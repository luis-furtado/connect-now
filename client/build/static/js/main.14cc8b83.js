/*! For license information please see main.14cc8b83.js.LICENSE.txt */
(()=>{var e={322:function(e,t,n){e.exports=function(){"use strict";function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(n){if("default"!==n&&!(n in e)){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof n.g?n.g:"undefined"!=typeof self?self:{};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r=function(e){try{return!!e()}catch(e){return!0}},o=!r((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),s=o,a=Function.prototype,c=a.call,d=s&&a.bind.bind(c,c),l=s?d:function(e){return function(){return c.apply(e,arguments)}},u=l({}.isPrototypeOf),h=function(e){return e&&e.Math==Math&&e},p=h("object"==typeof globalThis&&globalThis)||h("object"==typeof window&&window)||h("object"==typeof self&&self)||h("object"==typeof t&&t)||function(){return this}()||t||Function("return this")(),f=o,_=Function.prototype,m=_.apply,E=_.call,g="object"==typeof Reflect&&Reflect.apply||(f?E.bind(m):function(){return E.apply(m,arguments)}),S=l,T=S({}.toString),v=S("".slice),y=function(e){return v(T(e),8,-1)},R=y,C=l,b=function(e){if("Function"===R(e))return C(e)},I="object"==typeof document&&document.all,w={all:I,IS_HTMLDDA:void 0===I&&void 0!==I},A=w.all,O=w.IS_HTMLDDA?function(e){return"function"==typeof e||e===A}:function(e){return"function"==typeof e},N={},D=!r((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),P=o,k=Function.prototype.call,L=P?k.bind(k):function(){return k.apply(k,arguments)},M={},U={}.propertyIsEnumerable,x=Object.getOwnPropertyDescriptor,V=x&&!U.call({1:2},1);M.f=V?function(e){var t=x(this,e);return!!t&&t.enumerable}:U;var F,j,B=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},G=r,W=y,H=Object,K=l("".split),z=G((function(){return!H("z").propertyIsEnumerable(0)}))?function(e){return"String"==W(e)?K(e,""):H(e)}:H,Y=function(e){return null==e},q=Y,J=TypeError,X=function(e){if(q(e))throw J("Can't call method on "+e);return e},Q=z,Z=X,$=function(e){return Q(Z(e))},ee=O,te=w.all,ne=w.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:ee(e)||e===te}:function(e){return"object"==typeof e?null!==e:ee(e)},ie={},re=ie,oe=p,se=O,ae=function(e){return se(e)?e:void 0},ce=function(e,t){return arguments.length<2?ae(re[e])||ae(oe[e]):re[e]&&re[e][t]||oe[e]&&oe[e][t]},de="undefined"!=typeof navigator&&String(navigator.userAgent)||"",le=p,ue=de,he=le.process,pe=le.Deno,fe=he&&he.versions||pe&&pe.version,_e=fe&&fe.v8;_e&&(j=(F=_e.split("."))[0]>0&&F[0]<4?1:+(F[0]+F[1])),!j&&ue&&(!(F=ue.match(/Edge\/(\d+)/))||F[1]>=74)&&(F=ue.match(/Chrome\/(\d+)/))&&(j=+F[1]);var me=j,Ee=me,ge=r,Se=p.String,Te=!!Object.getOwnPropertySymbols&&!ge((function(){var e=Symbol();return!Se(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Ee&&Ee<41})),ve=Te&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ye=ce,Re=O,Ce=u,be=Object,Ie=ve?function(e){return"symbol"==typeof e}:function(e){var t=ye("Symbol");return Re(t)&&Ce(t.prototype,be(e))},we=String,Ae=function(e){try{return we(e)}catch(e){return"Object"}},Oe=O,Ne=Ae,De=TypeError,Pe=function(e){if(Oe(e))return e;throw De(Ne(e)+" is not a function")},ke=Pe,Le=Y,Me=function(e,t){var n=e[t];return Le(n)?void 0:ke(n)},Ue=L,xe=O,Ve=ne,Fe=TypeError,je={exports:{}},Be=p,Ge=Object.defineProperty,We=function(e,t){try{Ge(Be,e,{value:t,configurable:!0,writable:!0})}catch(i){Be[e]=t}return t},He="__core-js_shared__",Ke=p[He]||We(He,{}),ze=Ke;(je.exports=function(e,t){return ze[e]||(ze[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"\xa9 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var Ye=je.exports,qe=X,Je=Object,Xe=function(e){return Je(qe(e))},Qe=Xe,Ze=l({}.hasOwnProperty),$e=Object.hasOwn||function(e,t){return Ze(Qe(e),t)},et=l,tt=0,nt=Math.random(),it=et(1..toString),rt=function(e){return"Symbol("+(void 0===e?"":e)+")_"+it(++tt+nt,36)},ot=Ye,st=$e,at=rt,ct=Te,dt=ve,lt=p.Symbol,ut=ot("wks"),ht=dt?lt.for||lt:lt&&lt.withoutSetter||at,pt=function(e){return st(ut,e)||(ut[e]=ct&&st(lt,e)?lt[e]:ht("Symbol."+e)),ut[e]},ft=L,_t=ne,mt=Ie,Et=Me,gt=function(e,t){var n,i;if("string"===t&&xe(n=e.toString)&&!Ve(i=Ue(n,e)))return i;if(xe(n=e.valueOf)&&!Ve(i=Ue(n,e)))return i;if("string"!==t&&xe(n=e.toString)&&!Ve(i=Ue(n,e)))return i;throw Fe("Can't convert object to primitive value")},St=TypeError,Tt=pt("toPrimitive"),vt=function(e,t){if(!_t(e)||mt(e))return e;var n,i=Et(e,Tt);if(i){if(void 0===t&&(t="default"),n=ft(i,e,t),!_t(n)||mt(n))return n;throw St("Can't convert object to primitive value")}return void 0===t&&(t="number"),gt(e,t)},yt=Ie,Rt=function(e){var t=vt(e,"string");return yt(t)?t:t+""},Ct=ne,bt=p.document,It=Ct(bt)&&Ct(bt.createElement),wt=function(e){return It?bt.createElement(e):{}},At=wt,Ot=!D&&!r((function(){return 7!=Object.defineProperty(At("div"),"a",{get:function(){return 7}}).a})),Nt=D,Dt=L,Pt=M,kt=B,Lt=$,Mt=Rt,Ut=$e,xt=Ot,Vt=Object.getOwnPropertyDescriptor;N.f=Nt?Vt:function(e,t){if(e=Lt(e),t=Mt(t),xt)try{return Vt(e,t)}catch(e){}if(Ut(e,t))return kt(!Dt(Pt.f,e,t),e[t])};var Ft=r,jt=O,Bt=/#|\.prototype\./,Gt=function(e,t){var n=Ht[Wt(e)];return n==zt||n!=Kt&&(jt(t)?Ft(t):!!t)},Wt=Gt.normalize=function(e){return String(e).replace(Bt,".").toLowerCase()},Ht=Gt.data={},Kt=Gt.NATIVE="N",zt=Gt.POLYFILL="P",Yt=Gt,qt=Pe,Jt=o,Xt=b(b.bind),Qt=function(e,t){return qt(e),void 0===t?e:Jt?Xt(e,t):function(){return e.apply(t,arguments)}},Zt={},$t=D&&r((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),en=ne,tn=String,nn=TypeError,rn=function(e){if(en(e))return e;throw nn(tn(e)+" is not an object")},on=D,sn=Ot,an=$t,cn=rn,dn=Rt,ln=TypeError,un=Object.defineProperty,hn=Object.getOwnPropertyDescriptor,pn="enumerable",fn="configurable",_n="writable";Zt.f=on?an?function(e,t,n){if(cn(e),t=dn(t),cn(n),"function"==typeof e&&"prototype"===t&&"value"in n&&_n in n&&!n[_n]){var i=hn(e,t);i&&i[_n]&&(e[t]=n.value,n={configurable:fn in n?n[fn]:i[fn],enumerable:pn in n?n[pn]:i[pn],writable:!1})}return un(e,t,n)}:un:function(e,t,n){if(cn(e),t=dn(t),cn(n),sn)try{return un(e,t,n)}catch(e){}if("get"in n||"set"in n)throw ln("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var mn=Zt,En=B,gn=D?function(e,t,n){return mn.f(e,t,En(1,n))}:function(e,t,n){return e[t]=n,e},Sn=p,Tn=g,vn=b,yn=O,Rn=N.f,Cn=Yt,bn=ie,In=Qt,wn=gn,An=$e,On=function(e){var t=function(n,i,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(n);case 2:return new e(n,i)}return new e(n,i,r)}return Tn(e,this,arguments)};return t.prototype=e.prototype,t},Nn=function(e,t){var n,i,r,o,s,a,c,d,l,u=e.target,h=e.global,p=e.stat,f=e.proto,_=h?Sn:p?Sn[u]:(Sn[u]||{}).prototype,m=h?bn:bn[u]||wn(bn,u,{})[u],E=m.prototype;for(o in t)i=!(n=Cn(h?o:u+(p?".":"#")+o,e.forced))&&_&&An(_,o),a=m[o],i&&(c=e.dontCallGetSet?(l=Rn(_,o))&&l.value:_[o]),s=i&&c?c:t[o],i&&typeof a==typeof s||(d=e.bind&&i?In(s,Sn):e.wrap&&i?On(s):f&&yn(s)?vn(s):s,(e.sham||s&&s.sham||a&&a.sham)&&wn(d,"sham",!0),wn(m,o,d),f&&(An(bn,r=u+"Prototype")||wn(bn,r,{}),wn(bn[r],o,s),e.real&&E&&(n||!E[o])&&wn(E,o,s)))},Dn=Math.ceil,Pn=Math.floor,kn=Math.trunc||function(e){var t=+e;return(t>0?Pn:Dn)(t)},Ln=function(e){var t=+e;return t!=t||0===t?0:kn(t)},Mn=Ln,Un=Math.max,xn=Math.min,Vn=function(e,t){var n=Mn(e);return n<0?Un(n+t,0):xn(n,t)},Fn=Ln,jn=Math.min,Bn=function(e){return e>0?jn(Fn(e),9007199254740991):0},Gn=function(e){return Bn(e.length)},Wn=$,Hn=Vn,Kn=Gn,zn=function(e){return function(t,n,i){var r,o=Wn(t),s=Kn(o),a=Hn(i,s);if(e&&n!=n){for(;s>a;)if((r=o[a++])!=r)return!0}else for(;s>a;a++)if((e||a in o)&&o[a]===n)return e||a||0;return!e&&-1}},Yn={includes:zn(!0),indexOf:zn(!1)},qn=Yn.includes;Nn({target:"Array",proto:!0,forced:r((function(){return!Array(1).includes()}))},{includes:function(e){return qn(this,e,arguments.length>1?arguments[1]:void 0)}});var Jn=ie,Xn=function(e){return Jn[e+"Prototype"]},Qn=Xn("Array").includes,Zn=ne,$n=y,ei=pt("match"),ti=function(e){var t;return Zn(e)&&(void 0!==(t=e[ei])?!!t:"RegExp"==$n(e))},ni=TypeError,ii={};ii[pt("toStringTag")]="z";var ri="[object z]"===String(ii),oi=ri,si=O,ai=y,ci=pt("toStringTag"),di=Object,li="Arguments"==ai(function(){return arguments}()),ui=oi?ai:function(e){var t,n,i;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=di(e),ci))?n:li?ai(t):"Object"==(i=ai(t))&&si(t.callee)?"Arguments":i},hi=ui,pi=String,fi=function(e){if("Symbol"===hi(e))throw TypeError("Cannot convert a Symbol value to a string");return pi(e)},_i=pt("match"),mi=Nn,Ei=function(e){if(ti(e))throw ni("The method doesn't accept regular expressions");return e},gi=X,Si=fi,Ti=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[_i]=!1,"/./"[e](t)}catch(e){}}return!1},vi=l("".indexOf);mi({target:"String",proto:!0,forced:!Ti("includes")},{includes:function(e){return!!~vi(Si(gi(this)),Si(Ei(e)),arguments.length>1?arguments[1]:void 0)}});var yi=Xn("String").includes,Ri=u,Ci=Qn,bi=yi,Ii=Array.prototype,wi=String.prototype,Ai=i((function(e){var t=e.includes;return e===Ii||Ri(Ii,e)&&t===Ii.includes?Ci:"string"==typeof e||e===wi||Ri(wi,e)&&t===wi.includes?bi:t}));let Oi=!0,Ni=!0;function Di(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function Pi(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return r.apply(this,arguments);const o=e=>{const t=n(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,o),r.apply(this,[e,o])};const o=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(n))return o.apply(this,arguments);const i=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function ki(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Oi=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function Li(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Ni=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function Mi(){if("object"==typeof window){if(Oi)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function Ui(e,t){Ni&&console.warn(e+" is deprecated, please use "+t+" instead.")}function xi(e){return"[object Object]"===Object.prototype.toString.call(e)}function Vi(e){return xi(e)?Object.keys(e).reduce((function(t,n){const i=xi(e[n]),r=i?Vi(e[n]):e[n],o=i&&!Object.keys(r).length;return void 0===r||o?t:Object.assign(t,{[n]:r})}),{}):e}function Fi(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?Fi(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach((t=>{Fi(e,e.get(t),n)}))})))}function ji(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((n=>{n.type===i&&n.trackId===t.id&&Fi(e,n,r)}))})),r}const Bi=Mi;function Gi(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[r("min",n)]=i.ideal,t.optional.push(e),e={},e[r("max",n)]=i.ideal,t.optional.push(e)):(e[r("",n)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach((e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return n.mediaDevices.enumerateDevices().then((n=>{let s=(n=n.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!s&&n.length&&t.includes("back")&&(s=n[n.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=i(e.video),Bi("chrome: "+JSON.stringify(e)),r(e)}))}e.video=i(e.video)}return Bi("chrome: "+JSON.stringify(e)),r(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(e,t,i){r(e,(e=>{n.webkitGetUserMedia(e,t,(e=>{i&&i(o(e))}))}))}.bind(n),n.mediaDevices.getUserMedia){const e=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function Wi(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Hi(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.track.id)):{track:n.track};const r=new Event("track");r.track=n.track,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.id)):{track:n};const r=new Event("track");r.track=n,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Pi(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function Ki(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let r=n.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function zi(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,i]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t[n.id]=n})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const i=function(e){n(o(r(e)))};return t.apply(this,[i,e])}return new Promise(((e,n)=>{t.apply(this,[function(t){e(o(r(t)))},n])})).then(n,i)}}function Yi(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ji(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Pi(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ji(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,i;return this.getSenders().forEach((n=>{n.track===e&&(t?i=!0:t=n)})),this.getReceivers().forEach((t=>(t.track===e&&(n?i=!0:n=t),t.track===e))),i||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function qi(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();n.apply(this,arguments);const i=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function Ji(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return qi(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[n.id];if(r)r.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const i=new e.MediaStream([t]);this._streams[n.id]=i,this._reverseStreams[i.id]=n,this.addStream(i)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=o(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=i[t]}));const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Xi(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}))}function Qi(e,t){Pi(e,"negotiationneeded",(e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}var Zi=Object.freeze({__proto__:null,fixNegotiationNeeded:Qi,shimAddTrackRemoveTrack:Ji,shimAddTrackRemoveTrackWithNative:qi,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((t=>{const i=n.video&&n.video.width,r=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},i&&(n.video.mandatory.maxWidth=i),r&&(n.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:Ki,shimGetStats:zi,shimGetUserMedia:Gi,shimMediaStream:Wi,shimOnTrack:Hi,shimPeerConnection:Xi,shimSenderReceiverGetStats:Yi});function $i(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,i){Ui("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function er(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function tr(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,o]=arguments;return i.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,i)=>{e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(r,o)}}function nr(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ir(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Pi(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function rr(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){Ui("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function or(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function sr(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const n=e.length>0;n&&e.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const i=t.apply(this,arguments);if(n){const{sender:t}=i,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return i})}function ar(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function cr(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function dr(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var lr=Object.freeze({__proto__:null,shimAddTransceiver:sr,shimCreateAnswer:dr,shimCreateOffer:cr,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:ar,shimGetUserMedia:$i,shimOnTrack:er,shimPeerConnection:tr,shimRTCDataChannel:or,shimReceiverGetStats:ir,shimRemoveStream:rr,shimSenderGetStats:nr});function ur(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((n=>t.call(this,n,e))),e.getVideoTracks().forEach((n=>t.call(this,n,e)))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach((e=>{n.includes(e.track)&&this.removeTrack(e)}))})}}function hr(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}))}),t.apply(e,arguments)}}}function pr(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r};let a=function(e,t,n){const i=r.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i};t.setLocalDescription=a,a=function(e,t,n){const i=o.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.setRemoteDescription=a,a=function(e,t,n){const i=s.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.addIceCandidate=a}function fr(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(_r(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t))}function _r(e){return e&&void 0!==e.video?Object.assign({},e,{video:Vi(e.video)}):e}function mr(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let i=e.iceServers[n];!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")?(Ui("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Er(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function gr(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function Sr(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var Tr=Object.freeze({__proto__:null,shimAudioContext:Sr,shimCallbacksAPI:pr,shimConstraints:_r,shimCreateOfferLegacy:gr,shimGetUserMedia:fr,shimLocalStreamsAPI:ur,shimRTCIceServerUrls:mr,shimRemoteStreamsAPI:hr,shimTrackEventTransceiver:Er}),vr={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){const n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter((e=>0===e.indexOf(n)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const n={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1];break;case"ufrag":n.ufrag=t[i+1],n.usernameFragment=t[i+1];break;default:void 0===n[t[i]]&&(n[t[i]]=t[i+1])}return n},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const n=e.component;"rtp"===n?t.push(1):"rtcp"===n?t.push(2):t.push(n),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let n;const i=e.substring(e.indexOf(" ")+1).split(";");for(let r=0;r<i.length;r++)n=i[r].trim().split("="),t[n[0].trim()]=n[1];return t},t.writeFmtp=function(e){let t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),n={ssrc:parseInt(e.substring(7,t),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substring(t+1,i),n.value=e.substring(i+1)):n.attribute=e.substring(t+1),n},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){const i=t.matchPrefix(e+n,"a=ice-ufrag:")[0],r=t.matchPrefix(e+n,"a=ice-pwd:")[0];return i&&r?{usernameFragment:i.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");n.profile=i[2];for(let o=3;o<i.length;o++){const r=i[o],s=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(s){const i=t.parseRtpMap(s),o=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(i.parameters=o.length?t.parseFmtp(o[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),n.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(i.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{n.headerExtensions.push(t.parseExtmap(e))}));const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach((e=>{r.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),n},t.writeRtpDescription=function(e,n){let i="";i+="m="+e+" ",i+=n.codecs.length>0?"9":"0",i+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=n.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach((e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));let r=0;return n.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(i+="a=maxptime:"+r+"\r\n"),n.headerExtensions&&n.headerExtensions.forEach((e=>{i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){const n=[],i=t.parseRtpParameters(e),r=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]),i.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),n.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},n.push(t))}})),0===n.length&&a&&n.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,n.forEach((e=>{e.maxBitrate=l}))),n},t.parseRtcpParameters=function(e){const n={},i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];i&&(n.cname=i.value,n.ssrc=i.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=r.length>0,n.compound=0===r.length;const o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=o.length>0,n},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let n;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return n=i[0].substring(7).split(" "),{stream:n[0],track:n[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(n=r[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(e){const n=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let r;i.length>0&&(r=parseInt(i[0].substring(19),10)),isNaN(r)&&(r=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:r};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,n,i){let r;const o=void 0!==n?n:2;return r=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+r+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,n){const i=t.splitLines(e);for(let t=0;t<i.length;t++)switch(i[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[t].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const n=t.splitLines(e)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){const n=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const n=t.splitLines(e);for(let t=0;t<n.length;t++)if(n[t].length<2||"="!==n[t].charAt(1))return!1;return!0},e.exports=t}(vr);var yr=vr.exports,Rr=i(yr),Cr=e({__proto__:null,default:Rr},[yr]);function br(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),i=Rr.parseCandidate(e.candidate),r=Object.assign(n,i);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,Pi(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function Ir(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||Pi(e,"icecandidate",(e=>{if(e.candidate){const t=Rr.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function wr(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=function(e){if(!e||!e.sdp)return!1;const t=Rr.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=Rr.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n},r=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n},o=function(e,n){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const r=Rr.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?i=parseInt(r[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const e=i(arguments[0]),t=r(e),n=o(arguments[0],e);let s;s=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>s}),this._sctp=a}return s.apply(this,arguments)}}function Ar(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const i=arguments[0],r=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},Pi(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function Or(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function Nr(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const n=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return n.apply(this,arguments)}}function Dr(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Pr(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&0!==n.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return n.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}return e.sdp||"offer"!==e.type&&"answer"!==e.type?n.apply(this,[e]):("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>n.apply(this,[e])))})}var kr=Object.freeze({__proto__:null,removeExtmapAllowMixed:Nr,shimAddIceCandidateNullOrEmpty:Dr,shimConnectionState:Or,shimMaxMessageSize:wr,shimParameterlessSetLocalDescription:Pr,shimRTCIceCandidate:br,shimRTCIceCandidateRelayProtocol:Ir,shimSendThrowTypeError:Ar});!function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=Mi,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.mozGetUserMedia)t.browser="firefox",t.version=Di(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=Di(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=Di(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),r={browserDetails:i,commonShim:kr,extractVersion:Di,disableLog:ki,disableWarnings:Li,sdp:Cr};switch(i.browser){case"chrome":if(!Zi||!Xi||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(null===i.version)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=Zi,Dr(e,i),Pr(e),Gi(e,i),Wi(e),Xi(e,i),Hi(e),Ji(e,i),Ki(e),zi(e),Yi(e),Qi(e,i),br(e),Ir(e),Or(e),wr(e,i),Ar(e),Nr(e,i);break;case"firefox":if(!lr||!tr||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=lr,Dr(e,i),Pr(e),$i(e,i),tr(e,i),er(e),rr(e),nr(e),ir(e),or(e),sr(e),ar(e),cr(e),dr(e),br(e),Or(e),wr(e,i),Ar(e);break;case"safari":if(!Tr||!t.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=Tr,Dr(e,i),Pr(e),mr(e),gr(e),pr(e),ur(e),hr(e),Er(e),fr(e),Sr(e),br(e),Ir(e),wr(e,i),Ar(e),Nr(e,i);break;default:n("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});var Lr={exports:{}},Mr=Nn,Ur=D,xr=Zt.f;Mr({target:"Object",stat:!0,forced:Object.defineProperty!==xr,sham:!Ur},{defineProperty:xr});var Vr=ie.Object,Fr=Lr.exports=function(e,t,n){return Vr.defineProperty(e,t,n)};Vr.defineProperty.sham&&(Fr.sham=!0);var jr=i(Lr.exports),Br=y,Gr=Array.isArray||function(e){return"Array"==Br(e)},Wr=TypeError,Hr=Rt,Kr=Zt,zr=B,Yr=function(e,t,n){var i=Hr(t);i in e?Kr.f(e,i,zr(0,n)):e[i]=n},qr=O,Jr=Ke,Xr=l(Function.toString);qr(Jr.inspectSource)||(Jr.inspectSource=function(e){return Xr(e)});var Qr=Jr.inspectSource,Zr=l,$r=r,eo=O,to=ui,no=Qr,io=function(){},ro=[],oo=ce("Reflect","construct"),so=/^\s*(?:class|function)\b/,ao=Zr(so.exec),co=!so.exec(io),lo=function(e){if(!eo(e))return!1;try{return oo(io,ro,e),!0}catch(e){return!1}},uo=function(e){if(!eo(e))return!1;switch(to(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return co||!!ao(so,no(e))}catch(e){return!0}};uo.sham=!0;var ho=!oo||$r((function(){var e;return lo(lo.call)||!lo(Object)||!lo((function(){e=!0}))||e}))?uo:lo,po=Gr,fo=ho,_o=ne,mo=pt("species"),Eo=Array,go=function(e){var t;return po(e)&&(t=e.constructor,(fo(t)&&(t===Eo||po(t.prototype))||_o(t)&&null===(t=t[mo]))&&(t=void 0)),void 0===t?Eo:t},So=function(e,t){return new(go(e))(0===t?0:t)},To=r,vo=me,yo=pt("species"),Ro=Nn,Co=r,bo=Gr,Io=ne,wo=Xe,Ao=Gn,Oo=function(e){if(e>9007199254740991)throw Wr("Maximum allowed index exceeded");return e},No=Yr,Do=So,Po=function(e){return vo>=51||!To((function(){var t=[];return(t.constructor={})[yo]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},ko=me,Lo=pt("isConcatSpreadable"),Mo=ko>=51||!Co((function(){var e=[];return e[Lo]=!1,e.concat()[0]!==e})),Uo=function(e){if(!Io(e))return!1;var t=e[Lo];return void 0!==t?!!t:bo(e)};Ro({target:"Array",proto:!0,arity:1,forced:!Mo||!Po("concat")},{concat:function(e){var t,n,i,r,o,s=wo(this),a=Do(s,0),c=0;for(t=-1,i=arguments.length;t<i;t++)if(Uo(o=-1===t?s:arguments[t]))for(r=Ao(o),Oo(c+r),n=0;n<r;n++,c++)n in o&&No(a,c,o[n]);else Oo(c+1),No(a,c++,o);return a.length=c,a}});var xo={},Vo={},Fo=$e,jo=$,Bo=Yn.indexOf,Go=Vo,Wo=l([].push),Ho=function(e,t){var n,i=jo(e),r=0,o=[];for(n in i)!Fo(Go,n)&&Fo(i,n)&&Wo(o,n);for(;t.length>r;)Fo(i,n=t[r++])&&(~Bo(o,n)||Wo(o,n));return o},Ko=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],zo=Ho,Yo=Ko,qo=Object.keys||function(e){return zo(e,Yo)},Jo=D,Xo=$t,Qo=Zt,Zo=rn,$o=$,es=qo;xo.f=Jo&&!Xo?Object.defineProperties:function(e,t){Zo(e);for(var n,i=$o(t),r=es(t),o=r.length,s=0;o>s;)Qo.f(e,n=r[s++],i[n]);return e};var ts,ns=ce("document","documentElement"),is=rt,rs=Ye("keys"),os=function(e){return rs[e]||(rs[e]=is(e))},ss=rn,as=xo,cs=Ko,ds=Vo,ls=ns,us=wt,hs="prototype",ps="script",fs=os("IE_PROTO"),_s=function(){},ms=function(e){return"<"+ps+">"+e+"</"+ps+">"},Es=function(e){e.write(ms("")),e.close();var t=e.parentWindow.Object;return e=null,t},gs=function(){try{ts=new ActiveXObject("htmlfile")}catch(e){}var e,t,n;gs="undefined"!=typeof document?document.domain&&ts?Es(ts):(t=us("iframe"),n="java"+ps+":",t.style.display="none",ls.appendChild(t),t.src=String(n),(e=t.contentWindow.document).open(),e.write(ms("document.F=Object")),e.close(),e.F):Es(ts);for(var i=cs.length;i--;)delete gs[hs][cs[i]];return gs()};ds[fs]=!0;var Ss=Object.create||function(e,t){var n;return null!==e?(_s[hs]=ss(e),n=new _s,_s[hs]=null,n[fs]=e):n=gs(),void 0===t?n:as.f(n,t)},Ts={},vs=Ho,ys=Ko.concat("length","prototype");Ts.f=Object.getOwnPropertyNames||function(e){return vs(e,ys)};var Rs={},Cs=Vn,bs=Gn,Is=Yr,ws=Array,As=Math.max,Os=function(e,t,n){for(var i=bs(e),r=Cs(t,i),o=Cs(void 0===n?i:n,i),s=ws(As(o-r,0)),a=0;r<o;r++,a++)Is(s,a,e[r]);return s.length=a,s},Ns=y,Ds=$,Ps=Ts.f,ks=Os,Ls="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Rs.f=function(e){return Ls&&"Window"==Ns(e)?function(e){try{return Ps(e)}catch(e){return ks(Ls)}}(e):Ps(Ds(e))};var Ms={};Ms.f=Object.getOwnPropertySymbols;var Us=gn,xs=function(e,t,n,i){return i&&i.enumerable?e[t]=n:Us(e,t,n),e},Vs=Zt,Fs=function(e,t,n){return Vs.f(e,t,n)},js={},Bs=pt;js.f=Bs;var Gs,Ws,Hs,Ks=ie,zs=$e,Ys=js,qs=Zt.f,Js=function(e){var t=Ks.Symbol||(Ks.Symbol={});zs(t,e)||qs(t,e,{value:Ys.f(e)})},Xs=L,Qs=ce,Zs=pt,$s=xs,ea=function(){var e=Qs("Symbol"),t=e&&e.prototype,n=t&&t.valueOf,i=Zs("toPrimitive");t&&!t[i]&&$s(t,i,(function(e){return Xs(n,this)}),{arity:1})},ta=ui,na=ri?{}.toString:function(){return"[object "+ta(this)+"]"},ia=ri,ra=Zt.f,oa=gn,sa=$e,aa=na,ca=pt("toStringTag"),da=function(e,t,n,i){if(e){var r=n?e:e.prototype;sa(r,ca)||ra(r,ca,{configurable:!0,value:t}),i&&!ia&&oa(r,"toString",aa)}},la=O,ua=p.WeakMap,ha=la(ua)&&/native code/.test(String(ua)),pa=p,fa=ne,_a=gn,ma=$e,Ea=Ke,ga=os,Sa=Vo,Ta="Object already initialized",va=pa.TypeError,ya=pa.WeakMap;if(ha||Ea.state){var Ra=Ea.state||(Ea.state=new ya);Ra.get=Ra.get,Ra.has=Ra.has,Ra.set=Ra.set,Gs=function(e,t){if(Ra.has(e))throw va(Ta);return t.facade=e,Ra.set(e,t),t},Ws=function(e){return Ra.get(e)||{}},Hs=function(e){return Ra.has(e)}}else{var Ca=ga("state");Sa[Ca]=!0,Gs=function(e,t){if(ma(e,Ca))throw va(Ta);return t.facade=e,_a(e,Ca,t),t},Ws=function(e){return ma(e,Ca)?e[Ca]:{}},Hs=function(e){return ma(e,Ca)}}var ba={set:Gs,get:Ws,has:Hs,enforce:function(e){return Hs(e)?Ws(e):Gs(e,{})},getterFor:function(e){return function(t){var n;if(!fa(t)||(n=Ws(t)).type!==e)throw va("Incompatible receiver, "+e+" required");return n}}},Ia=Qt,wa=z,Aa=Xe,Oa=Gn,Na=So,Da=l([].push),Pa=function(e){var t=1==e,n=2==e,i=3==e,r=4==e,o=6==e,s=7==e,a=5==e||o;return function(c,d,l,u){for(var h,p,f=Aa(c),_=wa(f),m=Ia(d,l),E=Oa(_),g=0,S=u||Na,T=t?S(c,E):n||s?S(c,0):void 0;E>g;g++)if((a||g in _)&&(p=m(h=_[g],g,f),e))if(t)T[g]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return g;case 2:Da(T,h)}else switch(e){case 4:return!1;case 7:Da(T,h)}return o?-1:i||r?r:T}},ka={forEach:Pa(0),map:Pa(1),filter:Pa(2),some:Pa(3),every:Pa(4),find:Pa(5),findIndex:Pa(6),filterReject:Pa(7)},La=Nn,Ma=p,Ua=L,xa=l,Va=D,Fa=Te,ja=r,Ba=$e,Ga=u,Wa=rn,Ha=$,Ka=Rt,za=fi,Ya=B,qa=Ss,Ja=qo,Xa=Ts,Qa=Rs,Za=Ms,$a=N,ec=Zt,tc=xo,nc=M,ic=xs,rc=Fs,oc=Ye,sc=Vo,ac=rt,cc=pt,dc=js,lc=Js,uc=ea,hc=da,pc=ba,fc=ka.forEach,_c=os("hidden"),mc="Symbol",Ec="prototype",gc=pc.set,Sc=pc.getterFor(mc),Tc=Object[Ec],vc=Ma.Symbol,yc=vc&&vc[Ec],Rc=Ma.TypeError,Cc=Ma.QObject,bc=$a.f,Ic=ec.f,wc=Qa.f,Ac=nc.f,Oc=xa([].push),Nc=oc("symbols"),Dc=oc("op-symbols"),Pc=oc("wks"),kc=!Cc||!Cc[Ec]||!Cc[Ec].findChild,Lc=Va&&ja((function(){return 7!=qa(Ic({},"a",{get:function(){return Ic(this,"a",{value:7}).a}})).a}))?function(e,t,n){var i=bc(Tc,t);i&&delete Tc[t],Ic(e,t,n),i&&e!==Tc&&Ic(Tc,t,i)}:Ic,Mc=function(e,t){var n=Nc[e]=qa(yc);return gc(n,{type:mc,tag:e,description:t}),Va||(n.description=t),n},Uc=function(e,t,n){e===Tc&&Uc(Dc,t,n),Wa(e);var i=Ka(t);return Wa(n),Ba(Nc,i)?(n.enumerable?(Ba(e,_c)&&e[_c][i]&&(e[_c][i]=!1),n=qa(n,{enumerable:Ya(0,!1)})):(Ba(e,_c)||Ic(e,_c,Ya(1,{})),e[_c][i]=!0),Lc(e,i,n)):Ic(e,i,n)},xc=function(e,t){Wa(e);var n=Ha(t),i=Ja(n).concat(Bc(n));return fc(i,(function(t){Va&&!Ua(Vc,n,t)||Uc(e,t,n[t])})),e},Vc=function(e){var t=Ka(e),n=Ua(Ac,this,t);return!(this===Tc&&Ba(Nc,t)&&!Ba(Dc,t))&&(!(n||!Ba(this,t)||!Ba(Nc,t)||Ba(this,_c)&&this[_c][t])||n)},Fc=function(e,t){var n=Ha(e),i=Ka(t);if(n!==Tc||!Ba(Nc,i)||Ba(Dc,i)){var r=bc(n,i);return!r||!Ba(Nc,i)||Ba(n,_c)&&n[_c][i]||(r.enumerable=!0),r}},jc=function(e){var t=wc(Ha(e)),n=[];return fc(t,(function(e){Ba(Nc,e)||Ba(sc,e)||Oc(n,e)})),n},Bc=function(e){var t=e===Tc,n=wc(t?Dc:Ha(e)),i=[];return fc(n,(function(e){!Ba(Nc,e)||t&&!Ba(Tc,e)||Oc(i,Nc[e])})),i};Fa||(vc=function(){if(Ga(yc,this))throw Rc("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?za(arguments[0]):void 0,t=ac(e),n=function(e){this===Tc&&Ua(n,Dc,e),Ba(this,_c)&&Ba(this[_c],t)&&(this[_c][t]=!1),Lc(this,t,Ya(1,e))};return Va&&kc&&Lc(Tc,t,{configurable:!0,set:n}),Mc(t,e)},ic(yc=vc[Ec],"toString",(function(){return Sc(this).tag})),ic(vc,"withoutSetter",(function(e){return Mc(ac(e),e)})),nc.f=Vc,ec.f=Uc,tc.f=xc,$a.f=Fc,Xa.f=Qa.f=jc,Za.f=Bc,dc.f=function(e){return Mc(cc(e),e)},Va&&rc(yc,"description",{configurable:!0,get:function(){return Sc(this).description}})),La({global:!0,constructor:!0,wrap:!0,forced:!Fa,sham:!Fa},{Symbol:vc}),fc(Ja(Pc),(function(e){lc(e)})),La({target:mc,stat:!0,forced:!Fa},{useSetter:function(){kc=!0},useSimple:function(){kc=!1}}),La({target:"Object",stat:!0,forced:!Fa,sham:!Va},{create:function(e,t){return void 0===t?qa(e):xc(qa(e),t)},defineProperty:Uc,defineProperties:xc,getOwnPropertyDescriptor:Fc}),La({target:"Object",stat:!0,forced:!Fa},{getOwnPropertyNames:jc}),uc(),hc(vc,mc),sc[_c]=!0;var Gc=Te&&!!Symbol.for&&!!Symbol.keyFor,Wc=Nn,Hc=ce,Kc=$e,zc=fi,Yc=Ye,qc=Gc,Jc=Yc("string-to-symbol-registry"),Xc=Yc("symbol-to-string-registry");Wc({target:"Symbol",stat:!0,forced:!qc},{for:function(e){var t=zc(e);if(Kc(Jc,t))return Jc[t];var n=Hc("Symbol")(t);return Jc[t]=n,Xc[n]=t,n}});var Qc=Nn,Zc=$e,$c=Ie,ed=Ae,td=Gc,nd=Ye("symbol-to-string-registry");Qc({target:"Symbol",stat:!0,forced:!td},{keyFor:function(e){if(!$c(e))throw TypeError(ed(e)+" is not a symbol");if(Zc(nd,e))return nd[e]}});var id=l([].slice),rd=Gr,od=O,sd=y,ad=fi,cd=l([].push),dd=Nn,ld=ce,ud=g,hd=L,pd=l,fd=r,_d=O,md=Ie,Ed=id,gd=function(e){if(od(e))return e;if(rd(e)){for(var t=e.length,n=[],i=0;i<t;i++){var r=e[i];"string"==typeof r?cd(n,r):"number"!=typeof r&&"Number"!=sd(r)&&"String"!=sd(r)||cd(n,ad(r))}var o=n.length,s=!0;return function(e,t){if(s)return s=!1,t;if(rd(this))return t;for(var i=0;i<o;i++)if(n[i]===e)return t}}},Sd=Te,Td=String,vd=ld("JSON","stringify"),yd=pd(/./.exec),Rd=pd("".charAt),Cd=pd("".charCodeAt),bd=pd("".replace),Id=pd(1..toString),wd=/[\uD800-\uDFFF]/g,Ad=/^[\uD800-\uDBFF]$/,Od=/^[\uDC00-\uDFFF]$/,Nd=!Sd||fd((function(){var e=ld("Symbol")();return"[null]"!=vd([e])||"{}"!=vd({a:e})||"{}"!=vd(Object(e))})),Dd=fd((function(){return'"\\udf06\\ud834"'!==vd("\udf06\ud834")||'"\\udead"'!==vd("\udead")})),Pd=function(e,t){var n=Ed(arguments),i=gd(t);if(_d(i)||void 0!==e&&!md(e))return n[1]=function(e,t){if(_d(i)&&(t=hd(i,this,Td(e),t)),!md(t))return t},ud(vd,null,n)},kd=function(e,t,n){var i=Rd(n,t-1),r=Rd(n,t+1);return yd(Ad,e)&&!yd(Od,r)||yd(Od,e)&&!yd(Ad,i)?"\\u"+Id(Cd(e,0),16):e};vd&&dd({target:"JSON",stat:!0,arity:3,forced:Nd||Dd},{stringify:function(e,t,n){var i=Ed(arguments),r=ud(Nd?Pd:vd,null,i);return Dd&&"string"==typeof r?bd(r,wd,kd):r}});var Ld=Ms,Md=Xe;Nn({target:"Object",stat:!0,forced:!Te||r((function(){Ld.f(1)}))},{getOwnPropertySymbols:function(e){var t=Ld.f;return t?t(Md(e)):[]}}),Js("asyncIterator"),Js("hasInstance"),Js("isConcatSpreadable"),Js("iterator"),Js("match"),Js("matchAll"),Js("replace"),Js("search"),Js("species"),Js("split");var Ud=ea;Js("toPrimitive"),Ud();var xd=ce,Vd=da;Js("toStringTag"),Vd(xd("Symbol"),"Symbol"),Js("unscopables"),da(p.JSON,"JSON",!0);var Fd,jd,Bd,Gd=ie.Symbol,Wd={},Hd=D,Kd=$e,zd=Function.prototype,Yd=Hd&&Object.getOwnPropertyDescriptor,qd=Kd(zd,"name"),Jd={EXISTS:qd,PROPER:qd&&"something"===function(){}.name,CONFIGURABLE:qd&&(!Hd||Hd&&Yd(zd,"name").configurable)},Xd=!r((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Qd=$e,Zd=O,$d=Xe,el=Xd,tl=os("IE_PROTO"),nl=Object,il=nl.prototype,rl=el?nl.getPrototypeOf:function(e){var t=$d(e);if(Qd(t,tl))return t[tl];var n=t.constructor;return Zd(n)&&t instanceof n?n.prototype:t instanceof nl?il:null},ol=r,sl=O,al=ne,cl=Ss,dl=rl,ll=xs,ul=pt("iterator"),hl=!1;[].keys&&("next"in(Bd=[].keys())?(jd=dl(dl(Bd)))!==Object.prototype&&(Fd=jd):hl=!0);var pl=!al(Fd)||ol((function(){var e={};return Fd[ul].call(e)!==e}));sl((Fd=pl?{}:cl(Fd))[ul])||ll(Fd,ul,(function(){return this}));var fl={IteratorPrototype:Fd,BUGGY_SAFARI_ITERATORS:hl},_l=fl.IteratorPrototype,ml=Ss,El=B,gl=da,Sl=Wd,Tl=function(){return this},vl=l,yl=Pe,Rl=O,Cl=String,bl=TypeError,Il=function(e,t,n){try{return vl(yl(Object.getOwnPropertyDescriptor(e,t)[n]))}catch(e){}},wl=rn,Al=function(e){if("object"==typeof e||Rl(e))return e;throw bl("Can't set "+Cl(e)+" as a prototype")},Ol=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=Il(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch(e){}return function(n,i){return wl(n),Al(i),t?e(n,i):n.__proto__=i,n}}():void 0),Nl=Nn,Dl=L,Pl=function(e,t,n,i){var r=t+" Iterator";return e.prototype=ml(_l,{next:El(+!i,n)}),gl(e,r,!1,!0),Sl[r]=Tl,e},kl=rl,Ll=da,Ml=xs,Ul=Wd,xl=fl,Vl=Jd.PROPER,Fl=xl.BUGGY_SAFARI_ITERATORS,jl=pt("iterator"),Bl="keys",Gl="values",Wl="entries",Hl=function(){return this},Kl=function(e,t,n,i,r,o,s){Pl(n,t,i);var a,c,d,l=function(e){if(e===r&&_)return _;if(!Fl&&e in p)return p[e];switch(e){case Bl:case Gl:case Wl:return function(){return new n(this,e)}}return function(){return new n(this)}},u=t+" Iterator",h=!1,p=e.prototype,f=p[jl]||p["@@iterator"]||r&&p[r],_=!Fl&&f||l(r),m="Array"==t&&p.entries||f;if(m&&(a=kl(m.call(new e)))!==Object.prototype&&a.next&&(Ll(a,u,!0,!0),Ul[u]=Hl),Vl&&r==Gl&&f&&f.name!==Gl&&(h=!0,_=function(){return Dl(f,this)}),r)if(c={values:l(Gl),keys:o?_:l(Bl),entries:l(Wl)},s)for(d in c)(Fl||h||!(d in p))&&Ml(p,d,c[d]);else Nl({target:t,proto:!0,forced:Fl||h},c);return s&&p[jl]!==_&&Ml(p,jl,_,{name:r}),Ul[t]=_,c},zl=function(e,t){return{value:e,done:t}},Yl=$,ql=Wd,Jl=ba;Zt.f;var Xl=Kl,Ql=zl,Zl="Array Iterator",$l=Jl.set,eu=Jl.getterFor(Zl);Xl(Array,"Array",(function(e,t){$l(this,{type:Zl,target:Yl(e),index:0,kind:t})}),(function(){var e=eu(this),t=e.target,n=e.kind,i=e.index++;return!t||i>=t.length?(e.target=void 0,Ql(void 0,!0)):Ql("keys"==n?i:"values"==n?t[i]:[i,t[i]],!1)}),"values"),ql.Arguments=ql.Array;var tu={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},nu=p,iu=ui,ru=gn,ou=Wd,su=pt("toStringTag");for(var au in tu){var cu=nu[au],du=cu&&cu.prototype;du&&iu(du)!==su&&ru(du,su,au),ou[au]=ou.Array}var lu=Gd,uu=pt,hu=Zt.f,pu=uu("metadata"),fu=Function.prototype;void 0===fu[pu]&&hu(fu,pu,{value:null}),Js("dispose"),Js("metadata");var _u=lu;Js("asyncDispose");var mu=l,Eu=ce("Symbol"),gu=Eu.keyFor,Su=mu(Eu.prototype.valueOf),Tu=Eu.isRegisteredSymbol||function(e){try{return void 0!==gu(Su(e))}catch(e){return!1}};Nn({target:"Symbol",stat:!0},{isRegisteredSymbol:Tu});for(var vu=Ye,yu=ce,Ru=l,Cu=Ie,bu=pt,Iu=yu("Symbol"),wu=Iu.isWellKnownSymbol,Au=yu("Object","getOwnPropertyNames"),Ou=Ru(Iu.prototype.valueOf),Nu=vu("wks"),Du=0,Pu=Au(Iu),ku=Pu.length;Du<ku;Du++)try{var Lu=Pu[Du];Cu(Iu[Lu])&&bu(Lu)}catch(e){}var Mu=function(e){if(wu&&wu(e))return!0;try{for(var t=Ou(e),n=0,i=Au(Nu),r=i.length;n<r;n++)if(Nu[i[n]]==t)return!0}catch(e){}return!1};Nn({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Mu}),Js("matcher"),Js("observable"),Nn({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:Tu}),Nn({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Mu}),Js("metadataKey"),Js("patternMatch"),Js("replaceAll");var Uu=i(_u),xu=l,Vu=Ln,Fu=fi,ju=X,Bu=xu("".charAt),Gu=xu("".charCodeAt),Wu=xu("".slice),Hu=function(e){return function(t,n){var i,r,o=Fu(ju(t)),s=Vu(n),a=o.length;return s<0||s>=a?e?"":void 0:(i=Gu(o,s))<55296||i>56319||s+1===a||(r=Gu(o,s+1))<56320||r>57343?e?Bu(o,s):i:e?Wu(o,s,s+2):r-56320+(i-55296<<10)+65536}},Ku=(Hu(!1),Hu(!0)),zu=fi,Yu=ba,qu=Kl,Ju=zl,Xu="String Iterator",Qu=Yu.set,Zu=Yu.getterFor(Xu);qu(String,"String",(function(e){Qu(this,{type:Xu,string:zu(e),index:0})}),(function(){var e,t=Zu(this),n=t.string,i=t.index;return i>=n.length?Ju(void 0,!0):(e=Ku(n,i),t.index+=e.length,Ju(e,!1))}));var $u=i(js.f("iterator"));function eh(e){return eh="function"==typeof Uu&&"symbol"==typeof $u?function(e){return typeof e}:function(e){return e&&"function"==typeof Uu&&e.constructor===Uu&&e!==Uu.prototype?"symbol":typeof e},eh(e)}var th=i(js.f("toPrimitive"));function nh(e){var t=function(e,t){if("object"!==eh(e)||null===e)return e;var n=e[th];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==eh(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===eh(t)?t:String(t)}function ih(e,t,n){return(t=nh(t))in e?jr(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var rh=Xn("Array").keys,oh=ui,sh=$e,ah=u,ch=rh,dh=Array.prototype,lh={DOMTokenList:!0,NodeList:!0},uh=i((function(e){var t=e.keys;return e===dh||ah(dh,e)&&t===dh.keys||sh(lh,oh(e))?ch:t})),hh=Ae,ph=TypeError,fh=Os,_h=Math.floor,mh=function(e,t){var n=e.length,i=_h(n/2);return n<8?Eh(e,t):gh(e,mh(fh(e,0,i),t),mh(fh(e,i),t),t)},Eh=function(e,t){for(var n,i,r=e.length,o=1;o<r;){for(i=o,n=e[o];i&&t(e[i-1],n)>0;)e[i]=e[--i];i!==o++&&(e[i]=n)}return e},gh=function(e,t,n,i){for(var r=t.length,o=n.length,s=0,a=0;s<r||a<o;)e[s+a]=s<r&&a<o?i(t[s],n[a])<=0?t[s++]:n[a++]:s<r?t[s++]:n[a++];return e},Sh=mh,Th=r,vh=function(e,t){var n=[][e];return!!n&&Th((function(){n.call(null,t||function(){return 1},1)}))},yh=de.match(/firefox\/(\d+)/i),Rh=!!yh&&+yh[1],Ch=/MSIE|Trident/.test(de),bh=de.match(/AppleWebKit\/(\d+)\./),Ih=!!bh&&+bh[1],wh=Nn,Ah=l,Oh=Pe,Nh=Xe,Dh=Gn,Ph=function(e,t){if(!delete e[t])throw ph("Cannot delete property "+hh(t)+" of "+hh(e))},kh=fi,Lh=r,Mh=Sh,Uh=vh,xh=Rh,Vh=Ch,Fh=me,jh=Ih,Bh=[],Gh=Ah(Bh.sort),Wh=Ah(Bh.push),Hh=Lh((function(){Bh.sort(void 0)})),Kh=Lh((function(){Bh.sort(null)})),zh=Uh("sort"),Yh=!Lh((function(){if(Fh)return Fh<70;if(!(xh&&xh>3)){if(Vh)return!0;if(jh)return jh<603;var e,t,n,i,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)Bh.push({k:t+i,v:n})}for(Bh.sort((function(e,t){return t.v-e.v})),i=0;i<Bh.length;i++)t=Bh[i].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return"DGBEFHACIJK"!==r}}));wh({target:"Array",proto:!0,forced:Hh||!Kh||!zh||!Yh},{sort:function(e){void 0!==e&&Oh(e);var t=Nh(this);if(Yh)return void 0===e?Gh(t):Gh(t,e);var n,i,r=[],o=Dh(t);for(i=0;i<o;i++)i in t&&Wh(r,t[i]);for(Mh(r,function(e){return function(t,n){return void 0===n?-1:void 0===t?1:void 0!==e?+e(t,n)||0:kh(t)>kh(n)?1:-1}}(e)),n=Dh(r),i=0;i<n;)t[i]=r[i++];for(;i<o;)Ph(t,i++);return t}});var qh=Xn("Array").sort,Jh=u,Xh=qh,Qh=Array.prototype,Zh=i((function(e){var t=e.sort;return e===Qh||Jh(Qh,e)&&t===Qh.sort?Xh:t})),$h=ce,ep=Ts,tp=Ms,np=rn,ip=l([].concat),rp=$h("Reflect","ownKeys")||function(e){var t=ep.f(np(e)),n=tp.f;return n?ip(t,n(e)):t},op=$e,sp=rp,ap=N,cp=Zt,dp=ne,lp=gn,up=Error,hp=l("".replace),pp=String(up("zxcasd").stack),fp=/\n\s*at [^:]*:[^\n]*/,_p=fp.test(pp),mp=B,Ep=!r((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",mp(1,7)),7!==e.stack)})),gp=gn,Sp=function(e,t){if(_p&&"string"==typeof e&&!up.prepareStackTrace)for(;t--;)e=hp(e,fp,"");return e},Tp=Ep,vp=Error.captureStackTrace,yp=Wd,Rp=pt("iterator"),Cp=Array.prototype,bp=ui,Ip=Me,wp=Y,Ap=Wd,Op=pt("iterator"),Np=function(e){if(!wp(e))return Ip(e,Op)||Ip(e,"@@iterator")||Ap[bp(e)]},Dp=L,Pp=Pe,kp=rn,Lp=Ae,Mp=Np,Up=TypeError,xp=L,Vp=rn,Fp=Me,jp=Qt,Bp=L,Gp=rn,Wp=Ae,Hp=function(e){return void 0!==e&&(yp.Array===e||Cp[Rp]===e)},Kp=Gn,zp=u,Yp=function(e,t){var n=arguments.length<2?Mp(e):t;if(Pp(n))return kp(Dp(n,e));throw Up(Lp(e)+" is not iterable")},qp=Np,Jp=function(e,t,n){var i,r;Vp(e);try{if(!(i=Fp(e,"return"))){if("throw"===t)throw n;return n}i=xp(i,e)}catch(e){r=!0,i=e}if("throw"===t)throw n;if(r)throw i;return Vp(i),n},Xp=TypeError,Qp=function(e,t){this.stopped=e,this.result=t},Zp=Qp.prototype,$p=function(e,t,n){var i,r,o,s,a,c,d,l=n&&n.that,u=!(!n||!n.AS_ENTRIES),h=!(!n||!n.IS_RECORD),p=!(!n||!n.IS_ITERATOR),f=!(!n||!n.INTERRUPTED),_=jp(t,l),m=function(e){return i&&Jp(i,"normal",e),new Qp(!0,e)},E=function(e){return u?(Gp(e),f?_(e[0],e[1],m):_(e[0],e[1])):f?_(e,m):_(e)};if(h)i=e.iterator;else if(p)i=e;else{if(!(r=qp(e)))throw Xp(Wp(e)+" is not iterable");if(Hp(r)){for(o=0,s=Kp(e);s>o;o++)if((a=E(e[o]))&&zp(Zp,a))return a;return new Qp(!1)}i=Yp(e,r)}for(c=h?e.next:i.next;!(d=Bp(c,i)).done;){try{a=E(d.value)}catch(e){Jp(i,"throw",e)}if("object"==typeof a&&a&&zp(Zp,a))return a}return new Qp(!1)},ef=fi,tf=Nn,nf=u,rf=rl,of=Ol,sf=function(e,t,n){for(var i=sp(t),r=cp.f,o=ap.f,s=0;s<i.length;s++){var a=i[s];op(e,a)||n&&op(n,a)||r(e,a,o(t,a))}},af=Ss,cf=gn,df=B,lf=function(e,t){dp(t)&&"cause"in t&&lp(e,"cause",t.cause)},uf=function(e,t,n,i){Tp&&(vp?vp(e,t):gp(e,"stack",Sp(n,i)))},hf=$p,pf=function(e,t){return void 0===e?arguments.length<2?"":t:ef(e)},ff=pt("toStringTag"),_f=Error,mf=[].push,Ef=function(e,t){var n,i=nf(gf,this);of?n=of(_f(),i?rf(this):gf):(n=i?this:af(gf),cf(n,ff,"Error")),void 0!==t&&cf(n,"message",pf(t)),uf(n,Ef,n.stack,1),arguments.length>2&&lf(n,arguments[2]);var r=[];return hf(e,mf,{that:r}),cf(n,"errors",r),n};of?of(Ef,_f):sf(Ef,_f,{name:!0});var gf=Ef.prototype=af(_f.prototype,{constructor:df(1,Ef),message:df(1,""),name:df(1,"AggregateError")});tf({global:!0,constructor:!0,arity:2},{AggregateError:Ef});var Sf,Tf,vf,yf,Rf="undefined"!=typeof process&&"process"==y(process),Cf=ce,bf=Fs,If=D,wf=pt("species"),Af=u,Of=TypeError,Nf=ho,Df=Ae,Pf=TypeError,kf=rn,Lf=function(e){if(Nf(e))return e;throw Pf(Df(e)+" is not a constructor")},Mf=Y,Uf=pt("species"),xf=function(e,t){var n,i=kf(e).constructor;return void 0===i||Mf(n=kf(i)[Uf])?t:Lf(n)},Vf=TypeError,Ff=/(?:ipad|iphone|ipod).*applewebkit/i.test(de),jf=p,Bf=g,Gf=Qt,Wf=O,Hf=$e,Kf=r,zf=ns,Yf=id,qf=wt,Jf=function(e,t){if(e<t)throw Vf("Not enough arguments");return e},Xf=Ff,Qf=Rf,Zf=jf.setImmediate,$f=jf.clearImmediate,e_=jf.process,t_=jf.Dispatch,n_=jf.Function,i_=jf.MessageChannel,r_=jf.String,o_=0,s_={},a_="onreadystatechange";Kf((function(){Sf=jf.location}));var c_=function(e){if(Hf(s_,e)){var t=s_[e];delete s_[e],t()}},d_=function(e){return function(){c_(e)}},l_=function(e){c_(e.data)},u_=function(e){jf.postMessage(r_(e),Sf.protocol+"//"+Sf.host)};Zf&&$f||(Zf=function(e){Jf(arguments.length,1);var t=Wf(e)?e:n_(e),n=Yf(arguments,1);return s_[++o_]=function(){Bf(t,void 0,n)},Tf(o_),o_},$f=function(e){delete s_[e]},Qf?Tf=function(e){e_.nextTick(d_(e))}:t_&&t_.now?Tf=function(e){t_.now(d_(e))}:i_&&!Xf?(yf=(vf=new i_).port2,vf.port1.onmessage=l_,Tf=Gf(yf.postMessage,yf)):jf.addEventListener&&Wf(jf.postMessage)&&!jf.importScripts&&Sf&&"file:"!==Sf.protocol&&!Kf(u_)?(Tf=u_,jf.addEventListener("message",l_,!1)):Tf=a_ in qf("script")?function(e){zf.appendChild(qf("script"))[a_]=function(){zf.removeChild(this),c_(e)}}:function(e){setTimeout(d_(e),0)});var h_={set:Zf,clear:$f},p_=function(){this.head=null,this.tail=null};p_.prototype={add:function(e){var t={item:e,next:null},n=this.tail;n?n.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var f_,__,m_,E_,g_,S_=p_,T_=/ipad|iphone|ipod/i.test(de)&&"undefined"!=typeof Pebble,v_=/web0s(?!.*chrome)/i.test(de),y_=p,R_=Qt,C_=N.f,b_=h_.set,I_=S_,w_=Ff,A_=T_,O_=v_,N_=Rf,D_=y_.MutationObserver||y_.WebKitMutationObserver,P_=y_.document,k_=y_.process,L_=y_.Promise,M_=C_(y_,"queueMicrotask"),U_=M_&&M_.value;if(!U_){var x_=new I_,V_=function(){var e,t;for(N_&&(e=k_.domain)&&e.exit();t=x_.get();)try{t()}catch(e){throw x_.head&&f_(),e}e&&e.enter()};w_||N_||O_||!D_||!P_?!A_&&L_&&L_.resolve?((E_=L_.resolve(void 0)).constructor=L_,g_=R_(E_.then,E_),f_=function(){g_(V_)}):N_?f_=function(){k_.nextTick(V_)}:(b_=R_(b_,y_),f_=function(){b_(V_)}):(__=!0,m_=P_.createTextNode(""),new D_(V_).observe(m_,{characterData:!0}),f_=function(){m_.data=__=!__}),U_=function(e){x_.head||f_(),x_.add(e)}}var F_=U_,j_=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},B_=p.Promise,G_="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,W_=!G_&&!Rf&&"object"==typeof window&&"object"==typeof document,H_=p,K_=B_,z_=O,Y_=Yt,q_=Qr,J_=pt,X_=W_,Q_=G_,Z_=me,$_=K_&&K_.prototype,em=J_("species"),tm=!1,nm=z_(H_.PromiseRejectionEvent),im=Y_("Promise",(function(){var e=q_(K_),t=e!==String(K_);if(!t&&66===Z_)return!0;if(!$_.catch||!$_.finally)return!0;if(!Z_||Z_<51||!/native code/.test(e)){var n=new K_((function(e){e(1)})),i=function(e){e((function(){}),(function(){}))};if((n.constructor={})[em]=i,!(tm=n.then((function(){}))instanceof i))return!0}return!t&&(X_||Q_)&&!nm})),rm={CONSTRUCTOR:im,REJECTION_EVENT:nm,SUBCLASSING:tm},om={},sm=Pe,am=TypeError,cm=function(e){var t,n;this.promise=new e((function(e,i){if(void 0!==t||void 0!==n)throw am("Bad Promise constructor");t=e,n=i})),this.resolve=sm(t),this.reject=sm(n)};om.f=function(e){return new cm(e)};var dm,lm,um=Nn,hm=Rf,pm=p,fm=L,_m=xs,mm=da,Em=function(e){var t=Cf(e);If&&t&&!t[wf]&&bf(t,wf,{configurable:!0,get:function(){return this}})},gm=Pe,Sm=O,Tm=ne,vm=function(e,t){if(Af(t,e))return e;throw Of("Incorrect invocation")},ym=xf,Rm=h_.set,Cm=F_,bm=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t)}catch(e){}},Im=j_,wm=S_,Am=ba,Om=B_,Nm=rm,Dm=om,Pm="Promise",km=Nm.CONSTRUCTOR,Lm=Nm.REJECTION_EVENT,Mm=Am.getterFor(Pm),Um=Am.set,xm=Om&&Om.prototype,Vm=Om,Fm=xm,jm=pm.TypeError,Bm=pm.document,Gm=pm.process,Wm=Dm.f,Hm=Wm,Km=!!(Bm&&Bm.createEvent&&pm.dispatchEvent),zm="unhandledrejection",Ym=function(e){var t;return!(!Tm(e)||!Sm(t=e.then))&&t},qm=function(e,t){var n,i,r,o=t.value,s=1==t.state,a=s?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(s||(2===t.rejection&&$m(t),t.rejection=1),!0===a?n=o:(l&&l.enter(),n=a(o),l&&(l.exit(),r=!0)),n===e.promise?d(jm("Promise-chain cycle")):(i=Ym(n))?fm(i,n,c,d):c(n)):d(o)}catch(e){l&&!r&&l.exit(),d(e)}},Jm=function(e,t){e.notified||(e.notified=!0,Cm((function(){for(var n,i=e.reactions;n=i.get();)qm(n,e);e.notified=!1,t&&!e.rejection&&Qm(e)})))},Xm=function(e,t,n){var i,r;Km?((i=Bm.createEvent("Event")).promise=t,i.reason=n,i.initEvent(e,!1,!0),pm.dispatchEvent(i)):i={promise:t,reason:n},!Lm&&(r=pm["on"+e])?r(i):e===zm&&bm("Unhandled promise rejection",n)},Qm=function(e){fm(Rm,pm,(function(){var t,n=e.facade,i=e.value;if(Zm(e)&&(t=Im((function(){hm?Gm.emit("unhandledRejection",i,n):Xm(zm,n,i)})),e.rejection=hm||Zm(e)?2:1,t.error))throw t.value}))},Zm=function(e){return 1!==e.rejection&&!e.parent},$m=function(e){fm(Rm,pm,(function(){var t=e.facade;hm?Gm.emit("rejectionHandled",t):Xm("rejectionhandled",t,e.value)}))},eE=function(e,t,n){return function(i){e(t,i,n)}},tE=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,Jm(e,!0))},nE=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw jm("Promise can't be resolved itself");var i=Ym(t);i?Cm((function(){var n={done:!1};try{fm(i,t,eE(nE,n,e),eE(tE,n,e))}catch(t){tE(n,t,e)}})):(e.value=t,e.state=1,Jm(e,!1))}catch(t){tE({done:!1},t,e)}}};km&&(Fm=(Vm=function(e){vm(this,Fm),gm(e),fm(dm,this);var t=Mm(this);try{e(eE(nE,t),eE(tE,t))}catch(e){tE(t,e)}}).prototype,(dm=function(e){Um(this,{type:Pm,done:!1,notified:!1,parent:!1,reactions:new wm,rejection:!1,state:0,value:void 0})}).prototype=_m(Fm,"then",(function(e,t){var n=Mm(this),i=Wm(ym(this,Vm));return n.parent=!0,i.ok=!Sm(e)||e,i.fail=Sm(t)&&t,i.domain=hm?Gm.domain:void 0,0==n.state?n.reactions.add(i):Cm((function(){qm(i,n)})),i.promise})),lm=function(){var e=new dm,t=Mm(e);this.promise=e,this.resolve=eE(nE,t),this.reject=eE(tE,t)},Dm.f=Wm=function(e){return e===Vm||void 0===e?new lm(e):Hm(e)}),um({global:!0,constructor:!0,wrap:!0,forced:km},{Promise:Vm}),mm(Vm,Pm,!1,!0),Em(Pm);var iE=pt("iterator"),rE=!1;try{var oE=0,sE={next:function(){return{done:!!oE++}},return:function(){rE=!0}};sE[iE]=function(){return this},Array.from(sE,(function(){throw 2}))}catch(e){}var aE=B_,cE=function(e,t){if(!t&&!rE)return!1;var n=!1;try{var i={};i[iE]=function(){return{next:function(){return{done:n=!0}}}},e(i)}catch(e){}return n},dE=rm.CONSTRUCTOR||!cE((function(e){aE.all(e).then(void 0,(function(){}))})),lE=L,uE=Pe,hE=om,pE=j_,fE=$p;Nn({target:"Promise",stat:!0,forced:dE},{all:function(e){var t=this,n=hE.f(t),i=n.resolve,r=n.reject,o=pE((function(){var n=uE(t.resolve),o=[],s=0,a=1;fE(e,(function(e){var c=s++,d=!1;a++,lE(n,t,e).then((function(e){d||(d=!0,o[c]=e,--a||i(o))}),r)})),--a||i(o)}));return o.error&&r(o.value),n.promise}});var _E=Nn,mE=rm.CONSTRUCTOR;B_&&B_.prototype,_E({target:"Promise",proto:!0,forced:mE,real:!0},{catch:function(e){return this.then(void 0,e)}});var EE=L,gE=Pe,SE=om,TE=j_,vE=$p;Nn({target:"Promise",stat:!0,forced:dE},{race:function(e){var t=this,n=SE.f(t),i=n.reject,r=TE((function(){var r=gE(t.resolve);vE(e,(function(e){EE(r,t,e).then(n.resolve,i)}))}));return r.error&&i(r.value),n.promise}});var yE=L,RE=om;Nn({target:"Promise",stat:!0,forced:rm.CONSTRUCTOR},{reject:function(e){var t=RE.f(this);return yE(t.reject,void 0,e),t.promise}});var CE=rn,bE=ne,IE=om,wE=function(e,t){if(CE(e),bE(t)&&t.constructor===e)return t;var n=IE.f(e);return(0,n.resolve)(t),n.promise},AE=Nn,OE=B_,NE=rm.CONSTRUCTOR,DE=wE,PE=ce("Promise"),kE=!NE;AE({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return DE(kE&&this===PE?OE:this,e)}});var LE=L,ME=Pe,UE=om,xE=j_,VE=$p;Nn({target:"Promise",stat:!0,forced:dE},{allSettled:function(e){var t=this,n=UE.f(t),i=n.resolve,r=n.reject,o=xE((function(){var n=ME(t.resolve),r=[],o=0,s=1;VE(e,(function(e){var a=o++,c=!1;s++,LE(n,t,e).then((function(e){c||(c=!0,r[a]={status:"fulfilled",value:e},--s||i(r))}),(function(e){c||(c=!0,r[a]={status:"rejected",reason:e},--s||i(r))}))})),--s||i(r)}));return o.error&&r(o.value),n.promise}});var FE=L,jE=Pe,BE=ce,GE=om,WE=j_,HE=$p,KE="No one promise resolved";Nn({target:"Promise",stat:!0,forced:dE},{any:function(e){var t=this,n=BE("AggregateError"),i=GE.f(t),r=i.resolve,o=i.reject,s=WE((function(){var i=jE(t.resolve),s=[],a=0,c=1,d=!1;HE(e,(function(e){var l=a++,u=!1;c++,FE(i,t,e).then((function(e){u||d||(d=!0,r(e))}),(function(e){u||d||(u=!0,s[l]=e,--c||o(new n(s,KE)))}))})),--c||o(new n(s,KE))}));return s.error&&o(s.value),i.promise}});var zE=Nn,YE=B_,qE=r,JE=ce,XE=O,QE=xf,ZE=wE,$E=YE&&YE.prototype;zE({target:"Promise",proto:!0,real:!0,forced:!!YE&&qE((function(){$E.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=QE(this,JE("Promise")),n=XE(e);return this.then(n?function(n){return ZE(t,e()).then((function(){return n}))}:e,n?function(n){return ZE(t,e()).then((function(){throw n}))}:e)}});var eg=ie.Promise,tg=i(eg);const ng=()=>{};function ig(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:ng};return e.promise=new tg(((t,n)=>{e.resolve=n=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(n),e.value=n)},e.reject=t=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,n(t))}})),e}const rg=new Map,og=new Map,sg=new Map;var ag,cg;!function(e){e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot"}(ag||(ag={})),function(e){e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger"}(cg||(cg={}));var dg={exports:{}};!function(e,n){!function(t,i){var r="function",o="undefined",s="object",a="string",c="major",d="model",l="name",u="type",h="vendor",p="version",f="architecture",_="console",m="mobile",E="tablet",g="smarttv",S="wearable",T="embedded",v="Amazon",y="Apple",R="ASUS",C="BlackBerry",b="Browser",I="Chrome",w="Firefox",A="Google",O="Huawei",N="LG",D="Microsoft",P="Motorola",k="Opera",L="Samsung",M="Sharp",U="Sony",x="Xiaomi",V="Zebra",F="Facebook",j="Chromium OS",B="Mac OS",G=function(e){for(var t={},n=0;n<e.length;n++)t[e[n].toUpperCase()]=e[n];return t},W=function(e,t){return typeof e===a&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},K=function(e,t){if(typeof e===a)return e=e.replace(/^\s\s*/,""),typeof t===o?e:e.substring(0,350)},z=function(e,t){for(var n,o,a,c,d,l,u=0;u<t.length&&!d;){var h=t[u],p=t[u+1];for(n=o=0;n<h.length&&!d&&h[n];)if(d=h[n++].exec(e))for(a=0;a<p.length;a++)l=d[++o],typeof(c=p[a])===s&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,l):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=l?l.replace(c[1],c[2]):i:this[c[0]]=l?c[1].call(this,l,c[2]):i:4===c.length&&(this[c[0]]=l?c[3].call(this,l.replace(c[1],c[2])):i):this[c]=l||i;u+=2}},Y=function(e,t){for(var n in t)if(typeof t[n]===s&&t[n].length>0){for(var r=0;r<t[n].length;r++)if(W(t[n][r],e))return"?"===n?i:n}else if(W(t[n],e))return"?"===n?i:n;return e},q={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},J={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,k+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[l,k]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+b]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+b],p],[/\bfocus\/([\w\.]+)/i],[p,[l,w+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,k+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,k+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI "+b]],[/fxios\/([-\w\.]+)/i],[p,[l,w]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+b]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+b],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,F],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,I+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,I+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+b]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,Y,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,w+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,p],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[f,"amd64"]],[/(ia32(?=;))/i],[[f,H]],[/((?:i[346]|x)86)[;\)]/i],[[f,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[f,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[f,"armhf"]],[/windows (ce|mobile); ppc;/i],[[f,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[f,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[f,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[f,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,L],[u,E]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,L],[u,m]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[h,y],[u,m]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,y],[u,E]],[/(macintosh);/i],[d,[h,y]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,M],[u,m]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[h,O],[u,E]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,O],[u,m]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[h,x],[u,m]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[h,x],[u,E]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,"OPPO"],[u,m]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,m]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,m]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,P],[u,m]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,P],[u,E]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,N],[u,E]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,N],[u,m]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[h,"Lenovo"],[u,E]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[h,"Nokia"],[u,m]],[/(pixel c)\b/i],[d,[h,A],[u,E]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,A],[u,m]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,U],[u,m]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,U],[u,E]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,"OnePlus"],[u,m]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,v],[u,E]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,v],[u,m]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,E]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,C],[u,m]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,R],[u,E]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,R],[u,m]],[/(nexus 9)/i],[d,[h,"HTC"],[u,E]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,m]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,E]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,m]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,m]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,E]],[/(surface duo)/i],[d,[h,D],[u,E]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,m]],[/(u304aa)/i],[d,[h,"AT&T"],[u,m]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,m]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,E]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,E]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,E]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,E]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,E]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,E]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,m]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,m]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,E]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,E]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,E]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,E]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,E]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,m]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,m]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,m]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,E]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,E]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,E]],[/(shield[\w ]+) b/i],[d,[h,"Nvidia"],[u,E]],[/(sprint) (\w+)/i],[h,d,[u,m]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,D],[u,m]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,V],[u,E]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,V],[u,m]],[/smart-tv.+(samsung)/i],[h,[u,g]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,L],[u,g]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,N],[u,g]],[/(apple) ?tv/i],[h,[d,y+" TV"],[u,g]],[/crkey/i],[[d,I+"cast"],[h,A],[u,g]],[/droid.+aft(\w)( bui|\))/i],[d,[h,v],[u,g]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,M],[u,g]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,U],[u,g]],[/(mitv-\w{5}) bui/i],[d,[h,x],[u,g]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,g]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,K],[d,K],[u,g]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,g]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,_]],[/droid.+; (shield) bui/i],[d,[h,"Nvidia"],[u,_]],[/(playstation [345portablevi]+)/i],[d,[h,U],[u,_]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,D],[u,_]],[/((pebble))app/i],[h,d,[u,S]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,y],[u,S]],[/droid.+; (glass) \d/i],[d,[h,A],[u,S]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,V],[u,S]],[/(quest( 2| pro)?)/i],[d,[h,F],[u,S]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,T]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[u,m]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,E]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,E]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,m]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[p,Y,q]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[p,Y,q]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,B],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,C]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,w+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,I+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,j],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,p]]},X=function(e,n){if(typeof e===s&&(n=e,e=i),!(this instanceof X))return new X(e,n).getResult();var _=typeof t!==o&&t.navigator?t.navigator:i,g=e||(_&&_.userAgent?_.userAgent:""),S=_&&_.userAgentData?_.userAgentData:i,T=n?function(e,t){var n={};for(var i in e)t[i]&&t[i].length%2==0?n[i]=t[i].concat(e[i]):n[i]=e[i];return n}(J,n):J;return this.getBrowser=function(){var e={};return e[l]=i,e[p]=i,z.call(e,g,T.browser),e[c]=function(e){return typeof e===a?e.replace(/[^\d\.]/g,"").split(".")[0]:i}(e[p]),_&&_.brave&&typeof _.brave.isBrave==r&&(e[l]="Brave"),e},this.getCPU=function(){var e={};return e[f]=i,z.call(e,g,T.cpu),e},this.getDevice=function(){var e={};return e[h]=i,e[d]=i,e[u]=i,z.call(e,g,T.device),!e[u]&&S&&S.mobile&&(e[u]=m),"Macintosh"==e[d]&&_&&typeof _.standalone!==o&&_.maxTouchPoints&&_.maxTouchPoints>2&&(e[d]="iPad",e[u]=E),e},this.getEngine=function(){var e={};return e[l]=i,e[p]=i,z.call(e,g,T.engine),e},this.getOS=function(){var e={};return e[l]=i,e[p]=i,z.call(e,g,T.os),!e[l]&&S&&"Unknown"!=S.platform&&(e[l]=S.platform.replace(/chrome os/i,j).replace(/macos/i,B)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return g},this.setUA=function(e){return g=typeof e===a&&e.length>350?K(e,350):e,this},this.setUA(g),this};X.VERSION="0.7.34",X.BROWSER=G([l,p,c]),X.CPU=G([f]),X.DEVICE=G([d,h,u,_,m,g,E,S,T]),X.ENGINE=X.OS=G([l,p]),e.exports&&(n=e.exports=X),n.UAParser=X;var Q=typeof t!==o&&(t.jQuery||t.Zepto);if(Q&&!Q.ua){var Z=new X;Q.ua=Z.getResult(),Q.ua.get=function(){return Z.getUA()},Q.ua.set=function(e){Z.setUA(e);var t=Z.getResult();for(var n in t)Q.ua[n]=t[n]}}}("object"==typeof window?window:t)}(dg,dg.exports);const lg=new(i(dg.exports));let ug=lg.getResult(),hg=null;function pg(e){if(!hg){e&&lg.setUA(e),ug=lg.getResult();const t=function(e){if("Blink"===e.engine.name&&"WeChat"!==e.browser.name)return cg.CHROME;switch(e.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return cg.CHROME;case"Safari":case"Mobile Safari":return cg.SAFARI;case"Edge":return cg.EDGE;case"Firefox":return cg.FIREFOX;case"QQBrowser":return cg.QQ;case"Opera":return cg.OPERA;case"WeChat":return cg.WECHAT;default:return e.browser.name||""}}(ug),n=function(e){let t;return t="Blink"===e.engine.name?e.engine.version||"":e.browser.version||"",t.split(".")[0]}(ug),i=function(e){return"Windows"===e.os.name?e.os.version?e.os.name+" "+e.os.version:e.os.name:e.os.name||""}(ug),r=ug.os.version;if(!(t&&n&&i&&r))return{name:t,version:n,os:i,osVersion:r};hg={name:t,version:n,os:i,osVersion:r}}return hg}function fg(){return pg().os}function _g(){const e=pg();return"".concat(e.os," ").concat(e.osVersion)}function mg(){const e=pg();return!!("WebKit"===ug.engine.name&&e.os===ag.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==cg.SAFARI||yg()&&e.name!==cg.SAFARI)}function Eg(){const e=pg();if(mg()){if(e.os===ag.MAC_OS)return!0;if(e.os===ag.IOS){const e=ug.os.version&&ug.os.version.split(".");if(e&&14===Number(e[0])&&e[1]&&Number(e[1])>=3)return!0;if(e&&Number(e[0])>14)return!0}}return!1}function gg(){return"WebKit"===ug.engine.name}function Sg(){return pg().name===cg.CHROME}function Tg(){return pg().name===cg.SAFARI}function vg(){return pg().name===cg.FIREFOX}function yg(){return pg().os===ag.IOS}function Rg(e){const t=pg();return!(t.name!==cg.CHROME||!t.osVersion)&&Number(t.version)>=e}function Cg(e){const t=pg();return!(t.name!==cg.EDGE||!t.osVersion)&&Number(t.version)>=e}function bg(e){const t=pg();return!(t.name!==cg.OPERA||!t.osVersion)&&Number(t.version)>=e}function Ig(){const e=pg();return!(e.name!==cg.CHROME||!e.osVersion)&&Number(e.version)<=90}function wg(){const e=pg();if(e.os!==ag.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||14===Number(t[0])&&Number(t[1])<=6}function Ag(){const e=pg();if(e.os!==ag.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])}function Og(){const e=pg();if(e.os!==ag.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 16===Number(t[0])}function Ng(){const e=pg();if(e.os!==ag.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=1}function Dg(){return Tg()&&navigator.maxTouchPoints>0}function Pg(){return pg().name===cg.WECHAT}function kg(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Lg(){const e=pg();return e.name!==cg.EDGE&&e.name!==cg.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Mg(){return fg()===ag.ANDROID}function Ug(){const e=pg();return Mg()&&(e.name===cg.CHROME||e.name===cg.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var xg;!function(e){e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED"}(xg||(xg={}));let Vg=class extends Error{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(t),ih(this,"code",void 0),ih(this,"message",void 0),ih(this,"data",void 0),ih(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=n}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return"error"===e&&(t||console).error(this.toString()),"warning"===e&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function Fg(e,t){if("boolean"!=typeof e)throw new Vg(xg.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function jg(e,t,n){if(!Ai(n).call(n,e))throw new Vg(xg.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(n)))}function Bg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(e<n||e>i||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!function(e){return"number"==typeof e&&e%1==0}(e))throw new Vg(xg.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function Gg(e,t){if("number"!=typeof e){if(!(e.min||e.max||e.ideal||e.exact))throw new Vg(xg.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));void 0!==e.min&&Bg(e.min,"".concat(t,".min"),0,1/0),void 0!==e.max&&Bg(e.max,"".concat(t,".max"),1,1/0),void 0!==e.exact&&Bg(e.exact,"".concat(t,".exact"),1,1/0),void 0!==e.ideal&&Bg(e.ideal,"".concat(t,".ideal"),1,1/0)}else Bg(e,t,1,1/0)}function Wg(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==e)throw new Vg(xg.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!zg(e,n,i,r))throw new Vg(xg.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function Hg(e,t){if(!Array.isArray(e))throw new Vg(xg.INVALID_PARAMS,"".concat(t," should be an array"))}function Kg(e){return null==e}function zg(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof e&&e.length<=n&&e.length>=t&&(!i||function(e){if("string"!=typeof e)return!1;for(let t=0;t<e.length;t+=1){const n=e.charCodeAt(t);if(n<0||n>255)return!1}return!0}(e))}function Yg(e,t,n){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,n);const i=e.getUint32(t,n),r=e.getUint32(t+4,n),o=Number(!!n),s=Number(!n);return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function qg(e,t,n,i){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,n,i);const r=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));i?(e.setUint32(t+4,r,i),e.setUint32(t,o,i)):(e.setUint32(t,r,i),e.setUint32(t+4,o,i))}var Jg,Xg;!function(e){e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE"}(Jg||(Jg={})),function(e){e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(Xg||(Xg={}));const Qg=new class{constructor(){ih(this,"_clientSize",null),ih(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),ih(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),ih(this,"getStyle",(e=>window.getComputedStyle(e,null))),ih(this,"checkCssVisibleProperty",(e=>{var t;let n=!0;const i=this.getStyle(e),{display:r,visibility:o,opacity:s,filter:a}=i;return("none"===r||Ai(t=["hidden","collapse"]).call(t,o)||Number(s)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter((e=>{var t;const n=e.split("(")[0];return Ai(t=["brightness","blur","opacity"]).call(t,n)})).map((e=>{const[t,n]=e.split(/\(|\)/);return[t,Number(n.match(/^[0-9\.]+/))]})).forEach((e=>{const[t,i]=e;switch(t){case"brightness":(i<.1||i>3)&&(n=!1);break;case"blur":i>3&&(n=!1);break;case"opacity":i<.1&&(n=!1)}})),n)})),ih(this,"checkPropertyUpToAllParentNodes",((e,t)=>{let n=!0,i=!0;const r=e=>t(e);let o=e;for(;o&&i;)r(o)||(n=!1,i=!1),o=o.parentElement,o||(i=!1);return n})),ih(this,"checkActualCssVisibleIncludeInherit",(e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty))),ih(this,"getSizeAboutClient",(e=>{const{width:t,height:n,left:i,right:r,top:o,bottom:s}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:n,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),ih(this,"checkActualSize",(()=>{const{width:e,height:t,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(e,t,n)})),ih(this,"elementFromPoint",((e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null)),ih(this,"checkCoverForAPoint",((e,t,n)=>{const i=this.elementFromPoint(e,t);return null!==i&&i!==n})),ih(this,"getPointPositionList",(()=>{const{width:e,height:t,left:n,top:i}=this._clientSize,r=e/6,o=t/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let e=0;e<5;e++){const t=(n*a+(0===c?.1:4===c?(r*c*a-1e5)/a:r*c)*a)/a,d=(i*a+(0===e?.1:4===e?(o*e*a-1e5)/a:o*e)*a)/a;s.push({x:t,y:d})}return[...s]})),ih(this,"checkElementCover",(e=>this.getPointPositionList().map((t=>this.checkCoverForAPoint(t.x,t.y,e))).filter((e=>!!e)).length>6)),ih(this,"checkSizeIsVisible",((e,t,n)=>(e>50||n/e<=10)&&(t>50||n/t<=10))),ih(this,"checkSizeOfPartInClient",(()=>{const{left:e,right:t,top:n,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize;let a,c,d,l;if(e<0)a=0;else{if(!(e<o))return!1;a=e}if(t<0)return!1;if(c=t<o?t:o,n<0)d=0;else{if(!(n<r))return!1;d=n}if(i<0)return!1;l=i<r?i:r;const u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,s)})),ih(this,"returnHiddenResult",(e=>(this._clientSize=null,{visible:!1,reason:e}))),ih(this,"checkOneElementVisible",(e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(Jg.COVERED);{const e=this.checkActualSize(),t=this.checkSizeOfPartInClient();return e&&!t?this.returnHiddenResult(Jg.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Jg.SIZE)}}return this.returnHiddenResult(Jg.STYLE)}return this.returnHiddenResult(Xg.UNMOUNTED)}return this.returnHiddenResult(Xg.INVALID_HTML_ELEMENT)})),ih(this,"checkElementIsMountedOnDom",(e=>this.checkPropertyUpToAllParentNodes(e,(e=>"HTML"!==e.nodeName.toUpperCase()?null!==e.parentElement:!!document.documentElement))))}};function Zg(e){return(new TextEncoder).encode(e)}const $g=function(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n},eS=async e=>{const t=function(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),n=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),i=Zg(e),r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},n,i);return function(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}(new Uint8Array(r))},tS=async e=>function(e,t){let n="";return new Uint8Array(e).forEach((e=>{n+=e.toString(t).padStart(2,"0")})),n}(await crypto.subtle.digest("SHA-256",Zg(e)),16);class nS{constructor(){ih(this,"_events",{}),ih(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map((e=>e.listener)):[]}on(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const n=this._events[e],i=this._indexOfListener(n,t);-1!==i&&n.splice(i,1),0===this._events[e].length&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map((e=>e));for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let o=0;o<t.length;o+=1){const n=t[o];n.once&&this.off(e,n.listener),n.listener.apply(this,i||[])}}safeEmit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];[...this._events[e]||[]].forEach((t=>{t.once&&this.off(e,t.listener);try{t.listener.apply(this,n)}catch(t){console.error("safeEmit event:".concat(e," error ").concat(null==t?void 0:t.toString()))}}))}_indexOfListener(e,t){let n=e.length;for(;n--;)if(e[n].listener===t)return n;return-1}}let iS=null;function rS(){if(iS)return iS;if(window.electron)return iS=window.electron;if(!window.require)return null;try{return iS=window.require("electron"),iS}catch(e){return null}}var oS,sS,aS,cS,dS,lS,uS,hS;function pS(e){return Bg(e.timeout,"config.timeout",0,1e5),Bg(e.timeoutFactor,"config.timeoutFactor",0,100,!1),Bg(e.maxRetryCount,"config.maxRetryConfig",0,1/0),Bg(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function fS(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach((e=>{if(!e.urls)throw Error()}))}catch(e){return!1}return!0}function _S(e){return Wg(e.turnServerURL,"turnServerURL"),Wg(e.username,"username"),Wg(e.password,"password"),e.udpport&&Bg(e.udpport,"udpport",1,99999,!0),e.forceturn&&Fg(e.forceturn,"forceturn"),e.security&&Fg(e.security,"security"),e.tcpport&&Bg(e.tcpport,"tcpport",1,99999,!0),!0}function mS(e){return void 0!==e.level&&jg(e.level,"level",[1,2,3]),void 0!==e.delay&&Bg(e.delay,"delay",0,3e3,!0),!0}function ES(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return 0===e.getListeners(t).length?tg.reject(new Vg(xg.UNEXPECTED_ERROR,"can not emit promise")):new tg(((n,r)=>{e.emit(t,...i,n,r)}))}function gS(e,t){if(0===e.getListeners(t).length)return tg.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return ES(e,t,...i)}function SS(e,t){if(0===e.getListeners(t).length)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return TS(e,t,...i)}function TS(e,t){let n=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(e.emit(t,...o,(e=>{n=e}),(e=>{i=e})),null!==i)throw i;if(null===n)throw new Vg(xg.UNEXPECTED_ERROR,"handler is not sync");return n}!function(e){e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.DATACHANNEL_FAILBACK="Client._datachannelFailback",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",e.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload"}(oS||(oS={})),function(e){e.TRACER="tracer"}(sS||(sS={})),function(e){e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(aS||(aS={})),function(e){e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.FALLBACK="FALLBACK",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE"}(cS||(cS={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.INJECT_STREAM_STATUS="stream-inject-status",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(dS||(dS={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}(lS||(lS={})),function(e){e.ONLINE="ONLINE",e.OFFLINE="OFFLINE"}(uS||(uS={})),function(e){e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE"}(hS||(hS={}));const vS=new class extends nS{set networkState(e){this.emit(hS.NETWORK_STATE_CHANGE,e,this._networkState),e===uS.ONLINE?this.emit(hS.ONLINE):e===uS.OFFLINE&&(this.onlineWaiter=new tg((e=>{this.once(hS.ONLINE,(()=>{this.onlineWaiter=void 0,e(uS.ONLINE)}))})),this.emit(hS.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===uS.ONLINE}constructor(){super(),ih(this,"_moduleName","network-indicator"),ih(this,"_networkState",uS.ONLINE),ih(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=uS.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=uS.OFFLINE}))}};function yS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function RS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?yS(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):yS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function CS(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}function bS(e){const t=[];return e.forEach((e=>{-1===t.indexOf(e)&&t.push(e)})),t}function IS(e){void 0!==tg?tg.resolve().then(e):setTimeout(e,0)}function wS(e){return JSON.parse(JSON.stringify(e))}function AS(e){try{return wS(e)}catch(t){return e}}const OS={};function NS(e,t){OS[t]||(OS[t]=!0,e())}function DS(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}function PS(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}function kS(e){return window.TextEncoder?(new TextEncoder).encode(e).length:e.length}function LS(e){let t=0;return/DingTalk/i.test(navigator.userAgent)&&e.realFormData&&(e=e.realFormData),e.forEach((e=>{t+="string"==typeof e?kS(e):e.size})),t+138}function MS(e){const t=new Vg(xg.TIMEOUT,"timeout");return new tg(((n,i)=>{window.setTimeout((()=>i(t)),e)}))}function US(e){return new tg((t=>{window.setTimeout(t,e)}))}function xS(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,e).toLowerCase();return n.length===e?"".concat(t).concat(n):"".concat(t).concat(n)+xS(e-n.length,"")}function VS(){return xS(32,"").toUpperCase()}const FS=()=>{},jS=new class{constructor(){ih(this,"fnMap",new Map)}throttleByKey(e,t,n,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(t)){const r=this.fnMap.get(t);if(r.threshold!==n){r.fn(...r.args),clearTimeout(r.timer);const s=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:s,args:o,skipFn:i})}else r.skipFn&&r.skipFn(...r.args),this.fnMap.set(t,RS(RS({},r),{},{fn:e,args:o,skipFn:i}))}else{const r=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:r,args:o,skipFn:i})}}},BS=jS.throttleByKey.bind(jS);function GS(e){return"object"==typeof e&&null!==e&&!(e instanceof RegExp)}function WS(e,t){if(!GS(e)||!GS(t))return t;if(Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const n=[...e];for(let i=0;i<t.length;i++)n[i]=WS(e[i],t[i]);return n}{const n=RS({},e);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)?n[i]=WS(e[i],t[i]):n[i]=t[i]);return n}}let HS=1,KS=console;class zS{static setLogger(e){KS=e}constructor(e){ih(this,"lockingPromise",tg.resolve()),ih(this,"locks",0),ih(this,"name",""),ih(this,"lockId",void 0),this.lockId=HS++,e&&(this.name=e),KS.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,KS.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:""));const n=new tg((n=>{t=()=>{this.locks-=1,KS.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:"")),n()}})),i=this.lockingPromise.then((()=>t));return this.lockingPromise=this.lockingPromise.then((()=>n)),i}}function YS(e,t){return function(n,i,r){const o=r.value;if("function"!=typeof o)throw new Error("Cannot use mutex on object property.");return r.value=async function(){const n=this[t];if(!n)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const r=await n.lock("From ".concat(e,".").concat(i));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await o.apply(this,a)}finally{r()}},r}}const qS={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function JS(e,t){const n=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,n)}function XS(e,t,n,i){const r=Object.assign({},qS,i);let o=r.timeout;const s=async()=>{await function(e){return new tg((t=>{window.setTimeout(t,e)}))}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)};let a=!1;const c=new tg((async(i,o)=>{t=t||(()=>!1),n=n||(()=>!0);for(let c=0;c<r.maxRetryCount;c+=1){if(a)return o(new Vg(xg.OPERATION_ABORTED));try{const n=await e();if(!t(n,c))return i(n);if(c+1===r.maxRetryCount)return i(n);await s()}catch(e){if(!n(e,c))return o(e);if(c+1===r.maxRetryCount)return o(e);await s()}}}));return c.cancel=()=>a=!0,c}var QS=Pe,ZS=Xe,$S=z,eT=Gn,tT=TypeError,nT=function(e){return function(t,n,i,r){QS(n);var o=ZS(t),s=$S(o),a=eT(o),c=e?a-1:0,d=e?-1:1;if(i<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,e?c<0:a<=c)throw tT("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=d)c in s&&(r=n(r,s[c],c,o));return r}},iT=[nT(!1),nT(!0)][0];Nn({target:"Array",proto:!0,forced:!Rf&&me>79&&me<83||!vh("reduce")},{reduce:function(e){var t=arguments.length;return iT(this,e,t,t>1?arguments[1]:void 0)}});var rT=Xn("Array").reduce,oT=u,sT=rT,aT=Array.prototype,cT=i((function(e){var t=e.reduce;return e===aT||oT(aT,e)&&t===aT.reduce?sT:t}));let dT=class{constructor(e){ih(this,"input",[]),ih(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return 0===this.input.length?0:cT(e=this.input).call(e,((e,t)=>e+t))/this.input.length}};var lT,uT={exports:{}},hT=function(e,t){return function(){for(var n=new Array(arguments.length),i=0;i<n.length;i++)n[i]=arguments[i];return e.apply(t,n)}},pT=hT,fT=Object.prototype.toString,_T=(lT=Object.create(null),function(e){var t=fT.call(e);return lT[t]||(lT[t]=t.slice(8,-1).toLowerCase())});function mT(e){return e=e.toLowerCase(),function(t){return _T(t)===e}}function ET(e){return Array.isArray(e)}function gT(e){return void 0===e}var ST=mT("ArrayBuffer");function TT(e){return null!==e&&"object"==typeof e}function vT(e){if("object"!==_T(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}var yT=mT("Date"),RT=mT("File"),CT=mT("Blob"),bT=mT("FileList");function IT(e){return"[object Function]"===fT.call(e)}var wT=mT("URLSearchParams");function AT(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),ET(e))for(var n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)}var OT,NT=(OT="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(e){return OT&&e instanceof OT}),DT={isArray:ET,isArrayBuffer:ST,isBuffer:function(e){return null!==e&&!gT(e)&&null!==e.constructor&&!gT(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){var t="[object FormData]";return e&&("function"==typeof FormData&&e instanceof FormData||fT.call(e)===t||IT(e.toString)&&e.toString()===t)},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&ST(e.buffer)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:TT,isPlainObject:vT,isUndefined:gT,isDate:yT,isFile:RT,isBlob:CT,isFunction:IT,isStream:function(e){return TT(e)&&IT(e.pipe)},isURLSearchParams:wT,isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:AT,merge:function e(){var t={};function n(n,i){vT(t[i])&&vT(n)?t[i]=e(t[i],n):vT(n)?t[i]=e({},n):ET(n)?t[i]=n.slice():t[i]=n}for(var i=0,r=arguments.length;i<r;i++)AT(arguments[i],n);return t},extend:function(e,t,n){return AT(t,(function(t,i){e[i]=n&&"function"==typeof t?pT(t,n):t})),e},trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e},inherits:function(e,t,n,i){e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,n&&Object.assign(e.prototype,n)},toFlatObject:function(e,t,n){var i,r,o,s={};t=t||{};do{for(r=(i=Object.getOwnPropertyNames(e)).length;r-- >0;)s[o=i[r]]||(t[o]=e[o],s[o]=!0);e=Object.getPrototypeOf(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:_T,kindOfTest:mT,endsWith:function(e,t,n){e=String(e),(void 0===n||n>e.length)&&(n=e.length),n-=t.length;var i=e.indexOf(t,n);return-1!==i&&i===n},toArray:function(e){if(!e)return null;var t=e.length;if(gT(t))return null;for(var n=new Array(t);t-- >0;)n[t]=e[t];return n},isTypedArray:NT,isFileList:bT},PT=DT;function kT(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var LT=function(e,t,n){if(!t)return e;var i;if(n)i=n(t);else if(PT.isURLSearchParams(t))i=t.toString();else{var r=[];PT.forEach(t,(function(e,t){null!=e&&(PT.isArray(e)?t+="[]":e=[e],PT.forEach(e,(function(e){PT.isDate(e)?e=e.toISOString():PT.isObject(e)&&(e=JSON.stringify(e)),r.push(kT(t)+"="+kT(e))})))})),i=r.join("&")}if(i){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+i}return e},MT=DT;function UT(){this.handlers=[]}UT.prototype.use=function(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1},UT.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},UT.prototype.forEach=function(e){MT.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var xT,VT,FT=UT,jT=DT;function BT(){if(VT)return xT;VT=1;var e=DT;function t(e,t,n,i,r){Error.call(this),this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r)}e.inherits(t,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var n=t.prototype,i={};return["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(e){i[e]={value:e}})),Object.defineProperties(t,i),Object.defineProperty(n,"isAxiosError",{value:!0}),t.from=function(i,r,o,s,a,c){var d=Object.create(n);return e.toFlatObject(i,d,(function(e){return e!==Error.prototype})),t.call(d,i.message,r,o,s,a),d.name=i.name,c&&Object.assign(d,c),d},xT=t}var GT,WT,HT,KT,zT,YT,qT={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function JT(){if(WT)return GT;WT=1;var e=DT;return GT=function(t,n){n=n||new FormData;var i=[];function r(t){return null===t?"":e.isDate(t)?t.toISOString():e.isArrayBuffer(t)||e.isTypedArray(t)?"function"==typeof Blob?new Blob([t]):Buffer.from(t):t}return function t(o,s){if(e.isPlainObject(o)||e.isArray(o)){if(-1!==i.indexOf(o))throw Error("Circular reference detected in "+s);i.push(o),e.forEach(o,(function(i,o){if(!e.isUndefined(i)){var a,c=s?s+"."+o:o;if(i&&!s&&"object"==typeof i)if(e.endsWith(o,"{}"))i=JSON.stringify(i);else if(e.endsWith(o,"[]")&&(a=e.toArray(i)))return void a.forEach((function(t){!e.isUndefined(t)&&n.append(c,r(t))}));t(i,c)}})),i.pop()}else n.append(s,r(o))}(t),n},GT}function XT(){if(KT)return HT;KT=1;var e=BT();return HT=function(t,n,i){var r=i.config.validateStatus;i.status&&r&&!r(i.status)?n(new e("Request failed with status code "+i.status,[e.ERR_BAD_REQUEST,e.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)}}function QT(){if(YT)return zT;YT=1;var e=DT;return zT=e.isStandardBrowserEnv()?{write:function(t,n,i,r,o,s){var a=[];a.push(t+"="+encodeURIComponent(n)),e.isNumber(i)&&a.push("expires="+new Date(i).toGMTString()),e.isString(r)&&a.push("path="+r),e.isString(o)&&a.push("domain="+o),!0===s&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},zT}var ZT,$T,ev,tv,nv,iv,rv,ov,sv,av,cv,dv,lv=function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)},uv=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e},hv=function(e,t){return e&&!lv(t)?uv(e,t):t};function pv(){if($T)return ZT;$T=1;var e=DT,t=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return ZT=function(n){var i,r,o,s={};return n?(e.forEach(n.split("\n"),(function(n){if(o=n.indexOf(":"),i=e.trim(n.substr(0,o)).toLowerCase(),r=e.trim(n.substr(o+1)),i){if(s[i]&&t.indexOf(i)>=0)return;s[i]="set-cookie"===i?(s[i]?s[i]:[]).concat([r]):s[i]?s[i]+", "+r:r}})),s):s},ZT}function fv(){if(tv)return ev;tv=1;var e=DT;return ev=e.isStandardBrowserEnv()?function(){var t,n=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function r(e){var t=e;return n&&(i.setAttribute("href",t),t=i.href),i.setAttribute("href",t),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return t=r(window.location.href),function(n){var i=e.isString(n)?r(n):n;return i.protocol===t.protocol&&i.host===t.host}}():function(){return!0}}function _v(){if(iv)return nv;iv=1;var e=BT();function t(t){e.call(this,null==t?"canceled":t,e.ERR_CANCELED),this.name="CanceledError"}return DT.inherits(t,e,{__CANCEL__:!0}),nv=t}function mv(){return ov||(ov=1,rv=function(e){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}),rv}function Ev(){if(av)return sv;av=1;var e=DT,t=XT(),n=QT(),i=LT,r=hv,o=pv(),s=fv(),a=qT,c=BT(),d=_v(),l=mv();return sv=function(u){return new Promise((function(h,p){var f,_=u.data,m=u.headers,E=u.responseType;function g(){u.cancelToken&&u.cancelToken.unsubscribe(f),u.signal&&u.signal.removeEventListener("abort",f)}e.isFormData(_)&&e.isStandardBrowserEnv()&&delete m["Content-Type"];var S=new XMLHttpRequest;if(u.auth){var T=u.auth.username||"",v=u.auth.password?unescape(encodeURIComponent(u.auth.password)):"";m.Authorization="Basic "+btoa(T+":"+v)}var y=r(u.baseURL,u.url);function R(){if(S){var e="getAllResponseHeaders"in S?o(S.getAllResponseHeaders()):null,n={data:E&&"text"!==E&&"json"!==E?S.response:S.responseText,status:S.status,statusText:S.statusText,headers:e,config:u,request:S};t((function(e){h(e),g()}),(function(e){p(e),g()}),n),S=null}}if(S.open(u.method.toUpperCase(),i(y,u.params,u.paramsSerializer),!0),S.timeout=u.timeout,"onloadend"in S?S.onloadend=R:S.onreadystatechange=function(){S&&4===S.readyState&&(0!==S.status||S.responseURL&&0===S.responseURL.indexOf("file:"))&&setTimeout(R)},S.onabort=function(){S&&(p(new c("Request aborted",c.ECONNABORTED,u,S)),S=null)},S.onerror=function(){p(new c("Network Error",c.ERR_NETWORK,u,S,S)),S=null},S.ontimeout=function(){var e=u.timeout?"timeout of "+u.timeout+"ms exceeded":"timeout exceeded",t=u.transitional||a;u.timeoutErrorMessage&&(e=u.timeoutErrorMessage),p(new c(e,t.clarifyTimeoutError?c.ETIMEDOUT:c.ECONNABORTED,u,S)),S=null},e.isStandardBrowserEnv()){var C=(u.withCredentials||s(y))&&u.xsrfCookieName?n.read(u.xsrfCookieName):void 0;C&&(m[u.xsrfHeaderName]=C)}"setRequestHeader"in S&&e.forEach(m,(function(e,t){void 0===_&&"content-type"===t.toLowerCase()?delete m[t]:S.setRequestHeader(t,e)})),e.isUndefined(u.withCredentials)||(S.withCredentials=!!u.withCredentials),E&&"json"!==E&&(S.responseType=u.responseType),"function"==typeof u.onDownloadProgress&&S.addEventListener("progress",u.onDownloadProgress),"function"==typeof u.onUploadProgress&&S.upload&&S.upload.addEventListener("progress",u.onUploadProgress),(u.cancelToken||u.signal)&&(f=function(e){S&&(p(!e||e&&e.type?new d:e),S.abort(),S=null)},u.cancelToken&&u.cancelToken.subscribe(f),u.signal&&(u.signal.aborted?f():u.signal.addEventListener("abort",f))),_||(_=null);var b=l(y);b&&-1===["http","https","file"].indexOf(b)?p(new c("Unsupported protocol "+b+":",c.ERR_BAD_REQUEST,u)):S.send(_)}))},sv}var gv=DT,Sv=function(e,t){jT.forEach(e,(function(n,i){i!==t&&i.toUpperCase()===t.toUpperCase()&&(e[t]=n,delete e[i])}))},Tv=BT(),vv=qT,yv=JT(),Rv={"Content-Type":"application/x-www-form-urlencoded"};function Cv(e,t){!gv.isUndefined(e)&&gv.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var bv,Iv={transitional:vv,adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(bv=Ev()),bv),transformRequest:[function(e,t){if(Sv(t,"Accept"),Sv(t,"Content-Type"),gv.isFormData(e)||gv.isArrayBuffer(e)||gv.isBuffer(e)||gv.isStream(e)||gv.isFile(e)||gv.isBlob(e))return e;if(gv.isArrayBufferView(e))return e.buffer;if(gv.isURLSearchParams(e))return Cv(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString();var n,i=gv.isObject(e),r=t&&t["Content-Type"];if((n=gv.isFileList(e))||i&&"multipart/form-data"===r){var o=this.env&&this.env.FormData;return yv(n?{"files[]":e}:e,o&&new o)}return i||"application/json"===r?(Cv(t,"application/json"),function(e,t,n){if(gv.isString(e))try{return(t||JSON.parse)(e),gv.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(n||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){var t=this.transitional||Iv.transitional,n=t&&t.silentJSONParsing,i=t&&t.forcedJSONParsing,r=!n&&"json"===this.responseType;if(r||i&&gv.isString(e)&&e.length)try{return JSON.parse(e)}catch(e){if(r){if("SyntaxError"===e.name)throw Tv.from(e,Tv.ERR_BAD_RESPONSE,this,null,this.response);throw e}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:dv?cv:(dv=1,cv=null)},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};gv.forEach(["delete","get","head"],(function(e){Iv.headers[e]={}})),gv.forEach(["post","put","patch"],(function(e){Iv.headers[e]=gv.merge(Rv)}));var wv,Av,Ov=Iv,Nv=DT,Dv=Ov;function Pv(){return Av?wv:(Av=1,wv=function(e){return!(!e||!e.__CANCEL__)})}var kv=DT,Lv=function(e,t,n){var i=this||Dv;return Nv.forEach(n,(function(n){e=n.call(i,e,t)})),e},Mv=Pv(),Uv=Ov,xv=_v();function Vv(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new xv}var Fv,jv,Bv=DT,Gv=function(e,t){t=t||{};var n={};function i(e,t){return Bv.isPlainObject(e)&&Bv.isPlainObject(t)?Bv.merge(e,t):Bv.isPlainObject(t)?Bv.merge({},t):Bv.isArray(t)?t.slice():t}function r(n){return Bv.isUndefined(t[n])?Bv.isUndefined(e[n])?void 0:i(void 0,e[n]):i(e[n],t[n])}function o(e){if(!Bv.isUndefined(t[e]))return i(void 0,t[e])}function s(n){return Bv.isUndefined(t[n])?Bv.isUndefined(e[n])?void 0:i(void 0,e[n]):i(void 0,t[n])}function a(n){return n in t?i(e[n],t[n]):n in e?i(void 0,e[n]):void 0}var c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a};return Bv.forEach(Object.keys(e).concat(Object.keys(t)),(function(e){var t=c[e]||r,i=t(e);Bv.isUndefined(i)&&t!==a||(n[e]=i)})),n};function Wv(){return jv?Fv:(jv=1,Fv={version:"0.27.2"})}var Hv=Wv().version,Kv=BT(),zv={};["object","boolean","number","function","string","symbol"].forEach((function(e,t){zv[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));var Yv={};zv.transitional=function(e,t,n){function i(e,t){return"[Axios v"+Hv+"] Transitional option '"+e+"'"+t+(n?". "+n:"")}return function(n,r,o){if(!1===e)throw new Kv(i(r," has been removed"+(t?" in "+t:"")),Kv.ERR_DEPRECATED);return t&&!Yv[r]&&(Yv[r]=!0,console.warn(i(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,r,o)}};var qv,Jv,Xv,Qv,Zv,$v,ey={assertOptions:function(e,t,n){if("object"!=typeof e)throw new Kv("options must be an object",Kv.ERR_BAD_OPTION_VALUE);for(var i=Object.keys(e),r=i.length;r-- >0;){var o=i[r],s=t[o];if(s){var a=e[o],c=void 0===a||s(a,o,e);if(!0!==c)throw new Kv("option "+o+" must be "+c,Kv.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new Kv("Unknown option "+o,Kv.ERR_BAD_OPTION)}},validators:zv},ty=DT,ny=LT,iy=FT,ry=function(e){return Vv(e),e.headers=e.headers||{},e.data=Lv.call(e,e.data,e.headers,e.transformRequest),e.headers=kv.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),kv.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||Uv.adapter)(e).then((function(t){return Vv(e),t.data=Lv.call(e,t.data,t.headers,e.transformResponse),t}),(function(t){return Mv(t)||(Vv(e),t&&t.response&&(t.response.data=Lv.call(e,t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},oy=Gv,sy=hv,ay=ey,cy=ay.validators;function dy(e){this.defaults=e,this.interceptors={request:new iy,response:new iy}}dy.prototype.request=function(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},(t=oy(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var n=t.transitional;void 0!==n&&ay.assertOptions(n,{silentJSONParsing:cy.transitional(cy.boolean),forcedJSONParsing:cy.transitional(cy.boolean),clarifyTimeoutError:cy.transitional(cy.boolean)},!1);var i=[],r=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(r=r&&e.synchronous,i.unshift(e.fulfilled,e.rejected))}));var o,s=[];if(this.interceptors.response.forEach((function(e){s.push(e.fulfilled,e.rejected)})),!r){var a=[ry,void 0];for(Array.prototype.unshift.apply(a,i),a=a.concat(s),o=Promise.resolve(t);a.length;)o=o.then(a.shift(),a.shift());return o}for(var c=t;i.length;){var d=i.shift(),l=i.shift();try{c=d(c)}catch(e){l(e);break}}try{o=ry(c)}catch(e){return Promise.reject(e)}for(;s.length;)o=o.then(s.shift(),s.shift());return o},dy.prototype.getUri=function(e){e=oy(this.defaults,e);var t=sy(e.baseURL,e.url);return ny(t,e.params,e.paramsSerializer)},ty.forEach(["delete","get","head","options"],(function(e){dy.prototype[e]=function(t,n){return this.request(oy(n||{},{method:e,url:t,data:(n||{}).data}))}})),ty.forEach(["post","put","patch"],(function(e){function t(t){return function(n,i,r){return this.request(oy(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:n,data:i}))}}dy.prototype[e]=t(),dy.prototype[e+"Form"]=t(!0)}));var ly=DT,uy=hT,hy=dy,py=Gv,fy=function e(t){var n=new hy(t),i=uy(hy.prototype.request,n);return ly.extend(i,hy.prototype,n),ly.extend(i,n),i.create=function(n){return e(py(t,n))},i}(Ov);fy.Axios=hy,fy.CanceledError=_v(),fy.CancelToken=function(){if(Jv)return qv;Jv=1;var e=_v();function t(t){if("function"!=typeof t)throw new TypeError("executor must be a function.");var n;this.promise=new Promise((function(e){n=e}));var i=this;this.promise.then((function(e){if(i._listeners){var t,n=i._listeners.length;for(t=0;t<n;t++)i._listeners[t](e);i._listeners=null}})),this.promise.then=function(e){var t,n=new Promise((function(e){i.subscribe(e),t=e})).then(e);return n.cancel=function(){i.unsubscribe(t)},n},t((function(t){i.reason||(i.reason=new e(t),n(i.reason))}))}return t.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},t.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},t.prototype.unsubscribe=function(e){if(this._listeners){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}},t.source=function(){var e;return{token:new t((function(t){e=t})),cancel:e}},qv=t}(),fy.isCancel=Pv(),fy.VERSION=Wv().version,fy.toFormData=JT(),fy.AxiosError=BT(),fy.Cancel=fy.CanceledError,fy.all=function(e){return Promise.all(e)},fy.spread=Qv?Xv:(Qv=1,Xv=function(e){return function(t){return e.apply(null,t)}}),fy.isAxiosError=function(){if($v)return Zv;$v=1;var e=DT;return Zv=function(t){return e.isObject(t)&&!0===t.isAxiosError}}(),uT.exports=fy,uT.exports.default=fy;var _y=i(uT.exports);function my(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ey(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?my(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):my(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let gy,Sy=0,Ty=0;function vy(e,t,n,i){return new tg(((r,o)=>{t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),Sy+=kS(t.data)):n&&(t.data.size?Sy+=t.data.size:t.data instanceof FormData?Sy+=LS(t.data):Sy+=kS(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,_y.request(t).then((e=>{"string"==typeof e.data?Ty+=kS(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?Ty+=e.data.byteLength:Ty+=kS(JSON.stringify(e.data)),i&&r({data:e.data,headers:e.headers}),r(e.data)})).catch((e=>{_y.isCancel(e)?o(new Vg(xg.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new Vg(xg.NETWORK_TIMEOUT,e.message)):e.response?o(new Vg(xg.NETWORK_RESPONSE_ERROR,e.response.status)):o(new Vg(xg.NETWORK_ERROR,e.message))}))}))}async function yy(e,t){const n=new Blob([t.data],{type:"buffer"});return await vy(e,Ey(Ey({},t),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const Ry=()=>"HTTPS"===(gy||gy||(gy=(window.location.protocol.split(":")[0]||"").toUpperCase(),gy)),Cy=()=>void 0!==window.isSecureContext,by=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const e=t[1],n=t[2];return"".concat(e,".").concat(n)}const n=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(n&&n[1]&&n[2]){const e=n[1],t=n[2];return"".concat(e,".").concat(100*(Number(t)+1))}return"4.0.0.999"}("4.20.0"),Iy=function(){try{return!0===JSON.parse("true")}catch(e){return!0}}();var wy;!function(e){e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn"}(wy||(wy={}));const Ay="v4.20.0-0-g334e514b-dirty(12/8/2023, 3:48:29 PM)",Oy={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function Ny(e,t,n){var i,r;Ai(i=Object.keys(Oy)).call(i,e)&&(!n&&Ai(r=Object.keys(Py)).call(r,e)||(Oy[e]=t))}function Dy(e){return Oy[e]}const Py={};function ky(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ly(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ky(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ky(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var My,Uy,xy;!function(e){e.SET_SESSION_ID="SET_SESSION_ID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.AVOID_JOIN_START="AVOID_JOIN_START",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE"}(My||(My={}));class Vy{constructor(e,t,n,i){ih(this,"state",void 0),this.state={codec:e,audioCodec:t,mode:n,clientId:i,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:wy.Default}}dispatch(e){this.state=function(e,t){switch(t.type){case My.SET_SESSION_ID:return Ly(Ly({},e),{},{sessionId:t.sessionId});case My.SET_P2P_ID:return Ly(Ly({},e),{},{p2pId:t.p2pId});case My.SET_UID:return Ly(Ly({},e),{},{uid:t.uid});case My.SET_INT_UID:return Ly(Ly({},e),{},{intUid:t.intUid});case My.SET_PUB_ID:return Ly(Ly({},e),{},{pubId:t.pubId});case My.KEY_METRIC_CLIENT_CREATED:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{clientCreated:t.metric})});case My.KEY_METRIC_JOIN_START:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{joinStart:t.metric})});case My.AVOID_JOIN_START:return Ly(Ly({},e),{},{avoidJoinStart:t.avoidJoinStart});case My.KEY_METRIC_JOIN_END:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{joinEnd:t.metric})});case My.KEY_METRIC_REQUEST_AP_START:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{requestAPStart:t.metric})});case My.KEY_METRIC_REQUEST_AP_END:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{requestAPEnd:t.metric})});case My.KEY_METRIC_JOIN_GATEWAY_START:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{joinGatewayStart:t.metric})});case My.KEY_METRIC_JOIN_GATEWAY_END:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{joinGatewayEnd:t.metric})});case My.KEY_METRIC_PEER_CONNECTION_START:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{peerConnectionStart:t.metric})});case My.KEY_METRIC_PEER_CONNECTION_END:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{peerConnectionEnd:t.metric})});case My.KEY_METRIC_DESCRIPTION_START:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{descriptionStart:t.metric})});case My.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{signalChannelOpen:t.metric})});case My.KEY_METRIC_ICE_CONNECTION_END:return Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{iceConnectionEnd:t.metric})});case My.KEY_METRIC_PUBLISH:{const n=e.keyMetrics.publish,i=n.findIndex((e=>e.trackId===t.metric.trackId));return-1!==i?(n[i]=Ly(Ly({},n[i]),t.metric),Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{publish:[...n]})})):Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,t.metric]})})}case My.KEY_METRIC_SUBSCRIBE:{const n=e.keyMetrics.subscribe,i=n.findIndex((e=>e.userId===t.metric.userId&&e.type===t.metric.type));return-1!==i?(n[i]=Ly(Ly({},n[i]),t.metric),Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{subscribe:[...n]})})):Ly(Ly({},e),{},{keyMetrics:Ly(Ly({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,t.metric]})})}case My.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=t.mode,e;case My.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof t.index?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,t.record]:(e.joinChannelServiceRecords[t.index]=Ly(Ly({},e.joinChannelServiceRecords[t.index]),t.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case My.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case My.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case My.SET_USE_DATACHANNEL:return Ly(Ly({},e),{},{useDataChannel:t.val});case My.SET_USE_P2P:return Ly(Ly({},e),{},{useP2P:t.val});case My.SET_TRANSPORT_TYPE:return Ly(Ly({},e),{},{p2pTransport:t.val});default:return e}}(this.state,e)}set sessionId(e){this.dispatch({type:My.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:My.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:My.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:My.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:My.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:My.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:My.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:My.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:My.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:My.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:My.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:My.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:My.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:My.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:My.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:My.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:My.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:My.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:My.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:My.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:My.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:My.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,t,n,i){this.dispatch({type:My.KEY_METRIC_PUBLISH,metric:Ly(Ly({trackId:e,type:t},n&&{publishStart:n}),i&&{publishEnd:i})})}subscribe(e,t,n,i,r,o,s){this.dispatch({type:My.KEY_METRIC_SUBSCRIBE,metric:Ly(Ly(Ly(Ly(Ly({userId:e,type:t},n&&{subscribeStart:n}),i&&{subscribeEnd:i}),r&&{firstFrame:r}),o&&{streamAdded:o}),s&&{firstDecoded:s})})}massSubscribe(e,t,n,i){e.forEach((e=>{this.dispatch({type:My.KEY_METRIC_SUBSCRIBE,metric:Ly(Ly(Ly({userId:e.userId,type:e.type},t&&{subscribeStart:t}),n&&{subscribeEnd:n}),i&&{firstFrame:i})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,t){"gateway"===e.service&&Array.isArray(e.urls)&&(e.urls=e.urls.map((e=>e.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof t?(this.dispatch({type:My.RECORD_JOIN_CHANNEL_SERVICE,record:Ly(Ly({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(t<0||t>=this.state.joinChannelServiceRecords.length||this.dispatch({type:My.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:t}),t)}catch(e){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:My.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:My.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(e){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:My.AVOID_JOIN_START,avoidJoinStart:e})}}!function(e){e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1"}(Uy||(Uy={})),function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"}(xy||(xy={}));const Fy=new class extends nS{reportLogUploadError(e){this.emit("REPORT_LOG_UPLOAD",e)}};class jy{constructor(e){ih(this,"logger",void 0),ih(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.debug(...this.prefixLists,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.info(...this.prefixLists,...t)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.warning(...this.prefixLists,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.error(...this.prefixLists,...t)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function By(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function Gy(){const e=new Date,t=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return t?(null==t?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const Wy={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Hy=Date.now(),Ky=e=>{for(const t in Wy)if(Object.prototype.hasOwnProperty.call(Wy,t)&&Wy[t]===e)return t;return"DEFAULT"},zy=new class{constructor(){ih(this,"proxyServerURL",void 0),ih(this,"logLevel",Wy.DEBUG),ih(this,"uploadState","collecting"),ih(this,"uploadLogWaitingList",[]),ih(this,"uploadLogUploadingList",[]),ih(this,"uploadErrorCount",0),ih(this,"currentLogID",0),ih(this,"url",void 0),ih(this,"extLog",((e,t)=>{this.appendLogToWaitingList(e,...t)}))}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Wy.DEBUG].concat(t);this.log.apply(this,i)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Wy.INFO].concat(t);this.log.apply(this,i)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Wy.WARNING].concat(t);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Wy.ERROR].concat(t);this.log.apply(this,i)}upload(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Wy.DEBUG].concat(t);this.uploadLog.apply(this,i)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){Ny("UPLOAD_LOG",!0)}disableLogUpload(){Ny("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new jy(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Hy<100)return void setTimeout((()=>{this.log(...t)}),Date.now()-Hy);const i=Math.max(0,Math.min(4,t[0]));if(t[0]=By()+" Agora-SDK [".concat(Ky(i),"]:"),this.appendLogToWaitingList(i,...t),i<this.logLevel)return;const r=By()+" %cAgora-SDK [".concat(Ky(i),"]:");let o=[];if(!Dy("USE_NEW_LOG"))switch(i){case Wy.DEBUG:o=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,o);break;case Wy.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,o);break;case Wy.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,o);break;case Wy.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Hy<100)return void setTimeout((()=>{this.uploadLog(...t)}),Date.now()-Hy);const i=Math.max(0,Math.min(4,t[0]));t[0]=By()+" Agora-SDK [".concat(Ky(i),"]:"),this.appendLogToWaitingList(i,...t)}appendLogToWaitingList(e){if(!Dy("UPLOAD_LOG"))return;for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=Gy()+" Agora-SDK [".concat(Ky(e),"]:"):n[0]=Gy()+" Agora-SDK [".concat(Ky(e),"]:");let r="";n.forEach((e=>{"object"==typeof e&&(e=JSON.stringify(e)),r+="".concat(e," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:e,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:by,process_id:Dy("PROCESS_ID"),payload:JSON.stringify(e)};return XS((async()=>{const e=await _y.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(Dy("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(Dy("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if("OK"!==e.data){const t=new Error("unexpected upload log response");throw t.response=e,t}}),(()=>(this.uploadLogUploadingList=[],!1)),(e=>(e.response?Fy.reportLogUploadError({status:e.response.status,data:e.response.data,headers:e.response.headers,message:e.message}):e.request?Fy.reportLogUploadError({status:e.request.status,message:e.message}):Fy.reportLogUploadError({status:-1,message:e.message}),!0)),{timeout:Dy("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:Dy("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,Dy("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),Dy("UPLOAD_LOG_INTERVAL"))})).catch((e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),Dy("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),Dy("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var Yy,qy;function Jy(e){return Wg(e.reportId,"params.reportId",0,100,!1),Wg(e.category,"params.category",0,100,!1),Wg(e.event,"params.event",0,100,!1),Wg(e.label,"params.label",0,100,!1),Bg(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}!function(e){e.FREE="free",e.UPLOADING="uploading"}(Yy||(Yy={})),function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}(qy||(qy={}));const Xy={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var Qy,Zy,$y,eR;function tR(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function nR(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tR(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tR(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}!function(e){e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities"}(Qy||(Qy={})),function(e){e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities"}(Zy||(Zy={})),function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}($y||($y={})),function(e){e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(eR||(eR={}));class iR{constructor(){ih(this,"baseInfoMap",new Map),ih(this,"proxyServer",void 0),ih(this,"eventUploadTimer",void 0),ih(this,"setSessionIdTimer",void 0),ih(this,"url",void 0),ih(this,"backupUrl",void 0),ih(this,"_appId",void 0),ih(this,"keyEventUploadPendingItems",[]),ih(this,"normalEventUploadPendingItems",[]),ih(this,"apiInvokeUploadPendingItems",[]),ih(this,"apiInvokeCount",0),ih(this,"ltsList",[]),ih(this,"lastSendNormalEventTime",Date.now()),ih(this,"customReportCounterTimer",void 0),ih(this,"customReportCount",0),ih(this,"extApiInvoke",(async e=>{for(const t of e){const e=nR(nR({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:sS.TRACER});this.sendApiInvoke(e)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),Dy("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),Dy("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void zy.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const t=this.baseInfoMap.get(e),n=Date.now(),i=t.startTime;t.startTime=n,zy.debug("rewrite session ".concat(e," startTime: ").concat(n," , ").concat(n-i,"ms")),this.baseInfoMap.set(e,t)}setAppId(e){this._appId=e}reportApiInvoke(e,t,n){t.timeout=t.timeout||6e4,t.reportResult=void 0===t.reportResult||t.reportResult;const i=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,o=()=>({tag:t.tag,invokeId:r,sid:e,name:t.name,apiInvokeTime:i,options:t.options,states:t.states||null}),s=!!Dy("SHOW_REPORT_INVOKER_LOG");s&&zy.info("".concat(t.name," start"),t.options);let a=!1;US(t.timeout).then((()=>{a||(this.sendApiInvoke(nR(nR({},o()),{},{error:xg.API_INVOKE_TIMEOUT,success:!1})),zy.debug("".concat(t.name," timeout")))}));const c=new Vg(xg.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:e=>{const i=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(nR(nR({},o()),{},{success:!0},t.reportResult&&{result:e})),s&&zy.info("".concat(t.name," onSuccess")),e};return n?BS(i,t.name+"Success",n,(()=>a=!0)):i()},onError:e=>{const i=()=>{if(a)throw e;a=!0,this.sendApiInvoke(nR(nR({},o()),{},{success:!1,error:e})),s&&zy.info("".concat(t.name," onFailure"),e.toString())};return n?BS(i,t.name+"Error",n,(()=>a=!0)):i()}}}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const n=Date.now(),i=this.createBaseInfo(e,n);i.cname=t.cname;const r=Object.assign({},{willUploadConsoleLog:Dy("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Iy?"global":"oversea",areas:Dy("AREAS")&&Dy("AREAS").join(",")},t.extend),{stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=t,u=Date.now(),h=nR(nR({},i),{},{eventType:Qy.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,build:Ay,lts:u,elapse:u-n,extend:JSON.stringify(r),mode:t.mode,process:Dy("PROCESS_ID"),appType:Dy("APP_TYPE"),success:!0,version:by,stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientType:20,clientRole:l,serviceId:Dy("PROCESS_ID"),extensionID:Dy("PLUGIN_INFO").join(",")||""});this.send({type:Zy.SESSION,data:h},!0)}joinChooseServer(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{eventType:Qy.JOIN_CHOOSE_SERVER,lts:r,eventElapse:r-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:r-n.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3});this.send({type:Zy.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{eventType:Qy.REQ_USER_ACCOUNT,lts:r,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:r-n.startTime,eventElapse:r-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Zy.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info;t.vid&&(i.vid=t.vid),i.uid=t.uid,i.cid=t.cid;const r=Date.now(),{firstSuccess:o,avoidJoinStartTime:s,isProxy:a,addr:c}=t,d=r-(o&&s?s:n.startTime),l=nR(nR({},i),{},{eventType:Qy.JOIN_GATEWAY,lts:r,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,elapse:d,eventElapse:r-t.lts,firstSuccess:o,signalChannel:t.signalChannel}),u=l.success?1:0;if(t.succ&&(n.lastJoinSuccessTime=r),o)this.send({type:Zy.JOIN_GATEWAY,data:l},!0);else{let e;if(c)if(a){const t=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),n=c.match(/p=[0-9]{1,6}/g);e={isSuccess:u,gatewayIp:t&&t.length?t[0].split("=")[1].replace(/-/g,"."):"",port:n&&n.length?n[0].split("=")[1]:"",isProxy:a?1:0}}else{const t=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),n=c.match(/(:|p=)[0-9]{1,6}/g);e={isSuccess:u,gatewayIp:t&&t.length?t[0].split("//")[1].replace(/-/g,"."):"",port:n&&n.length?n[0].split(/:|p=/g)[1]:"",isProxy:a?1:0}}else e={isSuccess:u,gatewayIp:"",port:"",isProxy:a?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const t=Object.assign({},l,e,{eventType:Qy.REJOIN_GATEWAY});this.send({type:Zy.RE_JOIN_GATEWAY,data:t},!0)}}joinChannelTimeout(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=Date.now(),r=nR(nR({},n.info),{},{lts:i,timeout:t,elapse:i-n.startTime});this.send({type:Zy.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{eventType:Qy.PUBLISH,lts:r,eventElapse:t.eventElapse,elapse:r-n.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Zy.PUBLISH,data:o},!0)}subscribe(e,t,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=nR(nR({},r),{},{eventType:Qy.SUBSCRIBE,lts:o,eventElapse:t.eventElapse,elapse:o-i.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid},n&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof t.peerid?s.peerSuid=t.peerid:s.peer=t.peerid,this.send({type:Zy.SUBSCRIBE,data:s},!0)}wsCompressorInit(e){var t;const n=[...uh(t=this.baseInfoMap).call(t)],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;const o=r.info,s=Date.now(),a=nR(nR({},o),{},{eventType:Qy.WS_COMPRESSOR_INIT,lts:s,eventElapse:e.eventElapse,elapse:s-r.startTime,status:e.status?1:2});this.send({type:Zy.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=nR(nR(nR({},o),i),{},{elapse:s-r.startTime,eventType:t,lts:s,firstDecodeFrame:Math.max(s-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=nR(nR(nR({},o),i),{},{elapse:s-r.startTime,eventType:t,lts:s});this.send({type:n,data:a},!0)}pcStats(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR(nR({},i),t),{},{vid:void 0===i.vid?0:Number(i.vid),elapse:r-n.startTime,eventType:Qy.PC_STATS,lts:r});this.send({type:Zy.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(e,t){if(e){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR(nR({},i),t),{},{vid:void 0===i.vid?0:Number(i.vid),eventType:Qy.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Zy.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=nR(nR(nR({},o),i),{},{eventType:t,lts:s});this.send({type:n,data:a},!0)}streamSwitch(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{eventType:Qy.STREAM_SWITCH,lts:r,isDual:t.isdual,elapse:r-n.startTime,success:t.succ});this.send({type:Zy.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{eventType:Qy.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Zy.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{eventType:Qy.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Zy.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(e){this.proxyServer=e,e?zy.debug("reportProxyServerurl: ".concat(e)):zy.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR({},i),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Zy.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=function(e,t,n){const i=e[t];if(!i||"string"!=typeof i)return[e];e[t]="";const r=kS(JSON.stringify(e));let o=0;const s=[];let a=0;for(let c=0;c<i.length;c++)a+=i.charCodeAt(c)<=127?1:3,a<=n-r||(s[s.length]=RS(RS({},e),{},{[t]:i.substring(o,c)}),o=c,a=i.charCodeAt(c)<=127?1:3);return o!==i.length-1&&(s[s.length]=RS(RS({},e),{},{[t]:i.substring(o)})),s}(nR(nR(nR({},i),t),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300);o.forEach((e=>this.send({type:Zy.WORKER_EVENT,data:e},!0)))}apworkerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR(nR({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:Zy.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR(nR({},i),t),{},{elapse:r-n.startTime,lts:r,extend:t.extend||void 0});this.send({type:Zy.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=nR(nR(nR({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:Zy.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>Dy("CUSTOM_REPORT_LIMIT"))throw new Vg(xg.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const n=Date.now(),i=t.map((t=>({type:Zy.USER_ANALYTICS,data:nR(nR({sid:e},t),{},{lts:n})})));try{Dy("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(e){throw zy.error("send custom report message failed",e.toString()),new Vg(xg.CUSTOM_REPORT_SEND_FAILED,e.message)}}sendApiInvoke(e){const t=Dy("NOT_REPORT_EVENT");if(e.tag&&Ai(t)&&Ai(t).call(t,e.tag))return!1;if(null===e.sid)return this.apiInvokeUploadPendingItems.push(e),!1;const n=this.baseInfoMap.get(e.sid);if(!n)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:i,uid:r,cid:o}=n.info;let s;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof Vg){const{code:t,message:n}=e.error;s=t||n||e.error.toString()}else s=e.error.toString();const a={invokeId:e.invokeId,sid:e.sid,cname:i,cid:o,uid:r,lts:e.lts,success:e.success,elapse:e.lts-n.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?s:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Zy.API_INVOKE,data:a},!1),!0}appendSessionId(){iR.__CLIENT_LIST__.forEach((e=>{if(e._sessionId){const t=this.apiInvokeUploadPendingItems.length;for(let n=0;n<t;n++){const t=this.apiInvokeUploadPendingItems.shift();t&&(t.sid=e._sessionId,this.sendApiInvoke(Object.assign({},t)))}}}))}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>Dy("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const n=[],i=[];for(;e.length;){const t=e.shift();n.length<20?n.push(t):i.push(t)}e.push(...i);for(const o of[...n]){var r;-1!==this.ltsList.indexOf(o.data.lts)?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),Zh(r=this.ltsList).call(r,((e,t)=>e-t)))}return t||(this.lastSendNormalEventTime=Date.now()),Dy("ENABLE_EVENT_REPORT")?(n.length&&(Dy("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((e=>n=>{Dy("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(e):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(e),this.normalEventUploadPendingItems.length>Dy("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-Dy("NORMAL_EVENT_QUEUE_CAPACITY")),zy.warning("report: drop normal events"))))})(n)),e):e}async postDataToStatsCollector2(e){vS.networkState===uS.OFFLINE&&await tg.race([vS.onlineWaiter,US(2*qS.maxRetryTimeout)]);const t=e=>{let t=new Uint8Array;return e.forEach((e=>{const n=Zg(JSON.stringify(e.data)),i=new ArrayBuffer(5),r=(e=>{let t=0;return Object.entries(Zy).forEach((n=>{let[i,r]=n;r===e.type&&(t=EventNameToID[i])})),t})(e),o=new DataView(i);o.setUint16(0,n.byteLength,!0),o.setUint8(2,255&r),o.setUint8(3,r>>>8&255),o.setUint8(4,r>>>16&255),t=$g(t,new Uint8Array(i)),t=$g(t,n)})),t},n="event";let i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dy("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(Dy("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){1===r&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dy("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(Dy("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await vy(i,{timeout:1e4,data:t(e),headers:nR(nR({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(e){if(1===r)throw e;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map((e=>JSON.stringify(e))),vid:(e=>{const t=e&&e.data.sid&&this.baseInfoMap.get(e.data.sid);return t&&t.info.vid&&+t.info.vid||0})(e[0])};vS.networkState===uS.OFFLINE&&await tg.race([vS.onlineWaiter,US(2*qS.maxRetryTimeout)]);const i=t?"/events/proto-raws":"/events/messages";let r=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dy("EVENT_REPORT_DOMAIN"),"&p=").concat(Dy("STATS_COLLECTOR_PORT"),"&d=").concat(i):"https://".concat(Dy("EVENT_REPORT_DOMAIN"),":").concat(Dy("STATS_COLLECTOR_PORT")).concat(i));for(let o=0;o<2;o+=1){1===o&&(r=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dy("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(Dy("STATS_COLLECTOR_PORT"),"&d=").concat(i):"https://".concat(Dy("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(Dy("STATS_COLLECTOR_PORT")).concat(i)));try{t?await yy(r,{timeout:1e4,data:n}):await vy(r,{timeout:1e4,data:n})}catch(t){if(1===o)throw t;continue}return}}createBaseInfo(e,t){const n=Object.assign({},Xy);return n.sid=e,this.baseInfoMap.set(e,{info:n,startTime:t}),n}reportResourceTiming(e,t){const n=performance.getEntriesByName(e),i=n[n.length-1];i&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:i,tag:sS.TRACER}).onSuccess()}}function rR(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,n,i){const r=i.value;if("function"==typeof r){const o=e.className||t.__className__||("AgoraRTCClient"===t.constructor.name?"Client":t.constructor.name);i.value=function(){for(var t=arguments.length,i=new Array(t),s=0;s<t;s++)i[s]=arguments[s];let a=i;if(e.argsMap)try{a=e.argsMap(this,...i)}catch(e){zy.warning(e),a=[]}try{JSON.stringify(a)}catch(e){zy.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),a=[]}const c=(e.report||oR).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(n)),options:a,tag:sS.TRACER,reportResult:e.reportResult},e.throttleTime);try{const t=r.apply(this,i);return t instanceof tg?t.then((t=>(c.onSuccess(e.reportResult&&t),t))).catch((e=>{throw c.onError(e),e})):(c.onSuccess(e.reportResult&&t),t)}catch(e){throw c.onError(e),e}}}return i}}ih(iR,"__CLIENT_LIST__",[]);const oR=new iR;Fy.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=vS.networkState,oR.reportApiInvoke(null,{name:"logUploadError",options:e,tag:sS.TRACER})}));const sR=["CHINA","GLOBAL"],aR=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const o=r.join(""),s={};return s[e]=i,s[t]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=aR,Iy||(Oy.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Oy.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Oy.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Oy.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Oy.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Oy.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Oy.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Oy.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Oy.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Oy.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Oy.AREAS=["NORTH_AMERICA","OVERSEA"]);const cR=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],dR=[];function lR(e,t){return!!t&&dR.some((n=>n.uid===e&&n.channelName===t))}iR.__CLIENT_LIST__=dR;var uR,hR,pR,fR,_R,mR,ER,gR,SR,TR,vR,yR,RR,CR,bR,IR,wR,AR=Xn("Array").values,OR=ui,NR=$e,DR=u,PR=AR,kR=Array.prototype,LR={DOMTokenList:!0,NodeList:!0},MR=i((function(e){var t=e.values;return e===kR||DR(kR,e)&&t===kR.values||NR(LR,OR(e))?PR:t}));function UR(e,t,n,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,n,s):r(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s}function xR(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e){e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY"}(uR||(uR={})),function(e){e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver"}(hR||(hR={})),function(e){e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(pR||(pR={})),function(e){e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(fR||(fR={})),function(e){e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(_R||(_R={})),function(e){e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(mR||(mR={})),function(e){e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(ER||(ER={})),function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed"}(gR||(gR={})),function(e){e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(SR||(SR={})),function(e){e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag"}(TR||(TR={})),function(e){e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats"}(vR||(vR={})),function(e){e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list"}(yR||(yR={})),function(e){e.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",e.NEED_ANSWER="NEED_ANSWER",e.NEED_RENEGOTIATE="NEED_RENEGOTIATE",e.P2P_LOST="P2P_LOST",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NEED_UNPUB="NEED_UNPUB",e.NEED_UNSUB="NEED_UNSUB",e.NEED_UPLOAD="NEED_UPLOAD",e.NEED_CONTROL="NEED_CONTROL",e.START_RECONNECT="START_RECONNECT",e.END_RECONNECT="END_RECONNECT",e.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(RR||(RR={})),function(e){e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY"}(CR||(CR={})),function(e){e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(bR||(bR={}));class VR extends Vg{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),ih(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,zy)}throw(){super.throw(zy)}}function FR(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw zy.error("Invalid Channel Name ".concat(e)),new VR(xg.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function jR(e){if(!("number"==typeof(t=e)&&Math.floor(t)===t&&0<=t&&t<=4294967295||zg(e,1,255)))throw new VR(xg.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;"string"==typeof e&&zy.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}!function(e){e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming"}(IR||(IR={})),function(e){e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(wR||(wR={}));const BR={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},GR={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function WR(e,t){Wg(e.url,"".concat(t,".url"),1,1e3,!1),Kg(e.x)||Bg(e.x,"".concat(t,".x"),0,1e4),Kg(e.y)||Bg(e.y,"".concat(t,".y"),0,1e4),Kg(e.width)||Bg(e.width,"".concat(t,".width"),0,1e4),Kg(e.height)||Bg(e.height,"".concat(t,".height"),0,1e4),Kg(e.zOrder)||Bg(e.zOrder,"".concat(t,".zOrder"),0,255),Kg(e.alpha)||Bg(e.alpha,"".concat(t,".alpha"),0,1,!1)}const HR={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},KR={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var zR,YR,qR,JR,XR,QR,ZR,$R,eC,tC,nC,iC,rC,oC;function sC(e){if(!e.channelName)throw new VR(xg.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new VR(xg.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&Wg(e.token,"info.token",1,2047),jR(e.uid),FR(e.channelName),!0}!function(e){e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address"}(zR||(zR={})),function(e){e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(YR||(YR={})),function(e){e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(qR||(qR={})),function(e){e.CONNECT_FAILED="connect failed",e.CONNECT_TIMEOUT="connect timeout",e.WS_DISCONNECTED="websocket disconnected",e.REQUEST_TIMEOUT="request timeout",e.REQUEST_FAILED="request failed",e.WAIT_STATUS_TIMEOUT="wait status timeout",e.WAIT_STATUS_ERROR="wait status error",e.BAD_STATE="bad state",e.WS_ABORT="ws abort",e.AP_REQUEST_TIMEOUT="AP request timeout",e.AP_JSON_PARSE_ERROR="AP json parse error",e.AP_REQUEST_ERROR="AP request error",e.AP_REQUEST_ABORT="AP request abort"}(JR||(JR={})),function(e){e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile"}(XR||(XR={})),function(e){e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(QR||(QR={})),function(e){e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(ZR||(ZR={})),function(e){e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}($R||($R={})),function(e){e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low"}(eC||(eC={})),function(e){e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal"}(tC||(tC={})),function(e){e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON"}(nC||(nC={})),function(e){e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7"}(iC||(iC={})),function(e){e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel"}(rC||(rC={})),function(e){e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS"}(oC||(oC={}));const aC=[oC.AFRICA,oC.ASIA,oC.CHINA,oC.EUROPE,oC.GLOBAL,oC.INDIA,oC.JAPAN,oC.NORTH_AMERICA,oC.OCEANIA,oC.OVERSEA,oC.SOUTH_AMERICA];var cC;!function(e){e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL"}(cC||(cC={}));const dC={CHINA:{},ASIA:{CODE:cC.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:cC.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:cC.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:cC.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:cC.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:cC.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:cC.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:cC.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:cC.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:cC.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:cC.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:cC.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:cC.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var lC,uC,hC,pC,fC,_C,mC,EC,gC,SC,TC,vC,yC,RC,CC,bC,IC,wC,AC,OC,NC,DC,PC,kC;Iy&&(dC.CHINA={CODE:cC.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(e){e.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(lC||(lC={}));class LC extends nS{constructor(e,t){super(),ih(this,"onICEConnectionStateChange",void 0),ih(this,"onConnectionStateChange",void 0),ih(this,"onDTLSTransportStateChange",void 0),ih(this,"onDTLSTransportError",void 0),ih(this,"onICETransportStateChange",void 0),ih(this,"onFirstAudioReceived",void 0),ih(this,"onFirstVideoReceived",void 0),ih(this,"onFirstAudioDecoded",void 0),ih(this,"onFirstVideoDecoded",void 0),ih(this,"onFirstVideoDecodedTimeout",void 0),ih(this,"onSelectedLocalCandidateChanged",void 0),ih(this,"onSelectedRemoteCandidateChanged",void 0)}}class MC extends LC{constructor(e,t){super(e,t)}}!function(e){e.SEND="sendonly",e.RECV="recvonly",e.SENDRECV="sendrecv",e.INACTIVE="inactive"}(uC||(uC={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(hC||(hC={})),function(e){e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY"}(pC||(pC={})),function(e){e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(fC||(fC={})),function(e){e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack"}(_C||(_C={})),function(e){e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected"}(mC||(mC={})),function(e){e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE"}(EC||(EC={})),function(e){e.MUTE_LOCAL_VIDEO="mute_local_video",e.MUTE_LOCAL_AUDIO="mute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.MUTE_REMOTE_VIDEO="mute_remote_video",e.MUTE_REMOTE_AUDIO="mute_remote_audio",e.UNMUTE_REMOTE_VIDEO="unmute_remote_video",e.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(gC||(gC={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(SC||(SC={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(TC||(TC={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(vC||(vC={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}(yC||(yC={})),function(e){e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback"}(RC||(RC={})),function(e){e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation"}(CC||(CC={})),function(e){e[e.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",e[e.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",e[e.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",e[e.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",e[e.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",e[e.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",e[e.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",e[e.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",e[e.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",e[e.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",e[e.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",e[e.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",e[e.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",e[e.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",e[e.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",e[e.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",e[e.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",e[e.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",e[e.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",e[e.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(bC||(bC={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(IC||(IC={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(wC||(wC={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(AC||(AC={})),function(e){e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check"}(OC||(OC={})),function(e){e.ABORT="abort"}(NC||(NC={})),function(e){e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(DC||(DC={})),function(e){e[e.SUCCESS=1]="SUCCESS",e[e.FAILED=0]="FAILED"}(PC||(PC={})),function(e){e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed"}(kC||(kC={}));const UC={[pR.ACCESS_POINT]:{[mR.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[mR.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[mR.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[mR.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[mR.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[mR.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[mR.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[pR.UNILBS]:{[_R.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[_R.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[_R.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[_R.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[_R.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[_R.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[_R.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[_R.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[_R.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[_R.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[_R.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[_R.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[pR.STRING_UID_ALLOCATOR]:{[fR.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[fR.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[fR.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function xC(e){const t=UC[Math.floor(e/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const n=t[e%1e4];if(!n){if(Math.floor(e/1e4)===pR.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return n}const VC={[ER.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ER.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ER.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ER.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ER.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ER.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ER.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ER.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ER.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ER.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ER.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ER.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ER.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ER.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ER.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ER.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ER.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ER.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ER.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ER.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ER.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ER.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ER.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ER.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ER.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ER.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ER.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ER.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ER.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ER.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ER.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ER.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ER.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ER.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ER.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ER.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ER.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ER.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ER.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ER.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ER.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ER.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ER.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ER.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ER.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ER.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ER.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ER.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ER.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ER.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ER.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ER.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ER.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ER.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ER.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ER.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ER.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ER.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ER.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ER.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ER.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ER.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ER.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function FC(e){return VC[e]||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function jC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function BC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?jC(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):jC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function GC(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function WC(e,t){if("string"==typeof e)return e;const{proxy:n,host:i,port:r}=e;if(t){const e=Dy("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(e,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const HC=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,KC=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,zC=/wss:\/\/(.+):([0-9]+)\/?/,YC=/wss:\/\/(.[^\/]+)\/?/;let qC=0;class JC{constructor(e,t){ih(this,"id",0),ih(this,"store",void 0),ih(this,"recordIndex",void 0),ih(this,"websockets",[]),ih(this,"try443PortDuration",2e3),ih(this,"forceCloseWSDuration",5e3),ih(this,"try443PortTimeout",null),ih(this,"forceCloseTimeout",null),ih(this,"isTry443PortFailed",!1),ih(this,"isNormalPortFailed",!1),ih(this,"useDoubleDomain",!1),ih(this,"useProxy",!1),ih(this,"startTime",Date.now()),this.id=++qC,this.try443PortDuration=Dy("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const t=Date.now()-this.startTime;for(var n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];zy.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...i)}createWebSocket(e,t,n){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:n});const i=Dy("GATEWAY_DOMAINS"),r=Date.now(),o=[],s=i.find((t=>{var n;return Ai(n=e.host).call(n,t)}));s||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)i.forEach((n=>{a.push(WC(BC(BC({},e),{},{host:e.host.replace(s,n)}),t))}));else{const n=BC({},e);if(t&&s){const e=i.find((e=>e!==s));e&&(n.host=n.host.replace(s,e))}a.push(WC(n,t))}try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(i){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,n);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,n);throw new VR(xg.WS_ERR,"init websocket failed! Error: ".concat(i.toString()))}const c=ig();return this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-r,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=n=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-r,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=GC(o):this.isNormalPortFailed=GC(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(n.reason)),c.reject({code:n.code,reason:nC.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o),n||(()=>{const n=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(n,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return n();pg().os===ag.MAC_OS&&vg()&&n(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(n,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,t,n,i){return this.useDoubleDomain=!!t,"string"==typeof e&&(e=function(e){let t,n,i;return[,t,n,i]=e.match(HC)||[],t||([,n,i]=e.match(KC)||[]),n&&i||([,n,i]=e.match(zC)||[]),n&&i||([,n]=e.match(YC)||[]),n||zy.warning("un-destructible url: ",e),{proxy:t,host:n,port:i||"443"}}(e)),this.recordIndex=i,this.useProxy=!!e.proxy,n&&this.useProxy&&(zy.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally((()=>this.clearTimeout()))}}function XC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class QC extends nS{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Ai(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(bR.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(bR.CONNECTED):"closed"===this._state?this.emit(bR.CLOSED):"failed"===this._state&&this.emit(bR.FAILED))}resetReconnectCount(e){zy.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),ih(this,"connectionID",0),ih(this,"currentURLIndex",0),ih(this,"urls",[]),ih(this,"_reconnectMode","tryNext"),ih(this,"reconnectReason",void 0),ih(this,"_initMutex",new zS("websocket")),ih(this,"name",void 0),ih(this,"_state","closed"),ih(this,"reconnectInterrupter",void 0),ih(this,"websocket",void 0),ih(this,"retryConfig",void 0),ih(this,"reconnectCount",0),ih(this,"forceCloseTimeout",5e3),ih(this,"onlineReconnectListener",void 0),ih(this,"useCompress",void 0),ih(this,"tryDoubleDomain",!1),ih(this,"use443PortOnly",!1),ih(this,"wsInflateLength",0),ih(this,"wsDeflateLength",0),ih(this,"closeEstablishingWs",(()=>{})),ih(this,"store",void 0),ih(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?XC(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):XC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t),this.useCompress=n,this.tryDoubleDomain=i,this.use443PortOnly=r;const{timeout:s,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*s/5)),d=Math.max(1.2,Math.floor(8*a)/10);uS.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),vS.on(hS.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===uS.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=s,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=ig(),t=this.urls[this.currentURLIndex];this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(bR.CLOSED,(()=>{e.reject(new Vg(xg.WS_DISCONNECT))})),this.once(bR.CONNECTED,e.resolve),await e.promise}catch(e){}finally{n()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void zy.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),zy.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Vg(xg.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new Vg(xg.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;const n=ig();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const i=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),zy.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},r=async e=>{var t;if(zy.debug("[".concat(this.name,"] websocket close ").concat(null===(t=this.websocket)||void 0===t?void 0:t.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new Vg(xg.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const t=SS(this,bR.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,i=await this.reconnectWithAction(t);if("closed"===this.state)return void zy.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!i)return n.reject(new Vg(xg.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},o=e=>{this.emit(bR.ON_MESSAGE,e)},s=e=>{zy.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),Dy("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=Dy("GATEWAY_WSS_ADDRESS")),zy.debug("[".concat(this.name,"] start connect, url:"),e);const a=null===(t=this.store)||void 0===t?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var c;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,i&&i(this.websocket.url),this.websocket.onclose=r,this.websocket.onmessage=o,this.websocket.onerror=s,null===(c=this.store)||void 0===c||c.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this.joinGatewayRecordIndex=a}catch(e){const t="closed"===this.state,i=e instanceof Vg,o=i&&e.code===xg.WS_ABORT,s=i&&e.code===xg.WS_ERR,c=i?e.message:e&&(e.reason||e.toString());zy.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(c)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:o?"aborted":"error",errors:[e]},a),t||s?(n.reject(t?new Vg(xg.WS_DISCONNECT,"websocket is closed: ".concat(c)):new Vg(xg.WS_ERR,"init websocket failed: ".concat(c))),s&&zy.error("[".concat(this.name,"] init websocket failed: ").concat(c))):r&&r(e)}return n.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;zy.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||vS.isOnline||!vS.onlineWaiter||(this.onlineReconnectListener=vS.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,t){const t=JS(this.reconnectCount,this.retryConfig);zy.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await tg.race([US(t),this.onlineReconnectListener||new tg((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const i=async(e,t)=>{this.emit(bR.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(bR.RECONNECT_WAITTING_FINISH,e),await i(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);zy.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(bR.RECONNECT_WAITTING_FINISH,e),await i(this.urls[this.currentURLIndex],e)}else"recover"===e&&(zy.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(bR.RECONNECT_WAITTING_FINISH,e),this.urls=await ES(this,bR.REQUEST_NEW_URLS),this.currentURLIndex=0,await i(this.urls[this.currentURLIndex],e))}catch(n){var r;zy.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const i=null==n||null===(r=n.data)||void 0===r?void 0:r.desc;return Array.isArray(i)&&Ai(i).call(i,"dynamic key expired")?(this.emit(bR.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class ZC extends QC{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){const n=ig(),i=function(e,t){return new JC(e,t)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{zy.debug("[choose-best-ws] close establishing websockets"),i.closeAllWebsockets(),n.reject(new Vg(xg.WS_ABORT,"choose best websocket aborted"))};const r=Dy("GATEWAY_DOMAINS");return zy.debug("[choose-best-ws] currentDomain: ",e,", domains: ",r,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),i.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,t).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class $C extends QC{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){return new tg(((n,i)=>{let r=!1;const o=[];this.closeEstablishingWs=()=>{zy.debug("[choose-best-ws] close establishing websockets"),o.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),i(new Vg(xg.WS_ABORT,"choose best websocket aborted"))};const s=Dy("GATEWAY_DOMAINS");let a;const c=e.indexOf("?h="),d=s.find((t=>-1!==c?Ai(e).call(e,t,c):Ai(e).call(e,t)));zy.debug("[choose-best-ws] currentDomain: ",d,", domains: ",s);let l=!this.tryDoubleDomain||!d;if(!l&&d){var u;const h=Date.now();try{s.forEach((t=>{const n=-1===c?e.replace(d,t):e.substr(0,c)+e.substr(c).replace(d,t),i=new WebSocket(n);i.binaryType="arraybuffer",o.push(i),zy.debug("[choose-best-ws] ws is connecting:",i.url)}))}catch(e){for(zy.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((e=>e.close()));o.length;)o.pop();l=!0}null===(u=this.store)||void 0===u||u.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},t),o.forEach((e=>{e.onopen=()=>{if(r)return;const t=Date.now()-h;zy.debug("[choose-best-ws] ws open cost ".concat(t,"ms")),o.filter((t=>t!==e)).forEach((e=>{zy.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),r=!0,n(e)},e.onclose=e=>{a=e,r||o.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(zy.debug("[choose-best-ws] all websocket is closed"),r=!0,i(a))},e.onmessage=t=>{zy.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(t.data))}})),US(this.forceCloseTimeout).then((()=>{o.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(l){var h;let r;zy.debug("[choose-best-ws] use single url: ",e),null===(h=this.store)||void 0===h||h.recordJoinChannelService({urls:[e],service:"gateway"},t);try{r=new WebSocket(e),o.push(r),r.binaryType="arraybuffer"}catch(e){const n=new Vg(xg.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return zy.error("[".concat(this.name,"]").concat(n)),void i(n)}r.onopen=()=>{n(r)},r.onclose=e=>{i(e)},r.onmessage=e=>{zy.debug("[choose-best-ws]".concat(r.url," onmessage: ").concat(e.data))},US(this.forceCloseTimeout).then((()=>{r&&r.readyState!==WebSocket.OPEN&&r.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class eb extends nS{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===gR.CONNECTED?this.emit(SR.WS_CONNECTED):e===gR.RECONNECTING?this.emit(SR.WS_RECONNECTING,this._websocketReconnectReason):e===gR.CLOSED&&this.emit(SR.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),ih(this,"_disconnectedReason",void 0),ih(this,"_websocketReconnectReason",void 0),ih(this,"_connectionState",gR.CLOSED),ih(this,"reconnectToken",void 0),ih(this,"websocket",void 0),ih(this,"openConnectionTime",void 0),ih(this,"clientId",void 0),ih(this,"lastMsgTime",Date.now()),ih(this,"uploadCache",[]),ih(this,"uploadCacheInterval",void 0),ih(this,"rttRolling",new dT(5)),ih(this,"pingpongTimer",void 0),ih(this,"wsInflateDataTimer",void 0),ih(this,"pingpongTimeoutCount",0),ih(this,"joinResponse",void 0),ih(this,"multiIpOption",void 0),ih(this,"initError",void 0),ih(this,"spec",void 0),ih(this,"store",void 0),ih(this,"onWebsocketMessage",(e=>{if(e.data instanceof ArrayBuffer)return void this.emit(SR.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===yR.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===yR.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(cS.UID_BANNED);break;case 15:this.close(cS.IP_BANNED);break;case 16:this.close(cS.CHANNEL_BANNED)}if(t._type===yR.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case ER.ERR_LICENSE_MISSING:this.close(cS.LICENSE_MISSING);break;case ER.ERR_LICENSE_EXPIRED:this.close(cS.LICENSE_EXPIRED);break;case ER.ERR_LICENSE_MINUTES_EXCEEDED:this.close(cS.LICENSE_MINUTES_EXCEEDED);break;case ER.ERR_LICENSE_PERIOD_INVALID:this.close(cS.LICENSE_PERIOD_INVALID);break;case ER.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(cS.LICENSE_MULTIPLE_SDK_SERVICE);break;case ER.ERR_LICENSE_ILLEGAL:this.close(cS.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new ZC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dy("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dy("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===gR.CONNECTED&&this.reconnect("retry",lS.OFFLINE)}))}async request(e,t,n,i){const r=xS(6,""),o={_id:r,_type:e,_message:t},s=this.websocket.connectionID,a=()=>new tg(((t,n)=>{if(this.connectionState===gR.CONNECTED)return t();const i=()=>{this.off(SR.WS_CLOSED,r),t()},r=()=>{this.off(SR.WS_CONNECTED,i),n(new VR(xg.WS_ABORT))};this.once(SR.WS_CONNECTED,i),this.once(SR.WS_CLOSED,r),e!==TR.PUBLISH&&e!==TR.SUBSCRIBE&&e!==TR.UNSUBSCRIBE&&e!==TR.UNPUBLISH&&e!==TR.CONTROL&&e!==TR.RESTART_ICE||this.once(SR.DISCONNECT_P2P,(()=>{n(new VR(xg.DISCONNECT_P2P))})),e!==TR.PUBLISH&&e!==TR.RESTART_ICE||this.once(SR.ABORT_P2P_EXECUTION,(()=>{n(new VR(xg.DISCONNECT_P2P))}))}));if(this.connectionState!==gR.CONNECTING&&this.connectionState!==gR.RECONNECTING||e===TR.JOIN||e===TR.REJOIN||await a(),this.websocket.sendMessage(o,!0),i)return;const c=new tg(((n,i)=>{let o=!1;const a=(i,r)=>{o=!0,n({isSuccess:"success"===i,message:r||{}}),this.off(SR.WS_CLOSED,c),this.off(SR.WS_RECONNECTING,c),this.emit(SR.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{i(new VR(xg.WS_ABORT,"type: ".concat(e))),this.off(SR.WS_CLOSED,c),this.off(SR.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(SR.WS_CLOSED,c),this.once(SR.WS_RECONNECTING,c),US(Dy("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==s||o||(zy.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(SR.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(i){if(this.connectionState===gR.CLOSED||e===TR.LEAVE)throw new VR(xg.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?i.throw():e===TR.JOIN||e===TR.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),u=FC(l),h=new VR(xg.UNEXPECTED_RESPONSE,"".concat(u.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===u.action?d.message:(zy.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(u.desc,", action: ").concat(u.action)),l===ER.ERR_TOO_MANY_BROADCASTERS?e===TR.JOIN||e===TR.REJOIN?(this.initError=h,this.close(),h.throw()):h.throw():"failed"===u.action?h.throw():"quit"===u.action?(this.initError=h,this.close(),h.throw()):(l===ER.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,zy.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",lS.MULTI_IP)):this.reconnect(u.action,lS.SERVER_ERROR),e===TR.JOIN||e===TR.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new tg((n=>{const i=r=>{(!t||t(r))&&(this.off(e,i),n(r))};this.on(e,i)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void zy.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(vR.WRTC_STATS,t)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=Dy("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==gR.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Dy("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const n={_type:e,_message:t};this.websocket.sendMessage(n)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new tg(((t,n)=>{this.once(SR.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(SR.WS_CLOSED,(()=>n(this.initError||new VR(xg.WS_ABORT)))),this.connectionState=gR.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||cS.LEAVE,this.connectionState=gR.CLOSED,zy.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===cS.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new ZC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dy("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dy("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(SR.ABORT_P2P_EXECUTION);const e=await ES(this,SR.REQUEST_JOIN_INFO),t=await this.request(TR.JOIN,e);if(!t)return this.emit(SR.REPORT_JOIN_GATEWAY,nC.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(SR.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=gR.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new VR(xg.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=TS(this,SR.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(TR.REJOIN,e);return!!t&&(this.connectionState=gR.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(yR.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(yR.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(yR.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(yR.MUTE_AUDIO,{uid:e.uid}):this.emit(yR.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(yR.MUTE_VIDEO,{uid:e.uid}):this.emit(yR.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(yR.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(yR.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(yR.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(yR.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(yR.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){zy.debug("[".concat(this.clientId,"] receive notification: "),e);const t=FC(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(cS.UID_BANNED),void this.close()):void this.reconnect(t.action,lS.SERVER_ERROR);zy.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Dy("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(zy.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Dy("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",lS.TIMEOUT):this.request(TR.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Dy("REPORT_STATS")&&this.send(TR.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(vR.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(bR.RECONNECT_WAITTING_FINISH,(e=>{this.emit(SR.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(bR.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(SR.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(bR.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(bR.CLOSED,(()=>{this.connectionState=gR.CLOSED})),this.websocket.on(bR.FAILED,(()=>{this._disconnectedReason=cS.NETWORK_ERROR,this.connectionState=gR.CLOSED})),this.websocket.on(bR.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===gR.CONNECTED?this.connectionState=gR.RECONNECTING:this.connectionState=gR.CONNECTING})),this.websocket.on(bR.WILL_RECONNECT,((e,t,n)=>{const i=TS(this,SR.IS_P2P_DISCONNECTED),r=i||"retry"!==e;i&&"retry"===e&&(zy.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",t=nC.P2P_DISCONNECTED),r&&(zy.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(SR.REPORT_JOIN_GATEWAY,t||nC.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(SR.NEED_RENEW_SESSION),this.emit(SR.DISCONNECT_P2P)),n(e)})),this.websocket.on(bR.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{zy.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",lS.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(SR.REPORT_JOIN_GATEWAY,e.message||e.code||nC.UNKNOWN_REASON,this.url||""),e instanceof VR&&e.code===xg.UNEXPECTED_RESPONSE&&e.data.code===ER.ERR_NO_AUTHORIZED)return zy.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",lS.SERVER_ERROR);zy.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",lS.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(bR.REQUEST_NEW_URLS,((e,t)=>{ES(this,SR.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(bR.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(yR.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}var tb="\t\n\v\f\r \xa0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029\ufeff",nb=X,ib=fi,rb=tb,ob=l("".replace),sb=RegExp("^["+rb+"]+"),ab=RegExp("(^|[^"+rb+"])["+rb+"]+$"),cb=function(e){return function(t){var n=ib(nb(t));return 1&e&&(n=ob(n,sb,"")),2&e&&(n=ob(n,ab,"$1")),n}},db={start:cb(1),end:cb(2),trim:cb(3)},lb=Jd.PROPER,ub=r,hb=tb,pb=db.trim;Nn({target:"String",proto:!0,forced:function(e){return ub((function(){return!!hb[e]()||"\u200b\x85\u180e"!=="\u200b\x85\u180e"[e]()||lb&&hb[e].name!==e}))}("trim")},{trim:function(){return pb(this)}});var fb,_b,mb=Xn("String").trim,Eb=u,gb=mb,Sb=String.prototype,Tb=i((function(e){var t=e.trim;return"string"==typeof e||e===Sb||Eb(Sb,e)&&t===Sb.trim?gb:t}));function vb(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function yb(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vb(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vb(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Rb(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(Dy("TURN_DOMAIN")):(zy.info("Unidentified as ip: ".concat(e,", use as host")),e)}function Cb(e,t){e.addresses||(e.addresses=[]);const n=function(e,t){if(Dy("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return e.map((e=>{let{ip:t,port:n}=e;return{address:"".concat(t,":").concat(n)}}));const n=Dy("GATEWAY_DOMAINS");let i=n[1]&&Ai(t).call(t,n[1])?1:0;return e.map((e=>{let{domain_prefix:t,port:r,ip:o}=e;if(t)return{address:"".concat(t,".").concat(n[i++%n.length],":").concat(r)};const s=/^[\.\:\d]+$/.test(o),a=s?"".concat(o.replace(/[^\d]/g,"-"),".").concat(n[i++%n.length],":").concat(r):"".concat(o,":").concat(r);return s||zy.info("Unidentified as ip: ".concat(o,", use as host")),{ip:o,port:r,address:a}}))}(e.addresses,t),i=Array.isArray(e.detail)&&e.detail[18];if(i&&"string"==typeof i){const e=i.split(";");for(let t=0;t<e.length;t++){var r;const i=Tb(r=e[t]).call(r);n[t]&&i&&(n[t].ip6=i)}}return{gatewayAddrs:n,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function bb(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function Ib(e){const t=e._encoderConfig;if(!t)return{};const n={resolution:t.width&&t.height?"".concat(bb(t.width),"x").concat(bb(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(n.maxFrameRate=t.frameRate,n.minFrameRate=t.frameRate):t.frameRate&&(n.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,n.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),n}function wb(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function Ab(e,t){let n,i,r;switch(t){case fb.CHOOSE_SERVER:i=4096,r="choose server";break;case fb.CLOUD_PROXY:i=1048576,r="proxy";break;case fb.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case fb.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new VR(xg.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===i&&(n={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>yb(yb({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:yb(yb({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!n)throw new VR(xg.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return n}async function Ob(e,t){return await tg.all(e.addresses.map((async e=>({address:Rb(e.ip),tcpport:e.port,udpport:e.port,username:t&&Dy("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():aR.username,password:t&&Dy("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await tS(t.toString()):aR.password}))))}function Nb(e,t){const n=t._videoHeight||t.getMediaStreamTrack(!0).getSettings().height;return n?Math.max(n/bb(e.height),1):(zy.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Db(e){let{candidateType:t,relayProtocol:n,type:i,address:r,port:o,protocol:s}=e;return"local-candidate"===i?{candidateType:t,relayProtocol:n,protocol:s}:{candidateType:t,relayProtocol:n,address:r,port:o,protocol:s}}function Pb(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}!function(e){e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(fb||(fb={}));class kb extends nS{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Ai(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(RC.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(RC.CONNECTED):"closed"===this._state?this.emit(RC.CLOSED):"failed"===this._state&&this.emit(RC.FAILED))}constructor(e,t,n,i){super(),ih(this,"connectionID",0),ih(this,"currentURLIndex",0),ih(this,"reconnectReason",void 0),ih(this,"_reconnectMode","tryNext"),ih(this,"_name",void 0),ih(this,"_state","closed"),ih(this,"_retryConfig",void 0),ih(this,"_reconnectCount",0),ih(this,"_forceCloseTimeout",5e3),ih(this,"_onlineReconnectListener",void 0),ih(this,"_closeEstablishingTransmitter",(()=>{})),ih(this,"_store",void 0),ih(this,"_joinChannelServiceRecordIndex",void 0),ih(this,"_useCompress",void 0),ih(this,"_inflateLength",0),ih(this,"_deflateLength",0),this._store=i,this._name=e,this._retryConfig=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Pb(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pb(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t),this._useCompress=n}resetReconnectCount(e){zy.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,t){if(!this._transmitter)return void zy.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;void 0!==e&&(this.reconnectMode=e),zy.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex&&(null===(n=this._store)||void 0===n||n.recordJoinChannelService({status:"error",errors:[new Error(t)]},this._joinChannelServiceRecordIndex));const i=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),i&&i.bind(this._transmitter)({code:9999,reason:t})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}!function(e){e[e.Default=0]="Default",e[e.Ack=1]="Ack"}(_b||(_b={}));class Lb{constructor(e,t,n){ih(this,"version",1),ih(this,"initialRTO",void 0),ih(this,"maxBatchAckCount",void 0),ih(this,"maxRTO",void 0),ih(this,"initialRTT",void 0),ih(this,"ID",void 0),ih(this,"rtt",void 0),ih(this,"packetNumber",1),ih(this,"rtoRatioMap",new Map),ih(this,"timeoutMap",new Map),ih(this,"unorderedPacketQueue",[]),ih(this,"batchAckPacketQueue",[]),ih(this,"lastOrderedPacketNumber",0),ih(this,"batchAckTimer",void 0),ih(this,"sendImpl",void 0),ih(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=t,this.ID=xS(7,"transmitter-"),this.initialRTO=void 0!==(null==n?void 0:n.initialRTO)?n.initialRTO:Dy("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==n?void 0:n.initialRTT)?n.initialRTT:Dy("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==n?void 0:n.initialRTT)?n.initialRTT:Dy("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==n?void 0:n.maxBatchAckCount)?n.maxBatchAckCount:Dy("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==n?void 0:n.maxRTO)?n.maxRTO:Dy("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:_b.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case _b.Default:{let t;t="string"==typeof e.payload?(new TextEncoder).encode(e.payload):e.payload;const n=new ArrayBuffer(t.length+15),i=new DataView(n);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.packetNumber),qg(i,7,BigInt(e.sendTs)),new Uint8Array(i.buffer).set(t,15),n}case _b.Ack:{const t=new ArrayBuffer(16),n=new DataView(t);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.maxAckPacketNumber),n.setUint8(7,e.shift),qg(n,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const t=new DataView(e),n=t.getUint16(0),i=t.getUint8(2);switch(i){case _b.Default:{const r=t.getUint32(3),o=Yg(t,7),s=e.slice(15),a=(new TextDecoder).decode(s);return{version:n,type:i,packetNumber:r,sendTs:Number(o),payload:a}}case _b.Ack:{const e=t.getUint32(3),r=t.getUint8(7),o=Yg(t,8);return{version:n,type:i,maxAckPacketNumber:e,shift:r,ackSendTs:Number(o)}}default:throw zy.error("[".concat(this.ID,"] Unrecognized packet type ").concat(i)),new Error("Unrecognized packet type ".concat(i))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const n=this.calculateRTO(t),i=window.setTimeout((()=>{this.resendMessage(t)}),n);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===_b.Default?this.ack(t):t.type===_b.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,n]=e;window.clearTimeout(n)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),n=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,n),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const n=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),n>this.maxRTO?this.maxRTO:n}}updateRTT(e,t){const n=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-n-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:_b.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:_b.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:_b.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===_b.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class Mb extends kb{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),ih(this,"_initMutex",void 0),ih(this,"_reconnectInterrupter",void 0),ih(this,"_url",void 0),ih(this,"_transmitter",void 0),ih(this,"_addresses",void 0),ih(this,"_reliableTransmission",void 0),this._initMutex=new zS("datachannel");const{timeout:n,timeoutFactor:i}=t,r=Math.max(300,Math.floor(3*n/5)),o=Math.max(1.2,Math.floor(8*i)/10);uS.ONLINE&&(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o),vS.on(hS.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===uS.ONLINE?(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=n,this._retryConfig.timeoutFactor=i))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const n=(t,n)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||Dy("FINGERPRINT")));const i=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(i).then(t).catch(n),this.once(RC.CLOSED,(()=>n(new VR(xg.WS_DISCONNECT)))),this.once(RC.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new tg(((e,t)=>{n(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new VR(xg.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new VR(xg.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new tg(((t,n)=>{var i;const r=()=>{zy.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),t()},o=async e=>{var i;if(null===(i=this._closeEstablishingTransmitter)||void 0===i||i.call(this),zy.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const i=SS(this,RC.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,r=await this.reconnectWithAction(i);if("closed"===this.state)return void zy.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!r)return n(new VR(xg.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);t()}else n(new VR(xg.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},s=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),zy.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const a=null===(i=this._store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),c=Date.now();ES(this,RC.TO_CONNECT_DATACHANNEL,e).then((e=>{var t,n;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:i,close:d}=e;this._transmitter=i,null===(t=this._store)||void 0===t||t.signalChannelOpen();const l=Date.now()-c;zy.debug("[choose dc] dc open cost ".concat(l,"ms")),this._reliableTransmission=new Lb((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(RC.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,d()},r&&r(),i.onclose=o,i.onmessage=s,null===(n=this._store)||void 0===n||n.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this._joinChannelServiceRecordIndex=a})).catch((e=>{var t;if(null===(t=this._store)||void 0===t||t.recordJoinChannelService({endTs:Date.now(),status:e instanceof VR&&e.code===xg.WS_ABORT?"aborted":"error",errors:[e]},a),"closed"!==this.state){if(e instanceof VR&&e.code===xg.WS_ERR){const t=new VR(xg.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return zy.error("[".concat(this._name,"]").concat(t)),void n(t)}o&&o(e)}else n(new VR(xg.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||vS.networkState!==uS.OFFLINE||(this._onlineReconnectListener=vS.onlineWaiter&&vS.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},t){const t=JS(this._reconnectCount,this._retryConfig);zy.debug("[".concat(this._name,"] wait ").concat(t,"ms to reconnect datachannel, mode: ").concat(e)),await tg.race([US(t),this._onlineReconnectListener||new tg((()=>{}))])}if("closed"===this.state||!n)return!1;this._reconnectCount+=1;const i=async(e,t)=>{this.emit(RC.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(RC.RECONNECT_WAITTING_FINISH,e),await i(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||Dy("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return zy.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);zy.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const t=this._addresses[this.currentURLIndex];this.emit(RC.RECONNECT_WAITTING_FINISH,e),await i(t,e)}else"recover"===e&&(zy.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(RC.RECONNECT_WAITTING_FINISH,e),this.emit(RC.FAILBACK));return!0}catch(n){var r,o;return zy.error("[".concat(this._name,"] reconnect failed"),n.toString()),null!=n&&null!==(r=n.data)&&void 0!==r&&r.desc&&Array.isArray(n.data.desc)&&n.data.desc.length&&Ai(o=n.data.desc).call(o,"dynamic key expired")?(this.emit(RC.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}}class Ub extends nS{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===gR.CONNECTED?this.emit(SR.WS_CONNECTED):e===gR.RECONNECTING?this.emit(SR.WS_RECONNECTING,this._websocketReconnectReason):e===gR.CLOSED&&this.emit(SR.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),ih(this,"_disconnectedReason",void 0),ih(this,"_websocketReconnectReason",void 0),ih(this,"_connectionState",gR.CLOSED),ih(this,"reconnectToken",void 0),ih(this,"websocket",void 0),ih(this,"openConnectionTime",void 0),ih(this,"clientId",void 0),ih(this,"lastMsgTime",Date.now()),ih(this,"uploadCache",[]),ih(this,"uploadCacheInterval",void 0),ih(this,"rttRolling",new dT(5)),ih(this,"pingpongTimer",void 0),ih(this,"inflateDataTimer",void 0),ih(this,"pingpongTimeoutCount",0),ih(this,"joinResponse",void 0),ih(this,"multiIpOption",void 0),ih(this,"initError",void 0),ih(this,"spec",void 0),ih(this,"store",void 0),ih(this,"onWebsocketMessage",(e=>{if(e instanceof ArrayBuffer)return void this.emit(SR.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===yR.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===yR.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(cS.UID_BANNED);break;case 15:this.close(cS.IP_BANNED);break;case 16:this.close(cS.CHANNEL_BANNED)}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new Mb("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===gR.CONNECTED&&this.reconnect("retry",yC.OFFLINE)}))}async request(e,t,n,i){const r=xS(6,""),o={_id:r,_type:e,_message:t},s=this.websocket.connectionID,a=()=>new tg(((t,n)=>{if(this.connectionState===gR.CONNECTED)return t();const i=()=>{this.off(SR.WS_CLOSED,r),t()},r=()=>{this.off(SR.WS_CONNECTED,i),n(new VR(xg.WS_ABORT))};this.once(SR.WS_CONNECTED,i),this.once(SR.WS_CLOSED,r),e!==TR.PUBLISH&&e!==TR.SUBSCRIBE&&e!==TR.UNSUBSCRIBE&&e!==TR.UNPUBLISH&&e!==TR.CONTROL&&e!==TR.RESTART_ICE||this.once(SR.DISCONNECT_P2P,(()=>{n(new VR(xg.DISCONNECT_P2P))})),e!==TR.PUBLISH&&e!==TR.RESTART_ICE||this.once(SR.ABORT_P2P_EXECUTION,(()=>{n(new VR(xg.DISCONNECT_P2P))}))}));if(this.connectionState!==gR.CONNECTING&&this.connectionState!==gR.RECONNECTING||e===TR.JOIN||e===TR.REJOIN||await a(),e===TR.LEAVE&&(this.websocket.unbindDcCloseEventListener(),i=!0),this.websocket.sendMessage(o,!0,!1),i)return;const c=new tg(((n,i)=>{let o=!1;const a=(i,r)=>{o=!0,n({isSuccess:"success"===i,message:r||{}}),this.off(SR.WS_CLOSED,c),this.off(SR.WS_RECONNECTING,c),this.emit(SR.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{i(new VR(xg.WS_ABORT,"type: ".concat(e))),this.off(SR.WS_CLOSED,c),this.off(SR.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(SR.WS_CLOSED,c),this.once(SR.WS_RECONNECTING,c),US(Dy("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==s||o||(zy.warning("dc request timeout, type: ".concat(e)),this.emit(SR.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(i){if(this.connectionState===gR.CLOSED||e===TR.LEAVE)throw new VR(xg.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?i.throw():e===TR.JOIN||e===TR.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),u=FC(l),h=new VR(xg.UNEXPECTED_RESPONSE,"".concat(u.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===u.action?d.message:(zy.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(u.desc,", action: ").concat(u.action)),l===ER.ERR_TOO_MANY_BROADCASTERS?e===TR.JOIN||e===TR.REJOIN?(this.initError=h,this.close(),h.throw()):h.throw():"failed"===u.action?h.throw():"quit"===u.action?(this.initError=h,this.close(),h.throw()):(l===ER.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,zy.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",yC.MULTI_IP)):this.reconnect(u.action,yC.SERVER_ERROR),e===TR.JOIN||e===TR.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new tg((n=>{const i=r=>{(!t||t(r))&&(this.off(e,i),n(r))};this.on(e,i)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void zy.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(vR.WRTC_STATS,t)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=Dy("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==gR.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Dy("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const n={_type:e,_message:t};this.websocket.sendMessage(n)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new tg(((n,i)=>{this.once(SR.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(SR.WS_CLOSED,(()=>i(this.initError||new VR(xg.WS_ABORT)))),this.connectionState=gR.CONNECTING,this.websocket.init(e).catch(i),this.websocket.once(RC.FAILBACK,(()=>{void 0===this.openConnectionTime&&i(new VR(xg.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{t&&void 0===this.openConnectionTime&&(zy.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new VR(xg.INIT_DATACHANNEL_TIMEOUT)))}),Dy("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||cS.LEAVE,this.connectionState=gR.CLOSED,zy.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===cS.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Mb("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(SR.ABORT_P2P_EXECUTION);const e=await ES(this,SR.DATACHANNEL_CONNECTING),t=await this.request(TR.JOIN,e);if(!t)return this.emit(SR.REPORT_JOIN_GATEWAY,xg.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(SR.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=gR.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new VR(xg.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=TS(this,SR.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(TR.REJOIN,e);return!!t&&(this.connectionState=gR.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(yR.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(yR.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(yR.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(yR.MUTE_AUDIO,{uid:e.uid}):this.emit(yR.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(yR.MUTE_VIDEO,{uid:e.uid}):this.emit(yR.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(yR.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(yR.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(yR.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(yR.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(yR.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){zy.debug("[".concat(this.clientId,"] receive notification: "),e);const t=FC(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(cS.UID_BANNED),void this.close()):void this.reconnect(t.action,yC.SERVER_ERROR);zy.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Dy("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(zy.warning("PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Dy("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",yC.TIMEOUT):this.request(TR.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Dy("REPORT_STATS")&&this.send(TR.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(vR.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(RC.RECONNECT_WAITTING_FINISH,(e=>{this.emit(SR.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(RC.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(SR.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(RC.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(RC.CLOSED,(()=>{this.connectionState=gR.CLOSED})),this.websocket.on(RC.FAILED,(()=>{this._disconnectedReason=cS.NETWORK_ERROR,this.connectionState=gR.CLOSED})),this.websocket.on(RC.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===gR.CONNECTED?this.connectionState=gR.RECONNECTING:this.connectionState=gR.CONNECTING})),this.websocket.on(RC.WILL_RECONNECT,((e,t)=>{if(TS(this,SR.IS_P2P_DISCONNECTED)&&"retry"===e)return zy.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(SR.NEED_RENEW_SESSION),this.emit(SR.DISCONNECT_P2P),t("tryNext");"retry"!==e&&(zy.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(SR.NEED_RENEW_SESSION),this.emit(SR.DISCONNECT_P2P)),t(e)})),this.websocket.on(RC.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{zy.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",yC.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(SR.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof VR&&e.code===xg.UNEXPECTED_RESPONSE&&e.data.code===ER.ERR_NO_AUTHORIZED)return zy.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",yC.SERVER_ERROR);zy.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",yC.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(RC.REQUEST_NEW_URLS,((e,t)=>{ES(this,SR.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(RC.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(yR.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(RC.TO_CONNECT_DATACHANNEL,(async(e,t,n)=>ES(this,SR.DATACHANNEL_PRECONNECT,e).then(t).catch(n))),this.websocket.on(RC.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(SR.DATACHANNEL_FAILBACK)}))}}class xb extends nS{constructor(e,t){super(),ih(this,"signal",void 0),ih(this,"token",void 0),ih(this,"tokenTimeout",void 0),ih(this,"tokenInterval",void 0),ih(this,"_sequence",0),ih(this,"userMap",new Map),ih(this,"encoder",new TextEncoder),this.signal=e,this.token=t;const n=()=>{this.signal.connectionState===gR.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(n,1e3):this.tokenInterval=window.setTimeout(n,3*Dy("P2P_TOKEN_INTERVAL"))};n()}async send(e,t,n,i,r){var o,s,a;if(0===this.userMap.size)return;const c=Array.from(MR(o=this.userMap).call(o))[0].token;"string"!=typeof t&&(t=JSON.stringify(t)),i=null!==(s=i)&&void 0!==s?s:xS(6,""),r=null!==(a=r)&&void 0!==a?a:this._sequence++;const d={_id:i,_type:e,_seq:r,_message:t,token:"".concat(this.token,"_").concat(c)};Dy("SHOW_P2P_LOG")&&zy.debug("send message",d,"noNeedResponse : ".concat(n)),this.splitMessage(JSON.stringify(d)).forEach((e=>{this.signal.request(TR.DATA_STREAM,{payload:PS(this.encoder.encode(e))})}));const l=new tg(((t,r)=>{const o=window.setTimeout((()=>{this.off("res-@".concat(i,"_ack"),s),this.off("res-@".concat(i),c),this.off(NC.ABORT,a),zy.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(i)),0===this.userMap.size?r(new Vg(xg.INVALID_REMOTE_USER)):r(new Vg(xg.TIMEOUT))}),Dy("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),s=()=>{o&&window.clearTimeout(o),this.off(NC.ABORT,a),n&&t()},a=()=>{o&&window.clearTimeout(o),this.off("res-@".concat(i,"_ack"),s),this.off("res-@".concat(i),c),r(new Vg(xg.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(i)))};this.once(NC.ABORT,a),this.once("res-@".concat(i,"_ack"),s);const c=(n,c)=>{l=!0,o&&window.clearTimeout(o),this.off("res-@".concat(i,"_ack"),s),this.off(NC.ABORT,a),"success"===n?t(c):r(new Vg(xg.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(i)))};let l=!1;n||(this.once("res-@".concat(i),c),US(Dy("SIGNAL_REQUEST_TIMEOUT")).then((()=>{l||zy.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(i,", ").concat(d))})))}));try{return await l}catch(o){if(o.code===xg.TIMEOUT)return await this.send(e,t,n,i,r);throw o}}onMessage(e){var t;const{_uid:n}=e;let i,r=this.userMap.get(n);if(r)i=r.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==OC.CHECK)return;const{token:t}=e;i=new Map,r={uid:n,isStart:!0,token:t,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,r),this.signal.emit(yR.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in e&&"total"in e){var o;const{id:t,total:r}=e,s=null!==(o=i.get(t))&&void 0!==o?o:[];if(s.push(e),i.has(t)||i.set(t,s),s.length!==r)return;{const r=Zh(s).call(s,((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");i.delete(t),(e=JSON.parse(r))._uid=n}}const{_type:s,token:a}=e;if(Ai(t=[OC.ACK,OC.CHECK]).call(t,s))return s===OC.CHECK&&this.handleCheckToken(r,a),void this.receiveMessage(e);a==="".concat(r.token,"_").concat(this.token)?this.handleReceivedMessage(e):zy.debug('Receive unexpected message", '.concat(a,", cur_token: ").concat(r.token,"_").concat(this.token),e)}check(){const e={_id:xS(6,""),token:this.token,_type:OC.CHECK};Dy("SHOW_P2P_LOG")&&zy.debug("send message",e),this.signal.request(TR.DATA_STREAM,{payload:PS(this.encoder.encode(JSON.stringify(e)))})}ack(e){const t={_id:e,_type:OC.ACK,token:this.token};Dy("SHOW_P2P_LOG")&&zy.debug("send message",t),this.signal.request(TR.DATA_STREAM,{payload:PS(this.encoder.encode(JSON.stringify(t)))})}response(e,t,n){this.send(OC.RESPONSE,JSON.stringify({success:!n,message:t}),!0,e)}handleReceivedMessage(e){const t=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:n}=e;for(;t.has(n);){const i=t.get(n);t.delete(n),this.receiveMessage(i),e.nextExpectedSequenceNumber++}}))};if(!e)return void t();const{_uid:n,_seq:i}=e,r=this.userMap.get(n),{receivedMessagesMap:o,isStart:s,nextExpectedSequenceNumber:a}=r;if(i<a)return this.ack(e._id),void zy.debug("[external-signal] receive old message, seq: ".concat(i,", ").concat(e._message));o.set(i,e),s&&i===a&&(this.receiveMessage(e),o.delete(a),r.nextExpectedSequenceNumber++,t())}receiveMessage(e){const{_id:t,_type:n,_message:i,_uid:r}=e;if(Dy("SHOW_P2P_LOG")&&zy.debug("receive message",e),t){let o;switch(e._type!==OC.ACK&&(i&&(o=JSON.parse(i)),this.ack(e._id)),e._type){case OC.CANDIDATE:case OC.CONTROL:this.signal.emit(n,o,r);break;case OC.PUBLISH:case OC.UNPUBLISH:case OC.RESTART_ICE:case OC.CALL:o.uid=r,ES(this.signal,n,o).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case OC.ACK:this.getListeners("res-@".concat(t,"_ack")).length>0&&this.emit("res-@".concat(t,"_ack"));break;case OC.RESPONSE:{const{success:e,message:n}=o;this.emit("res-@".concat(t),e?"success":"failed",n);break}}}}splitMessage(e){if(e.length<xb.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:n}=JSON.parse(e),i=xS(6,"");let r=0,o=800;const s=Math.ceil(e.length/o);for(;e.length>0;){r++;const a={id:i,index:r,total:s,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(n)};JSON.stringify(a).length>xb.MAX_MESSAGE_SIZE?o-=50:(t.push(a),e=e.slice(o))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,t){return e.token!==t?(zy.debug("token changed, from ".concat(e.token," to ").concat(t)),this.reset(e.uid,t),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{zy.debug("token timeout, ".concat(t)),this.reset(e.uid)}),Dy("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await ES(this.signal,OC.CALL,void 0),t=await this.send(OC.CALL,e);this.signal.emit(SR.P2P_CONNECTION,t,!0)}async reset(e,t){const n=this.userMap.get(e);n&&(this.emit(NC.ABORT),this.signal.emit(yR.ON_USER_OFFLINE,{uid:n.uid,reason:kC.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),t||(zy.debug("change local token from ".concat(t," to ").concat(t)),this.token=xS(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(NC.ABORT)}}ih(xb,"MAX_SIZE",1),ih(xb,"MAX_MESSAGE_SIZE",1024);class Vb extends nS{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===gR.CONNECTED?this.emit(SR.WS_CONNECTED):e===gR.RECONNECTING?this.emit(SR.WS_RECONNECTING,this._websocketReconnectReason):e===gR.CLOSED&&this.emit(SR.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),ih(this,"_disconnectedReason",void 0),ih(this,"_websocketReconnectReason",void 0),ih(this,"_connectionState",gR.CLOSED),ih(this,"reconnectToken",void 0),ih(this,"p2pToken",void 0),ih(this,"websocket",void 0),ih(this,"openConnectionTime",void 0),ih(this,"clientId",void 0),ih(this,"lastMsgTime",Date.now()),ih(this,"uploadCache",[]),ih(this,"uploadCacheInterval",void 0),ih(this,"rttRolling",new dT(5)),ih(this,"pingpongTimer",void 0),ih(this,"pingpongTimeoutCount",0),ih(this,"joinResponse",void 0),ih(this,"multiIpOption",void 0),ih(this,"initError",void 0),ih(this,"spec",void 0),ih(this,"store",void 0),ih(this,"_external_signal",void 0),ih(this,"onWebsocketMessage",(e=>{if(e.data instanceof ArrayBuffer)return void this.emit(SR.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){switch(t._type){case yR.ON_DATA_STREAM:return void this.handleDataStream(t._message);case yR.MUTE_AUDIO:case yR.MUTE_VIDEO:case yR.ON_P2P_LOST:case yR.ON_USER_ONLINE:return;case yR.ON_USER_OFFLINE:const{uid:e}=t._message;return zy.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(t._type,t._message),t._type===yR.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===yR.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(cS.UID_BANNED);break;case 15:this.close(cS.IP_BANNED);break;case 16:this.close(cS.CHANNEL_BANNED)}if(t._type===yR.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case ER.ERR_LICENSE_MISSING:this.close(cS.LICENSE_MISSING);break;case ER.ERR_LICENSE_EXPIRED:this.close(cS.LICENSE_EXPIRED);break;case ER.ERR_LICENSE_MINUTES_EXCEEDED:this.close(cS.LICENSE_MINUTES_EXCEEDED);break;case ER.ERR_LICENSE_PERIOD_INVALID:this.close(cS.LICENSE_PERIOD_INVALID);break;case ER.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(cS.LICENSE_MULTIPLE_SDK_SERVICE);break;case ER.ERR_LICENSE_ILLEGAL:this.close(cS.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new ZC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dy("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dy("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===gR.CONNECTED&&this.reconnect("retry",lS.OFFLINE)})),this.p2pToken=xS(6,""),this._external_signal=new xb(this,this.p2pToken)}async request(e,t,n,i){const r=xS(6,""),o={_id:r,_type:e,_message:t},s=this.websocket.connectionID,a=()=>new tg(((e,t)=>{if(this.connectionState===gR.CONNECTED)return e();const n=()=>{this.off(SR.WS_CLOSED,i),e()},i=()=>{this.off(SR.WS_CONNECTED,n),t(new Vg(xg.WS_ABORT))};this.once(SR.WS_CONNECTED,n),this.once(SR.WS_CLOSED,i)}));if(this.connectionState!==gR.CONNECTING&&this.connectionState!==gR.RECONNECTING||e===TR.JOIN||e===TR.REJOIN||await a(),this.websocket.sendMessage(o,!0),i)return;const c=new tg(((n,i)=>{let o=!1;const a=(i,r)=>{o=!0,n({isSuccess:"success"===i,message:r||{}}),this.off(SR.WS_CLOSED,c),this.off(SR.WS_RECONNECTING,c),this.emit(SR.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{i(new Vg(xg.WS_ABORT,"type: ".concat(e))),this.off(SR.WS_CLOSED,c),this.off(SR.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(SR.WS_CLOSED,c),this.once(SR.WS_RECONNECTING,c),US(Dy("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==s||o||(zy.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(SR.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(i){if(this.connectionState===gR.CLOSED||e===TR.LEAVE)throw new Vg(xg.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?i.throw():e===TR.JOIN||e===TR.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),u=FC(l),h=new Vg(xg.UNEXPECTED_RESPONSE,"".concat(u.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===u.action?d.message:(zy.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(u.desc,", action: ").concat(u.action)),l===ER.ERR_TOO_MANY_BROADCASTERS?e===TR.JOIN||e===TR.REJOIN?(this.initError=h,this.close(),h.throw()):h.throw():"failed"===u.action?h.throw():"quit"===u.action?(this.initError=h,this.close(),h.throw()):(l===ER.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,zy.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",lS.MULTI_IP)):this.reconnect(u.action,lS.SERVER_ERROR),e===TR.JOIN||e===TR.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new tg((n=>{const i=r=>{(!t||t(r))&&(this.off(e,i),n(r))};this.on(e,i)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void zy.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(vR.WRTC_STATS,t)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=Dy("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==gR.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Dy("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const n={_type:e,_message:t};this.websocket.sendMessage(n)}async sendExtensionMessage(e,t,n){return await this._external_signal.send(e,t,n)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new tg(((t,n)=>{this.once(SR.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(SR.WS_CLOSED,(()=>n(this.initError||new Vg(xg.WS_ABORT)))),this.connectionState=gR.CONNECTING,this.websocket.init(e).catch(n)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||cS.LEAVE,this.connectionState=gR.CLOSED,zy.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===cS.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new ZC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dy("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dy("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=xS(6,""),this._external_signal.clear(),this._external_signal=new xb(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(SR.ABORT_P2P_EXECUTION);const e=await ES(this,SR.REQUEST_JOIN_INFO),t=await this.request(TR.JOIN,e);if(!t)return this.emit(SR.REPORT_JOIN_GATEWAY,xg.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(SR.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=gR.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{var t;const n=DS(e.payload),i=(new TextDecoder).decode(n),r=JSON.parse(i);"total"in r&&"id"in r||Ai(t=Object.values(OC)).call(t,r._type)?(r._uid=e.uid,this._external_signal.onMessage(r)):this.emit(yR.ON_DATA_STREAM,e)}catch(t){this.emit(yR.ON_DATA_STREAM,e)}}handleNotification(e){zy.debug("[".concat(this.clientId,"] receive notification: "),e);const t=FC(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(cS.UID_BANNED),void this.close()):void this.reconnect(t.action,lS.SERVER_ERROR);zy.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Dy("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(zy.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Dy("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",lS.TIMEOUT):this.request(TR.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Dy("REPORT_STATS")&&this.send(TR.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(bR.RECONNECT_WAITTING_FINISH,(e=>{this.emit(SR.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(bR.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(SR.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(bR.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(bR.CLOSED,(()=>{this.connectionState=gR.CLOSED})),this.websocket.on(bR.FAILED,(()=>{this._disconnectedReason=cS.NETWORK_ERROR,this.connectionState=gR.CLOSED})),this.websocket.on(bR.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===gR.CONNECTED?this.connectionState=gR.RECONNECTING:this.connectionState=gR.CONNECTING})),this.websocket.on(bR.WILL_RECONNECT,((e,t,n)=>{"retry"!==e?(zy.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(SR.NEED_RENEW_SESSION)):zy.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)})),this.websocket.on(bR.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(SR.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof Vg&&e.code===xg.UNEXPECTED_RESPONSE&&e.data.code===ER.ERR_NO_AUTHORIZED)return zy.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",lS.SERVER_ERROR);zy.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",lS.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(bR.REQUEST_NEW_URLS,((e,t)=>{ES(this,SR.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(bR.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(yR.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}function Fb(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function jb(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Fb(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Fb(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Bb=new Map;class Gb extends nS{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(tC.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(tC.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){zy.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),ih(this,"store",void 0),ih(this,"joinInfo",void 0),ih(this,"key",void 0),ih(this,"ntpOffset",0),ih(this,"signal",void 0),ih(this,"role",void 0),ih(this,"inChannelInfo",{joinAt:null,duration:0}),ih(this,"spec",void 0),ih(this,"_state","DISCONNECTED"),ih(this,"_statsCollector",void 0),ih(this,"_disconnectedReason",void 0),ih(this,"isSignalRecover",!1),ih(this,"hasChangeBGPAddress",!1),ih(this,"trafficStatsInterval",void 0),ih(this,"networkQualityInterval",void 0),ih(this,"_joinGatewayStartTime",0),ih(this,"_signalTimeout",!1),ih(this,"_clientRoleOptions",void 0),ih(this,"_isProactiveJoin",!1),this.store=e,this.spec=t,this.signal=this.store.useP2P?new Vb(jb(jb({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new Ub(jb(jb({},t),{},{retryConfig:t.websocketRetryConfig}),e):new eb(jb(jb({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,t,n){if(this.signal instanceof Ub){let t=!1;"disabled"!==e.cloudProxyServer?(zy.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),t=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(zy.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),t=!0):e.apResponse.addresses.some((e=>e.fingerprint))||Dy("FINGERPRINT")||(zy.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),t=!0),t&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const i=Date.now();let r=Bb.get(e.cname);if(r||(r=new Map,Bb.set(e.cname,r)),this._isProactiveJoin=!0,r.has(e.uid)){const t=new VR(xg.UID_CONFLICT);throw oR.joinGateway(e.sid,{lts:i,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof Ub?"1":"0"}),this._isProactiveJoin=!1,t}r.set(e.uid,!0),this.joinInfo=e,this.key=t;let o=0;this.joinGatewayStartTime=i;const s=e.proxyServer;try{let t;if(zy.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Ub?"datachannel":"websocket"," join uid ").concat(o)),this.signal instanceof Ub)t=await this.signal.init(e.apResponse.addresses,n);else{const i=e.gatewayAddrs.map((t=>{let{address:n}=t;const[i,r]=n.split(":"),o={host:i,port:r};return e.proxyServer&&(o.proxy=e.proxyServer),o}));t=await this.signal.init(i,n)}o=t.uid,zy.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Ub?"datachannel":"websocket"," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(t){if(t&&t.code===xg.INIT_WEBSOCKET_TIMEOUT)throw zy.warning("[".concat(this.store.clientId,"] User join failed"),t.toString()),t;if(t&&t.code===xg.INIT_DATACHANNEL_TIMEOUT)throw zy.warning("[".concat(this.store.clientId,"] User join datachannel failed"),t.toString()),this.resetSignal(),t;throw zy.error("[".concat(this.store.clientId,"] User join failed"),t.toString()),oR.joinGateway(e.sid,{lts:i,succ:!1,ec:t.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!s,signalChannel:this.signal instanceof Ub?"1":"0"}),this._isProactiveJoin=!1,r.delete(e.uid),this.signal.close(),t}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),zy.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{zy.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(tC.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(tC.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(tC.NETWORK_QUALITY,{uplinkNetworkQuality:wb(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:wb(this._statsCollector.trafficStats.B_dnq)}):this.emit(tC.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){t!==cS.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==gR.CONNECTED||await function(e,t){return t===1/0?e:tg.race([e,MS(t)])}(this.signal.request(TR.LEAVE,void 0,!0),3e3)}catch(e){zy.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(t),t!==cS.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const i={state:"offer",p2p_id:this.store.p2pId,ortc:t,mode:this.spec.mode,extend:Dy("PUB_EXTEND"),twcc:!!Dy("PUBLISH_TWCC"),rtx:!!Dy("USE_PUB_RTX")};try{return(await this.signal.request(TR.PUBLISH,i,!0))._message}catch(i){if(n&&i.data&&i.data.code===ER.ERR_PUBLISH_REQUEST_INVALID)return zy.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),i.toString()),await this.tryUnpubBeforeRepub(e,t),this.publish(e,t,!1);throw i}}async publishDataChannel(e,t,n){var i;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={stream_id:t.streamId,ordered:t.ordered?1:0,max_retrans_times:null!==(i=t.maxRetransmits)&&void 0!==i?i:10,channel_id:t.channelId,metadata:t.metadata};try{await this.signal.request(TR.PUBLISH_DATASTREAM,r,!0)}catch(i){if(n&&i.data&&i.data.code===ER.ERR_PUBLISH_REQUEST_INVALID)return zy.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),i.toString()),await this.tryUnpubDataChannelBeforeRepub(e,t),this.publishDataChannel(e,t,!1);throw i}}async unpublish(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(TR.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(e){zy.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await tg.all(e.map((e=>this.signal.request(TR.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){zy.warning("unpublish datachannels warning: ",e)}}async presubscribe(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const i={stream_id:e,stream_type:t,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Dy("SUBSCRIBE_TWCC"),rtx:!!Dy("USE_SUB_RTX")||void 0,extend:Dy("SUB_EXTEND"),svc:Array.isArray(Dy("SVC"))&&0!==Dy("SVC").length?Dy("SVC"):void 0};try{return await this.signal.request(TR.PRE_SUBSCRIBE,i,!0)}catch(i){if(n&&i.data&&i.data.code===ER.ERR_SUBSCRIBE_REQUEST_INVALID)return zy.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),i.toString()),this.presubscribe(e,t,!1);throw i}}async subscribe(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const i={stream_id:e,stream_type:t.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Dy("SUBSCRIBE_TWCC"),rtx:!!Dy("USE_SUB_RTX"),extend:Dy("SUB_EXTEND"),ssrcId:t.ssrcId,svc:Array.isArray(Dy("SVC"))&&0!==Dy("SVC").length?Dy("SVC"):void 0};try{return(await this.signal.request(TR.SUBSCRIBE,i,!0))._message}catch(i){if(n&&i.data&&i.data.code===ER.ERR_SUBSCRIBE_REQUEST_INVALID)return zy.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),i.toString()),await this.tryUnsubBeforeResub(e,t),await this.subscribe(e,t,!1);throw i}}async subscribeDataChannel(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const i={uid:e,stream_id:t.id,channel_id:t.datachannelId};try{return void await this.signal.request(TR.SUBSCRIBE_DATASTREAM,i,!0)}catch(i){if(n&&i.data&&i.data.code===ER.ERR_SUBSCRIBE_REQUEST_INVALID)return zy.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),i.toString()),await this.tryUnsubDataChannelBeforeResub(e,t),await this.subscribeDataChannel(e,t,!1);throw i}}async subscribeAll(e,t){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!Dy("USE_SUB_RTX")};try{return await this.signal.request(TR.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(t&&n.data&&n.data.code===ER.ERR_SUBSCRIBE_REQUEST_INVALID)return zy.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){const t=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,n=e.width,i=e.height,r=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(r=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,n||(r=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,t||(r=!1)),r?{stream_type:0,width:n,height:i,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(t)return this.signal.request(TR.SET_VIDEO_PROFILE,t);zy.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,t){try{await this.signal.request(TR.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:t},!0)}catch(e){zy.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new VR(xg.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await tg.all(e.map((e=>this.signal.request(TR.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:t},!0))))}catch(e){zy.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(TR.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){zy.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=e;return{gatewayEstablishParams:await this.signal.request(TR.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(TR.GATEWAY_INFO)}async renewToken(e){await this.signal.request(TR.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let n,i=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(n=this._clientRoleOptions.delay,i=1):i=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:i=0,await this.signal.request(TR.SET_CLIENT_ROLE,{role:e,level:i,delay:n,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(TR.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(TR.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(TR.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(TR.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(TR.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,n){if(this.signal instanceof Vb)return this.signal.sendExtensionMessage(e,t,n)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),jb({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(TR.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=Bb.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:aR.username,password:aR.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(jb(jb({},aR),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(TR.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&IS((()=>{this.emit(tC.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new VR(xg.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let n=Dy("REPORT_APP_SCENARIO");if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n=void 0}n&&n.length>128&&(n=void 0);const i=jb({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:by,browser:navigator.userAgent,process_id:Dy("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:Dy("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:n,attributes:{userAttributes:{enablePublishedUserList:Dy("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:Dy("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof Dy("SUBSCRIBE_AUDIO_FILTER_TOPN")?Dy("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof Dy("ENABLE_PUBLISH_AUDIO_FILTER")?Dy("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof Dy("ENABLE_USER_LICENSE_CHECK")?Dy("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===Dy("USE_PUB_RTX")||!0===Dy("USE_SUB_RTX")||void 0,disableFEC:Dy("DISABLE_FEC"),enableNTPReport:!!Dy("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!Dy("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof Dy("ENABLE_DATASTREAM_2")?Dy("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!Dy("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof Dy("USE_XR")?Dy("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(i.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(i.aes_mode=this.joinInfo.aesmode,Dy("ENCRYPT_AES")?(i.aes_secret=this.joinInfo.aespassword,i.aes_encrypt=!0):i.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(i.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(i.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(i.default_video_stream=this.joinInfo.defaultVideoStream),i}getRejoinMessage(){if(!this.joinInfo)throw new VR(xg.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(SR.WS_RECONNECT_WAITTING_FINISH,(e=>{var t;Ai(t=["tryNext","recover"]).call(t,e)&&this.joinInfo&&oR.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(SR.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(SR.WS_RECONNECTING,(e=>{this.joinInfo&&oR.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||lS.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",oR.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(SR.WS_CLOSED,(e=>{let t;switch(e){case cS.LEAVE:t=lS.LEAVE;break;case cS.UID_BANNED:case cS.IP_BANNED:case cS.CHANNEL_BANNED:case cS.SERVER_ERROR:t=lS.SERVER_ERROR;break;case cS.FALLBACK:t=lS.FALLBACK;break;case cS.LICENSE_MISSING:case cS.LICENSE_EXPIRED:case cS.LICENSE_MINUTES_EXCEEDED:case cS.LICENSE_PERIOD_INVALID:case cS.LICENSE_MULTIPLE_SDK_SERVICE:case cS.LICENSE_ILLEGAL:case cS.TOKEN_EXPIRE:t=e;break;default:t=lS.NETWORK_ERROR}zy.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(t||"undefined -> "+lS.NETWORK_ERROR)),this.joinInfo&&oR.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===cS.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t}),this._disconnectedReason=e,e!==cS.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(SR.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(zy.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),oR.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Ub?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void zy.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Ny("EVENT_REPORT_DOMAIN",e[1]),Ny("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Ny("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(yR.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(SR.REQUEST_RECOVER,((e,t,n)=>{if(!this.joinInfo)return n(new VR(xg.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,ES(this,tC.REQUEST_NEW_GATEWAY_LIST).then(t).catch(n)})),this.signal.on(SR.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=await ES(this,tC.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r,version:"2"}}))})),this.signal.on(SR.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(SR.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(oR.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Ub?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(SR.IS_P2P_DISCONNECTED,(e=>{e(TS(this,tC.IS_P2P_DISCONNECTED))})),this.signal.on(SR.DISCONNECT_P2P,(()=>{this.emit(tC.DISCONNECT_P2P)})),this.signal.on(SR.NEED_RENEW_SESSION,(()=>{this.emit(tC.NEED_RENEW_SESSION)})),this.signal.on(SR.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(SR.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(SR.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(tC.JOIN_RESPONSE,e,t)})),this.signal.on(SR.DATACHANNEL_PRECONNECT,(async(e,t,n)=>{this.updateTurnConfigFromSignal();const i=this.getCurrentGatewayAddress();return ES(this,tC.DATACHANNEL_PRECONNECT,e,i).then(t).catch(n)})),this.signal.on(SR.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await ES(this,tC.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:n,rtpCapabilities:i,version:"2"}}))})),this.signal.on(SR.DATACHANNEL_FAILBACK,(()=>{zy.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(tC.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,t){try{await this.signal.request(TR.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[t]},!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,t){try{await this.signal.request(TR.UNSUBSCRIBE,{stream_id:t.id},!0)}catch(e){throw zy.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,t){try{await this.signal.request(TR.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,t){try{await this.signal.request(TR.UNPUBLISH_DATASTREAM,{channnel_id:t.channelId},!0)}catch(e){throw zy.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const t={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(TR.UNSUBSCRIBE_STREAMS,t,!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,t){const n={action:e.find((e=>e.stream_type===eC.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(TR.CONTROL,n,!0,!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,t){const n={action:e.find((e=>e.stream_type===eC.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(TR.CONTROL,n,!0,!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,t){const n={action:e===hC.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(TR.CONTROL,n,!0,!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,t){const n={action:e===hC.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(TR.CONTROL,n,!0,!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const t={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(TR.RESTART_ICE,t,!0)}catch(e){throw zy.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,lS.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!Dy("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(TR.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(cS.FALLBACK)),this.store.useDataChannel=!1,this.signal=new eb(jb(jb({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(tC.RESET_SIGNAL,rC.websocket)}}let Wb=0,Hb=0;function Kb(e,t,n,i){return new tg(((r,o)=>{t.timeout=t.timeout||Dy("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),Wb+=kS(t.data)):n&&(t.data.size?Wb+=t.data.size:t.data instanceof FormData?Wb+=LS(t.data):Wb+=kS(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,_y.request(t).then((e=>{"string"==typeof e.data?Hb+=kS(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?Hb+=e.data.byteLength:Hb+=kS(JSON.stringify(e.data)),i&&r({data:e.data,headers:e.headers}),r(e.data)})).catch((e=>{_y.isCancel(e)?o(new VR(xg.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new VR(xg.NETWORK_TIMEOUT,e.message)):e.response?o(new VR(xg.NETWORK_RESPONSE_ERROR,e.response.status)):o(new VR(xg.NETWORK_ERROR,e.message))}))}))}!function(){var e;function n(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}var i,r="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype||(e[t]=n.value),e},o=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof t&&t];for(var n=0;n<e.length;++n){var i=e[n];if(i&&i.Math==Math)return i}throw Error("Cannot find global object")}(this);function s(e,t){if(t)e:{var n=o;e=e.split(".");for(var i=0;i<e.length-1;i++){var s=e[i];if(!(s in n))break e;n=n[s]}(t=t(i=n[e=e[e.length-1]]))!=i&&null!=t&&r(n,e,{configurable:!0,writable:!0,value:t})}}function a(e){return(e={next:e})[Symbol.iterator]=function(){return this},e}function c(e){var t="undefined"!=typeof Symbol&&Symbol.iterator&&e[Symbol.iterator];return t?t.call(e):{next:n(e)}}if(s("Symbol",(function(e){function t(e,t){this.A=e,r(this,"description",{configurable:!0,writable:!0,value:t})}if(e)return e;t.prototype.toString=function(){return this.A};var n="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",i=0;return function e(r){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new t(n+(r||"")+"_"+i++,r)}})),s("Symbol.iterator",(function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var t="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),i=0;i<t.length;i++){var s=o[t[i]];"function"==typeof s&&"function"!=typeof s.prototype[e]&&r(s.prototype,e,{configurable:!0,writable:!0,value:function(){return a(n(this))}})}return e})),"function"==typeof Object.setPrototypeOf)i=Object.setPrototypeOf;else{var d;e:{var l={};try{l.__proto__={a:!0},d=l.a;break e}catch(e){}d=!1}i=d?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}var u=i;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(e){if(e.m)throw new TypeError("Generator is already running");e.m=!0}function f(e,t){return e.h=3,{value:t}}function _(e){this.g=new h,this.G=e}function m(e,t,n,i){try{var r=t.call(e.g.j,n);if(!(r instanceof Object))throw new TypeError("Iterator result "+r+" is not an object");if(!r.done)return e.g.m=!1,r;var o=r.value}catch(t){return e.g.j=null,e.g.s(t),E(e)}return e.g.j=null,i.call(e.g,o),E(e)}function E(e){for(;e.g.h;)try{var t=e.G(e.g);if(t)return e.g.m=!1,{value:t.value,done:!1}}catch(t){e.g.v=void 0,e.g.s(t)}if(e.g.m=!1,e.g.l){if(t=e.g.l,e.g.l=null,t.F)throw t.D;return{value:t.return,done:!0}}return{value:void 0,done:!0}}function g(e){this.next=function(t){return e.o(t)},this.throw=function(t){return e.s(t)},this.return=function(t){return function(e,t){p(e.g);var n=e.g.j;return n?m(e,"return"in n?n.return:function(e){return{value:e,done:!0}},t,e.g.return):(e.g.return(t),E(e))}(e,t)},this[Symbol.iterator]=function(){return this}}function S(e,t){return t=new g(new _(t)),u&&e.prototype&&u(t,e.prototype),t}if(h.prototype.o=function(e){this.v=e},h.prototype.s=function(e){this.l={D:e,F:!0},this.h=this.C||this.u},h.prototype.return=function(e){this.l={return:e},this.h=this.u},_.prototype.o=function(e){return p(this.g),this.g.j?m(this,this.g.j.next,e,this.g.o):(this.g.o(e),E(this))},_.prototype.s=function(e){return p(this.g),this.g.j?m(this,this.g.j.throw,e,this.g.o):(this.g.s(e),E(this))},s("Array.prototype.entries",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var n=0,i=!1,r={next:function(){if(!i&&n<e.length){var r=n++;return{value:t(r,e[r]),done:!1}}return i=!0,{done:!0,value:void 0}}};return r[Symbol.iterator]=function(){return r},r}(this,(function(e,t){return[e,t]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var T=function(e,t){for(var n=0;n<e.length;n++)t(e[n])},v=function(e){return e.replace(/\r?\n|\r/g,"\r\n")},y=function(e,t,n){return t instanceof Blob?(n=void 0!==n?String(n+""):"string"==typeof t.name?t.name:"blob",t.name===n&&"[object Blob]"!==Object.prototype.toString.call(t)||(t=new File([t],n)),[String(e),t]):[String(e),String(t)]},R=function(e,t){if(e.length<t)throw new TypeError(t+" argument required, but only "+e.length+" present.")},C="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,b=C.FormData,I=C.XMLHttpRequest&&C.XMLHttpRequest.prototype.send,w=C.Request&&C.fetch,A=C.navigator&&C.navigator.sendBeacon,O=C.Element&&C.Element.prototype,N=C.Symbol&&Symbol.toStringTag;N&&(Blob.prototype[N]||(Blob.prototype[N]="Blob"),"File"in C&&!File.prototype[N]&&(File.prototype[N]="File"));try{new File([],"")}catch(e){C.File=function(e,t,n){return e=new Blob(e,n||{}),Object.defineProperties(e,{name:{value:t},lastModified:{value:+(n&&void 0!==n.lastModified?new Date(n.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),N&&Object.defineProperty(e,N,{value:"File"}),e}}var D=function(e){return e.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},P=function(e){this.i=[];var t=this;e&&T(e.elements,(function(e){if(e.name&&!e.disabled&&"submit"!==e.type&&"button"!==e.type&&!e.matches("form fieldset[disabled] *"))if("file"===e.type){var n=e.files&&e.files.length?e.files:[new File([],"",{type:"application/octet-stream"})];T(n,(function(n){t.append(e.name,n)}))}else"select-multiple"===e.type||"select-one"===e.type?T(e.options,(function(n){!n.disabled&&n.selected&&t.append(e.name,n.value)})):"checkbox"===e.type||"radio"===e.type?e.checked&&t.append(e.name,e.value):(n="textarea"===e.type?v(e.value):e.value,t.append(e.name,n))}))};if((e=P.prototype).append=function(e,t,n){R(arguments,2),this.i.push(y(e,t,n))},e.delete=function(e){R(arguments,1);var t=[];e=String(e),T(this.i,(function(n){n[0]!==e&&t.push(n)})),this.i=t},e.entries=function e(){var t,n=this;return S(e,(function(e){if(1==e.h&&(t=0),3!=e.h)return t<n.i.length?e=f(e,n.i[t]):(e.h=0,e=void 0),e;t++,e.h=2}))},e.forEach=function(e,t){R(arguments,1);for(var n=c(this),i=n.next();!i.done;i=n.next()){var r=c(i.value);i=r.next().value,r=r.next().value,e.call(t,r,i,this)}},e.get=function(e){R(arguments,1);var t=this.i;e=String(e);for(var n=0;n<t.length;n++)if(t[n][0]===e)return t[n][1];return null},e.getAll=function(e){R(arguments,1);var t=[];return e=String(e),T(this.i,(function(n){n[0]===e&&t.push(n[1])})),t},e.has=function(e){R(arguments,1),e=String(e);for(var t=0;t<this.i.length;t++)if(this.i[t][0]===e)return!0;return!1},e.keys=function e(){var t,n,i,r=this;return S(e,(function(e){if(1==e.h&&(t=c(r),n=t.next()),3!=e.h)return n.done?void(e.h=0):(i=n.value,f(e,c(i).next().value));n=t.next(),e.h=2}))},e.set=function(e,t,n){R(arguments,2),e=String(e);var i=[],r=y(e,t,n),o=!0;T(this.i,(function(t){t[0]===e?o&&(o=!i.push(r)):i.push(t)})),o&&i.push(r),this.i=i},e.values=function e(){var t,n,i,r,o=this;return S(e,(function(e){if(1==e.h&&(t=c(o),n=t.next()),3!=e.h)return n.done?void(e.h=0):(i=n.value,(r=c(i)).next(),f(e,r.next().value));n=t.next(),e.h=2}))},P.prototype._asNative=function(){for(var e=new b,t=c(this),n=t.next();!n.done;n=t.next()){var i=c(n.value);n=i.next().value,i=i.next().value,e.append(n,i)}return e},P.prototype._blob=function(){var e="----formdata-polyfill-"+Math.random(),t=[],n="--"+e+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(e,i){return"string"==typeof e?t.push(n+D(v(i))+'"\r\n\r\n'+v(e)+"\r\n"):t.push(n+D(v(i))+'"; filename="'+D(e.name)+'"\r\nContent-Type: '+(e.type||"application/octet-stream")+"\r\n\r\n",e,"\r\n")})),t.push("--"+e+"--"),new Blob(t,{type:"multipart/form-data; boundary="+e})},P.prototype[Symbol.iterator]=function(){return this.entries()},P.prototype.toString=function(){return"[object FormData]"},O&&!O.matches&&(O.matches=O.matchesSelector||O.mozMatchesSelector||O.msMatchesSelector||O.oMatchesSelector||O.webkitMatchesSelector||function(e){for(var t=(e=(this.document||this.ownerDocument).querySelectorAll(e)).length;0<=--t&&e.item(t)!==this;);return-1<t}),N&&(P.prototype[N]="FormData"),I){var k=C.XMLHttpRequest.prototype.setRequestHeader;C.XMLHttpRequest.prototype.setRequestHeader=function(e,t){k.call(this,e,t),"content-type"===e.toLowerCase()&&(this.B=!0)},C.XMLHttpRequest.prototype.send=function(e){e instanceof P?(e=e._blob(),this.B||this.setRequestHeader("Content-Type",e.type),I.call(this,e)):I.call(this,e)}}w&&(C.fetch=function(e,t){return t&&t.body&&t.body instanceof P&&(t.body=t.body._blob()),w.call(this,e,t)}),A&&(C.navigator.sendBeacon=function(e,t){return t instanceof P&&(t=t._asNative()),A.call(this,e,t)}),C.FormData=P}}();const zb=()=>{const e=Dy("AREAS");return 0===e.length&&e.push(oC.GLOBAL),cT(e).call(e,((e,t,n)=>{const i=Yb(t);return i?0===n?i:"".concat(e,",").concat(i):e}),"")},Yb=e=>e===oC.OVERSEA?"".concat(cC.ASIA,",").concat(cC.EUROPE,",").concat(cC.AFRICA,",").concat(cC.NORTH_AMERICA,",").concat(cC.SOUTH_AMERICA,",").concat(cC.OCEANIA):cC[e],qb=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const n=dC[e],i=Object.keys(n);i&&i.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(n[e]))}))})),t},Jb={GLOBAL:{ASIA:[oC.CHINA,oC.JAPAN,oC.INDIA,oC.KOREA,oC.HKMC],EUROPE:[],NORTH_AMERICA:[oC.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Xb=Object.keys(Jb[oC.GLOBAL]),Qb=[oC.CHINA,oC.NORTH_AMERICA,oC.EUROPE,oC.ASIA,oC.JAPAN,oC.INDIA,oC.OCEANIA,oC.SOUTH_AMERICA,oC.AFRICA,oC.KOREA,oC.HKMC,oC.US],Zb=function(e,t){let n=[];if(Ai(e).call(e,oC.GLOBAL)){const o=[oC.GLOBAL,oC.OVERSEA],s=Object.keys(dC);if(t===oC.GLOBAL)throw new VR(xg.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===oC.CHINA)n=[oC.OVERSEA];else if(r=t,Ai(Xb).call(Xb,r)){const e=(i=t,Jb[oC.GLOBAL][i]||[]),r=[...o,t,...e];n=s.filter((e=>!Ai(r).call(r,e)))}else if(function(e){let t=!1;return Xb.forEach((n=>{var i;Ai(i=Jb[oC.GLOBAL][n]).call(i,e)&&(t=!0)})),t}(t)){const e=function(e){let t;return Xb.forEach((n=>{var i;Ai(i=Jb[oC.GLOBAL][n]).call(i,e)&&(t=n)})),t}(t),i=[...o,e,t];n=s.filter((e=>!Ai(i).call(i,e)))}else n=e;n=function(e){const t=[];return Qb.forEach((n=>{Ai(e).call(e,n)&&t.push(n)})),t.concat(e.filter((e=>!Ai(Qb).call(Qb,e))))}(n)}else n=e;var i,r;return n};function $b(e){var t,n;if(!e&&Ai(t=Dy("AREAS")).call(t,oC.EXTENSIONS))return zy.debug("update area from ap : reset"),void eI(sR,!0);if(!Ai(n=Dy("AREAS")).call(n,oC.GLOBAL)||!e)return;let i=dC.EXTENSIONS;i&&(i={CODE:Yb(oC.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},zy.debug("update area from ap success: ".concat(e,",config is "),i),Ny("AREAS",[oC.EXTENSIONS],!0),Object.keys(i).map((e=>{Ny(e,"LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e?i[e][0]:i[e])})))}function eI(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=oR.reportApiInvoke(null,{name:oS.SET_AREA,options:e,tag:sS.TRACER});try{let i=[];if("string"==typeof e&&(i=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!Ai(aC).call(aC,e))throw new VR(xg.INVALID_PARAMS,"invalid area code")})),i=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:n}=e;if(!t)throw new VR(xg.INVALID_PARAMS,"area code is needed");let r=t;"string"==typeof t&&(r=[t]),i=n?Zb(r,n):r}if(!t){if(Py.AREAS){const e=new VR(xg.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(e),void zy.warning("setArea is prohibited because of config-distribute")}if(Ai(i).call(i,oC.GLOBAL)&&Dy("AREAS")===oC.EXTENSIONS){const e=new VR(xg.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(e),void zy.warning("setArea is prohibited because of ap extensions")}}Ny("AREAS",i,t);const r=qb(i);Object.keys(r).map((e=>{Ny(e,"LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e?r[e][0]:r[e])})),zy.debug("set area success:",i.join(","))}catch(e){throw n.onError(e),e}n.onSuccess()}function tI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function nI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tI(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tI(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let iI=1;function rI(e,t,n,i,r){iI+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:iI,requestId:iI,version:by,cname:n.cname},s={service_name:t,json_body:JSON.stringify(o)};let a,c,d=e[0];return XS((async()=>{a=Date.now();const e=await Kb(d,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==e.code){const t=new VR(xg.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:c});throw zy.error(t.toString()),t}const n=JSON.parse(e.json_body);if(200!==n.code){const e=new VR(xg.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(n.code,", reason: ").concat(n.reason),{code:n.code,responseTime:c});throw zy.error(e.toString()),e}if(!n.servers||0===n.servers.length){const e=new VR(xg.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:n.code,responseTime:c});throw zy.error(e.toString()),e}const r=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(Dy("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(n,t);return Dy("LIVE_STREAMING_ADDRESS")&&(r.addressList=Dy("LIVE_STREAMING_ADDRESS")instanceof Array?Dy("LIVE_STREAMING_ADDRESS"):[Dy("LIVE_STREAMING_ADDRESS")]),nI(nI({},r),{},{responseTime:c})}),((i,r)=>(oR.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(i.addressList),firstSuccess:0===r,responseTime:c,serverIp:e[r%e.length]}),!1)),((i,r)=>(oR.apworkerEvent(n.sid,{success:!1,sc:i.data&&i.data.code||200,serviceName:t,responseTime:c,serverIp:e[r%e.length]}),!!(i.code!==xg.OPERATION_ABORTED&&i.code!==xg.UNEXPECTED_RESPONSE||i.data&&i.data.retry)&&(d=e[(r+1)%e.length],!0))),r)}let oI=1;function sI(e,t,n,i){let{url:r,areaCode:o}=e;const s=Date.now();let a;const[c,d]=uI(t,o,[fb.CHOOSE_SERVER]);let l=vS.networkState;return XS((async()=>{l&&vS.networkState===uS.OFFLINE&&vS.onlineWaiter&&await tg.race([vS.onlineWaiter,US(i&&i.maxRetryTimeout||qS.maxRetryTimeout)]),l=vS.networkState;const{data:e,headers:o}=await Kb(r,{data:c,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===o.http3?1:-1,oR.reportResourceTiming(r,t.sid),cI(e,r,t,s,[fb.CHOOSE_SERVER],a);const d=Ab(e,fb.CHOOSE_SERVER);return dI(d),Cb(d,r)}),(e=>(e&&oR.joinChooseServer(t.sid,{lts:s,succ:!0,csAddr:r,opid:d,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[fb.CHOOSE_SERVER].toString(),isHttp3:a}),!1)),(e=>e.code!==xg.OPERATION_ABORTED&&(e.code===xg.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(oR.joinChooseServer(t.sid,{lts:s,succ:!1,csAddr:r,serverList:null,opid:d,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[fb.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:l}),isHttp3:a}),zy.warning("[".concat(t.clientId,"] Choose server network error, retry"),e),!0))),i)}function aI(e,t,n,i){let r,{url:o,areaCode:s,serviceIds:a}=e;const c=Date.now(),[d,l]=uI(t,s,a);let u;return XS((async()=>{u&&vS.networkState===uS.OFFLINE&&vS.onlineWaiter&&await tg.race([vS.onlineWaiter,US(i&&i.maxRetryTimeout||qS.maxRetryTimeout)]),u=vS.networkState;const{data:e,headers:s}=await Kb(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r="1"===s.http3?1:-1,oR.reportResourceTiming(o,t.sid),cI(e,o,t,c,a,r);const l=Ab(e,fb.CHOOSE_SERVER),h=Ab(e,"proxy5"===t.cloudProxyServer?fb.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?fb.CLOUD_PROXY:fb.CLOUD_PROXY_FALLBACK);return dI(l),{gatewayInfo:Cb(l,o),proxyInfo:h,url:o}}),(e=>(e.gatewayInfo&&oR.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:o,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:l,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),e.proxyInfo&&oR.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1)),(e=>e.code!==xg.OPERATION_ABORTED&&(e.code===xg.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(oR.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:e.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:u})}),zy.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),e),!0))),i)}const cI=(e,t,n,i,r,o)=>{const s=[],a=s=>{4096===s.flag?oR.joinChooseServer(n.sid,{lts:i,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:s.error.message,csIp:s.error.data&&s.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o}):1048576!==s.flag&&4194304!==s.flag&&4194310!==s.flag||oR.joinWebProxyAP(n.sid,{lts:i,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:s.error.code,eventType:n.cloudProxyServer,unilbsServerIds:r.toString()})};if(e.response_body.forEach((t=>{const n=t.buffer.code;if(23===t.uri&&0===n&&!t.buffer.edges_services)if(4194310===t.buffer.flag)zy.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),t.buffer.edges_services=[];else{const n={error:new VR(xg.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:t.buffer.flag};s.push(n),a(n)}if(0!==n){const i=xC(n),r={error:new VR(xg.CAN_NOT_GET_GATEWAY_SERVER,i.desc,{desc:i.desc,retry:i.retry,csIp:e.detail[502]}),flag:t.buffer.flag};4194310===t.buffer.flag?zy.warning(r.error.toString()):s.push(r),a(r)}})),s.length)throw zy.warning("[".concat(n.clientId,"] multi unilbs ").concat(t," failed, ").concat(s.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new VR(xg.CAN_NOT_GET_GATEWAY_SERVER,s.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!s.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(s.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},dI=e=>{var t,n,i,r;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new VR(xg.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(Dy("AP_AREA")&&(null!==(i=e.detail)&&void 0!==i&&i[23]&&"string"==typeof(null===(r=e.detail)||void 0===r?void 0:r[23])?$b(e.detail[23].toLowerCase()):$b()),null!==(t=e.detail)&&void 0!==t&&t[19]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[19])){const t=e.detail[19],n=null==t?void 0:t.split(";");for(let i=0;i<n.length;i++){var o;const t=Tb(o=n[i]).call(o);e.addresses[i]&&n&&(e.addresses[i].fingerprint=t)}}if(Dy("GATEWAY_ADDRESS")&&Dy("GATEWAY_ADDRESS").length>0){zy.debug("assign gateway address to",Dy("GATEWAY_ADDRESS"));const t=Dy("GATEWAY_ADDRESS").map((t=>{var n,i;const r=null!==(n=null===(i=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===i?void 0:i.fingerprint)&&void 0!==n?n:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:r}}));e.addresses=t}},lI=(e,t)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=xC(t.buffer.code);throw new VR(xg.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw zy.debug("update ticket request received ap response without response body:",t),new VR(xg.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},uI=(e,t,n)=>{const i=Math.floor(Math.random()*10**12),r={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:nI({6:e.stringUid,11:t,12:Dy("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:n,uid:e.uid||0}}]};r.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(r)),[o,i]},hI=(e,t)=>{const n=Math.floor(Math.random()*10**12),i={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let pI=0;function fI(e){return tg.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const _I=async e=>{let{fragementLength:t,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=e,s=0;const a=t;let c,d=0;const l=async()=>{const e=(()=>{const e=s*a,t=e+a;return n.slice(e,t).map(i)})();o&&o.push(...e);try{c=await fI(e)}catch(e){if(d+=a,s++,!(d>=n.length))return void await l();r(e)}e.forEach((e=>e.cancel()))};return await l(),c};async function mI(e,t,n,i){const r=async function(e,t,n,i){let r=null;const o=[],s=async()=>{const r=Dy("WEBCS_DOMAIN").slice(0,Dy("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:zb()}))),s=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),a=await _I({fragementLength:Dy("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:i=>(zy.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),sI(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},s),e[0]},promisesCollector:o});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},s),a},a=async()=>{if(await US(1e3),null!==r)return r;const s=Dy("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:zb()}))),a=i.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((e=>e.url))}),c=await _I({fragementLength:Dy("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:i=>(zy.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),sI(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:o});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c};try{return r=await fI([s(),a()]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),r}catch(e){throw e[0]}}(e,t,n,i);return{gatewayInfo:await r}}async function EI(e,t,n,i,r){const o=e.cloudProxyServer;if("disabled"===o){if(!i)return;if(e.useLocalAccessPoint)return await mI(e,t,n,r);if(Dy("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:i,proxyInfo:o}=await TI(e,t,n,r);if(e.turnServer&&"auto"!==e.turnServer.mode)return{gatewayInfo:i};const a=o.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||aR.tcpport,udpport:e.udpport||aR.udpport,username:e.username||aR.username,password:e.password||aR.password,forceturn:!1,security:!0})));if(r.useP2P){var s;const t=null!==(s=e.uid)&&void 0!==s?s:i.uid,n="glb:".concat(t.toString()),r=await tS(n),c=o.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||aR.tcpport,udpport:e.udpport||aR.udpport,username:n,password:r,forceturn:!1,security:!0})));a.push(...c)}return e.turnServer={mode:"manual",servers:a},{gatewayInfo:i}}return await mI(e,t,n,r)}const{proxyInfo:a,gatewayInfo:c}=await TI(e,t,n,r),d={gatewayInfo:c},l=a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===o?void 0:e.tcpport?e.tcpport:aR.tcpport,udpport:"proxy4"===o?void 0:e.udpport?e.udpport:aR.udpport,username:e.username||aR.username,password:e.password||aR.password,forceturn:"proxy4"!==o,security:"proxy5"===o})));if(r.useP2P){var u;const t=null!==(u=e.uid)&&void 0!==u?u:c.uid,n="glb:".concat(t.toString()),i=await tS(n),r=a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===o?void 0:e.tcpport||aR.tcpport,udpport:"proxy4"===o?void 0:e.udpport||aR.udpport,username:n,password:i,forceturn:"proxy4"!==o,security:"proxy5"===o})));l.push(...r)}return e.turnServer={mode:"manual",servers:l},zy.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(o)),d}async function gI(e,t,n,i,r){const o=Dy("ACCOUNT_REGISTER").slice(0,Dy("AJAX_REQUEST_CONCURRENT"));let s=[];s=t.proxyServer?o.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):o.map((e=>"https://".concat(e,"/api/v1")));const a=null==r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const o=await async function(e,t,n,i,r){const o=Date.now(),s={sid:n.sid,opid:10,appid:n.appId,string_uid:t};let a=e[0];const c=await XS((()=>Kb(a+"".concat(-1===a.indexOf("?")?"?":"&","action=stringuid"),{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((n,i)=>{if(0===n.code){if(n.uid<=0||n.uid>=Math.pow(2,32))throw zy.error("Invalid Uint Uid ".concat(t," => ").concat(n.uid),n),oR.reqUserAccount(s.sid,{lts:o,success:!1,serverAddr:a,stringUid:s.string_uid,uid:n.uid,errorCode:xg.INVALID_UINT_UID_FROM_STRING_UID,extend:s}),new VR(xg.INVALID_UINT_UID_FROM_STRING_UID);return oR.reqUserAccount(s.sid,{lts:o,success:!0,serverAddr:a,stringUid:s.string_uid,uid:n.uid,errorCode:null,extend:s}),!1}const r=xC(n.code);return r.retry&&(a=e[(i+1)%e.length]),oR.reqUserAccount(s.sid,{lts:o,success:!1,serverAddr:a,stringUid:s.string_uid,uid:n.uid,errorCode:r.desc,extend:s}),r.retry}),((t,n)=>t.code!==xg.OPERATION_ABORTED&&(oR.reqUserAccount(s.sid,{lts:o,success:!1,serverAddr:a,stringUid:s.string_uid,uid:null,errorCode:t.code,extend:s}),a=e[(n+1)%e.length],!0)),r);if(0!==c.code){const e=xC(c.code);throw new VR(xg.UNEXPECTED_RESPONSE,e.desc)}return c}(s,e,t,n,i);return null==r||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),o.uid}catch(e){throw null==r||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},a),e}}async function SI(e,t,n){const i=Dy("CDS_AP").slice(0,Dy("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((i=>function(e,t,n,i){const r=pg(),o={flag:64,cipher_method:0,features:{device:r.name,system:r.os,system_general:navigator.userAgent,vendor:t.appId,version:by,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return XS((()=>Kb(e,{data:o,timeout:1e3,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==xg.OPERATION_ABORTED),i)}(i,e,t,n)));let r=null,o=null,s={};try{r=await fI(i)}catch(e){if(e.code===xg.OPERATION_ABORTED)throw e;o=e}if(i.forEach((e=>e.cancel())),oR.reportApiInvoke(e.sid,{name:oS.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:r}}).onSuccess(),r&&r.test_tags)try{s=function(e){if(!e.test_tags)return{};const t=e.test_tags,n=Object.keys(t),i={};return n.forEach((e=>{var n;const r=Tb(n=e.slice(4)).call(n),o=JSON.parse(t[e])[1];i[r]=o})),i}(r)}catch(e){}return s}async function TI(e,t,n,i){const r=Dy("PROXY_SERVER_TYPE3"),o=(e,t,n)=>{let i=n||r;return Array.isArray(i)&&(i=t%2==0?r[1]:r[0]),"https://".concat(i,"/ap/?url=").concat(e)};let s=null;const a=[],c=async()=>{const r=Dy("WEBCS_DOMAIN").slice(0,Dy("AJAX_REQUEST_CONCURRENT")).map(((t,n)=>{let i;return i="disabled"===e.cloudProxyServer&&e.proxyServer?o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n),{url:i,areaCode:zb(),serviceIds:[fb.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?fb.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?fb.CLOUD_PROXY:fb.CLOUD_PROXY_FALLBACK]}})),s=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),c=await _I({fragementLength:Dy("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:i=>(zy.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),aI(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},s),e[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},s),c},d=async()=>{if(await US(1e3),null!==s)return s;const r=Dy("WEBCS_DOMAIN_BACKUP_LIST").map(((t,n)=>{let i;return i="disabled"===e.cloudProxyServer&&e.proxyServer?o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n),{url:i,areaCode:zb(),serviceIds:[fb.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?fb.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?fb.CLOUD_PROXY:fb.CLOUD_PROXY_FALLBACK]}})),c=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),d=await _I({fragementLength:Dy("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:i=>(zy.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),aI(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};let l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=await fI([c(),d()]))}catch(e){throw e[0]}if(a.length&&a.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!l||!u)throw new VR(xg.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=h,"disabled"!==e.cloudProxyServer&&Array.isArray(r)&&h){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];Ai(r).call(r,t)&&(e.proxyServer=t,zy.setProxyServer(t),oR.setProxyServer(t))}return s={gatewayInfo:l,proxyInfo:await Ob(u,l.uid)},s}async function vI(e,t,n,i){const r=Dy("UAP_AP").slice(0,Dy("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await rI(r,e,t,n,i)}async function yI(e,t,n){const i=Dy("UAP_AP").slice(0,Dy("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((i=>function(e,t,n,i){const r={command:"convergeAllocateEdge",sid:t.sid,appId:t.appId,token:t.token,ts:Date.now(),version:by,cname:t.cname,uid:t.uid.toString(),requestId:oI,seq:oI};oI+=1;const o={service_name:"tele_channel",json_body:JSON.stringify(r)};return XS((async()=>{const t=await Kb(e,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==t.code){const e=new VR(xg.UNEXPECTED_RESPONSE,"cross channel ap error, code"+t.code,{retry:!0});throw zy.error(e.toString()),e}const i=JSON.parse(t.json_body);if(200!==i.code){const e=new VR(xg.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(i.code,", reason: ").concat(i.reason));throw zy.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new VR(xg.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw zy.error(e.toString()),e}return{vid:i.vid,workerToken:i.workerToken,addressList:(Dy("CHANNEL_MEDIA_RELAY_SERVERS")||i.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(Dy("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==xg.OPERATION_ABORTED&&e.code!==xg.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),i)}(i,e,t,n)));try{const e=await fI(i);return i.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function RI(e,t,n){let i=null;const r=[],o=async o=>{const s=Dy(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return o&&(await US(1e3),null!==i)?i:await _I({fragementLength:Dy("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:i=>(zy.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),i),function(e,t,n,i){const[r]=hI(t,[fb.CHOOSE_SERVER]);let o=vS.networkState;return XS((async()=>{o&&vS.networkState===uS.OFFLINE&&vS.onlineWaiter&&await tg.race([vS.onlineWaiter,US(i&&i.maxRetryTimeout||qS.maxRetryTimeout)]),o=vS.networkState;const t=await Kb(e,{data:r,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return lI(t,e)}),(()=>!1),(e=>e.code!==xg.OPERATION_ABORTED&&(e.code===xg.UPDATE_TICKET_FAILED?e.data.retry:(zy.warning("[".concat(t.clientId,"] update ticket network error, retry"),e),!0))),i)}(i,e,t,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:r})};try{return i=await fI([o(!1),o(!0)]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),i}catch(e){throw e[0]}}function CI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function bI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CI(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CI(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class II extends nS{get isSuccess(){return!!this.configs}constructor(){super(),ih(this,"configs",void 0),ih(this,"joinInfo",void 0),ih(this,"cancelToken",void 0),ih(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),ih(this,"interval",void 0),ih(this,"mutex",new zS("config-distribute")),ih(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),Dy("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),Dy("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,oR.reportApiInvoke(null,{options:void 0,name:oS.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:sS.TRACER}).onSuccess(JSON.stringify(Py))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void zy.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const t=await this.mutex.lock();try{e=await SI(this.joinInfo,this.cancelToken,this.retryConfig),zy.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const t=new VR(xg.NETWORK_RESPONSE_ERROR,e);zy.warning("[config-distribute] ".concat(t.toString()))}finally{t()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(lC.UPDATE_BITRATE_LIMIT,e):this.emit(lC.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&bI({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var t;const n=Zh(t=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e)))).call(t);for(let r=0;r<n.length;r++)for(let t=n.length-1;t>r;t--){const i=n[t];if("number"==typeof e[i].__priority){const r=e[i].__priority,o=n[t-1];if("number"==typeof e[o].__priority){if(!(r>e[o].__priority))continue;{const e=i;n[t]=n[t-1],n[t-1]=e}}else{const e=i;n[t]=n[t-1],n[t-1]=e}}}const i={};n.forEach((t=>{const n=e[t],r=n.__expires;Object.keys(n).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(i,e)||(i[e]=bI({value:n[e]},r&&{expires:r}))}))}));try{!function(e){try{const t=Date.now();Object.keys(e).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(Oy,n)){const{value:i,expires:r}=e[n];if(r&&r<=t)return;Py[n]=i,Oy[n]=i,zy.debug("Update global parameters from config distribute",n,i)}}}))}catch(t){zy.error("Error update config immediately: ".concat(e),t.message)}}(i);const e=JSON.stringify(i),t=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",t),zy.debug("Caching global parameters ".concat(e))}catch(e){zy.error("Error caching global parameters:",e.message)}}}const wI={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function AI(){return wI}var OI;function NI(e,t,n){return{sampleRate:e,stereo:t,bitrate:n}}function DI(e,t,n,i,r){return{width:e,height:t,frameRate:n,bitrateMin:i,bitrateMax:r}}function PI(e,t,n,i,r){return{width:{max:e},height:{max:t},frameRate:n,bitrateMin:i,bitrateMax:r}}function kI(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}!function(e){e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change"}(OI||(OI={}));const LI={"90p":DI(160,90),"90p_1":DI(160,90),"120p":DI(160,120,15,30,65),"120p_1":DI(160,120,15,30,65),"120p_3":DI(120,120,15,30,50),"120p_4":DI(212,120),"180p":DI(320,180,15,30,140),"180p_1":DI(320,180,15,30,140),"180p_3":DI(180,180,15,30,100),"180p_4":DI(240,180,15,30,120),"240p":DI(320,240,15,40,200),"240p_1":DI(320,240,15,40,200),"240p_3":DI(240,240,15,40,140),"240p_4":DI(424,240,15,40,220),"360p":DI(640,360,15,80,400),"360p_1":DI(640,360,15,80,400),"360p_3":DI(360,360,15,80,260),"360p_4":DI(640,360,30,80,600),"360p_6":DI(360,360,30,80,400),"360p_7":DI(480,360,15,80,320),"360p_8":DI(480,360,30,80,490),"360p_9":DI(640,360,15,80,800),"360p_10":DI(640,360,24,80,800),"360p_11":DI(640,360,24,80,1e3),"480p":DI(640,480,15,100,500),"480p_1":DI(640,480,15,100,500),"480p_2":DI(640,480,30,100,1e3),"480p_3":DI(480,480,15,100,400),"480p_4":DI(640,480,30,100,750),"480p_6":DI(480,480,30,100,600),"480p_8":DI(848,480,15,100,610),"480p_9":DI(848,480,30,100,930),"480p_10":DI(640,480,10,100,400),"720p":DI(1280,720,15,120,1130),"720p_auto":DI(1280,720,30,900,3e3),"720p_1":DI(1280,720,15,120,1130),"720p_2":DI(1280,720,30,120,2e3),"720p_3":DI(1280,720,30,120,1710),"720p_5":DI(960,720,15,120,910),"720p_6":DI(960,720,30,120,1380),"1080p":DI(1920,1080,15,120,2080),"1080p_1":DI(1920,1080,15,120,2080),"1080p_2":DI(1920,1080,30,120,3e3),"1080p_3":DI(1920,1080,30,120,3150),"1080p_5":DI(1920,1080,60,120,4780),"1440p":DI(2560,1440,30,120,4850),"1440p_1":DI(2560,1440,30,120,4850),"1440p_2":DI(2560,1440,60,120,7350),"4k":DI(3840,2160,30,120,8910),"4k_1":DI(3840,2160,30,120,8910),"4k_3":DI(3840,2160,60,120,13500)},MI=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],UI={"480p":PI(640,480,5),"480p_1":PI(640,480,5),"480p_2":PI(640,480,30),"480p_3":PI(640,480,15),"720p":PI(1280,720,5),"720p_auto":DI(1280,720,30,900,3e3),"720p_1":PI(1280,720,5),"720p_2":PI(1280,720,30),"720p_3":PI(1280,720,15),"1080p":PI(1920,1080,5),"1080p_1":PI(1920,1080,5),"1080p_2":PI(1920,1080,30),"1080p_3":PI(1920,1080,15)},xI={"1SL1TL":kI(1,1),"3SL3TL":kI(3,3),"2SL3TL":kI(2,3)};function VI(e){return e||(e="480p_1"),"string"==typeof e?Object.assign({},LI[e]):e}function FI(e){return"string"==typeof e?Object.assign({},UI[e]):e}function jI(e){return"string"==typeof e?Object.assign({},xI[e]):e}const BI={speech_low_quality:NI(16e3,!1),speech_standard:NI(32e3,!1,18),music_standard:NI(48e3,!1),standard_stereo:NI(48e3,!0,56),high_quality:NI(48e3,!1,128),high_quality_stereo:NI(48e3,!0,192)};function GI(e){return"string"==typeof e?Object.assign({},BI[e]):e}const WI=[];function HI(e){return jg(e,"mediaSource",["screen","window","application"]),!0}var KI,zI,YI,qI,JI,XI,QI,ZI,$I,ew;!function(e){e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track"}(KI||(KI={})),function(e){e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream"}(zI||(zI={})),function(e){e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM"}(YI||(YI={})),function(e){e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM"}(qI||(qI={})),function(e){e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY"}(JI||(JI={})),function(e){e.TRANSCEIVER_UPDATED="transceiver-updated"}(XI||(XI={})),function(e){e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed"}(QI||(QI={})),function(e){e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(ZI||(ZI={})),function(e){e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source"}($I||($I={})),function(e){e.UPDATE_TRACK_SOURCE="update-track-source"}(ew||(ew={}));const tw={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},nw={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},iw={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},rw={uplinkNetworkQuality:0,downlinkNetworkQuality:0},ow={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var sw,aw,cw,dw,lw;!function(e){e.ON_TRACK="on_track",e.ON_NODE="on_node"}(sw||(sw={})),function(e){e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints"}(aw||(aw={})),function(e){e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND"}(cw||(cw={})),function(e){e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(dw||(dw={})),function(e){e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata"}(lw||(lw={}));const uw={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var hw;!function(e){e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error"}(hw||(hw={}));class pw extends nS{constructor(e,t){super(),ih(this,"_ID",void 0),ih(this,"_rtpTransceiver",void 0),ih(this,"_lowRtpTransceiver",void 0),ih(this,"_hints",[]),ih(this,"_isClosed",!1),ih(this,"_originMediaStreamTrack",void 0),ih(this,"_mediaStreamTrack",void 0),ih(this,"_external",{}),this._ID=t||xS(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(e){Ai(WI).call(WI,e)||WI.push(e)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){const e=oR.reportApiInvoke(null,{name:oS.GET_MEDIA_STREAM_TRACK,options:[],tag:sS.TRACER});this._mediaStreamTrack&&"string"==typeof this._mediaStreamTrack.label?e.onSuccess(this._mediaStreamTrack.label):e.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===YI.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const t=WI.indexOf(e);-1!==t&&WI.splice(t,1)}(this),this.emit(QI.CLOSED)}_updateRtpTransceiver(e,t){if(t===YI.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(XI.TRANSCEIVER_UPDATED,e,t)}}class fw extends pw{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}constructor(e,t){super(e,t),ih(this,"_enabled",!0),ih(this,"_muted",!1),ih(this,"_isExternalTrack",!1),ih(this,"_isClosed",!1),ih(this,"_enabledMutex",void 0),ih(this,"processor",void 0),ih(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new zS("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,t;return null!==(e=null===(t=this._originMediaStreamTrack)||void 0===t?void 0:t.label)&&void 0!==e?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,zy.debug("[".concat(this.getTrackId(),"] close")),this.emit(KI.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=n,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await gS(this,KI.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){zy.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(QI.TRACK_ENDED)}stateCheck(e,t){if(zy.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(t,"]")),Fg(t,e),this._enabled&&this._muted&&"enabled"===e&&!1===t)throw new Vg(xg.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",zy);if(!this._enabled&&!this._muted&&"muted"===e&&!0===t)throw new Vg(xg.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",zy)}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function _w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const mw=window.AudioContext||window.webkitAudioContext;let Ew=null;const gw=new class extends nS{constructor(){super(...arguments),ih(this,"prevState",void 0),ih(this,"curState",void 0),ih(this,"currentTime",void 0),ih(this,"currentTimeStuckAt",void 0),ih(this,"interruptDetectorTrack",void 0),ih(this,"onLocalAudioTrackMute",(()=>{zy.info("ios15-interruption-start"),this.emit(OI.IOS_15_16_INTERRUPTION_START)})),ih(this,"onLocalAudioTrackUnmute",(async()=>{zy.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?zy.info("ios15-interruption-end-canceled"):(Ew&&await Ew.suspend(),this.emit(OI.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(e){zy.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){zy.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Sw(){if(!mw)return void zy.error("your browser is not support web audio");zy.info("create audio context");const e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_w(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},Dy("WEBAUDIO_INIT_OPTIONS"));zy.debug("audio context init option:",JSON.stringify(e)),Ew=new mw(e),gw.curState=Ew.state,Ew.onstatechange=()=>{gw.prevState=gw.curState,gw.curState=Ew?Ew.state:void 0;const{prevState:e,curState:t}=gw,n="running"===t,i="interrupted"===t,r="running"===e,o="suspended"===e,s="interrupted"===e,a=pg().osVersion;(yg()||Dg())&&r&&i&&(zy.info("ios".concat(a,"-interruption-start")),gw.emit(OI.IOS_INTERRUPTION_START)),(yg()||Dg())&&(o||s)&&n&&(zy.info("ios".concat(a,"-interruption-end")),gw.emit(OI.IOS_INTERRUPTION_END)),e!==t&&gw.emit(OI.STATE_CHANGE,t,e)},setInterval((()=>{var e;const t=null===(e=Ew)||void 0===e?void 0:e.currentTime;gw.currentTime!==t?(gw.currentTimeStuckAt&&(zy.debug("AudioContext current time resume at ".concat(t)),gw.currentTimeStuckAt=void 0),gw.currentTime=t):(t!==gw.currentTimeStuckAt&&(oR.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:t},tag:sS.TRACER}).onSuccess(),zy.warning("AudioContext current time stuck at ".concat(t))),gw.currentTimeStuckAt=t)}),5e3),async function(e){const t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let n,i=!1,r=!1,o=!1;function s(t){"running"===e.state?a(!1):yg()||Dg()?"suspended"===e.state&&(a(!0),t&&e.resume().then(d,d)):"closed"!==e.state&&(a(!0),t&&e.resume().then(d,d))}function a(e){if(i!==e){i=e;for(let n=0,i=t;n<i.length;n+=1){const t=i[n];e?window.addEventListener(t,l,{capture:!0,passive:!0}):window.removeEventListener(t,l,{capture:!0,passive:!0})}}}function c(){s(!0)}function d(){s(!1)}function l(){s(!0)}function u(e){if(!o)if(n.paused)if(e){let t;h(!1),o=!0;try{t=n.play(),t?t.then(p,p):(n.addEventListener("playing",p),n.addEventListener("abort",p),n.addEventListener("error",p))}catch(e){p()}}else h(!0);else h(!1)}function h(e){if(r!==e){r=e;for(let n=0,i=t;n<i.length;n++){const t=i[n];e?window.addEventListener(t,f,{capture:!0,passive:!0}):window.removeEventListener(t,f,{capture:!0,passive:!0})}}}function p(){n.removeEventListener("playing",p),n.removeEventListener("abort",p),n.removeEventListener("error",p),o=!1,u(!1)}function f(){u(!0)}if(yg()){const t=e.createMediaStreamDestination(),i=document.createElement("div");i.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=i.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=t.stream,u(!0)}gw.on(OI.STATE_CHANGE,c),s(!1)}(Ew)}function Tw(){if(!Ew){if(Sw(),!Ew)throw new Vg(xg.NOT_SUPPORTED,"can not create audio context");return Ew}return Ew}function vw(){return!!Ew}function yw(e){if(function(){if(null!==Rw)return Rw;const e=Tw(),t=e.createBufferSource(),n=e.createGain(),i=e.createGain();t.connect(n),t.connect(i),t.disconnect(n);let r=!1;try{t.disconnect(n)}catch(e){r=!0}return t.disconnect(),Rw=r,r}())return;const t=e.connect,n=e.disconnect;e.connect=(n,i,r)=>{var o;return e._inputNodes||(e._inputNodes=[]),Ai(o=e._inputNodes).call(o,n)||(n instanceof AudioNode?(e._inputNodes.push(n),t.call(e,n,i,r)):t.call(e,n,i)),e},e.disconnect=(i,r,o)=>{n.call(e),i?CS(e._inputNodes,i):e._inputNodes=[];for(const n of e._inputNodes)t.call(e,n)}}let Rw=null;function Cw(e,t){let n=!1;const i=1/t;if(Dy("DISABLE_WEBAUDIO")){const t=window.setInterval((()=>{n?window.clearInterval(t):e(performance.now()/1e3)}),1e3*i)}else{const t=Tw();let r=t.createGain();r.gain.value=0,r.connect(t.destination);const o=()=>{if(n)return void(r=null);const s=t.createOscillator();s.onended=o,s.connect(r),s.start(0),s.stop(t.currentTime+i),e(t.currentTime)};o()}return()=>{n=!0}}class bw{constructor(){ih(this,"context",void 0),ih(this,"analyserNode",void 0),ih(this,"sourceNode",void 0),this.context=Tw(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(e){}this.sourceNode=e,null==e||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||yg()||Dg()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const t=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(t);for(let n=0;n<e.length;++n)e[n]=t[n]/128-1}const t=cT(e).call(e,((e,t)=>e+t*t),0)/e.length;return Math.max(10*Math.log10(t)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,t;null===(e=this.sourceNode)||void 0===e||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(t=this.sourceNode)||void 0===t||t.connect(this.analyserNode)}catch(e){zy.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class Iw extends nS{get processSourceNode(){return this.sourceNode}set processedNode(e){var t;if(!this.isDestroyed&&this._processedNode!==e){try{var n;null===(n=this.sourceNode)||void 0===n||n.disconnect(this.outputNode)}catch(e){}null===(t=this._processedNode)||void 0===t||t.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),ih(this,"outputNode",void 0),ih(this,"outputTrack",void 0),ih(this,"isPlayed",!1),ih(this,"context",void 0),ih(this,"audioBufferNode",void 0),ih(this,"destNode",void 0),ih(this,"audioOutputLevel",0),ih(this,"volumeLevelAnalyser",void 0),ih(this,"_processedNode",void 0),ih(this,"playNode",void 0),ih(this,"isDestroyed",!1),ih(this,"onNoAudioInput",void 0),ih(this,"isNoAudioInput",!1),ih(this,"_noAudioInputCount",0),this.context=Tw(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),yw(this.outputNode),this.volumeLevelAnalyser=new bw}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=e=>{this.emit($I.ON_AUDIO_BUFFER,function(e){for(let t=0;t<e.outputBuffer.numberOfChannels;t+=1){const n=e.outputBuffer.getChannelData(t);for(let e=0;e<n.length;e+=1)n[e]=0}return e.inputBuffer}(e))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!AI().webAudioMediaStreamDest)throw new Vg(xg.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){"running"!==this.context.state&&IS((()=>{gw.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(e){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;yg()||Dg()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const t=this.volumeLevelAnalyser.getAnalyserNode();let n;t.getFloatTimeDomainData?(n=new Float32Array(t.fftSize),t.getFloatTimeDomainData(n)):(n=new Uint8Array(t.fftSize),t.getByteTimeDomainData(n));let i=!1;for(let r=0;r<n.length;r++)0!==n[r]&&(i=!0);return i?(this.isNoAudioInput=!1,!0):(await US(200),await this.checkHasAudioInput(e?e+1:1)&&i)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,t;null===(e=this.processedNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?null===(e=this.processedNode)||void 0===e||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class ww extends Iw{get isFreeze(){return!1}constructor(e,t,n){var i;if(super(),ih(this,"sourceNode",void 0),ih(this,"track",void 0),ih(this,"clonedTrack",void 0),ih(this,"audioElement",void 0),ih(this,"isCurrentTrackCloned",!1),ih(this,"isRemoteTrack",!1),ih(this,"originVolumeLevelAnalyser",void 0),ih(this,"rebuildWebAudio",(async()=>{if(zy.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void zy.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>zy.info("resume success"))),zy.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const e=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?e.stop():this.isCurrentTrackCloned=!0;const t=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(t),yw(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const n=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(n,this.context.currentTime),yw(this.outputNode),this.emit($I.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=t,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),"audio"!==e.kind)throw new Vg(xg.UNEXPECTED_ERROR);this.track=e;const r=new MediaStream([this.track]);if(this.isRemoteTrack=!!t,this.sourceNode=this.context.createMediaStreamSource(r),yw(this.sourceNode),n){const e=n.clone();e.enabled=!0,this.clonedTrack=e,zy.debug("create an unmuted track ".concat(e.id," from the original track ").concat(n.id," to get the volume"));const t=this.context.createMediaStreamSource(new MediaStream([e]));yw(t),this.originVolumeLevelAnalyser=new bw,this.originVolumeLevelAnalyser.updateSource(t)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=r;const o=pg();t&&o.os===ag.IOS&&Number(null===(i=o.osVersion)||void 0===i?void 0:i.split(".")[0])<15&&(gw.on(OI.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((e=>{e||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const t=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(t),yw(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit($I.UPDATE_SOURCE),this.audioElement.srcObject=t}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),gw.off("state-change",this.rebuildWebAudio),null===(e=this.originVolumeLevelAnalyser)||void 0===e||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const t=e.clone();t.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=t),zy.debug("create an unmuted track ".concat(t.id," from the original track ").concat(e.id," to get the volume"));const n=this.context.createMediaStreamSource(new MediaStream([t]));yw(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function Aw(e,t,n){const i=(e,t)=>e?"number"!=typeof e?e.max||e.exact||e.ideal||e.min||t:e:t,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&"number"!=typeof t.frameRate?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):"number"==typeof t.frameRate&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function Ow(e,t){const n=await Nw(e.mediaSource),{sourceId:i,audio:r}=await function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new tg(((n,i)=>{const r=document.createElement("div");r.innerText="share screen",r.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const o=document.createElement("div");o.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const s=document.createElement("div");s.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",s.setAttribute("style","height: 12%;");const a=document.createElement("div");a.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const c=document.createElement("div");c.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const d=document.createElement("button");d.innerHTML="cancel",d.setAttribute("style","width: 85px;"),d.onclick=()=>{document.body.removeChild(h);const e=new Error("NotAllowedError");e.name="NotAllowedError",i(e)};let l=t;const u=document.createElement("div");if(t){const e=document.createElement("input");e.setAttribute("type","checkbox");const t=document.createElement("span");e.setAttribute("style","margin-right: 6px;"),t.innerText="Share audio",e.checked=l,e.onchange=()=>{l=e.checked},u.appendChild(e),u.appendChild(t)}c.appendChild(u),c.appendChild(d),o.appendChild(s),o.appendChild(a),o.appendChild(c);const h=document.createElement("div");h.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),h.appendChild(r),h.appendChild(o),document.body.appendChild(h),e.map((e=>{if(e.id){const t=document.createElement("div");t.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let i=e.thumbnail;try{const{width:e}=i.getSize();e>1920&&(i=i.resize({width:1920}))}catch(e){throw e&&e.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),e}t.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+i.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+e.name.replace(/[\u00A0-\u9999<>\&]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))+"</span>",t.onclick=()=>{document.body.removeChild(h),n({sourceId:e.id,audio:l})},a.appendChild(t)}}))}))}(n,t);return await Aw(i,e,r)}async function Nw(e){let t=["window","screen"];"application"!==e&&"window"!==e||(t=["window"]),"screen"===e&&(t=["screen"]);const n=rS();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new Vg(xg.ELECTRON_IS_NULL);let i=null;try{var r;i=(null===(r=n.desktopCapturer)||void 0===r?void 0:r.getSources({types:t}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch(e){i=null}i&&i.then||(i=new tg(((e,i)=>{n.desktopCapturer.getSources({types:t},((t,n)=>{t?i(t):e(n)}))})));try{return await i}catch(e){throw new Vg(xg.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,e.toString())}}function Dw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const Pw=new zS("safari");let kw=!1,Lw=!1;async function Mw(e,t){let n=0,i=null;for(;n<2;)try{i=await Uw(e,t,n>0);break}catch(e){if(e instanceof Vg)throw zy.error("[".concat(t,"] ").concat(e.toString())),e;const i=xw(e.name||e.code||e,e.message);if(i.code===xg.MEDIA_OPTION_INVALID){zy.debug("[".concat(t,"] detect media option invalid, retry")),n+=1,await US(500);continue}throw zy.error("[".concat(t,"] ").concat(i.toString())),i}if(!i)throw new Vg(xg.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function Uw(e,t,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Vg(xg.NOT_SUPPORTED,"can not find getUserMedia");n&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const i=AI(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return zy.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(rS())e.screen.sourceId?Vw(r,await Aw(e.screen.sourceId,e.screen,e.screenAudio)):Vw(r,await Ow(e.screen,e.screenAudio));else if(Sg()&&e.screen.extensionId&&e.screen.mandatory){if(!i.getStreamFromExtension)throw new Vg(xg.NOT_SUPPORTED,"This browser does not support screen sharing");zy.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const n=await(s=e.screen.extensionId,a=t,new tg(((e,t)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},(n=>{if(!n||!n.streamId)return zy.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),n),void t(new Vg(xg.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));e(n.streamId)}))}catch(e){zy.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),e.toString()),t(new Vg(xg.CHROME_PLUGIN_NOT_INSTALL))}})));e.screen.mandatory.chromeMediaSourceId=n,Vw(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(i.getDisplayMedia){var o;e.screen.mediaSource&&HI(e.screen.mediaSource);const n={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:null!==(o=e.screen.displaySurface)&&void 0!==o?o:"screen"===e.screen.mediaSource?"monitor":e.screen.mediaSource},{selfBrowserSurface:i,surfaceSwitching:s,systemAudio:a}=e.screen,c={selfBrowserSurface:i,surfaceSwitching:s,systemAudio:a};!i&&delete c.selfBrowserSurface,!s&&delete c.surfaceSwitching,!a&&delete c.systemAudio,zy.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:n,audio:!!e.screenAudio,controls:c}));const d=await navigator.mediaDevices.getDisplayMedia(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Dw(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Dw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({video:n,audio:!!e.screenAudio},c));Vw(r,d)}else{if(!vg())throw zy.error("[".concat(t,"] This browser does not support screenSharing")),new Vg(xg.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&HI(e.screen.mediaSource);const n={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};zy.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(n))),Vw(r,await navigator.mediaDevices.getUserMedia(n))}}var s,a;if(!e.video&&!e.audio)return r;let c={video:e.video,audio:e.audio},d=Dy("MEDIA_DEVICE_CONSTRAINTS");if(d)try{"string"==typeof d&&(d=JSON.parse(d)),c=WS(c,d)}catch(e){}zy.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),pg();let l,u=null;(Tg()||yg()||mg())&&(u=await Pw.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(e){throw u&&u(),e}return c.audio&&(kw=!0),c.video&&(Lw=!0),Vw(r,l),u&&u(),r}function xw(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new Vg(xg.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new Vg(xg.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new Vg(xg.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new Vg(xg.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new Vg(xg.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new Vg(xg.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return zy.error("getUserMedia unexpected error",e),new Vg(xg.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function Vw(e,t){const n=e.getVideoTracks()[0],i=e.getAudioTracks()[0],r=t.getVideoTracks()[0],o=t.getAudioTracks()[0];o&&(i&&e.removeTrack(i),e.addTrack(o)),r&&(n&&e.removeTrack(n),e.addTrack(r))}const Fw=new class extends nS{get state(){return this._state}set state(e){e!==this._state&&(this.emit(dw.STATE_CHANGE,e),this._state=e)}constructor(){super(),ih(this,"_state",cw.IDLE),ih(this,"isAccessMicrophonePermission",!1),ih(this,"isAccessCameraPermission",!1),ih(this,"lastAccessMicrophonePermission",!1),ih(this,"lastAccessCameraPermission",!1),ih(this,"checkdeviceMatched",!1),ih(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(Dy("ENUMERATE_DEVICES_INTERVAL")||(Mg()||fg()===ag.HARMONY_OS)&&Lg())&&this.updateDevicesInfo()}),Dy("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((e=>zy.error(e.toString())))}async enumerateDevices(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new Vg(xg.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let o=!this.isAccessMicrophonePermission&&e,s=!this.isAccessCameraPermission&&t;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,d=null;if(!n&&(o||s)){if(Pw.isLocked&&(zy.debug("[device manager] wait GUM lock"),(await Pw.lock())(),zy.debug("[device manager] GUM unlock")),kw&&(o=!1,this.isAccessMicrophonePermission=!0),Lw&&(s=!1,this.isAccessCameraPermission=!0),zy.debug("[device manager] check media device permissions",e,t,o,s),o&&s){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){const t=xw(e.name||e.code||e,e.message);if(t.code===xg.PERMISSION_DENIED)throw t;zy.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:e})}catch(e){const t=xw(e.name||e.code||e,e.message);if(t.code===xg.PERMISSION_DENIED)throw t;zy.warning("getUserMedia failed in getDevices",t)}this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(e){const t=xw(e.name||e.code||e,e.message);if(t.code===xg.PERMISSION_DENIED)throw t;zy.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0}zy.debug("[device manager] mic permission",e,"cam permission",t)}try{const e=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),d&&d.getTracks().forEach((e=>e.stop())),a=null,c=null,d=null,e}catch(e){return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),d&&d.getTracks().forEach((e=>e.stop())),a=null,c=null,d=null,new Vg(xg.ENUMERATE_DEVICES_FAILED,e.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audioinput"===e.kind))}async getCamerasDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter((e=>"videoinput"===e.kind))}async getSpeakers(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audiooutput"===e.kind))}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach((n=>{n.device.label===e&&(t=n.device.deviceId)})),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find((t=>t.deviceId===e));if(!t)throw new Vg(xg.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=cw.INITING;try{await this.updateDevicesInfo(),this.state=cw.INITEND}catch(e){throw zy.warning("Device Detection functionality cannot start properly.",e.toString()),this.state=cw.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new Vg(xg.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),e}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),n=[];if(e[0]&&e[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const t=e.find((e=>"audioinput"===e.kind&&"default"===e.deviceId)),n=e.find((e=>"audiooutput"===e.kind&&"default"===e.deviceId));t&&n?n.groupId===t.groupId?zy.debug("[device-check] default input ".concat(t.label," and output ").concat(n.label," is the same group")):zy.warning("[device-check] default input ".concat(t.label," and output ").concat(n.label," is not the same group")):zy.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(e);if(e.forEach((e=>{if(!e.deviceId)return;const i=this.deviceInfoMap.get("".concat(e.kind,"_").concat(e.deviceId));if("ACTIVE"!==(i?i.state:"INACTIVE")){const i={initAt:t,updateAt:t,device:e,state:"ACTIVE"};this.deviceInfoMap.set("".concat(e.kind,"_").concat(e.deviceId),i),n.push(i)}i&&(i.updateAt=t)})),this.deviceInfoMap.forEach(((e,i)=>{"ACTIVE"===e.state&&e.updateAt!==t&&(e.state="INACTIVE",n.push(e))})),this.state!==cw.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach((e=>{switch(e.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(dw.RECORDING_DEVICE_CHANGED,e);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(dw.CAMERA_DEVICE_CHANGED,e);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(dw.PLAYOUT_DEVICE_CHANGED,e)}})),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter((e=>"audioinput"===e.kind)),n=e.filter((e=>"videoinput"===e.kind)),i={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}};let jw=!1;const Bw=new class extends nS{constructor(){super(...arguments),ih(this,"onAutoplayFailed",void 0),ih(this,"onAudioAutoplayFailed",void 0)}};function Gw(){if(pg(),!jw){const e=t=>{t.preventDefault(),jw=!1,Ug()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};jw=!0,Ug()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),zy.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Bw.onAutoplayFailed?Bw.onAutoplayFailed():Bw.onAudioAutoplayFailed?zy.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):zy.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),Bw.emit("autoplay-failed")}}function Ww(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Hw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ww(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ww(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Kw(e,t,n,i){if(!e)return;const r=oR.getBaseInfoBySessionId(e);if(!r)return;const o=r.info,s=Date.now(),a=Hw(Hw({},o),{},{vid:void 0===o.vid?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:Bw.onAutoplayFailed||Bw.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:t,trackId:i,extend:void 0});oR.send({type:Zy.AUTOPLAY_FAILED,data:a},!0)}const zw=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Yw=new class{constructor(){ih(this,"onAutoplayFailed",void 0),ih(this,"elementMap",new Map),ih(this,"elementStateMap",new Map),ih(this,"elementsNeedToResume",[]),ih(this,"sinkIdMap",new Map),ih(this,"autoResumeAfterInterruption",(e=>{Array.from(this.elementMap.entries()).forEach((t=>{let[n,i]=t;const r=this.elementStateMap.get(n),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(zy.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(e)),"live"===s){if(e)return i.pause(),void i.play();if("running"===gw.curState)return Ag()?(i.pause(),void i.play()):void(r&&"paused"===r&&i.play())}}))})),ih(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,n]=e;const i=n.srcObject.getAudioTracks()[0];i&&"live"===i.readyState&&(zy.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())}))})),this.autoResumeAudioElement(),gw.on(OI.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),gw.on(OI.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),gw.on(OI.STATE_CHANGE,(()=>{yg()&&"suspended"===gw.prevState&&"running"===gw.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(e,t){const n=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),n)try{await n.setSinkId(t)}catch(e){throw new Vg(xg.PERMISSION_DENIED,"can not set sink id: "+e.toString())}}play(e,t,n,i){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,lw.INIT),this.setVolume(t,n);const o=this.sinkIdMap.get(t);if(o)try{r.setSinkId(o).catch((e=>{zy.warning("[".concat(t,"] set sink id failed"),e.toString())}))}catch(e){zy.warning("[".concat(t,"] set sink id failed"),e.toString())}const s=r.play();s&&s.then&&s.catch((e=>{i&&Kw(i,"audio",e.message,t),zy.warning("audio element play warning",e.toString()),this.elementMap.has(t)&&"NotAllowedError"===e.name&&(zy.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),IS((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Gw()})))}))}updateTrack(e,t){const n=this.elementMap.get(e);n&&(n.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&"playing"===this.elementStateMap.get(e)}setVolume(e,t){const n=this.elementMap.get(e);n&&(t=Math.max(0,Math.min(100,t)),n.volume=t/100)}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const n=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(n,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){zw.forEach((n=>{t.addEventListener(n,(n=>{const i=this.elementStateMap.get(e),r="pause"===n.type?"paused":n.type;if(zy.debug("[".concat(e,"] audio-element-status change ").concat(i," => ").concat(r)),"error"===n.type){const n=null==t?void 0:t.error;n&&zy.error("[".concat(e,"] media error, code: ").concat(n.code,", message: ").concat(n.message))}this.elementStateMap.set(e,r)}))}))}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((e=>{e.play().then((e=>{zy.debug("Auto resume audio element success")})).catch((e=>{zy.warning("Auto resume audio element failed!",e)}))})),this.elementsNeedToResume=[]};new tg((e=>{document.body?e():window.addEventListener("load",(()=>e()))})).then((()=>{Ug()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function qw(){return function(e,t,n){const i=n.value;return"function"==typeof i&&(n.value=function(){this._isClosed&&new Vg(xg.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",zy);for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=i.apply(this,t);return r instanceof tg?new tg(((e,t)=>{r.then(e).catch(t)})):r}),n}}function Jw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Xw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Jw(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Jw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Qw extends nS{constructor(e){super(),ih(this,"name","VideoProcessorDestination"),ih(this,"ID","0"),ih(this,"_source",void 0),ih(this,"videoContext",void 0),ih(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new Vg(xg.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new Vg(xg.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(sw.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(sw.ON_TRACK,void 0)}}class Zw extends nS{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t){super(),ih(this,"constraintsMap",new Map),ih(this,"statsRegistry",[]),ih(this,"usageRegistry",[]),ih(this,"trackId",void 0),ih(this,"direction",void 0),ih(this,"_chained",!1),this.trackId=e,this.direction=t}async getConstraints(){return await ES(this,aw.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,t){var n;return zy.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),gS(this,aw.REQUEST_UPDATE_CONSTRAINTS,Array.from(MR(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return zy.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),gS(this,aw.REQUEST_UPDATE_CONSTRAINTS,Array.from(MR(t=this.constraintsMap).call(t)))}registerStats(e,t,n){this.statsRegistry.find((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:n})}unregisterStats(e,t){const n=this.statsRegistry.findIndex((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t));-1!==n&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:n,type:i,cb:r}of this.statsRegistry)try{const o=r();e.push({processorID:t,processorName:n,type:i,stats:o})}catch(e){zy.error(new Vg(xg.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let n=t();n instanceof tg&&(n=await n),e.push(Xw(Xw({},n),{},{direction:this.direction}))}catch(e){zy.error("gather extension usage error",e)}return e}getDirection(){return this.direction}}class $w extends nS{constructor(e){super(),ih(this,"name","AudioProcessorDestination"),ih(this,"ID","0"),ih(this,"inputTrack",void 0),ih(this,"inputNode",void 0),ih(this,"audioProcessorContext",void 0),ih(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new Vg(xg.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new Vg(xg.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(sw.ON_TRACK,void 0),this.emit(sw.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(sw.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(sw.ON_NODE,this.inputNode))}}class eA extends nS{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t,n){super(),ih(this,"constraintsMap",new Map),ih(this,"statsRegistry",[]),ih(this,"audioContext",void 0),ih(this,"trackId",void 0),ih(this,"direction",void 0),ih(this,"usageRegistry",[]),ih(this,"_chained",!1),this.audioContext=e,this.trackId=t,this.direction=n}async getConstraints(){return ES(this,aw.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,t){var n;return zy.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),gS(this,aw.REQUEST_UPDATE_CONSTRAINTS,Array.from(MR(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),gS(this,aw.REQUEST_UPDATE_CONSTRAINTS,Array.from(MR(t=this.constraintsMap).call(t)))}registerStats(e,t,n){this.statsRegistry.find((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:n})}unregisterStats(e,t){const n=this.statsRegistry.findIndex((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t));-1!==n&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:n,type:i,cb:r}of this.statsRegistry)try{const o=r();e.push({processorID:t,processorName:n,type:i,stats:o})}catch(e){zy.error(new Vg(xg.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let n=t();n instanceof tg&&(n=await n),e.push(Xw(Xw({},n),{},{direction:this.direction}))}catch(e){zy.error("gather extension usage error",e)}return e}getDirection(){return this.direction}}class tA extends nS{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),ih(this,"context",void 0),ih(this,"processSourceNode",void 0),ih(this,"outputTrack",void 0),ih(this,"processedNode",void 0),ih(this,"clonedTrack",void 0),ih(this,"outputNode",void 0),this.outputNode=new nA}setVolume(){}createOutputTrack(){throw new Vg(xg.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class nA{disconnect(){}connect(){}}let iA=null;class rA{constructor(){ih(this,"state","open"),ih(this,"trigger",void 0),ih(this,"tasks",[]),zy.debug("[macro-task-queue] is created."),this.trigger=window.setTimeout((()=>{this.state="closed",zy.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map((e=>e.key)),"]")),this.trigger=void 0,this.tasks.forEach((e=>{let{func:t}=e;return t()})),this.tasks.length=0,zy.debug("[macro-task-queue] is closed.")}))}enqueue(e,t){"closed"!==this.state&&(this.tasks.push({key:e,func:t}),zy.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof e?e:"")))}runTask(e){if("closed"===this.state)return;const t=this.tasks.findIndex((t=>t.key===e));if(-1!==t){const n=this.tasks.splice(t,1);zy.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof e?e:"")),n[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,zy.debug("[macro-task-queue] is closed."))}}function oA(e){return function(t,n,i){var r;const o=null!==(r=i.value)&&void 0!==r?r:i.get,s=function(){iA&&"open"===iA.state&&iA.runTask(e);for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return null==o?void 0:o.apply(this,...n)};return i.value?i.value=s:i.get=s,i}}function sA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function aA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sA(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class cA extends fw{get _source(){return this._trackSource}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get processorDestination(){return this._processorDestination}set processorDestination(e){this._processorDestination=e}get isPlaying(){return this._useAudioElement?Yw.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,n,i,r){super(e,n),ih(this,"trackMediaType","audio"),ih(this,"_encoderConfig",void 0),ih(this,"_trackSource",void 0),ih(this,"_enabled",!0),ih(this,"_volume",100),ih(this,"_useAudioElement",!1),ih(this,"_bypassWebAudio",!1),ih(this,"processor",void 0),ih(this,"_processorContext",void 0),ih(this,"_processorDestination",void 0),ih(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!i;const o=()=>{this.processorContext=new eA(this._source.context,this.getTrackId(),"local"),this.processorDestination=new $w(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on($I.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))},s=r&&Tg()&&!vw();Dy("DISABLE_WEBAUDIO")?(this._source=new tA,this._useAudioElement=!0,this._bypassWebAudio=!0):s?this._source=new tA:(this._source=new ww(e,!1,this._getOriginVolumeLevel?e:void 0),Dy("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),o(),!Dy("DISABLE_WEBAUDIO")&&s&&(iA||(iA=new rA),iA).enqueue("INIT_WEBAUDIO",(()=>{this._source=new ww(e,!1,this._getOriginVolumeLevel?e:void 0),Dy("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),o(),this.emit(ew.UPDATE_TRACK_SOURCE)}))}setVolume(e){Bg(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Yw.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void zy.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,gS(this,KI.NEED_REPLACE_TRACK,this).then((()=>{zy.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((e=>{zy.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),e)})))}catch(e){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!Sg()&&Dy("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new Vg(xg.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Yw.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,n){return this._setEnabled(e,t,n)}async _setEnabled(e,t,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(zy.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await gS(this,KI.NEED_ENABLE_TRACK,this),zy.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(e){throw n||(this._enabled=!1),zy.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await gS(this,KI.NEED_DISABLE_TRACK,this)}catch(e){throw n||(this._enabled=!0),zy.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,zy.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await gS(this,KI.NEED_MUTE_TRACK,this):await gS(this,KI.NEED_UNMUTE_TRACK,this))}getStats(){return NS((()=>{zy.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),SS(this,KI.GET_STATS)||aA({},tw)}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners($I.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners($I.ON_AUDIO_BUFFER),this._source.on($I.ON_AUDIO_BUFFER,(t=>e(t)))}play(){zy.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(zy.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Yw.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){zy.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Yw.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];zy.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Yw.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:e,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await gS(this,KI.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return tg.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new Vg(xg.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new Vg(xg.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(sw.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await gS(this,KI.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await gS(this,KI.NEED_REPLACE_TRACK,this))})),this.processorDestination.on(sw.ON_NODE,(e=>{this._source.processedNode=e}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(sw.ON_TRACK),this.processorDestination.removeAllListeners(sw.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(aw.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(aw.REQUEST_CONSTRAINTS)}}UR([oA("INIT_WEBAUDIO"),xR("design:type",Object),xR("design:paramtypes",[Object])],cA.prototype,"_source",null),UR([oA("INIT_WEBAUDIO"),xR("design:type",eA),xR("design:paramtypes",[eA])],cA.prototype,"processorContext",null),UR([oA("INIT_WEBAUDIO"),xR("design:type",$w),xR("design:paramtypes",[$w])],cA.prototype,"processorDestination",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),xR("design:type",Function),xR("design:paramtypes",[Number]),xR("design:returntype",void 0)],cA.prototype,"setVolume",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],cA.prototype,"setPlaybackDevice",null),UR([YS("LocalAudioTrack","_enabledMutex"),rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean,Object,Boolean]),xR("design:returntype",tg)],cA.prototype,"setEnabled",null),UR([YS("LocalAudioTrack","_enabledMutex"),rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean]),xR("design:returntype",tg)],cA.prototype,"setMuted",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",Object)],cA.prototype,"getStats",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[Object,Number]),xR("design:returntype",void 0)],cA.prototype,"setAudioFrameCallback",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],cA.prototype,"play",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],cA.prototype,"stop",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],cA.prototype,"close",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t.name]}),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",Object)],cA.prototype,"pipe",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],cA.prototype,"unpipe",null);class dA extends cA{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,n,i){super(e,t.encoderConfig?GI(t.encoderConfig):{},i,Dy("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),ih(this,"_config",void 0),ih(this,"_deviceName","default"),ih(this,"_constraints",void 0),ih(this,"_originalConstraints",void 0),ih(this,"_enabled",!0),this._config=t,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,"boolean"==typeof t.bypassWebAudio&&(this._bypassWebAudio=t.bypassWebAudio),(Ag()||Og())&&gw.bindInterruptDetectorTrack(this),this.on(ew.UPDATE_TRACK_SOURCE,(()=>{this.bindProcessorContextEvents()})),vw()&&this.bindProcessorContextEvents()}async setDevice(e){if(zy.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await Fw.getDeviceById(e),n={};n.audio=aA({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let i=null;try{i=await Mw(n,this.getTrackId())}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),i=await Mw({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await Fw.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}zy.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,n){if(t)return zy.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(zy.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(i=this._source.clonedTrack)||void 0===i||i.stop(),n||(this._enabled=!1);try{await gS(this,KI.NEED_DISABLE_TRACK,this)}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setEnabled false failed"),e.toString()),e}return}const r=aA({},this._constraints),o=Fw.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);const e=await Mw({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!1),await gS(this,KI.NEED_ENABLE_TRACK,this)}catch(e){throw n||(this._enabled=!1),zy.error("[".concat(this.getTrackId(),"] setEnabled true failed"),e.toString()),e}zy.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Ag()||Og())&&gw.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((yg()||Dg())&&this._enabled&&!this._isClosed&&gw.duringInterruption){const e=async()=>{gw.off(OI.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(zy.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};gw.on(OI.IOS_INTERRUPTION_END,e)}else zy.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(QI.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Fw.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId=n),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const e=await Mw({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(aw.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,n)=>{try{const n=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(n),t()}catch(e){n(e)}})),this.processorContext.on(aw.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}}UR([rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],dA.prototype,"setDevice",null),UR([YS("MicrophoneAudioTrack","_enabledMutex"),rR({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean,Boolean,Boolean]),xR("design:returntype",tg)],dA.prototype,"setEnabled",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],dA.prototype,"close",null);class lA extends cA{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,n,i){super(t.createOutputTrack(),n,i),ih(this,"source",void 0),ih(this,"_bufferSource",void 0),this.source=e,this._bufferSource=t,this._bufferSource.on($I.AUDIO_SOURCE_STATE_CHANGE,(e=>{this.safeEmit(QI.SOURCE_STATE_CHANGE,e)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){Bg(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}UR([rR({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",void 0)],lA.prototype,"startProcessAudioBuffer",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],lA.prototype,"pauseProcessAudioBuffer",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Number]),xR("design:returntype",void 0)],lA.prototype,"seekAudioBuffer",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],lA.prototype,"resumeProcessAudioBuffer",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],lA.prototype,"stopProcessAudioBuffer",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],lA.prototype,"close",null),UR([rR({argsMap:e=>[e.getTrackId()]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Number]),xR("design:returntype",void 0)],lA.prototype,"setAudioBufferPlaybackSpeed",null);class uA extends cA{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Tw().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,xS(8,"track-mix-")),ih(this,"trackList",void 0),ih(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return-1!==this.trackList.indexOf(e)}addAudioTrack(e){-1===this.trackList.indexOf(e)?(zy.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):zy.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(-1!==this.trackList.indexOf(e)){zy.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch(e){}CS(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach((t=>{t._encoderConfig&&((t._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=t._encoderConfig.bitrate),(t._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=t._encoderConfig.sampleRate),(t._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=t._encoderConfig.sampleSize),t._encoderConfig.stereo&&(e.stereo=!0))})),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach((t=>{t instanceof uA?t.emit(XI.TRANSCEIVER_UPDATED,e):t._updateRtpTransceiver(e)})))}}function hA(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const n=VI(e.encoderConfig);return null!=n.width&&(t.width=n.width),null!=n.height&&(t.height=n.height),!kg()&&n.frameRate&&(t.frameRate=n.frameRate),pg().name===cg.EDGE&&"object"==typeof t.frameRate&&(t.frameRate.max=60),vg()&&(t.frameRate={ideal:30,max:30}),t}function pA(e){const t={};if(kg()||(void 0!==e.AGC&&(t.autoGainControl=e.AGC),void 0!==e.AEC&&(t.echoCancellation=e.AEC),void 0!==e.ANS&&(t.noiseSuppression=e.ANS,Sg()&&e.ANS&&(t.googHighpassFilter=e.ANS))),e.encoderConfig){const n=GI(e.encoderConfig);t.channelCount=n.stereo?2:1,t.sampleRate=n.sampleRate,t.sampleSize=n.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),Mg()&&(t.sampleRate=void 0),t}class fA extends Iw{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit($I.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),ih(this,"audioBuffer",void 0),ih(this,"sourceNode",void 0),ih(this,"startPlayTime",0),ih(this,"startPlayOffset",0),ih(this,"pausePlayTime",0),ih(this,"options",void 0),ih(this,"currentLoopCount",0),ih(this,"currentPlaybackSpeed",100),ih(this,"_currentState","stopped"),this.audioBuffer=e,this.options=t,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){"stopped"===this.currentState?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):zy.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=e,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(e){}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const _A=new Map;async function mA(e,t){let n=null;if("string"==typeof e){const t=_A.get(e);if(t)return zy.debug("use cached audio resource: ",e),t;try{n=(await XS((()=>_y.get(e,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(e){throw new Vg(xg.FETCH_AUDIO_FILE_FAILED,e.toString())}}else{const t=new tg(((t,n)=>{const i=new FileReader;i.onload=e=>{e.target?t(e.target.result):n(new Vg(xg.READ_LOCAL_AUDIO_FILE_ERROR))},i.onerror=()=>{n(new Vg(xg.READ_LOCAL_AUDIO_FILE_ERROR))},i.readAsArrayBuffer(e)}));n=await t}const i=await function(e){const t=Tw();return new tg(((n,i)=>{t.decodeAudioData(e,(e=>{n(e)}),(e=>{i(new Vg(xg.DECODE_AUDIO_FILE_FAILED,e.toString()))}))}))}(n);return"string"==typeof e&&t&&_A.set(e,i),i}const EA=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new tg(((n,i)=>{t.toBlob((async e=>{if(t.remove(),e){const i=await gA(e);n({buffer:i,width:t.width,height:t.height})}else i(new Vg(xg.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,1)}))},gA=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)},SA=new class extends nS{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),ih(this,"_lastHiddenTime",0),ih(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),zy.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};function TA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function vA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?TA(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):TA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class yA{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(zy.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}constructor(e){ih(this,"trackId",void 0),ih(this,"config",void 0),ih(this,"onFirstVideoFrameDecoded",void 0),ih(this,"freezeTimeCounterList",[]),ih(this,"renderFreezeAccTime",0),ih(this,"isKeepLastFrame",!1),ih(this,"timeUpdatedCount",0),ih(this,"freezeTime",0),ih(this,"playbackTime",0),ih(this,"lastTimeUpdatedTime",0),ih(this,"autoplayFailed",!1),ih(this,"videoTrack",void 0),ih(this,"videoElement",void 0),ih(this,"cacheVideoElement",void 0),ih(this,"videoElementCheckInterval",void 0),ih(this,"_videoElementStatus",lw.NONE),ih(this,"isGettingVideoDimensions",!1),ih(this,"startGetVideoDimensions",(()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return zy.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()})),ih(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===gw.curState&&(zy.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(_g())),Ng()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),ih(this,"handleVideoEvents",(e=>{switch(e.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=lw.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(e){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=lw.CANPLAY;break;case"stalled":this.videoElementStatus=lw.STALLED;break;case"suspend":this.videoElementStatus=lw.SUSPEND;break;case"pause":this.videoElementStatus=lw.PAUSED,yg()||Dg()||Tg()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(zy.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=lw.WAITING;break;case"abort":this.videoElementStatus=lw.ABORT;break;case"ended":this.videoElementStatus=lw.ENDED;break;case"emptied":this.videoElementStatus=lw.EMPTIED;break;case"error":{this.videoElementStatus=lw.ERROR;const e=this.videoElement.error;e&&zy.error("[".concat(this.trackId,"] media error, code: ").concat(e.code,", message: ").concat(e.message));break}case"timeupdate":{const e=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=e);const t=e-this.lastTimeUpdatedTime,n=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=e,SA.lastVisibleTime<SA.lastHiddenTime||n<SA.lastHiddenTime||n<SA.lastVisibleTime)return;for(t>Dy("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=t),this.playbackTime+=t;this.playbackTime>=6e3;){this.playbackTime-=6e3;const e=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(e),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),ih(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(zy.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(_g())),Ng()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),gw.on(OI.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),gw.on(OI.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return null!==(e=this.videoElement.parentElement)&&void 0!==e?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const t=this.videoElement.play();t&&t.catch&&t.catch((t=>{e&&Kw(e,"video",t.message,this.trackId),"NotAllowedError"===t.name?(zy.warning("detected video element autoplay failed",t),this.autoplayFailed=!0,this.handleAutoPlayFailed()):zy.warning("[".concat(this.trackId,"] play warning: "),t)}));const n=pg();if(("Safari"===n.name&&15===Number(n.version)||Ag())&&t&&t.then){const e=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};t.then(e).catch(e)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const t=e.getContext("2d");if(!t)return zy.error("create canvas context failed!"),new ImageData(2,2);t.drawImage(this.videoElement,0,0,e.width,e.height);const n=t.getImageData(0,0,e.width,e.height);return e.remove(),n}async getCurrentFrameToUint8Array(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const i=n.getContext("2d");return i?(i.drawImage(this.videoElement,0,0,n.width,n.height),new tg(((i,r)=>{n.toBlob((async e=>{if(n.remove(),e){const t=await gA(e);i({buffer:t,width:n.width,height:n.height})}else r(new Vg(xg.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,t<0?.1:t>1?1:t)}))):await EA(e)}destroy(){gw.off(OI.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),gw.off(OI.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=lw.INIT,!this.videoElementCheckInterval&&(RA.forEach((e=>{this.videoElement.addEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(e){return e!==document.body&&document.body.contains(e)})(this.videoElement)||(this.videoElementStatus=lw.DESTROYED)}),1e3),Dy("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,t;let n;const i=(e,t)=>{if(this.videoElementStatus===lw.PLAYING){if(n){const e=t.presentationTime-n.presentationTime;e>Dy("VIDEO_FREEZE_DURATION")&&SA.lastVisibleTime>=SA.lastHiddenTime&&n.timestamp>SA.lastVisibleTime&&n.timestamp>SA.lastHiddenTime&&(this.renderFreezeAccTime+=e)}n=vA(vA({},t),{},{timestamp:e})}var r,o;Dy("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(r=(o=this.videoElement).requestVideoFrameCallback)||void 0===r||r.call(o,i))};null===(e=(t=this.videoElement).requestVideoFrameCallback)||void 0===e||e.call(t,i)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Mg()&&(this.videoElement.poster="noposter");const n=pg();"Safari"===n.name&&15===Number(n.version)||Ag()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,vg()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,vg()&&this.videoElement.load());const i=this.videoElement.play();void 0!==i&&i.catch((e=>{zy.debug("[".concat(this.trackId,"] playback interrupted"),e.toString())}))}resetVideoElement(){RA.forEach((e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=lw.NONE}handleAutoPlayFailed(){const e=t=>{t.preventDefault(),this.videoElement.play().then((()=>{zy.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((e=>{zy.error(e)})),this.autoplayFailed=!1,Ug()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};Ug()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Gw()}}const RA=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class CA extends yA{constructor(e){super(e),ih(this,"container",void 0),ih(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const t=e.element;t!==this.slot&&(this.destroy(),this.slot=t),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var t;null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,n):await EA(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(e){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",Dy("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if(null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(e){}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function bA(e){return new tg(((t,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const o=yg()?"canplay":"playing";r.addEventListener(o,(()=>{const e=r.videoWidth,n=r.videoHeight;!e&&vg()||(i=!0,r.srcObject=null,r.remove(),t([e,n]))})),r.srcObject=new MediaStream([e]),r.play().catch(FS),setTimeout((()=>{i||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))}),4e3)}))}const IA=async(e,t,n)=>{const i=function(e){const t=[];for(let n=0;n<e.length;n+=2)t.push(parseInt(e.slice(n,n+2),16));return Uint8Array.from(t)}(function(e){const t="0123456789abcdef";function n(e){let n,i="";for(n=0;n<=3;n++)i+=t.charAt(e>>8*n+4&15)+t.charAt(e>>8*n&15);return i}function i(e,t){const n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function r(e,t,n,r,o,s){return i(function(e,t){return e<<t|e>>>32-t}(i(i(t,e),i(r,s)),o),n)}function o(e,t,n,i,o,s,a){return r(t&n|~t&i,e,t,o,s,a)}function s(e,t,n,i,o,s,a){return r(t&i|n&~i,e,t,o,s,a)}function a(e,t,n,i,o,s,a){return r(t^n^i,e,t,o,s,a)}function c(e,t,n,i,o,s,a){return r(n^(t|~i),e,t,o,s,a)}const d=function(e){let t;const n=1+(e.length+8>>6),i=new Array(16*n);for(t=0;t<16*n;t++)i[t]=0;for(t=0;t<e.length;t++)i[t>>2]|=e.charCodeAt(t)<<t%4*8;return i[t>>2]|=128<<t%4*8,i[16*n-2]=8*e.length,i}(e);let l,u,h,p,f,_=1732584193,m=-271733879,E=-1732584194,g=271733878;for(l=0;l<d.length;l+=16)u=_,h=m,p=E,f=g,_=o(_,m,E,g,d[l+0],7,-680876936),g=o(g,_,m,E,d[l+1],12,-389564586),E=o(E,g,_,m,d[l+2],17,606105819),m=o(m,E,g,_,d[l+3],22,-1044525330),_=o(_,m,E,g,d[l+4],7,-176418897),g=o(g,_,m,E,d[l+5],12,1200080426),E=o(E,g,_,m,d[l+6],17,-1473231341),m=o(m,E,g,_,d[l+7],22,-45705983),_=o(_,m,E,g,d[l+8],7,1770035416),g=o(g,_,m,E,d[l+9],12,-1958414417),E=o(E,g,_,m,d[l+10],17,-42063),m=o(m,E,g,_,d[l+11],22,-1990404162),_=o(_,m,E,g,d[l+12],7,1804603682),g=o(g,_,m,E,d[l+13],12,-40341101),E=o(E,g,_,m,d[l+14],17,-1502002290),m=o(m,E,g,_,d[l+15],22,1236535329),_=s(_,m,E,g,d[l+1],5,-165796510),g=s(g,_,m,E,d[l+6],9,-1069501632),E=s(E,g,_,m,d[l+11],14,643717713),m=s(m,E,g,_,d[l+0],20,-373897302),_=s(_,m,E,g,d[l+5],5,-701558691),g=s(g,_,m,E,d[l+10],9,38016083),E=s(E,g,_,m,d[l+15],14,-660478335),m=s(m,E,g,_,d[l+4],20,-405537848),_=s(_,m,E,g,d[l+9],5,568446438),g=s(g,_,m,E,d[l+14],9,-1019803690),E=s(E,g,_,m,d[l+3],14,-187363961),m=s(m,E,g,_,d[l+8],20,1163531501),_=s(_,m,E,g,d[l+13],5,-1444681467),g=s(g,_,m,E,d[l+2],9,-51403784),E=s(E,g,_,m,d[l+7],14,1735328473),m=s(m,E,g,_,d[l+12],20,-1926607734),_=a(_,m,E,g,d[l+5],4,-378558),g=a(g,_,m,E,d[l+8],11,-2022574463),E=a(E,g,_,m,d[l+11],16,1839030562),m=a(m,E,g,_,d[l+14],23,-35309556),_=a(_,m,E,g,d[l+1],4,-1530992060),g=a(g,_,m,E,d[l+4],11,1272893353),E=a(E,g,_,m,d[l+7],16,-155497632),m=a(m,E,g,_,d[l+10],23,-1094730640),_=a(_,m,E,g,d[l+13],4,681279174),g=a(g,_,m,E,d[l+0],11,-358537222),E=a(E,g,_,m,d[l+3],16,-722521979),m=a(m,E,g,_,d[l+6],23,76029189),_=a(_,m,E,g,d[l+9],4,-640364487),g=a(g,_,m,E,d[l+12],11,-421815835),E=a(E,g,_,m,d[l+15],16,530742520),m=a(m,E,g,_,d[l+2],23,-995338651),_=c(_,m,E,g,d[l+0],6,-198630844),g=c(g,_,m,E,d[l+7],10,1126891415),E=c(E,g,_,m,d[l+14],15,-1416354905),m=c(m,E,g,_,d[l+5],21,-57434055),_=c(_,m,E,g,d[l+12],6,1700485571),g=c(g,_,m,E,d[l+3],10,-1894986606),E=c(E,g,_,m,d[l+10],15,-1051523),m=c(m,E,g,_,d[l+1],21,-2054922799),_=c(_,m,E,g,d[l+8],6,1873313359),g=c(g,_,m,E,d[l+15],10,-30611744),E=c(E,g,_,m,d[l+6],15,-1560198380),m=c(m,E,g,_,d[l+13],21,1309151649),_=c(_,m,E,g,d[l+4],6,-145523070),g=c(g,_,m,E,d[l+11],10,-1120210379),E=c(E,g,_,m,d[l+2],15,718787259),m=c(m,E,g,_,d[l+9],21,-343485551),_=i(_,u),m=i(m,h),E=i(E,p),g=i(g,f);return n(_)+n(m)+n(E)+n(g)}(""+t+n)).slice(0,16),r=i.slice(0,12),o=await window.crypto.subtle.importKey("raw",i,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,e))},wA=async(e,t,n)=>await IA(e.buffer,t,n);function AA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function OA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?AA(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):AA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class NA extends fw{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==lw.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,t,n,i,r,o){if(super(e,r),ih(this,"trackMediaType","video"),ih(this,"_player",void 0),ih(this,"isUseScaleResolutionDownBy",!1),ih(this,"_videoVisibleTimer",null),ih(this,"_statsTimer",null),ih(this,"_previousVideoVisibleStatus",void 0),ih(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),ih(this,"_encoderConfig",void 0),ih(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),ih(this,"_optimizationMode",void 0),ih(this,"_videoHeight",void 0),ih(this,"_videoWidth",void 0),ih(this,"_forceBitrateLimit",void 0),ih(this,"_enabled",!0),ih(this,"processorDestination",void 0),ih(this,"_processorContext",void 0),Tg()){const{width:t,height:n}=e.getSettings();this._videoWidth=t,this._videoHeight=n}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=t,this._scalabilityMode=n,this._optimizationMode=i,this._hints=o||[],-1===this._hints.indexOf(zI.SCREEN_TRACK))this.updateBitrateFromProfile();else if(function(e,t,n){const i=pg();return!(i.name!==e||!i.osVersion)&&(n?Number(i.version)>=t&&Number(i.version)<=n:Number(i.version)===t)}(cg.CHROME,115)&&-1!==fg().indexOf("Windows")){const t=function(e,t){if("VideoFrame"in window&&"TransformStream"in window&&AI().supportWebRTCInsertableStream){const n=new MediaStreamTrackProcessor(e),i=new MediaStreamTrackGenerator({kind:"video"});let r,o,s=Date.now();const a=()=>{c&&(clearInterval(c),c=void 0),r&&(r.close(),r=void 0),e.stop(),o=void 0,i.removeEventListener("ended",a)};let c=window.setInterval((()=>{if(o&&r&&Date.now()-s>(null!=t?t:1e3))try{"live"===i.readyState?o.enqueue(r.clone()):a()}catch(e){a()}}),null!=t?t:1e3);const d=new TransformStream({transform:(e,t)=>{"live"===i.readyState?(o=t,s=Date.now(),void 0===r?(r=e,t.enqueue(e.clone())):(t.enqueue(r),r=e)):e.close()}});return i.addEventListener("ended",a),n.readable.pipeThrough(d).pipeTo(i.writable),i}}(e);t&&(zy.info("local screen video track begin to inject frame"),this._mediaStreamTrack=t)}t&&-1!==this._hints.indexOf(zI.CUSTOM_TRACK)&&this.setEncoderConfiguration(t),this.processorContext=new Zw(this.getTrackId(),"local"),this.processorDestination=new Qw(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(zy.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}zy.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=OA(OA(OA({},this._getDefaultPlayerConfig()),t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new yA(n):this._player=new CA(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.safeEmit(QI.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),Dy("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,zy.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(zy.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await gS(this,KI.NEED_DISABLE_TRACK,this)}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}return t||(this._enabled=!1),void zy.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await gS(this,KI.NEED_ENABLE_TRACK,this)}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}zy.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,zy.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await gS(this,KI.NEED_MUTE_TRACK,this):await gS(this,KI.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,t){if(!this._enabled)throw new Vg(xg.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if("720p_auto"===e?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=VI(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const t=hA({encoderConfig:e});(Tg()||yg()||Dg())&&(t.deviceId=void 0),zy.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(t));try{await this._originMediaStreamTrack.applyConstraints(t),this.updateMediaStreamTrackResolution()}catch(e){const t=new Vg(xg.UNEXPECTED_ERROR,e.toString());throw zy.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}}this._encoderConfig=e,-1===this._hints.indexOf(zI.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await gS(this,KI.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(zy)}}getStats(){return NS((()=>{zy.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),SS(this,KI.GET_STATS)||OA({},nw)}async setBeautyEffect(e){zy.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,t):await EA(e)}async setBitrateLimit(e){if(zy.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await gS(this,KI.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(zy)}}}async setOptimizationMode(e){if("motion"!==e&&"detail"!==e&&"balanced"!==e)return void zy.error(xg.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const t=this._optimizationMode;try{this._optimizationMode=e,await gS(this,KI.SET_OPTIMIZATION_MODE,this)}catch(e){throw this._optimizationMode=t,zy.error("[".concat(this.getTrackId(),"] set optimization mode failed"),e.toString()),e}zy.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(1===e.numSpatialLayers&&1!==e.numTemporalLayers)return zy.error(xg.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,zy.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){bA(this._originMediaStreamTrack).then((e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t})).catch(FS)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new Vg(xg.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");zy.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=VI(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,-1===this._hints.indexOf(zI.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await gS(this,KI.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(zy)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:t,frameRate:n}=this.getMediaStreamTrackSettings();if(!e||!t||!n)return;const[i,r]=function(e,t,n,i){let r;const o=200*Math.pow(n/15,.6)*Math.pow(e*t/640/360,.75),s=o;if("STANDARD_BITRATE"===i)r=4*o;else{if("COMPATIABLE_BITRATE"!==i)return;r=2*o}return[Math.floor(r),Math.floor(s)]}(e,t,n,Dy("BITRATE_ADAPTER_TYPE"))||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=r,this._encoderConfig.bitrateMax=i,zy.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(n,"] => [brMax: ").concat(i,", brMin: ").concat(r,"]")))}getVideoElementVisibleStatus(){try{var e,t;const n=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),i={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==n?void 0:n.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const e=Qg.checkOneElementVisible(r),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new Vg(xg.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new Vg(xg.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._encoderConfig;e&&(n=OA(OA({},n),VI(e))),n=AS(n);const i=xS(8,"track-video-cloned-"),r=new NA(t?this._mediaStreamTrack.clone():this._mediaStreamTrack,n,AS(this._scalabilityMode),this._optimizationMode,i,AS(this._hints));return e&&n&&r.setEncoderConfiguration(n),zy.debug("clone video track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(t)),r}async replaceTrack(e,t){if(!(e instanceof MediaStreamTrack))throw new Vg(xg.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==e.kind)throw new Vg(xg.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,t,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!Tg()&&!yg())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,t=MI[e],n=-1,i=Date.now();const r=e=>{e>2||e<0||(i=Date.now(),t=MI[e],this.setSenderConfiguration(t))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval((()=>{const o=this.getStats(),s=SS(this,KI.GET_RTC_STATS);if(o.sendPackets>0&&s){-1===n&&(n=Date.now());const a=Date.now();if(a-n<1e3||a-i<Dy("PROFILE_SWITCH_INTERVAL"))return;const c=o.sendFrameRate,d=.6*t.frameRate,l=.9*t.frameRate;"number"==typeof c&&c>0&&c<d?e>0&&(e--,r(e),zy.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(c,", switchProfile to ").concat(e))):s.OutgoingAvailableBandwidth<t.bitrateMin?e>0&&(e--,r(e),zy.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(s.OutgoingAvailableBandwidth,", bitrateMin ").concat(t.bitrateMin,", switchProfile to ").concat(e))):"number"==typeof c&&c>l&&e<MI.length-1&&s.OutgoingAvailableBandwidth>1.2*MI[e+1].bitrateMin&&(e++,r(e),zy.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(c,", OutgoingAvailableBandwidth ").concat(s.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}}),Dy("CHECK_LOCAL_STATS_INTERVAL"))}bindProcessorDestinationEvents(){this.processorDestination.on(sw.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await gS(this,KI.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await gS(this,KI.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(sw.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(aw.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(aw.REQUEST_CONSTRAINTS)}}UR([rR({argsMap:(e,t,n)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Object,Object]),xR("design:returntype",void 0)],NA.prototype,"play",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],NA.prototype,"stop",null),UR([YS("LocalVideoTrack","_enabledMutex"),rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean,Boolean]),xR("design:returntype",tg)],NA.prototype,"setEnabled",null),UR([YS("LocalVideoTrack","_enabledMutex"),rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean]),xR("design:returntype",tg)],NA.prototype,"setMuted",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Object,Boolean]),xR("design:returntype",tg)],NA.prototype,"setEncoderConfiguration",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",Object)],NA.prototype,"getStats",null),UR([rR({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean,Object]),xR("design:returntype",tg)],NA.prototype,"setBeautyEffect",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",ImageData)],NA.prototype,"getCurrentFrameData",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[String,Number]),xR("design:returntype",tg)],NA.prototype,"getCurrentFrameImage",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],NA.prototype,"setBitrateLimit",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],NA.prototype,"setOptimizationMode",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",void 0)],NA.prototype,"setScalabiltyMode",null),UR([qw(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],NA.prototype,"updateMediaStreamTrackResolution",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t.name]}),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",Object)],NA.prototype,"pipe",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],NA.prototype,"unpipe",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],NA.prototype,"close",null),UR([rR({argsMap:(e,t,n)=>[e.getTrackId(),t.label,n]}),xR("design:type",Function),xR("design:paramtypes",[MediaStreamTrack,Boolean]),xR("design:returntype",tg)],NA.prototype,"replaceTrack",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],NA.prototype,"startMonitorStats",null);class DA extends NA{get __className__(){return"CameraVideoTrack"}constructor(e,t,n,i,r,o){super(e,VI(t.encoderConfig),i,r,o),ih(this,"_config",void 0),ih(this,"_originalConstraints",void 0),ih(this,"_constraints",void 0),ih(this,"_enabled",!0),ih(this,"_deviceName","default"),ih(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(Ag()||Og())&&!function(){const e=pg();if(e.os!==ag.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=2}()&&Pg()&&this._enabled&&!this._isClosed&&(zy.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=t,this._originalConstraints=n,this._constraints=n,this._deviceName=e.label,this._encoderConfig=VI(this._config.encoderConfig),gw.on(OI.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),gw.on(OI.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return"string"==typeof e?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(zy.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const t=await Fw.getDeviceById(e),n={};n.video=OA({},this._constraints),n.video.deviceId={exact:e},n.video.facingMode=void 0,this._originMediaStreamTrack.stop();let i=null;try{i=await Mw(n,this.getTrackId())}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),i=await Mw({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await Fw.getDeviceById(e);this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}zy.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){zy.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const t={video:OA(OA({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let e=null;try{e=await Mw(t,this.getTrackId())}catch(t){throw zy.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),t.toString()),e=await Mw({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=OA({},t.video),zy.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(zy.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const e=await Mw({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1)}await gS(this,KI.NEED_ENABLE_TRACK,this)}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setEnabled true error"),e.toString()),e}this.updateMediaStreamTrackResolution(),zy.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),t||(this._enabled=!1);try{await gS(this,KI.NEED_DISABLE_TRACK,this)}catch(e){throw zy.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}zy.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new Vg(xg.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");"720p_auto"===e?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=VI(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin);const n=wS(this._config);n.encoderConfig=e;const i=hA(n);(Tg()||yg()||Dg())&&(i.deviceId=void 0),zy.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(e){const t=new Vg(xg.UNEXPECTED_ERROR,e.toString());throw zy.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}this._config=n,this._constraints=i,this._originalConstraints=i,this._encoderConfig=e,-1===this._hints.indexOf(zI.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await gS(this,KI.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(zy)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((yg()||Dg())&&this._enabled&&!this._isClosed&&gw.duringInterruption){const e=async()=>{gw.off(OI.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(zy.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};gw.on(OI.IOS_INTERRUPTION_END,e)}else zy.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(QI.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Fw.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId={exact:n}),this._enabled){const e=await Mw({video:t},this.getTrackId());this._constraints=t,await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),gw.off(OI.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),gw.off(OI.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._encoderConfig;e&&(n=OA(OA({},n),VI(e))),n=AS(n);const i=xS(8,"track-cam-cloned-"),r=new DA(t?this._mediaStreamTrack.clone():this._mediaStreamTrack,AS(OA(OA({},this._config),{},{encoderConfig:n})),AS(this._constraints),AS(this._scalabilityMode),this._optimizationMode,i);return e&&n&&r.setEncoderConfiguration(n),zy.debug("clone track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(t)),r}bindProcessorContextEvents(){this.processorContext.on(aw.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,n)=>{try{const n=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(n),t()}catch(e){n(e)}})),this.processorContext.on(aw.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}}function PA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function kA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?PA(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):PA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function LA(e,t,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=kA(kA({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),"motion"!==n.optimizationMode&&"detail"!==n.optimizationMode||(t.contentHint=n.optimizationMode,t.contentHint===n.optimizationMode?zy.debug("[".concat(e,"] set content hint to"),n.optimizationMode):zy.debug("[".concat(e,"] set content hint failed")))):zy.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}function MA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function UA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?MA(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):MA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}UR([rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],DA.prototype,"setDevice",null),UR([YS("CameraVideoTrack","_enabledMutex"),rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Boolean,Boolean]),xR("design:returntype",tg)],DA.prototype,"setEnabled",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t]}),qw(),xR("design:type",Function),xR("design:paramtypes",[Object,Boolean]),xR("design:returntype",tg)],DA.prototype,"setEncoderConfiguration",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],DA.prototype,"close",null);class xA extends pw{getUserId(){return this._userId}constructor(e,t,n,i){super(e,"track-".concat(e.kind,"-").concat(t,"-").concat(i.clientId,"_").concat(xS(5,""))),ih(this,"_userId",void 0),ih(this,"_uintId",void 0),ih(this,"_isDestroyed",!1),ih(this,"store",void 0),ih(this,"processor",void 0),this._userId=t,this._uintId=n,this.store=i}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,zy.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class VA extends xA{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==lw.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,n,i){super(e,t,n,i),ih(this,"_videoVisibleTimer",null),ih(this,"_previousVideoVisibleStatus",void 0),ih(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),ih(this,"trackMediaType","video"),ih(this,"_videoWidth",void 0),ih(this,"_videoHeight",void 0),ih(this,"_player",void 0),ih(this,"processorDestination",void 0),ih(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Zw(this.getTrackId(),"remote"),this.processorDestination=new Qw(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return NS((()=>{zy.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),SS(this,KI.GET_STATS)||UA({},ow)}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(zy.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}zy.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=UA(UA({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new yA(n):this._player=new CA(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(ZI.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.safeEmit(ZI.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),Dy("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,zy.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){bA(this._originMediaStreamTrack).then((e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t})).catch(FS)}_updatePlayerSource(){zy.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const n=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),i={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==n?void 0:n.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const e=Qg.checkOneElementVisible(r),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new Vg(xg.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new Vg(xg.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(sw.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(sw.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}UR([rR({argsMap:(e,t,n)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),xR("design:type",Function),xR("design:paramtypes",[Object,Object]),xR("design:returntype",void 0)],VA.prototype,"play",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],VA.prototype,"stop",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t.name]}),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",Object)],VA.prototype,"pipe",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],VA.prototype,"unpipe",null);class FA extends xA{get isPlaying(){return this._useAudioElement?Yw.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,n,i){super(e,t,n,i),ih(this,"trackMediaType","audio"),ih(this,"_source",void 0),ih(this,"_useAudioElement",!0),ih(this,"_volume",100),ih(this,"processorContext",void 0),ih(this,"processorDestination",void 0),ih(this,"_played",!1),ih(this,"_bypassWebAudio",!1),Dy("DISABLE_WEBAUDIO")?(this._source=new tA,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new ww(e,!0),Dy("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once($I.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(ZI.FIRST_FRAME_DECODED)})),this.processorContext=new eA(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new $w(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on($I.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners($I.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners($I.ON_AUDIO_BUFFER),this._source.on($I.ON_AUDIO_BUFFER,(t=>e(t)))}setVolume(e){this._volume=e,this._useAudioElement?Yw.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!Sg()&&Dy("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new Vg(xg.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Yw.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return NS((()=>{zy.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),SS(this,KI.GET_STATS)||UA({},iw)}play(){zy.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(zy.debug("[".concat(this.getTrackId(),"] use audio element to play")),Yw.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){zy.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Yw.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];zy.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Yw.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new Vg(xg.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new Vg(xg.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new Vg(xg.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(sw.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(sw.ON_NODE,(e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(sw.ON_TRACK),this.processorDestination.removeAllListeners(sw.ON_NODE)}}function jA(e){let t=e.length;for(;--t>=0;)e[t]=0}UR([rR({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),xR("design:type",Function),xR("design:paramtypes",[Number]),xR("design:returntype",void 0)],FA.prototype,"setVolume",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t]}),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],FA.prototype,"setPlaybackDevice",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],FA.prototype,"play",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],FA.prototype,"stop",null),UR([rR({argsMap:(e,t)=>[e.getTrackId(),t.name]}),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",Object)],FA.prototype,"pipe",null),UR([rR({argsMap:e=>[e.getTrackId()]}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],FA.prototype,"unpipe",null);const BA=256,GA=286,WA=30,HA=15,KA=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),zA=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),YA=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),qA=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),JA=new Array(576);jA(JA);const XA=new Array(60);jA(XA);const QA=new Array(512);jA(QA);const ZA=new Array(256);jA(ZA);const $A=new Array(29);jA($A);const eO=new Array(WA);function tO(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}let nO,iO,rO;function oO(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}jA(eO);const sO=e=>e<256?QA[e]:QA[256+(e>>>7)],aO=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},cO=(e,t,n)=>{e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,aO(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},dO=(e,t,n)=>{cO(e,n[2*t],n[2*t+1])},lO=(e,t)=>{let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1},uO=(e,t,n)=>{const i=new Array(16);let r,o,s=0;for(r=1;r<=HA;r++)s=s+n[r-1]<<1,i[r]=s;for(o=0;o<=t;o++){let t=e[2*o+1];0!==t&&(e[2*o]=lO(i[t]++,t))}},hO=e=>{let t;for(t=0;t<GA;t++)e.dyn_ltree[2*t]=0;for(t=0;t<WA;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},pO=e=>{e.bi_valid>8?aO(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},fO=(e,t,n,i)=>{const r=2*t,o=2*n;return e[r]<e[o]||e[r]===e[o]&&i[t]<=i[n]},_O=(e,t,n)=>{const i=e.heap[n];let r=n<<1;for(;r<=e.heap_len&&(r<e.heap_len&&fO(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!fO(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i},mO=(e,t,n)=>{let i,r,o,s,a=0;if(0!==e.sym_next)do{i=255&e.pending_buf[e.sym_buf+a++],i+=(255&e.pending_buf[e.sym_buf+a++])<<8,r=e.pending_buf[e.sym_buf+a++],0===i?dO(e,r,t):(o=ZA[r],dO(e,o+BA+1,t),s=KA[o],0!==s&&(r-=$A[o],cO(e,r,s)),i--,o=sO(i),dO(e,o,n),s=zA[o],0!==s&&(i-=eO[o],cO(e,i,s)))}while(a<e.sym_next);dO(e,256,t)},EO=(e,t)=>{const n=t.dyn_tree,i=t.stat_desc.static_tree,r=t.stat_desc.has_stree,o=t.stat_desc.elems;let s,a,c,d=-1;for(e.heap_len=0,e.heap_max=573,s=0;s<o;s++)0!==n[2*s]?(e.heap[++e.heap_len]=d=s,e.depth[s]=0):n[2*s+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=d<2?++d:0,n[2*c]=1,e.depth[c]=0,e.opt_len--,r&&(e.static_len-=i[2*c+1]);for(t.max_code=d,s=e.heap_len>>1;s>=1;s--)_O(e,n,s);c=o;do{s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],_O(e,n,1),a=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=a,n[2*c]=n[2*s]+n[2*a],e.depth[c]=(e.depth[s]>=e.depth[a]?e.depth[s]:e.depth[a])+1,n[2*s+1]=n[2*a+1]=c,e.heap[1]=c++,_O(e,n,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const n=t.dyn_tree,i=t.max_code,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,s=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,c=t.stat_desc.max_length;let d,l,u,h,p,f,_=0;for(h=0;h<=HA;h++)e.bl_count[h]=0;for(n[2*e.heap[e.heap_max]+1]=0,d=e.heap_max+1;d<573;d++)l=e.heap[d],h=n[2*n[2*l+1]+1]+1,h>c&&(h=c,_++),n[2*l+1]=h,l>i||(e.bl_count[h]++,p=0,l>=a&&(p=s[l-a]),f=n[2*l],e.opt_len+=f*(h+p),o&&(e.static_len+=f*(r[2*l+1]+p)));if(0!==_){do{for(h=c-1;0===e.bl_count[h];)h--;e.bl_count[h]--,e.bl_count[h+1]+=2,e.bl_count[c]--,_-=2}while(_>0);for(h=c;0!==h;h--)for(l=e.bl_count[h];0!==l;)u=e.heap[--d],u>i||(n[2*u+1]!==h&&(e.opt_len+=(h-n[2*u+1])*n[2*u],n[2*u+1]=h),l--)}})(e,t),uO(n,d,e.bl_count)},gO=(e,t,n)=>{let i,r,o=-1,s=t[1],a=0,c=7,d=4;for(0===s&&(c=138,d=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)r=s,s=t[2*(i+1)+1],++a<c&&r===s||(a<d?e.bl_tree[2*r]+=a:0!==r?(r!==o&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,o=r,0===s?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4))},SO=(e,t,n)=>{let i,r,o=-1,s=t[1],a=0,c=7,d=4;for(0===s&&(c=138,d=3),i=0;i<=n;i++)if(r=s,s=t[2*(i+1)+1],!(++a<c&&r===s)){if(a<d)do{dO(e,r,e.bl_tree)}while(0!=--a);else 0!==r?(r!==o&&(dO(e,r,e.bl_tree),a--),dO(e,16,e.bl_tree),cO(e,a-3,2)):a<=10?(dO(e,17,e.bl_tree),cO(e,a-3,3)):(dO(e,18,e.bl_tree),cO(e,a-11,7));a=0,o=r,0===s?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4)}};let TO=!1;const vO=(e,t,n,i)=>{cO(e,0+(i?1:0),3),pO(e),aO(e,n),aO(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n};var yO=e=>{TO||((()=>{let e,t,n,i,r;const o=new Array(16);for(n=0,i=0;i<28;i++)for($A[i]=n,e=0;e<1<<KA[i];e++)ZA[n++]=i;for(ZA[n-1]=i,r=0,i=0;i<16;i++)for(eO[i]=r,e=0;e<1<<zA[i];e++)QA[r++]=i;for(r>>=7;i<WA;i++)for(eO[i]=r<<7,e=0;e<1<<zA[i]-7;e++)QA[256+r++]=i;for(t=0;t<=HA;t++)o[t]=0;for(e=0;e<=143;)JA[2*e+1]=8,e++,o[8]++;for(;e<=255;)JA[2*e+1]=9,e++,o[9]++;for(;e<=279;)JA[2*e+1]=7,e++,o[7]++;for(;e<=287;)JA[2*e+1]=8,e++,o[8]++;for(uO(JA,287,o),e=0;e<WA;e++)XA[2*e+1]=5,XA[2*e]=lO(e,5);nO=new tO(JA,KA,257,GA,HA),iO=new tO(XA,zA,0,WA,HA),rO=new tO(new Array(0),YA,0,19,7)})(),TO=!0),e.l_desc=new oO(e.dyn_ltree,nO),e.d_desc=new oO(e.dyn_dtree,iO),e.bl_desc=new oO(e.bl_tree,rO),e.bi_buf=0,e.bi_valid=0,hO(e)},RO=(e,t,n,i)=>{let r,o,s=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<BA;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),EO(e,e.l_desc),EO(e,e.d_desc),s=(e=>{let t;for(gO(e,e.dyn_ltree,e.l_desc.max_code),gO(e,e.dyn_dtree,e.d_desc.max_code),EO(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*qA[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),r=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=r&&(r=o)):r=o=n+5,n+4<=r&&-1!==t?vO(e,t,n,i):4===e.strategy||o===r?(cO(e,2+(i?1:0),3),mO(e,JA,XA)):(cO(e,4+(i?1:0),3),((e,t,n,i)=>{let r;for(cO(e,t-257,5),cO(e,n-1,5),cO(e,i-4,4),r=0;r<i;r++)cO(e,e.bl_tree[2*qA[r]+1],3);SO(e,e.dyn_ltree,t-1),SO(e,e.dyn_dtree,n-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),mO(e,e.dyn_ltree,e.dyn_dtree)),hO(e),i&&pO(e)},CO=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(ZA[n]+BA+1)]++,e.dyn_dtree[2*sO(t)]++),e.sym_next===e.sym_end),bO={_tr_init:yO,_tr_stored_block:vO,_tr_flush_block:RO,_tr_tally:CO,_tr_align:e=>{cO(e,2,3),dO(e,256,JA),(e=>{16===e.bi_valid?(aO(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}},IO=(e,t,n,i)=>{let r=65535&e|0,o=e>>>16&65535|0,s=0;for(;0!==n;){s=n>2e3?2e3:n,n-=s;do{r=r+t[i++]|0,o=o+r|0}while(--s);r%=65521,o%=65521}return r|o<<16|0};const wO=new Uint32Array((()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t})());var AO=(e,t,n,i)=>{const r=wO,o=i+n;e^=-1;for(let s=i;s<o;s++)e=e>>>8^r[255&(e^t[s])];return-1^e},OO={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},NO={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:DO,_tr_stored_block:PO,_tr_flush_block:kO,_tr_tally:LO,_tr_align:MO}=bO,{Z_NO_FLUSH:UO,Z_PARTIAL_FLUSH:xO,Z_FULL_FLUSH:VO,Z_FINISH:FO,Z_BLOCK:jO,Z_OK:BO,Z_STREAM_END:GO,Z_STREAM_ERROR:WO,Z_DATA_ERROR:HO,Z_BUF_ERROR:KO,Z_DEFAULT_COMPRESSION:zO,Z_FILTERED:YO,Z_HUFFMAN_ONLY:qO,Z_RLE:JO,Z_FIXED:XO,Z_DEFAULT_STRATEGY:QO,Z_UNKNOWN:ZO,Z_DEFLATED:$O}=NO,eN=286,tN=30,nN=19,iN=2*eN+1,rN=15,oN=258,sN=262,aN=42,cN=113,dN=666,lN=(e,t)=>(e.msg=OO[t],t),uN=e=>2*e-(e>4?9:0),hN=e=>{let t=e.length;for(;--t>=0;)e[t]=0},pN=e=>{let t,n,i,r=e.w_size;t=e.hash_size,i=t;do{n=e.head[--i],e.head[i]=n>=r?n-r:0}while(--t);t=r,i=t;do{n=e.prev[--i],e.prev[i]=n>=r?n-r:0}while(--t)};let fN=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask;const _N=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))},mN=(e,t)=>{kO(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,_N(e.strm)},EN=(e,t)=>{e.pending_buf[e.pending++]=t},gN=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},SN=(e,t,n,i)=>{let r=e.avail_in;return r>i&&(r=i),0===r?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),n),1===e.state.wrap?e.adler=IO(e.adler,t,r,n):2===e.state.wrap&&(e.adler=AO(e.adler,t,r,n)),e.next_in+=r,e.total_in+=r,r)},TN=(e,t)=>{let n,i,r=e.max_chain_length,o=e.strstart,s=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-sN?e.strstart-(e.w_size-sN):0,d=e.window,l=e.w_mask,u=e.prev,h=e.strstart+oN;let p=d[o+s-1],f=d[o+s];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do{if(n=t,d[n+s]===f&&d[n+s-1]===p&&d[n]===d[o]&&d[++n]===d[o+1]){o+=2,n++;do{}while(d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&o<h);if(i=oN-(h-o),o=h-oN,i>s){if(e.match_start=t,s=i,i>=a)break;p=d[o+s-1],f=d[o+s]}}}while((t=u[t&l])>c&&0!=--r);return s<=e.lookahead?s:e.lookahead},vN=e=>{const t=e.w_size;let n,i,r;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-sN)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),pN(e),i+=t),0===e.strm.avail_in)break;if(n=SN(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=n,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=fN(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=fN(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<sN&&0!==e.strm.avail_in)},yN=(e,t)=>{let n,i,r,o=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s=0,a=e.strm.avail_in;do{if(n=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r)break;if(r=e.strm.avail_out-r,i=e.strstart-e.block_start,n>i+e.strm.avail_in&&(n=i+e.strm.avail_in),n>r&&(n=r),n<o&&(0===n&&t!==FO||t===UO||n!==i+e.strm.avail_in))break;s=t===FO&&n===i+e.strm.avail_in?1:0,PO(e,0,0,s),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,_N(e.strm),i&&(i>n&&(i=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,n-=i),n&&(SN(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(0===s);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?4:t!==UO&&t!==FO&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(SN(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,o=r>e.w_size?e.w_size:r,i=e.strstart-e.block_start,(i>=o||(i||t===FO)&&t!==UO&&0===e.strm.avail_in&&i<=r)&&(n=i>r?r:i,s=t===FO&&0===e.strm.avail_in&&n===i?1:0,PO(e,e.block_start,n,s),e.block_start+=n,_N(e.strm)),s?3:1)},RN=(e,t)=>{let n,i;for(;;){if(e.lookahead<sN){if(vN(e),e.lookahead<sN&&t===UO)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=fN(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-sN&&(e.match_length=TN(e,n)),e.match_length>=3)if(i=LO(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=fN(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=fN(e,e.ins_h,e.window[e.strstart+1]);else i=LO(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(mN(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===FO?(mN(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(mN(e,!1),0===e.strm.avail_out)?1:2},CN=(e,t)=>{let n,i,r;for(;;){if(e.lookahead<sN){if(vN(e),e.lookahead<sN&&t===UO)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=fN(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-sN&&(e.match_length=TN(e,n),e.match_length<=5&&(e.strategy===YO||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,i=LO(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=fN(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(mN(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(i=LO(e,0,e.window[e.strstart-1]),i&&mN(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=LO(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===FO?(mN(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(mN(e,!1),0===e.strm.avail_out)?1:2};function bN(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}const IN=[new bN(0,0,0,0,yN),new bN(4,4,8,4,RN),new bN(4,5,16,8,RN),new bN(4,6,32,32,RN),new bN(4,4,16,16,CN),new bN(8,16,32,32,CN),new bN(8,16,128,128,CN),new bN(8,32,128,256,CN),new bN(32,128,258,1024,CN),new bN(32,258,258,4096,CN)];function wN(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=$O,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*iN),this.dyn_dtree=new Uint16Array(2*(2*tN+1)),this.bl_tree=new Uint16Array(2*(2*nN+1)),hN(this.dyn_ltree),hN(this.dyn_dtree),hN(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(rN+1),this.heap=new Uint16Array(2*eN+1),hN(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*eN+1),hN(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const AN=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==aN&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==cN&&t.status!==dN?1:0},ON=e=>{if(AN(e))return lN(e,WO);e.total_in=e.total_out=0,e.data_type=ZO;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?aN:cN,e.adler=2===t.wrap?0:1,t.last_flush=-2,DO(t),BO},NN=e=>{const t=ON(e);var n;return t===BO&&((n=e.state).window_size=2*n.w_size,hN(n.head),n.max_lazy_match=IN[n.level].max_lazy,n.good_match=IN[n.level].good_length,n.nice_match=IN[n.level].nice_length,n.max_chain_length=IN[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0),t},DN=(e,t,n,i,r,o)=>{if(!e)return WO;let s=1;if(t===zO&&(t=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>9||n!==$O||i<8||i>15||t<0||t>9||o<0||o>XO||8===i&&1!==s)return lN(e,WO);8===i&&(i=9);const a=new wN;return e.state=a,a.strm=e,a.status=aN,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=o,a.method=n,NN(e)};var PN=(e,t)=>{if(AN(e)||t>jO||t<0)return e?lN(e,WO):WO;const n=e.state;if(!e.output||0!==e.avail_in&&!e.input||n.status===dN&&t!==FO)return lN(e,0===e.avail_out?KO:WO);const i=n.last_flush;if(n.last_flush=t,0!==n.pending){if(_N(e),0===e.avail_out)return n.last_flush=-1,BO}else if(0===e.avail_in&&uN(t)<=uN(i)&&t!==FO)return lN(e,KO);if(n.status===dN&&0!==e.avail_in)return lN(e,KO);if(n.status===aN&&0===n.wrap&&(n.status=cN),n.status===aN){let t=$O+(n.w_bits-8<<4)<<8,i=-1;if(i=n.strategy>=qO||n.level<2?0:n.level<6?1:6===n.level?2:3,t|=i<<6,0!==n.strstart&&(t|=32),t+=31-t%31,gN(n,t),0!==n.strstart&&(gN(n,e.adler>>>16),gN(n,65535&e.adler)),e.adler=1,n.status=cN,_N(e),0!==n.pending)return n.last_flush=-1,BO}if(57===n.status)if(e.adler=0,EN(n,31),EN(n,139),EN(n,8),n.gzhead)EN(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),EN(n,255&n.gzhead.time),EN(n,n.gzhead.time>>8&255),EN(n,n.gzhead.time>>16&255),EN(n,n.gzhead.time>>24&255),EN(n,9===n.level?2:n.strategy>=qO||n.level<2?4:0),EN(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(EN(n,255&n.gzhead.extra.length),EN(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=AO(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(EN(n,0),EN(n,0),EN(n,0),EN(n,0),EN(n,0),EN(n,9===n.level?2:n.strategy>=qO||n.level<2?4:0),EN(n,3),n.status=cN,_N(e),0!==n.pending)return n.last_flush=-1,BO;if(69===n.status){if(n.gzhead.extra){let t=n.pending,i=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+i>n.pending_buf_size;){let r=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+r),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>t&&(e.adler=AO(e.adler,n.pending_buf,n.pending-t,t)),n.gzindex+=r,_N(e),0!==n.pending)return n.last_flush=-1,BO;t=0,i-=r}let r=new Uint8Array(n.gzhead.extra);n.pending_buf.set(r.subarray(n.gzindex,n.gzindex+i),n.pending),n.pending+=i,n.gzhead.hcrc&&n.pending>t&&(e.adler=AO(e.adler,n.pending_buf,n.pending-t,t)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let t,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=AO(e.adler,n.pending_buf,n.pending-i,i)),_N(e),0!==n.pending)return n.last_flush=-1,BO;i=0}t=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,EN(n,t)}while(0!==t);n.gzhead.hcrc&&n.pending>i&&(e.adler=AO(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let t,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=AO(e.adler,n.pending_buf,n.pending-i,i)),_N(e),0!==n.pending)return n.last_flush=-1,BO;i=0}t=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,EN(n,t)}while(0!==t);n.gzhead.hcrc&&n.pending>i&&(e.adler=AO(e.adler,n.pending_buf,n.pending-i,i))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(_N(e),0!==n.pending))return n.last_flush=-1,BO;EN(n,255&e.adler),EN(n,e.adler>>8&255),e.adler=0}if(n.status=cN,_N(e),0!==n.pending)return n.last_flush=-1,BO}if(0!==e.avail_in||0!==n.lookahead||t!==UO&&n.status!==dN){let i=0===n.level?yN(n,t):n.strategy===qO?((e,t)=>{let n;for(;;){if(0===e.lookahead&&(vN(e),0===e.lookahead)){if(t===UO)return 1;break}if(e.match_length=0,n=LO(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(mN(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===FO?(mN(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(mN(e,!1),0===e.strm.avail_out)?1:2})(n,t):n.strategy===JO?((e,t)=>{let n,i,r,o;const s=e.window;for(;;){if(e.lookahead<=oN){if(vN(e),e.lookahead<=oN&&t===UO)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=e.strstart-1,i=s[r],i===s[++r]&&i===s[++r]&&i===s[++r])){o=e.strstart+oN;do{}while(i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&r<o);e.match_length=oN-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=LO(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=LO(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(mN(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===FO?(mN(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(mN(e,!1),0===e.strm.avail_out)?1:2})(n,t):IN[n.level].func(n,t);if(3!==i&&4!==i||(n.status=dN),1===i||3===i)return 0===e.avail_out&&(n.last_flush=-1),BO;if(2===i&&(t===xO?MO(n):t!==jO&&(PO(n,0,0,!1),t===VO&&(hN(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),_N(e),0===e.avail_out))return n.last_flush=-1,BO}return t!==FO?BO:n.wrap<=0?GO:(2===n.wrap?(EN(n,255&e.adler),EN(n,e.adler>>8&255),EN(n,e.adler>>16&255),EN(n,e.adler>>24&255),EN(n,255&e.total_in),EN(n,e.total_in>>8&255),EN(n,e.total_in>>16&255),EN(n,e.total_in>>24&255)):(gN(n,e.adler>>>16),gN(n,65535&e.adler)),_N(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?BO:GO)},kN=(e,t)=>{let n=t.length;if(AN(e))return WO;const i=e.state,r=i.wrap;if(2===r||1===r&&i.status!==aN||i.lookahead)return WO;if(1===r&&(e.adler=IO(e.adler,t,n,0)),i.wrap=0,n>=i.w_size){0===r&&(hN(i.head),i.strstart=0,i.block_start=0,i.insert=0);let e=new Uint8Array(i.w_size);e.set(t.subarray(n-i.w_size,n),0),t=e,n=i.w_size}const o=e.avail_in,s=e.next_in,a=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,vN(i);i.lookahead>=3;){let e=i.strstart,t=i.lookahead-2;do{i.ins_h=fN(i,i.ins_h,i.window[e+3-1]),i.prev[e&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=e,e++}while(--t);i.strstart=e,i.lookahead=2,vN(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=s,e.input=a,e.avail_in=o,i.wrap=r,BO},LN={deflateInit:(e,t)=>DN(e,t,$O,15,8,QO),deflateInit2:DN,deflateReset:NN,deflateResetKeep:ON,deflateSetHeader:(e,t)=>AN(e)||2!==e.state.wrap?WO:(e.state.gzhead=t,BO),deflate:PN,deflateEnd:e=>{if(AN(e))return WO;const t=e.state.status;return e.state=null,t===cN?lN(e,HO):BO},deflateSetDictionary:kN,deflateInfo:"pako deflate (from Nodeca project)"};const MN=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var UN={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const t in n)MN(n,t)&&(e[t]=n[t])}}return e},flattenChunks:e=>{let t=0;for(let i=0,r=e.length;i<r;i++)t+=e[i].length;const n=new Uint8Array(t);for(let i=0,r=0,o=e.length;i<o;i++){let t=e[i];n.set(t,r),r+=t.length}return n}};let xN=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){xN=!1}const VN=new Uint8Array(256);for(let n=0;n<256;n++)VN[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;VN[254]=VN[254]=1;var FN={string2buf:e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,n,i,r,o,s=e.length,a=0;for(r=0;r<s;r++)n=e.charCodeAt(r),55296==(64512&n)&&r+1<s&&(i=e.charCodeAt(r+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(a),o=0,r=0;o<a;r++)n=e.charCodeAt(r),55296==(64512&n)&&r+1<s&&(i=e.charCodeAt(r+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?t[o++]=n:n<2048?(t[o++]=192|n>>>6,t[o++]=128|63&n):n<65536?(t[o++]=224|n>>>12,t[o++]=128|n>>>6&63,t[o++]=128|63&n):(t[o++]=240|n>>>18,t[o++]=128|n>>>12&63,t[o++]=128|n>>>6&63,t[o++]=128|63&n);return t},buf2string:(e,t)=>{const n=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let i,r;const o=new Array(2*n);for(r=0,i=0;i<n;){let t=e[i++];if(t<128){o[r++]=t;continue}let s=VN[t];if(s>4)o[r++]=65533,i+=s-1;else{for(t&=2===s?31:3===s?15:7;s>1&&i<n;)t=t<<6|63&e[i++],s--;s>1?o[r++]=65533:t<65536?o[r++]=t:(t-=65536,o[r++]=55296|t>>10&1023,o[r++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&xN)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(e[i]);return n})(o,r)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let n=t-1;for(;n>=0&&128==(192&e[n]);)n--;return n<0||0===n?t:n+VN[e[n]]>t?n:t}},jN=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const BN=Object.prototype.toString,{Z_NO_FLUSH:GN,Z_SYNC_FLUSH:WN,Z_FULL_FLUSH:HN,Z_FINISH:KN,Z_OK:zN,Z_STREAM_END:YN,Z_DEFAULT_COMPRESSION:qN,Z_DEFAULT_STRATEGY:JN,Z_DEFLATED:XN}=NO;function QN(e){this.options=UN.assign({level:qN,method:XN,chunkSize:16384,windowBits:15,memLevel:8,strategy:JN},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new jN,this.strm.avail_out=0;let n=LN.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==zN)throw new Error(OO[n]);if(t.header&&LN.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?FN.string2buf(t.dictionary):"[object ArrayBuffer]"===BN.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,n=LN.deflateSetDictionary(this.strm,e),n!==zN)throw new Error(OO[n]);this._dict_set=!0}}function ZN(e,t){const n=new QN(t);if(n.push(e,!0),n.err)throw n.msg||OO[n.err];return n.result}QN.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize;let r,o;if(this.ended)return!1;for(o=t===~~t?t:!0===t?KN:GN,"string"==typeof e?n.input=FN.string2buf(e):"[object ArrayBuffer]"===BN.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(o===WN||o===HN)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=LN.deflate(n,o),r===YN)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=LN.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===zN;if(0!==n.avail_out){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},QN.prototype.onData=function(e){this.chunks.push(e)},QN.prototype.onEnd=function(e){e===zN&&(this.result=UN.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var $N={Deflate:QN,deflate:ZN,deflateRaw:function(e,t){return(t=t||{}).raw=!0,ZN(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,ZN(e,t)},constants:NO};const eD=16209;var tD=function(e,t){let n,i,r,o,s,a,c,d,l,u,h,p,f,_,m,E,g,S,T,v,y,R,C,b;const I=e.state;n=e.next_in,C=e.input,i=n+(e.avail_in-5),r=e.next_out,b=e.output,o=r-(t-e.avail_out),s=r+(e.avail_out-257),a=I.dmax,c=I.wsize,d=I.whave,l=I.wnext,u=I.window,h=I.hold,p=I.bits,f=I.lencode,_=I.distcode,m=(1<<I.lenbits)-1,E=(1<<I.distbits)-1;e:do{p<15&&(h+=C[n++]<<p,p+=8,h+=C[n++]<<p,p+=8),g=f[h&m];t:for(;;){if(S=g>>>24,h>>>=S,p-=S,S=g>>>16&255,0===S)b[r++]=65535&g;else{if(!(16&S)){if(0==(64&S)){g=f[(65535&g)+(h&(1<<S)-1)];continue t}if(32&S){I.mode=16191;break e}e.msg="invalid literal/length code",I.mode=eD;break e}T=65535&g,S&=15,S&&(p<S&&(h+=C[n++]<<p,p+=8),T+=h&(1<<S)-1,h>>>=S,p-=S),p<15&&(h+=C[n++]<<p,p+=8,h+=C[n++]<<p,p+=8),g=_[h&E];n:for(;;){if(S=g>>>24,h>>>=S,p-=S,S=g>>>16&255,!(16&S)){if(0==(64&S)){g=_[(65535&g)+(h&(1<<S)-1)];continue n}e.msg="invalid distance code",I.mode=eD;break e}if(v=65535&g,S&=15,p<S&&(h+=C[n++]<<p,p+=8,p<S&&(h+=C[n++]<<p,p+=8)),v+=h&(1<<S)-1,v>a){e.msg="invalid distance too far back",I.mode=eD;break e}if(h>>>=S,p-=S,S=r-o,v>S){if(S=v-S,S>d&&I.sane){e.msg="invalid distance too far back",I.mode=eD;break e}if(y=0,R=u,0===l){if(y+=c-S,S<T){T-=S;do{b[r++]=u[y++]}while(--S);y=r-v,R=b}}else if(l<S){if(y+=c+l-S,S-=l,S<T){T-=S;do{b[r++]=u[y++]}while(--S);if(y=0,l<T){S=l,T-=S;do{b[r++]=u[y++]}while(--S);y=r-v,R=b}}}else if(y+=l-S,S<T){T-=S;do{b[r++]=u[y++]}while(--S);y=r-v,R=b}for(;T>2;)b[r++]=R[y++],b[r++]=R[y++],b[r++]=R[y++],T-=3;T&&(b[r++]=R[y++],T>1&&(b[r++]=R[y++]))}else{y=r-v;do{b[r++]=b[y++],b[r++]=b[y++],b[r++]=b[y++],T-=3}while(T>2);T&&(b[r++]=b[y++],T>1&&(b[r++]=b[y++]))}break}}break}}while(n<i&&r<s);T=p>>3,n-=T,p-=T<<3,h&=(1<<p)-1,e.next_in=n,e.next_out=r,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=r<s?s-r+257:257-(r-s),I.hold=h,I.bits=p};const nD=15,iD=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),rD=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),oD=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),sD=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var aD=(e,t,n,i,r,o,s,a)=>{const c=a.bits;let d,l,u,h,p,f,_=0,m=0,E=0,g=0,S=0,T=0,v=0,y=0,R=0,C=0,b=null;const I=new Uint16Array(16),w=new Uint16Array(16);let A,O,N,D=null;for(_=0;_<=nD;_++)I[_]=0;for(m=0;m<i;m++)I[t[n+m]]++;for(S=c,g=nD;g>=1&&0===I[g];g--);if(S>g&&(S=g),0===g)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(E=1;E<g&&0===I[E];E++);for(S<E&&(S=E),y=1,_=1;_<=nD;_++)if(y<<=1,y-=I[_],y<0)return-1;if(y>0&&(0===e||1!==g))return-1;for(w[1]=0,_=1;_<nD;_++)w[_+1]=w[_]+I[_];for(m=0;m<i;m++)0!==t[n+m]&&(s[w[t[n+m]]++]=m);if(0===e?(b=D=s,f=20):1===e?(b=iD,D=rD,f=257):(b=oD,D=sD,f=0),C=0,m=0,_=E,p=o,T=S,v=0,u=-1,R=1<<S,h=R-1,1===e&&R>852||2===e&&R>592)return 1;for(;;){A=_-v,s[m]+1<f?(O=0,N=s[m]):s[m]>=f?(O=D[s[m]-f],N=b[s[m]-f]):(O=96,N=0),d=1<<_-v,l=1<<T,E=l;do{l-=d,r[p+(C>>v)+l]=A<<24|O<<16|N|0}while(0!==l);for(d=1<<_-1;C&d;)d>>=1;if(0!==d?(C&=d-1,C+=d):C=0,m++,0==--I[_]){if(_===g)break;_=t[n+s[m]]}if(_>S&&(C&h)!==u){for(0===v&&(v=S),p+=E,T=_-v,y=1<<T;T+v<g&&(y-=I[T+v],!(y<=0));)T++,y<<=1;if(R+=1<<T,1===e&&R>852||2===e&&R>592)return 1;u=C&h,r[u]=S<<24|T<<16|p-o|0}}return 0!==C&&(r[p+C]=_-v<<24|64<<16|0),a.bits=S,0};const{Z_FINISH:cD,Z_BLOCK:dD,Z_TREES:lD,Z_OK:uD,Z_STREAM_END:hD,Z_NEED_DICT:pD,Z_STREAM_ERROR:fD,Z_DATA_ERROR:_D,Z_MEM_ERROR:mD,Z_BUF_ERROR:ED,Z_DEFLATED:gD}=NO,SD=16180,TD=16190,vD=16191,yD=16192,RD=16194,CD=16199,bD=16200,ID=16206,wD=16209,AD=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function OD(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const ND=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<SD||t.mode>16211?1:0},DD=e=>{if(ND(e))return fD;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=SD,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,uD},PD=e=>{if(ND(e))return fD;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,DD(e)},kD=(e,t)=>{let n;if(ND(e))return fD;const i=e.state;return t<0?(n=0,t=-t):(n=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?fD:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,PD(e))},LD=(e,t)=>{if(!e)return fD;const n=new OD;e.state=n,n.strm=e,n.window=null,n.mode=SD;const i=kD(e,t);return i!==uD&&(e.state=null),i};let MD,UD,xD=!0;const VD=e=>{if(xD){MD=new Int32Array(512),UD=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(aD(1,e.lens,0,288,MD,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;aD(2,e.lens,0,32,UD,0,e.work,{bits:5}),xD=!1}e.lencode=MD,e.lenbits=9,e.distcode=UD,e.distbits=5},FD=(e,t,n,i)=>{let r;const o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(t.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(t.subarray(n-i,n-i+r),o.wnext),(i-=r)?(o.window.set(t.subarray(n-i,n),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var jD=(e,t)=>{let n,i,r,o,s,a,c,d,l,u,h,p,f,_,m,E,g,S,T,v,y,R,C=0;const b=new Uint8Array(4);let I,w;const A=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(ND(e)||!e.output||!e.input&&0!==e.avail_in)return fD;n=e.state,n.mode===vD&&(n.mode=yD),s=e.next_out,r=e.output,c=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,d=n.hold,l=n.bits,u=a,h=c,R=uD;e:for(;;)switch(n.mode){case SD:if(0===n.wrap){n.mode=yD;break}for(;l<16;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(2&n.wrap&&35615===d){0===n.wbits&&(n.wbits=15),n.check=0,b[0]=255&d,b[1]=d>>>8&255,n.check=AO(n.check,b,2,0),d=0,l=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",n.mode=wD;break}if((15&d)!==gD){e.msg="unknown compression method",n.mode=wD;break}if(d>>>=4,l-=4,y=8+(15&d),0===n.wbits&&(n.wbits=y),y>15||y>n.wbits){e.msg="invalid window size",n.mode=wD;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=512&d?16189:vD,d=0,l=0;break;case 16181:for(;l<16;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(n.flags=d,(255&n.flags)!==gD){e.msg="unknown compression method",n.mode=wD;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=wD;break}n.head&&(n.head.text=d>>8&1),512&n.flags&&4&n.wrap&&(b[0]=255&d,b[1]=d>>>8&255,n.check=AO(n.check,b,2,0)),d=0,l=0,n.mode=16182;case 16182:for(;l<32;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}n.head&&(n.head.time=d),512&n.flags&&4&n.wrap&&(b[0]=255&d,b[1]=d>>>8&255,b[2]=d>>>16&255,b[3]=d>>>24&255,n.check=AO(n.check,b,4,0)),d=0,l=0,n.mode=16183;case 16183:for(;l<16;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&n.flags&&4&n.wrap&&(b[0]=255&d,b[1]=d>>>8&255,n.check=AO(n.check,b,2,0)),d=0,l=0,n.mode=16184;case 16184:if(1024&n.flags){for(;l<16;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}n.length=d,n.head&&(n.head.extra_len=d),512&n.flags&&4&n.wrap&&(b[0]=255&d,b[1]=d>>>8&255,n.check=AO(n.check,b,2,0)),d=0,l=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&n.flags&&(p=n.length,p>a&&(p=a),p&&(n.head&&(y=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(o,o+p),y)),512&n.flags&&4&n.wrap&&(n.check=AO(n.check,i,p,o)),a-=p,o+=p,n.length-=p),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&n.flags){if(0===a)break e;p=0;do{y=i[o+p++],n.head&&y&&n.length<65536&&(n.head.name+=String.fromCharCode(y))}while(y&&p<a);if(512&n.flags&&4&n.wrap&&(n.check=AO(n.check,i,p,o)),a-=p,o+=p,y)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&n.flags){if(0===a)break e;p=0;do{y=i[o+p++],n.head&&y&&n.length<65536&&(n.head.comment+=String.fromCharCode(y))}while(y&&p<a);if(512&n.flags&&4&n.wrap&&(n.check=AO(n.check,i,p,o)),a-=p,o+=p,y)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&n.flags){for(;l<16;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(4&n.wrap&&d!==(65535&n.check)){e.msg="header crc mismatch",n.mode=wD;break}d=0,l=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=vD;break;case 16189:for(;l<32;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}e.adler=n.check=AD(d),d=0,l=0,n.mode=TD;case TD:if(0===n.havedict)return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=d,n.bits=l,pD;e.adler=n.check=1,n.mode=vD;case vD:if(t===dD||t===lD)break e;case yD:if(n.last){d>>>=7&l,l-=7&l,n.mode=ID;break}for(;l<3;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}switch(n.last=1&d,d>>>=1,l-=1,3&d){case 0:n.mode=16193;break;case 1:if(VD(n),n.mode=CD,t===lD){d>>>=2,l-=2;break e}break;case 2:n.mode=16196;break;case 3:e.msg="invalid block type",n.mode=wD}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",n.mode=wD;break}if(n.length=65535&d,d=0,l=0,n.mode=RD,t===lD)break e;case RD:n.mode=16195;case 16195:if(p=n.length,p){if(p>a&&(p=a),p>c&&(p=c),0===p)break e;r.set(i.subarray(o,o+p),s),a-=p,o+=p,c-=p,s+=p,n.length-=p;break}n.mode=vD;break;case 16196:for(;l<14;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(n.nlen=257+(31&d),d>>>=5,l-=5,n.ndist=1+(31&d),d>>>=5,l-=5,n.ncode=4+(15&d),d>>>=4,l-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=wD;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;l<3;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}n.lens[A[n.have++]]=7&d,d>>>=3,l-=3}for(;n.have<19;)n.lens[A[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,I={bits:n.lenbits},R=aD(0,n.lens,0,19,n.lencode,0,n.work,I),n.lenbits=I.bits,R){e.msg="invalid code lengths set",n.mode=wD;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;C=n.lencode[d&(1<<n.lenbits)-1],m=C>>>24,E=C>>>16&255,g=65535&C,!(m<=l);){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(g<16)d>>>=m,l-=m,n.lens[n.have++]=g;else{if(16===g){for(w=m+2;l<w;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(d>>>=m,l-=m,0===n.have){e.msg="invalid bit length repeat",n.mode=wD;break}y=n.lens[n.have-1],p=3+(3&d),d>>>=2,l-=2}else if(17===g){for(w=m+3;l<w;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}d>>>=m,l-=m,y=0,p=3+(7&d),d>>>=3,l-=3}else{for(w=m+7;l<w;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}d>>>=m,l-=m,y=0,p=11+(127&d),d>>>=7,l-=7}if(n.have+p>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=wD;break}for(;p--;)n.lens[n.have++]=y}}if(n.mode===wD)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=wD;break}if(n.lenbits=9,I={bits:n.lenbits},R=aD(1,n.lens,0,n.nlen,n.lencode,0,n.work,I),n.lenbits=I.bits,R){e.msg="invalid literal/lengths set",n.mode=wD;break}if(n.distbits=6,n.distcode=n.distdyn,I={bits:n.distbits},R=aD(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,I),n.distbits=I.bits,R){e.msg="invalid distances set",n.mode=wD;break}if(n.mode=CD,t===lD)break e;case CD:n.mode=bD;case bD:if(a>=6&&c>=258){e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=d,n.bits=l,tD(e,h),s=e.next_out,r=e.output,c=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,d=n.hold,l=n.bits,n.mode===vD&&(n.back=-1);break}for(n.back=0;C=n.lencode[d&(1<<n.lenbits)-1],m=C>>>24,E=C>>>16&255,g=65535&C,!(m<=l);){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(E&&0==(240&E)){for(S=m,T=E,v=g;C=n.lencode[v+((d&(1<<S+T)-1)>>S)],m=C>>>24,E=C>>>16&255,g=65535&C,!(S+m<=l);){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}d>>>=S,l-=S,n.back+=S}if(d>>>=m,l-=m,n.back+=m,n.length=g,0===E){n.mode=16205;break}if(32&E){n.back=-1,n.mode=vD;break}if(64&E){e.msg="invalid literal/length code",n.mode=wD;break}n.extra=15&E,n.mode=16201;case 16201:if(n.extra){for(w=n.extra;l<w;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;C=n.distcode[d&(1<<n.distbits)-1],m=C>>>24,E=C>>>16&255,g=65535&C,!(m<=l);){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(0==(240&E)){for(S=m,T=E,v=g;C=n.distcode[v+((d&(1<<S+T)-1)>>S)],m=C>>>24,E=C>>>16&255,g=65535&C,!(S+m<=l);){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}d>>>=S,l-=S,n.back+=S}if(d>>>=m,l-=m,n.back+=m,64&E){e.msg="invalid distance code",n.mode=wD;break}n.offset=g,n.extra=15&E,n.mode=16203;case 16203:if(n.extra){for(w=n.extra;l<w;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=wD;break}n.mode=16204;case 16204:if(0===c)break e;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=wD;break}p>n.wnext?(p-=n.wnext,f=n.wsize-p):f=n.wnext-p,p>n.length&&(p=n.length),_=n.window}else _=r,f=s-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do{r[s++]=_[f++]}while(--p);0===n.length&&(n.mode=bD);break;case 16205:if(0===c)break e;r[s++]=n.length,c--,n.mode=bD;break;case ID:if(n.wrap){for(;l<32;){if(0===a)break e;a--,d|=i[o++]<<l,l+=8}if(h-=c,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=n.flags?AO(n.check,r,h,s-h):IO(n.check,r,h,s-h)),h=c,4&n.wrap&&(n.flags?d:AD(d))!==n.check){e.msg="incorrect data check",n.mode=wD;break}d=0,l=0}n.mode=16207;case 16207:if(n.wrap&&n.flags){for(;l<32;){if(0===a)break e;a--,d+=i[o++]<<l,l+=8}if(4&n.wrap&&d!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=wD;break}d=0,l=0}n.mode=16208;case 16208:R=hD;break e;case wD:R=_D;break e;case 16210:return mD;default:return fD}return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=d,n.bits=l,(n.wsize||h!==e.avail_out&&n.mode<wD&&(n.mode<ID||t!==cD))&&FD(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=n.flags?AO(n.check,r,h,e.next_out-h):IO(n.check,r,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===vD?128:0)+(n.mode===CD||n.mode===RD?256:0),(0===u&&0===h||t===cD)&&R===uD&&(R=ED),R},BD={inflateReset:PD,inflateReset2:kD,inflateResetKeep:DD,inflateInit:e=>LD(e,15),inflateInit2:LD,inflate:jD,inflateEnd:e=>{if(ND(e))return fD;let t=e.state;return t.window&&(t.window=null),e.state=null,uD},inflateGetHeader:(e,t)=>{if(ND(e))return fD;const n=e.state;return 0==(2&n.wrap)?fD:(n.head=t,t.done=!1,uD)},inflateSetDictionary:(e,t)=>{const n=t.length;let i,r,o;return ND(e)?fD:(i=e.state,0!==i.wrap&&i.mode!==TD?fD:i.mode===TD&&(r=1,r=IO(r,t,n,0),r!==i.check)?_D:(o=FD(e,t,n,n),o?(i.mode=16210,mD):(i.havedict=1,uD)))},inflateInfo:"pako inflate (from Nodeca project)"},GD=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const WD=Object.prototype.toString,{Z_NO_FLUSH:HD,Z_FINISH:KD,Z_OK:zD,Z_STREAM_END:YD,Z_NEED_DICT:qD,Z_STREAM_ERROR:JD,Z_DATA_ERROR:XD,Z_MEM_ERROR:QD}=NO;function ZD(e){this.options=UN.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new jN,this.strm.avail_out=0;let n=BD.inflateInit2(this.strm,t.windowBits);if(n!==zD)throw new Error(OO[n]);if(this.header=new GD,BD.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=FN.string2buf(t.dictionary):"[object ArrayBuffer]"===WD.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=BD.inflateSetDictionary(this.strm,t.dictionary),n!==zD)))throw new Error(OO[n])}function $D(e,t){const n=new ZD(t);if(n.push(e),n.err)throw n.msg||OO[n.err];return n.result}ZD.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let o,s,a;if(this.ended)return!1;for(s=t===~~t?t:!0===t?KD:HD,"[object ArrayBuffer]"===WD.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),o=BD.inflate(n,s),o===qD&&r&&(o=BD.inflateSetDictionary(n,r),o===zD?o=BD.inflate(n,s):o===XD&&(o=qD));n.avail_in>0&&o===YD&&n.state.wrap>0&&0!==e[n.next_in];)BD.inflateReset(n),o=BD.inflate(n,s);switch(o){case JD:case XD:case qD:case QD:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(0===n.avail_out||o===YD))if("string"===this.options.to){let e=FN.utf8border(n.output,n.next_out),t=n.next_out-e,r=FN.buf2string(n.output,e);n.next_out=t,n.avail_out=i-t,t&&n.output.set(n.output.subarray(e,e+t),0),this.onData(r)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==zD||0!==a){if(o===YD)return o=BD.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},ZD.prototype.onData=function(e){this.chunks.push(e)},ZD.prototype.onEnd=function(e){e===zD&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=UN.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var eP={Inflate:ZD,inflate:$D,inflateRaw:function(e,t){return(t=t||{}).raw=!0,$D(e,t)},ungzip:$D,constants:NO};const{Deflate:tP,deflate:nP,deflateRaw:iP,gzip:rP}=$N,{Inflate:oP,inflate:sP,inflateRaw:aP,ungzip:cP}=eP;var dP,lP=nP,uP=sP;!function(e){e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE"}(dP||(dP={}));class hP{constructor(){ih(this,"_sequence",0),ih(this,"_startTime",Date.now()),ih(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const t={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const n=new Uint8Array(4);n.set([1,0,0,0]);const i={id:0,length:4,data:n.buffer},r={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[i]};t.commonPacketHeader.extension=1,t.extension=r,t.payload=this.compress(e),t.commonPacketHeader.length=8+(t.extension.length+2)+t.payload.byteLength}else t.commonPacketHeader.length=8+t.payload.byteLength;Dy("SHOW_DATASTREAM2_LOG")&&zy.debug("send data header: ".concat(JSON.stringify(t.commonPacketHeader)));const n=new ArrayBuffer(t.commonPacketHeader.length),i=new Uint8Array(n),r=new DataView(n);let o=0;if(r.setUint16(o,t.commonPacketHeader.extension<<15|t.commonPacketHeader.reserved<<14|t.commonPacketHeader.length,!0),o+=2,r.setUint32(o,t.commonPacketHeader.sequence,!0),o+=4,r.setUint16(o,t.commonStreamHeader,!0),o+=2,t.extension){const e=this.serializeExtension(t.extension);i.set(new Uint8Array(e),o),o+=e.byteLength}if(i.set(new Uint8Array(t.payload),o),o+=t.payload.byteLength,o!==t.commonPacketHeader.length)throw Error("serialize error!");return n}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const t=new DataView(e);let n=0;const i=t.getUint16(n,!0);n+=2;const r={length:16383&i,reserved:(16384&i)>>14,extension:(32768&i)>>15,sequence:t.getUint16(n+2,!0)<<16|t.getUint16(n,!0)};let o,s;if(n+=4,Dy("SHOW_DATASTREAM2_LOG")&&zy.debug("receive data header: ".concat(JSON.stringify(r))),t.getUint16(n,!0),n+=2,r.extension){s=this.deserializeExtension(e.slice(n)),n+=2+s.length,o=e.slice(n);let t=!1;if(s.datas.length>0){const e=s.datas.find((e=>0===e.id));e&&(t=1==(1&new DataView(e.data).getUint32(0,!0)))}o=t?this.decompress(o):o}else o=e.slice(8);return o}serializeExtension(e){const{profile:t,length:n,datas:i}=e,r=new ArrayBuffer(n+2),o=new Uint8Array(r),s=new DataView(r);let a=0;if(s.setUint8(a++,t),s.setUint8(a++,n),i.forEach((e=>{t?(s.setUint8(a++,e.id),s.setUint8(a++,e.length),o.set(new Uint8Array(e.data),a),a+=e.data.byteLength):(s.setUint8(a++,e.id|e.length<<4),o.set(new Uint8Array(e.data),a),a+=e.data.byteLength)})),a!==n+2)throw Error("serialize extension error, is ".concat(a,"!==").concat(n+2));return r}deserializeExtension(e){const t=new DataView(e);let n=0;const i=t.getUint8(n);n++;const r=t.getUint8(n);n++;const o=i===dP.TWO_BYTE,s=[],a=new DataView(e,2);let c=0;for(;c<r;){let e=0,t=0,n=new ArrayBuffer(0);o?(e=a.getUint8(c),c++,t=a.getUint8(c),c++):(e=15&a.getUint8(c),t=a.getUint8(c)>>4,c++),t>0&&(n=a.buffer.slice(c+2,c+2+t),c+=n.byteLength),s.push({id:e,length:t,data:n})}if(c!==r)throw Error("parse error");return{profile:i,length:r,datas:s}}decompress(e){return uP(new Uint8Array(e))}compress(e){return lP(new Uint8Array(e))}}class pP extends nS{constructor(e,t){super(),ih(this,"_version",1),ih(this,"_type",3),ih(this,"_config",void 0),ih(this,"_originDataChannel",void 0),ih(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),ih(this,"_dataStreamPacketHandler",void 0),ih(this,"_datachannelEventMap",new Map),this._config=e,t&&(this._originDataChannel=t,this._bandDataChannelEvents(t)),this._initPacketHeader(),this._dataStreamPacketHandler=new hP}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return Dy("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,t;return null!==(e=null===(t=this._originDataChannel)||void 0===t?void 0:t.readyState)&&void 0!==e?e:"connecting"}get _originDataChannelId(){var e,t;return null!==(e=null===(t=this._originDataChannel)||void 0===t?void 0:t.id)&&void 0!==e?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new tg(((e,t)=>{if(this._originDataChannel){"open"===this._originDataChannel.readyState&&e();const n=setTimeout((()=>{var e;t(new Vg(xg.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(e=this._originDataChannel)||void 0===e?void 0:e.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(n),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(n),new Vg(xg.DATACHANNEL_CONNECTION_TIMEOUT)}}else t(new Vg(xg.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[hw.OPEN,hw.CLOSE,hw.ERROR].forEach((t=>{const n=()=>{this.emit(t)};this._datachannelEventMap.set(t,n),e.addEventListener(t,n)}))}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach((t=>{let[n,i]=t;e.removeEventListener(n,i)})),this._datachannelEventMap.clear()}}class fP extends pP{constructor(e){super(e),ih(this,"_messageListener",void 0),this._messageListener=e=>{if(e.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const t=e.data.slice(0,this._dataStreamPacketHeader.byteLength),n=new DataView(t).getUint8(3);if(n!==this.id)return void(Dy("SHOW_DATASTREAM2_LOG")&&zy.debug("invalid datachannel id: ".concat(n," !== ").concat(this.id)));let i=e.data.slice(this._dataStreamPacketHeader.byteLength);i=this._dataStreamPacketHandler.deserialize(i),this.emit(hw.MESSAGE,i)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class _P extends pP{send(e){if(this._originDataChannel){let t=e;t=this._dataStreamPacketHandler.serialize(e);const n=new Uint8Array(this._dataStreamPacketHeader.byteLength+t.byteLength);n.set(new Uint8Array(this._dataStreamPacketHeader),0),n.set(new Uint8Array(t),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(n.buffer)}}}!function(){const e=pg();wI.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),wI.getStreamFromExtension=e.name===cg.CHROME&&Number(e.version)>34,wI.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let t=!1;try{e.addTransceiver("audio"),t=!0}catch(e){}return e.close(),t}(),wI.supportMinBitrate=e.name===cg.CHROME||e.name===cg.EDGE,wI.supportSetRtpSenderParameters=function(){const e=pg();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Lg()||!(!Tg()&&!mg())||e.name===cg.FIREFOX&&Number(e.version)>=64)}(),e.name===cg.SAFARI&&(Number(e.version)>=14?wI.supportDualStream=!0:wI.supportDualStream=!1),wI.webAudioMediaStreamDest=function(){const e=pg();return!(e.name===cg.SAFARI&&Number(e.version)<12)}(),wI.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,wI.supportWebGL="undefined"!=typeof WebGLRenderingContext,wI.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Lg()||(wI.webAudioWithAEC=!0),wI.supportShareAudio=function(){const e=pg();return(e.os===ag.WIN_10||e.os===ag.WIN_81||e.os===ag.WIN_7||e.os===ag.LINUX||e.os===ag.MAC_OS||e.os===ag.CHROMIUM_OS)&&e.name===cg.CHROME&&Number(e.version)>=74}(),wI.supportDataChannel=!!(Rg(76)||function(e){const t=pg();return!(t.name!==cg.FIREFOX||!t.osVersion)&&Number(t.version)>=e}(68)||function(e){const t=pg();return!(t.name!==cg.SAFARI||!t.osVersion)&&Number(t.version)>=e}(14)),wI.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!vg()&&!!e&&e.prototype.setConfiguration instanceof Function}(),wI.supportWebRTCEncodedTransform=function(){const e=pg();return"Chrome"===e.name&&Number(e.version)>=86}(),wI.supportWebRTCInsertableStream=function(){const e=pg();return(e.name===cg.CHROME||e.name===cg.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),IS((()=>{wI.supportDualStreamEncoding=function(){const e=pg();return!!Dy("DISABLE_WEBAUDIO")||"Safari"===e.name&&Number(e.version)>=14||!!("Chrome"===e.name&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&Dy("CHROME_DUAL_STREAM_USE_ENCODING"))}(),zy.info("browser compatibility",JSON.stringify(wI),JSON.stringify(e))}))}();class mP extends nS{constructor(){super(...arguments),ih(this,"resultStorage",new Map)}setLocalAudioStats(e,t,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(n,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(n,t))}setLocalVideoStats(e,t,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(n,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(n,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(n))}setRemoteAudioStats(e,t){const n=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const n=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(t))}record(e,t,n){if(Dy("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const i=this.resultStorage.get(e);if(i&&(i.result.push(n),i.result.length>=5)){var r;const n=Ai(r=i.result).call(r,!0);i.isPrevNormal&&!n&&this.emit("exception",EP[e],e,t),!i.isPrevNormal&&n&&this.emit("exception",EP[e]+2e3,e+"_RECOVER",t),i.isPrevNormal=n,i.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof uA&&!t.isActive||!!t.muted||0!==e.sendVolumeLevel}checkFramerateInput(e,t){let n=null;t._encoderConfig&&t._encoderConfig.frameRate&&(n=bb(t._encoderConfig.frameRate));const i=e.captureFrameRate;return!n||!i||!(n>10&&i<5||n<10&&n>=5&&i<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof uA&&!t.isActive||!!t.muted||0!==e.sendBitrate}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const EP={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},gP=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(n.length>0){const e=n[n.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(n.length>0){const e=n[n.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function SP(e,t){this.v=e,this.k=t}function TP(e){return new SP(e,0)}var vP=eg,yP=om;Nn({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=yP.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var RP=om,CP=j_;Nn({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=RP.f(this),n=CP(e);return(n.error?t.reject:t.resolve)(n.value),t.promise}});var bP=i(vP),IP=js.f("asyncIterator"),wP=i(IP);function AP(e){var t,n;function i(t,n){try{var o=e[t](n),s=o.value,a=s instanceof SP;bP.resolve(a?s.v:s).then((function(n){if(a){var c="return"===t?"return":"next";if(!s.k||n.done)return i(c,n);n=e[c](n).value}r(o.done?"return":"normal",n)}),(function(e){i("throw",e)}))}catch(e){r("throw",e)}}function r(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?i(t.key,t.arg):n=null}this._invoke=function(e,r){return new bP((function(o,s){var a={key:e,arg:r,resolve:o,reject:s,next:null};n?n=n.next=a:(t=n=a,i(e,r))}))},"function"!=typeof e.return&&(this.return=void 0)}function OP(e){return function(){return new AP(e.apply(this,arguments))}}AP.prototype["function"==typeof Uu&&wP||"@@asyncIterator"]=function(){return this},AP.prototype.next=function(e){return this._invoke("next",e)},AP.prototype.throw=function(e){return this._invoke("throw",e)},AP.prototype.return=function(e){return this._invoke("return",e)};var NP=i(ie.Object.getOwnPropertySymbols),DP=Nn,PP=Yn.indexOf,kP=vh,LP=b([].indexOf),MP=!!LP&&1/LP([1],1,-0)<0;DP({target:"Array",proto:!0,forced:MP||!kP("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return MP?LP(this,e,t)||0:PP(this,e,t)}});var UP=Xn("Array").indexOf,xP=u,VP=UP,FP=Array.prototype,jP=i((function(e){var t=e.indexOf;return e===FP||xP(FP,e)&&t===FP.indexOf?VP:t})),BP=Xe,GP=qo;Nn({target:"Object",stat:!0,forced:r((function(){GP(1)}))},{keys:function(e){return GP(BP(e))}});var WP=i(ie.Object.keys);function HP(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},o=WP(e);for(i=0;i<o.length;i++)n=o[i],jP(t).call(t,n)>=0||(r[n]=e[n]);return r}(e,t);if(NP){var o=NP(e);for(i=0;i<o.length;i++)n=o[i],jP(t).call(t,n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var KP={exports:{}};!function(e,t){e.exports=(()=>{var e={8:(e,t,n)=>{n.r(t),n.d(t,{Parser:()=>y,Printer:()=>w,parse:()=>D,print:()=>P});const i="\n",r="".concat("\r").concat(i),o=" ";let s;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>="\x80"&&e<="\xff"}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function u(e){return e>="1"&&e<="9"}function h(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function f(e){return e>"\x01"&&e<"\t"||e>"\v"&&e<"\f"||e>"\x0e"&&e<"\xff"}function _(e){return h(e)||a(e)||"+"===e||"/"===e}function m(e){return a(e)||h(e)||"+"===e||"/"===e||"-"===e||"_"===e}function E(e){return h(e)||a(e)||"+"===e||"/"===e}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){T(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(s||(s={}));class v{consumeText(e,t){let n=t;for(;n<e.length;){const t=e[n];if("\0"===t||"\r"===t||t===i)break;n+=1}if(n-t==0)throw new Error("Invalid text, at ".concat(e));return n}consumeUnicastAddress(e,t,n){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,n){let i=t;for(;n(e[i]);)i++;if(i-t==0)throw new Error("Invalid rule at ".concat(t,"."));return i}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let n=t;for(let i=0;i<4;i++)if(n=this.consumeDecimalUChar(e,n),3!==i){if("."!==e[n])throw new Error("Invalid IP4 address.");n++}return n}consumeDecimalUChar(e,t){let n=t;for(let r=0;r<3&&a(e[n]);r++,n++);if(n-t==0)throw new Error("Invalid decimal uchar.");const i=parseInt(e.slice(t,n));if(i>=0&&i<=255)return n;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let n=this.consumeHexpart(e,t);return":"===e[n]?(n+=1,n=this.consumeIP4Address(e,n),n):n}consumeHexpart(e,t){let n=t;if(":"===e[n]&&":"===e[n+1]){n+=2;try{n=this.consumeHexseq(e,n)}catch(e){}return n}if(n=this.consumeHexseq(e,n),":"===e[n]&&":"===e[n+1]){n+=2;try{n=this.consumeHexseq(e,n)}catch(e){}return n}return n}consumeHexseq(e,t){let n=t;for(;n=this.consumeHex4(e,n),":"===e[n]&&":"!==e[n+1];)n+=1;return n}consumeHex4(e,t){let n=0;for(;n<4;n++)if(!((i=e[t+n])>="0"&&i<="9"||i>="a"&&i<="f"||i>="A"&&i<="F")){if(0===n)throw new Error("Invalid hex 4");break}var i;return t+n}consumeFQDN(e,t){let n=t;for(;a(e[n])||h(e[n])||"-"===e[n]||"."===e[n];)n+=1;if(n-t<4)throw new Error("Invalid FQDN");return n}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,n){switch(n){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(n){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const n=this.consumeHexpart(e,t);return"/"===e[n]?this.consumeInteger(e,n+1):n}consumeIP4MulticastAddress(e,t){let n=t+3;const i=e.slice(t,n),r=parseInt(i);if(r<224||r>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let o=0;o<3;o++){if("."!==e[n])throw new Error("Invalid IP4 multicast address.");n+=1,n=this.consumeDecimalUChar(e,n)}return"/"===e[n]&&(n+=1),n=this.consumeTTL(e,n),"/"===e[n]&&(n=this.consumeInteger(e,n)),n}consumeInteger(e,t){if(!u(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!u(e[t]))throw new Error("Invalid TTL.");t+=1;for(let n=0;n<2&&a(e[t]);n++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let n=t;if("0"===e[n])return n+1;for(u(e[n])&&(n+=1);a(e[n]);)n++;if(n-t<10)throw new Error("Invalid time");return n}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let n=t;return n=this.consumeOneOrMore(e,n,a),p(e[n])?n+1:n}consumeRepeatInterval(e,t){if(!u(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,n){for(let i=0;i<n.length;i++){if(t+i>=e.length)throw new Error("consume exceeding value length");if(e[t+i]!==n[i])throw new Error("consume ".concat(n," failed at ").concat(i))}return t+n.length}consumeTill(e,t,n){let i=t;for(;i<e.length&&("string"!=typeof n||e[i]!==n)&&("function"!=typeof n||!n(e[i]));)i++;return i}}class y extends v{constructor(){super(),T(this,"records",[]),T(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const n=this.parseVersion(),i=this.parseOrigin(),r=this.parseSessionName(),o=this.parseInformation(),s=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),u=this.parseTimeFields(),h=this.parseKey(),p=this.parseSessionAttribute(),f=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:n,origin:i,sessionName:r,information:o,uri:s,emails:a,phones:c,connection:d,bandwidths:l,timeFields:u,key:h,attributes:p,mediaDescriptions:f}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===i)return"\r"===e[t-1]?r:i;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const n=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:n,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new C;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==s.ATTRIBUTE)break;const n={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,n.attValue=this.extractOneOrMore(t,f)),e.parse(n),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new b(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==s.ATTRIBUTE)break;const n={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,n.attValue=this.extractOneOrMore(e,f)),t.parse(n),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===s.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===s.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const n=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let i=!1;"-"===e.value[e.cur]&&(i=!0,e.cur+=1);const r=this.extract(e,this.consumeTypedTime);t.push({time:n,typedTime:r,back:i})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==s.REPEAT)break;{const n=this.extract(t,this.consumeRepeatInterval),i=this.parseTypedTime(t);e.push({repeatInterval:n,typedTimes:i}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:n}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==s.BANDWIDTH)break;{const n=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const i=this.extractOneOrMore(t,a);e.push({bwtype:n,bandwidth:i}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==s.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==s.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const r=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:n,sessVersion:i,nettype:r,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===s.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==s.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===s.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==s.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==s.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===s.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:n,address:i}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let n=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,n+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const i=[];for(i.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,i.push(this.extract(e,this.consumeToken));if(0===i.length)throw new Error("Invalid proto");const r=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:n,protos:i,fmts:r}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===s.TIME;){const t=this.parseTime(),n=this.parseRepeat(),i=this.parseZone();e.push({time:t,repeats:n,zones:i})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===s.MEDIA;){const t=this.parseMedia(),n=this.parseInformation(),i=this.parseConnections(),r=this.parseBandWidth(),o=this.parseKey(),s=this.parseMediaAttributes(t);e.push({media:t,information:n,connections:i,bandwidths:r,key:o,attributes:s})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===s.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];const o=t.call(this,e.value,e.cur,...i),s=e.value.slice(e.cur,o);return e.cur=o,s}extractOneOrMore(e,t){const n=this.consumeOneOrMore(e.value,e.cur,t),i=e.value.slice(e.cur,n);return e.cur=n,i}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class R extends v{constructor(){super(...arguments),T(this,"attributes",void 0),T(this,"digested",!1)}extractOneOrMore(e,t,n){const i=this.consumeOneOrMore(e.attValue,e._cur,t),r=e.attValue.slice(e._cur,i),[o,s]=n||[];if("number"==typeof o&&r.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof s&&r.length>s)throw new Error("error in length, should be less or equal than ".concat(s," characters."));return e._cur=i,r}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t){if(!e.attValue)throw new Error("Nothing to extract from attValue.");for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];const o=t.call(this,e.attValue,e._cur,...i),s=e.attValue.slice(e._cur,o);return e._cur=o,s}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let n=0;n<t.length;n++)if(t[n]!==e.attValue[e._cur+n])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,_,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,_,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,_));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:n})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let n;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),n=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o),r=S(S({entry:parseInt(t,10)},n&&{direction:n}),{},{extensionName:i});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),r.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(r)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class C extends R{constructor(){super(...arguments),T(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),n=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),n.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:n})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,m)}parseIdentity(e){const t=this.extractOneOrMore(e,E),n=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const i=this.extractOneOrMore(e,(e=>e!==o&&f(e)));n.push({name:t,value:i})}this.attributes.identities.push({assertionValue:t,extensions:n})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const n=this.extract(e,this.consumeTill,o);t.identifierList.push(n)}}this.attributes.msidSemantic=t}}class b extends R{constructor(e){super(),T(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,_,[1,32]);this.consumeAttributeSpace(e);const n=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const r=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:n,transport:i,priority:r,connectionAddress:s,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const n=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const r=this.extract(e,this.consumePort);t.push({componentId:n,connectionAddress:i,port:r});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const i={encodingName:n,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),i.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const r=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));r?r.rtpMap=i:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:i,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,":");let i;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),i=this.extract(e,this.consumeTill));const r=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));r?r.attributes[n]=i:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[n]:i}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill),i={};n.split(";").forEach((e=>{let[t,n]=e.split("=");t=t.trim();const r="string"==typeof n?n.trim():null;"string"==typeof t&&t.length>0&&(i[t]=r)}));const r=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));r?r.fmtp={parameters:i}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:i}})}parseFmtParameters(e){const t={},n=this.extract(e,this.consumeTill,"=");e._cur++;const i=this.extract(e,this.consumeTill,";");for(t[n]=i;";"===e.attValue[e._cur];){const n=this.extract(e,this.consumeTill,"=");e._cur++;const i=this.extract(e,this.consumeTill,";");t[n]=i}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o);let i;if("trr-int"===n)i={type:n,interval:this.extract(e,this.consumeTill)};else{const t={type:n};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),i=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(i);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(i):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[i]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>h(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const n={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const n=this.extract(e,this.consumeToken);t.push(n);try{this.extract(e,this.consume,",")}catch(e){break}}n.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const i={type:t,rids:this.extract(e,this.consume,"=").split(",")};n.params.push(i);break}default:{const i={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),i.val=this.extract(e,this.consumeTill,";")),n.params.push(i)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(n)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),n=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);n.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:n})}}function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class w{constructor(){I(this,"eol",r)}print(e,t){let n="";return t&&(this.eol=t),n+=this.printVersion(e.version),n+=this.printOrigin(e.origin),n+=this.printSessionName(e.sessionName),n+=this.printInformation(e.information),n+=this.printUri(e.uri),n+=this.printEmail(e.emails),n+=this.printPhone(e.phones),n+=this.printConnection(e.connection),n+=this.printBandwidth(e.bandwidths),n+=this.printTimeFields(e.timeFields),n+=this.printKey(e.key),n+=this.printSessionAttributes(e.attributes),n+=this.printMediaDescription(e.mediaDescriptions),n}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const n of e)t+="e=".concat(n).concat(this.eol);return t}printPhone(e){let t="";for(const n of e)t+="e=".concat(n).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const n of e)t+="b=".concat(n.bwtype,":").concat(n.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const n of e){t+="t=".concat(n.time.startTime," ").concat(n.time.startTime).concat(this.eol);for(const e of n.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);n.zoneAdjustments&&(t+="z=",t+="z=".concat(n.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const n of e)t+="a=".concat(n.attField).concat(n.attValue?":".concat(n.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const n of e)t+=this.printMedia(n.media),t+=this.printInformation(n.information),t+=this.printConnections(n.connections),t+=this.printBandwidth(n.bandwidths),t+=this.printKey(n.key),t+=this.printMediaAttributes(n);return t}printConnections(e){let t="";for(const n of e)t+=this.printConnection(n);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new O(this.eol).print(e)}printMediaAttributes(e){return new N(this.eol).print(e)}}class A{constructor(e){I(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class O extends A{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class N extends A{print(e){const t=e.attributes;let n="";return n+=this.printRTCP(t.rtcp),n+=this.printIceUfrag(t.iceUfrag),n+=this.printIcePwd(t.icePwd),n+=this.printIceOptions(t.iceOptions),n+=this.printCandidates(t.candidates),n+=this.printRemoteCandidatesList(t.remoteCandidatesList),n+=this.printEndOfCandidates(t.endOfCandidates),n+=this.printFingerprints(t.fingerprints),n+=this.printSetup(t.setup),n+=this.printMid(t.mid),n+=this.printExtmap(t.extmaps),n+=this.printRTPRelated(t),n+=this.printPtime(t.ptime),n+=this.printMaxPtime(t.maxPtime),n+=this.printDirection(t.direction),n+=this.printSSRCGroups(t.ssrcGroups),n+=this.printSSRC(t.ssrcs),n+=this.printRTCPMux(t.rtcpMux),n+=this.printRTCPMuxOnly(t.rtcpMuxOnly),n+=this.printRTCPRsize(t.rtcpRsize),n+=this.printMSId(t.msids),n+=this.printImageattr(t.imageattr),n+=this.printRid(t.rids),n+=this.printSimulcast(t.simulcast),n+=this.printSCTPPort(t.sctpPort),n+=this.printMaxMessageSize(t.maxMessageSize),n+=this.printUnrecognized(t.unrecognized),n}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let n="";n+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const i of t)n+=this.printRtpMap(i.payloadType,i.rtpMap),n+=this.printFmtp(i.payloadType,i.fmtp),n+=i.rtcpFeedbacks.map((e=>this.printRTCPFeedback(i.payloadType,e))).join("");return n}printFmtp(e,t){if(!t)return"";const n=Object.keys(t.parameters);return 1===n.length&&null===t.parameters[n[0]]?"a=fmtp:".concat(e).concat(o).concat(n[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let n="a=rtcp-fb:".concat(e).concat(o),i=t;return"trr-int"===i.type?n+="ttr-int".concat(o).concat(i.interval):(n+="".concat(i.type),i.parameter&&(n+="".concat(o).concat(i.parameter),i.additional&&(n+="".concat(o).concat(i.additional)))),n+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function D(e){return(new y).parse(e)}function P(e,t){return(new w).print(e,t)}}},t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}return n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n(8)})()}(KP);var zP=KP.exports;function YP(e){if(Array.isArray(e))return e.map((e=>e));if(!qP(e))return e;const t={};for(const n in e){const i=e[n];qP(i)||Array.isArray(i)?t[n]=YP(i):t[n]=i}return t}function qP(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class JP{constructor(e){ih(this,"input",[]),ih(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const XP={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},QP={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:XP,remoteCandidate:XP}},ZP={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},$P={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},ek={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},tk={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function nk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ik(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nk(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nk(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class rk{constructor(e,t){ih(this,"onFirstVideoReceived",void 0),ih(this,"onFirstVideoDecoded",void 0),ih(this,"onFirstAudioReceived",void 0),ih(this,"onFirstVideoDecodedTimeout",void 0),ih(this,"onFirstAudioDecoded",void 0),ih(this,"onSelectedLocalCandidateChanged",void 0),ih(this,"onSelectedRemoteCandidateChanged",void 0),ih(this,"videoIsReady",!1),ih(this,"videoIsReady2",{}),ih(this,"pc",void 0),ih(this,"options",void 0),ih(this,"intervalTimer",void 0),ih(this,"stats",YP(QP)),ih(this,"isFirstVideoReceived",{}),ih(this,"isFirstVideoDecoded",{}),ih(this,"isFirstAudioReceived",{}),ih(this,"isFirstAudioDecoded",{}),ih(this,"isFirstVideoDecodedTimeout",{}),ih(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new tg((e=>{e({local:ik({},XP),remote:ik({},XP)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let i=0,r=0,o=0,s=0;for(const a of n)e[a].forEach(((e,n)=>{if(!this.lossRateWindowStats[t-1][a][n]||!this.lossRateWindowStats[0][a][n])return;const c=this.lossRateWindowStats[t-1][a][n].packets-this.lossRateWindowStats[0][a][n].packets,d=this.lossRateWindowStats[t-1][a][n].packetsLost-this.lossRateWindowStats[0][a][n].packetsLost;"videoSend"===a||"audioSend"===a?(i+=c,o+=d):(r+=c,s+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=i<=0||o<=0?0:o/(i+o),e.recvPacketLossRate=r<=0||s<=0?0:s/(r+s)}}function ok(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function sk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ok(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ok(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class ak extends rk{constructor(){super(...arguments),ih(this,"_stats",QP),ih(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=YP(QP);const n=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(n);const i=t.find((e=>"VideoBwe"===e.type));i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{var t;const n=Ai(t=e.id).call(t,"send");switch("".concat(e.mediaType,"_").concat(n?"send":"recv")){case"video_send":{const t=YP($P);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=YP(ZP),n=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),n){const i=n.stats,r=Date.now()-n.lts;t.framesDecodeFreezeTime=i.framesDecodeFreezeTime,t.framesDecodeInterval=i.framesDecodeInterval,t.framesDecodeCount>i.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=r,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:sk({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=YP(tk);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=YP(ek);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new tg(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t.push(n)})),t}}function ck(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function dk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ck(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ck(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class lk extends rk{constructor(){super(...arguments),ih(this,"_stats",QP),ih(this,"report",void 0),ih(this,"lastDecodeVideoReceiverStats",new Map),ih(this,"lastVideoFramesRecv",new Map),ih(this,"lastVideoFramesSent",new Map),ih(this,"lastVideoFramesDecode",new Map),ih(this,"lastVideoJBDelay",new Map),ih(this,"lastAudioJBDelay",new Map),ih(this,"mediaBytesSent",new Map),ih(this,"mediaBytesRetransmit",new Map),ih(this,"mediaBytesTargetEncode",new Map),ih(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=YP(QP),this.report.forEach((e=>{switch(e.type){case hR.OUTBOUND:case hR.INBOUND:{const t=e.mediaType||e.kind,n=!t&&"frameWidth"in e,i=!t&&!("frameWidth"in e);e.type===hR.OUTBOUND?"audio"===t||i?this.processAudioOutboundStats(e):("video"===t||n)&&this.processVideoOutboundStats(e):e.type===hR.INBOUND&&("audio"===t||i?this.processAudioInboundStats(e):("video"===t||n)&&this.processVideoInboundStats(e));break}case hR.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case hR.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:dk({},XP),remote:dk({},XP)};return e.forEach((n=>{let i;if(n.type===hR.TRANSPORT&&(i=e.get(n.selectedCandidatePairId)),n.type===hR.CANDIDATE_PAIR&&n.selected&&(i=n),i){const n=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(i.localCandidateId){const r=e.get(i.localCandidateId);r&&n(t.local,r)}if(i.remoteCandidateId){const r=e.get(i.remoteCandidateId);r&&n(t.remote,r)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===hR.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===hR.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===hR.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(dk({},t),dk({},this.stats.selectedCandidatePair.localCandidate)),e.type===hR.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(dk({},t),dk({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=YP(tk),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=YP(ZP),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const n=this.lastDecodeVideoReceiverStats.get(t.ssrc),i=this.lastVideoFramesDecode.get(t.ssrc),r=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,n=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,n),this.isFirstVideoDecoded[t.ssrc]=!0}if(n){const i=n.stats,o=r-n.lts;t.framesDecodeFreezeTime=i.framesDecodeFreezeTime,t.framesDecodeInterval=i.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&o>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>i.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=o,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-n.qpSum)/(e.framesDecoded-n.stats.framesDecodeCount))}i&&r-i.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-i.count)/((r-i.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:r,rate:t.decodeFrameRate})):i?t.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:r,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:dk({},t),lts:n?n.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=YP($P),this._stats.videoSend.push(t));const n=this.mediaBytesSent.get(e.ssrc);if(n)n.add(e.bytesSent);else{const t=new JP(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new JP(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new JP(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const n=this.lastEncoderMs.get(e.ssrc);if(!n||n.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const i=e.framesEncoded-n.lastFrameCount,r=e.totalEncodeTime-n.lastEncoderTime;t.avgEncodeMs=1e3*r/i}}if(e.framesEncoded&&e.qpSum){const n=this.lastEncoderMs.get(e.ssrc);!n||n.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-n.lastQpSum)/(e.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,hR.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=YP(ek),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,hR.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}findRemoteStatsId(e,t){var n;const i=Array.from(MR(n=this.report).call(n)).find((n=>n.type===t&&n.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const n=this.report.get(e);n&&n.width&&n.height&&n.framesPerSecond&&(t.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(e,t){const n=this.report.get(e);n&&(t.inputLevel=n.audioLevel)}processVideoTrackSenderStats(e,t,n){var i,r,o,s;const a=t?this.report.get(t):void 0,c=null!==(i=null==a?void 0:a.framesSent)&&void 0!==i?i:e.framesSent;if("number"!=typeof c)return;let d=null!==(r=null==a?void 0:a.frameWidth)&&void 0!==r?r:e.frameWidth,l=null!==(o=null==a?void 0:a.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(s=null==a?void 0:a.framesPerSecond)&&void 0!==s?s:e.framesPerSecond;if("number"==typeof d&&"number"==typeof l||(d=0,l=0),null==u){const e=Date.now(),t=this.lastVideoFramesSent.get(n.ssrc);t&&e-t.lts>=800?(u=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:e,rate:u})):t?u=t.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:e,rate:0})}n.sentFrame={width:d,height:l,frameRate:Math.max(0,u)}}processVideoTrackReceiverStats(e,t,n){var i,r,o,s,a;const c=t?this.report.get(t):void 0,d=null!==(i=null==c?void 0:c.framesReceived)&&void 0!==i?i:e.framesReceived,l=null!==(r=null==c?void 0:c.frameWidth)&&void 0!==r?r:e.frameWidth,u=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,h=null!==(s=null==c?void 0:c.jitterBufferDelay)&&void 0!==s?s:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(n.ssrc),t=Date.now();n.framesReceivedCount=d;let i=0;e&&t-e.lts>=800?(i=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:t,rate:i})):e?i=e.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:t,rate:0}),n.receivedFrame={width:l||0,height:u||0,frameRate:i||0},n.decodedFrame={width:l||0,height:u||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:l||0,height:u||0,frameRate:n.decodeFrameRate||0}}if(h&&p){const e=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const i=p-e.jitterBufferEmittedCount;i>0&&(t=1e3*(h-e.jitterBufferDelay)/i),n.jitterBufferMs=t,n.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:p,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(e,t,n){var i,r,o,s;const a=t?this.report.get(t):void 0,c=null!==(i=null!==(r=null==a?void 0:a.echoReturnLoss)&&void 0!==r?r:e.echoReturnLoss)&&void 0!==i?i:0,d=null!==(o=null!==(s=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==s?s:e.echoReturnLossEnhancement)&&void 0!==o?o:0;n.aecReturnLoss=c,n.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,n){var i,r,o,s,a,c,d;const l=t?this.report.get(t):void 0,u=null!==(i=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==i?i:e.removedSamplesForAcceleration,h=null!==(r=null==l?void 0:l.totalSamplesReceived)&&void 0!==r?r:e.totalSamplesReceived,p=null!==(o=null==l?void 0:l.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,f=null!==(s=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==s?s:e.jitterBufferEmittedCount,_=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,m=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,E=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(u&&h&&(n.accelerateRate=u/h),p&&f){const e=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const i=f-e.jitterBufferEmittedCount;i>0&&(t=1e3*(p-e.jitterBufferDelay)/i),n.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:f,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=_;let g=1920;m&&h&&(g=h/m/50,n.receivedFrames=Math.round(h/g)),E&&(n.droppedFrames=Math.round(E/g))}processRemoteInboundStats(e,t){const n=this.report.get(e);n&&(t.packetsLost=n.packetsLost,n.roundTripTime&&(t.rttMs=1e3*n.roundTripTime),n.jitter&&(t.jitterMs=1e3*n.jitter),n.timestamp&&(t.timestamp=n.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const n=t.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let e=0,t=null,n=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{n=null===n?e.diffMean():n+e.diffMean()}));const i=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==n&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}}class uk extends rk{updateStats(){return tg.resolve()}}function hk(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new ak(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new lk(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof tg}(e)?new lk(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new uk(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}function pk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function fk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pk(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pk(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _k(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=n;let l=[],u=[],h=[],p=[],f=!1,_=!1;if(zP.parse(e).mediaDescriptions.forEach((e=>{i&&i!==e.attributes.direction||("video"!==e.media.mediaType||f||(u=e.attributes.payloads,p=e.attributes.extmaps,f=!0),"audio"!==e.media.mediaType||_||(l=e.attributes.payloads,h=e.attributes.extmaps,_=!0))})),!p||0===u.length)throw new Error("Cannot get video capabilities from SDP.");if(!h||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");u.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),r&&(l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),u=u.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(u=u.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),s&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(l=l.filter((e=>{var t;return Ai(a).call(a,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0&&(u=u.filter((e=>{var t;return Ai(c).call(c,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")})));const m=Dy("UNSUPPORTED_VIDEO_CODEC");return m&&m.length>0&&(u=u.filter((e=>!(e.rtpMap&&Ai(m).call(m,e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:l,videoCodecs:u,audioExtensions:h,videoExtensions:p}}function mk(e){const t=zP.parse(e);let n,i;for(const r of t.mediaDescriptions){if(!n){const e=r.attributes.iceUfrag,t=r.attributes.icePwd;if(!e||!t)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:e,icePwd:t}}if(!i){const e=r.attributes.fingerprints;e.length>0&&(i={fingerprints:e})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function Ek(e,t){const n=[],i=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),r=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(r)r.ssrcIds.forEach((e=>{var r;const o=null===(r=i.find((t=>t.ssrcIds[0]===e)))||void 0===r?void 0:r.ssrcIds[1];n.push({ssrcId:e,rtx:t?o:void 0})}));else if(i.length>0){const e=i[0].ssrcIds[0],r=i[0].ssrcIds[1];n.push({ssrcId:e,rtx:t?r:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function gk(e,t){const{cname:n}=e;let i;t&&t.ip&&"number"==typeof t.port?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],zy.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),zy.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):i=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const r={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let s;switch(e.dtlsParameters.role){case"server":s="passive";break;case"client":s="active";break;case"auto":s="actpass"}return{dtlsParameters:r,iceParameters:o,candidates:i,rtpCapabilities:Ok(e.rtpCapabilities),setup:s,cname:n}}function Sk(e,t,n){const i=[],r=[];return e.forEach((e=>{let{ssrcId:o,rtx:s}=e;const a=xS(8,"track-"),c={ssrcId:o,attributes:fk({label:a,mslabel:n=n||xS(10,""),msid:"".concat(n," ").concat(a)},t&&{cname:t})};if(i.push(c),void 0!==s){const e={ssrcId:s,attributes:fk({label:a,mslabel:n,msid:"".concat(n," ").concat(a)},t&&{cname:t})};i.push(e),r.push({semantic:"FID",ssrcIds:[o,s]})}})),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:i,ssrcGroups:r}}function Tk(e,t){t instanceof cA&&e.attributes.payloads.forEach((e=>{var n;const i=null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase();if(!i||-1===["opus","pcmu","pcma","g722"].indexOf(i))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const r=t._encoderConfig;r&&"pcmu"!==i&&"pcma"!==i&&"g722"!==i&&(r.bitrate&&!vg()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*r.bitrate))),r.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(r.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(r.sampleRate)),r.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function vk(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function yk(e,t){var n;if(!(t instanceof NA&&t._encoderConfig&&-1===t._hints.indexOf(zI.SCREEN_TRACK)))return;const i=t._encoderConfig;AI().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((e=>{var t,n;Ai(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),AI().supportMinBitrate&&!Ai(n=t._hints).call(n,zI.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((e=>{var t,n;Ai(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(Dy("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function Rk(e){if("video"!==e.media.mediaType)return;const t=pg();if(t.name!==cg.SAFARI&&t.os!==ag.IOS)return;const n=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==n&&e.attributes.extmaps.splice(n,1)}function Ck(e,t,n){if(!t)return;let i,r;if("video"===e.media.mediaType?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),!0===t.twcc){const t=i.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const n=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(r,e.attributes.payloads);n.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=i.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const n=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(r,e.attributes.payloads);n.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function bk(e,t,n){if(vg())return;if("video"!==e.media.mediaType)return;if(!(t instanceof NA))return;if("vp9"!==n&&"vp8"!==n)return;if("vp8"===n&&!Dy("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const i="vp8"===n?2:t._scalabilityMode.numSpatialLayers,r=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===r.ssrcId)),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:wS(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:wS(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));e.attributes.ssrcGroups.unshift(s)}async function Ik(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const i=_k(n,e,t,"sendonly"),r=_k(n,e,t,"recvonly"),o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ak(i,r,"videoExtensions",o,s,a),Ak(i,r,"videoCodecs",o,s,a),Ak(i,r,"audioExtensions",o,s,a),Ak(i,r,"audioCodecs",o,s,a),Dy("RAISE_H264_BASELINE_PRIORITY")){const e=a.videoCodecs.findIndex((e=>{var t,n;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])}));if(-1!==e){const t=a.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(t<e){zy.debug("raising H264 baseline profile priority");const n=a.videoCodecs[e];a.videoCodecs.splice(e,1),a.videoCodecs.splice(t,0,n)}-1!==t&&(s.videoCodecs=s.videoCodecs.filter((e=>{var t,n;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"]))}))),-1!==t&&Dy("FILTER_SEND_H264_BASELINE")&&(o.videoCodecs=o.videoCodecs.filter((e=>{var t,n;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"]))})))}}return{send:o,recv:s,sendrecv:a}}(e,t,i);try{n.close()}catch(e){}return{send:r,recv:o,sendrecv:s}}function wk(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=_k(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ak(e,t,"videoExtensions",n,i,r),Ak(e,t,"videoCodecs",n,i,r),Ak(e,t,"audioExtensions",n,i,r),Ak(e,t,"audioCodecs",n,i,r),Dy("RAISE_H264_BASELINE_PRIORITY")){const e=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){zy.debug("raising H264 baseline profile priority");const n=r.videoCodecs[e];r.videoCodecs.splice(e,1),r.videoCodecs.splice(t,0,n)}-1!==t&&(i.videoCodecs=i.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:i,sendrecv:r}}function Ak(e,t,n,i,r,o){if("videoExtensions"===n||"audioExtensions"===n){const s=[];return e[n].forEach((e=>{t[n].some(((t,n)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return s.push(n),!0}))?o[n].push(e):i[n].push(e)})),void t[n].forEach(((e,t)=>{-1===s.indexOf(t)&&r[n].push(e)}))}if("videoCodecs"===n||"audioCodecs"===n){const s=[];return e[n].forEach((e=>{t[n].some(((t,n)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return s.push(n),!0}))?o[n].push(e):i[n].push(e)})),void t[n].forEach(((e,t)=>{-1===s.indexOf(t)&&r[n].push(e)}))}}function Ok(e){const{send:t,recv:n,sendrecv:i}=e;if(!i){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let r,o;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...i.audioCodecs],r.videoCodecs=[...t.videoCodecs,...i.videoCodecs],r.audioExtensions=[...t.audioExtensions,...i.audioExtensions],r.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):r=i,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...i.audioCodecs],o.videoCodecs=[...n.videoCodecs,...i.videoCodecs],o.audioExtensions=[...n.audioExtensions,...i.audioExtensions],o.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):o=i,{send:r,recv:o}}function Nk(e){"audio"===e.media.mediaType&&e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function Dk(e){e.mediaDescriptions.forEach((e=>{"video"!==e.media.mediaType&&"audio"!==e.media.mediaType||e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))}))}function Pk(e,t,n,i){let r=[];if(e===hC.VIDEO){if(Dy("H264_PROFILE_LEVEL_ID")&&"h264"===i&&(r=t.videoCodecs.filter((e=>{var t;return Ai(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,i)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===Dy("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(r)||0===r.length){let e=[];const o=[],s=[];n.videoCodecs.forEach((t=>{var n,r,a;Ai(n=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(n,i)&&e.push(t),Ai(r=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(r,"vp8")&&o.push(t),Ai(a=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(a,"h264")&&s.push(t)})),0===e.length&&(0!==o.length?(e=o,zy.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: vp8"))):0!==s.length&&(e=s,zy.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: h264")))),0!==e.length&&(r=t.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(Dy("USE_PUB_RTX")){const e=r.map((e=>e.payloadType.toString())),n=t.videoCodecs.filter((t=>t.rtpMap&&"rtx"===t.rtpMap.encodingName&&Ai(e).call(e,t.fmtp&&t.fmtp.parameters.apt||"")));r=[...r,...n]}0===r.length&&(zy.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs)}else r=t.audioCodecs.filter((e=>{var t;return Ai(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,i)})),0===r.length&&(zy.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter((e=>{var t;return Ai(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,"opus")})));return r}let kk=class{get localCapabilities(){return wS(this._localCapabilities)}get rtpCapabilities(){return wS(this._rtpCapabilities)}get candidates(){return wS(this._candidates)}get iceParameters(){return wS(this._iceParameters)}get dtlsParameters(){return wS(this._dtlsParameters)}constructor(e){ih(this,"sessionDesc",void 0),ih(this,"_localCapabilities",void 0),ih(this,"_rtpCapabilities",void 0),ih(this,"_candidates",void 0),ih(this,"_iceParameters",void 0),ih(this,"_dtlsParameters",void 0),ih(this,"setup",void 0),ih(this,"currentMidIndex",void 0),ih(this,"cname","o/i14u9pJrxRKAsu"),ih(this,"firefoxSsrcMidMap",new Map),e=wS(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=e;let l;this.setup=a,l=s===CR.RECEIVE_ONLY?zP.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):zP.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=o;const u=s===CR.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=s===CR.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=s===CR.RECEIVE_ONLY?r.send.videoCodecs:Pk(hC.VIDEO,u,h,c),f=s===CR.RECEIVE_ONLY?r.send.audioCodecs:Pk(hC.AUDIO,u,h,d);for(const _ of l.mediaDescriptions){if(_.attributes.iceUfrag=t.iceUfrag,_.attributes.icePwd=t.icePwd,_.attributes.fingerprints=n.fingerprints,_.attributes.candidates=i,_.attributes.setup=this.setup,"application"===_.media.mediaType&&(_.attributes.sctpPort="5000"),"video"===_.media.mediaType&&(_.media.fmts=p.map((e=>e.payloadType.toString(10))),_.attributes.payloads=p,_.attributes.extmaps=u.videoExtensions,Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:4e4,rtx:Dy("USE_SUB_RTX")?40001:void 0}],this.cname);_.attributes.ssrcs=e,_.attributes.ssrcGroups=t}if("audio"===_.media.mediaType&&(_.media.fmts=f.map((e=>e.payloadType.toString(10))),_.attributes.payloads=f,_.attributes.extmaps=u.audioExtensions,Nk(_),Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:2e4}],this.cname);_.attributes.ssrcs=e,_.attributes.ssrcGroups=t}}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return zP.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:s}=Sk(t,this.cname,Dy("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(vg()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o,i);let n;return-1===t?(n=this.createOrRecycleSendMedia(e,o,s,"sendonly",i,r),this.updateBundleMids()):(n=wS(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=o,n.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,r)),vg()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,n.attributes.mid),{needExchangeSDP:!0,mid:n.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,n){const i=[];return e.forEach((e=>{const r=e._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(r);let s,a=!1;-1===o?(a=!0,s=this.createOrRecycleRecvMedia(e,[],"recvonly",t,n),this.updateBundleMids()):(s=wS(this.sessionDesc.mediaDescriptions[o]),s.attributes.direction="recvonly"),i.push({mid:s.attributes.mid,needCreateTransceiver:a})})),i}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:n,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(e),d={foundation:null!=t?t:"",componentId:"1",transport:null!=n?n:"",priority:c?c+"":"",connectionAddress:null!=i?i:"",port:r?r+"":"",type:o?o+"":"",relAddr:null!=s?s:"",relPort:a?a+"":"",extension:{}};this.candidates.some((e=>e.priority===d.priority&&e.connectionAddress===d.connectionAddress&&e.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,n,i,r){const o=e._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=Pk(o,s,this.localCapabilities.send,o===hC.AUDIO?r:i),c=o===hC.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const u=this.findFirstClosedMedia(o);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ai(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ai(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,n){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const r=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(vg()){if(r){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const n=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&n}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}restartICE(e){e=wS(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,n,i,r,o){const s=this.rtpCapabilities.send,a=e===hC.VIDEO?s.videoCodecs:s.audioCodecs,c=e===hC.VIDEO?s.videoExtensions:s.audioExtensions;vg()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,n){const i=wS(e);return vk(i),Tk(i,t),yk(i,t),Rk(i),Ck(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=wS(e);return Ck(n,t,this.localCapabilities.recv),Nk(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>vg()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const Lk=["sdp"];function Mk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Uk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mk(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mk(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let xk=class e extends LC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,n,i){super(t,n),ih(this,"direction",void 0),ih(this,"name",void 0),ih(this,"store",void 0),ih(this,"spec",void 0),ih(this,"peerConnection",void 0),ih(this,"initialOffer",void 0),ih(this,"transport",void 0),ih(this,"statsFilter",void 0),ih(this,"localCandidateCount",0),ih(this,"allCandidatesReceived",!1),ih(this,"localCandidateAddress",null),ih(this,"useXR",Dy("USE_XR")),ih(this,"filter",{filterRTX:!Dy("USE_PUB_RTX")&&!Dy("USE_SUB_RTX"),filterVideoFec:Dy("FILTER_VIDEO_FEC"),filterAudioFec:Dy("FILTER_AUDIO_FEC")}),ih(this,"extension",{useXR:this.useXR}),ih(this,"_isInRestartIce",!1),ih(this,"mutex",new zS("P2PConnection-mutex")),ih(this,"onLocalCandidate",void 0),ih(this,"remoteSDP",void 0),ih(this,"pendingCandidates",[]),ih(this,"localCapabilities",void 0),ih(this,"isReady",!1),ih(this,"restartCnt",0),ih(this,"curTurnServerIndex",0),this.store=n,this.spec=t,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=i?i:CR.SEND_ONLY,this.name=this.direction===CR.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=hk(this.peerConnection,Dy("STATS_UPDATE_INTERVAL"),void 0,vg()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const t=await Ik(this.filter,this.extension);if(this.localCapabilities=Ok(t),e){const{sdp:t}=e,n=HP(e,Lk),i=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=_k(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ak(t,e,"videoExtensions",n,i,r),Ak(t,e,"videoCodecs",n,i,r),Ak(t,e,"audioExtensions",n,i,r),Ak(t,e,"audioCodecs",n,i,r),Dy("RAISE_H264_BASELINE_PRIORITY")){const e=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){zy.debug("raising H264 baseline profile priority");const n=r.videoCodecs[e];r.videoCodecs.splice(e,1),r.videoCodecs.splice(t,0,n)}-1!==t&&Dy("FILTER_SEND_H264_BASELINE")&&(n.videoCodecs=n.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:i,sendrecv:r}}(this.filter,this.extension,t);this.remoteSDP=new kk({remoteIceParameters:n.iceParameters,remoteDtlsParameters:n.dtlsParameters,candidates:[],remoteRTPCapabilities:i,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const r=await this.peerConnection.createAnswer();if(!r.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const o=mk(r.sdp);await this.peerConnection.setLocalDescription(r);const s=await wk(this.filter,this.extension,r.sdp);this.localCapabilities=Ok(s);const a=this.peerConnection.getTransceivers()[0];return null!=a&&a.receiver&&a.receiver.transport&&this.tryBindTransportEvents(a.receiver.transport),Uk(Uk({},o),{},{sdp:r.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=mk(e.sdp);return this.initialOffer=e,Uk(Uk({},t),{},{sdp:e.sdp})}}catch(e){throw new Vg(xg.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:n,dtlsParameters:i}=e,r=await wk(this.filter,this.extension,t);this.remoteSDP=new kk({remoteIceParameters:n,remoteDtlsParameters:i,candidates:[],remoteRTPCapabilities:r,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];null!=o&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new Vg(xg.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,n){var i=this;return OP((function*(){const r=yield TP(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const r=[],o=i.remoteSDP.receive(e,t,n);e.forEach(((e,t)=>{if(o[t].needCreateTransceiver){const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});r.push(t),e._updateRtpTransceiver(t)}else{const n=i.peerConnection.getTransceivers().find((e=>e.mid===o[t].mid));if(!n)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(o[t].mid));r.push(n),e._updateRtpTransceiver(n)}})),vg()&&!0===Dy("SIMULCAST")&&(yield TP(i.applySimulcastForFirefox(r,e)));const s=o.map((e=>e.mid)),a=yield TP(i.peerConnection.createOffer()),c=i.mungSendOfferSDP(a.sdp,e,s),d=zP.parse(c),l=s.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Ek(t,Dy("USE_PUB_RTX"))})),u=r.map(((e,t)=>{const n=s[t];return{localSSRC:l[t],id:n}}));yield TP(i.peerConnection.setLocalDescription({type:"offer",sdp:c}));try{yield u}catch(e){const n=i.remoteSDP.toString();throw yield TP(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield TP(i.peerConnection.setRemoteDescription({type:"answer",sdp:n})),yield TP(i.stopSending(s,!0)),e}yield TP(i.applySimulcastEncodings(r,e)),yield TP(i.applySendEncodings(r,e));const h=i.remoteSDP.toString(),p=i.logSDPExchange(c,"offer","local","send");return null==p||p(h),yield TP(i.setRemoteDescription({type:"answer",sdp:h})),r.map(((e,t)=>{const n=s[t];return{localSSRC:l[t],id:n}}))}catch(e){throw e instanceof Vg?e:new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==i||i(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),zy.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else zy.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const s=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!s||null===s.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,mid:s.mid,transceiver:s}}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),zy.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else zy.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===wy.Auto&&(this.store.p2pTransport=wy.SdRtn,AI().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,AI().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=mk(e.sdp);return this.store.descriptionStart(),this.direction===CR.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===CR.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=mk(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?vg()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:n,remote:i}=t.getSelectedCandidatePair();return{local:Uk(Uk({},XP),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:Uk(Uk({},XP),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,t;Ai(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{var t;e.candidate?(e.candidate.candidate&&(this.localCandidateAddress=e.candidate.address,null===(t=this.onLocalCandidate)||void 0===t||t.call(this,e.candidate.toJSON())),this.localCandidateCount+=1):(this.allCandidatesReceived=!0,zy.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,n){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const r={iceServers:[]};var o;return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(fS(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers,n,i)),Dy("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway,n,i)),Ai(o=[wy.Relay,wy.SdRtn]).call(o,n)&&(r.iceTransportPolicy="relay"),Dy("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(r.iceTransportPolicy="relay")})))),Dy("ENABLE_ENCODED_TRANSFORM")&&AI().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),zy.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i=[],r=e.filter((e=>e.tcpport));zy.debug("P2PConnection turnServers is ".concat(r,", current index is ").concat(n));const o=r.length>n?r[n]:r[0];switch(t){case wy.SdRtn:const t=e.filter((e=>{var t;return Ai(t=e.username).call(t,"glb:")&&e.turnServerURL==e.turnServerURL})),r=t.length>n?t[n]:t[0];r&&(i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(Rb(r.turnServerURL),":").concat(r.tcpport,"?transport=udp")}),i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(Rb(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}));break;case wy.Relay:o&&(i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(Rb(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(Rb(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),i.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return i}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const t=e.iceTransport;t&&(t.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var n;t&&(null===(n=this.onICETransportStateChange)||void 0===n||n.call(this,t))},t.getSelectedCandidatePair&&(t.onselectedcandidatepairchange=()=>{if(t.getSelectedCandidatePair()){const{local:e,remote:n}=t.getSelectedCandidatePair();zy.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var n;if(t||(t=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))),!t)return zy.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return zy.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!AI().supportSetRtpSenderParameters)return zy.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},r={};switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(e._encoderConfig){var o;const{bitrateMax:t,frameRate:n,scaleResolutionDownBy:i}=e._encoderConfig;t&&(r.maxBitrate=1e3*t),Ai(o=e._hints).call(o,zI.LOW_STREAM)&&(n&&(r.maxFramerate=bb(n)),i&&i>=1&&(r.scaleResolutionDownBy=i))}if(Dy("DSCP_TYPE")&&Lg()){var s;const e=Dy("DSCP_TYPE");Ai(s=["very-low","low","medium","high"]).call(s,e)&&(r.networkPriority=e)}const a=t.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];vg()&&!c&&(i.encodings=[r]),c&&Object.assign(c,r),Object.assign(a,i),zy.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await t.setParameters(a)}async applySendEncodings(e,t){try{if(!AI().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){const i=e[n],r=t[n];r instanceof NA&&!this.isVP8Simulcast(r)&&await this.updateRtpSenderEncodings(r,i.sender)}}catch(e){zy.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,n){const i=zP.parse(e);return t.forEach(((e,t)=>{const r=n[t],o=i.mediaDescriptions.find((e=>e.attributes.mid===r));o&&(Tk(o,e),bk(o,e,this.store.codec))})),zP.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var n,i,r,o,s;const c=e[a],d=t[a];if(d instanceof NA&&!Ai(n=d._hints).call(n,zI.LOW_STREAM)&&null!==(i=d._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(r=d._encoderConfig)||void 0===r?void 0:r.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=d._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=c.sender.getParameters();await c.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!vg()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof NA&&this.isVP8Simulcast(i)){const t=e[n],r={},o={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,r))}}}isVP8Simulcast(e){var t,n,i,r,o;return!!(e instanceof NA&&Dy("SIMULCAST")&&"vp8"===this.store.codec&&!Ai(t=e._hints).call(t,zI.LOW_STREAM)&&null!==(n=e._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(r=e._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,t,n,i){if(Dy("SDP_LOGGING"))return zy.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(t," SDP during P2PConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var n,i;if(t=null!==(n=t)&&void 0!==n?n:null===(i=this.currentRemoteDescription)||void 0===i?void 0:i.sdp){var r;const n=null===(r=zP.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===r?void 0:r.attributes.ssrcs;return null==n?void 0:n[0].ssrcId}}async setRemoteDescription(e){var t;await this.peerConnection.setRemoteDescription(e),Ai(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,n){const i=zP.parse(e),r=i.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&(n===hC.AUDIO&&"audio"===r.media.mediaType&&Nk(r),this.useXR&&Dk(i)),zP.print(i)}};function Vk(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function Fk(e,t){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=bb(t.width),i.height=bb(t.height);const r=bb(t.framerate||15);document.body.append(n),document.body.append(i);let o=e._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();const s=i.getContext("2d");if(!s)throw new VR(xg.UNEXPECTED_ERROR,"can not get canvas context");const a=AI(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const e=n.videoWidth,t=n.videoHeight/e,r=i.width*t;Math.abs(r-i.height)>=2&&(zy.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(r)),i.height=r)}s.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==e._mediaStreamTrack&&(o=e._mediaStreamTrack,n.srcObject=new MediaStream([o]))},i.stopCapture=Cw((()=>i.startCapture&&i.startCapture()),r);const d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),zy.debug("clean low stream renderer")},c}var jk,Bk,Gk,Wk,Hk,Kk,zk,Yk,qk,Jk,Xk;UR([Vk,xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],xk.prototype,"establish",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],xk.prototype,"connect",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[String,Array,String,String]),xR("design:returntype",tg)],xk.prototype,"receive",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[String,Array,String,String]),xR("design:returntype",tg)],xk.prototype,"mockReceive",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],xk.prototype,"stopReceiving",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],xk.prototype,"restartICE",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],xk.prototype,"close",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],xk.prototype,"updateEncoderConfig",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],xk.prototype,"updateSendParameters",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[fw,String]),xR("design:returntype",tg)],xk.prototype,"replaceTrack",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],xk.prototype,"muteLocal",null),UR([Vk,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],xk.prototype,"unmuteLocal",null),function(e){e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH"}(jk||(jk={})),function(e){e[e.HEIGHT=2072]="HEIGHT",e[e.FRAME_RATE=2074]="FRAME_RATE",e[e.WIDTH=2076]="WIDTH"}(Bk||(Bk={})),function(e){e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM"}(Gk||(Gk={})),function(e){e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH"}(Wk||(Wk={})),function(e){e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(Hk||(Hk={})),function(e){e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}(Kk||(Kk={})),function(e){e[e.PCM_LEVEL=2104]="PCM_LEVEL"}(zk||(zk={})),function(e){e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED"}(Yk||(Yk={})),function(e){e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(qk||(qk={})),function(e){e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL"}(Jk||(Jk={})),function(e){e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE"}(Xk||(Xk={}));const Qk=1e3,Zk=3;function $k(e,t,n){null!=n&&Number.isFinite(n)&&(e[t]=Math.round(Math.max(0,n)))}function eL(e){const t={[Xk.CONN_TYPE]:0,[Xk.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===n&&(t[Xk.CONN_TYPE]=1),"tcp"===n&&(t[Xk.CONN_TYPE]=3),"tls"===n&&(t[Xk.CONN_TYPE]=4);break}case"srflx":t[Xk.CONN_TYPE]=2}return t}class tL extends nS{constructor(e){super(),ih(this,"store",void 0),ih(this,"uploadWRTCStatsTimer",void 0),ih(this,"uploadOutboundDenoiserStatsTimer",void 0),ih(this,"uploadExtStatsTimer",void 0),ih(this,"uploadExtUsageStatsTimer",void 0),ih(this,"uploadInboundExtStatsTimer",void 0),ih(this,"requestStats",void 0),ih(this,"requestTransportStats",void 0),ih(this,"requestLocalMedia",void 0),ih(this,"requestRemoteMedia",void 0),ih(this,"requestAllTracks",void 0),ih(this,"requestVideoIsReady",void 0),ih(this,"requestUploadStats",void 0),ih(this,"requestUpload",void 0),ih(this,"uploadOutboundStarted",!1),ih(this,"uploadInboundStarted",!1),ih(this,"uploadTransportStarted",!1),ih(this,"uploadExtensionUsageStarted",!1),ih(this,"lastRecvStats",void 0),ih(this,"lastSendStats",void 0),ih(this,"lastFullRecvStats",void 0),ih(this,"lastFullSendStats",void 0),ih(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t,n;if(this.uploadTransportStarted&&(t=this.requestStats(),this.store.useP2P&&(n=this.requestStats(!0))),!t&&this.uploadOutboundStarted&&(t=this.requestStats()),!n&&this.uploadInboundStarted&&(n=this.requestStats(!0)),t||n){const i={};if(this.uploadTransportStarted&&t){const r=this.getTransportStats(t,n,e);r&&(i.misc=[r])}if(this.uploadOutboundStarted&&t){const n=this.getOutboundStats(t,e?this.lastSendStats:this.lastFullSendStats,e);n&&(i.outbound=[n])}if(this.uploadInboundStarted&&n){const t=this.getInboundStats(n,e?this.lastRecvStats:this.lastFullRecvStats,e);t&&(i.inbound=t)}this.requestUploadStats(i)}this.lastRecvStats=n,this.lastSendStats=t,e||(this.lastFullRecvStats=n,this.lastFullSendStats=t)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==Zk),++e===Zk+1&&(e=1)}),Qk)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,n){if(!this.requestStats)return;if(n)return null==e.rtt?void 0:{addition:{[Xk.RTT]:e.rtt,[Xk.CONN_TYPE]:void 0}};const i=eL(e);if(this.store.useP2P){if(t){const e=eL(t);i[Xk.CONN_TYPE]+=e[Xk.CONN_TYPE]<<3}i[Xk.CONN_TYPE]+=110}else i[Xk.CONN_TYPE]+=100;return{addition:i}}getOutboundStats(e,t,n){if(!this.requestUploadStats||!this.requestLocalMedia)return;const i=this.requestLocalMedia();if(!i||0===i.length)return;let r,o,s;return i.forEach((i=>{let[a,{track:c,ssrcs:d}]=i;switch(a){case _C.LocalVideoLowTrack:case _C.LocalVideoTrack:if(a===_C.LocalVideoTrack){const i=function(e,t,n,i,r){const o=t.videoSend.find((t=>t.ssrc===e));if(!o)return;const s={},{sentFrame:a,inputFrame:c}=o;if(c&&a){const e=c.frameRate,t=a.frameRate;s[Gk.FREEZE]=function(e,t){let n=!0;return n=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),n}(e,t)?1:0}if($k(s,Gk.QP_SUM,o.qpSumPerFrame),r)return s;switch(a&&($k(s,Gk.HEIGHT,a.height),$k(s,Gk.WIDTH,a.width),$k(s,Gk.FRAME_RATE,a.frameRate)),s[Gk.DISABLED]=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?1:0,o.adaptionChangeReason){case"none":s[Gk.ADAPTATION]=0;break;case"cpu":s[Gk.ADAPTATION]=1;break;case"bandwidth":s[Gk.ADAPTATION]=2;break;case"other":s[Gk.ADAPTATION]=3}s[Gk.PLAYER_STATUS]=uw[i._player?i._player.videoElementStatus:"uninit"],$k(s,Gk.NACKS,o.nacksCount),$k(s,Gk.PLIS,o.plisCount),$k(s,Gk.FIRS,o.firsCount),$k(s,Gk.AVG_ENCODE,o.avgEncodeMs);const d=n&&n.videoSend.find((t=>t.ssrc===e));if(d){let e=r?Qk:Qk*Zk;d.timestamp&&o.timestamp&&(e=o.timestamp-d.timestamp),null!=d.packets&&null!=o.packets&&$k(s,Gk.PACKAGE_RATE,1e3*(o.packets-d.packets)/e),null!=o.packetsLost&&null!=d.packetsLost&&$k(s,Gk.PACKAGE_LOST,o.packetsLost-d.packetsLost),null!=d.bytes&&null!=o.bytes&&$k(s,Gk.BITRATE,8*(o.bytes-d.bytes)/e)}return s}(d[0].ssrcId,e,t,c,n),r=n?null:function(e,t,n){const i=t.videoSend.find((t=>t.ssrc===e));if(!i)return null;const r={},o=i.inputFrame,s=o&&o.height||n&&n._videoHeight||0,a=o&&o.width||n&&n._videoWidth||0,c=o&&o.frameRate||0;return $k(r,jk.HEIGHT,s),$k(r,jk.WIDTH,a),$k(r,jk.FRAME_RATE,c),r}(d[0].ssrcId,e,c),s=n?null:function(e){const t={};return $k(t,Gk.RETRANSMIT,e.bitrate.retransmit),$k(t,Gk.TARGET_ENCODED,e.bitrate.targetEncoded),$k(t,Gk.ACTUAL_ENCODED,e.bitrate.actualEncoded),$k(t,Gk.TRANSMIT,e.bitrate.transmit),$k(t,Gk.BANDWIDTH,e.sendBandwidth),t}(e);o=Object.assign({},i,r,s)}else s=n?void 0:function(e,t,n){const i=t.videoSend.find((t=>t.ssrc===e));if(!i)return;const r={},o=i.sentFrame;if(o&&($k(r,Wk.HEIGHT,o.height),$k(r,Wk.WIDTH,o.width),$k(r,Wk.FRAME_RATE,o.frameRate)),n){const t=n.videoSend.find((t=>t.ssrc===e));if(t){let e=Qk*Zk;t.timestamp&&i.timestamp&&(e=i.timestamp-t.timestamp),null!=t.packets&&null!=i.packets&&$k(r,Wk.PACKAGE_RATE,1e3*(i.packets-t.packets)/e),null!=i.packetsLost&&null!=t.packetsLost&&$k(r,Wk.PACKAGE_LOST,i.packetsLost-t.packetsLost),null!=t.bytes&&null!=i.bytes&&$k(r,Wk.BITRATE,8*(i.bytes-t.bytes)/e)}}return r}(d[0].ssrcId,e,t);break;case _C.LocalAudioTrack:r=n?void 0:function(e,t,n,i){const r=t.audioSend.find((t=>t.ssrc===e));if(!r)return;const o={};o[Yk.DISABLED]=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?1:0;const s=i._source.getAccurateVolumeLevel(),a=r.inputLevel;$k(o,Yk.LEVEL,100*(null==a?s:a)),$k(o,zk.PCM_LEVEL,100*s),$k(o,Yk.AEC_RETURN_LOSS,r.aecReturnLoss),$k(o,Yk.AEC_RETURN_LOSS_ENH,r.aecReturnLossEnhancement),o[Yk.FREEZE]=0;const c=n&&n.audioSend.find((t=>t.ssrc===e));if(c){let e=Qk*Zk;c.timestamp&&r.timestamp&&(e=r.timestamp-c.timestamp),null!=c.bytes&&null!=r.bytes&&$k(o,Yk.BITRATE,8*(r.bytes-c.bytes)/e),null!=c.packets&&null!=r.packets&&$k(o,Yk.PACKAGE_RATE,1e3*(r.packets-c.packets)/e)}return o}(d[0].ssrcId,e,t,c)}})),{high:o,low:s,audio:r}}getInboundStats(e,t,n){if(!this.requestRemoteMedia)return;const i=this.requestRemoteMedia()||[],r=[];return i.forEach((i=>{let[o,s]=i;const a={peer:o.uid};if(s.has(hC.VIDEO)&&o.videoTrack){const i=o._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(o._videoSSRC)||!1,r=o.videoTrack?function(e,t,n,i,r,o,s){const a=t.videoRecv.find((t=>t.ssrc===e));if(!a)return;const c={},{receivedFrame:d,outputFrame:l,decodeFrameRate:u}=a,h=n&&n.videoRecv.find((t=>t.ssrc===e));if(c[Hk.FREEZE]=r&&uL.isRemoteVideoFreeze(i,a,h)?1:0,$k(c,Kk.FRAME_RATE_DECODE,u),$k(c,Hk.QP_SUM,a.qpSumPerFrame),a.framesRateFirefox&&$k(c,Hk.FRAME_RATE,a.framesRateFirefox),d&&$k(c,Hk.FRAME_RATE,d.frameRate),h){const e=t.timestamp-n.timestamp||(s?Qk:Zk*Qk);null!=a.packetsLost&&null!=h.packetsLost&&$k(c,Hk.PACKAGE_LOST,a.packetsLost-h.packetsLost),null!=h.bytes&&null!=a.bytes&&$k(c,Hk.BITRATE,8*(a.bytes-h.bytes)/e),null!=h.packets&&null!=a.packets&&$k(c,Hk.PACKAGE_RATE,1e3*(a.packets-h.packets)/e)}if(s)return c;if(d?($k(c,Hk.HEIGHT,d.height),$k(c,Hk.WIDTH,d.width)):i&&($k(c,Hk.HEIGHT,i._videoHeight||0),$k(c,Hk.WIDTH,i._videoWidth||0)),l&&$k(c,Kk.FRAME_RATE_RENDER,l.frameRate),$k(c,Hk.JITTER_BUFFER,a.jitterBufferMs),$k(c,Hk.CURRENT_DELAY,a.currentDelayMs),$k(c,Hk.FIRS,a.firsCount),$k(c,Hk.NACKS,a.nacksCount),$k(c,Hk.PLIS,a.plisCount),i){c[Hk.DISABLED]=i._originMediaStreamTrack.enabled&&i._mediaStreamTrack.enabled?0:1;const e=i._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:n}=e;if(t&&t.length>0&&$k(c,Kk.FREEZE_TIME,t.splice(0,1)[0]),o&&"visible"===SA.visibility){const t=Math.min(6e3,n);e.renderFreezeAccTime=Math.max(0,n-t),$k(c,Kk.FREEZE_TIME_RENDER,t)}}}if(c[Hk.PLAYER_STATUS]=uw[i._player?i._player.videoElementStatus:"uninit"],h&&void 0!==a.totalInterFrameDelay&&void 0!==a.totalSquaredInterFrameDelay&&void 0!==h.totalInterFrameDelay&&void 0!==h.totalSquaredInterFrameDelay){const e=a.totalInterFrameDelay-h.totalInterFrameDelay,t=a.totalSquaredInterFrameDelay-h.totalSquaredInterFrameDelay,n=a.framesDecodeCount-h.framesDecodeCount,i=e/n*1e3,r=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/n)/n));!isNaN(r)&&i+r>Math.max(3*i,i+150)&&(c[Hk.I_FRAME_DELAY]=r)}return c}(o._videoSSRC,e,t,o.videoTrack,!0===i,this.needUploadRenderFreezeTime,n):void 0;r&&(a.video=r)}if(s.has(hC.AUDIO)&&o.audioTrack){const i=o.audioTrack?function(e,t,n,i,r){const o=t.audioRecv.find((t=>t.ssrc===e));if(!o)return;const s={},a=n&&n.audioRecv.find((t=>t.ssrc===e)),{receivedFrames:c,droppedFrames:d}=o;var l;if($k(s,qk.JITTER,o.jitterMs),null!=c&&null!=d&&(s[qk.FREEZE]=0===(l=c)||100*d/l>20?1:0),a){const e=t.timestamp-n.timestamp||(r?Qk:Qk*Zk);null!=o.packets&&null!=a.packets&&$k(s,qk.PACKAGE_RATE,1e3*(o.packets-a.packets)/e),null!=a.bytes&&null!=o.bytes&&$k(s,qk.BITRATE,8*(o.bytes-a.bytes)/e),null!=o.packetsLost&&null!=a.packetsLost&&$k(s,qk.PACKAGE_LOST,o.packetsLost-a.packetsLost)}if(r)return s;const u=i._source.getAccurateVolumeLevel(),h=o.outputLevel;if($k(s,Jk.LEVEL,100*(null==h?u:h)),$k(s,qk.PCM_LEVEL,100*u),i&&(s[qk.DISABLED]=i._originMediaStreamTrack.enabled&&i._mediaStreamTrack.enabled?0:1),$k(s,qk.JITTER_BUFFER,o.jitterBufferMs),$k(s,qk.CURRENT_DELAY,o.jitterBufferMs),s[qk.PLAYER_STATUS]=uw[Yw.getPlayerState(i.getTrackId())],a){const e=o.concealedSamples-a.concealedSamples;e>0&&$k(s,qk.CONCEALED_SAMPLES,e)}return s}(o._audioSSRC,e,t,o.audioTrack,n):void 0;i&&(a.audio=i)}(a.video||a.audio)&&r.push(a)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,r}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof dA));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(vR.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{this.requestAllTracks&&this.requestUpload&&this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{this.requestUpload&&this.requestRemoteMedia&&(this.requestRemoteMedia()||[]).forEach((e=>{let[t,n]=e;n.has(hC.VIDEO)&&t.videoTrack&&t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)})),n.has(hC.AUDIO)&&t.audioTrack&&t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),n={connectionInterval:Dy("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let i=[];const r=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of r)!e.muted&&e.enabled&&(i=i.concat(await e.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,c]of o)c.has(hC.VIDEO)&&e.videoTrack&&(i=i.concat(await e.videoTrack.getProcessorUsage())),c.has(hC.AUDIO)&&e.audioTrack&&(i=i.concat(await e.audioTrack.getProcessorUsage()));if(0===i.length)return;n.details=function(e,t){const n={};for(const{id:s,value:a,level:c,direction:d}of e){var i;const e=null!==(i=t.get(s))&&void 0!==i?i:0,l=2===a?e+Dy("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var r,o;t.set(s,l),n[s]?(2===a&&(n[s].value=a),c>n[s].level&&(n[s].level=c),"remote"===d&&(n[s].remoteUidCount+=1),n[s].totalTs=null!==(r=t.get(s))&&void 0!==r?r:0):n[s]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(s))&&void 0!==o?o:0}}return Object.keys(n).map((e=>{const{level:t,value:i,totalTs:r}=n[e];return{id:e,level:t,value:i,totalTs:r}}))}(i,e);const s=Date.now(),a=s>t?s:t+1;this.requestUpload&&this.requestUpload(vR.EXTENSION_USAGE_STATS,{usageStats:n,sendTs:a})}),Dy("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class nL{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){ih(this,"uid",void 0),ih(this,"_uintid",void 0),ih(this,"_trust_in_room_",!0),ih(this,"_trust_audio_enabled_state_",!0),ih(this,"_trust_video_enabled_state_",!0),ih(this,"_trust_audio_mute_state_",!0),ih(this,"_trust_video_mute_state_",!0),ih(this,"_audio_muted_",!1),ih(this,"_video_muted_",!1),ih(this,"_audio_enabled_",!0),ih(this,"_video_enabled_",!0),ih(this,"_audio_added_",!1),ih(this,"_video_added_",!1),ih(this,"_is_pre_created",!1),ih(this,"_video_pre_subscribed",!1),ih(this,"_audio_pre_subscribed",!1),ih(this,"_trust_video_stream_added_state_",!0),ih(this,"_trust_audio_stream_added_state_",!0),ih(this,"_audioTrack",void 0),ih(this,"_videoTrack",void 0),ih(this,"_dataChannels",[]),ih(this,"_audioSSRC",void 0),ih(this,"_videoSSRC",void 0),ih(this,"_audioOrtc",void 0),ih(this,"_videoOrtc",void 0),ih(this,"_cname",void 0),ih(this,"_rtxSsrcId",void 0),ih(this,"_videoMid",void 0),ih(this,"_audioMid",void 0),this.uid=e,this._uintid=t}}var iL;function rL(e,t){var n;let i;switch(t){case _C.LocalAudioTrack:i=eC.Audio;break;case _C.LocalVideoTrack:i=Ai(n=e._hints).call(n,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalVideoLowTrack:i=eC.Low}return i}function oL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function sL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}!function(e){e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY"}(iL||(iL={}));class aL extends nS{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(EC.StateChange,t,this._state)}constructor(e,t){super(),ih(this,"store",void 0),ih(this,"statsUploader",void 0),ih(this,"sendConnection",void 0),ih(this,"recvConnection",void 0),ih(this,"localTrackMap",new Map),ih(this,"remoteUserMap",new Map),ih(this,"localDataChannels",[]),ih(this,"pendingLocalTracks",[]),ih(this,"pendingRemoteTracks",[]),ih(this,"statsCollector",void 0),ih(this,"dtlsFailedCount",0),ih(this,"sendMutex",new zS("P2PChannel2-send-mutex")),ih(this,"recvMutex",new zS("P2PChannel2-recv-mutex")),ih(this,"_state",mC.Disconnected),ih(this,"_restartStates",["disconnected","failed"]),ih(this,"reconnectInterval",void 0),ih(this,"uploadUnplinkStarted",!1),ih(this,"uploadDownlinkStarted",!1),ih(this,"uplinkStateUploadInterval",void 0),ih(this,"downlinkStatsUploadInterval",void 0),ih(this,"handleMuteLocalTrack",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==mC.Connected)return void n(new Vg(xg.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const i=this.filterTobeMutedTracks(e);if(0===i.length)return void t();const s=i.find((e=>"videoLowTrack"===e[0]));s&&s[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(i.map((e=>{let[,{id:t}]=e;return t})));let a=!1;var r,o;a="video"===e.trackMediaType?!(null===(r=this.localTrackMap.get(_C.LocalAudioTrack))||void 0===r||!r.track._muted):void 0===(null===(o=this.localTrackMap.get(_C.LocalVideoTrack))||void 0===o?void 0:o.id);const c=this.createMuteMessage(i);await gS(this,EC.RequestMuteLocal,c);const d="video"===e.trackMediaType?DC.MUTE_LOCAL_VIDEO:DC.MUTE_LOCAL_AUDIO;await gS(this,EC.RequestP2PMuteLocal,{action:d,message:c,isMuteAll:a}),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleUnmuteLocalTrack",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==mC.Connected)return void n(new Vg(xg.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const i=this.filterTobeUnmutedTracks(e);if(0===i.length)return void t();await this.sendConnection.unmuteLocal(i.map((e=>{let[,{id:t}]=e;return t})));const r=this.createUnmuteMessage(i),o="video"===e.trackMediaType?DC.UNMUTE_LOCAL_VIDEO:DC.UNMUTE_LOCAL_AUDIO;await gS(this,EC.RequestP2PMuteLocal,{action:o,message:r}),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleUpdateVideoEncoder",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const n=this.localTrackMap.get(_C.LocalVideoTrack);if(!this.sendConnection||!n||n.track!==e||this.state!==mC.Connected)return void t();const{id:i,track:r}=n;i&&(await this.sendConnection.updateSendParameters(i,r),await this.sendConnection.updateEncoderConfig(i,r),this.emit(EC.UpdateVideoEncoder,r)),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleSetOptimizationMode",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const n=this.localTrackMap.get(_C.LocalVideoTrack);if(!this.sendConnection||!n||n.track!==e||this.state!==mC.Connected)return;const{id:i,track:r}=n;i&&await this.sendConnection.updateSendParameters(i,r),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleReplaceTrack",(async(e,t,n,i)=>{let r;zy.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof i&&i||(r=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var o;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(!this.sendConnection||!n||void 0===n[1].id||this.state!==mC.Connected)return void t();if(await(null===(o=this.sendConnection)||void 0===o?void 0:o.replaceTrack(e,n[1].id)),n[0]===_C.LocalVideoTrack&&AI().supportDualStreamEncoding){const t=this.localTrackMap.get(_C.LocalVideoLowTrack);if(t){const n=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n,await new tg(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}}t()}catch(e){n(e)}finally{var s;null===(s=r)||void 0===s||s()}})),ih(this,"handleGetLocalVideoStats",(e=>{e(this.statsCollector.getLocalVideoTrackStats())})),ih(this,"handleGetLocalAudioStats",(e=>{e(this.statsCollector.getLocalAudioTrackStats())})),ih(this,"handleGetRemoteVideoStats",(e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid])),ih(this,"handleGetRemoteAudioStats",(e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new tL(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),Dy("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,n,i,r,o){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let n;try{if(t){this.recvConnection&&(zy.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new xk(e,this.store,CR.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(t);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=mC.New,this.sendConnection&&(zy.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new xk(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const t=await this.sendConnection.establish();return{iceParameters:t.iceParameters,dtlsParameters:t.dtlsParameters,sdp:t.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=mC.Connected}async addRemoteCandidate(e,t){if(t===CR.RECEIVE_ONLY){if(!this.sendConnection)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,n){var i=this;return OP((function*(){const r=yield TP(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==mC.Connected){i.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===i.pendingLocalTracks.indexOf(e)));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(t))}i.store.pubId=i.store.pubId+1,gP.markPublishStart(i.store.clientId,i.store.pubId);const r=i.filterTobePublishedTracks(e,t,n);if(0===r.length)return void(yield TP(i.tryToUnmuteAudio(e)));r.forEach((e=>{let{track:t,type:n}=e;const r=Date.now();i.store.publish(t.getTrackId(),n===_C.LocalAudioTrack?"audio":"video",r)})),i.bindLocalTrackEvents(r);const o=yield TP(i.sendConnection.send(r.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),s=(yield TP(o.next())).value,a=i.createGatewayPublishMessage(r,s);try{yield a}catch(e){throw o.throw(e),(null==e?void 0:e.code)===xg.WS_ABORT&&r.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(r),e}yield TP(o.next()),r.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(r,s),r.forEach((e=>{let{track:t,type:n}=e;const r=Date.now();i.store.publish(t.getTrackId(),n===_C.LocalAudioTrack?"audio":"video",void 0,r)})),i.startUploadUplinkState()}finally{r()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==mC.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!Ai(e).call(e,t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const n=t.find((e=>"videoLowTrack"===e[0]));n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:n}]=e;return{type:t,track:n}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===mC.Connected)return n&&n[1].track.close(),i;e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((n=>{let[i,{track:r,ssrcs:o}]=n;const s={stream_type:rL(r,i),ssrcs:o};r._muted||!r._enabled?e.push(s):t.push(s)})),e.length>0&&e.forEach((e=>{gS(this,EC.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{gS(this,EC.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return OP((function*(){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(zy.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await ES(this,EC.RequestRePublish,this.pendingLocalTracks),this.emit(EC.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,n,i){var r;if(!this.recvConnection)throw new Vg(xg.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(r=this.remoteUserMap.get(e))&&void 0!==r&&r.has(t))return;const{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:n}],String(e.uid),i);t===hC.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new FA(o,e.uid,e._uintid,this.store),zy.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new VA(o,e.uid,e._uintid,this.store),zy.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,s):this.remoteUserMap.set(e,new Map([[t,s]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex((n=>{let{user:i,kind:r}=n;return i.uid===e.uid&&t===r}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(EC.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,n,i){if(!this.recvConnection)throw new Vg(xg.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:n}],String(e.uid),i)}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((n=>{let{user:i,kind:r}=n;return void 0!==t?i.uid===e.uid&&t===r:i.uid===e.uid}));if(i.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||n||i.forEach((t=>{let{kind:n}=t;var i;if(n===hC.AUDIO)null===(i=e._audioTrack)||void 0===i||i._destroy(),e._audioTrack=void 0;else if(n===hC.VIDEO){var r;null===(r=e._videoTrack)||void 0===r||r._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(e,t);0!==r.length&&(await this.recvConnection.stopReceiving(r.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(r),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach((e=>{let[t,{kind:i}]=e;var r,o;if(i===hC.VIDEO&&t._videoSSRC&&(null===(r=this.recvConnection)||void 0===r||r.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),i===hC.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),n||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(i===hC.AUDIO){var s;this.unbindRemoteTrackEvents(t._audioTrack),n||(null===(s=t._audioTrack)||void 0===s||s._destroy(),t._audioTrack=void 0)}})),r.forEach((e=>{let[,{kind:t}]=e;gS(this,EC.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[hC.VIDEO,hC.AUDIO].forEach((e=>{t.has(e)?gS(this,EC.RequestP2PUnmuteRemote,e):gS(this,EC.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new Vg(xg.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void zy.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void zy.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===hC.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==i&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);n?n.get(t)||zy.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,".")):zy.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(_C.LocalAudioTrack);if((null==t?void 0:t.track)instanceof uA){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==_C.LocalAudioTrack})).filter((t=>{let[n]=t;return!(e&&n===_C.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[n]=t;return!(e&&n===_C.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,n,i,r){if(e){const n=this.localTrackMap.get(_C.LocalAudioTrack),o=i?this.localTrackMap.get(_C.LocalVideoLowTrack):this.localTrackMap.get(_C.LocalVideoTrack);oR.publish(this.store.sessionId,{eventElapse:gP.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(zI.SCREEN_TRACK)),audio:!!n,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find((e=>e instanceof cA)),a=i?null===(o=this.localTrackMap.get(_C.LocalVideoTrack))||void 0===o?void 0:o.track:n.find((e=>e instanceof NA));oR.publish(this.store.sessionId,{eventElapse:gP.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==s?void 0:s.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(zI.SCREEN_TRACK)),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===hC.VIDEO?n._videoSSRC:n._audioSSRC;r&&oR.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===hC.VIDEO,audio:i===hC.AUDIO,peerid:n.uid,subscribeRequestid:i===hC.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:gP.measureFromSubscribeStart(this.store.clientId,r)})}reset(){zy.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new zS("P2PChannel2-send-mutex"),this.sendMutex=new zS("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(_C.LocalAudioTrack);if((null==e?void 0:e.track)instanceof uA){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=mC.Disconnected}getStats(e){var t,n;return e?null===(n=this.recvConnection)||void 0===n?void 0:n.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(_C.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(_C.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof NA||t&&t.track instanceof cA?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(_C.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=Zh(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(zy.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=mC.Reconnecting,Dy("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&(null===(n=t._videoTrack._player.getVideoElement())||void 0===n||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case _C.LocalVideoTrack:Ai(t=i._hints).call(t,zI.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case _C.LocalAudioTrack:i instanceof uA?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case _C.LocalVideoLowTrack:}})),this.emit(EC.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(uh(n).call(n)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(EC.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),zy.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof nL?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let n,i;if(e===CR.SEND_ONLY){if(!this.sendConnection)throw new Vg(xg.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new Vg(xg.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(t){const e=await i.restartICE(t);return i.isInRestartIce=!1,e}{const e=await i.restartICE();if(e){const t=await ES(this,EC.RequestP2PRestartICE,{direction:CR.RECEIVE_ONLY,iceParameter:e});await i.restartICE(t),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(_C.LocalVideoTrack),n=this.localTrackMap.get(_C.LocalAudioTrack),i=e.videoSend.find((e=>{var n;return e.ssrc===(null==t||null===(n=t.ssrcs)||void 0===n?void 0:n[0].ssrcId)})),r=e.audioSend.find((e=>{var t;return e.ssrc===(null==n||null===(t=n.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!i||!r)return 1;const o=SS(this,EC.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=null==t?void 0:t.track;if(h&&h._encoderConfig&&-1===h._hints.indexOf(zI.SCREEN_TRACK)){const t=h._encoderConfig.bitrateMax,n=e.bitrate.actualEncoded;if(t&&n){const e=(1e3*t-n)/(1e3*t);return cR[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=e.audioRecv.find((e=>e.ssrc===r)),a=e.videoRecv.find((e=>e.ssrc===o));if(!s&&!a)return void(t+=1);const c=SS(this,EC.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new tg(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}filterTobePublishedTracks(e,t,n){const i=[],r=AI(),o=this.getAllTracks();e=bS(e=e.filter((e=>-1===o.indexOf(e))));let s=!1,a=!1;for(const c of e){if(c instanceof NA&&(this.localTrackMap.has(_C.LocalVideoTrack)||s?new Vg(xg.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:_C.LocalVideoTrack}),s=!0),t)){const e=this.getLowVideoTrack(c,n);i.push({track:e,type:_C.LocalVideoLowTrack})}if(c instanceof cA){const e=this.localTrackMap.get(_C.LocalAudioTrack);if(e){if(!(e.track instanceof uA))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const e=i.find((e=>{let{type:t}=e;return t===_C.LocalAudioTrack}));if(!(e.track instanceof uA))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof uA||c._bypassWebAudio)i.push({track:c,type:_C.LocalAudioTrack});else{const e=new uA;e.addAudioTrack(c),i.push({track:e,type:_C.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=bS(e=e.filter((e=>-1!==n.indexOf(e))));for(const i of e){if(i instanceof cA){const e=this.localTrackMap.get(_C.LocalAudioTrack);if(!e)continue;e.track instanceof uA?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([_C.LocalAudioTrack,e]),e.track.close())):t.push([_C.LocalAudioTrack,e])}if(i instanceof NA){const e=this.localTrackMap.get(_C.LocalVideoTrack);if(!e)continue;t.push([_C.LocalVideoTrack,e]);const n=this.localTrackMap.get(_C.LocalVideoLowTrack);n&&t.push([_C.LocalVideoLowTrack,n])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:n}=e;switch(n){case _C.LocalVideoTrack:t.addListener(KI.GET_STATS,this.handleGetLocalVideoStats),t.addListener(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(KI.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(KI.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case _C.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case _C.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof uA?e.trackList.forEach((e=>{e.addListener(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(KI.GET_STATS,this.handleGetLocalAudioStats),e.addListener(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(KI.GET_STATS,this.handleGetLocalAudioStats),e.addListener(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:n}]=e;return{track:n,type:t}}))),e.forEach((e=>{let{track:t,type:n}=e;switch(n){case _C.LocalVideoTrack:t.off(KI.GET_STATS,this.handleGetLocalVideoStats),t.off(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(KI.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(KI.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case _C.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case _C.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof uA?e.trackList.forEach((e=>{e.off(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(KI.GET_STATS,this.handleGetLocalAudioStats),e.off(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(KI.GET_STATS,this.handleGetLocalAudioStats),e.off(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof VA&&t.addListener(KI.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof FA&&t.addListener(KI.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(KI.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(hC.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(hC.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,n)=>{var i;let r,{track:o,type:s}=e;switch(s){case _C.LocalAudioTrack:r=eC.Audio;break;case _C.LocalVideoTrack:r=Ai(i=o._hints).call(i,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalVideoLowTrack:r=eC.Low}return{kind:s===_C.LocalAudioTrack?hC.AUDIO:hC.VIDEO,stream_type:r,mid:t[n].id,ssrcs:t[n].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case _C.LocalVideoTrack:n=Ai(t=r._hints).call(t,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalAudioTrack:n=eC.Audio;break;case _C.LocalVideoLowTrack:n=eC.Low}return{stream_type:n,ssrcs:o,mid:s}}))}assignLocalTracks(e,t){e.forEach(((e,n)=>{let{track:i,type:r}=e;this.localTrackMap.set(r,{track:i,id:t[n].id,ssrcs:t[n].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var n;zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(EC.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(e.isInRestartIce=!1),Ai(n=this._restartStates).call(n,t)&&!e.isInRestartIce&&("disconnected"===t&&await US(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),oR.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:sS.TRACER}).onSuccess(),this.emit(EC.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var i;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=n.audioTrack)||void 0===i||i.emit(ZI.FIRST_FRAME_DECODED),oR.firstRemoteFrame(this.store.sessionId,Qy.FIRST_AUDIO_DECODE,Zy.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));n&&oR.firstRemoteFrame(this.store.sessionId,Qy.FIRST_AUDIO_RECEIVED,Zy.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,n)=>{this.reportVideoFirstFrameDecoded(e,t,n)},e.onFirstVideoReceived=e=>{var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));n&&oR.firstRemoteFrame(this.store.sessionId,Qy.FIRST_VIDEO_RECEIVED,Zy.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const n="relay"===e.candidateType,i="relay"===t.candidateType;"unknown"!==t.candidateType&&n===i||this.emit(EC.ConnectionTypeChange,n),zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Db(t))," -> ").concat(JSON.stringify(Db(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Db(t))," -> ").concat(JSON.stringify(Db(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(EC.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===CR.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,zy.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===CR.SEND_ONLY?this.restartICE(e):ES(this,EC.RequestP2PRestartICE,{direction:CR.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const n=this.localTrackMap.get(_C.LocalAudioTrack);if(e instanceof cA&&(null==n?void 0:n.track)instanceof uA)return n.track.isActive||t.push([_C.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i&&(t.push(i),i[0]===_C.LocalVideoTrack)){const e=this.localTrackMap.get(_C.LocalVideoLowTrack);e&&t.push([_C.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(_C.LocalAudioTrack);if(e instanceof cA&&(null==n?void 0:n.track)instanceof uA)return n.track.isActive&&t.push([_C.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i)if(i[0]===_C.LocalVideoTrack){t.push(i);const e=this.localTrackMap.get(_C.LocalVideoLowTrack);e&&t.push([_C.LocalVideoLowTrack,e])}else t.push(i);return t}createMuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case _C.LocalAudioTrack:n=eC.Audio;break;case _C.LocalVideoTrack:n=Ai(t=r._hints).call(t,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalVideoLowTrack:n=eC.Low}return{stream_type:n,ssrcs:o,mid:s}}))}createUnmuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case _C.LocalAudioTrack:n=eC.Audio;break;case _C.LocalVideoTrack:n=Ai(t=r._hints).call(t,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalVideoLowTrack:n=eC.Low}return{stream_type:n,ssrcs:o,mid:s}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((t=>{let[i,r]=t;n.push([e,{kind:i,id:r}])}));return n}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[n,{kind:i,id:r}]=e;switch(i){case hC.VIDEO:return void(n._videoSSRC&&t.push({stream_type:hC.VIDEO,ssrcId:n._videoSSRC}));case hC.AUDIO:return void(n._audioSSRC&&t.push({stream_type:hC.AUDIO,ssrcId:n._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:n}]=e;const i=this.remoteUserMap.get(t);i&&(i.delete(n),0===Array.from(i.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(_C.LocalVideoTrack),n=this.localTrackMap.get(_C.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),n&&e.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof cA){const n=this.filterTobeUnmutedTracks(e[t]);if(0===n.length)continue;const i=this.createUnmuteMessage(n);return void await gS(this,EC.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(EC.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(EC.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await US(JS(this.dtlsFailedCount,qS)),this.emit(EC.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(_C.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof NA))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof NA)).length>1)throw new Vg(xg.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof cA)).length>1&&(e.some((e=>e instanceof cA&&e._bypassWebAudio))||!AI().webAudioMediaStreamDest))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof NA&&this.pendingLocalTracks.some((e=>e instanceof NA)))throw new Vg(xg.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof cA&&this.pendingLocalTracks.some((e=>e instanceof cA))&&(!AI().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof cA&&e._bypassWebAudio))))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!Dy("DISABLE_DUAL_STREAM_USE_ENCODING")&&AI().supportDualStreamEncoding,i=sL(sL({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():Fk(e,i);const o=xS(8,"track-low-"),s=new NA(r,sL(sL({},n&&{scaleResolutionDownBy:Nb(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(XI.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,YI.LOW_STREAM)})),s._hints.push(zI.LOW_STREAM),e.addListener(KI.NEED_CLOSE,(()=>{s.close()})),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,n,i){var r;const o=Array.from(uh(r=this.remoteUserMap).call(r)).find((t=>t._videoSSRC===e));if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,s=r.subscribe.find((e=>e.userId===o.uid&&"video"===e.type));oR.firstRemoteVideoDecode(this.store.sessionId,Qy.FIRST_VIDEO_DECODE,Zy.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:n,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==s?void 0:s.subscribeEnd)||0,subscriberStart:(null==s?void 0:s.subscribeStart)||0,videoAddNotify:(null==s?void 0:s.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const o=await this.recvConnection.getRemoteSSRC(r);return void 0!==o&&o!==n}resetConnection(e){zy.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===mC.Connected?(zy.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new Vg(xg.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new Vg(xg.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new Vg(xg.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new Vg(xg.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new Vg(xg.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new Vg(xg.NOT_SUPPORTED)}async preConnect(e,t,n,i,r,o){throw new Vg(xg.NOT_SUPPORTED)}getEstablishParams(){throw new Vg(xg.NOT_SUPPORTED)}async reSubscribe(e){throw new Vg(xg.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new Vg(xg.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===_C.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,YI.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}}function cL(e){return function(t,n,i){const r=t[n];if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];switch(e){case iL.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,i)}finally{e()}}case iL.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,i)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(n)),t=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,i)}finally{e(),t()}}}},i}}function dL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function lL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?dL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}UR([cL(iL.SEND_ONLY),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],aL.prototype,"p2pConnect",null),UR([cL(iL.SEND_ONLY),xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],aL.prototype,"unpublish",null),UR([cL(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],aL.prototype,"unpublishLowStream",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String,Number,String]),xR("design:returntype",tg)],aL.prototype,"subscribe",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String,Number,String]),xR("design:returntype",tg)],aL.prototype,"mockSubscribe",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String,Boolean]),xR("design:returntype",tg)],aL.prototype,"unsubscribe",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String]),xR("design:returntype",tg)],aL.prototype,"muteRemote",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String]),xR("design:returntype",tg)],aL.prototype,"unmuteRemote",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String]),xR("design:returntype",tg)],aL.prototype,"hasRemoteMediaWithLock",null),UR([cL(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],aL.prototype,"disconnectForReconnect",null),UR([cL(iL.RECEIVE_ONLY),xR("design:type",Function),xR("design:paramtypes",[nL,String,Number]),xR("design:returntype",tg)],aL.prototype,"remoteMediaSsrcChanged",null);class uL{constructor(e){ih(this,"store",void 0),ih(this,"onStatsException",void 0),ih(this,"onUploadPublishDuration",void 0),ih(this,"onStatsChanged",void 0),ih(this,"localStats",new Map),ih(this,"remoteStats",new Map),ih(this,"updateStatsInterval",void 0),ih(this,"trafficStats",void 0),ih(this,"trafficStatsPeerList",[]),ih(this,"uplinkStats",void 0),ih(this,"exceptionMonitor",void 0),ih(this,"p2pChannel",void 0),ih(this,"scalabilityMode",uR.L1T1),ih(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new mP,this.exceptionMonitor.on("exception",((e,t,n)=>{this.onStatsException&&this.onStatsException(e,t,n)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(_C.LocalAudioTrack)||lL({},tw)}getLocalVideoTrackStats(){return this.localStats.get(_C.LocalVideoTrack)||lL({},nw)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const n=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return n&&(t.publishDuration=n.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},n={};if(e){var i;const r=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.audioStats;r&&(n[e]=t(e,r))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{audioStats:r}]=e;r&&(n[i]=t(i,r))}));return n}getRemoteNetworkQualityStats(e){const t={};if(e){var n;const i=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.networkStats;i&&(t[e]=i)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{networkStats:i}]=e;i&&(t[n]=i)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const n=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return n&&(t.publishDuration=n.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},n={};if(e){var i;const r=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.videoStats;r&&(n[e]=t(e,r))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{videoStats:r}]=e;r&&(n[i]=t(i,r))}));return n}getRTCStats(){let e=0,t=0,n=0,i=0;const r=this.localStats.get(_C.LocalAudioTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate);const o=this.localStats.get(_C.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const s=this.localStats.get(_C.LocalVideoLowTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:r}=e;t&&(n+=t.receiveBytes,i+=t.receiveBitrate),r&&(n+=r.receiveBytes,i+=r.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:n,RecvBitrate:i,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd)),e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const n=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),i=null!=n&&n.videoSSRC?gP.measureFromSubscribeStart(this.store.clientId,n.videoSSRC):0,r=null!=n&&n.audioSSRC?gP.measureFromSubscribeStart(this.store.clientId,n.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,i>r?i:r),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&zy.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,n){if(!e)return!1;const i=!!n&&t.framesDecodeFreezeTime>n.framesDecodeFreezeTime,r=!n||t.framesDecodeCount>n.framesDecodeCount;return i||!r}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((t=>{let[n,i]=t;switch(n){case _C.LocalVideoTrack:case _C.LocalVideoLowTrack:{const t=i,o=lL({},nw),s=e.getStats(),a=e.getLocalMedia(n);if(s){const n=s.videoSend.find((e=>e.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(n){const i=e.getLocalVideoSize(),r=e.getEncoderConfig(_C.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(o.codecType=n.codec),o.sendBytes=n.bytes,o.sendBitrate=t?8*Math.max(0,o.sendBytes-t.sendBytes):0,n.inputFrame?(o.captureFrameRate=n.inputFrame.frameRate,o.captureResolutionHeight=n.inputFrame.height,o.captureResolutionWidth=n.inputFrame.width):i&&(o.captureResolutionWidth=i.width,o.captureResolutionHeight=i.height),n.sentFrame?(o.sendFrameRate=n.sentFrame.frameRate,o.sendResolutionHeight=n.sentFrame.height,o.sendResolutionWidth=n.sentFrame.width):i&&(o.sendResolutionWidth=i.width,o.sendResolutionHeight=i.height),n.avgEncodeMs&&(o.encodeDelay=n.avgEncodeMs),r&&r.bitrateMax&&(o.targetSendBitrate=1e3*r.bitrateMax),o.sendPackets=n.packets,o.sendPacketsLost=n.packetsLost,o.sendJitterMs=n.jitterMs,o.sendRttMs=n.rttMs,o.totalDuration=t?t.totalDuration+1:1,o.totalFreezeTime=t?t.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(o.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(zy.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(o.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var r;this.localStats.set(n,o),((null==t?void 0:t.sendResolutionWidth)!==o.sendResolutionWidth||(null==t?void 0:t.sendResolutionHeight)!==o.sendResolutionHeight)&&(null===(r=this.onStatsChanged)||void 0===r||r.call(this,"resolution",{width:o.sendResolutionWidth,height:o.sendResolutionHeight})),o&&a&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,a.track,o);break}case _C.LocalAudioTrack:{const t=i,r=lL({},tw),o=e.getStats(),s=e.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==s?void 0:s.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(r.codecType=n.codec),n.inputLevel)r.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const t=e.getLocalAudioVolume();t&&(r.sendVolumeLevel=Math.round(32767*t))}r.sendBytes=n.bytes,r.sendPackets=n.packets,r.sendPacketsLost=n.packetsLost,r.sendJitterMs=n.jitterMs,r.sendRttMs=n.rttMs,r.sendBitrate=t?8*Math.max(0,r.sendBytes-t.sendBytes):0}}this.trafficStats&&(r.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(_C.LocalAudioTrack,r),r&&s&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,s.track,r);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var n,i;let[r,{videoStats:o,audioStats:s,videoPcStats:a}]=t;const c=s,d=o,l=a,u=lL({},iw),h=lL({},ow),p=lL({},rw),{audioTrack:f,videoTrack:_,audioSSRC:m,videoSSRC:E}=e.getRemoteMedia(r);let g;g=e instanceof aL?e.getStats(!0):e.getStats();const S=null===(n=g)||void 0===n?void 0:n.audioRecv.find((e=>e.ssrc===m)),T=null===(i=g)||void 0===i?void 0:i.videoRecv.find((e=>e.ssrc===E)),v=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===r));if(S&&("opus"!==S.codec&&"aac"!==S.codec&&"PCMU"!==S.codec&&"PCMA"!==S.codec&&"G722"!==S.codec||(u.codecType=S.codec),S.outputLevel?u.receiveLevel=Math.round(32767*S.outputLevel):f&&(u.receiveLevel=Math.round(32767*f.getVolumeLevel())),u.receiveBytes=S.bytes,u.receivePackets=S.packets,u.receivePacketsLost=S.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.receiveBitrate=c?8*Math.max(0,u.receiveBytes-c.receiveBytes):0,u.totalDuration=c?c.totalDuration+1:1,u.totalFreezeTime=c?c.totalFreezeTime:0,u.freezeRate=u.totalFreezeTime/u.totalDuration,u.receiveDelay=S.jitterBufferMs,u.totalDuration>10&&uL.isRemoteAudioFreeze(f)&&(u.totalFreezeTime+=1)),T){"H264"!==T.codec&&"H265"!==T.codec&&"VP8"!==T.codec&&"VP9"!==T.codec&&"AV1X"!==T.codec&&"AV1"!==T.codec||(h.codecType=T.codec),h.receiveBytes=T.bytes,h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.decodeFrameRate=T.decodeFrameRate<0?0:T.decodeFrameRate,h.renderFrameRate=T.decodeFrameRate<0?0:T.decodeFrameRate,T.outputFrame&&(h.renderFrameRate=T.outputFrame.frameRate),T.receivedFrame?(h.receiveFrameRate=T.receivedFrame.frameRate,h.receiveResolutionHeight=T.receivedFrame.height,h.receiveResolutionWidth=T.receivedFrame.width):_&&(h.receiveResolutionHeight=_._videoHeight||0,h.receiveResolutionWidth=_._videoWidth||0),void 0!==T.framesRateFirefox&&(h.receiveFrameRate=Math.round(T.framesRateFirefox)),h.receivePackets=T.packets,h.receivePacketsLost=T.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.receiveDelay=T.jitterBufferMs||0;const t=!!E&&e.getRemoteVideoIsReady(E);_&&t&&uL.isRemoteVideoFreeze(_,T,l)&&(h.totalFreezeTime+=1),h.freezeRate=h.totalFreezeTime/h.totalDuration}v&&(u.end2EndDelay=v.B_ad,h.end2EndDelay=v.B_vd,u.transportDelay=v.B_ed,h.transportDelay=v.B_ed,u.currentPacketLossRate=v.B_ealr4/100,h.currentPacketLossRate=v.B_evlr4/100,p.uplinkNetworkQuality=v.B_punq?v.B_punq:0,p.downlinkNetworkQuality=v.B_pdnq?v.B_pdnq:0),this.remoteStats.set(r,{audioStats:u,videoStats:h,videoPcStats:T,networkStats:p}),f&&this.exceptionMonitor.setRemoteAudioStats(f,u),_&&this.exceptionMonitor.setRemoteVideoStats(_,h)}))}}function hL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function pL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?hL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class fL extends nS{constructor(e,t,n,i){super(),ih(this,"spec",void 0),ih(this,"token",void 0),ih(this,"websocket",void 0),ih(this,"pingpongTimer",void 0),ih(this,"reconnectMode","retry"),ih(this,"serviceMode",void 0),ih(this,"reqId",0),ih(this,"commandReqId",0),ih(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),ih(this,"handleWebSocketMessage",(e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===IR.INJECT?this.emit(zR.INJECT_STREAM_STATUS,t):(oR.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===IR.TRANSCODE?1:2}),this.emit(zR.PUBLISH_STREAM_STATUS,t))})),this.spec=t,this.token=e,this.serviceMode=i,this.websocket=new $C("live-streaming",n),this.websocket.on(bR.CONNECTED,this.handleWebSocketOpen),this.websocket.on(bR.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(bR.REQUEST_NEW_URLS,((e,t)=>{ES(this,zR.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(bR.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,n,i){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const r=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new VR(xg.UNEXPECTED_ERROR);const s=pL({command:e,sdkVersion:"4.20.0"===by?"0.0.1":by,seq:o,requestId:o,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new VR(xg.WS_DISCONNECT);const a=()=>new tg(((e,t)=>{this.websocket.once(bR.CLOSED,(()=>t(new VR(xg.WS_ABORT)))),this.websocket.once(bR.CONNECTED,e)}));"connected"!==this.websocket.state&&await a(),s.clientRequest&&(s.clientRequest.workerToken=this.token);const c=new tg(((e,t)=>{const n=()=>{t(new VR(xg.WS_ABORT))};this.websocket.once(bR.RECONNECTING,n),this.websocket.once(bR.CLOSED,n),this.once("@".concat(o,"-").concat(this.spec.sid),(t=>{e(t)}))}));i&&oR.workerEvent(this.spec.sid,pL(pL({},i),{},{requestId:r,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const d=Date.now();this.websocket.sendMessage(s);let l=null;try{l=await c}catch(i){if("closed"===this.websocket.state)throw i;return await a(),await this.request(e,t,n)}return i&&oR.workerEvent(this.spec.sid,pL(pL({},i),{},{requestId:r,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:200===l.code,responseTime:Date.now()-d})),200!==l.code&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.20.0"===by?"0.0.1":by;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case qR.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void zy.warning("live stream response already exists stream");case qR.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case qR.LIVE_STREAM_RESPONSE_BAD_STREAM:case qR.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new VR(xg.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case qR.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case qR.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new VR(xg.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case qR.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new VR(xg.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(zR.WARNING,t,e.serverResponse.url)}case qR.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new VR(xg.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(zR.WARNING,t,e.serverResponse.url)}case qR.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case qR.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new VR(xg.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case qR.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new VR(xg.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(zR.WARNING,t,e.serverResponse.url)}case qR.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case qR.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case qR.LIVE_STREAM_RESPONSE_WORKER_LOST:case qR.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case qR.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case qR.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case qR.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case qR.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case qR.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new VR(xg.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(FS)}),6e3)}}function _L(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function mL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_L(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_L(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class EL extends nS{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:qS,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:qS;super(),ih(this,"onLiveStreamWarning",void 0),ih(this,"onLiveStreamError",void 0),ih(this,"onInjectStatusChange",void 0),ih(this,"spec",void 0),ih(this,"retryTimeout",1e4),ih(this,"connection",void 0),ih(this,"httpRetryConfig",void 0),ih(this,"wsRetryConfig",void 0),ih(this,"streamingTasks",new Map),ih(this,"isStartingStreamingTask",!1),ih(this,"taskMutex",new zS("live-streaming")),ih(this,"cancelToken",_y.CancelToken.source()),ih(this,"transcodingConfig",void 0),ih(this,"injectConfig",mL({},KR)),ih(this,"injectLoopTimes",0),ih(this,"uapResponse",void 0),ih(this,"lastTaskId",1),ih(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=n,this.wsRetryConfig=t}async setTranscodingConfig(e){const t=mL(mL({},HR),e);66!==t.videoCodecProfile&&77!==t.videoCodecProfile&&100!==t.videoCodecProfile&&(zy.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(t.videoCodecProfile," -> 100")),t.videoCodecProfile=100),t.transcodingUsers||(t.transcodingUsers=t.userConfigs),t.transcodingUsers&&(t.transcodingUsers=t.transcodingUsers.map((e=>mL(mL(mL({},BR),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){Kg(e.width)||Bg(e.width,"config.width",0,1e4),Kg(e.height)||Bg(e.height,"config.height",0,1e4),Kg(e.videoBitrate)||Bg(e.videoBitrate,"config.videoBitrate",1,1e6),Kg(e.videoFrameRate)||Bg(e.videoFrameRate,"config.videoFrameRate"),Kg(e.lowLatency)||Fg(e.lowLatency,"config.lowLatency"),Kg(e.audioSampleRate)||jg(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Kg(e.audioBitrate)||Bg(e.audioBitrate,"config.audioBitrate",1,128),Kg(e.audioChannels)||jg(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),Kg(e.videoGop)||Bg(e.videoGop,"config.videoGop"),Kg(e.videoCodecProfile)||jg(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Kg(e.userCount)||Bg(e.userCount,"config.userCount",0,17),Kg(e.backgroundColor)||Bg(e.backgroundColor,"config.backgroundColor",0,16777215),Kg(e.userConfigExtraInfo)||Wg(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!Kg(e.transcodingUsers)&&(Hg(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{jR(e.uid),Kg(e.x)||Bg(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),Kg(e.y)||Bg(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),Kg(e.width)||Bg(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),Kg(e.height)||Bg(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),Kg(e.zOrder)||Bg(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),Kg(e.alpha)||Bg(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),Kg(e.watermark)||WR(e.watermark,"watermark"),Kg(e.backgroundImage)||WR(e.backgroundImage,"backgroundImage"),e.images&&!Kg(e.images)&&(Hg(e.images,"config.images"),e.images.forEach(((e,t)=>{WR(e,"images[".concat(t,"]"))})))}(t);const n=[];t.images&&n.push(...t.images.map((e=>mL(mL(mL({},GR),e),{},{zOrder:255})))),t.backgroundImage&&(n.push(mL(mL(mL({},GR),t.backgroundImage),{},{zOrder:0})),delete t.backgroundImage),t.watermark&&(n.push(mL(mL(mL({},GR),t.watermark),{},{zOrder:255})),delete t.watermark),t.images=n,t.transcodingUsers&&(t.userConfigs=t.transcodingUsers.map((e=>mL({},e))),t.userCount=t.transcodingUsers.length,delete t.transcodingUsers);const i=(t.userConfigs||[]).map((e=>"number"==typeof e.uid?tg.resolve(e.uid):gI(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await tg.all(i)).forEach(((e,n)=>{t.userConfigs&&t.userConfigs[n]&&(t.userConfigs[n].uid=e)})),this.transcodingConfig=t,this.connection)try{var r;const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(MR(r=this.streamingTasks).call(r)).map((e=>e.taskId)).join("#")});zy.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((t=>{zy.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",t.url),this.startLiveStreamingTask(t.url,t.mode,e).then((()=>{zy.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(t.url," success"))})).catch((e=>{zy.error("[".concat(this.spec.clientId,"] live streaming republish failed"),t.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,t,n){var i;if(Array.from(MR(i=this.streamingTasks).call(i)).find((e=>e.mode===IR.INJECT))&&t===IR.INJECT)return new VR(xg.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&t===IR.TRANSCODE)throw new VR(xg.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};zy.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(t));const o=await this.taskMutex.lock();if(!this.connection&&n)return void o();if(this.streamingTasks.get(e)&&!n)return o(),new VR(xg.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(t))}catch(e){throw o(),e}switch(t){case IR.TRANSCODE:r.transcodingConfig=mL({},this.transcodingConfig);break;case IR.RAW:break;case IR.INJECT:r={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const s=this.lastTaskId++;try{const i=new tg(((t,i)=>{US(this.retryTimeout).then((()=>{if(n)return i(n);const t=this.statusError.get(e);return t?(this.statusError.delete(e),i(t)):void 0}))})),a=await tg.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:t===IR.TRANSCODE?1:2,requestByUser:!n,tid:s.toString()}),i]);this.isStartingStreamingTask=!1,zy.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(a.code)),this.streamingTasks.set(e,{clientRequest:r,mode:t,url:e,taskId:s}),o()}catch(i){if(o(),this.isStartingStreamingTask=!1,!i.data||!i.data.retry||n)throw i;return i.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,t,i)):await this.startLiveStreamingTask(e,t,i)}}stopLiveStreamingTask(e){return new tg(((t,n)=>{const i=this.streamingTasks.get(e);if(!i||!this.connection)return new VR(xg.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const r=i.mode;i.abortTask=()=>{zy.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),t()},this.connection.request("request",{clientRequest:{command:r===IR.INJECT?"UninjectStream":"UnpublishStream",url:i.url}},!1,{url:e,command:"UnPublishStream",workerType:r===IR.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((n=>{zy.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(n.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&r!==IR.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),t(),r===IR.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(wR.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(n)}))}async controlInjectStream(e,t,n,i){const r=this.streamingTasks.get(e);if(!r||!this.connection||r.mode!==IR.INJECT)throw new VR(xg.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:n,position:i}})).serverResponse}resetAllTask(){var e;const t=Array.from(MR(e=this.streamingTasks).call(e));this.terminate();for(const n of t)this.startLiveStreamingTask(n.url,n.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=_y.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new VR(xg.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await ES(this,YR.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new fL(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(zR.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(zR.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(zR.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(zR.REQUEST_NEW_ADDRESS,((t,n)=>{if(!this.connection)return n(new VR(xg.UNEXPECTED_ERROR,"can not get new live streaming address list"));ES(this,YR.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(n)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const t=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(t),i=e.reason;switch(e.code){case qR.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case qR.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case qR.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case qR.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const i=new VR(xg.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return zy.error(i.toString()),this.onLiveStreamError&&this.onLiveStreamError(t,i);if(!this.isStartingStreamingTask)return;this.statusError.set(t,i)}case qR.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new VR(xg.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,i);return this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e)}case qR.LIVE_STREAM_RESPONSE_WORKER_LOST:case qR.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var r;if(!this.connection)return;this.connection.tryNextAddress();const t=Array.from(MR(r=this.streamingTasks).call(r));for(const n of t)n.abortTask?n.abortTask():(zy.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",n.url),this.startLiveStreamingTask(n.url,n.mode,new VR(xg.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{zy.debug("[".concat(this.spec.clientId,"] republish live stream success"),n.url)})).catch((e=>{zy.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(n.url,e)})));return}}}handleInjectStreamServerStatus(e){const t=Number(e.uid),n=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(wR.INJECT_STREAM_STATUS_START_SUCCESS,t,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(wR.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,t,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(wR.INJECT_STREAM_STATUS_START_UNAUTHORIZED,t,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(wR.INJECT_STREAM_STATUS_BROKEN,t,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(wR.INJECT_STREAM_STATUS_START_TIMEOUT,t,n),void this.streamingTasks.delete(n);default:return void zy.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class gL{constructor(){ih(this,"destChannelMediaInfos",new Map),ih(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){sC(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){sC(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){FR(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function SL(e){if(!(e instanceof gL))return new VR(xg.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),n=e.getDestChannelMediaInfo();return t?0===n.size?new VR(xg.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new VR(xg.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}class TL extends nS{constructor(e,t,n){super(),ih(this,"ws",void 0),ih(this,"requestId",1),ih(this,"heartBeatTimer",void 0),ih(this,"joinInfo",void 0),ih(this,"clientId",void 0),ih(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),ih(this,"onClose",(e=>{this.emit("close"),this.dispose()})),ih(this,"onMessage",(e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)})),this.joinInfo=e,this.clientId=t,this.ws=new $C("cross-channel-".concat(this.clientId),n),this.ws.on(bR.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(bR.CONNECTED,this.onOpen),this.ws.on(bR.ON_MESSAGE,this.onMessage),this.ws.on(bR.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new tg(((t,n)=>{const i=window.setTimeout((()=>{n(new VR(xg.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(r=>{window.clearTimeout(i),r.state&&0!==r.state?n(new VR(xg.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(i),n(new VR(xg.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new VR(xg.WS_DISCONNECT);const t=()=>new tg(((e,t)=>{this.ws.once(bR.CLOSED,(()=>t(new VR(xg.WS_ABORT)))),this.ws.once(bR.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const n=this.sendMessage(e),i=new tg(((e,t)=>{const i=()=>{t(new VR(xg.WS_ABORT))};this.ws.once(bR.RECONNECTING,i),this.ws.once(bR.CLOSED,i),this.once("req_".concat(n),e),US(3e3).then((()=>{this.removeAllListeners("req_".concat(n)),this.ws.off(bR.RECONNECTING,i),this.ws.off(bR.CLOSED,i),t(new VR(xg.TIMEOUT,"cross channel ws request timeout"))}))})),r=await i;if(!r||200!==r.code)throw new VR(xg.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(r)));return r}async connect(e){this.ws.removeAllListeners(bR.REQUEST_NEW_URLS),this.ws.on(bR.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class vL extends nS{set state(e){e!==this._state&&(e!==ZR.RELAY_STATE_FAILURE&&(this.errorCode=$R.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,n,i,r){super(),ih(this,"joinInfo",void 0),ih(this,"sid",void 0),ih(this,"clientId",void 0),ih(this,"cancelToken",_y.CancelToken.source()),ih(this,"workerToken",void 0),ih(this,"requestId",0),ih(this,"signal",void 0),ih(this,"prevChannelMediaConfig",void 0),ih(this,"httpRetryConfig",void 0),ih(this,"_resolution",void 0),ih(this,"_state",ZR.RELAY_STATE_IDLE),ih(this,"errorCode",$R.RELAY_OK),ih(this,"onStatus",(e=>{zy.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",QR.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",QR.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=$R.SRC_TOKEN_EXPIRED,this.state=ZR.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=$R.DEST_TOKEN_EXPIRED,this.state=ZR.RELAY_STATE_FAILURE))})),ih(this,"onReconnect",(async()=>{zy.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",QR.NETWORK_DISCONNECTED),this.state=ZR.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==ZR.RELAY_STATE_IDLE&&(zy.error("auto restart channel media relay failed",e.toString()),this.errorCode=$R.SERVER_CONNECTION_LOST,this.state=ZR.RELAY_STATE_FAILURE)}))})),this.joinInfo=e,this.clientId=t,this.sid=VS(),this.signal=new TL(this.joinInfo,this.clientId,n),this.httpRetryConfig=i,this._resolution=r}async startChannelMediaRelay(e){if(this.state!==ZR.RELAY_STATE_IDLE)throw new VR(xg.INVALID_OPERATION);this.state=ZR.RELAY_STATE_CONNECTING,await this.connect(),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new VR(xg.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new VR(xg.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new VR(xg.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==ZR.RELAY_STATE_RUNNING)throw new VR(xg.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==ZR.RELAY_STATE_RUNNING)throw new VR(xg.INVALID_OPERATION);const t=this.genMessage(XR.SetVideoProfile);await this.signal.request(t),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),zy.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=ZR.RELAY_STATE_IDLE,this.dispose()}dispose(){zy.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=_y.CancelToken.source(),this.state=ZR.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await yI(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",QR.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const t=this.genMessage(XR.StopPacketTransfer);await this.signal.request(t),await this.signal.waitStatus("Normal Quit"),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(XR.SetSdkProfile,e);await this.signal.request(n),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const i=this.genMessage(XR.SetSourceChannel,e);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",QR.PACKET_JOINED_SRC_CHANNEL),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(XR.SetSourceUserId,e);await this.signal.request(r),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(XR.SetDestChannel,e);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",QR.PACKET_JOINED_DEST_CHANNEL),zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const s=this.genMessage(XR.StartPacketTransfer,e);await this.signal.request(s),this.emit("event",QR.PACKET_SENT_TO_DEST_CHANNEL),this.state=ZR.RELAY_STATE_RUNNING,zy.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const t=this.genMessage(XR.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",QR.PACKET_UPDATE_DEST_CHANNEL),zy.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(XR.StopPacketTransfer);await this.signal.request(e),zy.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const n=[],i=[],r=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:by,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.20.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let s=null,a=null;switch(e){case XR.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case XR.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new VR(xg.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case XR.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new VR(xg.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case XR.SetDestChannel:if(s=t&&t.getDestChannelMediaInfo(),!s)throw new VR(xg.UNEXPECTED_ERROR,"can not find dest config");return s.forEach((e=>{n.push(e.channelName),i.push(e.uid+""),r.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:n,uid:i,token:r},o;case XR.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case XR.Reconnect:return o.clientRequest={command:"Reconnect"},o;case XR.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case XR.UpdateDestChannel:if(s=t&&t.getDestChannelMediaInfo(),!s)throw new VR(xg.UNEXPECTED_ERROR,"can not find dest config");return s.forEach((e=>{n.push(e.channelName),i.push(e.uid+""),r.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:n,uid:i,token:r},o;case XR.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}function yL(e){var t={},n=!1;function i(t,i){return n=!0,{done:!1,value:new SP(i=new bP((function(n){n(e[t](i))})),1)}}return t[void 0!==Uu&&$u||"@@iterator"]=function(){return this},t.next=function(e){return n?(n=!1,e):i("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(n)throw n=!1,e;return i("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return n?(n=!1,e):i("return",e)}),t}var RL=i(IP);function CL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function bL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function IL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function wL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?IL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):IL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class AL extends MC{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ai(t=Object.keys(Uy)).call(t,e)})))]}constructor(e,t){super(e,t),ih(this,"store",void 0),ih(this,"peerConnection",void 0),ih(this,"remoteSDP",void 0),ih(this,"initialOffer",void 0),ih(this,"statsFilter",void 0),ih(this,"useRTX",!1),ih(this,"localCapabilities",void 0),ih(this,"localCandidateCount",0),ih(this,"allCandidatesReceived",!1),ih(this,"establishPromise",void 0),ih(this,"mutex",new zS("P2PConnection-mutex")),this.store=t,this.peerConnection=new RTCPeerConnection(AL.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=hk(this.peerConnection,Dy("STATS_UPDATE_INTERVAL"),void 0,vg()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=mk(e.sdp),n=_k(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:Dy("FILTER_VIDEO_FEC"),filterAudioFec:Dy("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=n,this.initialOffer=e,wL(wL({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:e.sdp})}catch(e){throw new Vg(xg.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,n,i,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){ih(this,"sessionDesc",void 0),ih(this,"localCapabilities",void 0),ih(this,"rtpCapabilities",void 0),ih(this,"candidates",void 0),ih(this,"iceParameters",void 0),ih(this,"dtlsParameters",void 0),ih(this,"setup",void 0),ih(this,"currentMidIndex",void 0),ih(this,"cname",void 0),e=wS(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:s,sdkCodec:a,cname:c}=e,d=zP.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=r,this.candidates=i,this.iceParameters=t,this.dtlsParameters=n,this.setup=o,this.localCapabilities=s,this.cname=c;for(let l=0;l<d.mediaDescriptions.length;l++){const e=d.mediaDescriptions[l];if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=n.fingerprints,e.attributes.candidates=i,e.attributes.setup=o,"video"===e.media.mediaType){e.media.fmts=r.videoCodecs.map((e=>e.payloadType.toString(10)));let t=r.videoCodecs.filter((e=>{var t,n;return null===(t=e.rtpMap)||void 0===t?void 0:Ai(n=t.encodingName.toLowerCase()).call(n,a)}));0===t.length&&(t=r.videoCodecs),e.attributes.payloads=t,e.attributes.extmaps=r.videoExtensions}"audio"===e.media.mediaType&&(e.media.fmts=r.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=r.audioCodecs,e.attributes.extmaps=r.audioExtensions),d.mediaDescriptions[l]=this.mungMediaDesc(e)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return zP.print(this.sessionDesc)}send(e,t,n){const{ssrcs:i,ssrcGroups:r}=Sk(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===hC.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),s=i[0].attributes.label,a=i[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(i),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(r),{id:s,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:n}=e;return this.send(t,n,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const n=[],i=[],r=[];t.attributes.ssrcs.forEach((t=>{Ai(e).call(e,t.attributes.label||"")?r.push(t):n.push(t)})),t.attributes.ssrcGroups.forEach((e=>{var t;Ai(t=r.map((e=>e.ssrcId))).call(t,e.ssrcIds[0])||i.push(e)})),t.attributes.ssrcs=n,t.attributes.ssrcGroups=i}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,n){e.forEach(((e,t)=>{const n=e._mediaStreamTrack,i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===n.kind)),r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=r}))}stopReceiving(e){}updateCandidates(e){e===pC.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(bL(bL({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(e){e=wS(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}mungRecvMediaDsec(e,t){const n=wS(e);return Tk(n,t),yk(n,t),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,n){const i=this.sessionDesc.mediaDescriptions.find((t=>e===hC.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(i){const e=i.attributes.ssrcs.find((e=>e.attributes.label===t));var r;e&&(e.attributes.label=n,null===(r=e.attributes.msid)||void 0===r||r.replace(t,n))}}mungMediaDesc(e){const t=wS(e);return vk(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const n of t.attributes.ssrcs)if(n.attributes.label===e)return[n]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:n,remoteRTPCapabilities:i.send,remoteSetup:r,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new Vg(xg.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,t){var n=this;return OP((function*(){const i=yield TP(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const i=e.map((e=>n.peerConnection.addTrack(e._mediaStreamTrack))),r=yield TP(n.peerConnection.createOffer()),o=zP.parse(r.sdp),s=e.map((e=>{const t=e._mediaStreamTrack,i=o.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!i)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,n){const i=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),r=e.attributes.ssrcGroups;if(0===i.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(r&&i.length>1){const e=r.find((e=>-1!==e.ssrcIds.indexOf(i[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:n?e.ssrcIds[1]:void 0}]:[{ssrcId:i[0].ssrcId}]}return[{ssrcId:i[0].ssrcId}]}(i,t.id,n.useRTX)}));let a;try{a=yield s}catch(e){throw i.forEach((e=>{Tg()&&e.replaceTrack(null),n.peerConnection.removeTrack(e)})),e}const c=n.mungSendOfferSDP(r.sdp,e);n.remoteSDP.receive(e,t,a);const d=n.remoteSDP.toString();return yield TP(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield TP(n.applySendEncodings(i,e)),yield TP(n.peerConnection.setRemoteDescription({type:"answer",sdp:d})),e.map(((e,t)=>{const n=e._mediaStreamTrack.id;return{localSSRC:s[t],id:n}}))}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{i()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var n;return-1!==e.indexOf((null===(n=t.track)||void 0===n?void 0:n.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{Tg()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:n,mslabel:r}=this.remoteSDP.send(e,t,i),o=new tg(((t,i)=>{const o=setTimeout((()=>{i(new Error("Cannot receive track, id: ".concat(n)))}),1e4),s=i=>{const a=pg();if(("Safari"===a.name&&11===Number(a.version)||yg())&&i.track.id!==n&&i.streams[0].id===r){var c;const r=i.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,n,i.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(o),void t(r)}if(i.track.id===n)return this.peerConnection.removeEventListener("track",s),clearTimeout(o),void t(i.track)};this.peerConnection.addEventListener("track",s)})),s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(a),{track:await o,id:n}}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var n;return-1!==e.indexOf((null===(n=t.track)||void 0===n?void 0:n.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(Tg()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var n;return-1!==e.indexOf((null===(n=t.track)||void 0===n?void 0:n.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(Tg()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return OP((function*(){const n=yield TP(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(AI().supportPCSetConfiguration){const n=t.peerConnection.getConfiguration(),i=e===pC.RELAY?"relay":"all";n.iceTransportPolicy!==i&&(zy.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(i,"]")),n.iceTransportPolicy=i,t.peerConnection.setConfiguration(n))}else if(e===pC.RELAY)return;e!==pC.RELAY&&t.remoteSDP.updateCandidates(e);const n=yield TP(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=mk(n.sdp),{remoteIceParameters:r}=yield i.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString();yield TP(t.peerConnection.setLocalDescription(n)),yield TP(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){zy.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const i=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getSenders().filter((t=>{var n;return(null===(n=t.track)||void 0===n?void 0:n.id)===e}));1===n.length&&await this.applySendEncodings(n,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getSenders().find((e=>{var n;return(null===(n=e.track)||void 0===n?void 0:n.id)===t}));n&&await n.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new Vg(xg.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new Vg(xg.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,zy.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,zy.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Dy("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(fS(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...AL.turnServerConfigToIceServers(e.turnServer.servers)),Dy("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...AL.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,t){var n;if(t||(t=this.peerConnection.getSenders().find((t=>{var n;return(null===(n=t.track)||void 0===n?void 0:n.id)===e._mediaStreamTrack.id}))),!t)return zy.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!AI().supportSetRtpSenderParameters)return zy.warn("Browser not support set rtp-sender parameters");const i={},r={};if(e instanceof NA)switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(Dy("DSCP_TYPE")&&Lg()){var o;const e=Dy("DSCP_TYPE");Ai(o=["very-low","low","medium","high"]).call(o,e)&&(r.networkPriority=e)}const s=t.getParameters(),a=null===(n=s.encodings)||void 0===n?void 0:n[0];a&&Object.assign(a,r),Object.assign(s,i),zy.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(s.encodings))),await t.setParameters(s)}async applySendEncodings(e,t){try{if(!AI().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){const i=e[n],r=t[n];i&&r&&await this.updateRtpSenderEncodings(r,i)}}catch(e){zy.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const n=zP.parse(e);return t.forEach(((e,t)=>{const i=e._mediaStreamTrack,r=n.mediaDescriptions.find((e=>e.attributes.mid===i.kind));r&&Tk(r,e)})),zP.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,n)=>{let{id:i,mslabel:r}=t;const{kind:o}=e[n];return new tg(((e,t)=>{const n=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(i)))}),1e4),s=t=>{const a=pg();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==i&&t.streams[0].id===r){var c;const r=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,i,t.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(n),void e({track:r,id:i})}if(t.track.id===i)return this.peerConnection.removeEventListener("track",s),clearTimeout(n),void e({track:t.track,id:i})};this.peerConnection.addEventListener("track",s)}))})),n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(i),await tg.all(t)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(AI().supportPCSetConfiguration){const t=AL.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function OL(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("Locking from P2PConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function NL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function DL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?NL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):NL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}UR([OL,xR("design:type",Function),xR("design:paramtypes",[Object,Object,Array,Object,String,String]),xR("design:returntype",tg)],AL.prototype,"connect",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],AL.prototype,"stopSending",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[String,Array,String,Object]),xR("design:returntype",tg)],AL.prototype,"receive",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],AL.prototype,"stopReceiving",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],AL.prototype,"muteRemote",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],AL.prototype,"unmuteRemote",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],AL.prototype,"muteLocal",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],AL.prototype,"unmuteLocal",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],AL.prototype,"close",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],AL.prototype,"updateEncoderConfig",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],AL.prototype,"updateSendParameters",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[fw,String]),xR("design:returntype",tg)],AL.prototype,"replaceTrack",null),UR([OL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],AL.prototype,"getRemoteSSRC",null);const PL="9",kL=4e4;function LL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ML(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?LL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):LL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class UL extends MC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ai(t=Object.keys(Uy)).call(t,e)})))]}constructor(e,t){super(e,t),ih(this,"store",void 0),ih(this,"peerConnection",void 0),ih(this,"remoteSDP",void 0),ih(this,"initialOffer",void 0),ih(this,"transportEventReceiver",void 0),ih(this,"statsFilter",void 0),ih(this,"useXR",Dy("USE_XR")),ih(this,"localCapabilities",void 0),ih(this,"remoteCodecs",void 0),ih(this,"localCandidateCount",0),ih(this,"allCandidatesReceived",!1),ih(this,"dataStreamChannelMap",new Map),ih(this,"establishPromise",void 0),ih(this,"mutex",new zS("P2PConnection-mutex")),this.store=t,this.peerConnection=new RTCPeerConnection(UL.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=hk(this.peerConnection,Dy("STATS_UPDATE_INTERVAL"),void 0,vg()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const n=this.remoteSDP.toString();null==t||t(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}else zy.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else zy.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t))}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=mk(e.sdp),n=await Ik({filterRTX:!Dy("USE_PUB_RTX")&&!Dy("USE_SUB_RTX"),filterVideoFec:Dy("FILTER_VIDEO_FEC"),filterAudioFec:Dy("FILTER_AUDIO_FEC"),filterVideoCodec:Dy("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=Ok(n),this.initialOffer=e,ML(ML({},t),{},{rtpCapabilities:n,offerSDP:e.sdp})}catch(e){throw new Vg(xg.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,n,i,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return wS(this._localCapabilities)}get rtpCapabilities(){return wS(this._rtpCapabilities)}get candidates(){return wS(this._candidates)}get iceParameters(){return wS(this._iceParameters)}get dtlsParameters(){return wS(this._dtlsParameters)}constructor(e){ih(this,"sessionDesc",void 0),ih(this,"_localCapabilities",void 0),ih(this,"_rtpCapabilities",void 0),ih(this,"_candidates",void 0),ih(this,"_iceParameters",void 0),ih(this,"_dtlsParameters",void 0),ih(this,"setup",void 0),ih(this,"currentMidIndex",void 0),ih(this,"cname",void 0),ih(this,"firefoxSsrcMidMap",new Map),e=wS(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:s,cname:a}=e,c=zP.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=s,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const l of c.mediaDescriptions){if(l.attributes.iceUfrag=t.iceUfrag,l.attributes.icePwd=t.icePwd,l.attributes.fingerprints=n.fingerprints,l.attributes.candidates=i,l.attributes.setup=o,"video"===l.media.mediaType&&(l.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.videoCodecs,l.attributes.extmaps=d.videoExtensions,Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:kL,rtx:Dy("USE_SUB_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}if("audio"===l.media.mediaType&&(l.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.audioCodecs,l.attributes.extmaps=d.audioExtensions,Nk(l),Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:2e4}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=Dy("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,n=this.dtlsParameters,i=this.iceParameters,r=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+2e4,s=2*o+kL,{ssrcs:a,ssrcGroups:c}=Sk([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=Sk([{ssrcId:s,rtx:Dy("USE_SUB_RTX")?s+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:PL,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:PL,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return zP.print(this.sessionDesc)}send(e,t,n,i){const{ssrcs:r,ssrcGroups:o}=Sk(t,this.cname,Dy("SYNC_GROUP")?n:void 0),s=this.findPreloadMediaDesc(r);if(s){if(vg()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,s.attributes.mid),i&&(i.twcc||i.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(s,i),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r);let n;return-1===t||1===t&&(Tg()||Ig())||0===t&&Dy("USE_SUB_RTX")||wg()?(n=this.createOrRecycleSendMedia(e,r,o,"sendonly",i),this.updateBundleMids()):(n=wS(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=r,n.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,i)),vg()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,n.attributes.mid),{mid:n.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:n,mslabel:i}=e;return this.send(t,n,i)})),n=[];let i=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:r}=e;r&&(i=!0),n.push(t)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||vg()||wg()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ai(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ai(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((e,r)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,n,i[r])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===pC.TCP){if(0===t.length)return;if(Dy("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(DL(DL({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(DL(DL({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===pC.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(DL(DL({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else 0===t.length?(this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(DL(DL({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}restartICE(e){e=wS(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(vg()){if(i){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return i}))}createOrRecycleDataChannel(){for(const n of this.sessionDesc.mediaDescriptions)if("application"===n.media.mediaType)return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:PL,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,n,i,r,o){const s=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Pk(s,a,this.localCapabilities.send,s===hC.VIDEO?i:r),d=s===hC.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let u={media:{mediaType:s,port:PL,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};u=this.mungRecvMediaDsec(u,e,o);const h=this.findFirstClosedMedia(s);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteCodec(e,t,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ai(t=Object.keys(Uy)).call(t,e)})))],r=new Set(t);if(i.every((e=>r.has(e))))return zy.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>{var n;return Ai(n=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(n,t)}))));if(0===o.length)return zy.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(t)),!1;const s=[...new Set(o.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(zy.debug("updateRemoteCodec, from ".concat(i," to ").concat(s)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&Ai(e).call(e,t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return zy.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=Pk(hC.VIDEO,d,c,n);return a.forEach((e=>{const t=l.map((e=>e.payloadType.toString(10)));zy.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(l)),e.attributes.payloads=l,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,n,i,r){const o=this.rtpCapabilities.send,s=e===hC.VIDEO?o.videoCodecs:o.audioCodecs,a=e===hC.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:PL,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=wS(e);return vk(i),Tk(i,t),yk(i,t),Rk(i),Ck(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=wS(e);return Ck(n,t,this.localCapabilities.recv),Nk(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>vg()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:n,remoteRTPCapabilities:i,remoteSetup:r,localCapabilities:this.localCapabilities,cname:o}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString(),a=zP.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&Nk(c),this.useXR&&Dk(a);const d=zP.print(a),l=this.logSDPExchange(d||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s});const u=this.peerConnection.getTransceivers()[0];if(null!=u&&u.receiver&&this.tryBindTransportEvents(u.receiver),Dy("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,n){var i=this;return OP((function*(){const r=yield TP(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)})),vg()&&!0===Dy("SIMULCAST")&&(yield TP(i.applySimulcastForFirefox(o,e)));const s=yield TP(i.peerConnection.createOffer()),a=i.remoteSDP.predictReceivingMids(e.length),c=i.mungSendOfferSDP(s.sdp,e,a),d=zP.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Ek(t,Dy("USE_PUB_RTX"))}));let u;try{u=yield l}catch(r){u=[],i.remoteSDP.receive(e,t,n,u);const o=i.remoteSDP.toString();throw yield TP(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield TP(i.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield TP(i.stopSending(a,!0)),r}i.remoteSDP.receive(e,t,n,u);const h=i.remoteSDP.toString(),p=i.logSDPExchange(c,"offer","local","send");return yield TP(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield TP(i.applySimulcastEncodings(o,e)),yield TP(i.applySendEncodings(o,e)),null==p||p(h),yield TP(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),o.map(((e,t)=>{const n=a[t];return{localSSRC:l[t],id:n,transceiver:e}}))}catch(e){throw e instanceof Vg?e:new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);n&&"open"===n.readyState?zy.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:Dy("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),t.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:i}=this.remoteSDP.sendDataChannel();if(i){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t),zy.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else zy.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof Vg?e:new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof Vg?e:new Vg(xg.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),zy.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else zy.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const s=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==t||t(n.sdp||""),await this.peerConnection.setLocalDescription(n),zy.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else zy.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return OP((function*(){const n=yield TP(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(AI().supportPCSetConfiguration){const n=t.peerConnection.getConfiguration(),i=e===pC.RELAY?"relay":"all";n.iceTransportPolicy!==i&&(zy.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(i,"]")),n.iceTransportPolicy=i,t.peerConnection.setConfiguration(n))}else if(e===pC.RELAY)return;t.remoteSDP.updateCandidates(e);const n=yield TP(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=mk(n.sdp),{remoteIceParameters:r}=yield i.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString(),s=t.logSDPExchange(n.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield TP(t.peerConnection.setLocalDescription(n)),null==s||s(o),yield TP(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){zy.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Vg(xg.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?vg()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:n,remote:i}=t.getSelectedCandidatePair();return{local:ML(ML({},XP),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:ML(ML({},XP),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,zy.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,zy.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Dy("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(fS(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...UL.turnServerConfigToIceServers(e.turnServer.servers)),Dy("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...UL.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Dy("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),Dy("ENABLE_ENCODED_TRANSFORM")&&AI().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Rb(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Dy("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var e;null!=t&&t.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,t.state))},t.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=t.iceTransport;n&&(n.onstatechange=()=>{const e=null==t?void 0:t.iceTransport.state;var n;e&&(null===(n=this.onICETransportStateChange)||void 0===n||n.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:t}=n.getSelectedCandidatePair();zy.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol,address:t.address,port:t.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var n;if(t||(t=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))),!t)return zy.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return zy.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!AI().supportSetRtpSenderParameters)return zy.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},r={};switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(e._encoderConfig){var o;const{bitrateMax:t,frameRate:n,scaleResolutionDownBy:i}=e._encoderConfig;t&&(r.maxBitrate=1e3*t),(Ai(o=e._hints).call(o,zI.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(n&&(r.maxFramerate=bb(n)),i&&i>=1&&(r.scaleResolutionDownBy=i))}if(Dy("DSCP_TYPE")&&Lg()){var s;const e=Dy("DSCP_TYPE");Ai(s=["very-low","low","medium","high"]).call(s,e)&&(r.networkPriority=e)}const a=t.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];vg()&&!c&&(i.encodings=[r]),c&&Object.assign(c,r),Object.assign(a,i),zy.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await t.setParameters(a)}async applySendEncodings(e,t){try{if(!AI().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){const i=e[n],r=t[n];r instanceof NA&&!this.isVP8Simulcast(r)&&await this.updateRtpSenderEncodings(r,i.sender)}}catch(e){zy.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,n){const i=zP.parse(e);return t.forEach(((e,t)=>{const r=n[t],o=i.mediaDescriptions.find((e=>e.attributes.mid===r));o&&(Tk(o,e),bk(o,e,this.store.codec))})),zP.print(i)}mungReceiveAnswerSDP(e,t,n){const i=zP.parse(e),r=i.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&(n===hC.AUDIO&&"audio"===r.media.mediaType&&Nk(r),this.useXR&&Dk(i)),zP.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var n,i,r,o,s;const c=e[a],d=t[a];if(d instanceof NA&&!Ai(n=d._hints).call(n,zI.LOW_STREAM)&&null!==(i=d._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(r=d._encoderConfig)||void 0===r?void 0:r.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=d._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=c.sender.getParameters();await c.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!vg()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof NA&&this.isVP8Simulcast(i)){const t=e[n],r={},o={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,r))}}}isVP8Simulcast(e){var t,n,i,r,o;return!!(e instanceof NA&&Dy("SIMULCAST")&&"vp8"===this.store.codec&&!Ai(t=e._hints).call(t,zI.LOW_STREAM)&&null!==(n=e._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(r=e._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,t,n,i){if(Dy("SDP_LOGGING"))return zy.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(t," SDP during P2PConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(AI().supportPCSetConfiguration){const t=UL.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function xL(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function VL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function FL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?VL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):VL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}UR([xL,xR("design:type",Function),xR("design:paramtypes",[Array,Array]),xR("design:returntype",tg)],UL.prototype,"updateRemoteRTPCapabilities",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[Object,Object,Array,Object,String,String]),xR("design:returntype",tg)],UL.prototype,"connect",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[Object,Array]),xR("design:returntype",tg)],UL.prototype,"createDataChannels",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[String,Array,String,Object]),xR("design:returntype",tg)],UL.prototype,"receive",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],UL.prototype,"batchReceive",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],UL.prototype,"stopReceiving",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],UL.prototype,"muteRemote",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],UL.prototype,"unmuteRemote",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],UL.prototype,"muteLocal",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],UL.prototype,"unmuteLocal",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],UL.prototype,"close",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],UL.prototype,"updateEncoderConfig",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],UL.prototype,"updateSendParameters",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[fw,String]),xR("design:returntype",tg)],UL.prototype,"replaceTrack",null),UR([xL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],UL.prototype,"getRemoteSSRC",null);const jL="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",BL="9",GL=2e4,WL=4e4;class HL{get localCapabilities(){return wS(this._localCapabilities)}get rtpCapabilities(){return wS(this._rtpCapabilities)}get candidates(){return wS(this._candidates)}get iceParameters(){return wS(this._iceParameters)}get dtlsParameters(){return wS(this._dtlsParameters)}constructor(e){ih(this,"sessionDesc",void 0),ih(this,"_localCapabilities",void 0),ih(this,"_rtpCapabilities",void 0),ih(this,"_candidates",void 0),ih(this,"_iceParameters",void 0),ih(this,"_dtlsParameters",void 0),ih(this,"setup",void 0),ih(this,"currentMidIndex",void 0),ih(this,"cname",void 0),ih(this,"firefoxSsrcMidMap",new Map),e=wS(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:s,cname:a}=e,c=zP.parse(jL);this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=s,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const l of c.mediaDescriptions){if(l.attributes.iceUfrag=t.iceUfrag,l.attributes.icePwd=t.icePwd,l.attributes.fingerprints=n.fingerprints,l.attributes.candidates=i,l.attributes.setup=o,"application"===l.media.mediaType&&(l.attributes.sctpPort="5000"),"video"===l.media.mediaType&&(l.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.videoCodecs,l.attributes.extmaps=d.videoExtensions,Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:WL,rtx:Dy("USE_SUB_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}if("audio"===l.media.mediaType&&(l.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.audioCodecs,l.attributes.extmaps=d.audioExtensions,Nk(l),Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:GL}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=zP.parse(jL);this._rtpCapabilities=e;const n=this.rtpCapabilities.send;for(const i of t.mediaDescriptions){if(i.attributes.iceUfrag=this._iceParameters.iceUfrag,i.attributes.icePwd=this._iceParameters.icePwd,i.attributes.fingerprints=this._dtlsParameters.fingerprints,i.attributes.candidates=this._candidates,i.attributes.setup=this.setup,"application"===i.media.mediaType&&(i.attributes.sctpPort="5000"),"video"===i.media.mediaType&&(i.media.fmts=n.videoCodecs.map((e=>e.payloadType.toString(10))),i.attributes.payloads=n.videoCodecs,i.attributes.extmaps=n.videoExtensions,Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:WL,rtx:Dy("USE_SUB_RTX")?40001:void 0}],this.cname);i.attributes.ssrcs=e,i.attributes.ssrcGroups=t}if("audio"===i.media.mediaType&&(i.media.fmts=n.audioCodecs.map((e=>e.payloadType.toString(10))),i.attributes.payloads=n.audioCodecs,i.attributes.extmaps=n.audioExtensions,Dy("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=Sk([{ssrcId:GL}],this.cname);i.attributes.ssrcs=e,i.attributes.ssrcGroups=t}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,n=this.dtlsParameters,i=this.iceParameters,r=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+GL,s=2*o+WL,{ssrcs:a,ssrcGroups:c}=Sk([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=Sk([{ssrcId:s,rtx:Dy("USE_SUB_RTX")?s+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:BL,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:BL,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return zP.print(this.sessionDesc)}send(e,t,n,i){const{ssrcs:r,ssrcGroups:o}=Sk(t,this.cname,Dy("SYNC_GROUP")?n:void 0),s=this.findPreloadMediaDesc(r);if(s){if(vg()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,s.attributes.mid),i&&(i.twcc||i.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(s,i),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r);let n;return-1===t||Tg()||yg()||Ig()||0===t&&Dy("USE_SUB_RTX")?(n=this.createOrRecycleSendMedia(e,r,o,"sendonly",i),this.updateBundleMids()):(n=wS(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=r,n.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,i)),vg()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,n.attributes.mid),{mid:n.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:n,mslabel:i}=e;return this.send(t,n,i)})),n=[];let i=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:r}=e;r&&(i=!0),n.push(t)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||vg()||Tg()||yg()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ai(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ai(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((e,r)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,n,i[r])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===pC.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(FL(FL({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(e){e=wS(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(vg()){if(i){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return i}))}createOrRecycleRecvMedia(e,t,n,i,r,o){const s=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Pk(s,a,this.localCapabilities.send,s===hC.VIDEO?i:r),d=s===hC.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let u={media:{mediaType:s,port:BL,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};u=this.mungRecvMediaDsec(u,e,o);const h=this.findFirstClosedMedia(s);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteCodec(e,t,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ai(t=Object.keys(Uy)).call(t,e)})))],r=new Set(t);if(i.every((e=>r.has(e))))return zy.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>{var n;return Ai(n=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(n,t)}))));if(0===o.length)return zy.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(t)),!1;const s=[...new Set(o.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(zy.debug("updateRemoteCodec, from ".concat(i," to ").concat(s)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&Ai(e).call(e,t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return zy.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=Pk(hC.VIDEO,d,c,n);return a.forEach((e=>{const t=l.map((e=>e.payloadType.toString(10)));zy.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(l)),e.attributes.payloads=l,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,n,i,r){const o=this.rtpCapabilities.send,s=e===hC.VIDEO?o.videoCodecs:o.audioCodecs,a=e===hC.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:BL,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=wS(e);return vk(i),Tk(i,t),yk(i,t),Rk(i),Ck(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=wS(e);return Ck(n,t,this.localCapabilities.recv),Nk(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>vg()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}function KL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function zL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?KL(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):KL(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class YL extends MC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=Ok(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ai(t=Object.keys(Uy)).call(t,e)})))]}constructor(e,t,n){super(e,t),ih(this,"store",void 0),ih(this,"peerConnection",void 0),ih(this,"remoteSDP",void 0),ih(this,"initialOffer",void 0),ih(this,"transportEventReceiver",void 0),ih(this,"statsFilter",void 0),ih(this,"useXR",Dy("USE_XR")),ih(this,"localCapabilities",void 0),ih(this,"localCandidateCount",0),ih(this,"allCandidatesReceived",!1),ih(this,"remoteCodecs",void 0),ih(this,"dataStreamChannelMap",new Map),ih(this,"establishPromise",void 0),ih(this,"mutex",new zS("NVExtentionsConnection-mutex")),ih(this,"rtcMedia",void 0),this.store=t,this.peerConnection=n,this.statsFilter=hk(this.peerConnection,Dy("STATS_UPDATE_INTERVAL"),void 0,vg()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=mk(e.sdp),n=await Ik({filterRTX:!Dy("USE_PUB_RTX")&&!Dy("USE_SUB_RTX"),filterVideoFec:Dy("FILTER_VIDEO_FEC"),filterAudioFec:Dy("FILTER_AUDIO_FEC"),filterVideoCodec:Dy("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=n,this.initialOffer=e,zL(zL({},t),{},{rtpCapabilities:n,offerSDP:e.sdp})}catch(e){throw new VR(xg.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,n,i,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new HL({remoteIceParameters:e,remoteDtlsParameters:t,candidates:n,remoteRTPCapabilities:i,remoteSetup:r,localCapabilities:Ok(this.localCapabilities),cname:o});const s=this.remoteSDP.toString(),a=zP.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&Nk(c),this.useXR&&Dk(a);const d=zP.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const n=this.remoteSDP.toString();null==t||t(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}else zy.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else zy.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t))}async updateRemoteConnect(e){var t,n,i,r;null===(t=this.remoteSDP)||void 0===t||t.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&(null===(r=this.remoteSDP)||void 0===r||r.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),null===(n=this.remoteSDP)||void 0===n||n.preloadRemoteMedia(2);const o=null===(i=this.remoteSDP)||void 0===i?void 0:i.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),zy.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,n){var i=this;return OP((function*(){const r=yield TP(i.mutex.lock("From NVExtentionsConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t)})),vg()&&!0===Dy("SIMULCAST")&&(yield TP(i.applySimulcastForFirefox(o,e)));const s=yield TP(i.peerConnection.createOffer()),a=i.remoteSDP.predictReceivingMids(e.length),c=i.mungSendOfferSDP(s.sdp,e,a),d=zP.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Ek(t,Dy("USE_PUB_RTX"))}));let u;try{u=yield l}catch(r){u=[],i.remoteSDP.receive(e,t,n,u);const o=i.remoteSDP.toString();throw yield TP(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield TP(i.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield TP(i.stopSending(a,!0)),r}i.remoteSDP.receive(e,t,n,u);const h=i.remoteSDP.toString(),p=i.logSDPExchange(c,"offer","local","send");return yield TP(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield TP(i.applySimulcastEncodings(o,e)),yield TP(i.applySendEncodings(o,e)),null==p||p(h),yield TP(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),o.map(((e,t)=>{const n=a[t];return{localSSRC:l[t],id:n,transceiver:e}}))}catch(e){throw e instanceof VR?e:new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);return n&&"open"===n.readyState?zy.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:Dy("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),void t.forEach((e=>{e._updateOriginDataChannel(n)}))}catch(e){throw e instanceof VR?e:new VR(xg.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof VR?e:new VR(xg.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),zy.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else zy.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const s=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r}}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==t||t(n.sdp||""),await this.peerConnection.setLocalDescription(n),zy.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else zy.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return OP((function*(){const n=yield TP(t.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(AI().supportPCSetConfiguration){const n=t.peerConnection.getConfiguration(),i=e===pC.RELAY?"relay":"all";n.iceTransportPolicy!==i&&(zy.debug("restartICE change iceTransportPolicy from [".concat(n.iceTransportPolicy,"] to [").concat(i,"]")),n.iceTransportPolicy=i,t.peerConnection.setConfiguration(n))}else if(e===pC.RELAY)return;e!==pC.RELAY&&t.remoteSDP.updateCandidates(e);const n=yield TP(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=mk(n.sdp),{remoteIceParameters:r}=yield i.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString(),s=t.logSDPExchange(n.sdp||"","offer","local","restartICE");yield TP(t.peerConnection.setLocalDescription(n)),null==s||s(o),yield TP(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){zy.warning("restart ICE failed, abort operation",e)}finally{n()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new VR(xg.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?vg()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return zL(zL({},mk(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,zy.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,zy.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Dy("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(fS(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...YL.turnServerConfigToIceServers(e.turnServer.servers)),Dy("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...YL.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Dy("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Rb(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Dy("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,t){try{if(!AI().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let l=0;l<e.length;l++){const u=e[l],h=t[l];if(h&&h instanceof NA){var n,i,r;if(this.isVP8Simulcast(h))continue;const e={},t={};switch(h._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var o,s,a,c;if(null!==(n=h._encoderConfig)&&void 0!==n&&n.bitrateMax&&(t.maxBitrate=1e3*(null===(o=h._encoderConfig)||void 0===o?void 0:o.bitrateMax)),Ai(i=h._hints).call(i,zI.LOW_STREAM)&&(null!==(s=h._encoderConfig)&&void 0!==s&&s.frameRate&&(t.maxFramerate=bb(h._encoderConfig.frameRate)),null!==(a=h._encoderConfig)&&void 0!==a&&a.scaleResolutionDownBy&&(null===(c=h._encoderConfig)||void 0===c?void 0:c.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=h._encoderConfig.scaleResolutionDownBy)),Dy("DSCP_TYPE")&&Lg()){var d;const e=Dy("DSCP_TYPE");Ai(d=["very-low","low","medium","high"]).call(d,e)&&(t.networkPriority=e)}const l=u.sender.getParameters(),p=null===(r=l.encodings)||void 0===r?void 0:r[0];vg()&&!p&&(e.encodings=[t]),p&&Object.assign(p,t),Object.assign(l,e),await u.sender.setParameters(l)}}}catch(e){zy.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,n){const i=zP.parse(e);return t.forEach(((e,t)=>{const r=n[t],o=i.mediaDescriptions.find((e=>e.attributes.mid===r));o&&(Tk(o,e),bk(o,e,this.store.codec))})),zP.print(i)}mungReceiveAnswerSDP(e,t,n){const i=zP.parse(e),r=i.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&n===hC.AUDIO&&"audio"===r.media.mediaType&&Nk(r),this.useXR&&Dk(i),zP.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var n,i,r,o,s;const c=e[a],d=t[a];if(d instanceof NA&&!Ai(n=d._hints).call(n,zI.LOW_STREAM)&&null!==(i=d._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(r=d._encoderConfig)||void 0===r?void 0:r.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=d._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=c.sender.getParameters();await c.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!vg()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof NA&&this.isVP8Simulcast(i)){const t=e[n],r={},o={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,r))}}}isVP8Simulcast(e){var t,n,i,r,o;return!!(e instanceof NA&&Dy("SIMULCAST")&&"vp8"===this.store.codec&&!Ai(t=e._hints).call(t,zI.LOW_STREAM)&&null!==(n=e._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(r=e._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,t,n,i){if(Dy("SDP_LOGGING"))return zy.upload("exchanging ".concat(n," ").concat(t," SDP during NVExtentionsConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(AI().supportPCSetConfiguration){const t=YL.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function qL(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function JL(e){var t,n,i,r=2;for("undefined"!=typeof Symbol&&(n=RL,i=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(i&&null!=(t=e[i]))return new XL(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function XL(e){function t(e){if(Object(e)!==e)return tg.reject(new TypeError(e+" is not an object."));var t=e.done;return tg.resolve(e.value).then((function(e){return{value:e,done:t}}))}return XL=function(e){this.s=e,this.n=e.next},XL.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?tg.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?tg.reject(e):t(n.apply(this.s,arguments))}},new XL(e)}UR([qL,xR("design:type",Function),xR("design:paramtypes",[Object,Object,Array,Object,String,String]),xR("design:returntype",tg)],YL.prototype,"connect",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Array,Array]),xR("design:returntype",tg)],YL.prototype,"updateRemoteRTPCapabilities",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],YL.prototype,"updateRemoteConnect",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Object,Array]),xR("design:returntype",tg)],YL.prototype,"createDataChannels",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[String,Array,String,Object]),xR("design:returntype",tg)],YL.prototype,"receive",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],YL.prototype,"batchReceive",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],YL.prototype,"stopReceiving",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],YL.prototype,"muteRemote",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],YL.prototype,"unmuteRemote",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],YL.prototype,"muteLocal",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],YL.prototype,"unmuteLocal",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],YL.prototype,"close",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],YL.prototype,"updateEncoderConfig",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],YL.prototype,"updateSendParameters",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[fw,String]),xR("design:returntype",tg)],YL.prototype,"replaceTrack",null),UR([qL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],YL.prototype,"getRemoteSSRC",null);class QL extends MC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,t){super(e,t),ih(this,"store",void 0),ih(this,"peerConnection",void 0),ih(this,"cname",void 0),ih(this,"mutex",new zS("DataChannelConnection-mutex")),ih(this,"dataChannel",void 0),ih(this,"_p2pConnection",void 0),ih(this,"establishPromise",void 0),ih(this,"_nvMedia",void 0),this.store=t,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(QL.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new YL(e,t,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,n,i,r,o){return this.cname=o,await this._p2pConnection.connect(e,t,n,i,r,o),await new tg(((e,t)=>{const i=setTimeout((()=>{this.closeSignal(),t(new VR(xg.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(n))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(i),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,n){var i=this;return OP((function*(){const r=yield TP(i.mutex.lock("From DataChannelConnection.send"));try{return yield*yL(JL(i._p2pConnection.send(e,t,n)))}finally{r()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,t,n,i){return this._nvMedia?(zy.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,t,this.cname)):(zy.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,t,n,i))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return OP((function*(){return yield*yL(JL(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,t,n,i){if(Dy("SDP_LOGGING"))return zy.upload("exchanging ".concat(n," ").concat(t," SDP during DataChannelConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(fS(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...QL.turnServerConfigToIceServers(e.turnServer.servers)),Dy("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...QL.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Dy("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Rb(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Dy("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,n)=>{var i;return null===(i=this.onFirstVideoDecoded)||void 0===i?void 0:i.call(this,e,t,n)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var n;return null===(n=this.onSelectedLocalCandidateChanged)||void 0===n?void 0:n.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var n;return null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n?void 0:n.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function ZL(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From DataChannelConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function $L(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function eM(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$L(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$L(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function tM(e){var t,n,i,r=2;for("undefined"!=typeof Symbol&&(n=RL,i=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(i&&null!=(t=e[i]))return new nM(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function nM(e){function t(e){if(Object(e)!==e)return tg.reject(new TypeError(e+" is not an object."));var t=e.done;return tg.resolve(e.value).then((function(e){return{value:e,done:t}}))}return nM=function(e){this.s=e,this.n=e.next},nM.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?tg.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?tg.reject(e):t(n.apply(this.s,arguments))}},new nM(e)}UR([ZL,xR("design:type",Function),xR("design:paramtypes",[Object,Object,Array,Object,String,String]),xR("design:returntype",tg)],QL.prototype,"connect",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[Array,Array]),xR("design:returntype",tg)],QL.prototype,"updateRemoteRTPCapabilities",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[Object,Array]),xR("design:returntype",tg)],QL.prototype,"createDataChannels",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[String,Array,String,Object]),xR("design:returntype",tg)],QL.prototype,"receive",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],QL.prototype,"stopReceiving",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],QL.prototype,"muteRemote",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],QL.prototype,"unmuteRemote",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],QL.prototype,"muteLocal",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],QL.prototype,"unmuteLocal",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],QL.prototype,"close",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],QL.prototype,"updateEncoderConfig",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[String,fw]),xR("design:returntype",tg)],QL.prototype,"updateSendParameters",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[fw,String]),xR("design:returntype",tg)],QL.prototype,"replaceTrack",null),UR([ZL,xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],QL.prototype,"getRemoteSSRC",null);class iM extends nS{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(EC.StateChange,t,this._state)}constructor(e,t){super(),ih(this,"store",void 0),ih(this,"statsUploader",void 0),ih(this,"connection",void 0),ih(this,"localTrackMap",new Map),ih(this,"remoteUserMap",new Map),ih(this,"localDataChannels",[]),ih(this,"remoteDataChannelMap",new Map),ih(this,"pendingLocalTracks",[]),ih(this,"pendingRemoteTracks",[]),ih(this,"pendingLocalDataChannels",[]),ih(this,"pendingRemoteDataChannels",[]),ih(this,"statsCollector",void 0),ih(this,"isPlanB",!1),ih(this,"shouldForwardP2PCreation",void 0),ih(this,"iceFailedCount",0),ih(this,"dtlsFailedCount",0),ih(this,"mutex",new zS("P2PChannel-mutex")),ih(this,"_state",mC.Disconnected),ih(this,"_pcStatsUploadType",Dy("NEW_ICE_RESTART")?fC.FIRST_CONNECTION:fC.OLD_FIRST_CONNECTION),ih(this,"_isInRestartIce",!1),ih(this,"_isStartRestartIce",!1),ih(this,"_restartStates",["disconnected","failed"]),ih(this,"_restartTimer",void 0),ih(this,"_isFirstConnected",!0),ih(this,"handleMuteLocalTrack",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==mC.Connected)return void n(new Vg(xg.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const i=this.filterTobeMutedTracks(e);if(0===i.length)return void t();const r=i.find((e=>"videoLowTrack"===e[0]));r&&r[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(i.map((e=>{let[,{id:t}]=e;return t})));const o=this.createMuteMessage(i);await gS(this,EC.RequestMuteLocal,o),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleUnmuteLocalTrack",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==mC.Connected)return void n(new Vg(xg.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const i=this.filterTobeUnmutedTracks(e);if(0===i.length)return void t();const r=i.find((e=>"videoLowTrack"===e[0]));if(r){const t=r[1];if(t.track._originMediaStreamTrack.stop(),!Dy("DISABLE_DUAL_STREAM_USE_ENCODING")&&AI().supportDualStreamEncoding){const n=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n}else{const n=Fk(e,TS(this,EC.RequestLowStreamParameter));t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n}await new tg(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}await this.connection.unmuteLocal(i.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(i);await gS(this,EC.RequestUnmuteLocal,o),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleUpdateVideoEncoder",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const n=this.localTrackMap.get(_C.LocalVideoTrack);if(!this.connection||!n||n.track!==e||this.state!==mC.Connected)return void t();const{id:i,track:r}=n;await this.connection.updateSendParameters(i,r),await this.connection.updateEncoderConfig(i,r),this.emit(EC.UpdateVideoEncoder,r),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleSetOptimizationMode",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const n=this.localTrackMap.get(_C.LocalVideoTrack);if(!this.connection||!n||n.track!==e||this.state!==mC.Connected)return;const{id:i,track:r}=n;await this.connection.updateSendParameters(i,r),t()}catch(e){n(e)}finally{i()}})),ih(this,"handleReplaceTrack",(async(e,t,n,i)=>{let r;zy.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof i&&i||(r=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var o;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(!this.connection||!n||this.state!==mC.Connected)return void t();if(await(null===(o=this.connection)||void 0===o?void 0:o.replaceTrack(e,n[1].id)),this.isPlanB){const t=n[1];t.id=e._mediaStreamTrack.id,this.localTrackMap.set(n[0],t)}if(n[0]===_C.LocalVideoTrack&&!Dy("DISABLE_DUAL_STREAM_USE_ENCODING")&&AI().supportDualStreamEncoding){const t=this.localTrackMap.get(_C.LocalVideoLowTrack);if(t){const n=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n,await new tg(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}}t()}catch(e){n(e)}finally{var s;null===(s=r)||void 0===s||s()}})),ih(this,"handleGetRTCStats",(e=>{e(this.statsCollector.getRTCStats())})),ih(this,"handleGetLocalVideoStats",(e=>{e(this.statsCollector.getLocalVideoTrackStats())})),ih(this,"handleGetLocalAudioStats",(e=>{e(this.statsCollector.getLocalAudioTrackStats())})),ih(this,"handleGetRemoteVideoStats",(e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid])),ih(this,"handleGetRemoteAudioStats",(e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new tL(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!AI().supportUnifiedPlan||Dy("CHROME_FORCE_PLAN_B")&&Lg(),this.shouldForwardP2PCreation=Dy("FORWARD_P2P_CREATION")&&AI().supportPCSetConfiguration&&function(){const e=fg();return e===ag.ANDROID||e===ag.IOS||e===ag.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new QL({},this.store):this.isPlanB?new AL({},this.store):new UL({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var n;this.state=mC.New;const i=this.shouldForwardP2PCreation&&"closed"===(null===(n=this.connection)||void 0===n?void 0:n.peerConnectionState);if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(zy.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new QL(e,this.store):this.isPlanB?new AL(e,this.store):new UL(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=Dy("NEW_ICE_RESTART")?fC.FIRST_CONNECTION:fC.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,n,i,r,o){if(!this.connection)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof QL?this.connection.updateRemoteConnect(i):(this.store.peerConnectionStart(),await this.connection.connect(e,t,n,i,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=mC.Connected)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter((e=>{var t;let[n]=e;return Ai(t=[_C.LocalVideoLowTrack,_C.LocalVideoTrack]).call(t,n)})),n=t.map((e=>{let[,{id:t}]=e;return t})),i=t.map((e=>{let[t]=e;return t}));if(this.connection instanceof UL){if(oR.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!Ai(e).call(e,this.store.codec)){const t=["vp8","h264"].find((t=>Ai(e).call(e,t)));t&&(this.store.codec=t,zy.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(t,".")))}this.connection.updateRemoteRTPCapabilities(n,e)}}async preConnect(e,t,n,i,r,o){if(!this.connection)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const s=await this.connection.connect(e,t,n,i,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=mC.Connected,s}getEstablishParams(){if(this.connection instanceof QL)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection){if(this.state===mC.Disconnected)throw new Vg(xg.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const t=e.filter((e=>-1!==this.pendingLocalDataChannels.findIndex((t=>t.id===e.id))));return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(t))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,n){var i=this;return OP((function*(){const r=yield TP(i.mutex.lock("From P2PChannel.publish"));try{if(!i.connection||i.state!==mC.Connected){if(i.state===mC.Disconnected)throw new Vg(xg.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===i.pendingLocalTracks.indexOf(e)));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(t))}i.store.pubId=i.store.pubId+1,gP.markPublishStart(i.store.clientId,i.store.pubId);const r=i.filterTobePublishedTracks(e,t,n);if(0===r.length)return void(yield TP(i.tryToUnmuteAudio(e)));yield*yL(tM(i.doPublish(i.connection,r)))}finally{r()}}))()}doPublish(e,t){var n=this;return OP((function*(){t.forEach((e=>{let{track:t,type:i}=e;const r=Date.now();n.store.publish(t.getTrackId(),i===_C.LocalAudioTrack?"audio":"video",r)})),n.bindLocalTrackEvents(t);const i=yield TP(e.send(t.map((e=>{let{track:t}=e;return t})),n.store.codec,n.store.audioCodec)),r=(yield TP(i.next())).value,o=n.createGatewayPublishMessage(t,r);let s;try{s=yield o}catch(e){throw i.throw(e),(null==e?void 0:e.code)===xg.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===n.pendingLocalTracks.indexOf(t)&&n.pendingLocalTracks.push(t)})),n.unbindLocalTrackEvents(t),e}const a=n.mapPubResToRemoteConfig(o,s),c=(yield TP(i.next(a))).value;t.forEach((e=>{let{type:t}=e;n.statsCollector.addLocalStats(t)})),n.assignLocalTracks(t,c),n.statsUploader.startUploadOutboundStats(),t.forEach((e=>{let{track:t,type:i}=e;const r=Date.now();n.store.publish(t.getTrackId(),i===_C.LocalAudioTrack?"audio":"video",void 0,r)}))}))()}async updateVideoStreamParameter(e,t){const n=this.localTrackMap.get(t);if(!n)return;if(!(n.track instanceof NA))return zy.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof UL||this.connection instanceof AL))return zy.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:i}=n,r=function(e,t){const n={};return e.height&&e.width&&(n.scaleResolutionDownBy=Nb(e,t)),n.maxFramerate=e.framerate?bb(e.framerate):void 0,n.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,n}(e,i);if(i._encoderConfig||(i._encoderConfig={}),t!==_C.LocalVideoLowTrack||!Dy("DISABLE_DUAL_STREAM_USE_ENCODING")&&AI().supportDualStreamEncoding)null!=r.scaleResolutionDownBy&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const t=i._originMediaStreamTrack;if(!t.canvas)return zy.warn("[".concat(i.getTrackId(),"] no canvas on track"));!function(e,t){const n=e.canvas;t.width&&(n.width=bb(t.width)),t.height&&(n.height=bb(t.height)),t.framerate&&(n.stopCapture&&n.stopCapture(),n.stopCapture=Cw((()=>{!n.startCapture&&n.stopCapture&&n.stopCapture(),n.startCapture&&n.startCapture()}),bb(t.framerate)))}(t,e)}null!=r.maxBitrate&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),null!=r.maxFramerate&&(i._encoderConfig.frameRate&&"object"==typeof i._encoderConfig.frameRate?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),zy.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(e){var t=this;return OP((function*(){if(!t.connection||t.state!==mC.Connected)return;const n=yield TP(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const n=t.localTrackMap.get(_C.LocalVideoTrack);if(!n)throw new Vg(xg.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(_C.LocalVideoLowTrack))throw new Vg(xg.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const r=[{track:t.getLowVideoTrack(n.track,e),type:_C.LocalVideoLowTrack}];if(yield*yL(tM(t.doPublish(t.connection,r))),n.track.muted||!n.track.enabled){var i;const e=null===(i=t.localTrackMap.get(_C.LocalVideoLowTrack))||void 0===i?void 0:i.id;void 0!==e&&(yield TP(t.connection.muteLocal([e])))}}finally{n()}}))()}async republish(){this.pendingLocalTracks.length>0&&(zy.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await ES(this,EC.RequestRePublish,this.pendingLocalTracks),this.emit(EC.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(zy.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await ES(this,EC.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:e,kind:n}=this.pendingRemoteTracks[t];(n!==hC.AUDIO||e._audio_added_&&e._audioSSRC)&&(n!==hC.VIDEO||e._video_added_&&e._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await ES(this,EC.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:n}of this.pendingRemoteTracks)await this.subscribe(t,n,n===hC.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(EC.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==mC.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const n=t.find((e=>"videoLowTrack"===e[0]));return n&&n[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==mC.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==mC.Connected)return;const e=this.localTrackMap.get(_C.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[_C.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const n=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:n}]=e;return{type:t,track:n}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(e,t){if(!this.connection||this.state!==mC.Connected)throw new Vg(xg.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=t.filter((t=>{var n;return!(null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.get(t.id))}));if(0!==n.length)return await this.connection.createDataChannels(e.uid,n),n.forEach((t=>{var n;this.remoteDataChannelMap.has(e)?null===(n=this.remoteDataChannelMap.get(e))||void 0===n||n.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const i=this.pendingRemoteDataChannels.findIndex((n=>{let{user:i,id:r}=n;return i.uid===e.uid&&r===t.id}));-1!==i&&this.pendingRemoteDataChannels.splice(i,1)})),n.map((e=>e.id))}async subscribe(e,t,n,i,r){var o;if(!this.connection||this.state!==mC.Connected)throw new Vg(xg.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(o=this.remoteUserMap.get(e))&&void 0!==o&&o.has(t))return;let s,a,c;if(r){const n=r.find((e=>{let{stream_type:n}=e;return n===t}));if(!n)throw new Vg(xg.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const i=await this.connection.receive(t,n.ssrcs,String(e._uintid),n.attributes);this.connection instanceof UL&&(c=i.transceiver),s=i.track,a=i.id}else{const r=await this.connection.receive(t,[{ssrcId:n,rtx:i}],String(e._uintid),void 0);this.connection instanceof UL&&(c=r.transceiver),s=r.track,a=r.id}t===hC.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new FA(s,e.uid,e._uintid,this.store),zy.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new VA(s,e.uid,e._uintid,this.store),zy.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const d=this.remoteUserMap.get(e);d?d.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex((n=>{let{user:i,kind:r}=n;return i.uid===e.uid&&t===r}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(EC.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==mC.Connected)throw new Vg(xg.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:n,mediaType:i}=e;return!(null!==(t=this.remoteUserMap.get(n))&&void 0!==t&&t.has(i))}));const t=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:n,ssrcId:i,rtxSsrcId:r}=e;return{kind:n,ssrcMsg:[{ssrcId:i,rtx:r}],mslabel:String(t._uintid)}})));e.forEach(((e,n)=>{let{user:i,mediaType:r}=e;const{track:o,id:s,transceiver:a}=t[n];r===hC.AUDIO?(i._audioTrack?i._audioTrack._updateOriginMediaStreamTrack(o):(i._audioTrack=new FA(o,i.uid,i._uintid,this.store),zy.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(i._audioTrack.getTrackId()))),a&&i._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(i,i._audioTrack)):(i._videoTrack?i._videoTrack._updateOriginMediaStreamTrack(o):(i._videoTrack=new VA(o,i.uid,i._uintid,this.store),zy.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(i._videoTrack.getTrackId()))),a&&i._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(i,i._videoTrack));const c=this.remoteUserMap.get(i);c?c.set(r,s):this.remoteUserMap.set(i,new Map([[r,s]])),this.statsCollector.addRemoteStats(i.uid),this.statsUploader.startUploadInboundStats();const d=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:n}=e;return t.uid===i.uid&&r===n}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(EC.MediaReconnectEnd,i.uid))}))}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((n=>{let{user:i,kind:r}=n;return void 0!==t?i.uid===e.uid&&t===r:i.uid===e.uid}));if(i.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===mC.Connected||n||i.forEach((t=>{let{kind:n}=t;var i;if(n===hC.AUDIO)null===(i=e._audioTrack)||void 0===i||i._destroy(),e._audioTrack=void 0;else if(n===hC.VIDEO){var r;null===(r=e._videoTrack)||void 0===r||r._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==mC.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(0===r.length)return;await this.connection.stopReceiving(r.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),r.forEach((e=>{let[t,{kind:i}]=e;var r,o;if(i===hC.VIDEO&&t._videoSSRC&&(null===(r=this.connection)||void 0===r||r.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),i===hC.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),n||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(i===hC.AUDIO){var s;this.unbindRemoteTrackEvents(t._audioTrack),n||(null===(s=t._audioTrack)||void 0===s||s._destroy(),t._audioTrack=void 0)}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(e,t);if(0===n.length)return;t.forEach((e=>{e._close()}));const i=this.remoteDataChannelMap.get(e);return n.forEach((e=>{i&&i.delete(e.id)})),i&&0===i.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),n.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:o}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:n}=e;return void 0!==o?t.uid===r.uid&&o===n:t.uid===r.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==mC.Connected)return void t.forEach((e=>{let{user:t,kind:n}=e;var i;if(n===hC.AUDIO)null===(i=t._audioTrack)||void 0===i||i._destroy(),t._audioTrack=void 0;else if(n===hC.VIDEO){var r;null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0}}));const n=cT(e).call(e,((e,t)=>{let{user:n,mediaType:i}=t;const r=this.filterTobeUnSubscribedTracks(n,i);return e.concat(r)}),[]);if(0===n.length)return;await this.connection.stopReceiving(n.map((e=>{let[,{id:t}]=e;return t})));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),n.forEach((e=>{let[t,{kind:n}]=e;var i,r;if(n===hC.VIDEO&&t._videoSSRC&&(null===(i=this.connection)||void 0===i||i.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),n===hC.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0;else if(n===hC.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),i}async muteRemote(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void zy.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void zy.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===hC.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==i&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);n?n.get(t)||zy.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,".")):zy.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(_C.LocalAudioTrack);if((null==t?void 0:t.track)instanceof uA){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==_C.LocalAudioTrack})).filter((t=>{let[n]=t;return!(e&&n===_C.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[n]=t;return!(e&&n===_C.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,i,r){if(e){const n=this.localTrackMap.get(_C.LocalAudioTrack),o=i?this.localTrackMap.get(_C.LocalVideoLowTrack):this.localTrackMap.get(_C.LocalVideoTrack);oR.publish(this.store.sessionId,{eventElapse:gP.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(zI.SCREEN_TRACK)),audio:!!n,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find((e=>e instanceof cA)),a=i?null===(o=this.localTrackMap.get(_C.LocalVideoTrack))||void 0===o?void 0:o.track:n.find((e=>e instanceof NA));oR.publish(this.store.sessionId,{eventElapse:gP.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==s?void 0:s.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(zI.SCREEN_TRACK)),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===hC.VIDEO?n._videoSSRC:n._audioSSRC;r&&oR.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===hC.VIDEO,audio:i===hC.AUDIO,peerid:n.uid,subscribeRequestid:i===hC.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:gP.measureFromSubscribeStart(this.store.clientId,r)})}reset(){zy.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new zS("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new QL({},this.store):this.isPlanB?new AL({},this.store):new UL({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(_C.LocalAudioTrack);if((null==e?void 0:e.track)instanceof uA){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=mC.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(_C.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(_C.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof NA||t&&t.track instanceof cA?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(_C.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=Zh(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(zy.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=mC.Reconnecting,Dy("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&(null===(n=t._videoTrack._player.getVideoElement())||void 0===n||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new QL({},this.store):this.isPlanB?new AL({},this.store):new UL({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case _C.LocalVideoTrack:Ai(t=i._hints).call(t,zI.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case _C.LocalAudioTrack:i instanceof uA?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case _C.LocalVideoLowTrack:}})),this.emit(EC.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(uh(n).call(n)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(EC.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,n]=e;Array.from(uh(n).call(n)).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),zy.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((e instanceof nL?e.uid:e)===i.uid&&r===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof nL?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return OP((function*(){if(!t.connection||t.state!==mC.Connected||t.connection instanceof QL)return;const n=yield TP(t.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield TP(t.connection.restartICE(e));const n=yield TP(i.next());if(n.done)return;const r=n.value,o=yield r;switch(t.reportPCDisconnectedOrFailed(e),e){case pC.TCP:t._pcStatsUploadType=fC.TCP_RESTART;break;case pC.RELAY:t._pcStatsUploadType=fC.RELAY_RESTART;break;default:t._pcStatsUploadType=fC.OLD_RESTART}t._isInRestartIce=!0,i.next(o)}catch(e){var r;null===(r=i)||void 0===r||r.throw(e)}finally{n()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(_C.LocalVideoTrack),n=this.localTrackMap.get(_C.LocalAudioTrack),i=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),r=e.audioSend.find((e=>e.ssrc===(null==n?void 0:n.ssrcs[0].ssrcId)));if(!i||!r)return 1;const o=SS(this,EC.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=null==t?void 0:t.track;if(h&&h._encoderConfig&&-1===h._hints.indexOf(zI.SCREEN_TRACK)){const t=h._encoderConfig.bitrateMax,n=e.bitrate.actualEncoded;if(t&&n){const e=(1e3*t-n)/(1e3*t);return cR[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=e.audioRecv.find((e=>e.ssrc===r)),a=e.videoRecv.find((e=>e.ssrc===o));if(!s&&!a)return void(t+=1);const c=SS(this,EC.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new tg(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}filterTobePublishedTracks(e,t,n){const i=[],r=AI(),o=this.getAllTracks();e=bS(e=e.filter((e=>-1===o.indexOf(e))));let s=!1,a=!1;for(const c of e){if(c instanceof NA&&(this.localTrackMap.has(_C.LocalVideoTrack)||s?new Vg(xg.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:_C.LocalVideoTrack}),s=!0),t)){const e=this.getLowVideoTrack(c,n);i.push({track:e,type:_C.LocalVideoLowTrack})}if(c instanceof cA){const e=this.localTrackMap.get(_C.LocalAudioTrack);if(e){if(!(e.track instanceof uA))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const e=i.find((e=>{let{type:t}=e;return t===_C.LocalAudioTrack}));if(!(e.track instanceof uA))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof uA||c._bypassWebAudio)i.push({track:c,type:_C.LocalAudioTrack});else{const e=new uA;e.addAudioTrack(c),i.push({track:e,type:_C.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=bS(e=e.filter((e=>-1!==n.indexOf(e))));for(const i of e){if(i instanceof cA){const e=this.localTrackMap.get(_C.LocalAudioTrack);if(!e)continue;e.track instanceof uA?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([_C.LocalAudioTrack,e]),e.track.close())):t.push([_C.LocalAudioTrack,e])}if(i instanceof NA){const e=this.localTrackMap.get(_C.LocalVideoTrack);if(!e)continue;t.push([_C.LocalVideoTrack,e]);const n=this.localTrackMap.get(_C.LocalVideoLowTrack);n&&t.push([_C.LocalVideoLowTrack,n])}}return t}filterTobePublishedDataChannels(e){return(e=bS(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return(e=(e=bS(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:n}=e;switch(n){case _C.LocalVideoTrack:t.addListener(KI.GET_STATS,this.handleGetLocalVideoStats),t.addListener(KI.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(KI.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(KI.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case _C.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case _C.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof uA?e.trackList.forEach((e=>{e.addListener(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(KI.GET_STATS,this.handleGetLocalAudioStats),e.addListener(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(KI.GET_STATS,this.handleGetLocalAudioStats),e.addListener(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:n}]=e;return{track:n,type:t}}))),e.forEach((e=>{let{track:t,type:n}=e;switch(n){case _C.LocalVideoTrack:t.off(KI.GET_STATS,this.handleGetLocalVideoStats),t.off(KI.GET_RTC_STATS,this.handleGetRTCStats),t.off(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(KI.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(KI.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case _C.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case _C.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof uA?e.trackList.forEach((e=>{e.off(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(KI.GET_STATS,this.handleGetLocalAudioStats),e.off(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(KI.GET_STATS,this.handleGetLocalAudioStats),e.off(KI.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(KI.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(KI.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(KI.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof VA&&t.addListener(KI.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof FA&&t.addListener(KI.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(KI.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(hC.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(hC.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,n)=>{var i;let r,o,{track:s,type:a}=e;switch(a){case _C.LocalAudioTrack:r=eC.Audio,o={dtx:s instanceof dA&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case _C.LocalVideoTrack:r=Ai(i=s._hints).call(i,zI.SCREEN_TRACK)?eC.Screen:eC.High,o=eM(eM({},Ib(s)),{},{codec:this.store.codec});break;case _C.LocalVideoLowTrack:r=eC.Low,o=eM(eM({},Ib(s)),{},{codec:this.store.codec})}return{stream_type:r,attributes:o,ssrcs:t[n]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case _C.LocalVideoTrack:n=Ai(t=r._hints).call(t,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalAudioTrack:n=eC.Audio;break;case _C.LocalVideoLowTrack:n=eC.Low}return{stream_type:n,ssrcs:o,mid:s}}))}assignLocalTracks(e,t){e.forEach(((e,n)=>{let{track:i,type:r}=e;this.localTrackMap.set(r,{track:i,id:t[n].id,ssrcs:t[n].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(EC.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),Dy("NEW_ICE_RESTART")){var n;if(Ai(n=this._restartStates).call(n,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const t=t=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(zy.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(t)),"CONNECTED"===SS(this,EC.QueryClientConnectionState)&&this.emit(EC.RequestRestartICE,t))},n=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),zy.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(EC.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},i=Dy("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(Dy("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&AI().supportPCSetConfiguration)t(pC.RELAY),this._restartTimer=window.setTimeout(n,i);else if(vg())t(pC.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(t(pC.TCP),AI().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{t(pC.RELAY),this._restartTimer=window.setTimeout(n,i)}),i));this._restartTimer=window.setTimeout(n,i)}}),800))}}else{if("disconnected"===t&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{"disconnected"===e.iceConnectionState&&Dy("ICE_RESTART")&&"CONNECTED"===SS(this,EC.QueryClientConnectionState)&&this.emit(EC.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(zy.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(EC.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===t&&(zy.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(EC.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),oR.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:sS.TRACER}).onSuccess(),this.emit(EC.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var i;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=n.audioTrack)||void 0===i||i.emit(ZI.FIRST_FRAME_DECODED),oR.firstRemoteFrame(this.store.sessionId,Qy.FIRST_AUDIO_DECODE,Zy.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));n&&oR.firstRemoteFrame(this.store.sessionId,Qy.FIRST_AUDIO_RECEIVED,Zy.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,n)=>{this.reportVideoFirstFrameDecoded(e,t,n)},e.onFirstVideoReceived=e=>{var t;const n=Array.from(uh(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));n&&oR.firstRemoteFrame(this.store.sessionId,Qy.FIRST_VIDEO_RECEIVED,Zy.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const n="relay"===e.candidateType,i="relay"===t.candidateType;"unknown"!==t.candidateType&&n===i||this.emit(EC.ConnectionTypeChange,n),zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Db(t))," -> ").concat(JSON.stringify(Db(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{zy.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Db(t))," -> ").concat(JSON.stringify(Db(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const n=this.localTrackMap.get(_C.LocalAudioTrack);if(e instanceof cA&&(null==n?void 0:n.track)instanceof uA)return n.track.isActive||t.push([_C.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i&&(t.push(i),i[0]===_C.LocalVideoTrack)){const e=this.localTrackMap.get(_C.LocalVideoLowTrack);e&&t.push([_C.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(_C.LocalAudioTrack);if(e instanceof cA&&(null==n?void 0:n.track)instanceof uA)return n.track.isActive&&t.push([_C.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i)if(i[0]===_C.LocalVideoTrack){t.push(i);const e=this.localTrackMap.get(_C.LocalVideoLowTrack);e&&t.push([_C.LocalVideoLowTrack,e])}else t.push(i);return t}createMuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case _C.LocalAudioTrack:n=eC.Audio;break;case _C.LocalVideoTrack:n=Ai(t=r._hints).call(t,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalVideoLowTrack:n=eC.Low}return{stream_type:n,ssrcs:o,mid:s}}))}createUnmuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case _C.LocalAudioTrack:n=eC.Audio;break;case _C.LocalVideoTrack:n=Ai(t=r._hints).call(t,zI.SCREEN_TRACK)?eC.Screen:eC.High;break;case _C.LocalVideoLowTrack:n=eC.Low}return{stream_type:n,ssrcs:o,mid:s}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((t=>{let[i,r]=t;n.push([e,{kind:i,id:r}])}));return n}filterTobeUnSubscribedDataChannels(e,t){const n=[];return t.forEach((t=>{var i;null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.has(t.id)&&n.push(t)})),n}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[n,{kind:i,id:r}]=e;switch(i){case hC.VIDEO:return void(n._videoSSRC&&t.push({stream_type:hC.VIDEO,ssrcId:n._videoSSRC}));case hC.AUDIO:return void(n._audioSSRC&&t.push({stream_type:hC.AUDIO,ssrcId:n._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[n,{kind:i}]=e;if(t.has(n)){let e=t.get(n);i===hC.VIDEO?e|=iC.Video:e|=iC.Audio,t.set(n,e)}else i===hC.VIDEO?t.set(n,iC.Video):t.set(n,iC.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,n]=e;return{stream_id:t.uid,stream_type:n}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:n}]=e;const i=this.remoteUserMap.get(t);i&&(i.delete(n),0===Array.from(i.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(_C.LocalVideoTrack),n=this.localTrackMap.get(_C.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),n&&e.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(e,t){return e.map(((e,n)=>{var i;let{stream_type:r}=e;return null===(i=t.find((e=>{let{stream_type:t}=e;return r===t})))||void 0===i?void 0:i.attributes}))}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof cA){var t;const i=this.filterTobeUnmutedTracks(e[n]);if(0===i.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(i.map((e=>{let[,{id:t}]=e;return t}))));const r=this.createUnmuteMessage(i);return void await gS(this,EC.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(EC.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(EC.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await US(JS(this.dtlsFailedCount,qS)),this.emit(EC.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await ES(this,EC.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(EC.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(_C.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof NA))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof NA)).length>1)throw new Vg(xg.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof cA)).length>1&&(e.some((e=>e instanceof cA&&e._bypassWebAudio))||!AI().webAudioMediaStreamDest))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof NA&&this.pendingLocalTracks.some((e=>e instanceof NA)))throw new Vg(xg.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof cA&&this.pendingLocalTracks.some((e=>e instanceof cA))&&(!AI().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof cA&&e._bypassWebAudio))))throw new Vg(xg.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!Dy("DISABLE_DUAL_STREAM_USE_ENCODING")&&AI().supportDualStreamEncoding,i=eM(eM({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():Fk(e,i);const o=xS(8,"track-low-"),s=new NA(r,eM(eM({},n&&{scaleResolutionDownBy:Nb(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(XI.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,YI.LOW_STREAM)})),s._hints.push(zI.LOW_STREAM),e.addListener(KI.NEED_CLOSE,(()=>{s.close()})),s}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof UL){var r,o,s,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();oR.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:u,intSucc:t?1:2,error:i,selectedLocalCandidateProtocol:null!==(r=null==h?void 0:h.protocol)&&void 0!==r?r:"",selectedLocalCandidateType:null!==(o=h.candidateType)&&void 0!==o?o:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:null!==(s=p.protocol)&&void 0!==s?s:"",selectedRemoteCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:n})}}reportVideoFirstFrameDecoded(e,t,n,i){var r;const o=Array.from(uh(r=this.remoteUserMap).call(r)).find((t=>t._videoSSRC===e));if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,s=r.subscribe.find((e=>e.userId===o.uid&&"video"===e.type));oR.firstRemoteVideoDecode(this.store.sessionId,Qy.FIRST_VIDEO_DECODE,Zy.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:n,subscribeElapse:gP.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==s?void 0:s.subscribeEnd)||0,subscriberStart:(null==s?void 0:s.subscribeStart)||0,videoAddNotify:(null==s?void 0:s.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const o=await this.connection.getRemoteSSRC(r);return void 0!==o&&o!==n}resetConnection(e){zy.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===mC.Connected?(zy.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===rC.datachannel?new QL({},this.store):this.isPlanB?new AL({},this.store):new UL({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===_C.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,YI.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof UL&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===fC.TCP_RESTART&&e===pC.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,fC.DISCONNECTED_OR_FAILED)))}}function rM(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PChannel.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function oM(e){let t=mM();return function(e,t){let n=e.appId;void 0!==n&&(NM(t,10),RM(t,n));let i=e.cid;void 0!==i&&(NM(t,16),NM(t,i));let r=e.cname;void 0!==r&&(NM(t,26),RM(t,r));let o=e.deviceId;void 0!==o&&(NM(t,34),RM(t,o));let s=e.elapse;void 0!==s&&(NM(t,40),DM(t,s));let a=e.fileSize;void 0!==a&&(NM(t,48),DM(t,fM(a)));let c=e.height;void 0!==c&&(NM(t,56),DM(t,fM(c)));let d=e.jpg;void 0!==d&&(NM(t,66),NM(t,d.length),function(e,t){let n=TM(e,t.length);e.bytes.set(t,n)}(t,d));let l=e.networkType;void 0!==l&&(NM(t,72),DM(t,fM(l)));let u=e.osType;void 0!==u&&(NM(t,80),DM(t,fM(u)));let h=e.requestId;void 0!==h&&(NM(t,90),RM(t,h));let p=e.sdkVersion;void 0!==p&&(NM(t,98),RM(t,p));let f=e.sequence;void 0!==f&&(NM(t,104),DM(t,fM(f)));let _=e.sid;void 0!==_&&(NM(t,114),RM(t,_));let m=e.timestamp;void 0!==m&&(NM(t,120),DM(t,m));let E=e.uid;void 0!==E&&(NM(t,128),NM(t,E));let g=e.vid;void 0!==g&&(NM(t,136),NM(t,g));let S=e.width;void 0!==S&&(NM(t,144),DM(t,fM(S)));let T=e.service;void 0!==T&&(NM(t,152),NM(t,T));let v=e.callbackData;void 0!==v&&(NM(t,162),RM(t,v));let y=e.jpgEncryption;void 0!==y&&(NM(t,168),NM(t,y));let R=e.requestType;void 0!==R&&(NM(t,176),NM(t,R));let C=e.scorePorn;void 0!==C&&(NM(t,185),AM(t,C));let b=e.scoreSexy;void 0!==b&&(NM(t,193),AM(t,b));let I=e.scoreNeutral;void 0!==I&&(NM(t,201),AM(t,I));let w=e.scene;void 0!==w&&(NM(t,208),NM(t,w));let A=e.ossFilePrefix;void 0!==A&&(NM(t,218),RM(t,A));let O=e.serviceVendor;if(void 0!==O)for(let N of O){NM(t,226);let e=mM();cM(N,e),NM(t,e.limit),CM(t,e),EM(e)}}(e,t),function(e){let t=e.bytes,n=e.limit;return t.length===n?t:t.subarray(0,n)}(t)}function sM(e){return function(e){let t={};e:for(;!SM(e);){let n=OM(e);switch(n>>>3){case 0:break e;case 1:t.code=OM(e);break;case 2:t.msg=yM(e,OM(e));break;case 3:{let n=dM(e);t.data=aM(e),e.limit=n;break}default:lM(e,7&n)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function aM(e){let t={};e:for(;!SM(e);){let n=OM(e);switch(n>>>3){case 0:break e;case 1:t.requestId=yM(e,OM(e));break;case 2:t.requestType=OM(e)>>>0;break;case 3:t.scorePorn=wM(e);break;case 4:t.scoreSexy=wM(e);break;case 5:t.scoreNeutral=wM(e);break;case 6:t.requestScene=OM(e)>>>0;break;case 7:t.scene=OM(e)>>>0;break;default:lM(e,7&n)}}return t}function cM(e,t){let n=e.service;void 0!==n&&(NM(t,8),NM(t,n));let i=e.vendor;void 0!==i&&(NM(t,16),NM(t,i));let r=e.token;void 0!==r&&(NM(t,26),RM(t,r));let o=e.callbackUrl;void 0!==o&&(NM(t,34),RM(t,o))}function dM(e){let t=OM(e),n=e.limit;return e.limit=e.offset+t,n}function lM(e,t){switch(t){case 0:for(;128&bM(e););break;case 2:gM(e,OM(e));break;case 5:gM(e,4);break;case 1:gM(e,8);break;default:throw new Error("Unimplemented type: "+t)}}UR([rM,xR("design:type",Function),xR("design:paramtypes",[Object,Boolean]),xR("design:returntype",tg)],iM.prototype,"startP2PConnection",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Object,Object,Array,Object,String,String]),xR("design:returntype",tg)],iM.prototype,"connect",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",void 0)],iM.prototype,"updateRemoteRTPCapabilities",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Object,Object,Array,Object,String,String]),xR("design:returntype",tg)],iM.prototype,"preConnect",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],iM.prototype,"publishDataChannel",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],iM.prototype,"unpublish",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],iM.prototype,"unpublishDataChannel",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],iM.prototype,"unpublishLowStream",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,Array]),xR("design:returntype",tg)],iM.prototype,"subscribeDataChannel",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,String,Number,Number,Array]),xR("design:returntype",tg)],iM.prototype,"subscribe",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],iM.prototype,"massSubscribe",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,String,Boolean]),xR("design:returntype",tg)],iM.prototype,"unsubscribe",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,Array]),xR("design:returntype",tg)],iM.prototype,"unsubscribeDataChannel",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],iM.prototype,"massUnsubscribe",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,String]),xR("design:returntype",tg)],iM.prototype,"muteRemote",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,String]),xR("design:returntype",tg)],iM.prototype,"unmuteRemote",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,String]),xR("design:returntype",tg)],iM.prototype,"hasRemoteMediaWithLock",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],iM.prototype,"disconnectForReconnect",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],iM.prototype,"updateBitrateLimit",null),UR([rM,xR("design:type",Function),xR("design:paramtypes",[nL,String,Number]),xR("design:returntype",tg)],iM.prototype,"remoteMediaSsrcChanged",null);let uM=new Float32Array(1);new Uint8Array(uM.buffer);let hM=new Float64Array(1),pM=new Uint8Array(hM.buffer);function fM(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let _M=[];function mM(){const e=_M.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function EM(e){_M.push(e)}function gM(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function SM(e){return e.offset>=e.limit}function TM(e,t){let n=e.bytes,i=e.offset,r=e.limit,o=i+t;if(o>n.length){let t=new Uint8Array(2*o);t.set(n),e.bytes=t}return e.offset=o,o>r&&(e.limit=o),i}function vM(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function yM(e,t){let n=vM(e,t),i=String.fromCharCode,r=e.bytes,o="\ufffd",s="";for(let a=0;a<t;a++){let e,c,d,l,u=r[a+n];0==(128&u)?s+=i(u):192==(224&u)?a+1>=t?s+=o:(e=r[a+n+1],128!=(192&e)?s+=o:(l=(31&u)<<6|63&e,l<128?s+=o:(s+=i(l),a++))):224==(240&u)?a+2>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],32896!=(49344&(e|c<<8))?s+=o:(l=(15&u)<<12|(63&e)<<6|63&c,l<2048||l>=55296&&l<=57343?s+=o:(s+=i(l),a+=2))):240==(248&u)?a+3>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],d=r[a+n+3],8421504!=(12632256&(e|c<<8|d<<16))?s+=o:(l=(7&u)<<18|(63&e)<<12|(63&c)<<6|63&d,l<65536||l>1114111?s+=o:(l-=65536,s+=i(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o}return s}function RM(e,t){let n=t.length,i=0;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),i+=e<128?1:e<2048?2:e<65536?3:4}NM(e,i);let r=TM(e,i),o=e.bytes;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),e<128?o[r++]=e:(e<2048?o[r++]=e>>6&31|192:(e<65536?o[r++]=e>>12&15|224:(o[r++]=e>>18&7|240,o[r++]=e>>12&63|128),o[r++]=e>>6&63|128),o[r++]=63&e|128)}}function CM(e,t){let n=TM(e,t.limit),i=e.bytes,r=t.bytes;for(let o=0,s=t.limit;o<s;o++)i[o+n]=r[o]}function bM(e){return e.bytes[vM(e,1)]}function IM(e,t){let n=TM(e,1);e.bytes[n]=t}function wM(e){let t=vM(e,8),n=e.bytes;return pM[0]=n[t++],pM[1]=n[t++],pM[2]=n[t++],pM[3]=n[t++],pM[4]=n[t++],pM[5]=n[t++],pM[6]=n[t++],pM[7]=n[t++],hM[0]}function AM(e,t){let n=TM(e,8),i=e.bytes;hM[0]=t,i[n++]=pM[0],i[n++]=pM[1],i[n++]=pM[2],i[n++]=pM[3],i[n++]=pM[4],i[n++]=pM[5],i[n++]=pM[6],i[n++]=pM[7]}function OM(e){let t,n=0,i=0;do{t=bM(e),n<32&&(i|=(127&t)<<n),n+=7}while(128&t);return i}function NM(e,t){for(t>>>=0;t>=128;)IM(e,127&t|128),t>>>=7;IM(e,t)}function DM(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,o=0===r?0===i?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=TM(e,o),a=e.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=9!==o?128|r:127&r;case 8:a[s+7]=8!==o?i>>>21|128:i>>>21&127;case 7:a[s+6]=7!==o?i>>>14|128:i>>>14&127;case 6:a[s+5]=6!==o?i>>>7|128:i>>>7&127;case 5:a[s+4]=5!==o?128|i:127&i;case 4:a[s+3]=4!==o?n>>>21|128:n>>>21&127;case 3:a[s+2]=3!==o?n>>>14|128:n>>>14&127;case 2:a[s+1]=2!==o?n>>>7|128:n>>>7&127;case 1:a[s]=1!==o?128|n:127&n}}function PM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const kM=new Map([["moderation",1],["supervise",2]]);class LM extends nS{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(vC.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=cT(t=e.map((e=>kM.get(e)||0))).call(t,((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),ih(this,"name","AgoraRTCVideoContentInspect"),ih(this,"_connectionState",SC.CONNECTING),ih(this,"_innerConnectionState",void 0),ih(this,"sequence",0),ih(this,"inspectStartTime",void 0),ih(this,"workerManagerConnection",void 0),ih(this,"workerConnection",void 0),ih(this,"workerMessageLengthLimit",void 0),ih(this,"inspectIntervalMinimum",void 0),ih(this,"qualityRatio",void 0),ih(this,"_connectInfo",void 0),ih(this,"_cancelTokenSource",_y.CancelToken.source()),ih(this,"_retryConfig",void 0),ih(this,"wmSequence",0),ih(this,"inspectInterval",void 0),ih(this,"inspectTimer",null),ih(this,"ossFilePrefix",void 0),ih(this,"extraInfo",void 0),ih(this,"_inspectType",void 0),ih(this,"_inspectMode",void 0),ih(this,"_quality",1),ih(this,"qualityTimer",null),ih(this,"_inspectId",void 0),ih(this,"_needWorkUrlOnly",!1),ih(this,"inspectImage",(()=>{if(this.connectionState!==SC.CONNECTED)throw new VR(xg.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===SC.CONNECTED?this.requestToInspectImage():zy.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=xS(5,"inspect-"),this.workerMessageLengthLimit=Dy("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=Dy("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=Dy("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new $C("worker-manager-"+this._inspectId,qS),this.on(vC.STATE_CHANGE,((e,t)=>{this._innerConnectionState=e,zy.debug("[".concat(this._inspectId,"] Inspect operation :").concat(TC[e]," ").concat(t||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new $C("worker-"+this._inspectId,qS),this.handleWorkerEvents()}async init(e,t){this.emit(vC.STATE_CHANGE,TC.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=t,new tg(((i,r)=>{this.on(vC.CONNECTION_STATE_CHANGE,((e,t)=>{t===SC.CONNECTED&&i()})),this.requestAP(e,n,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{r(e)}))}))}async requestAP(e,t,n){const i=Dy("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,t,n,i){let{appId:r,areaCode:o,cname:s,sid:a,token:c,uid:d}=t;pI++;const l="image_moderation_api",u={service_name:l,json_body:JSON.stringify({appId:r,areaCode:o,cname:s,command:"allocateEdge",requestId:pI,seq:pI,sid:a,token:c,ts:Date.now(),uid:d+""})};let h,p,f=e[0];return XS((async()=>{h=Date.now();const e=await Kb(f,{data:u,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-h,0!==e.code){const t=new VR(xg.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:p});throw zy.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new VR(xg.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw zy.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new VR(xg.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:t.code,responseTime:p});throw zy.error(e.toString()),e}const i=Dy("VIDEO_INSPECT_WORKER_MANAGER_HOST"),r=Dy("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:t.servers.map((e=>{let{address:t,wss:n}=e;if(t&&n)return"wss://".concat(t.replace(/\./g,"-"),".").concat(i,":").concat(r||n)})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,responseTime:p}}),((t,n)=>(oR.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:p,serverIp:e[n%e.length]}),!1)),((t,n)=>(oR.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:l,responseTime:p,serverIp:e[n%e.length]}),!!(t.code!==xg.OPERATION_ABORTED&&t.code!==xg.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),i)}(i,e,t,n);this.emit(vC.STATE_CHANGE,TC.AP_CONNECTED);const{addressList:o}=r;return this.wmSequence++,o}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(vC.STATE_CHANGE,TC.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(bR.CONNECTED,(async()=>{this.emit(vC.STATE_CHANGE,TC.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(bR.CLOSED,(()=>{this._innerConnectionState<TC.GET_WORKER_MANAGER_RESPONSE&&zy.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(bR.FAILED,(()=>{this._innerConnectionState<TC.GET_WORKER_MANAGER_RESPONSE&&zy.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(bR.RECONNECTING,(()=>{this._innerConnectionState<TC.GET_WORKER_MANAGER_RESPONSE&&zy.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(bR.ON_MESSAGE,(async e=>{this.emit(vC.STATE_CHANGE,TC.GET_WORKER_MANAGER_RESPONSE);const t=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(200!==n.code)throw zy.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new VR(xg.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&t))throw zy.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new VR(xg.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const e=Dy("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,i=t.replace(/:\d+\/?$/,":".concat(e));this.emit(vC.STATE_CHANGE,TC.CONNECT_WORKER,i),this._needWorkUrlOnly?this.emit(vC.REQUEST_NEW_WORKER_URL,i):await this.connectWorker(i)}})),this.workerManagerConnection.on(bR.WILL_RECONNECT,((e,t,n)=>{n(e)})),this.workerManagerConnection.on(bR.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(bR.CONNECTED,(async()=>{this.emit(vC.STATE_CHANGE,TC.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=SC.CONNECTED})),this.workerConnection.on(bR.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=sM(new Uint8Array(e.data));if(Dy("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&zy.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),200===n.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(vC.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var t;const e={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},i=cT(t=Object.keys(e)).call(t,((t,n)=>e[t]>e[n]?t:n),"porn"),r=Object.keys(e).find((e=>e===i));this.emit(vC.INSPECT_RESULT,r)}else this.emit(vC.INSPECT_RESULT,void 0,new VR(xg.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(vC.INSPECT_RESULT,void 0,new VR(xg.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else zy.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(vC.INSPECT_RESULT,void 0,new VR(xg.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(bR.CLOSED,(()=>{this.connectionState=SC.CLOSED})),this.workerConnection.on(bR.FAILED,(()=>{this.connectionState=SC.CLOSED})),this.workerConnection.on(bR.RECONNECTING,(()=>{this.connectionState=this.connectionState===SC.CONNECTED?SC.RECONNECTING:SC.CONNECTING})),this.workerConnection.on(bR.WILL_RECONNECT,((e,t,n)=>{"recover"===e&&n(e),n("tryNext")})),this.workerConnection.on(bR.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(vC.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=SS(this,vC.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(vC.INSPECT_RESULT,void 0,new VR(xg.INVALID_OPERATION,"Only the track being played can be inspected"));const n=await this.generateRequestData(e,t);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(vC.INSPECT_RESULT,void 0,new VR(xg.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,t){let{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a}=t;const c=Date.now(),d=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await wA(d,n,i),u=this.sequence+"-"+r+"-"+a+"-"+c+"-"+xS(12,""),h={appId:n,cid:r,cname:i,deviceId:"",elapse:LM.intToLong(Number(c-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:u,sdkVersion:"4.20.0",sequence:this.sequence,sid:s,timestamp:LM.intToLong(c),uid:a,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete h.callbackData,void 0===this.ossFilePrefix&&delete h.ossFilePrefix;const p=oM(h);if(p.byteLength<this.workerMessageLengthLimit){if(Dy("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?PM(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):PM(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},h);delete e.jpg,zy.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return p}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=_y.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=SC.CLOSED,this.emit(vC.STATE_CHANGE,TC.CLOSED)}}function MM(e){let t=function(){const e=FM.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let n=e.appId;void 0!==n&&(XM(t,10),zM(t,n));let i=e.cid;void 0!==i&&(XM(t,16),XM(t,i));let r=e.cname;void 0!==r&&(XM(t,26),zM(t,r));let o=e.deviceId;void 0!==o&&(XM(t,34),zM(t,o));let s=e.elapse;void 0!==s&&(XM(t,40),ZM(t,s));let a=e.fileSize;void 0!==a&&(XM(t,48),ZM(t,VM(a)));let c=e.height;void 0!==c&&(XM(t,56),ZM(t,VM(c)));let d=e.jpg;void 0!==d&&(XM(t,66),XM(t,d.length),HM(t,d));let l=e.networkType;void 0!==l&&(XM(t,72),ZM(t,VM(l)));let u=e.osType;void 0!==u&&(XM(t,80),ZM(t,VM(u)));let h=e.requestId;void 0!==h&&(XM(t,90),zM(t,h));let p=e.sdkVersion;void 0!==p&&(XM(t,98),zM(t,p));let f=e.sequence;void 0!==f&&(XM(t,104),ZM(t,VM(f)));let _=e.sid;void 0!==_&&(XM(t,114),zM(t,_));let m=e.timestamp;void 0!==m&&(XM(t,120),ZM(t,m));let E=e.uid;void 0!==E&&(XM(t,128),XM(t,E));let g=e.vid;void 0!==g&&(XM(t,136),XM(t,g));let S=e.width;void 0!==S&&(XM(t,144),ZM(t,VM(S)));let T=e.service;void 0!==T&&(XM(t,152),XM(t,T));let v=e.callbackData;void 0!==v&&(XM(t,162),XM(t,v.length),HM(t,v));let y=e.ticket;void 0!==y&&(XM(t,170),zM(t,y));let R=e.vendorConfigs;void 0!==R&&(XM(t,178),zM(t,R))}(e,t),function(e){let t=e.bytes,n=e.limit;return t.length===n?t:t.subarray(0,n)}(t)}function UM(e){return function(e){let t={};e:for(;!BM(e);){let n=JM(e);switch(n>>>3){case 0:break e;case 1:t.code=JM(e);break;case 2:t.msg=KM(e,JM(e));break;case 3:t.requestId=KM(e,JM(e));break;case 4:t.timestamp=QM(e,!1);break;default:xM(e,7&n)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function xM(e,t){switch(t){case 0:for(;128&YM(e););break;case 2:jM(e,JM(e));break;case 5:jM(e,4);break;case 1:jM(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function VM(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let FM=[];function jM(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function BM(e){return e.offset>=e.limit}function GM(e,t){let n=e.bytes,i=e.offset,r=e.limit,o=i+t;if(o>n.length){let t=new Uint8Array(2*o);t.set(n),e.bytes=t}return e.offset=o,o>r&&(e.limit=o),i}function WM(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function HM(e,t){let n=GM(e,t.length);e.bytes.set(t,n)}function KM(e,t){let n=WM(e,t),i=String.fromCharCode,r=e.bytes,o="\ufffd",s="";for(let a=0;a<t;a++){let e,c,d,l,u=r[a+n];0==(128&u)?s+=i(u):192==(224&u)?a+1>=t?s+=o:(e=r[a+n+1],128!=(192&e)?s+=o:(l=(31&u)<<6|63&e,l<128?s+=o:(s+=i(l),a++))):224==(240&u)?a+2>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],32896!=(49344&(e|c<<8))?s+=o:(l=(15&u)<<12|(63&e)<<6|63&c,l<2048||l>=55296&&l<=57343?s+=o:(s+=i(l),a+=2))):240==(248&u)?a+3>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],d=r[a+n+3],8421504!=(12632256&(e|c<<8|d<<16))?s+=o:(l=(7&u)<<18|(63&e)<<12|(63&c)<<6|63&d,l<65536||l>1114111?s+=o:(l-=65536,s+=i(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o}return s}function zM(e,t){let n=t.length,i=0;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),i+=e<128?1:e<2048?2:e<65536?3:4}XM(e,i);let r=GM(e,i),o=e.bytes;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),e<128?o[r++]=e:(e<2048?o[r++]=e>>6&31|192:(e<65536?o[r++]=e>>12&15|224:(o[r++]=e>>18&7|240,o[r++]=e>>12&63|128),o[r++]=e>>6&63|128),o[r++]=63&e|128)}}function YM(e){return e.bytes[WM(e,1)]}function qM(e,t){let n=GM(e,1);e.bytes[n]=t}function JM(e){let t,n=0,i=0;do{t=YM(e),n<32&&(i|=(127&t)<<n),n+=7}while(128&t);return i}function XM(e,t){for(t>>>=0;t>=128;)qM(e,127&t|128),t>>>=7;qM(e,t)}function QM(e,t){let n,i=0,r=0,o=0;return n=YM(e),i=127&n,128&n&&(n=YM(e),i|=(127&n)<<7,128&n&&(n=YM(e),i|=(127&n)<<14,128&n&&(n=YM(e),i|=(127&n)<<21,128&n&&(n=YM(e),r=127&n,128&n&&(n=YM(e),r|=(127&n)<<7,128&n&&(n=YM(e),r|=(127&n)<<14,128&n&&(n=YM(e),r|=(127&n)<<21,128&n&&(n=YM(e),o=127&n,128&n&&(n=YM(e),o|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:t}}function ZM(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,o=0===r?0===i?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=GM(e,o),a=e.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=9!==o?128|r:127&r;case 8:a[s+7]=8!==o?i>>>21|128:i>>>21&127;case 7:a[s+6]=7!==o?i>>>14|128:i>>>14&127;case 6:a[s+5]=6!==o?i>>>7|128:i>>>7&127;case 5:a[s+4]=5!==o?128|i:127&i;case 4:a[s+3]=4!==o?n>>>21|128:n>>>21&127;case 3:a[s+2]=3!==o?n>>>14|128:n>>>14&127;case 2:a[s+1]=2!==o?n>>>7|128:n>>>7&127;case 1:a[s]=1!==o?128|n:127&n}}const $M={},eU={},tU=4294967296,nU=tU*tU,iU=nU/2,rU=dU(0,!0),oU=dU(0),sU=lU(0,-2147483648,!1),aU=lU(-1,2147483647,!1),cU=lU(-1,-1,!0);function dU(e,t){let n,i,r;return t?(r=0<=(e>>>=0)&&e<256)&&(i=eU[e],i)?i:(n=lU(e,0,!0),r&&(eU[e]=n),n):(r=-128<=(e|=0)&&e<128)&&(i=$M[e],i)?i:(n=lU(e,e<0?-1:0,!1),r&&($M[e]=n),n)}function lU(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function uU(e,t){if(isNaN(e))return t?rU:oU;if(t){if(e<0)return rU;if(e>=nU)return cU}else{if(e<=-iU)return sU;if(e+1>=iU)return aU}return e<0?t?rU:oU:lU(e%tU|0,e/tU|0,t)}function hU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class pU extends nS{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(wC.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var t;super(),ih(this,"name","AgoraRTCImageModeration"),ih(this,"_connectionState",IC.CONNECTING),ih(this,"_sequence",0),ih(this,"_moderationStartTime",void 0),ih(this,"_workerConnection",void 0),ih(this,"_workerMessageLengthLimit",void 0),ih(this,"_qualityRatio",void 0),ih(this,"_connectInfo",void 0),ih(this,"_cancelTokenSource",_y.CancelToken.source()),ih(this,"_retryConfig",void 0),ih(this,"_moderationInterval",void 0),ih(this,"_moderationTimer",null),ih(this,"_moderationMode",1),ih(this,"_quality",1),ih(this,"_qualityTimer",null),ih(this,"_ticket",void 0),ih(this,"_moderationIntervalMinimum",void 0),ih(this,"_uploadFailedNum",0),ih(this,"_uploadNum",0),ih(this,"_uploadTimer",null),ih(this,"_extraInfo",void 0),ih(this,"_vendor",""),ih(this,"_encoder",new TextEncoder),ih(this,"_moderationId",void 0),ih(this,"inspectImage",(()=>{if(this.connectionState!==IC.CONNECTED)throw new VR(xg.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===IC.CONNECTED?this.requestToInspectImage():zy.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=xS(5,"image-moderation-"),this._workerMessageLengthLimit=Dy("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=Dy("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=Dy("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new $C("worker-"+this._moderationId,qS),this.on(wC.STATE_CHANGE,((e,t)=>{zy.debug("[".concat(this._moderationId,"] Moderation operation :").concat(AC[e]," ").concat(t||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(wC.STATE_CHANGE,AC.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=t,new tg(((i,r)=>{this.on(wC.CONNECTION_STATE_CHANGE,((e,t)=>{e===IC.CONNECTED&&i()})),this.requestAP(e,n,t).then((e=>{this.connectWorker(e)})).catch((e=>{r(e)}))}))}updateConfig(e){var t;this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),zy.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===IC.CONNECTED&&this.inspectImage()}async requestAP(e,t,n){const i=Dy("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,t,n,i){let{appId:r,areaCode:o,cname:s,sid:a,token:c,uid:d}=t;pI++;const l="moderation_plugin",u={service_name:l,json_body:JSON.stringify({appId:r,areaCode:o,cname:s,command:"allocateEdge",requestId:pI,seq:pI,sid:a,appToken:c,ts:Date.now(),uid:d+""})};let h,p,f=e[0];return XS((async()=>{h=Date.now();const e=await Kb(f,{data:u,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-h,0!==e.code){const t=new VR(xg.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:p});throw zy.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new VR(xg.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw zy.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new VR(xg.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:t.code,responseTime:p});throw zy.error(e.toString()),e}if(!t.servers.some((e=>!!e.wss))){const e=new VR(xg.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:t.code,responseTime:p});throw zy.error(e.toString()),e}const i=Dy("IMAGE_MODERATION_WORKER_HOST");return{addressList:t.servers.map((e=>{let{address:t,wss:n}=e;if(t&&n)return"wss://".concat(t.replace(/\./g,"-"),".").concat(i,":").concat(n,"/moderation")})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,ticket:t.appTicket,responseTime:p}}),((t,n)=>(oR.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:p,serverIp:e[n%e.length]}),!1)),((t,n)=>(oR.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:l,responseTime:p,serverIp:e[n%e.length]}),!!(t.code!==xg.OPERATION_ABORTED&&t.code!==xg.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),i)}(i,e,t,n);this.emit(wC.STATE_CHANGE,AC.AP_CONNECTED);const{addressList:o,ticket:s}=r;return this._ticket=s,o}async connectWorker(e){this.emit(wC.STATE_CHANGE,AC.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(bR.CONNECTED,(async()=>{this.emit(wC.STATE_CHANGE,AC.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=IC.CONNECTED})),this._workerConnection.on(bR.CLOSED,(()=>{this.connectionState=IC.CLOSED})),this._workerConnection.on(bR.FAILED,(()=>{this.connectionState=IC.CLOSED})),this._workerConnection.on(bR.RECONNECTING,(()=>{this.connectionState=this.connectionState===IC.CONNECTED?IC.RECONNECTING:IC.CONNECTING})),this._workerConnection.on(bR.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const t=UM(new Uint8Array(e.data));Dy("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&zy.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(t)),this._uploadNum++,void 0===t.code||0===t.code||(this._uploadFailedNum++,zy.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(t.code,", msg is ").concat(t.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{oR.reportApiInvoke(this._connectInfo.sid||null,{name:oS.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,t.code],tag:sS.TRACER}).onError(new VR(xg.IMAGE_MODERATION_UPLOAD_FAILED,t.msg)),this._uploadTimer=null}),Dy("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else zy.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(bR.WILL_RECONNECT,((e,t,n)=>{"recover"===e&&n(e),n("tryNext")})),this._workerConnection.on(bR.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=SS(this,wC.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(Dy("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&zy.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,t);this._workerConnection.sendMessage(n,!0,!0)}else Dy("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&zy.debug("Only the track being published can be inspected")}async generateRequestData(e,t){let{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a}=t;const c=Date.now(),d=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await wA(d,n,i),u=this._sequence+"-"+r+"-"+a+"-"+c+"-"+xS(12,""),h={appId:n,cid:r,cname:i,deviceId:"",elapse:pU.intToLong(Number(c-this._moderationStartTime)),fileSize:d.buffer.byteLength,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:u,sdkVersion:"4.20.0",sequence:this._sequence,sid:s,timestamp:uU(c),uid:a,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete h.callbackData;const p=MM(h);if(p.byteLength<this._workerMessageLengthLimit){if(Dy("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?hU(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hU(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},h);delete e.jpg,zy.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return p}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=_y.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=IC.CLOSED,this.emit(wC.STATE_CHANGE,AC.CLOSED)}}function fU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function _U(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fU(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fU(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const mU=Date.now(),EU=20,gU=new Map,SU=new Map;async function TU(e){const t=gU.get(e),n=Array.isArray(t)&&t[t.length-1],i=SU.get(e);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:DS(n.payload)};0===i.firstRecvTs&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const o=n.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(t.pop(),vU(n.context,r),a=0):a=Math.min(a,EU),setTimeout((()=>t.length&&TU(e)),a)}function vU(e,t){e.safeEmit(dS.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function yU(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return vU(n,{uid:e.uid,payload:DS(e.payload)});const i="".concat(n.id,"-").concat(e.uid),r=gU.get(i)||[],o=r.findIndex((t=>e.sendTs>=t.sendTs)),s=_U(_U({},e),{},{context:n,mediaDelay:t,recvTs:Date.now()});-1===o?r.push(s):r.splice(o,0,s),gU.set(i,r);let a=!1;var c;SU.has(i)?a=!(null===(c=SU.get(i))||void 0===c||!c.isSyncing):SU.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||TU(i)}const RU=pg().name;function CU(){return!function(e,t,n){const i=pg();if(i.os!==ag.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}(16,0,!0)&&!function(e,t,n){const i=pg();if(i.name!==cg.SAFARI||!i.osVersion)return!1;const r=i.version.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}(16,0,!0)}function bU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function IU(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?bU(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):bU(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}zS.setLogger(zy);class wU extends nS{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),ih(this,"store",void 0),ih(this,"_uid",void 0),ih(this,"_channelName",void 0),ih(this,"_uintUid",void 0),ih(this,"_users",[]),ih(this,"_config",void 0),ih(this,"_clientId",void 0),ih(this,"_appId",void 0),ih(this,"_sessionId",null),ih(this,"_key",void 0),ih(this,"_rtmConfig",{}),ih(this,"_joinInfo",void 0),ih(this,"_gateway",void 0),ih(this,"_statsCollector",void 0),ih(this,"_configDistribute",void 0),ih(this,"_leaveMutex",new zS("client-leave")),ih(this,"_publishMutex",new zS("client-publish")),ih(this,"_renewTokenMutex",new zS("client-renewtoken")),ih(this,"_subscribeMutex",new zS("client-subscribe")),ih(this,"_encryptionMode","none"),ih(this,"_encryptionSecret",null),ih(this,"_encryptionSalt",null),ih(this,"_proxyServer",void 0),ih(this,"_turnServer",{servers:[],mode:"auto"}),ih(this,"_cloudProxyServerMode","disabled"),ih(this,"_isDualStreamEnabled",!1),ih(this,"_defaultStreamFallbackType",void 0),ih(this,"_lowStreamParameter",void 0),ih(this,"_streamFallbackTypeCacheMap",new Map),ih(this,"_remoteStreamTypeCacheMap",new Map),ih(this,"_axiosCancelSource",_y.CancelToken.source()),ih(this,"_audioVolumeIndicationInterval",void 0),ih(this,"_networkQualityInterval",void 0),ih(this,"_userOfflineTimeout",void 0),ih(this,"_streamRemovedTimeout",void 0),ih(this,"_injectStreamingClient",void 0),ih(this,"_liveTranscodeStreamingClient",void 0),ih(this,"_liveRawStreamingClient",void 0),ih(this,"_channelMediaRelayClient",void 0),ih(this,"_networkQualitySensitivity","normal"),ih(this,"_p2pChannel",void 0),ih(this,"_useLocalAccessPoint",!1),ih(this,"_setLocalAPVersion",void 0),ih(this,"_joinAndNotLeaveYet",!1),ih(this,"_numberOfJoinCount",0),ih(this,"_remoteDefaultVideoStreamType",void 0),ih(this,"_inspect",void 0),ih(this,"_moderation",void 0),ih(this,"_license",void 0),ih(this,"_pendingPublishedUsers",[]),ih(this,"ntpAlignErrorCount",0),ih(this,"remoteInboundOffset",0),ih(this,"_handleLocalTrackEnable",((e,t,n)=>{this.publish(e,!1).then(t).catch(n)})),ih(this,"_handleLocalTrackDisable",((e,t,n)=>{this.unpublish(e).then(t).catch(n)})),ih(this,"_handleUserOnline",(e=>{if(Dy("BLOCK_LOCAL_CLIENT")&&lR(e.uid,this.channelName))return void zy.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&zy.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const t=this._users.find((t=>t.uid===e.uid));if(t)t._trust_in_room_=!0,t._is_pre_created&&(t._is_pre_created=!1,this.safeEmit(dS.USER_JOINED,t));else{const t=new nL(e.uid,e.uint_id||e.uid);this._users.push(t),zy.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(dS.USER_JOINED,t)}})),ih(this,"_handleUserOffline",(e=>{if(Dy("BLOCK_LOCAL_CLIENT")&&lR(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));t&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),t._audio_pre_subscribed||t._video_pre_subscribed?t._is_pre_created=!0:CS(this._users,t),this._remoteStreamTypeCacheMap.delete(t.uid),this._streamFallbackTypeCacheMap.delete(t.uid),zy.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(dS.USER_LEAVED,t,e.reason))})),ih(this,"_handleAddAudioOrVideoStream",((e,t,n,i,r,o,s)=>{if(Dy("BLOCK_LOCAL_CLIENT")&&lR(t,this.channelName))return;const a=this._users.find((e=>e.uid===t));if(!a)return void zy.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));zy.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(a.uid,e,void 0,void 0,void 0,Date.now());const c="audio"===e?a.hasAudio:a.hasVideo;a._uintid||(a._uintid=r||t),"audio"===e?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,"audio"===e?(a._audio_added_=!0,void 0!==n&&(a._audioSSRC=n),void 0!==i&&(a._cname=i),o&&(a._audioOrtc=o)):(a._video_added_=!0,void 0!==n&&(a._videoSSRC=n),void 0!==i&&(a._cname=i),void 0!==s&&(a._rtxSsrcId=s),o&&(a._videoOrtc=o)),("audio"===e?a.hasAudio:a.hasVideo)&&!c&&(zy.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(e)),this.safeEmit(dS.USER_PUBLISHED,a,e)),"video"===e?oR.onGatewayStream(this._sessionId,Qy.ON_ADD_VIDEO_STREAM,Zy.ON_ADD_VIDEO_STREAM,{peer:r||t,ssrc:a._videoSSRC}):oR.onGatewayStream(this._sessionId,Qy.ON_ADD_AUDIO_STREAM,Zy.ON_ADD_AUDIO_STREAM,{peer:r||t,ssrc:a._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(a,e,n).then((t=>{if(t&&(zy.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof iM))return this._p2pChannel.unsubscribe(a,e,!0).then((()=>this._subscribe(a,e,!0).catch((e=>{zy.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(a,e)&&(zy.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,e,!0).catch((e=>{zy.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))})),ih(this,"_handleRemoveStream",(e=>{if(Dy("BLOCK_LOCAL_CLIENT")&&lR(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));if(!t)return void zy.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));zy.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let n=()=>{};t.hasAudio&&t.hasVideo?n=()=>{zy.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.safeEmit(dS.USER_UNPUBLISHED,t,"audio"),zy.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.safeEmit(dS.USER_UNPUBLISHED,t,"video")}:t.hasVideo?n=()=>{zy.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.safeEmit(dS.USER_UNPUBLISHED,t,"video")}:t.hasAudio&&(n=()=>{zy.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.safeEmit(dS.USER_UNPUBLISHED,t,"audio")}),t._video_pre_subscribed||t._audio_pre_subscribed||(t._trust_audio_stream_added_state_=!0,t._trust_video_stream_added_state_=!0,t._audio_added_=!1,t._video_added_=!1,this._p2pChannel instanceof iM&&this._p2pChannel.unsubscribe(t).then((e=>{if(e)return this._gateway.unsubscribe(e,t.uid)})),t._audioSSRC=void 0,t._videoSSRC=void 0,t._audioOrtc=void 0,t._videoOrtc=void 0,t._rtxSsrcId=void 0),oR.onGatewayStream(this._sessionId,Qy.ON_REMOVE_STREAM,Zy.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),n()})),ih(this,"_handleSetStreamLocalEnable",((e,t,n)=>{if(Dy("BLOCK_LOCAL_CLIENT")&&lR(t,this.channelName))return;const i=this._users.find((e=>e.uid===t));if(!i)return void zy.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));zy.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(n?"enabled":"disabled"," with uid ").concat(t));const r="audio"===e?i.hasAudio:i.hasVideo;if("audio"===e){i._trust_audio_enabled_state_=!0;const e=i._audio_enabled_;if(i._audio_enabled_=n,i._audio_enabled_===e)return;{const e=i._audio_enabled_?"enable-local-audio":"disable-local-audio";zy.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(dS.USER_INFO_UPDATED,t,e)}}else{i._trust_video_enabled_state_=!0;const e=i._video_enabled_;if(i._video_enabled_=n,i._video_enabled_===e)return;{const e=i._video_enabled_?"enable-local-video":"disable-local-video";zy.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(dS.USER_INFO_UPDATED,t,e)}}const o="audio"===e?i.hasAudio:i.hasVideo;return r!==o?!r&&o?(zy.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(e)),void this.safeEmit(dS.USER_PUBLISHED,i,e)):("video"===e&&i._videoTrack&&i._videoTrack._destroy(),"audio"===e&&i._audioTrack,this._p2pChannel.muteRemote(i,e),zy.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(e)),void this.safeEmit(dS.USER_UNPUBLISHED,i,e)):void 0})),ih(this,"_handleMuteStream",((e,t,n)=>{if(Dy("BLOCK_LOCAL_CLIENT")&&lR(e,this.channelName))return;zy.debug("[".concat(this._clientId,"] receive mute message"),e,t,n);const i=this._users.find((t=>t.uid===e));if(!i)return void zy.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const r="audio"===t?i.hasAudio:i.hasVideo;if("audio"===t){i._trust_audio_mute_state_=!0;const t=i._audio_muted_;if(i._audio_muted_=n,i._audio_muted_===t)return;{const t=i._audio_muted_?"mute-audio":"unmute-audio";zy.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(dS.USER_INFO_UPDATED,e,t)}}else{i._trust_video_mute_state_=!0;const t=i._video_muted_;if(i._video_muted_=n,i._video_muted_===t)return;{const t=i._video_muted_?"mute-video":"unmute-video";zy.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(dS.USER_INFO_UPDATED,e,t)}}const o="audio"===t?i.hasAudio:i.hasVideo;if(r!==o){if(!r&&o)return("audio"===t?i._audioSSRC:i._videoSSRC)?(zy.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(t)),void this.safeEmit(dS.USER_PUBLISHED,i,t)):void zy.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(t," unmute message  before add stream message, ").concat(t," SSRC doesn't exist yet."));"video"===t&&i._videoTrack&&!i._video_pre_subscribed&&i._videoTrack._destroy(),"audio"===t&&i._audioTrack,this._p2pChannel.muteRemote(i,t),zy.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(t)),this.safeEmit(dS.USER_UNPUBLISHED,i,t)}})),ih(this,"_handleP2PLost",(async e=>{zy.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():zy.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)})),ih(this,"_handleTokenWillExpire",(()=>{zy.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(dS.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),ih(this,"_handleBeforeUnload",(e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),zy.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),ih(this,"_handleUpdateNetworkQuality",(()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(dS.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(dS.NETWORK_QUALITY,e)})),ih(this,"_handleP2PAddAudioOrVideoStream",((e,t,n,i)=>{const r=this._users.find((e=>e.uid===t));if(!r)return void zy.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));zy.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(r.uid,e,void 0,void 0,void 0,Date.now());const o="audio"===e?r.hasAudio:r.hasVideo;"audio"===e?r._trust_audio_stream_added_state_=!0:r._trust_video_stream_added_state_=!0,"audio"===e?(r._audio_added_=!0,void 0!==n&&(r._audioSSRC=n),void 0!==i&&(r._audioMid=i)):(r._video_added_=!0,void 0!==n&&(r._videoSSRC=n),void 0!==i&&(r._videoMid=i)),("audio"===e?r.hasAudio:r.hasVideo)&&!o&&(zy.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published ").concat(e)),this.safeEmit(dS.USER_PUBLISHED,r,e)),this._p2pChannel.hasPendingRemoteMedia(r,e)&&(zy.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(r.uid," after reconnect.")),this._subscribe(r,e,!0).catch((e=>{zy.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))})),this._config=e,this._clientId=xS(5,"client-"),this.store=new Vy(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),zy.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(by," build: ").concat(Ay,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{mS(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(e){zy.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new uL(this.store),this._statsCollector.onStatsException=(e,t,n)=>{zy.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(t,", uid: ").concat(n)),this.safeEmit(dS.EXCEPTION,{code:e,msg:t,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,n,i)=>{const r=this._users.find((t=>t.uid===e));r&&oR.peerPublishStatus(this._sessionId,{subscribeElapse:i,audioPublishDuration:t,videoPublishDuration:n,peer:r._uintid})},this.store.useDataChannel=AI().supportDataChannel&&Dy("SIGNAL_CHANNEL"),this.store.useP2P="p2p"===e.mode,this._gateway=new Gb(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||qS,httpRetryConfig:e.httpRetryConfig||qS,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._configDistribute=new II,this.store.useP2P?(this._p2pChannel=new aL(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new iM(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,n,i,r){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=arguments.length>6&&void 0!==arguments[6]&&arguments[6];Ny("JOIN_GATEWAY_USE_443PORT_ONLY",o),Ny("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);const a=this._gateway.signal.websocket;return a instanceof ZC&&(a.use443PortOnly=o,a.tryDoubleDomain=s),async function(e,t,n){rg.get(e)||rg.set(e,[]),og.get(e)||og.set(e,t),sg.get(e)||sg.set(e,0);const i=rg.get(e),r=og.get(e);if(!i||!r)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(sg.get(e)===r){const e=ig();i.push(e),await e.promise}sg.set(e,sg.get(e)+1);for(var o=arguments.length,s=new Array(o>3?o-3:0),a=3;a<o;a++)s[a-3]=arguments[a];const c=await n(...s);return sg.set(e,sg.get(e)-1),sg.get(e)===r-1&&i.length>0&&(i[0].resolve(),i.shift()),0===sg.get(e)&&(rg.set(e,[]),og.set(e,0),sg.set(e,0)),c}("client.join",Dy("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,n,i,r)}async join(e,t,n,i,r){const o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const s=Ry(),a=Cy()?window.isSecureContext:"Browser Not Support";if(!Cy()&&!s||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";zy.warning(e)}const c=VS();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),zy.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const d=oR.reportApiInvoke(c,{name:oS.JOIN,options:[e,t,n,i],states:{isHttps:s,isSecureContext:a},tag:sS.TRACER});oR.setAppId(e);try{if(!n&&null!==n)throw new VR(xg.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&Wg(n,"token",1,2047),Wg(e,"appid",1,2047),FR(t),i&&jR(i),r&&Wg(r,"optionalInfo",1,2047)}catch(e){throw d.onError(e),e}if(zy.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(o)),this._leaveMutex.isLocked&&(zy.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),zy.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw d.onError(e),e}this._sessionId||(this._sessionId=c,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const l=IU(IU({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:"string"!=typeof i?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(l.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof i&&(l.stringUid=i,this._uintUid?(l.uid=this._uintUid,this._uintUid=void 0):l.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(l.aesmode=this._encryptionMode,l.aespassword=await eS(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(l.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:t,appId:e,stringUid:l.stringUid});const u=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&u===this._sessionId&&oR.joinChannelTimeout(this._sessionId,5)}),5e3);try{var h;let i;const r=l.cloudProxyServer;if(Ai(h=["proxy3","proxy4","proxy5"]).call(h,r)){const e=Dy("PROXY_SERVER_TYPE3");Array.isArray(e)?l.proxyServer=e[0]:l.proxyServer=e}if(oR.setProxyServer(l.proxyServer),zy.setProxyServer(l.proxyServer),this.store.requestAPStart(),l.stringUid&&!l.uid){let e;[e,i]=await tg.all([gI(l.stringUid,l,this._axiosCancelSource.token,this._config.httpRetryConfig||qS,this.store),EI(l,this._axiosCancelSource.token,this._config.httpRetryConfig||qS,!0,this.store)]),zy.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(l.stringUid," => ").concat(e)),l.uid=e,i.gatewayInfo.uid=e,i.gatewayInfo.res.uid=e}else i=await EI(l,this._axiosCancelSource.token,this._config.httpRetryConfig||qS,!0,this.store);if(!this._joinAndNotLeaveYet)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(l,this._axiosCancelSource.token),this._configDistribute.on(lC.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=n||e;const o=i.gatewayInfo,s=l.uid?l.uid:o.uid;this._joinInfo=IU(IU({},l),{},{cid:o.cid,uid:s,vid:o.vid,apResponse:o.res,uni_lbs_ip:o.uni_lbs_ip,gatewayAddrs:o.gatewayAddrs}),this.store.intUid=s;const a=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));d.onSuccess(a),this._appId=e,this._channelName=l.cname,this._uid=a,this.store.uid=a,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Tg()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const c=l.stringUid?"string uid: ".concat(l.stringUid,",uid: ").concat(l.uid):"uid: ".concat(this._uid);return zy.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(c)),setTimeout((()=>{zy.startUpload()}),5e3),this.store.joinEnd(),p=this,Ai(dR).call(dR,p)||dR.push(p),a}catch(e){const t=Array.isArray(e)?e[0]:e;throw t&&t.code===xg.OPERATION_ABORTED?zy.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),t):zy.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),t),t.code!==xg.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),d.onError(t),t}var p}_joinGateway(){if(!this._joinInfo||!this._key)throw new VR(xg.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!Dy("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===xg.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,cS.FALLBACK),e;if(e.code===xg.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,cS.FALLBACK),e;throw e})).then((e=>{if(e instanceof VR){if(e.code===xg.INIT_WEBSOCKET_TIMEOUT){if(zy.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new VR(xg.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=Dy("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),n=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&Ai(e).call(e,n)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const t=Dy("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return t&&t[1]&&"443"!==t[1]&&zy.setProxyServer(this._joinInfo.proxyServer),"443"!==Dy("STATS_COLLECTOR_PORT").toString()&&oR.setProxyServer(this._joinInfo.proxyServer),oR.reportApiInvoke(this._sessionId,{name:oS.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:sS.TRACER}).onSuccess(),this.safeEmit(dS.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),Dy("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(zy.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new VR(xg.INVALID_OPERATION);return oR.reportApiInvoke(this._sessionId,{name:oS.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:sS.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){zy.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Tg()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=dR.indexOf(e);-1!==t&&dR.splice(t,1)}(this);const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return zy.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),zy.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof fw))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new VR(xg.INVALID_PARAMS,"param list is empty");const n=e;if("audience"===this._gateway.role)throw new VR(xg.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof fw))throw new VR(xg.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&t)throw new VR(xg.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}zy.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof NA&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),zy.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw zy.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{i()}}async _publishDataChannel(e){Bg(e.id,"id",0,65535,!0),Fg(e.ordered,"ordered"),Wg(e.metadata,"metadata",0,512),zy.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new VR(xg.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new VR(xg.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Dy("FORCE_TURN")&&!Dy("TURN_ENABLE_TCP")&&!Dy("TURN_ENABLE_UDP"))throw new VR(xg.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const t=new _P(e);await this._p2pChannel.publishDataChannel([t]);try{const n={streamId:e.id,ordered:e.ordered,maxRetransmits:Dy("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:t._originDataChannelId};await this._gateway.publishDataChannel(this._uid,n,!0)}catch(e){if(e.code!==xg.DISCONNECT_P2P)throw e}return await t._waitTillOpen(),zy.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(t.id)),t}catch(e){throw zy.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{t()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new VR(xg.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof fw))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);zy.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof aL){const e=await this._p2pChannel.unpublish(t);e&&await this._gateway.sendExtensionMessage(OC.UNPUBLISH,{unpubMsg:e},!0)}else{const e=await this._p2pChannel.unpublish(t);e&&await this._gateway.unpublish(e,this._uid),zy.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw zy.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{n&&n()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),zy.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const t=await this._publishMutex.lock();try{const t=await this._p2pChannel.unpublishDataChannel(e);t&&await this._gateway.unpublishDataChannel(t),zy.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw zy.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{t&&t()}}async subscribe(e,t,n){return"datachannel"===t?this._subscribeDataChannel(e,n):this._subscribe(e,t)}async presubscribe(e,t){if(jg(t,"mediaType",["audio","video"]),this._p2pChannel instanceof aL)throw new VR(xg.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=t===hC.AUDIO,i=t===hC.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:r,ortc:o,rtxSsrcId:s,cname:a,uint_id:c}=await this._gateway.presubscribe(e,t,!0);if(null==r)throw new VR(xg.UNEXPECTED_RESPONSE,"no ssrc id");let d=this._users.find((t=>t.uid===e));d||(d=new nL(e,c||e),d._is_pre_created=!0,this._users.push(d)),a&&(d._cname=a),d._uintid||(d._uintid=c||e),n&&(d._audioSSRC=r,d._audio_pre_subscribed=!0,o&&(d._audioOrtc=o)),i&&(d._videoSSRC=r,d._video_pre_subscribed=!0,o&&(d._videoOrtc=o),null!=s&&(d._rtxSsrcId=s)),zy.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(r)),await this._p2pChannel.subscribe(d,t,r,s,o);const l=n?d._audioTrack:d._videoTrack;if(!l)throw new VR(xg.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(d._trust_audio_stream_added_state_=!0,d._audio_added_=!0),i&&(d._trust_video_stream_added_state_=!0,d._video_added_=!0),l}catch(t){throw zy.error("[".concat(this._clientId,"] presub user ").concat(e," error"),t),t}finally{r()}}async _subscribeDataChannel(e,t){var n;if(Bg(t,"channelId",0,65535,!0),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e)))throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new VR(xg.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new VR(xg.INVALID_REMOTE_USER,"user is not published");const i=null===(n=e._dataChannels)||void 0===n?void 0:n.find((e=>e.id===t));if(!i)throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new VR(xg.REMOTE_USER_IS_NOT_PUBLISHED);const r=await this._subscribeMutex.lock();zy.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const n=await this._p2pChannel.subscribeDataChannel(e,[i]);if(n&&Ai(n).call(n,i.id))try{var o;if(!i._originDataChannelId)throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new VR(xg.REMOTE_USER_IS_NOT_PUBLISHED);const t={id:i.id,datachannelId:i._originDataChannelId,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:null!==(o=i.metadata)&&void 0!==o?o:""};await this._gateway.subscribeDataChannel(e.uid,t,!0)}catch(t){if((null==t?void 0:t.code)!==xg.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[i]),t;await this._p2pChannel.unsubscribeDataChannel(e,[i]),this._p2pChannel.setPendingRemoteDataChannel(e,i.id)}return await i._waitTillOpen(),zy.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),i}finally{r()}}async _p2pSubscribe(e,t,n){if(jg(t,"mediaType",["audio","video"]),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const t=new VR(xg.INVALID_REMOTE_USER,"user is not in the channel");throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new VR(xg.INVALID_REMOTE_USER,"user is not published");throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!n&&("audio"===t&&!e.hasAudio||"video"===t&&!e.hasVideo)){const n=new VR(xg.REMOTE_USER_IS_NOT_PUBLISHED);throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),n}const i=await this._subscribeMutex.lock();zy.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const n="audio"===t?e._audioSSRC:e._videoSSRC,i="audio"===t?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this._p2pChannel instanceof aL&&await this._p2pChannel.subscribe(e,t,n,i)}catch(e){throw e}zy.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{zy.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===t?e._audioTrack:e._videoTrack;if(!n)throw new VR(xg.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(t){throw zy.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{i()}}async _subscribe(e,t,n){if(this._p2pChannel instanceof aL)return this._p2pSubscribe(e,t);if(jg(t,"mediaType",["audio","video"]),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const t=new VR(xg.INVALID_REMOTE_USER,"user is not in the channel");throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new VR(xg.INVALID_REMOTE_USER,"user is not published");throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!(n||("audio"!==t||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==t||e.hasVideo&&void 0!==e._videoSSRC))){const n=new VR(xg.REMOTE_USER_IS_NOT_PUBLISHED);throw zy.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),n}let i="audio"===t?e._audioSSRC:e._videoSSRC,r="audio"===t?e._audioOrtc:e._videoOrtc,o="video"===t?e._rtxSsrcId:void 0,s={stream_type:"audio"===t?hC.AUDIO:hC.VIDEO,ssrcId:i};const a=await this._subscribeMutex.lock();zy.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const a="audio"===t?e._audioSSRC:e._videoSSRC;void 0!==a&&a!==i&&(i=a,r="audio"===t?e._audioOrtc:e._videoOrtc,o="video"===t?e._rtxSsrcId:void 0,s={stream_type:"audio"===t?hC.AUDIO:hC.VIDEO,ssrcId:i}),gP.markSubscribeStart(this.store.clientId,i),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,i,o,r);try{await this._gateway.subscribe(e.uid,s,!0)}catch(n){if((null==n?void 0:n.code)!==xg.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),n;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(n){throw this._p2pChannel.reportSubscribeEvent(!1,null==n?void 0:n.code,e,t),n}zy.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{zy.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const a="audio"===t?e._audioTrack:e._videoTrack;if(!a)throw new VR(xg.UNEXPECTED_ERROR,"can not find remote track in user object");return a}catch(t){throw zy.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{a()}}async massSubscribe(e){if(Hg(e,"subscribeList"),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),n=new Map,i=await this._subscribeMutex.lock();zy.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n)})).join("; ")));const r=(e=[...e]).map((e=>{let{user:t,mediaType:n}=e;return{user:t,mediaType:n}})),o=await this._p2pChannel.globalLock();try{var s;for(let t=e.length-1;t>=0;t--){const i=e[t],{user:o,mediaType:s}=i;if(jg(s,"mediaType",["audio","video"]),!o){const e=new VR(xg.INVALID_PARAMS,"user property does not exist in subscribeList item");throw zy.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===o))){const n=new VR(xg.INVALID_REMOTE_USER,"user is not in the channel");zy.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),r[t].error=n,e.splice(t,1);continue}if("audio"===s&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===s&&(!o.hasVideo||void 0===o._videoSSRC)){const n=new VR(xg.REMOTE_USER_IS_NOT_PUBLISHED);zy.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(s,", remote user is not published")),r[t].error=n,e.splice(t,1);continue}const a=iC.Video|iC.LwoVideo,c=n.get(o);if(c){if("video"===s?c&a:c&iC.Audio){e.splice(t,1),zy.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(s," twice"));continue}n.set(o,c|("video"===s?a:iC.Audio))}else n.set(o,"video"===s?a:iC.Audio)}for(let t=e.length-1;t>=0;t--){const i=e[t],{user:r,mediaType:o}=i,s=iC.Video|iC.LwoVideo;if(this._p2pChannel.hasRemoteMedia(r,o)){await this._p2pChannel.unmuteRemoteNoLock(r,o);const i=n.get(r);n.set(r,"video"===o?i^s:i^iC.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),t);const i=cT(s=Array.from(n.entries())).call(s,((e,t)=>{let[n,i]=t;if(0===i)return e;const r={stream_id:n.uid,stream_type:i};return i&iC.Audio&&(r.audio_ssrc=n._audioSSRC),i&iC.Video&&(r.video_ssrc=n._videoSSRC),e.push(r),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:n}=e;return{user:t,mediaType:n,ssrcId:n===hC.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:n===hC.VIDEO?t._rtxSsrcId:void 0}})));const n=new Map;if(i.length>0){const e=await this._gateway.subscribeAll(i,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:r,error_code:o}=e;(i||r||o)&&n.set(t,{video_error_code:i,audio_error_code:r,error_code:o})}))}if(Array.from(n.entries()).length>0){const e=Array.from(n.entries()).map((e=>{let t,[n,i]=e;return i.error_code||i.video_error_code&&i.audio_error_code?t=void 0:i.video_error_code?t=hC.VIDEO:i.audio_error_code&&(t=hC.AUDIO),{user:this.remoteUsers.find((e=>e.uid===n)),mediaType:t}}));await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of r){const t=n.get(e.user.uid);if(t){const n=t.error_code||"audio"===e.mediaType&&t.audio_error_code||"video"===e.mediaType&&t.video_error_code;if(n){const t=FC(n);zy.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(t.desc)),e.error=new VR(xg.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(t.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(r.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),r.forEach((e=>{var n;oR.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(n=e.error)||void 0===n?void 0:n.code)||null,video:e.mediaType===hC.VIDEO,audio:e.mediaType===hC.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===hC.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)})),zy.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n)})).join("; "))),r}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{o(),i()}}async unsubscribe(e,t,n){if(t||this.store.useP2P){if("datachannel"===t)return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(t&&jg(t,"mediaType",["audio","video"]),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const t=new VR(xg.INVALID_REMOTE_USER,"user is not in the channel");throw zy.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}zy.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const i=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof aL)await this._p2pChannel.unsubscribe(e,t);else{const n=await this._p2pChannel.unsubscribe(e,t);n&&await this._gateway.unsubscribe(n,e.uid),t&&"audio"!==t||(e._audio_pre_subscribed=!1),t&&"video"!==t||(e._video_pre_subscribed=!1),e._is_pre_created&&CS(this._users,e),zy.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(t){if(t.code===xg.DISCONNECT_P2P)return void zy.warning("disconnecting p2p, abort unsubscribe request.");throw zy.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}finally{i()}}async _unsubscribeDataChannel(e,t){if(t&&Bg(t,"id",0,65535,!0),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((t=>t===e))){const t=new VR(xg.INVALID_REMOTE_USER,"user is not in the channel");throw zy.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}let n;if("number"==typeof t){const i=e._dataChannels.find((e=>e.id===t));i&&(n=[i])}else n=e._dataChannels;if(void 0===n){const n=new VR(xg.REMOTE_USER_IS_NOT_PUBLISHED);throw zy.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),n}zy.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map((e=>e.id))));try{const t=await this._p2pChannel.unsubscribeDataChannel(e,n);t&&await this._gateway.unsubscribeDataChannel(t,e.uid),zy.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(t))}catch(t){if(t.code===xg.DISCONNECT_P2P)return void zy.warning("disconnecting p2p, abort unsubscribe request.");throw zy.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}}async massUnsubscribe(e){if(Hg(e,"unsubscribeList"),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");zy.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n,";")})).join())),e=[...e];const t=new Map;for(let n=e.length-1;n>=0;n--){const{user:i,mediaType:r}=e[n];if(!i){const e=new VR(xg.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw zy.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}if(jg(r,"mediaType",["video","audio",void 0]),!this._users.find((e=>e===i))){zy.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),e.splice(n,1);continue}const o=iC.Video|iC.LwoVideo;if(t.has(i)){const s=t.get(i);let a;switch(r){case"video":a=s&o;break;case"audio":a=s&iC.Audio;break;default:a=s&(iC.Audio|o)}if(a){zy.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),e.splice(n,1);continue}r?"audio"===r?t.set(i,s|iC.Audio):"video"===r&&t.set(i,s|o):t.set(i,s|iC.Audio|o)}else r?"audio"===r?t.set(i,iC.Audio):"video"===r&&t.set(i,o):t.set(i,iC.Audio|o)}try{const t=await this._p2pChannel.massUnsubscribe(e);t&&await this._gateway.massUnsubscribe(t),zy.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n,";")})).join()))}catch(e){if(e.code===xg.DISCONNECT_P2P)return void zy.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw zy.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){!function(e){if(!e)throw new Vg(xg.INVALID_PARAMS);Kg(e.width)||Gg(e.width,"streamParameter.width"),Kg(e.height)||Gg(e.height,"streamParameter.height"),Kg(e.framerate)||Gg(e.framerate,"streamParameter.framerate"),Kg(e.bitrate)||Bg(e.bitrate,"streamParameter.bitrate")}(e),(!e.width&&e.height||e.width&&!e.height)&&zy.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),zy.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,_C.LocalVideoLowTrack)}async enableDualStream(){if(!AI().supportDualStream)throw oR.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new VR(xg.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new VR(xg.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw oR.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,oR.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),zy.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(_C.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw oR.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,oR.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),zy.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(e){jg(e,"role",["audience","host"])}(e),t&&mS(t),"rtc"===this.mode||"p2p"===this.mode)throw zy.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new VR(xg.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&"host"===e)throw new VR(xg.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new VR(xg.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),this._config.role=e,zy.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const n=t.timestamp-Date.now();return Math.abs(n)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(Wg(e,"proxyServer"),!t){if("DISCONNECTED"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new VR(xg.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,oR.setProxyServer(this._proxyServer),zy.setProxyServer(this._proxyServer),zy.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if("DISCONNECTED"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new VR(xg.INVALID_OPERATION,"You have already set the proxy")}if(fS(e))return this._turnServer={servers:e,mode:"original-manual"},void zy.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>_S(e))),this._turnServer={servers:e,mode:"manual"},zy.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"you should set license before join channel");if(Wg(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new VR(xg.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,zy.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new VR(xg.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let n;switch(void 0===e&&(e=3),e){case 1:case 2:throw new VR(xg.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new VR(xg.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,zy.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"Stop proxy server after leave channel");oR.setProxyServer(),zy.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",zy.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new VR(xg.INVALID_PARAMS,"accessPoints is required.");Hg(e.accessPoints.serverList,"accessPoints.serverList"),Wg(e.accessPoints.domain,"accessPoints.domain");const t=(e,t)=>{Bg(e,t,0,65535,!0)};let n=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new VR(xg.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");Dy("CLOSE_AFB_FOR_LOCAL_AP")&&(Ny("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Ny("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,o=e.accessPoints.serverList.map((e=>i.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(r):e)),s=o.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Ny("WEBCS_DOMAIN",s),Ny("WEBCS_DOMAIN_BACKUP_LIST",s),Ny("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Hg(e.report.hostname,"report.hostname"),Ny("EVENT_REPORT_DOMAIN",e.report.hostname[0]),Ny("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(Ny("EVENT_REPORT_DOMAIN",o[0]),Ny("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),Ny("STATS_COLLECTOR_PORT",a),e.report?Ny("ENABLE_EVENT_REPORT",!0):Ny("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Hg(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=o[0];let d=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),d=e.log.port),Ny("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Hg(e.cds.hostname,"cds.hostname"),l=e.cds.hostname):l=o;let u=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),u=e.cds.port),Ny("CDS_AP",l.map((e=>"".concat(e,":").concat(u)))),e.cds?Ny("ENABLE_CONFIG_DISTRIBUTE",!0):Ny("ENABLE_CONFIG_DISTRIBUTE",!1),zy.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Hg(e,"serverList"),Wg(t,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new VR(xg.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(t):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Ny("WEBCS_DOMAIN",e),Ny("WEBCS_DOMAIN_BACKUP_LIST",e),Ny("GATEWAY_DOMAINS",[t]),Ny("EVENT_REPORT_DOMAIN",e[0]),Ny("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),Ny("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),zy.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(jg(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw zy.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else zy.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){jg(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw zy.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}zy.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){jg(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(e){throw zy.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}zy.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,n){!function(e){jg(e,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(e),Wg(t,"secret");const i=["aes-128-gcm2","aes-256-gcm2"];if(Ai(i).call(i,e)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new VR(xg.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new VR(xg.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(t)||zy.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=t,n&&(this._encryptionSalt=PS(n))}async renewToken(e){if(Wg(e,"token",1,2047),!this._key||!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(Dy("USE_NEW_TOKEN")){zy.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const t=await RI(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||qS);zy.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:t})}else zy.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});zy.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=t,this._joinInfo.token=t,zy.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?zy.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(dS.VOLUME_INDICATOR,e)}),Dy("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new VR(xg.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new VR(xg.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new VR(xg.LIVE_STREAMING_TASK_CONFLICT);const n=t?IR.TRANSCODE:IR.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(e,n)}setLiveTranscoding(e){return this._createLiveStreamingClient(IR.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new VR(xg.INVALID_PARAMS,"can not find live streaming url to stop");await tg.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const n=this._createLiveStreamingClient(IR.INJECT);n.setInjectStreamConfig(t,0),await n.startLiveStreamingTask(e,IR.INJECT)}async removeInjectStreamUrl(){var e;const t=this._createLiveStreamingClient(IR.INJECT),n=Array.from(MR(e=t.streamingTasks).call(e)).find((e=>e.mode===IR.INJECT));if(!this._joinInfo||!n)throw new VR(xg.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(n.url)}async startChannelMediaRelay(e){SL(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){SL(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}if(new Blob([e.payload]).size>1024)throw new VR(xg.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(TR.DATA_STREAM,{payload:PS(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-mU},!t)}sendMetadata(e){if(!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new VR(xg.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(TR.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:PS(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(Jy),!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"can not send custom report, not joined");await oR.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){jg(t.spatialLayer,"spatialLayer",[0,1,2,3]),jg(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(e){throw zy.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:n}=e;if(Fg(t,"apRTM"),Bg(n,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=n,zy.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(zy.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=_y.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new zS("client-publish"),this._subscribeMutex=new zS("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,t){var n;const i=e||VS();e?zy.debug("[".concat(this._clientId,"] new Session ").concat(i)):zy.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=e?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i;const o={lts:(new Date).getTime(),mode:this.mode,stringUid:(null==t?void 0:t.stringUid)||(null===(n=this._joinInfo)||void 0===n?void 0:n.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:"audience"===this.role?2:1};t?oR.sessionInit(this._sessionId,IU({cname:t.channel,appid:t.appId},o)):this._joinInfo?oR.sessionInit(this._sessionId,IU({cname:this._joinInfo.cname,appid:this._joinInfo.appId},o)):this._gateway.joinInfo&&oR.sessionInit(this._sessionId,IU({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new VR(xg.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Dy("FORCE_TURN")&&!Dy("TURN_ENABLE_TCP")&&!Dy("TURN_ENABLE_UDP"))throw new VR(xg.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");zy.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof aL){const t=(await n.next()).value;if(t){try{await this._gateway.sendExtensionMessage(OC.PUBLISH,t,!0)}catch(e){throw n.throw(e),e}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(e){if(e.code!==xg.DISCONNECT_P2P)throw n.throw(e),e}await n.next((null===(t=r)||void 0===t?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof NA&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===xg.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new VR(xg.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new VR(xg.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));zy.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(await e.next()).value;if(n){var t;let i;try{i=await this._gateway.publish(this._uid,n,!0)}catch(t){if(t.code!==xg.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(t=i)||void 0===t?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===xg.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new VR(xg.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const t=()=>new EL(this._joinInfo,this._config.websocketRetryConfig||qS,this._config.httpRetryConfig||qS),n=e=>{e.onLiveStreamError=(e,t)=>{oR.reportApiInvoke(this._sessionId,{name:oS.ON_LIVE_STREAM_ERROR,options:[e,t],tag:sS.TRACER}).onSuccess(),this.safeEmit(dS.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{oR.reportApiInvoke(this._sessionId,{name:oS.ON_LIVE_STREAM_WARNING,options:[e,t],tag:sS.TRACER}).onSuccess(),this.safeEmit(dS.LIVE_STREAMING_WARNING,e,t)},e.on(YR.REQUEST_WORKER_MANAGER_LIST,((e,t,n)=>{if(!this._joinInfo)return n(new VR(xg.INVALID_OPERATION,"can not find join info to get worker manager"));vI(e,this._joinInfo,this._axiosCancelSource.token,qS).then(t).catch(n)}))};switch(e){case IR.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case IR.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case IR.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(YR.REQUEST_WORKER_MANAGER_LIST,((e,t,n)=>{if(!this._joinInfo)return n(new VR(xg.INVALID_OPERATION,"can not find join info to get worker manager"));vI(e,this._joinInfo,this._axiosCancelSource.token,qS).then(t).catch(n)})),this._injectStreamingClient.onInjectStatusChange=(e,t,n)=>{this.safeEmit(dS.INJECT_STREAM_STATUS,e,t,n)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new VR(xg.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),n={width:e,height:t};this._channelMediaRelayClient=new vL(this._joinInfo,this._clientId,this._config.websocketRetryConfig||qS,this._config.httpRetryConfig||qS,n),this._channelMediaRelayClient.on("state",(e=>{e===ZR.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(dS.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(dS.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var n;"resolution"===e&&(null===(n=this._channelMediaRelayClient)||void 0===n||n.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:n,deleted:i}=e,r=[];Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:n,stream_id:i,ordered:o,max_retrans_times:s,metadata:a}=e,c=this._users.find((e=>e._uintid===n));if(c){if(zy.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),Ai(r).call(r,c)||r.push(c),c._uintid||(c._uintid=n),-1===c._dataChannels.findIndex((t=>t.id===e.stream_id))){const e={id:i,ordered:!!o,maxRetransmits:s,metadata:a},n=new fP(e);c._dataChannels.push(n),zy.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published datachannel")),t||this.safeEmit(dS.USER_PUBLISHED,c,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(c,e.stream_id)&&(zy.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(c.uid," after reconnect.")),this._subscribeDataChannel(c,e.stream_id).catch((e=>{zy.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))}else zy.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"))})),t&&(this.safeEmit(dS.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach((e=>{const{uid:t,stream_id:n}=e,i=this._users.find((e=>e._uintid===t));if(!i)return void zy.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const r=i._dataChannels.find((t=>t.id===e.stream_id));r&&(zy.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(t)),this._p2pChannel.unsubscribeDataChannel(i,[r]).then((e=>{if(i._dataChannels=i._dataChannels.filter((e=>e!==r)),e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),zy.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished datachannel ,id:").concat(r.id)),this.safeEmit(dS.USER_UNPUBLISHED,i,"datachannel",r._config))}))}_handleRemoveDataChannels(e){const t=this._users.find((t=>t.uid===e.uid));if(t){if(void 0!==t._dataChannels&&t._dataChannels.length>0){zy.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{zy.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach((e=>{this.safeEmit(dS.USER_UNPUBLISHED,t,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,t.uid)})),n()}}else zy.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(tC.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(tC.CONNECTION_STATE_CHANGE,((e,t,n)=>{var i;if(n===cS.FALLBACK)return;const r=()=>{this.safeEmit(dS.CONNECTION_STATE_CHANGE,e,t,n)};if(oR.reportApiInvoke(this._sessionId||(null===(i=this._gateway.joinInfo)||void 0===i?void 0:i.sid)||null,{name:oS.CONNECTION_STATE_CHANGE,options:[e,t,n],tag:sS.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:n})),zy.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void r();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._is_pre_created||(e._audio_pre_subscribed||(e._audioSSRC=void 0,e._audioOrtc=void 0),e._video_pre_subscribed||(e._videoSSRC=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0),e._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var o;this._streamFallbackTypeCacheMap.forEach(((e,t)=>{this._gateway.setStreamFallbackOption(t,e).catch((e=>{zy.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,t)=>{this._gateway.setRemoteVideoStreamType(t,e).catch((e=>{zy.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(o=this._joinInfo)||void 0===o?void 0:o.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{zy.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{zy.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{zy.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(zy.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,hC.AUDIO,!1)),e._trust_video_mute_state_||(zy.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,hC.VIDEO,!1)),e._trust_audio_enabled_state_||(zy.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(zy.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(zy.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(zy.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(zy.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}r()})),this._gateway.on(tC.REQUEST_NEW_GATEWAY_LIST,((e,t)=>{if(!this._joinInfo)return t(new VR(xg.UNEXPECTED_ERROR,"can not recover, no join info"));mI(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||qS,this.store).then((t=>{this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const n=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[i,r]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?n.push({proxy:this._joinInfo.proxyServer,host:i,port:r}):n.push({host:i,port:r})})),e(n)})).catch(t)})),this._gateway.on(tC.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(dS.NETWORK_QUALITY,e)})),this._gateway.on(tC.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(dS.STREAM_TYPE_CHANGED,e,t),oR.reportApiInvoke(this._sessionId,{name:oS.STREAM_TYPE_CHANGE,options:[e,t],tag:sS.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(tC.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(tC.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(tC.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,n)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){n(e)}})),this._gateway.on(tC.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:n,iceParameters:i,candidates:r,rtpCapabilities:o,setup:s,cname:a}=gk(e.ortc,t);this._p2pChannel.connect(i,n,r,o,s,a)})),this._gateway.on(tC.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(tC.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(tC.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(tC.DATACHANNEL_PRECONNECT,(async(e,t,n,i)=>{var r,o,s,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:null===(r=this._joinInfo)||void 0===r?void 0:r.turnServer},!0);const l=function(e,t){let n;return t&&t.ip&&"number"==typeof t.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],zy.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),zy.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],n}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(o=this._joinInfo)||void 0===o?void 0:o.apResponse.cid,"_").concat(null===(s=this._joinInfo)||void 0===s?void 0:s.apResponse.cert),icePwd:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(d=Dy("FINGERPRINT"))&&void 0!==d?d:e.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(i)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(yR.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(yR.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(yR.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(yR.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(yR.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(yR.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(yR.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(yR.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(yR.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,hC.AUDIO,!0))),this._gateway.signal.on(yR.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,hC.AUDIO,!1))),this._gateway.signal.on(yR.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,hC.VIDEO,!0))),this._gateway.signal.on(yR.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,hC.VIDEO,!1))),this._gateway.signal.on(yR.RECEIVE_METADATA,(e=>{const t=DS(e.metadata);this.safeEmit(dS.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(yR.ON_DATA_STREAM,(async e=>{if(!e)return;let t=0;if(e.ordered||e.syncWithAudio){const n=this._p2pChannel.getStats(),i=this.remoteUsers.find((t=>t.uid===e.uid)),r=null==n?void 0:n.audioRecv.find((e=>e.ssrc===(null==i?void 0:i._audioSSRC)));t=null==r?void 0:r.jitterBufferMs}null==t&&(t=0),yU(e,t,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(yR.ON_CRYPT_ERROR,(()=>{NS((()=>{zy.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(dS.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(yR.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(yR.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{zy.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,cS.TOKEN_EXPIRE),this.safeEmit(dS.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(yR.ON_STREAM_FALLBACK_UPDATE,(e=>{zy.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(dS.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(yR.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),zy.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(yR.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(yR.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(SR.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case TR.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var n,i;const r=e.some((e=>{let{stream_type:t}=e;return t===eC.Audio})),o=e.some((e=>{let{stream_type:t}=e;return t!==eC.Audio})),s=e.some((e=>{let{stream_type:t}=e;return t===eC.Screen||t===eC.ScreenLow}));"offer"===t.state&&oR.publish(this._joinInfo.sid,{eventElapse:gP.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:xg.TIMEOUT,audio:r,video:o,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:s,audioName:r?null===(n=e.find((e=>{let{stream_type:t}=e;return t===eC.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:o?null===(i=e.find((e=>{let{stream_type:t}=e;return t!==eC.Audio})))||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId.toString():void 0})}break}case TR.SUBSCRIBE:t&&oR.subscribe(this._joinInfo.sid,{succ:!1,ec:xg.TIMEOUT,audio:t.stream_type===hC.AUDIO,video:t.stream_type===hC.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:gP.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(yR.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(yR.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;Dy("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!lR(e.string_id||e.stream_id,this.channelName))));const t=[],n=[];for(const i of e.users){let e=this._users.find((e=>e._uintid===i.stream_id));e?e._trust_in_room_=!0:(e=new nL(i.string_id||i.stream_id,i.stream_id),this._users.push(e),0===this.getListeners(dS.PUBLISHED_USER_LIST).length&&(zy.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(dS.USER_JOINED,e)));const r=iC.Audio&i.stream_type,o=(iC.Video|iC.LwoVideo)&i.stream_type,s=0!=(65280&i.stream_type),a=r&&e.hasAudio,c=o&&e.hasVideo;o&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=i.video_ssrc,e._rtxSsrcId=i.video_rtx),r&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=i.audio_ssrc),r&&!a&&0===this.getListeners(dS.PUBLISHED_USER_LIST).length&&(zy.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(dS.USER_PUBLISHED,e,"audio")),o&&!c&&0===this.getListeners(dS.PUBLISHED_USER_LIST).length&&(zy.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(dS.USER_PUBLISHED,e,"video")),(r&&!a||o&&!c||s)&&t.push(e),o&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&n.push({user:e,mediaType:"video"}),r&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&n.push({user:e,mediaType:"audio"})}n.length>0&&(zy.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((e=>{zy.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(dS.PUBLISHED_USER_LIST).length>0?Dy("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(zy.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map((e=>e.uid)).join(", "))),this.safeEmit(dS.PUBLISHED_USER_LIST,t)):zy.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map((e=>e.uid)).join(", ")))})),this._gateway.signal.on(yR.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;this._p2pChannel instanceof iM&&this._p2pChannel.updateRemoteRTPCapabilities(t.map((e=>e.toLowerCase())).filter((e=>{var t;return Ai(t=Object.keys(Uy)).call(t,e)})))}))}_handleP2PEvents(){this._gateway.signal.on(yR.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(OC.PUBLISH,((e,t,n)=>{const{uid:i}=e;e.forEach((e=>{const{kind:r,ssrcs:o,mid:s,isMuted:a}=e;this._handleP2PAddAudioOrVideoStream(r,i,o[0].ssrcId,s);const c=this._users.find((e=>e.uid===i));return c&&this._p2pChannel instanceof aL?this._p2pChannel.mockSubscribe(c,r,o[0].ssrcId,s).then((()=>{t()})).catch(n):t(),this._handleMuteStream(i,r,!!a)}))})),this._gateway.signal.on(OC.CALL,(async(e,t,n)=>{if(this._p2pChannel instanceof aL)try{var i;t(await this._p2pChannel.startP2P({turnServer:null===(i=this._joinInfo)||void 0===i?void 0:i.turnServer},e))}catch(e){n(e)}})),this._gateway.signal.on(SR.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof aL&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(OC.UNPUBLISH,(async(e,t,n)=>{if(this._p2pChannel instanceof aL){const{unpubMsg:i,uid:r}=e,o=this._users.find((e=>e.uid===r));if(!o)return zy.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void t();try{i.forEach((async e=>{let{stream_type:t}=e;const n=t===eC.Audio?hC.AUDIO:hC.VIDEO;await this._p2pChannel.unsubscribe(o,n),this._handleMuteStream(r,n,!0)})),t()}catch(e){n(e)}}})),this._gateway.signal.on(OC.CONTROL,(async(e,t)=>{const{action:n}=e;switch(n){case DC.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,hC.VIDEO,!0);break;case DC.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,hC.AUDIO,!0);break;case DC.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,hC.VIDEO,!1);break;case DC.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,hC.AUDIO,!1)}})),this._gateway.signal.on(OC.RESTART_ICE,(async(e,t,n)=>{if(this._p2pChannel instanceof aL)try{const{direction:n,iceParameter:i}=e;n!==CR.SEND_ONLY||i?t(await this._p2pChannel.restartICE(n,i)):(this._p2pChannel.handleDisconnect(n),t())}catch(e){n(e)}})),this._gateway.signal.on(OC.CANDIDATE,(e=>{if(this._p2pChannel instanceof aL){const{candidate:t,direction:n}=e;this._p2pChannel.addRemoteCandidate(t,n)}})),this._p2pChannel.on(EC.RequestP2PRestartICE,(async(e,t,n)=>{try{const{direction:n}=e;t(await this._gateway.sendExtensionMessage(OC.RESTART_ICE,e,n===CR.SEND_ONLY))}catch(e){n(e)}})),this._p2pChannel.on(EC.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(OC.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(EC.RequestP2PMuteLocal,(async(e,t,n)=>{try{await this._gateway.sendExtensionMessage(OC.CONTROL,e,!0),t()}catch(e){n(e)}})),this._p2pChannel.on(EC.RequestP2PUnmuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===xg.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(EC.RequestP2PMuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===xg.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(EC.StateChange,((e,t)=>{t===mC.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(EC.RequestMuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===xg.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(EC.RequestUnmuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===xg.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(EC.RequestRePublish,((e,t,n)=>{this.publish(e,!1).then(t).catch(n)})),this._p2pChannel.on(EC.RequestRePublishDataChannel,((e,t,n)=>{tg.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==xg.DISCONNECT_P2P)throw e}}))).then(t).catch(n)})),this._p2pChannel.on(EC.RequestReSubscribe,(async(e,t,n)=>{try{for(const{user:t,kind:n}of e)n===hC.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){n(e)}})),this._p2pChannel.on(EC.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(EC.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(EC.MediaReconnectStart,(e=>{this.safeEmit(dS.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(EC.MediaReconnectEnd,(e=>{this.safeEmit(dS.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(EC.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(EC.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof aL)return;const t=await this._p2pChannel.restartICE(e),n=await t.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(r);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(EC.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(EC.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:n,rtpCapabilities:i}),{dtlsParameters:s,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:u}=gk(r,o);await this._p2pChannel.connect(a,s,c,d,l,u),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(EC.RequestUnpublishForReconnectPC,(async(e,t,n)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):n()})),this._p2pChannel.on(EC.P2PLost,(()=>{this.safeEmit(dS.P2P_LOST,this.store.uid)})),this._p2pChannel.on(EC.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(EC.ConnectionTypeChange,(e=>{this.safeEmit(dS.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(EC.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(EC.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{var t;if(!Ai(t=["supervise","moderation"]).call(t,e))throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new LM(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},qS)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(Fg(e,"enabled"),e){if(!t)throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(Bg(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new VR(xg.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new pU(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},qS)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new VR(xg.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}setP2PTransport(e){if(function(e){jg(e,"transport",["default","auto","relay","sd-rtn"])}(e),"p2p"!==this.mode)throw new VR(xg.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,zy.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(wC.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(dS.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,n),t===IC.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new VR(xg.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(wC.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(e){e.on(vC.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(dS.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,n),n===SC.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(dS.CONTENT_INSPECT_ERROR,new VR(xg.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(vC.INSPECT_RESULT,((e,t)=>{var n;if((null==t?void 0:t.code)===xg.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return zy.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.safeEmit(dS.CONTENT_INSPECT_RESULT,e,t)})),e.on(vC.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return zy.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){Fg(e,"enabled"),Ny("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],wU.prototype,"leave",null),UR([rR({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof fw))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),xR("design:type",Function),xR("design:paramtypes",[Object,Boolean]),xR("design:returntype",tg)],wU.prototype,"publish",null),UR([rR({argsMap:(e,t)=>(t||(t=[]),t instanceof _P?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],wU.prototype,"unpublish",null),UR([rR({argsMap:(e,t,n,i)=>[t.uid,n,i]}),xR("design:type",Function),xR("design:paramtypes",[nL,String,Number]),xR("design:returntype",tg)],wU.prototype,"subscribe",null),UR([rR({argsMap:(e,t,n)=>[t,n]}),xR("design:type",Function),xR("design:paramtypes",[Object,String]),xR("design:returntype",tg)],wU.prototype,"presubscribe",null),UR([rR({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:n}=e;return[null==t?void 0:t.uid,n]}))}),xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],wU.prototype,"massSubscribe",null),UR([rR({argsMap:(e,t,n,i)=>[t.uid,n,i]}),xR("design:type",Function),xR("design:paramtypes",[nL,String,Number]),xR("design:returntype",tg)],wU.prototype,"unsubscribe",null),UR([rR({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:n}=e;return{uid:null==t?void 0:t.uid,mediaType:n}}))}),xR("design:type",Function),xR("design:paramtypes",[Array]),xR("design:returntype",tg)],wU.prototype,"massUnsubscribe",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],wU.prototype,"setLowStreamParameter",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],wU.prototype,"enableDualStream",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],wU.prototype,"disableDualStream",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String,Object]),xR("design:returntype",tg)],wU.prototype,"setClientRole",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String,Boolean]),xR("design:returntype",void 0)],wU.prototype,"setProxyServer",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object,Boolean]),xR("design:returntype",void 0)],wU.prototype,"setTurnServer",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",void 0)],wU.prototype,"setLicense",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Number]),xR("design:returntype",void 0)],wU.prototype,"startProxyServer",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],wU.prototype,"stopProxyServer",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",void 0)],wU.prototype,"setLocalAccessPointsV2",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Array,String]),xR("design:returntype",void 0)],wU.prototype,"setLocalAccessPoints",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Number]),xR("design:returntype",tg)],wU.prototype,"setRemoteDefaultVideoStreamType",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object,Number]),xR("design:returntype",tg)],wU.prototype,"setRemoteVideoStreamType",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object,Number]),xR("design:returntype",tg)],wU.prototype,"setStreamFallbackOption",null),UR([rR({argsMap:(e,t)=>[t]}),xR("design:type",Function),xR("design:paramtypes",[String,String,Uint8Array]),xR("design:returntype",void 0)],wU.prototype,"setEncryptionConfig",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],wU.prototype,"renewToken",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",void 0)],wU.prototype,"enableAudioVolumeIndicator",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String,Boolean]),xR("design:returntype",tg)],wU.prototype,"startLiveStreaming",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],wU.prototype,"setLiveTranscoding",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",tg)],wU.prototype,"stopLiveStreaming",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String,Object]),xR("design:returntype",tg)],wU.prototype,"addInjectStreamUrl",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],wU.prototype,"removeInjectStreamUrl",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[gL]),xR("design:returntype",tg)],wU.prototype,"startChannelMediaRelay",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[gL]),xR("design:returntype",tg)],wU.prototype,"updateChannelMediaRelay",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],wU.prototype,"stopChannelMediaRelay",null),UR([rR({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],wU.prototype,"sendCustomReportMessage",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object,Object]),xR("design:returntype",tg)],wU.prototype,"pickSVCLayer",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],wU.prototype,"setRTMConfig",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Object]),xR("design:returntype",tg)],wU.prototype,"enableContentInspect",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",tg)],wU.prototype,"disableContentInspect",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Boolean,Object]),xR("design:returntype",tg)],wU.prototype,"setImageModeration",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[String]),xR("design:returntype",void 0)],wU.prototype,"setP2PTransport",null),UR([rR({reportResult:!0}),xR("design:type",Function),xR("design:paramtypes",[]),xR("design:returntype",Array)],wU.prototype,"getJoinChannelServiceRecords",null),UR([rR(),xR("design:type",Function),xR("design:paramtypes",[Boolean]),xR("design:returntype",tg)],wU.prototype,"setPublishAudioFilterEnabled",null);class AU{constructor(e,t){ih(this,"id",0),ih(this,"element",void 0),ih(this,"peerPair",void 0),ih(this,"context",void 0),ih(this,"audioPlayerElement",void 0),ih(this,"audioTrack",void 0),AU.count+=1,this.id=AU.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const n="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(n),"complete"===e.iceGatheringState?e.localDescription:new tg((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const n=await e(this.peerPair[0],"offer");await t(this.peerPair[1],n);const i=await e(this.peerPair[1],"answer");await t(this.peerPair[0],i)}catch(e){throw new VR(xg.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(t)}catch(e){throw new VR(xg.LOCAL_AEC_ERROR,e.toString()).print()}if(!t)throw new VR(xg.LOCAL_AEC_ERROR,"no dest node when local aec").print();const n=t.stream.getAudioTracks()[0];return this.audioTrack=n,n}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){zy.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}ih(AU,"count",0);const OU=window.AudioContext||window.webkitAudioContext;class NU{constructor(){ih(this,"units",[]),ih(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return zy.debug("the system does not need to process local aec"),-1;this.context||(this.context=new OU);let t=this.units.find((t=>t&&t.getElement()===e));return t||(t=new AU(e,this.context),this.units.push(t)),t.startEchoCancellation(),zy.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return pg().name!==cg.SAFARI}}UR([rR({report:oR}),xR("design:type",Function),xR("design:paramtypes",[HTMLAudioElement]),xR("design:returntype",Number)],NU.prototype,"processExternalMediaAEC",null);const DU=new NU;function PU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function kU(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?PU(Object(n),!0).forEach((function(t){ih(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):PU(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const LU=window||document;function MU(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!LU)return;const n=xU._cspEventHandlerPointer;if(n&&t)return void console.error(n,t);const i=e=>{if(!(e&&e.blockedURI&&(xU.onSecurityPolicyViolation||xU.getListeners(CC.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;Dy("CSP_DETECTED_HOSTNAME_LIST").some((e=>Ai(t).call(t,e)))&&(xU.onSecurityPolicyViolation&&"function"==typeof xU.onSecurityPolicyViolation&&xU.onSecurityPolicyViolation(e),xU.getListeners(CC.SECURITY_POLICY_VIOLATION).length>0&&xU.safeEmit(CC.SECURITY_POLICY_VIOLATION,e))};n&&LU.removeEventListener("securitypolicyviolation",n),(t||e&&"function"==typeof e||xU.getListeners(CC.SECURITY_POLICY_VIOLATION).length>0)&&LU.addEventListener("securitypolicyviolation",i),xU._cspEventHandlerPointer=i}Ny("PROCESS_ID","process-".concat(xS(8,""),"-").concat(xS(4,""),"-").concat(xS(4,""),"-").concat(xS(4,""),"-").concat(xS(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void zy.error("Error loading sdk config",e.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();zy.debug("Loading global parameters from cache",t),Object.keys(t).forEach((e=>{if(Object.prototype.hasOwnProperty.call(Oy,e)){const{value:i,expires:r}=t[e];if(r&&r<=n)return;Py[e]=i,Oy[e]=i}}))}catch(t){zy.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(Py.AREAS)&&Py.AREAS.length>0&&eI(Py.AREAS,!0);const UU=(e,t,n)=>{zy.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),Ny(e,t,n)},xU=function(e){const t=new nS,n=e,i={getListeners:t.getListeners.bind(t),on:(e,n)=>(function(e,t){e===CC.SECURITY_POLICY_VIOLATION&&MU(t,!0)}(e,n),t.on.bind(t)(e,n)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return kU(kU({},n),i)}({__TRACK_LIST__:WI,VERSION:by,BUILD:Ay,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:UU,getParameter:Dy,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const n=(await t.createOffer()).sdp;if(!n)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(n)}catch(e){throw new VR(xg.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e},checkSystemRequirements:function(){const e=oR.reportApiInvoke(null,{name:oS.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:sS.TRACER});let t=!1;try{const e=window.RTCPeerConnection,n=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket;t=!!(e&&n&&i)}catch(e){return zy.error("check system requirement failed: ",e),!1}let n=!1;const i=pg();i.name===cg.CHROME&&Number(i.version)>=58&&(!gg()||Eg())&&(n=!0),i.name===cg.FIREFOX&&Number(i.version)>=56&&(n=!0),i.name===cg.OPERA&&Number(i.version)>=45&&(n=!0),i.name===cg.SAFARI&&Number(i.version)>=11&&(n=!0),(Pg()||pg().name===cg.QQ)&&(n=!0),zy.debug("checkSystemRequirements, api:",t,"browser",n);const r=t&&n;return e.onSuccess(r),r},getDevices:function(e){return Fw.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return Fw.getRecordingDevices(e)},getCameras:function(e){return Fw.getCamerasDevices(e)},getElectronScreenSources:Nw,getPlaybackDevices:function(e){return Fw.getSpeakers(e)},createClient:function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=oR.reportApiInvoke(null,{name:oS.CREATE_CLIENT,options:[t],tag:sS.TRACER});try{!function(e){jg(e.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),jg(e.mode,"config.mode",["rtc","live","p2p"]),void 0!==e.audioCodec&&jg(e.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==e.proxyServer&&Wg(e.proxyServer,"config.proxyServer",1,1e4),void 0!==e.turnServer&&_S(e.turnServer),void 0!==e.httpRetryConfig&&pS(e.httpRetryConfig),void 0!==e.websocketRetryConfig&&pS(e.websocketRetryConfig)}(t)}catch(e){throw n.onError(e),e}return CU()||("vp9"===t.codec&&(t.codec="vp8",zy.debug("browser not support vp9, force use vp8")),Ny("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===t.audioCodec&&(t.audioCodec="opus"),n.onSuccess(),new wU(IU(IU({forceWaitGatewayResponse:!0},t),{},{role:Ai(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_CAM_VIDEO_TRACK,options:[kA({},e)]}),n=hA(e),i=xS(8,"track-cam-");let r=null;const o="720p_auto"===e.encoderConfig;zy.info("start create camera video track with config",JSON.stringify(e),"trackId",i);try{r=(await Mw({video:n},i)).getVideoTracks()[0]||null}catch(e){throw t.onError(e),e}if(!r){const e=new Vg(xg.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(e),e.throw(zy)}e.optimizationMode&&LA(i,r,e,VI(e.encoderConfig));const s=new DA(r,e,n,e.scalabiltyMode?jI(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,i);return o&&s.startMonitorStats(),t.onSuccess(s.getTrackId()),zy.info("create camera video success, trackId:",i),s},createCustomVideoTrack:function(e){const t=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_CUSTOM_VIDEO_TRACK,options:[e]}),n=new NA(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?jI(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,xS(8,"track-cus-"),[zI.CUSTOM_TRACK]);return t.onSuccess(n.getTrackId()),zy.info("create custom video track success with config",e,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const n=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_SCREEN_VIDEO_TRACK,options:[kA({},e),t]}),i="720p_auto"===e.encoderConfig;e.encoderConfig?"string"==typeof e.encoderConfig||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const r=function(e){const t={};e.screenSourceType&&(t.mediaSource=e.screenSourceType),e.extensionId&&Sg()&&(t.extensionId=e.extensionId);const{displaySurface:n,selfBrowserSurface:i,surfaceSwitching:r,systemAudio:o}=e;(Rg(107)||Cg(107)||bg(93))&&(n&&(jg(n,"displaySurface",["browser","window","monitor"]),t.displaySurface=n),i?(jg(i,"selfBrowserSurface",["exclude","include"]),t.selfBrowserSurface=i):t.selfBrowserSurface="include",r&&(jg(r,"surfaceSwitching",["exclude","include"]),t.surfaceSwitching=r)),(Rg(105)||Cg(105)||bg(91))&&o&&(jg(o,"systemAudio",["exclude","include"]),t.systemAudio=o),e.electronScreenSourceId&&(t.sourceId=e.electronScreenSourceId);const s=e.encoderConfig?FI(e.encoderConfig):null;return t.mandatory={chromeMediaSource:"desktop",maxWidth:s?s.width:void 0,maxHeight:s?s.height:void 0},s&&(s.frameRate&&("number"==typeof s.frameRate?(t.mandatory.maxFrameRate=s.frameRate,t.mandatory.minFrameRate=s.frameRate):(t.mandatory.maxFrameRate=s.frameRate.max||s.frameRate.ideal||s.frameRate.exact||void 0,t.mandatory.minFrameRate=s.frameRate.min||s.frameRate.ideal||s.frameRate.exact||void 0),t.frameRate=s.frameRate),s.width&&(t.width=s.width),s.height&&(t.height=s.height)),t}(e),o=xS(8,"track-scr-v-");let s=null,a=null;const c=AI();if(!c.supportShareAudio&&"enable"===t){const e=new Vg(xg.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return n.onError(e),e.throw(zy)}zy.info("start create screen video track with config",e,"withAudio",t,"trackId",o);try{const e=await Mw({screen:r,screenAudio:"auto"===t?c.supportShareAudio:"enable"===t},o);s=e.getVideoTracks()[0]||null,a=e.getAudioTracks()[0]||null}catch(e){throw n.onError(e),e}if(!s){const e=new Vg(xg.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(e),e.throw(zy)}if(!a&&"enable"===t){s&&s.stop();const e=new Vg(xg.SHARE_AUDIO_NOT_ALLOWED);return n.onError(e),e.throw(zy)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(LA(o,s,e,e.encoderConfig&&FI(e.encoderConfig)||void 0),e.encoderConfig&&"string"!=typeof e.encoderConfig&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const d=new NA(s,e.encoderConfig?FI(e.encoderConfig):{},e.scalabiltyMode?jI(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,o,[zI.SCREEN_TRACK]);if(i&&d.startMonitorStats(),!a)return n.onSuccess(d.getTrackId()),zy.info("create screen video track success","video:",d.getTrackId()),d;const l=new cA(a,void 0,xS(8,"track-scr-a-"),!1,!0);return n.onSuccess([d.getTrackId(),l.getTrackId()]),zy.info("create screen video track success","video:",d.getTrackId(),"audio:",l.getTrackId()),[d,l]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_MIC_AND_CAM_TRACKS,options:[e,t]}),i="720p_auto"===t.encoderConfig,r=hA(t),o=pA(e),s=xS(8,"track-mic-"),a=xS(8,"track-cam-");let c=null,d=null;zy.info("start create camera video track(".concat(a,") and microphone audio track(").concat(s,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const e=await Mw({audio:o,video:r},"".concat(s,"-").concat(a));c=e.getAudioTracks()[0],d=e.getVideoTracks()[0]}catch(e){throw n.onError(e),e}if(!c||!d){const e=new Vg(xg.UNEXPECTED_ERROR,"can not find tracks in media stream");return n.onError(e),e.throw(zy)}t.optimizationMode&&LA(a,d,t,VI(t.encoderConfig));const l=new dA(c,e,o,s),u=new DA(d,t,r,t.scalabiltyMode?jI(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,a);return i&&u.startMonitorStats(),n.onSuccess([l.getTrackId(),u.getTrackId()]),zy.info("create camera video track(".concat(a,") and microphone audio track(").concat(s,") success")),[l,u]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_MIC_AUDIO_TRACK,options:[e]}),n=pA(e),i=xS(8,"track-mic-");let r=null;zy.info("start create microphone audio track with config",JSON.stringify(e),"trackId",i);try{r=(await Mw({audio:n},i)).getAudioTracks()[0]||null}catch(e){throw t.onError(e),e}if(!r){const e=new Vg(xg.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(e),e.throw(zy)}const o=new dA(r,e,n,i);return t.onSuccess(o.getTrackId()),zy.info("create microphone audio track success, trackId:",i),o},createCustomAudioTrack:function(e){const t=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),n=new cA(e.mediaStreamTrack,e.encoderConfig?GI(e.encoderConfig):{},xS(8,"track-cus-"),!1,!0);return zy.info("create custom audio track success with config",e,"trackId",n.getTrackId()),t.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:n,encoderConfig:i}=e;let{source:r}=e;const o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?null!==(t=File.name)&&void 0!==t?t:"File":r,cacheOnlineFile:n,encoderConfig:i},s=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(Dy("DISABLE_WEBAUDIO"))throw new Vg(xg.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const a=xS(8,"track-buf-");zy.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",a);const c=r;if(!(r instanceof AudioBuffer))try{r=await mA(r,n)}catch(e){return s.onError(e),e.throw(zy)}const d=new fA(r),l=new lA(c,d,i?GI(i):{},a);return zy.info("create buffer source audio track success, trackId:",a),s.onSuccess(l.getTrackId()),l},setAppType:function(e){if(zy.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw zy.debug("Invalid appType"),new VR(xg.INVALID_PARAMS,"invalid app type",e);Ny("APP_TYPE",Math.floor(e))},setLogLevel:function(e){zy.setLogLevel(e)},enableLogUpload:function(){Dy("USE_NEW_LOG")?Ny("UPLOAD_LOG",!0):zy.enableLogUpload()},disableLogUpload:function(){Dy("USE_NEW_LOG")?Ny("UPLOAD_LOG",!1):zy.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new gL},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof cA||e instanceof FA)){const e=new VR(xg.INVALID_TRACK,"the parameter is not a audio track");return n.onError(e),e.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof cA?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let o=r,s=r;const a=Date.now();return new tg((r=>{const c=setInterval((()=>{const d=e.getVolumeLevel();o=d>o?d:o,s=d<s?d:s;const l=o-s>1e-4,u=Date.now()-a;if(l||u>t){clearInterval(c);const t=l,s={duration:u,deviceLabel:i,maxVolumeLevel:o,result:t};zy.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(s))),n.onSuccess(s),r(t)}}),200)}))},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=oR.reportApiInvoke(null,{tag:sS.TRACER,name:oS.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof NA||e instanceof VA)){const e=new VR(xg.INVALID_TRACK,"the parameter is not a video track");return n.onError(e),e.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof NA?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(Tg()||mg())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([r]),o.play();const s=document.createElement("canvas");s.width=160,s.height=120;let a=0,c=0;try{const e=Date.now();a=await function(e,t,n,i){let r,o=0,s=null;return new tg(((a,c)=>{function d(){o>i&&r&&(r(),a(o));const t=n.getContext("2d");if(!t){const e=new VR(xg.UNEXPECTED_ERROR,"can not get canvas 2d context.");return zy.error(e.toString()),void c(e)}t.drawImage(e,0,0,160,120);const d=t.getImageData(0,0,n.width,n.height),l=Math.floor(d.data.length/3);if(s){for(let e=0;e<l;e+=3)if(d.data[e]!==s[e])return o+=1,void(s=d.data);s=d.data}else s=d.data}setTimeout((()=>{r&&(r(),a(o))}),t),r=Cw((()=>{d()}),30)}))}(o,t,s,4),c=Date.now()-e}catch(e){throw n.onError(e),e}RU===cg.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const d=a>4,l={duration:c,changedPicNum:a,deviceLabel:i,result:d};return zy.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),n.onSuccess(l),d},setArea:eI,audioElementPlayCenter:Yw,resumeAudioContext:function(){Yw.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){DU.processExternalMediaAEC(e)},registerExtensions:function(e){const t=Dy("PLUGIN_INFO")||[];e.forEach((e=>{"name"in e&&!Ai(t).call(t,e.name)&&t.push(e.name);const n=e;n.__registered__=!0,n.logger.hookLog=zy.extLog,n.reporter.hookApiInvoke=oR.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach((e=>{n.parameters[e]=Dy(e)}))})),UU("PLUGIN_INFO",t)},ChannelMediaRelayError:$R,ChannelMediaRelayEvent:QR,ChannelMediaRelayState:ZR,RemoteStreamFallbackType:JI,RemoteStreamType:qI,ConnectionDisconnectedReason:cS,AudienceLatencyLevelType:aS,AREAS:oC});return Object.defineProperties(xU,{onAudioAutoplayFailed:{get:()=>Bw.onAudioAutoplayFailed,set:e=>{Bw.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>Bw.onAutoplayFailed,set:e=>{Bw.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>xU._onSecurityPolicyViolation,set(e){xU._onSecurityPolicyViolation=e,MU(e)}},__CLIENT_LIST__:{get:()=>Dy("SHOW_GLOBAL_CLIENT_LIST")?dR:[]}}),Fw.on(dw.CAMERA_DEVICE_CHANGED,(e=>{zy.info("camera device changed",JSON.stringify(e)),xU.onCameraChanged&&xU.onCameraChanged(e),xU.safeEmit(CC.CAMERA_CHANGED,e)})),Fw.on(dw.RECORDING_DEVICE_CHANGED,(e=>{zy.info("microphone device changed",JSON.stringify(e)),xU.onMicrophoneChanged&&xU.onMicrophoneChanged(e),xU.safeEmit(CC.MICROPHONE_CHANGED,e)})),Fw.on(dw.PLAYOUT_DEVICE_CHANGED,(e=>{zy.debug("playout device changed",JSON.stringify(e)),xU.onPlaybackDeviceChanged&&xU.onPlaybackDeviceChanged(e),xU.safeEmit(CC.PLAYBACK_DEVICE_CHANGED,e)})),Yw.onAutoplayFailed=()=>{zy.info("detect audio element autoplay failed"),Bw.onAudioAutoplayFailed&&Bw.onAudioAutoplayFailed()},gw.on("autoplay-failed",(()=>{zy.info("detect webaudio autoplay failed"),Bw.onAudioAutoplayFailed&&Bw.onAudioAutoplayFailed(),xU.safeEmit(CC.AUTOPLAY_FAILED)})),gw.on(OI.STATE_CHANGE,((e,t)=>{zy.info("audio context state changed: ".concat(t," => ").concat(e)),xU.onAudioContextStateChanged&&xU.onAudioContextStateChanged(e,t),xU.safeEmit(CC.AUDIO_CONTEXT_STATE_CHANGED,e,t)})),vS.on(hS.NETWORK_STATE_CHANGE,((e,t)=>{zy.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))})),window&&(window.__ARTC__=xU),xU}()},463:(e,t,n)=>{"use strict";var i=n(791),r=n(296);function o(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=new Set,a={};function c(e,t){d(e,t),d(e+"Capture",t)}function d(e,t){for(a[e]=t,e=0;e<t.length;e++)s.add(t[e])}var l=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),u=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,p={},f={};function _(e,t,n,i,r,o,s){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=i,this.attributeNamespace=r,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=o,this.removeEmptyString=s}var m={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){m[e]=new _(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];m[t]=new _(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){m[e]=new _(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){m[e]=new _(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){m[e]=new _(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){m[e]=new _(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){m[e]=new _(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){m[e]=new _(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){m[e]=new _(e,5,!1,e.toLowerCase(),null,!1,!1)}));var E=/[\-:]([a-z])/g;function g(e){return e[1].toUpperCase()}function S(e,t,n,i){var r=m.hasOwnProperty(t)?m[t]:null;(null!==r?0!==r.type:i||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,n,i){if(null===t||"undefined"===typeof t||function(e,t,n,i){if(null!==n&&0===n.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!i&&(null!==n?!n.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,n,i))return!0;if(i)return!1;if(null!==n)switch(n.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,n,r,i)&&(n=null),i||null===r?function(e){return!!u.call(f,e)||!u.call(p,e)&&(h.test(e)?f[e]=!0:(p[e]=!0,!1))}(t)&&(null===n?e.removeAttribute(t):e.setAttribute(t,""+n)):r.mustUseProperty?e[r.propertyName]=null===n?3!==r.type&&"":n:(t=r.attributeName,i=r.attributeNamespace,null===n?e.removeAttribute(t):(n=3===(r=r.type)||4===r&&!0===n?"":""+n,i?e.setAttributeNS(i,t,n):e.setAttribute(t,n))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(E,g);m[t]=new _(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(E,g);m[t]=new _(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(E,g);m[t]=new _(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){m[e]=new _(e,1,!1,e.toLowerCase(),null,!1,!1)})),m.xlinkHref=new _("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){m[e]=new _(e,1,!1,e.toLowerCase(),null,!0,!0)}));var T=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,v=Symbol.for("react.element"),y=Symbol.for("react.portal"),R=Symbol.for("react.fragment"),C=Symbol.for("react.strict_mode"),b=Symbol.for("react.profiler"),I=Symbol.for("react.provider"),w=Symbol.for("react.context"),A=Symbol.for("react.forward_ref"),O=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),D=Symbol.for("react.memo"),P=Symbol.for("react.lazy");Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode");var k=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker");var L=Symbol.iterator;function M(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=L&&e[L]||e["@@iterator"])?e:null}var U,x=Object.assign;function V(e){if(void 0===U)try{throw Error()}catch(n){var t=n.stack.trim().match(/\n( *(at )?)/);U=t&&t[1]||""}return"\n"+U+e}var F=!1;function j(e,t){if(!e||F)return"";F=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"===typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(d){var i=d}Reflect.construct(e,[],t)}else{try{t.call()}catch(d){i=d}e.call(t.prototype)}else{try{throw Error()}catch(d){i=d}e()}}catch(d){if(d&&i&&"string"===typeof d.stack){for(var r=d.stack.split("\n"),o=i.stack.split("\n"),s=r.length-1,a=o.length-1;1<=s&&0<=a&&r[s]!==o[a];)a--;for(;1<=s&&0<=a;s--,a--)if(r[s]!==o[a]){if(1!==s||1!==a)do{if(s--,0>--a||r[s]!==o[a]){var c="\n"+r[s].replace(" at new "," at ");return e.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",e.displayName)),c}}while(1<=s&&0<=a);break}}}finally{F=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?V(e):""}function B(e){switch(e.tag){case 5:return V(e.type);case 16:return V("Lazy");case 13:return V("Suspense");case 19:return V("SuspenseList");case 0:case 2:case 15:return e=j(e.type,!1);case 11:return e=j(e.type.render,!1);case 1:return e=j(e.type,!0);default:return""}}function G(e){if(null==e)return null;if("function"===typeof e)return e.displayName||e.name||null;if("string"===typeof e)return e;switch(e){case R:return"Fragment";case y:return"Portal";case b:return"Profiler";case C:return"StrictMode";case O:return"Suspense";case N:return"SuspenseList"}if("object"===typeof e)switch(e.$$typeof){case w:return(e.displayName||"Context")+".Consumer";case I:return(e._context.displayName||"Context")+".Provider";case A:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case D:return null!==(t=e.displayName||null)?t:G(e.type)||"Memo";case P:t=e._payload,e=e._init;try{return G(e(t))}catch(n){}}return null}function W(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return G(t);case 8:return t===C?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"===typeof t)return t.displayName||t.name||null;if("string"===typeof t)return t}return null}function H(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function K(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function z(e){e._valueTracker||(e._valueTracker=function(e){var t=K(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),i=""+e[t];if(!e.hasOwnProperty(t)&&"undefined"!==typeof n&&"function"===typeof n.get&&"function"===typeof n.set){var r=n.get,o=n.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return r.call(this)},set:function(e){i=""+e,o.call(this,e)}}),Object.defineProperty(e,t,{enumerable:n.enumerable}),{getValue:function(){return i},setValue:function(e){i=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function Y(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),i="";return e&&(i=K(e)?e.checked?"true":"false":e.value),(e=i)!==n&&(t.setValue(e),!0)}function q(e){if("undefined"===typeof(e=e||("undefined"!==typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function J(e,t){var n=t.checked;return x({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=n?n:e._wrapperState.initialChecked})}function X(e,t){var n=null==t.defaultValue?"":t.defaultValue,i=null!=t.checked?t.checked:t.defaultChecked;n=H(null!=t.value?t.value:n),e._wrapperState={initialChecked:i,initialValue:n,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function Q(e,t){null!=(t=t.checked)&&S(e,"checked",t,!1)}function Z(e,t){Q(e,t);var n=H(t.value),i=t.type;if(null!=n)"number"===i?(0===n&&""===e.value||e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n);else if("submit"===i||"reset"===i)return void e.removeAttribute("value");t.hasOwnProperty("value")?ee(e,t.type,n):t.hasOwnProperty("defaultValue")&&ee(e,t.type,H(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function $(e,t,n){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var i=t.type;if(!("submit"!==i&&"reset"!==i||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,n||t===e.value||(e.value=t),e.defaultValue=t}""!==(n=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==n&&(e.name=n)}function ee(e,t,n){"number"===t&&q(e.ownerDocument)===e||(null==n?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+n&&(e.defaultValue=""+n))}var te=Array.isArray;function ne(e,t,n,i){if(e=e.options,t){t={};for(var r=0;r<n.length;r++)t["$"+n[r]]=!0;for(n=0;n<e.length;n++)r=t.hasOwnProperty("$"+e[n].value),e[n].selected!==r&&(e[n].selected=r),r&&i&&(e[n].defaultSelected=!0)}else{for(n=""+H(n),t=null,r=0;r<e.length;r++){if(e[r].value===n)return e[r].selected=!0,void(i&&(e[r].defaultSelected=!0));null!==t||e[r].disabled||(t=e[r])}null!==t&&(t.selected=!0)}}function ie(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(o(91));return x({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function re(e,t){var n=t.value;if(null==n){if(n=t.children,t=t.defaultValue,null!=n){if(null!=t)throw Error(o(92));if(te(n)){if(1<n.length)throw Error(o(93));n=n[0]}t=n}null==t&&(t=""),n=t}e._wrapperState={initialValue:H(n)}}function oe(e,t){var n=H(t.value),i=H(t.defaultValue);null!=n&&((n=""+n)!==e.value&&(e.value=n),null==t.defaultValue&&e.defaultValue!==n&&(e.defaultValue=n)),null!=i&&(e.defaultValue=""+i)}function se(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function ae(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function ce(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?ae(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var de,le,ue=(le=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((de=de||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=de.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction((function(){return le(e,t)}))}:le);function he(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&3===n.nodeType)return void(n.nodeValue=t)}e.textContent=t}var pe={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},fe=["Webkit","ms","Moz","O"];function _e(e,t,n){return null==t||"boolean"===typeof t||""===t?"":n||"number"!==typeof t||0===t||pe.hasOwnProperty(e)&&pe[e]?(""+t).trim():t+"px"}function me(e,t){for(var n in e=e.style,t)if(t.hasOwnProperty(n)){var i=0===n.indexOf("--"),r=_e(n,t[n],i);"float"===n&&(n="cssFloat"),i?e.setProperty(n,r):e[n]=r}}Object.keys(pe).forEach((function(e){fe.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),pe[t]=pe[e]}))}));var Ee=x({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function ge(e,t){if(t){if(Ee[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(o(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(o(60));if("object"!==typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(o(61))}if(null!=t.style&&"object"!==typeof t.style)throw Error(o(62))}}function Se(e,t){if(-1===e.indexOf("-"))return"string"===typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Te=null;function ve(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var ye=null,Re=null,Ce=null;function be(e){if(e=Sr(e)){if("function"!==typeof ye)throw Error(o(280));var t=e.stateNode;t&&(t=vr(t),ye(e.stateNode,e.type,t))}}function Ie(e){Re?Ce?Ce.push(e):Ce=[e]:Re=e}function we(){if(Re){var e=Re,t=Ce;if(Ce=Re=null,be(e),t)for(e=0;e<t.length;e++)be(t[e])}}function Ae(e,t){return e(t)}function Oe(){}var Ne=!1;function De(e,t,n){if(Ne)return e(t,n);Ne=!0;try{return Ae(e,t,n)}finally{Ne=!1,(null!==Re||null!==Ce)&&(Oe(),we())}}function Pe(e,t){var n=e.stateNode;if(null===n)return null;var i=vr(n);if(null===i)return null;n=i[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(i=!i.disabled)||(i=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!i;break e;default:e=!1}if(e)return null;if(n&&"function"!==typeof n)throw Error(o(231,t,typeof n));return n}var ke=!1;if(l)try{var Le={};Object.defineProperty(Le,"passive",{get:function(){ke=!0}}),window.addEventListener("test",Le,Le),window.removeEventListener("test",Le,Le)}catch(le){ke=!1}function Me(e,t,n,i,r,o,s,a,c){var d=Array.prototype.slice.call(arguments,3);try{t.apply(n,d)}catch(l){this.onError(l)}}var Ue=!1,xe=null,Ve=!1,Fe=null,je={onError:function(e){Ue=!0,xe=e}};function Be(e,t,n,i,r,o,s,a,c){Ue=!1,xe=null,Me.apply(je,arguments)}function Ge(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{0!==(4098&(t=e).flags)&&(n=t.return),e=t.return}while(e)}return 3===t.tag?n:null}function We(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function He(e){if(Ge(e)!==e)throw Error(o(188))}function Ke(e){return null!==(e=function(e){var t=e.alternate;if(!t){if(null===(t=Ge(e)))throw Error(o(188));return t!==e?null:e}for(var n=e,i=t;;){var r=n.return;if(null===r)break;var s=r.alternate;if(null===s){if(null!==(i=r.return)){n=i;continue}break}if(r.child===s.child){for(s=r.child;s;){if(s===n)return He(r),e;if(s===i)return He(r),t;s=s.sibling}throw Error(o(188))}if(n.return!==i.return)n=r,i=s;else{for(var a=!1,c=r.child;c;){if(c===n){a=!0,n=r,i=s;break}if(c===i){a=!0,i=r,n=s;break}c=c.sibling}if(!a){for(c=s.child;c;){if(c===n){a=!0,n=s,i=r;break}if(c===i){a=!0,i=s,n=r;break}c=c.sibling}if(!a)throw Error(o(189))}}if(n.alternate!==i)throw Error(o(190))}if(3!==n.tag)throw Error(o(188));return n.stateNode.current===n?e:t}(e))?ze(e):null}function ze(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=ze(e);if(null!==t)return t;e=e.sibling}return null}var Ye=r.unstable_scheduleCallback,qe=r.unstable_cancelCallback,Je=r.unstable_shouldYield,Xe=r.unstable_requestPaint,Qe=r.unstable_now,Ze=r.unstable_getCurrentPriorityLevel,$e=r.unstable_ImmediatePriority,et=r.unstable_UserBlockingPriority,tt=r.unstable_NormalPriority,nt=r.unstable_LowPriority,it=r.unstable_IdlePriority,rt=null,ot=null;var st=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(at(e)/ct|0)|0},at=Math.log,ct=Math.LN2;var dt=64,lt=4194304;function ut(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function ht(e,t){var n=e.pendingLanes;if(0===n)return 0;var i=0,r=e.suspendedLanes,o=e.pingedLanes,s=268435455&n;if(0!==s){var a=s&~r;0!==a?i=ut(a):0!==(o&=s)&&(i=ut(o))}else 0!==(s=n&~r)?i=ut(s):0!==o&&(i=ut(o));if(0===i)return 0;if(0!==t&&t!==i&&0===(t&r)&&((r=i&-i)>=(o=t&-t)||16===r&&0!==(4194240&o)))return t;if(0!==(4&i)&&(i|=16&n),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=i;0<t;)r=1<<(n=31-st(t)),i|=e[n],t&=~r;return i}function pt(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function ft(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function _t(){var e=dt;return 0===(4194240&(dt<<=1))&&(dt=64),e}function mt(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function Et(e,t,n){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-st(t)]=n}function gt(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var i=31-st(n),r=1<<i;r&t|e[i]&t&&(e[i]|=t),n&=~r}}var St=0;function Tt(e){return 1<(e&=-e)?4<e?0!==(268435455&e)?16:536870912:4:1}var vt,yt,Rt,Ct,bt,It=!1,wt=[],At=null,Ot=null,Nt=null,Dt=new Map,Pt=new Map,kt=[],Lt="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Mt(e,t){switch(e){case"focusin":case"focusout":At=null;break;case"dragenter":case"dragleave":Ot=null;break;case"mouseover":case"mouseout":Nt=null;break;case"pointerover":case"pointerout":Dt.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Pt.delete(t.pointerId)}}function Ut(e,t,n,i,r,o){return null===e||e.nativeEvent!==o?(e={blockedOn:t,domEventName:n,eventSystemFlags:i,nativeEvent:o,targetContainers:[r]},null!==t&&(null!==(t=Sr(t))&&yt(t)),e):(e.eventSystemFlags|=i,t=e.targetContainers,null!==r&&-1===t.indexOf(r)&&t.push(r),e)}function xt(e){var t=gr(e.target);if(null!==t){var n=Ge(t);if(null!==n)if(13===(t=n.tag)){if(null!==(t=We(n)))return e.blockedOn=t,void bt(e.priority,(function(){Rt(n)}))}else if(3===t&&n.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===n.tag?n.stateNode.containerInfo:null)}e.blockedOn=null}function Vt(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var n=Jt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==n)return null!==(t=Sr(n))&&yt(t),e.blockedOn=n,!1;var i=new(n=e.nativeEvent).constructor(n.type,n);Te=i,n.target.dispatchEvent(i),Te=null,t.shift()}return!0}function Ft(e,t,n){Vt(e)&&n.delete(t)}function jt(){It=!1,null!==At&&Vt(At)&&(At=null),null!==Ot&&Vt(Ot)&&(Ot=null),null!==Nt&&Vt(Nt)&&(Nt=null),Dt.forEach(Ft),Pt.forEach(Ft)}function Bt(e,t){e.blockedOn===t&&(e.blockedOn=null,It||(It=!0,r.unstable_scheduleCallback(r.unstable_NormalPriority,jt)))}function Gt(e){function t(t){return Bt(t,e)}if(0<wt.length){Bt(wt[0],e);for(var n=1;n<wt.length;n++){var i=wt[n];i.blockedOn===e&&(i.blockedOn=null)}}for(null!==At&&Bt(At,e),null!==Ot&&Bt(Ot,e),null!==Nt&&Bt(Nt,e),Dt.forEach(t),Pt.forEach(t),n=0;n<kt.length;n++)(i=kt[n]).blockedOn===e&&(i.blockedOn=null);for(;0<kt.length&&null===(n=kt[0]).blockedOn;)xt(n),null===n.blockedOn&&kt.shift()}var Wt=T.ReactCurrentBatchConfig,Ht=!0;function Kt(e,t,n,i){var r=St,o=Wt.transition;Wt.transition=null;try{St=1,Yt(e,t,n,i)}finally{St=r,Wt.transition=o}}function zt(e,t,n,i){var r=St,o=Wt.transition;Wt.transition=null;try{St=4,Yt(e,t,n,i)}finally{St=r,Wt.transition=o}}function Yt(e,t,n,i){if(Ht){var r=Jt(e,t,n,i);if(null===r)Hi(e,t,i,qt,n),Mt(e,i);else if(function(e,t,n,i,r){switch(t){case"focusin":return At=Ut(At,e,t,n,i,r),!0;case"dragenter":return Ot=Ut(Ot,e,t,n,i,r),!0;case"mouseover":return Nt=Ut(Nt,e,t,n,i,r),!0;case"pointerover":var o=r.pointerId;return Dt.set(o,Ut(Dt.get(o)||null,e,t,n,i,r)),!0;case"gotpointercapture":return o=r.pointerId,Pt.set(o,Ut(Pt.get(o)||null,e,t,n,i,r)),!0}return!1}(r,e,t,n,i))i.stopPropagation();else if(Mt(e,i),4&t&&-1<Lt.indexOf(e)){for(;null!==r;){var o=Sr(r);if(null!==o&&vt(o),null===(o=Jt(e,t,n,i))&&Hi(e,t,i,qt,n),o===r)break;r=o}null!==r&&i.stopPropagation()}else Hi(e,t,i,null,n)}}var qt=null;function Jt(e,t,n,i){if(qt=null,null!==(e=gr(e=ve(i))))if(null===(t=Ge(e)))e=null;else if(13===(n=t.tag)){if(null!==(e=We(t)))return e;e=null}else if(3===n){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return qt=e,null}function Xt(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Ze()){case $e:return 1;case et:return 4;case tt:case nt:return 16;case it:return 536870912;default:return 16}default:return 16}}var Qt=null,Zt=null,$t=null;function en(){if($t)return $t;var e,t,n=Zt,i=n.length,r="value"in Qt?Qt.value:Qt.textContent,o=r.length;for(e=0;e<i&&n[e]===r[e];e++);var s=i-e;for(t=1;t<=s&&n[i-t]===r[o-t];t++);return $t=r.slice(e,1<t?1-t:void 0)}function tn(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function nn(){return!0}function rn(){return!1}function on(e){function t(t,n,i,r,o){for(var s in this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=r,this.target=o,this.currentTarget=null,e)e.hasOwnProperty(s)&&(t=e[s],this[s]=t?t(r):r[s]);return this.isDefaultPrevented=(null!=r.defaultPrevented?r.defaultPrevented:!1===r.returnValue)?nn:rn,this.isPropagationStopped=rn,this}return x(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!==typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=nn)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!==typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=nn)},persist:function(){},isPersistent:nn}),t}var sn,an,cn,dn={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},ln=on(dn),un=x({},dn,{view:0,detail:0}),hn=on(un),pn=x({},un,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:bn,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==cn&&(cn&&"mousemove"===e.type?(sn=e.screenX-cn.screenX,an=e.screenY-cn.screenY):an=sn=0,cn=e),sn)},movementY:function(e){return"movementY"in e?e.movementY:an}}),fn=on(pn),_n=on(x({},pn,{dataTransfer:0})),mn=on(x({},un,{relatedTarget:0})),En=on(x({},dn,{animationName:0,elapsedTime:0,pseudoElement:0})),gn=x({},dn,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),Sn=on(gn),Tn=on(x({},dn,{data:0})),vn={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},yn={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Rn={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Cn(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=Rn[e])&&!!t[e]}function bn(){return Cn}var In=x({},un,{key:function(e){if(e.key){var t=vn[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=tn(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?yn[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:bn,charCode:function(e){return"keypress"===e.type?tn(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?tn(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),wn=on(In),An=on(x({},pn,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),On=on(x({},un,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:bn})),Nn=on(x({},dn,{propertyName:0,elapsedTime:0,pseudoElement:0})),Dn=x({},pn,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),Pn=on(Dn),kn=[9,13,27,32],Ln=l&&"CompositionEvent"in window,Mn=null;l&&"documentMode"in document&&(Mn=document.documentMode);var Un=l&&"TextEvent"in window&&!Mn,xn=l&&(!Ln||Mn&&8<Mn&&11>=Mn),Vn=String.fromCharCode(32),Fn=!1;function jn(e,t){switch(e){case"keyup":return-1!==kn.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Bn(e){return"object"===typeof(e=e.detail)&&"data"in e?e.data:null}var Gn=!1;var Wn={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Hn(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Wn[e.type]:"textarea"===t}function Kn(e,t,n,i){Ie(i),0<(t=zi(t,"onChange")).length&&(n=new ln("onChange","change",null,n,i),e.push({event:n,listeners:t}))}var zn=null,Yn=null;function qn(e){Vi(e,0)}function Jn(e){if(Y(Tr(e)))return e}function Xn(e,t){if("change"===e)return t}var Qn=!1;if(l){var Zn;if(l){var $n="oninput"in document;if(!$n){var ei=document.createElement("div");ei.setAttribute("oninput","return;"),$n="function"===typeof ei.oninput}Zn=$n}else Zn=!1;Qn=Zn&&(!document.documentMode||9<document.documentMode)}function ti(){zn&&(zn.detachEvent("onpropertychange",ni),Yn=zn=null)}function ni(e){if("value"===e.propertyName&&Jn(Yn)){var t=[];Kn(t,Yn,e,ve(e)),De(qn,t)}}function ii(e,t,n){"focusin"===e?(ti(),Yn=n,(zn=t).attachEvent("onpropertychange",ni)):"focusout"===e&&ti()}function ri(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Jn(Yn)}function oi(e,t){if("click"===e)return Jn(t)}function si(e,t){if("input"===e||"change"===e)return Jn(t)}var ai="function"===typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e===1/t)||e!==e&&t!==t};function ci(e,t){if(ai(e,t))return!0;if("object"!==typeof e||null===e||"object"!==typeof t||null===t)return!1;var n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(i=0;i<n.length;i++){var r=n[i];if(!u.call(t,r)||!ai(e[r],t[r]))return!1}return!0}function di(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function li(e,t){var n,i=di(e);for(e=0;i;){if(3===i.nodeType){if(n=e+i.textContent.length,e<=t&&n>=t)return{node:i,offset:t-e};e=n}e:{for(;i;){if(i.nextSibling){i=i.nextSibling;break e}i=i.parentNode}i=void 0}i=di(i)}}function ui(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?ui(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function hi(){for(var e=window,t=q();t instanceof e.HTMLIFrameElement;){try{var n="string"===typeof t.contentWindow.location.href}catch(i){n=!1}if(!n)break;t=q((e=t.contentWindow).document)}return t}function pi(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function fi(e){var t=hi(),n=e.focusedElem,i=e.selectionRange;if(t!==n&&n&&n.ownerDocument&&ui(n.ownerDocument.documentElement,n)){if(null!==i&&pi(n))if(t=i.start,void 0===(e=i.end)&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if((e=(t=n.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var r=n.textContent.length,o=Math.min(i.start,r);i=void 0===i.end?o:Math.min(i.end,r),!e.extend&&o>i&&(r=i,i=o,o=r),r=li(n,o);var s=li(n,i);r&&s&&(1!==e.rangeCount||e.anchorNode!==r.node||e.anchorOffset!==r.offset||e.focusNode!==s.node||e.focusOffset!==s.offset)&&((t=t.createRange()).setStart(r.node,r.offset),e.removeAllRanges(),o>i?(e.addRange(t),e.extend(s.node,s.offset)):(t.setEnd(s.node,s.offset),e.addRange(t)))}for(t=[],e=n;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"===typeof n.focus&&n.focus(),n=0;n<t.length;n++)(e=t[n]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var _i=l&&"documentMode"in document&&11>=document.documentMode,mi=null,Ei=null,gi=null,Si=!1;function Ti(e,t,n){var i=n.window===n?n.document:9===n.nodeType?n:n.ownerDocument;Si||null==mi||mi!==q(i)||("selectionStart"in(i=mi)&&pi(i)?i={start:i.selectionStart,end:i.selectionEnd}:i={anchorNode:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset},gi&&ci(gi,i)||(gi=i,0<(i=zi(Ei,"onSelect")).length&&(t=new ln("onSelect","select",null,t,n),e.push({event:t,listeners:i}),t.target=mi)))}function vi(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n}var yi={animationend:vi("Animation","AnimationEnd"),animationiteration:vi("Animation","AnimationIteration"),animationstart:vi("Animation","AnimationStart"),transitionend:vi("Transition","TransitionEnd")},Ri={},Ci={};function bi(e){if(Ri[e])return Ri[e];if(!yi[e])return e;var t,n=yi[e];for(t in n)if(n.hasOwnProperty(t)&&t in Ci)return Ri[e]=n[t];return e}l&&(Ci=document.createElement("div").style,"AnimationEvent"in window||(delete yi.animationend.animation,delete yi.animationiteration.animation,delete yi.animationstart.animation),"TransitionEvent"in window||delete yi.transitionend.transition);var Ii=bi("animationend"),wi=bi("animationiteration"),Ai=bi("animationstart"),Oi=bi("transitionend"),Ni=new Map,Di="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Pi(e,t){Ni.set(e,t),c(t,[e])}for(var ki=0;ki<Di.length;ki++){var Li=Di[ki];Pi(Li.toLowerCase(),"on"+(Li[0].toUpperCase()+Li.slice(1)))}Pi(Ii,"onAnimationEnd"),Pi(wi,"onAnimationIteration"),Pi(Ai,"onAnimationStart"),Pi("dblclick","onDoubleClick"),Pi("focusin","onFocus"),Pi("focusout","onBlur"),Pi(Oi,"onTransitionEnd"),d("onMouseEnter",["mouseout","mouseover"]),d("onMouseLeave",["mouseout","mouseover"]),d("onPointerEnter",["pointerout","pointerover"]),d("onPointerLeave",["pointerout","pointerover"]),c("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),c("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),c("onBeforeInput",["compositionend","keypress","textInput","paste"]),c("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),c("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),c("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Mi="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Ui=new Set("cancel close invalid load scroll toggle".split(" ").concat(Mi));function xi(e,t,n){var i=e.type||"unknown-event";e.currentTarget=n,function(e,t,n,i,r,s,a,c,d){if(Be.apply(this,arguments),Ue){if(!Ue)throw Error(o(198));var l=xe;Ue=!1,xe=null,Ve||(Ve=!0,Fe=l)}}(i,t,void 0,e),e.currentTarget=null}function Vi(e,t){t=0!==(4&t);for(var n=0;n<e.length;n++){var i=e[n],r=i.event;i=i.listeners;e:{var o=void 0;if(t)for(var s=i.length-1;0<=s;s--){var a=i[s],c=a.instance,d=a.currentTarget;if(a=a.listener,c!==o&&r.isPropagationStopped())break e;xi(r,a,d),o=c}else for(s=0;s<i.length;s++){if(c=(a=i[s]).instance,d=a.currentTarget,a=a.listener,c!==o&&r.isPropagationStopped())break e;xi(r,a,d),o=c}}}if(Ve)throw e=Fe,Ve=!1,Fe=null,e}function Fi(e,t){var n=t[_r];void 0===n&&(n=t[_r]=new Set);var i=e+"__bubble";n.has(i)||(Wi(t,e,2,!1),n.add(i))}function ji(e,t,n){var i=0;t&&(i|=4),Wi(n,e,i,t)}var Bi="_reactListening"+Math.random().toString(36).slice(2);function Gi(e){if(!e[Bi]){e[Bi]=!0,s.forEach((function(t){"selectionchange"!==t&&(Ui.has(t)||ji(t,!1,e),ji(t,!0,e))}));var t=9===e.nodeType?e:e.ownerDocument;null===t||t[Bi]||(t[Bi]=!0,ji("selectionchange",!1,t))}}function Wi(e,t,n,i){switch(Xt(t)){case 1:var r=Kt;break;case 4:r=zt;break;default:r=Yt}n=r.bind(null,t,n,e),r=void 0,!ke||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(r=!0),i?void 0!==r?e.addEventListener(t,n,{capture:!0,passive:r}):e.addEventListener(t,n,!0):void 0!==r?e.addEventListener(t,n,{passive:r}):e.addEventListener(t,n,!1)}function Hi(e,t,n,i,r){var o=i;if(0===(1&t)&&0===(2&t)&&null!==i)e:for(;;){if(null===i)return;var s=i.tag;if(3===s||4===s){var a=i.stateNode.containerInfo;if(a===r||8===a.nodeType&&a.parentNode===r)break;if(4===s)for(s=i.return;null!==s;){var c=s.tag;if((3===c||4===c)&&((c=s.stateNode.containerInfo)===r||8===c.nodeType&&c.parentNode===r))return;s=s.return}for(;null!==a;){if(null===(s=gr(a)))return;if(5===(c=s.tag)||6===c){i=o=s;continue e}a=a.parentNode}}i=i.return}De((function(){var i=o,r=ve(n),s=[];e:{var a=Ni.get(e);if(void 0!==a){var c=ln,d=e;switch(e){case"keypress":if(0===tn(n))break e;case"keydown":case"keyup":c=wn;break;case"focusin":d="focus",c=mn;break;case"focusout":d="blur",c=mn;break;case"beforeblur":case"afterblur":c=mn;break;case"click":if(2===n.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":c=fn;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":c=_n;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":c=On;break;case Ii:case wi:case Ai:c=En;break;case Oi:c=Nn;break;case"scroll":c=hn;break;case"wheel":c=Pn;break;case"copy":case"cut":case"paste":c=Sn;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":c=An}var l=0!==(4&t),u=!l&&"scroll"===e,h=l?null!==a?a+"Capture":null:a;l=[];for(var p,f=i;null!==f;){var _=(p=f).stateNode;if(5===p.tag&&null!==_&&(p=_,null!==h&&(null!=(_=Pe(f,h))&&l.push(Ki(f,_,p)))),u)break;f=f.return}0<l.length&&(a=new c(a,d,null,n,r),s.push({event:a,listeners:l}))}}if(0===(7&t)){if(c="mouseout"===e||"pointerout"===e,(!(a="mouseover"===e||"pointerover"===e)||n===Te||!(d=n.relatedTarget||n.fromElement)||!gr(d)&&!d[fr])&&(c||a)&&(a=r.window===r?r:(a=r.ownerDocument)?a.defaultView||a.parentWindow:window,c?(c=i,null!==(d=(d=n.relatedTarget||n.toElement)?gr(d):null)&&(d!==(u=Ge(d))||5!==d.tag&&6!==d.tag)&&(d=null)):(c=null,d=i),c!==d)){if(l=fn,_="onMouseLeave",h="onMouseEnter",f="mouse","pointerout"!==e&&"pointerover"!==e||(l=An,_="onPointerLeave",h="onPointerEnter",f="pointer"),u=null==c?a:Tr(c),p=null==d?a:Tr(d),(a=new l(_,f+"leave",c,n,r)).target=u,a.relatedTarget=p,_=null,gr(r)===i&&((l=new l(h,f+"enter",d,n,r)).target=p,l.relatedTarget=u,_=l),u=_,c&&d)e:{for(h=d,f=0,p=l=c;p;p=Yi(p))f++;for(p=0,_=h;_;_=Yi(_))p++;for(;0<f-p;)l=Yi(l),f--;for(;0<p-f;)h=Yi(h),p--;for(;f--;){if(l===h||null!==h&&l===h.alternate)break e;l=Yi(l),h=Yi(h)}l=null}else l=null;null!==c&&qi(s,a,c,l,!1),null!==d&&null!==u&&qi(s,u,d,l,!0)}if("select"===(c=(a=i?Tr(i):window).nodeName&&a.nodeName.toLowerCase())||"input"===c&&"file"===a.type)var m=Xn;else if(Hn(a))if(Qn)m=si;else{m=ri;var E=ii}else(c=a.nodeName)&&"input"===c.toLowerCase()&&("checkbox"===a.type||"radio"===a.type)&&(m=oi);switch(m&&(m=m(e,i))?Kn(s,m,n,r):(E&&E(e,a,i),"focusout"===e&&(E=a._wrapperState)&&E.controlled&&"number"===a.type&&ee(a,"number",a.value)),E=i?Tr(i):window,e){case"focusin":(Hn(E)||"true"===E.contentEditable)&&(mi=E,Ei=i,gi=null);break;case"focusout":gi=Ei=mi=null;break;case"mousedown":Si=!0;break;case"contextmenu":case"mouseup":case"dragend":Si=!1,Ti(s,n,r);break;case"selectionchange":if(_i)break;case"keydown":case"keyup":Ti(s,n,r)}var g;if(Ln)e:{switch(e){case"compositionstart":var S="onCompositionStart";break e;case"compositionend":S="onCompositionEnd";break e;case"compositionupdate":S="onCompositionUpdate";break e}S=void 0}else Gn?jn(e,n)&&(S="onCompositionEnd"):"keydown"===e&&229===n.keyCode&&(S="onCompositionStart");S&&(xn&&"ko"!==n.locale&&(Gn||"onCompositionStart"!==S?"onCompositionEnd"===S&&Gn&&(g=en()):(Zt="value"in(Qt=r)?Qt.value:Qt.textContent,Gn=!0)),0<(E=zi(i,S)).length&&(S=new Tn(S,e,null,n,r),s.push({event:S,listeners:E}),g?S.data=g:null!==(g=Bn(n))&&(S.data=g))),(g=Un?function(e,t){switch(e){case"compositionend":return Bn(t);case"keypress":return 32!==t.which?null:(Fn=!0,Vn);case"textInput":return(e=t.data)===Vn&&Fn?null:e;default:return null}}(e,n):function(e,t){if(Gn)return"compositionend"===e||!Ln&&jn(e,t)?(e=en(),$t=Zt=Qt=null,Gn=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return xn&&"ko"!==t.locale?null:t.data}}(e,n))&&(0<(i=zi(i,"onBeforeInput")).length&&(r=new Tn("onBeforeInput","beforeinput",null,n,r),s.push({event:r,listeners:i}),r.data=g))}Vi(s,t)}))}function Ki(e,t,n){return{instance:e,listener:t,currentTarget:n}}function zi(e,t){for(var n=t+"Capture",i=[];null!==e;){var r=e,o=r.stateNode;5===r.tag&&null!==o&&(r=o,null!=(o=Pe(e,n))&&i.unshift(Ki(e,o,r)),null!=(o=Pe(e,t))&&i.push(Ki(e,o,r))),e=e.return}return i}function Yi(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function qi(e,t,n,i,r){for(var o=t._reactName,s=[];null!==n&&n!==i;){var a=n,c=a.alternate,d=a.stateNode;if(null!==c&&c===i)break;5===a.tag&&null!==d&&(a=d,r?null!=(c=Pe(n,o))&&s.unshift(Ki(n,c,a)):r||null!=(c=Pe(n,o))&&s.push(Ki(n,c,a))),n=n.return}0!==s.length&&e.push({event:t,listeners:s})}var Ji=/\r\n?/g,Xi=/\u0000|\uFFFD/g;function Qi(e){return("string"===typeof e?e:""+e).replace(Ji,"\n").replace(Xi,"")}function Zi(e,t,n){if(t=Qi(t),Qi(e)!==t&&n)throw Error(o(425))}function $i(){}var er=null,tr=null;function nr(e,t){return"textarea"===e||"noscript"===e||"string"===typeof t.children||"number"===typeof t.children||"object"===typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var ir="function"===typeof setTimeout?setTimeout:void 0,rr="function"===typeof clearTimeout?clearTimeout:void 0,or="function"===typeof Promise?Promise:void 0,sr="function"===typeof queueMicrotask?queueMicrotask:"undefined"!==typeof or?function(e){return or.resolve(null).then(e).catch(ar)}:ir;function ar(e){setTimeout((function(){throw e}))}function cr(e,t){var n=t,i=0;do{var r=n.nextSibling;if(e.removeChild(n),r&&8===r.nodeType)if("/$"===(n=r.data)){if(0===i)return e.removeChild(r),void Gt(t);i--}else"$"!==n&&"$?"!==n&&"$!"!==n||i++;n=r}while(n);Gt(t)}function dr(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function lr(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var n=e.data;if("$"===n||"$!"===n||"$?"===n){if(0===t)return e;t--}else"/$"===n&&t++}e=e.previousSibling}return null}var ur=Math.random().toString(36).slice(2),hr="__reactFiber$"+ur,pr="__reactProps$"+ur,fr="__reactContainer$"+ur,_r="__reactEvents$"+ur,mr="__reactListeners$"+ur,Er="__reactHandles$"+ur;function gr(e){var t=e[hr];if(t)return t;for(var n=e.parentNode;n;){if(t=n[fr]||n[hr]){if(n=t.alternate,null!==t.child||null!==n&&null!==n.child)for(e=lr(e);null!==e;){if(n=e[hr])return n;e=lr(e)}return t}n=(e=n).parentNode}return null}function Sr(e){return!(e=e[hr]||e[fr])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function Tr(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(o(33))}function vr(e){return e[pr]||null}var yr=[],Rr=-1;function Cr(e){return{current:e}}function br(e){0>Rr||(e.current=yr[Rr],yr[Rr]=null,Rr--)}function Ir(e,t){Rr++,yr[Rr]=e.current,e.current=t}var wr={},Ar=Cr(wr),Or=Cr(!1),Nr=wr;function Dr(e,t){var n=e.type.contextTypes;if(!n)return wr;var i=e.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===t)return i.__reactInternalMemoizedMaskedChildContext;var r,o={};for(r in n)o[r]=t[r];return i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=o),o}function Pr(e){return null!==(e=e.childContextTypes)&&void 0!==e}function kr(){br(Or),br(Ar)}function Lr(e,t,n){if(Ar.current!==wr)throw Error(o(168));Ir(Ar,t),Ir(Or,n)}function Mr(e,t,n){var i=e.stateNode;if(t=t.childContextTypes,"function"!==typeof i.getChildContext)return n;for(var r in i=i.getChildContext())if(!(r in t))throw Error(o(108,W(e)||"Unknown",r));return x({},n,i)}function Ur(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||wr,Nr=Ar.current,Ir(Ar,e),Ir(Or,Or.current),!0}function xr(e,t,n){var i=e.stateNode;if(!i)throw Error(o(169));n?(e=Mr(e,t,Nr),i.__reactInternalMemoizedMergedChildContext=e,br(Or),br(Ar),Ir(Ar,e)):br(Or),Ir(Or,n)}var Vr=null,Fr=!1,jr=!1;function Br(e){null===Vr?Vr=[e]:Vr.push(e)}function Gr(){if(!jr&&null!==Vr){jr=!0;var e=0,t=St;try{var n=Vr;for(St=1;e<n.length;e++){var i=n[e];do{i=i(!0)}while(null!==i)}Vr=null,Fr=!1}catch(r){throw null!==Vr&&(Vr=Vr.slice(e+1)),Ye($e,Gr),r}finally{St=t,jr=!1}}return null}var Wr=[],Hr=0,Kr=null,zr=0,Yr=[],qr=0,Jr=null,Xr=1,Qr="";function Zr(e,t){Wr[Hr++]=zr,Wr[Hr++]=Kr,Kr=e,zr=t}function $r(e,t,n){Yr[qr++]=Xr,Yr[qr++]=Qr,Yr[qr++]=Jr,Jr=e;var i=Xr;e=Qr;var r=32-st(i)-1;i&=~(1<<r),n+=1;var o=32-st(t)+r;if(30<o){var s=r-r%5;o=(i&(1<<s)-1).toString(32),i>>=s,r-=s,Xr=1<<32-st(t)+r|n<<r|i,Qr=o+e}else Xr=1<<o|n<<r|i,Qr=e}function eo(e){null!==e.return&&(Zr(e,1),$r(e,1,0))}function to(e){for(;e===Kr;)Kr=Wr[--Hr],Wr[Hr]=null,zr=Wr[--Hr],Wr[Hr]=null;for(;e===Jr;)Jr=Yr[--qr],Yr[qr]=null,Qr=Yr[--qr],Yr[qr]=null,Xr=Yr[--qr],Yr[qr]=null}var no=null,io=null,ro=!1,oo=null;function so(e,t){var n=Pd(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,null===(t=e.deletions)?(e.deletions=[n],e.flags|=16):t.push(n)}function ao(e,t){switch(e.tag){case 5:var n=e.type;return null!==(t=1!==t.nodeType||n.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,no=e,io=dr(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,no=e,io=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(n=null!==Jr?{id:Xr,overflow:Qr}:null,e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},(n=Pd(18,null,null,0)).stateNode=t,n.return=e,e.child=n,no=e,io=null,!0);default:return!1}}function co(e){return 0!==(1&e.mode)&&0===(128&e.flags)}function lo(e){if(ro){var t=io;if(t){var n=t;if(!ao(e,t)){if(co(e))throw Error(o(418));t=dr(n.nextSibling);var i=no;t&&ao(e,t)?so(i,n):(e.flags=-4097&e.flags|2,ro=!1,no=e)}}else{if(co(e))throw Error(o(418));e.flags=-4097&e.flags|2,ro=!1,no=e}}}function uo(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;no=e}function ho(e){if(e!==no)return!1;if(!ro)return uo(e),ro=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!nr(e.type,e.memoizedProps)),t&&(t=io)){if(co(e))throw po(),Error(o(418));for(;t;)so(e,t),t=dr(t.nextSibling)}if(uo(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(o(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var n=e.data;if("/$"===n){if(0===t){io=dr(e.nextSibling);break e}t--}else"$"!==n&&"$!"!==n&&"$?"!==n||t++}e=e.nextSibling}io=null}}else io=no?dr(e.stateNode.nextSibling):null;return!0}function po(){for(var e=io;e;)e=dr(e.nextSibling)}function fo(){io=no=null,ro=!1}function _o(e){null===oo?oo=[e]:oo.push(e)}var mo=T.ReactCurrentBatchConfig;function Eo(e,t){if(e&&e.defaultProps){for(var n in t=x({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}var go=Cr(null),So=null,To=null,vo=null;function yo(){vo=To=So=null}function Ro(e){var t=go.current;br(go),e._currentValue=t}function Co(e,t,n){for(;null!==e;){var i=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==i&&(i.childLanes|=t)):null!==i&&(i.childLanes&t)!==t&&(i.childLanes|=t),e===n)break;e=e.return}}function bo(e,t){So=e,vo=To=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(Ta=!0),e.firstContext=null)}function Io(e){var t=e._currentValue;if(vo!==e)if(e={context:e,memoizedValue:t,next:null},null===To){if(null===So)throw Error(o(308));To=e,So.dependencies={lanes:0,firstContext:e}}else To=To.next=e;return t}var wo=null;function Ao(e){null===wo?wo=[e]:wo.push(e)}function Oo(e,t,n,i){var r=t.interleaved;return null===r?(n.next=n,Ao(t)):(n.next=r.next,r.next=n),t.interleaved=n,No(e,i)}function No(e,t){e.lanes|=t;var n=e.alternate;for(null!==n&&(n.lanes|=t),n=e,e=e.return;null!==e;)e.childLanes|=t,null!==(n=e.alternate)&&(n.childLanes|=t),n=e,e=e.return;return 3===n.tag?n.stateNode:null}var Do=!1;function Po(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function ko(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Lo(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function Mo(e,t,n){var i=e.updateQueue;if(null===i)return null;if(i=i.shared,0!==(2&Oc)){var r=i.pending;return null===r?t.next=t:(t.next=r.next,r.next=t),i.pending=t,No(e,n)}return null===(r=i.interleaved)?(t.next=t,Ao(i)):(t.next=r.next,r.next=t),i.interleaved=t,No(e,n)}function Uo(e,t,n){if(null!==(t=t.updateQueue)&&(t=t.shared,0!==(4194240&n))){var i=t.lanes;n|=i&=e.pendingLanes,t.lanes=n,gt(e,n)}}function xo(e,t){var n=e.updateQueue,i=e.alternate;if(null!==i&&n===(i=i.updateQueue)){var r=null,o=null;if(null!==(n=n.firstBaseUpdate)){do{var s={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};null===o?r=o=s:o=o.next=s,n=n.next}while(null!==n);null===o?r=o=t:o=o.next=t}else r=o=t;return n={baseState:i.baseState,firstBaseUpdate:r,lastBaseUpdate:o,shared:i.shared,effects:i.effects},void(e.updateQueue=n)}null===(e=n.lastBaseUpdate)?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function Vo(e,t,n,i){var r=e.updateQueue;Do=!1;var o=r.firstBaseUpdate,s=r.lastBaseUpdate,a=r.shared.pending;if(null!==a){r.shared.pending=null;var c=a,d=c.next;c.next=null,null===s?o=d:s.next=d,s=c;var l=e.alternate;null!==l&&((a=(l=l.updateQueue).lastBaseUpdate)!==s&&(null===a?l.firstBaseUpdate=d:a.next=d,l.lastBaseUpdate=c))}if(null!==o){var u=r.baseState;for(s=0,l=d=c=null,a=o;;){var h=a.lane,p=a.eventTime;if((i&h)===h){null!==l&&(l=l.next={eventTime:p,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var f=e,_=a;switch(h=t,p=n,_.tag){case 1:if("function"===typeof(f=_.payload)){u=f.call(p,u,h);break e}u=f;break e;case 3:f.flags=-65537&f.flags|128;case 0:if(null===(h="function"===typeof(f=_.payload)?f.call(p,u,h):f)||void 0===h)break e;u=x({},u,h);break e;case 2:Do=!0}}null!==a.callback&&0!==a.lane&&(e.flags|=64,null===(h=r.effects)?r.effects=[a]:h.push(a))}else p={eventTime:p,lane:h,tag:a.tag,payload:a.payload,callback:a.callback,next:null},null===l?(d=l=p,c=u):l=l.next=p,s|=h;if(null===(a=a.next)){if(null===(a=r.shared.pending))break;a=(h=a).next,h.next=null,r.lastBaseUpdate=h,r.shared.pending=null}}if(null===l&&(c=u),r.baseState=c,r.firstBaseUpdate=d,r.lastBaseUpdate=l,null!==(t=r.shared.interleaved)){r=t;do{s|=r.lane,r=r.next}while(r!==t)}else null===o&&(r.shared.lanes=0);xc|=s,e.lanes=s,e.memoizedState=u}}function Fo(e,t,n){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var i=e[t],r=i.callback;if(null!==r){if(i.callback=null,i=n,"function"!==typeof r)throw Error(o(191,r));r.call(i)}}}var jo=(new i.Component).refs;function Bo(e,t,n,i){n=null===(n=n(i,t=e.memoizedState))||void 0===n?t:x({},t,n),e.memoizedState=n,0===e.lanes&&(e.updateQueue.baseState=n)}var Go={isMounted:function(e){return!!(e=e._reactInternals)&&Ge(e)===e},enqueueSetState:function(e,t,n){e=e._reactInternals;var i=td(),r=nd(e),o=Lo(i,r);o.payload=t,void 0!==n&&null!==n&&(o.callback=n),null!==(t=Mo(e,o,r))&&(id(t,e,r,i),Uo(t,e,r))},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var i=td(),r=nd(e),o=Lo(i,r);o.tag=1,o.payload=t,void 0!==n&&null!==n&&(o.callback=n),null!==(t=Mo(e,o,r))&&(id(t,e,r,i),Uo(t,e,r))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=td(),i=nd(e),r=Lo(n,i);r.tag=2,void 0!==t&&null!==t&&(r.callback=t),null!==(t=Mo(e,r,i))&&(id(t,e,i,n),Uo(t,e,i))}};function Wo(e,t,n,i,r,o,s){return"function"===typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(i,o,s):!t.prototype||!t.prototype.isPureReactComponent||(!ci(n,i)||!ci(r,o))}function Ho(e,t,n){var i=!1,r=wr,o=t.contextType;return"object"===typeof o&&null!==o?o=Io(o):(r=Pr(t)?Nr:Ar.current,o=(i=null!==(i=t.contextTypes)&&void 0!==i)?Dr(e,r):wr),t=new t(n,o),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=Go,e.stateNode=t,t._reactInternals=e,i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=r,e.__reactInternalMemoizedMaskedChildContext=o),t}function Ko(e,t,n,i){e=t.state,"function"===typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,i),"function"===typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,i),t.state!==e&&Go.enqueueReplaceState(t,t.state,null)}function zo(e,t,n,i){var r=e.stateNode;r.props=n,r.state=e.memoizedState,r.refs=jo,Po(e);var o=t.contextType;"object"===typeof o&&null!==o?r.context=Io(o):(o=Pr(t)?Nr:Ar.current,r.context=Dr(e,o)),r.state=e.memoizedState,"function"===typeof(o=t.getDerivedStateFromProps)&&(Bo(e,t,o,n),r.state=e.memoizedState),"function"===typeof t.getDerivedStateFromProps||"function"===typeof r.getSnapshotBeforeUpdate||"function"!==typeof r.UNSAFE_componentWillMount&&"function"!==typeof r.componentWillMount||(t=r.state,"function"===typeof r.componentWillMount&&r.componentWillMount(),"function"===typeof r.UNSAFE_componentWillMount&&r.UNSAFE_componentWillMount(),t!==r.state&&Go.enqueueReplaceState(r,r.state,null),Vo(e,n,r,i),r.state=e.memoizedState),"function"===typeof r.componentDidMount&&(e.flags|=4194308)}function Yo(e,t,n){if(null!==(e=n.ref)&&"function"!==typeof e&&"object"!==typeof e){if(n._owner){if(n=n._owner){if(1!==n.tag)throw Error(o(309));var i=n.stateNode}if(!i)throw Error(o(147,e));var r=i,s=""+e;return null!==t&&null!==t.ref&&"function"===typeof t.ref&&t.ref._stringRef===s?t.ref:(t=function(e){var t=r.refs;t===jo&&(t=r.refs={}),null===e?delete t[s]:t[s]=e},t._stringRef=s,t)}if("string"!==typeof e)throw Error(o(284));if(!n._owner)throw Error(o(290,e))}return e}function qo(e,t){throw e=Object.prototype.toString.call(t),Error(o(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function Jo(e){return(0,e._init)(e._payload)}function Xo(e){function t(t,n){if(e){var i=t.deletions;null===i?(t.deletions=[n],t.flags|=16):i.push(n)}}function n(n,i){if(!e)return null;for(;null!==i;)t(n,i),i=i.sibling;return null}function i(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function r(e,t){return(e=Ld(e,t)).index=0,e.sibling=null,e}function s(t,n,i){return t.index=i,e?null!==(i=t.alternate)?(i=i.index)<n?(t.flags|=2,n):i:(t.flags|=2,n):(t.flags|=1048576,n)}function a(t){return e&&null===t.alternate&&(t.flags|=2),t}function c(e,t,n,i){return null===t||6!==t.tag?((t=Vd(n,e.mode,i)).return=e,t):((t=r(t,n)).return=e,t)}function d(e,t,n,i){var o=n.type;return o===R?u(e,t,n.props.children,i,n.key):null!==t&&(t.elementType===o||"object"===typeof o&&null!==o&&o.$$typeof===P&&Jo(o)===t.type)?((i=r(t,n.props)).ref=Yo(e,t,n),i.return=e,i):((i=Md(n.type,n.key,n.props,null,e.mode,i)).ref=Yo(e,t,n),i.return=e,i)}function l(e,t,n,i){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=Fd(n,e.mode,i)).return=e,t):((t=r(t,n.children||[])).return=e,t)}function u(e,t,n,i,o){return null===t||7!==t.tag?((t=Ud(n,e.mode,i,o)).return=e,t):((t=r(t,n)).return=e,t)}function h(e,t,n){if("string"===typeof t&&""!==t||"number"===typeof t)return(t=Vd(""+t,e.mode,n)).return=e,t;if("object"===typeof t&&null!==t){switch(t.$$typeof){case v:return(n=Md(t.type,t.key,t.props,null,e.mode,n)).ref=Yo(e,null,t),n.return=e,n;case y:return(t=Fd(t,e.mode,n)).return=e,t;case P:return h(e,(0,t._init)(t._payload),n)}if(te(t)||M(t))return(t=Ud(t,e.mode,n,null)).return=e,t;qo(e,t)}return null}function p(e,t,n,i){var r=null!==t?t.key:null;if("string"===typeof n&&""!==n||"number"===typeof n)return null!==r?null:c(e,t,""+n,i);if("object"===typeof n&&null!==n){switch(n.$$typeof){case v:return n.key===r?d(e,t,n,i):null;case y:return n.key===r?l(e,t,n,i):null;case P:return p(e,t,(r=n._init)(n._payload),i)}if(te(n)||M(n))return null!==r?null:u(e,t,n,i,null);qo(e,n)}return null}function f(e,t,n,i,r){if("string"===typeof i&&""!==i||"number"===typeof i)return c(t,e=e.get(n)||null,""+i,r);if("object"===typeof i&&null!==i){switch(i.$$typeof){case v:return d(t,e=e.get(null===i.key?n:i.key)||null,i,r);case y:return l(t,e=e.get(null===i.key?n:i.key)||null,i,r);case P:return f(e,t,n,(0,i._init)(i._payload),r)}if(te(i)||M(i))return u(t,e=e.get(n)||null,i,r,null);qo(t,i)}return null}function _(r,o,a,c){for(var d=null,l=null,u=o,_=o=0,m=null;null!==u&&_<a.length;_++){u.index>_?(m=u,u=null):m=u.sibling;var E=p(r,u,a[_],c);if(null===E){null===u&&(u=m);break}e&&u&&null===E.alternate&&t(r,u),o=s(E,o,_),null===l?d=E:l.sibling=E,l=E,u=m}if(_===a.length)return n(r,u),ro&&Zr(r,_),d;if(null===u){for(;_<a.length;_++)null!==(u=h(r,a[_],c))&&(o=s(u,o,_),null===l?d=u:l.sibling=u,l=u);return ro&&Zr(r,_),d}for(u=i(r,u);_<a.length;_++)null!==(m=f(u,r,_,a[_],c))&&(e&&null!==m.alternate&&u.delete(null===m.key?_:m.key),o=s(m,o,_),null===l?d=m:l.sibling=m,l=m);return e&&u.forEach((function(e){return t(r,e)})),ro&&Zr(r,_),d}function m(r,a,c,d){var l=M(c);if("function"!==typeof l)throw Error(o(150));if(null==(c=l.call(c)))throw Error(o(151));for(var u=l=null,_=a,m=a=0,E=null,g=c.next();null!==_&&!g.done;m++,g=c.next()){_.index>m?(E=_,_=null):E=_.sibling;var S=p(r,_,g.value,d);if(null===S){null===_&&(_=E);break}e&&_&&null===S.alternate&&t(r,_),a=s(S,a,m),null===u?l=S:u.sibling=S,u=S,_=E}if(g.done)return n(r,_),ro&&Zr(r,m),l;if(null===_){for(;!g.done;m++,g=c.next())null!==(g=h(r,g.value,d))&&(a=s(g,a,m),null===u?l=g:u.sibling=g,u=g);return ro&&Zr(r,m),l}for(_=i(r,_);!g.done;m++,g=c.next())null!==(g=f(_,r,m,g.value,d))&&(e&&null!==g.alternate&&_.delete(null===g.key?m:g.key),a=s(g,a,m),null===u?l=g:u.sibling=g,u=g);return e&&_.forEach((function(e){return t(r,e)})),ro&&Zr(r,m),l}return function e(i,o,s,c){if("object"===typeof s&&null!==s&&s.type===R&&null===s.key&&(s=s.props.children),"object"===typeof s&&null!==s){switch(s.$$typeof){case v:e:{for(var d=s.key,l=o;null!==l;){if(l.key===d){if((d=s.type)===R){if(7===l.tag){n(i,l.sibling),(o=r(l,s.props.children)).return=i,i=o;break e}}else if(l.elementType===d||"object"===typeof d&&null!==d&&d.$$typeof===P&&Jo(d)===l.type){n(i,l.sibling),(o=r(l,s.props)).ref=Yo(i,l,s),o.return=i,i=o;break e}n(i,l);break}t(i,l),l=l.sibling}s.type===R?((o=Ud(s.props.children,i.mode,c,s.key)).return=i,i=o):((c=Md(s.type,s.key,s.props,null,i.mode,c)).ref=Yo(i,o,s),c.return=i,i=c)}return a(i);case y:e:{for(l=s.key;null!==o;){if(o.key===l){if(4===o.tag&&o.stateNode.containerInfo===s.containerInfo&&o.stateNode.implementation===s.implementation){n(i,o.sibling),(o=r(o,s.children||[])).return=i,i=o;break e}n(i,o);break}t(i,o),o=o.sibling}(o=Fd(s,i.mode,c)).return=i,i=o}return a(i);case P:return e(i,o,(l=s._init)(s._payload),c)}if(te(s))return _(i,o,s,c);if(M(s))return m(i,o,s,c);qo(i,s)}return"string"===typeof s&&""!==s||"number"===typeof s?(s=""+s,null!==o&&6===o.tag?(n(i,o.sibling),(o=r(o,s)).return=i,i=o):(n(i,o),(o=Vd(s,i.mode,c)).return=i,i=o),a(i)):n(i,o)}}var Qo=Xo(!0),Zo=Xo(!1),$o={},es=Cr($o),ts=Cr($o),ns=Cr($o);function is(e){if(e===$o)throw Error(o(174));return e}function rs(e,t){switch(Ir(ns,t),Ir(ts,e),Ir(es,$o),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:ce(null,"");break;default:t=ce(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}br(es),Ir(es,t)}function os(){br(es),br(ts),br(ns)}function ss(e){is(ns.current);var t=is(es.current),n=ce(t,e.type);t!==n&&(Ir(ts,e),Ir(es,n))}function as(e){ts.current===e&&(br(es),br(ts))}var cs=Cr(0);function ds(e){for(var t=e;null!==t;){if(13===t.tag){var n=t.memoizedState;if(null!==n&&(null===(n=n.dehydrated)||"$?"===n.data||"$!"===n.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(0!==(128&t.flags))return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var ls=[];function us(){for(var e=0;e<ls.length;e++)ls[e]._workInProgressVersionPrimary=null;ls.length=0}var hs=T.ReactCurrentDispatcher,ps=T.ReactCurrentBatchConfig,fs=0,_s=null,ms=null,Es=null,gs=!1,Ss=!1,Ts=0,vs=0;function ys(){throw Error(o(321))}function Rs(e,t){if(null===t)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!ai(e[n],t[n]))return!1;return!0}function Cs(e,t,n,i,r,s){if(fs=s,_s=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,hs.current=null===e||null===e.memoizedState?aa:ca,e=n(i,r),Ss){s=0;do{if(Ss=!1,Ts=0,25<=s)throw Error(o(301));s+=1,Es=ms=null,t.updateQueue=null,hs.current=da,e=n(i,r)}while(Ss)}if(hs.current=sa,t=null!==ms&&null!==ms.next,fs=0,Es=ms=_s=null,gs=!1,t)throw Error(o(300));return e}function bs(){var e=0!==Ts;return Ts=0,e}function Is(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===Es?_s.memoizedState=Es=e:Es=Es.next=e,Es}function ws(){if(null===ms){var e=_s.alternate;e=null!==e?e.memoizedState:null}else e=ms.next;var t=null===Es?_s.memoizedState:Es.next;if(null!==t)Es=t,ms=e;else{if(null===e)throw Error(o(310));e={memoizedState:(ms=e).memoizedState,baseState:ms.baseState,baseQueue:ms.baseQueue,queue:ms.queue,next:null},null===Es?_s.memoizedState=Es=e:Es=Es.next=e}return Es}function As(e,t){return"function"===typeof t?t(e):t}function Os(e){var t=ws(),n=t.queue;if(null===n)throw Error(o(311));n.lastRenderedReducer=e;var i=ms,r=i.baseQueue,s=n.pending;if(null!==s){if(null!==r){var a=r.next;r.next=s.next,s.next=a}i.baseQueue=r=s,n.pending=null}if(null!==r){s=r.next,i=i.baseState;var c=a=null,d=null,l=s;do{var u=l.lane;if((fs&u)===u)null!==d&&(d=d.next={lane:0,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null}),i=l.hasEagerState?l.eagerState:e(i,l.action);else{var h={lane:u,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null};null===d?(c=d=h,a=i):d=d.next=h,_s.lanes|=u,xc|=u}l=l.next}while(null!==l&&l!==s);null===d?a=i:d.next=c,ai(i,t.memoizedState)||(Ta=!0),t.memoizedState=i,t.baseState=a,t.baseQueue=d,n.lastRenderedState=i}if(null!==(e=n.interleaved)){r=e;do{s=r.lane,_s.lanes|=s,xc|=s,r=r.next}while(r!==e)}else null===r&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function Ns(e){var t=ws(),n=t.queue;if(null===n)throw Error(o(311));n.lastRenderedReducer=e;var i=n.dispatch,r=n.pending,s=t.memoizedState;if(null!==r){n.pending=null;var a=r=r.next;do{s=e(s,a.action),a=a.next}while(a!==r);ai(s,t.memoizedState)||(Ta=!0),t.memoizedState=s,null===t.baseQueue&&(t.baseState=s),n.lastRenderedState=s}return[s,i]}function Ds(){}function Ps(e,t){var n=_s,i=ws(),r=t(),s=!ai(i.memoizedState,r);if(s&&(i.memoizedState=r,Ta=!0),i=i.queue,Hs(Ms.bind(null,n,i,e),[e]),i.getSnapshot!==t||s||null!==Es&&1&Es.memoizedState.tag){if(n.flags|=2048,Fs(9,Ls.bind(null,n,i,r,t),void 0,null),null===Nc)throw Error(o(349));0!==(30&fs)||ks(n,t,r)}return r}function ks(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},null===(t=_s.updateQueue)?(t={lastEffect:null,stores:null},_s.updateQueue=t,t.stores=[e]):null===(n=t.stores)?t.stores=[e]:n.push(e)}function Ls(e,t,n,i){t.value=n,t.getSnapshot=i,Us(t)&&xs(e)}function Ms(e,t,n){return n((function(){Us(t)&&xs(e)}))}function Us(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!ai(e,n)}catch(i){return!0}}function xs(e){var t=No(e,1);null!==t&&id(t,e,1,-1)}function Vs(e){var t=Is();return"function"===typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:As,lastRenderedState:e},t.queue=e,e=e.dispatch=na.bind(null,_s,e),[t.memoizedState,e]}function Fs(e,t,n,i){return e={tag:e,create:t,destroy:n,deps:i,next:null},null===(t=_s.updateQueue)?(t={lastEffect:null,stores:null},_s.updateQueue=t,t.lastEffect=e.next=e):null===(n=t.lastEffect)?t.lastEffect=e.next=e:(i=n.next,n.next=e,e.next=i,t.lastEffect=e),e}function js(){return ws().memoizedState}function Bs(e,t,n,i){var r=Is();_s.flags|=e,r.memoizedState=Fs(1|t,n,void 0,void 0===i?null:i)}function Gs(e,t,n,i){var r=ws();i=void 0===i?null:i;var o=void 0;if(null!==ms){var s=ms.memoizedState;if(o=s.destroy,null!==i&&Rs(i,s.deps))return void(r.memoizedState=Fs(t,n,o,i))}_s.flags|=e,r.memoizedState=Fs(1|t,n,o,i)}function Ws(e,t){return Bs(8390656,8,e,t)}function Hs(e,t){return Gs(2048,8,e,t)}function Ks(e,t){return Gs(4,2,e,t)}function zs(e,t){return Gs(4,4,e,t)}function Ys(e,t){return"function"===typeof t?(e=e(),t(e),function(){t(null)}):null!==t&&void 0!==t?(e=e(),t.current=e,function(){t.current=null}):void 0}function qs(e,t,n){return n=null!==n&&void 0!==n?n.concat([e]):null,Gs(4,4,Ys.bind(null,t,e),n)}function Js(){}function Xs(e,t){var n=ws();t=void 0===t?null:t;var i=n.memoizedState;return null!==i&&null!==t&&Rs(t,i[1])?i[0]:(n.memoizedState=[e,t],e)}function Qs(e,t){var n=ws();t=void 0===t?null:t;var i=n.memoizedState;return null!==i&&null!==t&&Rs(t,i[1])?i[0]:(e=e(),n.memoizedState=[e,t],e)}function Zs(e,t,n){return 0===(21&fs)?(e.baseState&&(e.baseState=!1,Ta=!0),e.memoizedState=n):(ai(n,t)||(n=_t(),_s.lanes|=n,xc|=n,e.baseState=!0),t)}function $s(e,t){var n=St;St=0!==n&&4>n?n:4,e(!0);var i=ps.transition;ps.transition={};try{e(!1),t()}finally{St=n,ps.transition=i}}function ea(){return ws().memoizedState}function ta(e,t,n){var i=nd(e);if(n={lane:i,action:n,hasEagerState:!1,eagerState:null,next:null},ia(e))ra(t,n);else if(null!==(n=Oo(e,t,n,i))){id(n,e,i,td()),oa(n,t,i)}}function na(e,t,n){var i=nd(e),r={lane:i,action:n,hasEagerState:!1,eagerState:null,next:null};if(ia(e))ra(t,r);else{var o=e.alternate;if(0===e.lanes&&(null===o||0===o.lanes)&&null!==(o=t.lastRenderedReducer))try{var s=t.lastRenderedState,a=o(s,n);if(r.hasEagerState=!0,r.eagerState=a,ai(a,s)){var c=t.interleaved;return null===c?(r.next=r,Ao(t)):(r.next=c.next,c.next=r),void(t.interleaved=r)}}catch(d){}null!==(n=Oo(e,t,r,i))&&(id(n,e,i,r=td()),oa(n,t,i))}}function ia(e){var t=e.alternate;return e===_s||null!==t&&t===_s}function ra(e,t){Ss=gs=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function oa(e,t,n){if(0!==(4194240&n)){var i=t.lanes;n|=i&=e.pendingLanes,t.lanes=n,gt(e,n)}}var sa={readContext:Io,useCallback:ys,useContext:ys,useEffect:ys,useImperativeHandle:ys,useInsertionEffect:ys,useLayoutEffect:ys,useMemo:ys,useReducer:ys,useRef:ys,useState:ys,useDebugValue:ys,useDeferredValue:ys,useTransition:ys,useMutableSource:ys,useSyncExternalStore:ys,useId:ys,unstable_isNewReconciler:!1},aa={readContext:Io,useCallback:function(e,t){return Is().memoizedState=[e,void 0===t?null:t],e},useContext:Io,useEffect:Ws,useImperativeHandle:function(e,t,n){return n=null!==n&&void 0!==n?n.concat([e]):null,Bs(4194308,4,Ys.bind(null,t,e),n)},useLayoutEffect:function(e,t){return Bs(4194308,4,e,t)},useInsertionEffect:function(e,t){return Bs(4,2,e,t)},useMemo:function(e,t){var n=Is();return t=void 0===t?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var i=Is();return t=void 0!==n?n(t):t,i.memoizedState=i.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},i.queue=e,e=e.dispatch=ta.bind(null,_s,e),[i.memoizedState,e]},useRef:function(e){return e={current:e},Is().memoizedState=e},useState:Vs,useDebugValue:Js,useDeferredValue:function(e){return Is().memoizedState=e},useTransition:function(){var e=Vs(!1),t=e[0];return e=$s.bind(null,e[1]),Is().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var i=_s,r=Is();if(ro){if(void 0===n)throw Error(o(407));n=n()}else{if(n=t(),null===Nc)throw Error(o(349));0!==(30&fs)||ks(i,t,n)}r.memoizedState=n;var s={value:n,getSnapshot:t};return r.queue=s,Ws(Ms.bind(null,i,s,e),[e]),i.flags|=2048,Fs(9,Ls.bind(null,i,s,n,t),void 0,null),n},useId:function(){var e=Is(),t=Nc.identifierPrefix;if(ro){var n=Qr;t=":"+t+"R"+(n=(Xr&~(1<<32-st(Xr)-1)).toString(32)+n),0<(n=Ts++)&&(t+="H"+n.toString(32)),t+=":"}else t=":"+t+"r"+(n=vs++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},ca={readContext:Io,useCallback:Xs,useContext:Io,useEffect:Hs,useImperativeHandle:qs,useInsertionEffect:Ks,useLayoutEffect:zs,useMemo:Qs,useReducer:Os,useRef:js,useState:function(){return Os(As)},useDebugValue:Js,useDeferredValue:function(e){return Zs(ws(),ms.memoizedState,e)},useTransition:function(){return[Os(As)[0],ws().memoizedState]},useMutableSource:Ds,useSyncExternalStore:Ps,useId:ea,unstable_isNewReconciler:!1},da={readContext:Io,useCallback:Xs,useContext:Io,useEffect:Hs,useImperativeHandle:qs,useInsertionEffect:Ks,useLayoutEffect:zs,useMemo:Qs,useReducer:Ns,useRef:js,useState:function(){return Ns(As)},useDebugValue:Js,useDeferredValue:function(e){var t=ws();return null===ms?t.memoizedState=e:Zs(t,ms.memoizedState,e)},useTransition:function(){return[Ns(As)[0],ws().memoizedState]},useMutableSource:Ds,useSyncExternalStore:Ps,useId:ea,unstable_isNewReconciler:!1};function la(e,t){try{var n="",i=t;do{n+=B(i),i=i.return}while(i);var r=n}catch(o){r="\nError generating stack: "+o.message+"\n"+o.stack}return{value:e,source:t,stack:r,digest:null}}function ua(e,t,n){return{value:e,source:null,stack:null!=n?n:null,digest:null!=t?t:null}}function ha(e,t){try{console.error(t.value)}catch(n){setTimeout((function(){throw n}))}}var pa="function"===typeof WeakMap?WeakMap:Map;function fa(e,t,n){(n=Lo(-1,n)).tag=3,n.payload={element:null};var i=t.value;return n.callback=function(){Kc||(Kc=!0,zc=i),ha(0,t)},n}function _a(e,t,n){(n=Lo(-1,n)).tag=3;var i=e.type.getDerivedStateFromError;if("function"===typeof i){var r=t.value;n.payload=function(){return i(r)},n.callback=function(){ha(0,t)}}var o=e.stateNode;return null!==o&&"function"===typeof o.componentDidCatch&&(n.callback=function(){ha(0,t),"function"!==typeof i&&(null===Yc?Yc=new Set([this]):Yc.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),n}function ma(e,t,n){var i=e.pingCache;if(null===i){i=e.pingCache=new pa;var r=new Set;i.set(t,r)}else void 0===(r=i.get(t))&&(r=new Set,i.set(t,r));r.has(n)||(r.add(n),e=Id.bind(null,e,t,n),t.then(e,e))}function Ea(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function ga(e,t,n,i,r){return 0===(1&e.mode)?(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,1===n.tag&&(null===n.alternate?n.tag=17:((t=Lo(-1,1)).tag=2,Mo(n,t,1))),n.lanes|=1),e):(e.flags|=65536,e.lanes=r,e)}var Sa=T.ReactCurrentOwner,Ta=!1;function va(e,t,n,i){t.child=null===e?Zo(t,null,n,i):Qo(t,e.child,n,i)}function ya(e,t,n,i,r){n=n.render;var o=t.ref;return bo(t,r),i=Cs(e,t,n,i,o,r),n=bs(),null===e||Ta?(ro&&n&&eo(t),t.flags|=1,va(e,t,i,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Ka(e,t,r))}function Ra(e,t,n,i,r){if(null===e){var o=n.type;return"function"!==typeof o||kd(o)||void 0!==o.defaultProps||null!==n.compare||void 0!==n.defaultProps?((e=Md(n.type,null,i,t,t.mode,r)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=o,Ca(e,t,o,i,r))}if(o=e.child,0===(e.lanes&r)){var s=o.memoizedProps;if((n=null!==(n=n.compare)?n:ci)(s,i)&&e.ref===t.ref)return Ka(e,t,r)}return t.flags|=1,(e=Ld(o,i)).ref=t.ref,e.return=t,t.child=e}function Ca(e,t,n,i,r){if(null!==e){var o=e.memoizedProps;if(ci(o,i)&&e.ref===t.ref){if(Ta=!1,t.pendingProps=i=o,0===(e.lanes&r))return t.lanes=e.lanes,Ka(e,t,r);0!==(131072&e.flags)&&(Ta=!0)}}return wa(e,t,n,i,r)}function ba(e,t,n){var i=t.pendingProps,r=i.children,o=null!==e?e.memoizedState:null;if("hidden"===i.mode)if(0===(1&t.mode))t.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ir(Lc,kc),kc|=n;else{if(0===(1073741824&n))return e=null!==o?o.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,Ir(Lc,kc),kc|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=null!==o?o.baseLanes:n,Ir(Lc,kc),kc|=i}else null!==o?(i=o.baseLanes|n,t.memoizedState=null):i=n,Ir(Lc,kc),kc|=i;return va(e,t,r,n),t.child}function Ia(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function wa(e,t,n,i,r){var o=Pr(n)?Nr:Ar.current;return o=Dr(t,o),bo(t,r),n=Cs(e,t,n,i,o,r),i=bs(),null===e||Ta?(ro&&i&&eo(t),t.flags|=1,va(e,t,n,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Ka(e,t,r))}function Aa(e,t,n,i,r){if(Pr(n)){var o=!0;Ur(t)}else o=!1;if(bo(t,r),null===t.stateNode)Ha(e,t),Ho(t,n,i),zo(t,n,i,r),i=!0;else if(null===e){var s=t.stateNode,a=t.memoizedProps;s.props=a;var c=s.context,d=n.contextType;"object"===typeof d&&null!==d?d=Io(d):d=Dr(t,d=Pr(n)?Nr:Ar.current);var l=n.getDerivedStateFromProps,u="function"===typeof l||"function"===typeof s.getSnapshotBeforeUpdate;u||"function"!==typeof s.UNSAFE_componentWillReceiveProps&&"function"!==typeof s.componentWillReceiveProps||(a!==i||c!==d)&&Ko(t,s,i,d),Do=!1;var h=t.memoizedState;s.state=h,Vo(t,i,s,r),c=t.memoizedState,a!==i||h!==c||Or.current||Do?("function"===typeof l&&(Bo(t,n,l,i),c=t.memoizedState),(a=Do||Wo(t,n,a,i,h,c,d))?(u||"function"!==typeof s.UNSAFE_componentWillMount&&"function"!==typeof s.componentWillMount||("function"===typeof s.componentWillMount&&s.componentWillMount(),"function"===typeof s.UNSAFE_componentWillMount&&s.UNSAFE_componentWillMount()),"function"===typeof s.componentDidMount&&(t.flags|=4194308)):("function"===typeof s.componentDidMount&&(t.flags|=4194308),t.memoizedProps=i,t.memoizedState=c),s.props=i,s.state=c,s.context=d,i=a):("function"===typeof s.componentDidMount&&(t.flags|=4194308),i=!1)}else{s=t.stateNode,ko(e,t),a=t.memoizedProps,d=t.type===t.elementType?a:Eo(t.type,a),s.props=d,u=t.pendingProps,h=s.context,"object"===typeof(c=n.contextType)&&null!==c?c=Io(c):c=Dr(t,c=Pr(n)?Nr:Ar.current);var p=n.getDerivedStateFromProps;(l="function"===typeof p||"function"===typeof s.getSnapshotBeforeUpdate)||"function"!==typeof s.UNSAFE_componentWillReceiveProps&&"function"!==typeof s.componentWillReceiveProps||(a!==u||h!==c)&&Ko(t,s,i,c),Do=!1,h=t.memoizedState,s.state=h,Vo(t,i,s,r);var f=t.memoizedState;a!==u||h!==f||Or.current||Do?("function"===typeof p&&(Bo(t,n,p,i),f=t.memoizedState),(d=Do||Wo(t,n,d,i,h,f,c)||!1)?(l||"function"!==typeof s.UNSAFE_componentWillUpdate&&"function"!==typeof s.componentWillUpdate||("function"===typeof s.componentWillUpdate&&s.componentWillUpdate(i,f,c),"function"===typeof s.UNSAFE_componentWillUpdate&&s.UNSAFE_componentWillUpdate(i,f,c)),"function"===typeof s.componentDidUpdate&&(t.flags|=4),"function"===typeof s.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!==typeof s.componentDidUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!==typeof s.getSnapshotBeforeUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),t.memoizedProps=i,t.memoizedState=f),s.props=i,s.state=f,s.context=c,i=d):("function"!==typeof s.componentDidUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!==typeof s.getSnapshotBeforeUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),i=!1)}return Oa(e,t,n,i,o,r)}function Oa(e,t,n,i,r,o){Ia(e,t);var s=0!==(128&t.flags);if(!i&&!s)return r&&xr(t,n,!1),Ka(e,t,o);i=t.stateNode,Sa.current=t;var a=s&&"function"!==typeof n.getDerivedStateFromError?null:i.render();return t.flags|=1,null!==e&&s?(t.child=Qo(t,e.child,null,o),t.child=Qo(t,null,a,o)):va(e,t,a,o),t.memoizedState=i.state,r&&xr(t,n,!0),t.child}function Na(e){var t=e.stateNode;t.pendingContext?Lr(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Lr(0,t.context,!1),rs(e,t.containerInfo)}function Da(e,t,n,i,r){return fo(),_o(r),t.flags|=256,va(e,t,n,i),t.child}var Pa,ka,La,Ma,Ua={dehydrated:null,treeContext:null,retryLane:0};function xa(e){return{baseLanes:e,cachePool:null,transitions:null}}function Va(e,t,n){var i,r=t.pendingProps,s=cs.current,a=!1,c=0!==(128&t.flags);if((i=c)||(i=(null===e||null!==e.memoizedState)&&0!==(2&s)),i?(a=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(s|=1),Ir(cs,1&s),null===e)return lo(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(0===(1&t.mode)?t.lanes=1:"$!"===e.data?t.lanes=8:t.lanes=1073741824,null):(c=r.children,e=r.fallback,a?(r=t.mode,a=t.child,c={mode:"hidden",children:c},0===(1&r)&&null!==a?(a.childLanes=0,a.pendingProps=c):a=xd(c,r,0,null),e=Ud(e,r,n,null),a.return=t,e.return=t,a.sibling=e,t.child=a,t.child.memoizedState=xa(n),t.memoizedState=Ua,e):Fa(t,c));if(null!==(s=e.memoizedState)&&null!==(i=s.dehydrated))return function(e,t,n,i,r,s,a){if(n)return 256&t.flags?(t.flags&=-257,ja(e,t,a,i=ua(Error(o(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(s=i.fallback,r=t.mode,i=xd({mode:"visible",children:i.children},r,0,null),(s=Ud(s,r,a,null)).flags|=2,i.return=t,s.return=t,i.sibling=s,t.child=i,0!==(1&t.mode)&&Qo(t,e.child,null,a),t.child.memoizedState=xa(a),t.memoizedState=Ua,s);if(0===(1&t.mode))return ja(e,t,a,null);if("$!"===r.data){if(i=r.nextSibling&&r.nextSibling.dataset)var c=i.dgst;return i=c,ja(e,t,a,i=ua(s=Error(o(419)),i,void 0))}if(c=0!==(a&e.childLanes),Ta||c){if(null!==(i=Nc)){switch(a&-a){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}0!==(r=0!==(r&(i.suspendedLanes|a))?0:r)&&r!==s.retryLane&&(s.retryLane=r,No(e,r),id(i,e,r,-1))}return md(),ja(e,t,a,i=ua(Error(o(421))))}return"$?"===r.data?(t.flags|=128,t.child=e.child,t=Ad.bind(null,e),r._reactRetry=t,null):(e=s.treeContext,io=dr(r.nextSibling),no=t,ro=!0,oo=null,null!==e&&(Yr[qr++]=Xr,Yr[qr++]=Qr,Yr[qr++]=Jr,Xr=e.id,Qr=e.overflow,Jr=t),t=Fa(t,i.children),t.flags|=4096,t)}(e,t,c,r,i,s,n);if(a){a=r.fallback,c=t.mode,i=(s=e.child).sibling;var d={mode:"hidden",children:r.children};return 0===(1&c)&&t.child!==s?((r=t.child).childLanes=0,r.pendingProps=d,t.deletions=null):(r=Ld(s,d)).subtreeFlags=14680064&s.subtreeFlags,null!==i?a=Ld(i,a):(a=Ud(a,c,n,null)).flags|=2,a.return=t,r.return=t,r.sibling=a,t.child=r,r=a,a=t.child,c=null===(c=e.child.memoizedState)?xa(n):{baseLanes:c.baseLanes|n,cachePool:null,transitions:c.transitions},a.memoizedState=c,a.childLanes=e.childLanes&~n,t.memoizedState=Ua,r}return e=(a=e.child).sibling,r=Ld(a,{mode:"visible",children:r.children}),0===(1&t.mode)&&(r.lanes=n),r.return=t,r.sibling=null,null!==e&&(null===(n=t.deletions)?(t.deletions=[e],t.flags|=16):n.push(e)),t.child=r,t.memoizedState=null,r}function Fa(e,t){return(t=xd({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function ja(e,t,n,i){return null!==i&&_o(i),Qo(t,e.child,null,n),(e=Fa(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function Ba(e,t,n){e.lanes|=t;var i=e.alternate;null!==i&&(i.lanes|=t),Co(e.return,t,n)}function Ga(e,t,n,i,r){var o=e.memoizedState;null===o?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:i,tail:n,tailMode:r}:(o.isBackwards=t,o.rendering=null,o.renderingStartTime=0,o.last=i,o.tail=n,o.tailMode=r)}function Wa(e,t,n){var i=t.pendingProps,r=i.revealOrder,o=i.tail;if(va(e,t,i.children,n),0!==(2&(i=cs.current)))i=1&i|2,t.flags|=128;else{if(null!==e&&0!==(128&e.flags))e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&Ba(e,n,t);else if(19===e.tag)Ba(e,n,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}i&=1}if(Ir(cs,i),0===(1&t.mode))t.memoizedState=null;else switch(r){case"forwards":for(n=t.child,r=null;null!==n;)null!==(e=n.alternate)&&null===ds(e)&&(r=n),n=n.sibling;null===(n=r)?(r=t.child,t.child=null):(r=n.sibling,n.sibling=null),Ga(t,!1,r,n,o);break;case"backwards":for(n=null,r=t.child,t.child=null;null!==r;){if(null!==(e=r.alternate)&&null===ds(e)){t.child=r;break}e=r.sibling,r.sibling=n,n=r,r=e}Ga(t,!0,n,null,o);break;case"together":Ga(t,!1,null,null,void 0);break;default:t.memoizedState=null}return t.child}function Ha(e,t){0===(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Ka(e,t,n){if(null!==e&&(t.dependencies=e.dependencies),xc|=t.lanes,0===(n&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(o(153));if(null!==t.child){for(n=Ld(e=t.child,e.pendingProps),t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=Ld(e,e.pendingProps)).return=t;n.sibling=null}return t.child}function za(e,t){if(!ro)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;null!==t;)null!==t.alternate&&(n=t),t=t.sibling;null===n?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var i=null;null!==n;)null!==n.alternate&&(i=n),n=n.sibling;null===i?t||null===e.tail?e.tail=null:e.tail.sibling=null:i.sibling=null}}function Ya(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,i=0;if(t)for(var r=e.child;null!==r;)n|=r.lanes|r.childLanes,i|=14680064&r.subtreeFlags,i|=14680064&r.flags,r.return=e,r=r.sibling;else for(r=e.child;null!==r;)n|=r.lanes|r.childLanes,i|=r.subtreeFlags,i|=r.flags,r.return=e,r=r.sibling;return e.subtreeFlags|=i,e.childLanes=n,t}function qa(e,t,n){var i=t.pendingProps;switch(to(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Ya(t),null;case 1:case 17:return Pr(t.type)&&kr(),Ya(t),null;case 3:return i=t.stateNode,os(),br(Or),br(Ar),us(),i.pendingContext&&(i.context=i.pendingContext,i.pendingContext=null),null!==e&&null!==e.child||(ho(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&0===(256&t.flags)||(t.flags|=1024,null!==oo&&(ad(oo),oo=null))),ka(e,t),Ya(t),null;case 5:as(t);var r=is(ns.current);if(n=t.type,null!==e&&null!=t.stateNode)La(e,t,n,i,r),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!i){if(null===t.stateNode)throw Error(o(166));return Ya(t),null}if(e=is(es.current),ho(t)){i=t.stateNode,n=t.type;var s=t.memoizedProps;switch(i[hr]=t,i[pr]=s,e=0!==(1&t.mode),n){case"dialog":Fi("cancel",i),Fi("close",i);break;case"iframe":case"object":case"embed":Fi("load",i);break;case"video":case"audio":for(r=0;r<Mi.length;r++)Fi(Mi[r],i);break;case"source":Fi("error",i);break;case"img":case"image":case"link":Fi("error",i),Fi("load",i);break;case"details":Fi("toggle",i);break;case"input":X(i,s),Fi("invalid",i);break;case"select":i._wrapperState={wasMultiple:!!s.multiple},Fi("invalid",i);break;case"textarea":re(i,s),Fi("invalid",i)}for(var c in ge(n,s),r=null,s)if(s.hasOwnProperty(c)){var d=s[c];"children"===c?"string"===typeof d?i.textContent!==d&&(!0!==s.suppressHydrationWarning&&Zi(i.textContent,d,e),r=["children",d]):"number"===typeof d&&i.textContent!==""+d&&(!0!==s.suppressHydrationWarning&&Zi(i.textContent,d,e),r=["children",""+d]):a.hasOwnProperty(c)&&null!=d&&"onScroll"===c&&Fi("scroll",i)}switch(n){case"input":z(i),$(i,s,!0);break;case"textarea":z(i),se(i);break;case"select":case"option":break;default:"function"===typeof s.onClick&&(i.onclick=$i)}i=r,t.updateQueue=i,null!==i&&(t.flags|=4)}else{c=9===r.nodeType?r:r.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=ae(n)),"http://www.w3.org/1999/xhtml"===e?"script"===n?((e=c.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"===typeof i.is?e=c.createElement(n,{is:i.is}):(e=c.createElement(n),"select"===n&&(c=e,i.multiple?c.multiple=!0:i.size&&(c.size=i.size))):e=c.createElementNS(e,n),e[hr]=t,e[pr]=i,Pa(e,t,!1,!1),t.stateNode=e;e:{switch(c=Se(n,i),n){case"dialog":Fi("cancel",e),Fi("close",e),r=i;break;case"iframe":case"object":case"embed":Fi("load",e),r=i;break;case"video":case"audio":for(r=0;r<Mi.length;r++)Fi(Mi[r],e);r=i;break;case"source":Fi("error",e),r=i;break;case"img":case"image":case"link":Fi("error",e),Fi("load",e),r=i;break;case"details":Fi("toggle",e),r=i;break;case"input":X(e,i),r=J(e,i),Fi("invalid",e);break;case"option":default:r=i;break;case"select":e._wrapperState={wasMultiple:!!i.multiple},r=x({},i,{value:void 0}),Fi("invalid",e);break;case"textarea":re(e,i),r=ie(e,i),Fi("invalid",e)}for(s in ge(n,r),d=r)if(d.hasOwnProperty(s)){var l=d[s];"style"===s?me(e,l):"dangerouslySetInnerHTML"===s?null!=(l=l?l.__html:void 0)&&ue(e,l):"children"===s?"string"===typeof l?("textarea"!==n||""!==l)&&he(e,l):"number"===typeof l&&he(e,""+l):"suppressContentEditableWarning"!==s&&"suppressHydrationWarning"!==s&&"autoFocus"!==s&&(a.hasOwnProperty(s)?null!=l&&"onScroll"===s&&Fi("scroll",e):null!=l&&S(e,s,l,c))}switch(n){case"input":z(e),$(e,i,!1);break;case"textarea":z(e),se(e);break;case"option":null!=i.value&&e.setAttribute("value",""+H(i.value));break;case"select":e.multiple=!!i.multiple,null!=(s=i.value)?ne(e,!!i.multiple,s,!1):null!=i.defaultValue&&ne(e,!!i.multiple,i.defaultValue,!0);break;default:"function"===typeof r.onClick&&(e.onclick=$i)}switch(n){case"button":case"input":case"select":case"textarea":i=!!i.autoFocus;break e;case"img":i=!0;break e;default:i=!1}}i&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return Ya(t),null;case 6:if(e&&null!=t.stateNode)Ma(e,t,e.memoizedProps,i);else{if("string"!==typeof i&&null===t.stateNode)throw Error(o(166));if(n=is(ns.current),is(es.current),ho(t)){if(i=t.stateNode,n=t.memoizedProps,i[hr]=t,(s=i.nodeValue!==n)&&null!==(e=no))switch(e.tag){case 3:Zi(i.nodeValue,n,0!==(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Zi(i.nodeValue,n,0!==(1&e.mode))}s&&(t.flags|=4)}else(i=(9===n.nodeType?n:n.ownerDocument).createTextNode(i))[hr]=t,t.stateNode=i}return Ya(t),null;case 13:if(br(cs),i=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(ro&&null!==io&&0!==(1&t.mode)&&0===(128&t.flags))po(),fo(),t.flags|=98560,s=!1;else if(s=ho(t),null!==i&&null!==i.dehydrated){if(null===e){if(!s)throw Error(o(318));if(!(s=null!==(s=t.memoizedState)?s.dehydrated:null))throw Error(o(317));s[hr]=t}else fo(),0===(128&t.flags)&&(t.memoizedState=null),t.flags|=4;Ya(t),s=!1}else null!==oo&&(ad(oo),oo=null),s=!0;if(!s)return 65536&t.flags?t:null}return 0!==(128&t.flags)?(t.lanes=n,t):((i=null!==i)!==(null!==e&&null!==e.memoizedState)&&i&&(t.child.flags|=8192,0!==(1&t.mode)&&(null===e||0!==(1&cs.current)?0===Mc&&(Mc=3):md())),null!==t.updateQueue&&(t.flags|=4),Ya(t),null);case 4:return os(),ka(e,t),null===e&&Gi(t.stateNode.containerInfo),Ya(t),null;case 10:return Ro(t.type._context),Ya(t),null;case 19:if(br(cs),null===(s=t.memoizedState))return Ya(t),null;if(i=0!==(128&t.flags),null===(c=s.rendering))if(i)za(s,!1);else{if(0!==Mc||null!==e&&0!==(128&e.flags))for(e=t.child;null!==e;){if(null!==(c=ds(e))){for(t.flags|=128,za(s,!1),null!==(i=c.updateQueue)&&(t.updateQueue=i,t.flags|=4),t.subtreeFlags=0,i=n,n=t.child;null!==n;)e=i,(s=n).flags&=14680066,null===(c=s.alternate)?(s.childLanes=0,s.lanes=e,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=c.childLanes,s.lanes=c.lanes,s.child=c.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=c.memoizedProps,s.memoizedState=c.memoizedState,s.updateQueue=c.updateQueue,s.type=c.type,e=c.dependencies,s.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),n=n.sibling;return Ir(cs,1&cs.current|2),t.child}e=e.sibling}null!==s.tail&&Qe()>Wc&&(t.flags|=128,i=!0,za(s,!1),t.lanes=4194304)}else{if(!i)if(null!==(e=ds(c))){if(t.flags|=128,i=!0,null!==(n=e.updateQueue)&&(t.updateQueue=n,t.flags|=4),za(s,!0),null===s.tail&&"hidden"===s.tailMode&&!c.alternate&&!ro)return Ya(t),null}else 2*Qe()-s.renderingStartTime>Wc&&1073741824!==n&&(t.flags|=128,i=!0,za(s,!1),t.lanes=4194304);s.isBackwards?(c.sibling=t.child,t.child=c):(null!==(n=s.last)?n.sibling=c:t.child=c,s.last=c)}return null!==s.tail?(t=s.tail,s.rendering=t,s.tail=t.sibling,s.renderingStartTime=Qe(),t.sibling=null,n=cs.current,Ir(cs,i?1&n|2:1&n),t):(Ya(t),null);case 22:case 23:return hd(),i=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==i&&(t.flags|=8192),i&&0!==(1&t.mode)?0!==(1073741824&kc)&&(Ya(t),6&t.subtreeFlags&&(t.flags|=8192)):Ya(t),null;case 24:case 25:return null}throw Error(o(156,t.tag))}function Ja(e,t){switch(to(t),t.tag){case 1:return Pr(t.type)&&kr(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return os(),br(Or),br(Ar),us(),0!==(65536&(e=t.flags))&&0===(128&e)?(t.flags=-65537&e|128,t):null;case 5:return as(t),null;case 13:if(br(cs),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(o(340));fo()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return br(cs),null;case 4:return os(),null;case 10:return Ro(t.type._context),null;case 22:case 23:return hd(),null;default:return null}}Pa=function(e,t){for(var n=t.child;null!==n;){if(5===n.tag||6===n.tag)e.appendChild(n.stateNode);else if(4!==n.tag&&null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}},ka=function(){},La=function(e,t,n,i){var r=e.memoizedProps;if(r!==i){e=t.stateNode,is(es.current);var o,s=null;switch(n){case"input":r=J(e,r),i=J(e,i),s=[];break;case"select":r=x({},r,{value:void 0}),i=x({},i,{value:void 0}),s=[];break;case"textarea":r=ie(e,r),i=ie(e,i),s=[];break;default:"function"!==typeof r.onClick&&"function"===typeof i.onClick&&(e.onclick=$i)}for(l in ge(n,i),n=null,r)if(!i.hasOwnProperty(l)&&r.hasOwnProperty(l)&&null!=r[l])if("style"===l){var c=r[l];for(o in c)c.hasOwnProperty(o)&&(n||(n={}),n[o]="")}else"dangerouslySetInnerHTML"!==l&&"children"!==l&&"suppressContentEditableWarning"!==l&&"suppressHydrationWarning"!==l&&"autoFocus"!==l&&(a.hasOwnProperty(l)?s||(s=[]):(s=s||[]).push(l,null));for(l in i){var d=i[l];if(c=null!=r?r[l]:void 0,i.hasOwnProperty(l)&&d!==c&&(null!=d||null!=c))if("style"===l)if(c){for(o in c)!c.hasOwnProperty(o)||d&&d.hasOwnProperty(o)||(n||(n={}),n[o]="");for(o in d)d.hasOwnProperty(o)&&c[o]!==d[o]&&(n||(n={}),n[o]=d[o])}else n||(s||(s=[]),s.push(l,n)),n=d;else"dangerouslySetInnerHTML"===l?(d=d?d.__html:void 0,c=c?c.__html:void 0,null!=d&&c!==d&&(s=s||[]).push(l,d)):"children"===l?"string"!==typeof d&&"number"!==typeof d||(s=s||[]).push(l,""+d):"suppressContentEditableWarning"!==l&&"suppressHydrationWarning"!==l&&(a.hasOwnProperty(l)?(null!=d&&"onScroll"===l&&Fi("scroll",e),s||c===d||(s=[])):(s=s||[]).push(l,d))}n&&(s=s||[]).push("style",n);var l=s;(t.updateQueue=l)&&(t.flags|=4)}},Ma=function(e,t,n,i){n!==i&&(t.flags|=4)};var Xa=!1,Qa=!1,Za="function"===typeof WeakSet?WeakSet:Set,$a=null;function ec(e,t){var n=e.ref;if(null!==n)if("function"===typeof n)try{n(null)}catch(i){bd(e,t,i)}else n.current=null}function tc(e,t,n){try{n()}catch(i){bd(e,t,i)}}var nc=!1;function ic(e,t,n){var i=t.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var r=i=i.next;do{if((r.tag&e)===e){var o=r.destroy;r.destroy=void 0,void 0!==o&&tc(t,n,o)}r=r.next}while(r!==i)}}function rc(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var n=t=t.next;do{if((n.tag&e)===e){var i=n.create;n.destroy=i()}n=n.next}while(n!==t)}}function oc(e){var t=e.ref;if(null!==t){var n=e.stateNode;e.tag,e=n,"function"===typeof t?t(e):t.current=e}}function sc(e){var t=e.alternate;null!==t&&(e.alternate=null,sc(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[hr],delete t[pr],delete t[_r],delete t[mr],delete t[Er])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function ac(e){return 5===e.tag||3===e.tag||4===e.tag}function cc(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||ac(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function dc(e,t,n){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?8===n.nodeType?n.parentNode.insertBefore(e,t):n.insertBefore(e,t):(8===n.nodeType?(t=n.parentNode).insertBefore(e,n):(t=n).appendChild(e),null!==(n=n._reactRootContainer)&&void 0!==n||null!==t.onclick||(t.onclick=$i));else if(4!==i&&null!==(e=e.child))for(dc(e,t,n),e=e.sibling;null!==e;)dc(e,t,n),e=e.sibling}function lc(e,t,n){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?n.insertBefore(e,t):n.appendChild(e);else if(4!==i&&null!==(e=e.child))for(lc(e,t,n),e=e.sibling;null!==e;)lc(e,t,n),e=e.sibling}var uc=null,hc=!1;function pc(e,t,n){for(n=n.child;null!==n;)fc(e,t,n),n=n.sibling}function fc(e,t,n){if(ot&&"function"===typeof ot.onCommitFiberUnmount)try{ot.onCommitFiberUnmount(rt,n)}catch(a){}switch(n.tag){case 5:Qa||ec(n,t);case 6:var i=uc,r=hc;uc=null,pc(e,t,n),hc=r,null!==(uc=i)&&(hc?(e=uc,n=n.stateNode,8===e.nodeType?e.parentNode.removeChild(n):e.removeChild(n)):uc.removeChild(n.stateNode));break;case 18:null!==uc&&(hc?(e=uc,n=n.stateNode,8===e.nodeType?cr(e.parentNode,n):1===e.nodeType&&cr(e,n),Gt(e)):cr(uc,n.stateNode));break;case 4:i=uc,r=hc,uc=n.stateNode.containerInfo,hc=!0,pc(e,t,n),uc=i,hc=r;break;case 0:case 11:case 14:case 15:if(!Qa&&(null!==(i=n.updateQueue)&&null!==(i=i.lastEffect))){r=i=i.next;do{var o=r,s=o.destroy;o=o.tag,void 0!==s&&(0!==(2&o)||0!==(4&o))&&tc(n,t,s),r=r.next}while(r!==i)}pc(e,t,n);break;case 1:if(!Qa&&(ec(n,t),"function"===typeof(i=n.stateNode).componentWillUnmount))try{i.props=n.memoizedProps,i.state=n.memoizedState,i.componentWillUnmount()}catch(a){bd(n,t,a)}pc(e,t,n);break;case 21:pc(e,t,n);break;case 22:1&n.mode?(Qa=(i=Qa)||null!==n.memoizedState,pc(e,t,n),Qa=i):pc(e,t,n);break;default:pc(e,t,n)}}function _c(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new Za),t.forEach((function(t){var i=Od.bind(null,e,t);n.has(t)||(n.add(t),t.then(i,i))}))}}function mc(e,t){var n=t.deletions;if(null!==n)for(var i=0;i<n.length;i++){var r=n[i];try{var s=e,a=t,c=a;e:for(;null!==c;){switch(c.tag){case 5:uc=c.stateNode,hc=!1;break e;case 3:case 4:uc=c.stateNode.containerInfo,hc=!0;break e}c=c.return}if(null===uc)throw Error(o(160));fc(s,a,r),uc=null,hc=!1;var d=r.alternate;null!==d&&(d.return=null),r.return=null}catch(l){bd(r,t,l)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)Ec(t,e),t=t.sibling}function Ec(e,t){var n=e.alternate,i=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(mc(t,e),gc(e),4&i){try{ic(3,e,e.return),rc(3,e)}catch(m){bd(e,e.return,m)}try{ic(5,e,e.return)}catch(m){bd(e,e.return,m)}}break;case 1:mc(t,e),gc(e),512&i&&null!==n&&ec(n,n.return);break;case 5:if(mc(t,e),gc(e),512&i&&null!==n&&ec(n,n.return),32&e.flags){var r=e.stateNode;try{he(r,"")}catch(m){bd(e,e.return,m)}}if(4&i&&null!=(r=e.stateNode)){var s=e.memoizedProps,a=null!==n?n.memoizedProps:s,c=e.type,d=e.updateQueue;if(e.updateQueue=null,null!==d)try{"input"===c&&"radio"===s.type&&null!=s.name&&Q(r,s),Se(c,a);var l=Se(c,s);for(a=0;a<d.length;a+=2){var u=d[a],h=d[a+1];"style"===u?me(r,h):"dangerouslySetInnerHTML"===u?ue(r,h):"children"===u?he(r,h):S(r,u,h,l)}switch(c){case"input":Z(r,s);break;case"textarea":oe(r,s);break;case"select":var p=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!s.multiple;var f=s.value;null!=f?ne(r,!!s.multiple,f,!1):p!==!!s.multiple&&(null!=s.defaultValue?ne(r,!!s.multiple,s.defaultValue,!0):ne(r,!!s.multiple,s.multiple?[]:"",!1))}r[pr]=s}catch(m){bd(e,e.return,m)}}break;case 6:if(mc(t,e),gc(e),4&i){if(null===e.stateNode)throw Error(o(162));r=e.stateNode,s=e.memoizedProps;try{r.nodeValue=s}catch(m){bd(e,e.return,m)}}break;case 3:if(mc(t,e),gc(e),4&i&&null!==n&&n.memoizedState.isDehydrated)try{Gt(t.containerInfo)}catch(m){bd(e,e.return,m)}break;case 4:default:mc(t,e),gc(e);break;case 13:mc(t,e),gc(e),8192&(r=e.child).flags&&(s=null!==r.memoizedState,r.stateNode.isHidden=s,!s||null!==r.alternate&&null!==r.alternate.memoizedState||(Gc=Qe())),4&i&&_c(e);break;case 22:if(u=null!==n&&null!==n.memoizedState,1&e.mode?(Qa=(l=Qa)||u,mc(t,e),Qa=l):mc(t,e),gc(e),8192&i){if(l=null!==e.memoizedState,(e.stateNode.isHidden=l)&&!u&&0!==(1&e.mode))for($a=e,u=e.child;null!==u;){for(h=$a=u;null!==$a;){switch(f=(p=$a).child,p.tag){case 0:case 11:case 14:case 15:ic(4,p,p.return);break;case 1:ec(p,p.return);var _=p.stateNode;if("function"===typeof _.componentWillUnmount){i=p,n=p.return;try{t=i,_.props=t.memoizedProps,_.state=t.memoizedState,_.componentWillUnmount()}catch(m){bd(i,n,m)}}break;case 5:ec(p,p.return);break;case 22:if(null!==p.memoizedState){yc(h);continue}}null!==f?(f.return=p,$a=f):yc(h)}u=u.sibling}e:for(u=null,h=e;;){if(5===h.tag){if(null===u){u=h;try{r=h.stateNode,l?"function"===typeof(s=r.style).setProperty?s.setProperty("display","none","important"):s.display="none":(c=h.stateNode,a=void 0!==(d=h.memoizedProps.style)&&null!==d&&d.hasOwnProperty("display")?d.display:null,c.style.display=_e("display",a))}catch(m){bd(e,e.return,m)}}}else if(6===h.tag){if(null===u)try{h.stateNode.nodeValue=l?"":h.memoizedProps}catch(m){bd(e,e.return,m)}}else if((22!==h.tag&&23!==h.tag||null===h.memoizedState||h===e)&&null!==h.child){h.child.return=h,h=h.child;continue}if(h===e)break e;for(;null===h.sibling;){if(null===h.return||h.return===e)break e;u===h&&(u=null),h=h.return}u===h&&(u=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:mc(t,e),gc(e),4&i&&_c(e);case 21:}}function gc(e){var t=e.flags;if(2&t){try{e:{for(var n=e.return;null!==n;){if(ac(n)){var i=n;break e}n=n.return}throw Error(o(160))}switch(i.tag){case 5:var r=i.stateNode;32&i.flags&&(he(r,""),i.flags&=-33),lc(e,cc(e),r);break;case 3:case 4:var s=i.stateNode.containerInfo;dc(e,cc(e),s);break;default:throw Error(o(161))}}catch(a){bd(e,e.return,a)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function Sc(e,t,n){$a=e,Tc(e,t,n)}function Tc(e,t,n){for(var i=0!==(1&e.mode);null!==$a;){var r=$a,o=r.child;if(22===r.tag&&i){var s=null!==r.memoizedState||Xa;if(!s){var a=r.alternate,c=null!==a&&null!==a.memoizedState||Qa;a=Xa;var d=Qa;if(Xa=s,(Qa=c)&&!d)for($a=r;null!==$a;)c=(s=$a).child,22===s.tag&&null!==s.memoizedState?Rc(r):null!==c?(c.return=s,$a=c):Rc(r);for(;null!==o;)$a=o,Tc(o,t,n),o=o.sibling;$a=r,Xa=a,Qa=d}vc(e)}else 0!==(8772&r.subtreeFlags)&&null!==o?(o.return=r,$a=o):vc(e)}}function vc(e){for(;null!==$a;){var t=$a;if(0!==(8772&t.flags)){var n=t.alternate;try{if(0!==(8772&t.flags))switch(t.tag){case 0:case 11:case 15:Qa||rc(5,t);break;case 1:var i=t.stateNode;if(4&t.flags&&!Qa)if(null===n)i.componentDidMount();else{var r=t.elementType===t.type?n.memoizedProps:Eo(t.type,n.memoizedProps);i.componentDidUpdate(r,n.memoizedState,i.__reactInternalSnapshotBeforeUpdate)}var s=t.updateQueue;null!==s&&Fo(t,s,i);break;case 3:var a=t.updateQueue;if(null!==a){if(n=null,null!==t.child)switch(t.child.tag){case 5:case 1:n=t.child.stateNode}Fo(t,a,n)}break;case 5:var c=t.stateNode;if(null===n&&4&t.flags){n=c;var d=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":d.autoFocus&&n.focus();break;case"img":d.src&&(n.src=d.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var l=t.alternate;if(null!==l){var u=l.memoizedState;if(null!==u){var h=u.dehydrated;null!==h&&Gt(h)}}}break;default:throw Error(o(163))}Qa||512&t.flags&&oc(t)}catch(p){bd(t,t.return,p)}}if(t===e){$a=null;break}if(null!==(n=t.sibling)){n.return=t.return,$a=n;break}$a=t.return}}function yc(e){for(;null!==$a;){var t=$a;if(t===e){$a=null;break}var n=t.sibling;if(null!==n){n.return=t.return,$a=n;break}$a=t.return}}function Rc(e){for(;null!==$a;){var t=$a;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{rc(4,t)}catch(c){bd(t,n,c)}break;case 1:var i=t.stateNode;if("function"===typeof i.componentDidMount){var r=t.return;try{i.componentDidMount()}catch(c){bd(t,r,c)}}var o=t.return;try{oc(t)}catch(c){bd(t,o,c)}break;case 5:var s=t.return;try{oc(t)}catch(c){bd(t,s,c)}}}catch(c){bd(t,t.return,c)}if(t===e){$a=null;break}var a=t.sibling;if(null!==a){a.return=t.return,$a=a;break}$a=t.return}}var Cc,bc=Math.ceil,Ic=T.ReactCurrentDispatcher,wc=T.ReactCurrentOwner,Ac=T.ReactCurrentBatchConfig,Oc=0,Nc=null,Dc=null,Pc=0,kc=0,Lc=Cr(0),Mc=0,Uc=null,xc=0,Vc=0,Fc=0,jc=null,Bc=null,Gc=0,Wc=1/0,Hc=null,Kc=!1,zc=null,Yc=null,qc=!1,Jc=null,Xc=0,Qc=0,Zc=null,$c=-1,ed=0;function td(){return 0!==(6&Oc)?Qe():-1!==$c?$c:$c=Qe()}function nd(e){return 0===(1&e.mode)?1:0!==(2&Oc)&&0!==Pc?Pc&-Pc:null!==mo.transition?(0===ed&&(ed=_t()),ed):0!==(e=St)?e:e=void 0===(e=window.event)?16:Xt(e.type)}function id(e,t,n,i){if(50<Qc)throw Qc=0,Zc=null,Error(o(185));Et(e,n,i),0!==(2&Oc)&&e===Nc||(e===Nc&&(0===(2&Oc)&&(Vc|=n),4===Mc&&cd(e,Pc)),rd(e,i),1===n&&0===Oc&&0===(1&t.mode)&&(Wc=Qe()+500,Fr&&Gr()))}function rd(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.suspendedLanes,i=e.pingedLanes,r=e.expirationTimes,o=e.pendingLanes;0<o;){var s=31-st(o),a=1<<s,c=r[s];-1===c?0!==(a&n)&&0===(a&i)||(r[s]=pt(a,t)):c<=t&&(e.expiredLanes|=a),o&=~a}}(e,t);var i=ht(e,e===Nc?Pc:0);if(0===i)null!==n&&qe(n),e.callbackNode=null,e.callbackPriority=0;else if(t=i&-i,e.callbackPriority!==t){if(null!=n&&qe(n),1===t)0===e.tag?function(e){Fr=!0,Br(e)}(dd.bind(null,e)):Br(dd.bind(null,e)),sr((function(){0===(6&Oc)&&Gr()})),n=null;else{switch(Tt(i)){case 1:n=$e;break;case 4:n=et;break;case 16:default:n=tt;break;case 536870912:n=it}n=Nd(n,od.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function od(e,t){if($c=-1,ed=0,0!==(6&Oc))throw Error(o(327));var n=e.callbackNode;if(Rd()&&e.callbackNode!==n)return null;var i=ht(e,e===Nc?Pc:0);if(0===i)return null;if(0!==(30&i)||0!==(i&e.expiredLanes)||t)t=Ed(e,i);else{t=i;var r=Oc;Oc|=2;var s=_d();for(Nc===e&&Pc===t||(Hc=null,Wc=Qe()+500,pd(e,t));;)try{Sd();break}catch(c){fd(e,c)}yo(),Ic.current=s,Oc=r,null!==Dc?t=0:(Nc=null,Pc=0,t=Mc)}if(0!==t){if(2===t&&(0!==(r=ft(e))&&(i=r,t=sd(e,r))),1===t)throw n=Uc,pd(e,0),cd(e,i),rd(e,Qe()),n;if(6===t)cd(e,i);else{if(r=e.current.alternate,0===(30&i)&&!function(e){for(var t=e;;){if(16384&t.flags){var n=t.updateQueue;if(null!==n&&null!==(n=n.stores))for(var i=0;i<n.length;i++){var r=n[i],o=r.getSnapshot;r=r.value;try{if(!ai(o(),r))return!1}catch(a){return!1}}}if(n=t.child,16384&t.subtreeFlags&&null!==n)n.return=t,t=n;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(r)&&(2===(t=Ed(e,i))&&(0!==(s=ft(e))&&(i=s,t=sd(e,s))),1===t))throw n=Uc,pd(e,0),cd(e,i),rd(e,Qe()),n;switch(e.finishedWork=r,e.finishedLanes=i,t){case 0:case 1:throw Error(o(345));case 2:case 5:yd(e,Bc,Hc);break;case 3:if(cd(e,i),(130023424&i)===i&&10<(t=Gc+500-Qe())){if(0!==ht(e,0))break;if(((r=e.suspendedLanes)&i)!==i){td(),e.pingedLanes|=e.suspendedLanes&r;break}e.timeoutHandle=ir(yd.bind(null,e,Bc,Hc),t);break}yd(e,Bc,Hc);break;case 4:if(cd(e,i),(4194240&i)===i)break;for(t=e.eventTimes,r=-1;0<i;){var a=31-st(i);s=1<<a,(a=t[a])>r&&(r=a),i&=~s}if(i=r,10<(i=(120>(i=Qe()-i)?120:480>i?480:1080>i?1080:1920>i?1920:3e3>i?3e3:4320>i?4320:1960*bc(i/1960))-i)){e.timeoutHandle=ir(yd.bind(null,e,Bc,Hc),i);break}yd(e,Bc,Hc);break;default:throw Error(o(329))}}}return rd(e,Qe()),e.callbackNode===n?od.bind(null,e):null}function sd(e,t){var n=jc;return e.current.memoizedState.isDehydrated&&(pd(e,t).flags|=256),2!==(e=Ed(e,t))&&(t=Bc,Bc=n,null!==t&&ad(t)),e}function ad(e){null===Bc?Bc=e:Bc.push.apply(Bc,e)}function cd(e,t){for(t&=~Fc,t&=~Vc,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-st(t),i=1<<n;e[n]=-1,t&=~i}}function dd(e){if(0!==(6&Oc))throw Error(o(327));Rd();var t=ht(e,0);if(0===(1&t))return rd(e,Qe()),null;var n=Ed(e,t);if(0!==e.tag&&2===n){var i=ft(e);0!==i&&(t=i,n=sd(e,i))}if(1===n)throw n=Uc,pd(e,0),cd(e,t),rd(e,Qe()),n;if(6===n)throw Error(o(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,yd(e,Bc,Hc),rd(e,Qe()),null}function ld(e,t){var n=Oc;Oc|=1;try{return e(t)}finally{0===(Oc=n)&&(Wc=Qe()+500,Fr&&Gr())}}function ud(e){null!==Jc&&0===Jc.tag&&0===(6&Oc)&&Rd();var t=Oc;Oc|=1;var n=Ac.transition,i=St;try{if(Ac.transition=null,St=1,e)return e()}finally{St=i,Ac.transition=n,0===(6&(Oc=t))&&Gr()}}function hd(){kc=Lc.current,br(Lc)}function pd(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(-1!==n&&(e.timeoutHandle=-1,rr(n)),null!==Dc)for(n=Dc.return;null!==n;){var i=n;switch(to(i),i.tag){case 1:null!==(i=i.type.childContextTypes)&&void 0!==i&&kr();break;case 3:os(),br(Or),br(Ar),us();break;case 5:as(i);break;case 4:os();break;case 13:case 19:br(cs);break;case 10:Ro(i.type._context);break;case 22:case 23:hd()}n=n.return}if(Nc=e,Dc=e=Ld(e.current,null),Pc=kc=t,Mc=0,Uc=null,Fc=Vc=xc=0,Bc=jc=null,null!==wo){for(t=0;t<wo.length;t++)if(null!==(i=(n=wo[t]).interleaved)){n.interleaved=null;var r=i.next,o=n.pending;if(null!==o){var s=o.next;o.next=r,i.next=s}n.pending=i}wo=null}return e}function fd(e,t){for(;;){var n=Dc;try{if(yo(),hs.current=sa,gs){for(var i=_s.memoizedState;null!==i;){var r=i.queue;null!==r&&(r.pending=null),i=i.next}gs=!1}if(fs=0,Es=ms=_s=null,Ss=!1,Ts=0,wc.current=null,null===n||null===n.return){Mc=1,Uc=t,Dc=null;break}e:{var s=e,a=n.return,c=n,d=t;if(t=Pc,c.flags|=32768,null!==d&&"object"===typeof d&&"function"===typeof d.then){var l=d,u=c,h=u.tag;if(0===(1&u.mode)&&(0===h||11===h||15===h)){var p=u.alternate;p?(u.updateQueue=p.updateQueue,u.memoizedState=p.memoizedState,u.lanes=p.lanes):(u.updateQueue=null,u.memoizedState=null)}var f=Ea(a);if(null!==f){f.flags&=-257,ga(f,a,c,0,t),1&f.mode&&ma(s,l,t),d=l;var _=(t=f).updateQueue;if(null===_){var m=new Set;m.add(d),t.updateQueue=m}else _.add(d);break e}if(0===(1&t)){ma(s,l,t),md();break e}d=Error(o(426))}else if(ro&&1&c.mode){var E=Ea(a);if(null!==E){0===(65536&E.flags)&&(E.flags|=256),ga(E,a,c,0,t),_o(la(d,c));break e}}s=d=la(d,c),4!==Mc&&(Mc=2),null===jc?jc=[s]:jc.push(s),s=a;do{switch(s.tag){case 3:s.flags|=65536,t&=-t,s.lanes|=t,xo(s,fa(0,d,t));break e;case 1:c=d;var g=s.type,S=s.stateNode;if(0===(128&s.flags)&&("function"===typeof g.getDerivedStateFromError||null!==S&&"function"===typeof S.componentDidCatch&&(null===Yc||!Yc.has(S)))){s.flags|=65536,t&=-t,s.lanes|=t,xo(s,_a(s,c,t));break e}}s=s.return}while(null!==s)}vd(n)}catch(T){t=T,Dc===n&&null!==n&&(Dc=n=n.return);continue}break}}function _d(){var e=Ic.current;return Ic.current=sa,null===e?sa:e}function md(){0!==Mc&&3!==Mc&&2!==Mc||(Mc=4),null===Nc||0===(268435455&xc)&&0===(268435455&Vc)||cd(Nc,Pc)}function Ed(e,t){var n=Oc;Oc|=2;var i=_d();for(Nc===e&&Pc===t||(Hc=null,pd(e,t));;)try{gd();break}catch(r){fd(e,r)}if(yo(),Oc=n,Ic.current=i,null!==Dc)throw Error(o(261));return Nc=null,Pc=0,Mc}function gd(){for(;null!==Dc;)Td(Dc)}function Sd(){for(;null!==Dc&&!Je();)Td(Dc)}function Td(e){var t=Cc(e.alternate,e,kc);e.memoizedProps=e.pendingProps,null===t?vd(e):Dc=t,wc.current=null}function vd(e){var t=e;do{var n=t.alternate;if(e=t.return,0===(32768&t.flags)){if(null!==(n=qa(n,t,kc)))return void(Dc=n)}else{if(null!==(n=Ja(n,t)))return n.flags&=32767,void(Dc=n);if(null===e)return Mc=6,void(Dc=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}if(null!==(t=t.sibling))return void(Dc=t);Dc=t=e}while(null!==t);0===Mc&&(Mc=5)}function yd(e,t,n){var i=St,r=Ac.transition;try{Ac.transition=null,St=1,function(e,t,n,i){do{Rd()}while(null!==Jc);if(0!==(6&Oc))throw Error(o(327));n=e.finishedWork;var r=e.finishedLanes;if(null===n)return null;if(e.finishedWork=null,e.finishedLanes=0,n===e.current)throw Error(o(177));e.callbackNode=null,e.callbackPriority=0;var s=n.lanes|n.childLanes;if(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var i=e.eventTimes;for(e=e.expirationTimes;0<n;){var r=31-st(n),o=1<<r;t[r]=0,i[r]=-1,e[r]=-1,n&=~o}}(e,s),e===Nc&&(Dc=Nc=null,Pc=0),0===(2064&n.subtreeFlags)&&0===(2064&n.flags)||qc||(qc=!0,Nd(tt,(function(){return Rd(),null}))),s=0!==(15990&n.flags),0!==(15990&n.subtreeFlags)||s){s=Ac.transition,Ac.transition=null;var a=St;St=1;var c=Oc;Oc|=4,wc.current=null,function(e,t){if(er=Ht,pi(e=hi())){if("selectionStart"in e)var n={start:e.selectionStart,end:e.selectionEnd};else e:{var i=(n=(n=e.ownerDocument)&&n.defaultView||window).getSelection&&n.getSelection();if(i&&0!==i.rangeCount){n=i.anchorNode;var r=i.anchorOffset,s=i.focusNode;i=i.focusOffset;try{n.nodeType,s.nodeType}catch(v){n=null;break e}var a=0,c=-1,d=-1,l=0,u=0,h=e,p=null;t:for(;;){for(var f;h!==n||0!==r&&3!==h.nodeType||(c=a+r),h!==s||0!==i&&3!==h.nodeType||(d=a+i),3===h.nodeType&&(a+=h.nodeValue.length),null!==(f=h.firstChild);)p=h,h=f;for(;;){if(h===e)break t;if(p===n&&++l===r&&(c=a),p===s&&++u===i&&(d=a),null!==(f=h.nextSibling))break;p=(h=p).parentNode}h=f}n=-1===c||-1===d?null:{start:c,end:d}}else n=null}n=n||{start:0,end:0}}else n=null;for(tr={focusedElem:e,selectionRange:n},Ht=!1,$a=t;null!==$a;)if(e=(t=$a).child,0!==(1028&t.subtreeFlags)&&null!==e)e.return=t,$a=e;else for(;null!==$a;){t=$a;try{var _=t.alternate;if(0!==(1024&t.flags))switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==_){var m=_.memoizedProps,E=_.memoizedState,g=t.stateNode,S=g.getSnapshotBeforeUpdate(t.elementType===t.type?m:Eo(t.type,m),E);g.__reactInternalSnapshotBeforeUpdate=S}break;case 3:var T=t.stateNode.containerInfo;1===T.nodeType?T.textContent="":9===T.nodeType&&T.documentElement&&T.removeChild(T.documentElement);break;default:throw Error(o(163))}}catch(v){bd(t,t.return,v)}if(null!==(e=t.sibling)){e.return=t.return,$a=e;break}$a=t.return}_=nc,nc=!1}(e,n),Ec(n,e),fi(tr),Ht=!!er,tr=er=null,e.current=n,Sc(n,e,r),Xe(),Oc=c,St=a,Ac.transition=s}else e.current=n;if(qc&&(qc=!1,Jc=e,Xc=r),s=e.pendingLanes,0===s&&(Yc=null),function(e){if(ot&&"function"===typeof ot.onCommitFiberRoot)try{ot.onCommitFiberRoot(rt,e,void 0,128===(128&e.current.flags))}catch(t){}}(n.stateNode),rd(e,Qe()),null!==t)for(i=e.onRecoverableError,n=0;n<t.length;n++)r=t[n],i(r.value,{componentStack:r.stack,digest:r.digest});if(Kc)throw Kc=!1,e=zc,zc=null,e;0!==(1&Xc)&&0!==e.tag&&Rd(),s=e.pendingLanes,0!==(1&s)?e===Zc?Qc++:(Qc=0,Zc=e):Qc=0,Gr()}(e,t,n,i)}finally{Ac.transition=r,St=i}return null}function Rd(){if(null!==Jc){var e=Tt(Xc),t=Ac.transition,n=St;try{if(Ac.transition=null,St=16>e?16:e,null===Jc)var i=!1;else{if(e=Jc,Jc=null,Xc=0,0!==(6&Oc))throw Error(o(331));var r=Oc;for(Oc|=4,$a=e.current;null!==$a;){var s=$a,a=s.child;if(0!==(16&$a.flags)){var c=s.deletions;if(null!==c){for(var d=0;d<c.length;d++){var l=c[d];for($a=l;null!==$a;){var u=$a;switch(u.tag){case 0:case 11:case 15:ic(8,u,s)}var h=u.child;if(null!==h)h.return=u,$a=h;else for(;null!==$a;){var p=(u=$a).sibling,f=u.return;if(sc(u),u===l){$a=null;break}if(null!==p){p.return=f,$a=p;break}$a=f}}}var _=s.alternate;if(null!==_){var m=_.child;if(null!==m){_.child=null;do{var E=m.sibling;m.sibling=null,m=E}while(null!==m)}}$a=s}}if(0!==(2064&s.subtreeFlags)&&null!==a)a.return=s,$a=a;else e:for(;null!==$a;){if(0!==(2048&(s=$a).flags))switch(s.tag){case 0:case 11:case 15:ic(9,s,s.return)}var g=s.sibling;if(null!==g){g.return=s.return,$a=g;break e}$a=s.return}}var S=e.current;for($a=S;null!==$a;){var T=(a=$a).child;if(0!==(2064&a.subtreeFlags)&&null!==T)T.return=a,$a=T;else e:for(a=S;null!==$a;){if(0!==(2048&(c=$a).flags))try{switch(c.tag){case 0:case 11:case 15:rc(9,c)}}catch(y){bd(c,c.return,y)}if(c===a){$a=null;break e}var v=c.sibling;if(null!==v){v.return=c.return,$a=v;break e}$a=c.return}}if(Oc=r,Gr(),ot&&"function"===typeof ot.onPostCommitFiberRoot)try{ot.onPostCommitFiberRoot(rt,e)}catch(y){}i=!0}return i}finally{St=n,Ac.transition=t}}return!1}function Cd(e,t,n){e=Mo(e,t=fa(0,t=la(n,t),1),1),t=td(),null!==e&&(Et(e,1,t),rd(e,t))}function bd(e,t,n){if(3===e.tag)Cd(e,e,n);else for(;null!==t;){if(3===t.tag){Cd(t,e,n);break}if(1===t.tag){var i=t.stateNode;if("function"===typeof t.type.getDerivedStateFromError||"function"===typeof i.componentDidCatch&&(null===Yc||!Yc.has(i))){t=Mo(t,e=_a(t,e=la(n,e),1),1),e=td(),null!==t&&(Et(t,1,e),rd(t,e));break}}t=t.return}}function Id(e,t,n){var i=e.pingCache;null!==i&&i.delete(t),t=td(),e.pingedLanes|=e.suspendedLanes&n,Nc===e&&(Pc&n)===n&&(4===Mc||3===Mc&&(130023424&Pc)===Pc&&500>Qe()-Gc?pd(e,0):Fc|=n),rd(e,t)}function wd(e,t){0===t&&(0===(1&e.mode)?t=1:(t=lt,0===(130023424&(lt<<=1))&&(lt=4194304)));var n=td();null!==(e=No(e,t))&&(Et(e,t,n),rd(e,n))}function Ad(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),wd(e,n)}function Od(e,t){var n=0;switch(e.tag){case 13:var i=e.stateNode,r=e.memoizedState;null!==r&&(n=r.retryLane);break;case 19:i=e.stateNode;break;default:throw Error(o(314))}null!==i&&i.delete(t),wd(e,n)}function Nd(e,t){return Ye(e,t)}function Dd(e,t,n,i){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Pd(e,t,n,i){return new Dd(e,t,n,i)}function kd(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Ld(e,t){var n=e.alternate;return null===n?((n=Pd(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=14680064&e.flags,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function Md(e,t,n,i,r,s){var a=2;if(i=e,"function"===typeof e)kd(e)&&(a=1);else if("string"===typeof e)a=5;else e:switch(e){case R:return Ud(n.children,r,s,t);case C:a=8,r|=8;break;case b:return(e=Pd(12,n,t,2|r)).elementType=b,e.lanes=s,e;case O:return(e=Pd(13,n,t,r)).elementType=O,e.lanes=s,e;case N:return(e=Pd(19,n,t,r)).elementType=N,e.lanes=s,e;case k:return xd(n,r,s,t);default:if("object"===typeof e&&null!==e)switch(e.$$typeof){case I:a=10;break e;case w:a=9;break e;case A:a=11;break e;case D:a=14;break e;case P:a=16,i=null;break e}throw Error(o(130,null==e?e:typeof e,""))}return(t=Pd(a,n,t,r)).elementType=e,t.type=i,t.lanes=s,t}function Ud(e,t,n,i){return(e=Pd(7,e,i,t)).lanes=n,e}function xd(e,t,n,i){return(e=Pd(22,e,i,t)).elementType=k,e.lanes=n,e.stateNode={isHidden:!1},e}function Vd(e,t,n){return(e=Pd(6,e,null,t)).lanes=n,e}function Fd(e,t,n){return(t=Pd(4,null!==e.children?e.children:[],e.key,t)).lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function jd(e,t,n,i,r){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=mt(0),this.expirationTimes=mt(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=mt(0),this.identifierPrefix=i,this.onRecoverableError=r,this.mutableSourceEagerHydrationData=null}function Bd(e,t,n,i,r,o,s,a,c){return e=new jd(e,t,n,a,c),1===t?(t=1,!0===o&&(t|=8)):t=0,o=Pd(3,null,null,t),e.current=o,o.stateNode=e,o.memoizedState={element:i,isDehydrated:n,cache:null,transitions:null,pendingSuspenseBoundaries:null},Po(o),e}function Gd(e){if(!e)return wr;e:{if(Ge(e=e._reactInternals)!==e||1!==e.tag)throw Error(o(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(Pr(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(o(171))}if(1===e.tag){var n=e.type;if(Pr(n))return Mr(e,n,t)}return t}function Wd(e,t,n,i,r,o,s,a,c){return(e=Bd(n,i,!0,e,0,o,0,a,c)).context=Gd(null),n=e.current,(o=Lo(i=td(),r=nd(n))).callback=void 0!==t&&null!==t?t:null,Mo(n,o,r),e.current.lanes=r,Et(e,r,i),rd(e,i),e}function Hd(e,t,n,i){var r=t.current,o=td(),s=nd(r);return n=Gd(n),null===t.context?t.context=n:t.pendingContext=n,(t=Lo(o,s)).payload={element:e},null!==(i=void 0===i?null:i)&&(t.callback=i),null!==(e=Mo(r,t,s))&&(id(e,r,s,o),Uo(e,r,s)),s}function Kd(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function zd(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var n=e.retryLane;e.retryLane=0!==n&&n<t?n:t}}function Yd(e,t){zd(e,t),(e=e.alternate)&&zd(e,t)}Cc=function(e,t,n){if(null!==e)if(e.memoizedProps!==t.pendingProps||Or.current)Ta=!0;else{if(0===(e.lanes&n)&&0===(128&t.flags))return Ta=!1,function(e,t,n){switch(t.tag){case 3:Na(t),fo();break;case 5:ss(t);break;case 1:Pr(t.type)&&Ur(t);break;case 4:rs(t,t.stateNode.containerInfo);break;case 10:var i=t.type._context,r=t.memoizedProps.value;Ir(go,i._currentValue),i._currentValue=r;break;case 13:if(null!==(i=t.memoizedState))return null!==i.dehydrated?(Ir(cs,1&cs.current),t.flags|=128,null):0!==(n&t.child.childLanes)?Va(e,t,n):(Ir(cs,1&cs.current),null!==(e=Ka(e,t,n))?e.sibling:null);Ir(cs,1&cs.current);break;case 19:if(i=0!==(n&t.childLanes),0!==(128&e.flags)){if(i)return Wa(e,t,n);t.flags|=128}if(null!==(r=t.memoizedState)&&(r.rendering=null,r.tail=null,r.lastEffect=null),Ir(cs,cs.current),i)break;return null;case 22:case 23:return t.lanes=0,ba(e,t,n)}return Ka(e,t,n)}(e,t,n);Ta=0!==(131072&e.flags)}else Ta=!1,ro&&0!==(1048576&t.flags)&&$r(t,zr,t.index);switch(t.lanes=0,t.tag){case 2:var i=t.type;Ha(e,t),e=t.pendingProps;var r=Dr(t,Ar.current);bo(t,n),r=Cs(null,t,i,e,r,n);var s=bs();return t.flags|=1,"object"===typeof r&&null!==r&&"function"===typeof r.render&&void 0===r.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,Pr(i)?(s=!0,Ur(t)):s=!1,t.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,Po(t),r.updater=Go,t.stateNode=r,r._reactInternals=t,zo(t,i,e,n),t=Oa(null,t,i,!0,s,n)):(t.tag=0,ro&&s&&eo(t),va(null,t,r,n),t=t.child),t;case 16:i=t.elementType;e:{switch(Ha(e,t),e=t.pendingProps,i=(r=i._init)(i._payload),t.type=i,r=t.tag=function(e){if("function"===typeof e)return kd(e)?1:0;if(void 0!==e&&null!==e){if((e=e.$$typeof)===A)return 11;if(e===D)return 14}return 2}(i),e=Eo(i,e),r){case 0:t=wa(null,t,i,e,n);break e;case 1:t=Aa(null,t,i,e,n);break e;case 11:t=ya(null,t,i,e,n);break e;case 14:t=Ra(null,t,i,Eo(i.type,e),n);break e}throw Error(o(306,i,""))}return t;case 0:return i=t.type,r=t.pendingProps,wa(e,t,i,r=t.elementType===i?r:Eo(i,r),n);case 1:return i=t.type,r=t.pendingProps,Aa(e,t,i,r=t.elementType===i?r:Eo(i,r),n);case 3:e:{if(Na(t),null===e)throw Error(o(387));i=t.pendingProps,r=(s=t.memoizedState).element,ko(e,t),Vo(t,i,null,n);var a=t.memoizedState;if(i=a.element,s.isDehydrated){if(s={element:i,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},t.updateQueue.baseState=s,t.memoizedState=s,256&t.flags){t=Da(e,t,i,n,r=la(Error(o(423)),t));break e}if(i!==r){t=Da(e,t,i,n,r=la(Error(o(424)),t));break e}for(io=dr(t.stateNode.containerInfo.firstChild),no=t,ro=!0,oo=null,n=Zo(t,null,i,n),t.child=n;n;)n.flags=-3&n.flags|4096,n=n.sibling}else{if(fo(),i===r){t=Ka(e,t,n);break e}va(e,t,i,n)}t=t.child}return t;case 5:return ss(t),null===e&&lo(t),i=t.type,r=t.pendingProps,s=null!==e?e.memoizedProps:null,a=r.children,nr(i,r)?a=null:null!==s&&nr(i,s)&&(t.flags|=32),Ia(e,t),va(e,t,a,n),t.child;case 6:return null===e&&lo(t),null;case 13:return Va(e,t,n);case 4:return rs(t,t.stateNode.containerInfo),i=t.pendingProps,null===e?t.child=Qo(t,null,i,n):va(e,t,i,n),t.child;case 11:return i=t.type,r=t.pendingProps,ya(e,t,i,r=t.elementType===i?r:Eo(i,r),n);case 7:return va(e,t,t.pendingProps,n),t.child;case 8:case 12:return va(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(i=t.type._context,r=t.pendingProps,s=t.memoizedProps,a=r.value,Ir(go,i._currentValue),i._currentValue=a,null!==s)if(ai(s.value,a)){if(s.children===r.children&&!Or.current){t=Ka(e,t,n);break e}}else for(null!==(s=t.child)&&(s.return=t);null!==s;){var c=s.dependencies;if(null!==c){a=s.child;for(var d=c.firstContext;null!==d;){if(d.context===i){if(1===s.tag){(d=Lo(-1,n&-n)).tag=2;var l=s.updateQueue;if(null!==l){var u=(l=l.shared).pending;null===u?d.next=d:(d.next=u.next,u.next=d),l.pending=d}}s.lanes|=n,null!==(d=s.alternate)&&(d.lanes|=n),Co(s.return,n,t),c.lanes|=n;break}d=d.next}}else if(10===s.tag)a=s.type===t.type?null:s.child;else if(18===s.tag){if(null===(a=s.return))throw Error(o(341));a.lanes|=n,null!==(c=a.alternate)&&(c.lanes|=n),Co(a,n,t),a=s.sibling}else a=s.child;if(null!==a)a.return=s;else for(a=s;null!==a;){if(a===t){a=null;break}if(null!==(s=a.sibling)){s.return=a.return,a=s;break}a=a.return}s=a}va(e,t,r.children,n),t=t.child}return t;case 9:return r=t.type,i=t.pendingProps.children,bo(t,n),i=i(r=Io(r)),t.flags|=1,va(e,t,i,n),t.child;case 14:return r=Eo(i=t.type,t.pendingProps),Ra(e,t,i,r=Eo(i.type,r),n);case 15:return Ca(e,t,t.type,t.pendingProps,n);case 17:return i=t.type,r=t.pendingProps,r=t.elementType===i?r:Eo(i,r),Ha(e,t),t.tag=1,Pr(i)?(e=!0,Ur(t)):e=!1,bo(t,n),Ho(t,i,r),zo(t,i,r,n),Oa(null,t,i,!0,e,n);case 19:return Wa(e,t,n);case 22:return ba(e,t,n)}throw Error(o(156,t.tag))};var qd="function"===typeof reportError?reportError:function(e){console.error(e)};function Jd(e){this._internalRoot=e}function Xd(e){this._internalRoot=e}function Qd(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Zd(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function $d(){}function el(e,t,n,i,r){var o=n._reactRootContainer;if(o){var s=o;if("function"===typeof r){var a=r;r=function(){var e=Kd(s);a.call(e)}}Hd(t,s,e,r)}else s=function(e,t,n,i,r){if(r){if("function"===typeof i){var o=i;i=function(){var e=Kd(s);o.call(e)}}var s=Wd(t,i,e,0,null,!1,0,"",$d);return e._reactRootContainer=s,e[fr]=s.current,Gi(8===e.nodeType?e.parentNode:e),ud(),s}for(;r=e.lastChild;)e.removeChild(r);if("function"===typeof i){var a=i;i=function(){var e=Kd(c);a.call(e)}}var c=Bd(e,0,!1,null,0,!1,0,"",$d);return e._reactRootContainer=c,e[fr]=c.current,Gi(8===e.nodeType?e.parentNode:e),ud((function(){Hd(t,c,n,i)})),c}(n,t,e,r,i);return Kd(s)}Xd.prototype.render=Jd.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(o(409));Hd(e,t,null,null)},Xd.prototype.unmount=Jd.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;ud((function(){Hd(null,e,null,null)})),t[fr]=null}},Xd.prototype.unstable_scheduleHydration=function(e){if(e){var t=Ct();e={blockedOn:null,target:e,priority:t};for(var n=0;n<kt.length&&0!==t&&t<kt[n].priority;n++);kt.splice(n,0,e),0===n&&xt(e)}},vt=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=ut(t.pendingLanes);0!==n&&(gt(t,1|n),rd(t,Qe()),0===(6&Oc)&&(Wc=Qe()+500,Gr()))}break;case 13:ud((function(){var t=No(e,1);if(null!==t){var n=td();id(t,e,1,n)}})),Yd(e,1)}},yt=function(e){if(13===e.tag){var t=No(e,134217728);if(null!==t)id(t,e,134217728,td());Yd(e,134217728)}},Rt=function(e){if(13===e.tag){var t=nd(e),n=No(e,t);if(null!==n)id(n,e,t,td());Yd(e,t)}},Ct=function(){return St},bt=function(e,t){var n=St;try{return St=e,t()}finally{St=n}},ye=function(e,t,n){switch(t){case"input":if(Z(e,n),t=n.name,"radio"===n.type&&null!=t){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var i=n[t];if(i!==e&&i.form===e.form){var r=vr(i);if(!r)throw Error(o(90));Y(i),Z(i,r)}}}break;case"textarea":oe(e,n);break;case"select":null!=(t=n.value)&&ne(e,!!n.multiple,t,!1)}},Ae=ld,Oe=ud;var tl={usingClientEntryPoint:!1,Events:[Sr,Tr,vr,Ie,we,ld]},nl={findFiberByHostInstance:gr,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},il={bundleType:nl.bundleType,version:nl.version,rendererPackageName:nl.rendererPackageName,rendererConfig:nl.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:T.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Ke(e))?null:e.stateNode},findFiberByHostInstance:nl.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var rl=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!rl.isDisabled&&rl.supportsFiber)try{rt=rl.inject(il),ot=rl}catch(le){}}t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=tl,t.createPortal=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Qd(t))throw Error(o(200));return function(e,t,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:y,key:null==i?null:""+i,children:e,containerInfo:t,implementation:n}}(e,t,null,n)},t.createRoot=function(e,t){if(!Qd(e))throw Error(o(299));var n=!1,i="",r=qd;return null!==t&&void 0!==t&&(!0===t.unstable_strictMode&&(n=!0),void 0!==t.identifierPrefix&&(i=t.identifierPrefix),void 0!==t.onRecoverableError&&(r=t.onRecoverableError)),t=Bd(e,1,!1,null,0,n,0,i,r),e[fr]=t.current,Gi(8===e.nodeType?e.parentNode:e),new Jd(t)},t.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"===typeof e.render)throw Error(o(188));throw e=Object.keys(e).join(","),Error(o(268,e))}return e=null===(e=Ke(t))?null:e.stateNode},t.flushSync=function(e){return ud(e)},t.hydrate=function(e,t,n){if(!Zd(t))throw Error(o(200));return el(null,e,t,!0,n)},t.hydrateRoot=function(e,t,n){if(!Qd(e))throw Error(o(405));var i=null!=n&&n.hydratedSources||null,r=!1,s="",a=qd;if(null!==n&&void 0!==n&&(!0===n.unstable_strictMode&&(r=!0),void 0!==n.identifierPrefix&&(s=n.identifierPrefix),void 0!==n.onRecoverableError&&(a=n.onRecoverableError)),t=Wd(t,null,e,1,null!=n?n:null,r,0,s,a),e[fr]=t.current,Gi(e),i)for(e=0;e<i.length;e++)r=(r=(n=i[e])._getVersion)(n._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[n,r]:t.mutableSourceEagerHydrationData.push(n,r);return new Xd(t)},t.render=function(e,t,n){if(!Zd(t))throw Error(o(200));return el(null,e,t,!1,n)},t.unmountComponentAtNode=function(e){if(!Zd(e))throw Error(o(40));return!!e._reactRootContainer&&(ud((function(){el(null,null,e,!1,(function(){e._reactRootContainer=null,e[fr]=null}))})),!0)},t.unstable_batchedUpdates=ld,t.unstable_renderSubtreeIntoContainer=function(e,t,n,i){if(!Zd(n))throw Error(o(200));if(null==e||void 0===e._reactInternals)throw Error(o(38));return el(e,t,n,!1,i)},t.version="18.2.0-next-9e3b772b8-20220608"},250:(e,t,n)=>{"use strict";var i=n(164);t.createRoot=i.createRoot,t.hydrateRoot=i.hydrateRoot},164:(e,t,n)=>{"use strict";!function e(){if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}(),e.exports=n(463)},374:(e,t,n)=>{"use strict";var i=n(791),r=Symbol.for("react.element"),o=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,a=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function d(e,t,n){var i,o={},d=null,l=null;for(i in void 0!==n&&(d=""+n),void 0!==t.key&&(d=""+t.key),void 0!==t.ref&&(l=t.ref),t)s.call(t,i)&&!c.hasOwnProperty(i)&&(o[i]=t[i]);if(e&&e.defaultProps)for(i in t=e.defaultProps)void 0===o[i]&&(o[i]=t[i]);return{$$typeof:r,type:e,key:d,ref:l,props:o,_owner:a.current}}t.jsx=d,t.jsxs=d},117:(e,t)=>{"use strict";var n=Symbol.for("react.element"),i=Symbol.for("react.portal"),r=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),c=Symbol.for("react.context"),d=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),u=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),p=Symbol.iterator;var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},_=Object.assign,m={};function E(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||f}function g(){}function S(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||f}E.prototype.isReactComponent={},E.prototype.setState=function(e,t){if("object"!==typeof e&&"function"!==typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},E.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},g.prototype=E.prototype;var T=S.prototype=new g;T.constructor=S,_(T,E.prototype),T.isPureReactComponent=!0;var v=Array.isArray,y=Object.prototype.hasOwnProperty,R={current:null},C={key:!0,ref:!0,__self:!0,__source:!0};function b(e,t,i){var r,o={},s=null,a=null;if(null!=t)for(r in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(s=""+t.key),t)y.call(t,r)&&!C.hasOwnProperty(r)&&(o[r]=t[r]);var c=arguments.length-2;if(1===c)o.children=i;else if(1<c){for(var d=Array(c),l=0;l<c;l++)d[l]=arguments[l+2];o.children=d}if(e&&e.defaultProps)for(r in c=e.defaultProps)void 0===o[r]&&(o[r]=c[r]);return{$$typeof:n,type:e,key:s,ref:a,props:o,_owner:R.current}}function I(e){return"object"===typeof e&&null!==e&&e.$$typeof===n}var w=/\/+/g;function A(e,t){return"object"===typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function O(e,t,r,o,s){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var c=!1;if(null===e)c=!0;else switch(a){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case i:c=!0}}if(c)return s=s(c=e),e=""===o?"."+A(c,0):o,v(s)?(r="",null!=e&&(r=e.replace(w,"$&/")+"/"),O(s,t,r,"",(function(e){return e}))):null!=s&&(I(s)&&(s=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,r+(!s.key||c&&c.key===s.key?"":(""+s.key).replace(w,"$&/")+"/")+e)),t.push(s)),1;if(c=0,o=""===o?".":o+":",v(e))for(var d=0;d<e.length;d++){var l=o+A(a=e[d],d);c+=O(a,t,r,l,s)}else if(l=function(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e),"function"===typeof l)for(e=l.call(e),d=0;!(a=e.next()).done;)c+=O(a=a.value,t,r,l=o+A(a,d++),s);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function N(e,t,n){if(null==e)return e;var i=[],r=0;return O(e,i,"","",(function(e){return t.call(n,e,r++)})),i}function D(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var P={current:null},k={transition:null},L={ReactCurrentDispatcher:P,ReactCurrentBatchConfig:k,ReactCurrentOwner:R};t.Children={map:N,forEach:function(e,t,n){N(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return N(e,(function(){t++})),t},toArray:function(e){return N(e,(function(e){return e}))||[]},only:function(e){if(!I(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=E,t.Fragment=r,t.Profiler=s,t.PureComponent=S,t.StrictMode=o,t.Suspense=l,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=L,t.cloneElement=function(e,t,i){if(null===e||void 0===e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var r=_({},e.props),o=e.key,s=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,a=R.current),void 0!==t.key&&(o=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(d in t)y.call(t,d)&&!C.hasOwnProperty(d)&&(r[d]=void 0===t[d]&&void 0!==c?c[d]:t[d])}var d=arguments.length-2;if(1===d)r.children=i;else if(1<d){c=Array(d);for(var l=0;l<d;l++)c[l]=arguments[l+2];r.children=c}return{$$typeof:n,type:e.type,key:o,ref:s,props:r,_owner:a}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=b,t.createFactory=function(e){var t=b.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:d,render:e}},t.isValidElement=I,t.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:D}},t.memo=function(e,t){return{$$typeof:u,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=k.transition;k.transition={};try{e()}finally{k.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return P.current.useCallback(e,t)},t.useContext=function(e){return P.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return P.current.useDeferredValue(e)},t.useEffect=function(e,t){return P.current.useEffect(e,t)},t.useId=function(){return P.current.useId()},t.useImperativeHandle=function(e,t,n){return P.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return P.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return P.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return P.current.useMemo(e,t)},t.useReducer=function(e,t,n){return P.current.useReducer(e,t,n)},t.useRef=function(e){return P.current.useRef(e)},t.useState=function(e){return P.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return P.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return P.current.useTransition()},t.version="18.2.0"},791:(e,t,n)=>{"use strict";e.exports=n(117)},184:(e,t,n)=>{"use strict";e.exports=n(374)},813:(e,t)=>{"use strict";function n(e,t){var n=e.length;e.push(t);e:for(;0<n;){var i=n-1>>>1,r=e[i];if(!(0<o(r,t)))break e;e[i]=t,e[n]=r,n=i}}function i(e){return 0===e.length?null:e[0]}function r(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var i=0,r=e.length,s=r>>>1;i<s;){var a=2*(i+1)-1,c=e[a],d=a+1,l=e[d];if(0>o(c,n))d<r&&0>o(l,c)?(e[i]=l,e[d]=n,i=d):(e[i]=c,e[a]=n,i=a);else{if(!(d<r&&0>o(l,n)))break e;e[i]=l,e[d]=n,i=d}}}return t}function o(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"===typeof performance&&"function"===typeof performance.now){var s=performance;t.unstable_now=function(){return s.now()}}else{var a=Date,c=a.now();t.unstable_now=function(){return a.now()-c}}var d=[],l=[],u=1,h=null,p=3,f=!1,_=!1,m=!1,E="function"===typeof setTimeout?setTimeout:null,g="function"===typeof clearTimeout?clearTimeout:null,S="undefined"!==typeof setImmediate?setImmediate:null;function T(e){for(var t=i(l);null!==t;){if(null===t.callback)r(l);else{if(!(t.startTime<=e))break;r(l),t.sortIndex=t.expirationTime,n(d,t)}t=i(l)}}function v(e){if(m=!1,T(e),!_)if(null!==i(d))_=!0,k(y);else{var t=i(l);null!==t&&L(v,t.startTime-e)}}function y(e,n){_=!1,m&&(m=!1,g(I),I=-1),f=!0;var o=p;try{for(T(n),h=i(d);null!==h&&(!(h.expirationTime>n)||e&&!O());){var s=h.callback;if("function"===typeof s){h.callback=null,p=h.priorityLevel;var a=s(h.expirationTime<=n);n=t.unstable_now(),"function"===typeof a?h.callback=a:h===i(d)&&r(d),T(n)}else r(d);h=i(d)}if(null!==h)var c=!0;else{var u=i(l);null!==u&&L(v,u.startTime-n),c=!1}return c}finally{h=null,p=o,f=!1}}"undefined"!==typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var R,C=!1,b=null,I=-1,w=5,A=-1;function O(){return!(t.unstable_now()-A<w)}function N(){if(null!==b){var e=t.unstable_now();A=e;var n=!0;try{n=b(!0,e)}finally{n?R():(C=!1,b=null)}}else C=!1}if("function"===typeof S)R=function(){S(N)};else if("undefined"!==typeof MessageChannel){var D=new MessageChannel,P=D.port2;D.port1.onmessage=N,R=function(){P.postMessage(null)}}else R=function(){E(N,0)};function k(e){b=e,C||(C=!0,R())}function L(e,n){I=E((function(){e(t.unstable_now())}),n)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){_||f||(_=!0,k(y))},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):w=0<e?Math.floor(1e3/e):5},t.unstable_getCurrentPriorityLevel=function(){return p},t.unstable_getFirstCallbackNode=function(){return i(d)},t.unstable_next=function(e){switch(p){case 1:case 2:case 3:var t=3;break;default:t=p}var n=p;p=t;try{return e()}finally{p=n}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=p;p=e;try{return t()}finally{p=n}},t.unstable_scheduleCallback=function(e,r,o){var s=t.unstable_now();switch("object"===typeof o&&null!==o?o="number"===typeof(o=o.delay)&&0<o?s+o:s:o=s,e){case 1:var a=-1;break;case 2:a=250;break;case 5:a=1073741823;break;case 4:a=1e4;break;default:a=5e3}return e={id:u++,callback:r,priorityLevel:e,startTime:o,expirationTime:a=o+a,sortIndex:-1},o>s?(e.sortIndex=o,n(l,e),null===i(d)&&e===i(l)&&(m?(g(I),I=-1):m=!0,L(v,o-s))):(e.sortIndex=a,n(d,e),_||f||(_=!0,k(y))),e},t.unstable_shouldYield=O,t.unstable_wrapCallback=function(e){var t=p;return function(){var n=p;p=t;try{return e.apply(this,arguments)}finally{p=n}}}},296:(e,t,n)=>{"use strict";e.exports=n(813)}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},(()=>{var e,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__;n.t=function(i,r){if(1&r&&(i=this(i)),8&r)return i;if("object"===typeof i&&i){if(4&r&&i.__esModule)return i;if(16&r&&"function"===typeof i.then)return i}var o=Object.create(null);n.r(o);var s={};e=e||[null,t({}),t([]),t(t)];for(var a=2&r&&i;"object"==typeof a&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach((e=>s[e]=()=>i[e]));return s.default=()=>i,n.d(o,s),o}})(),n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e={};n.r(e),n.d(e,{hasBrowserEnv:()=>un,hasStandardBrowserEnv:()=>hn,hasStandardBrowserWebWorkerEnv:()=>fn});var t={};n.r(t),n.d(t,{Decoder:()=>Er,Encoder:()=>_r,PacketType:()=>fr,protocol:()=>pr});var i,r=n(791),o=n.t(r,2),s=n(250);function a(){return a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},a.apply(this,arguments)}!function(e){e.Pop="POP",e.Push="PUSH",e.Replace="REPLACE"}(i||(i={}));const c="popstate";function d(e,t){if(!1===e||null===e||"undefined"===typeof e)throw new Error(t)}function l(e,t){if(!e){"undefined"!==typeof console&&console.warn(t);try{throw new Error(t)}catch(n){}}}function u(e,t){return{usr:e.state,key:e.key,idx:t}}function h(e,t,n,i){return void 0===n&&(n=null),a({pathname:"string"===typeof e?e:e.pathname,search:"",hash:""},"string"===typeof t?f(t):t,{state:n,key:t&&t.key||i||Math.random().toString(36).substr(2,8)})}function p(e){let{pathname:t="/",search:n="",hash:i=""}=e;return n&&"?"!==n&&(t+="?"===n.charAt(0)?n:"?"+n),i&&"#"!==i&&(t+="#"===i.charAt(0)?i:"#"+i),t}function f(e){let t={};if(e){let n=e.indexOf("#");n>=0&&(t.hash=e.substr(n),e=e.substr(0,n));let i=e.indexOf("?");i>=0&&(t.search=e.substr(i),e=e.substr(0,i)),e&&(t.pathname=e)}return t}function _(e,t,n,r){void 0===r&&(r={});let{window:o=document.defaultView,v5Compat:s=!1}=r,l=o.history,f=i.Pop,_=null,m=E();function E(){return(l.state||{idx:null}).idx}function g(){f=i.Pop;let e=E(),t=null==e?null:e-m;m=e,_&&_({action:f,location:T.location,delta:t})}function S(e){let t="null"!==o.location.origin?o.location.origin:o.location.href,n="string"===typeof e?e:p(e);return d(t,"No window.location.(origin|href) available to create URL for href: "+n),new URL(n,t)}null==m&&(m=0,l.replaceState(a({},l.state,{idx:m}),""));let T={get action(){return f},get location(){return e(o,l)},listen(e){if(_)throw new Error("A history only accepts one active listener");return o.addEventListener(c,g),_=e,()=>{o.removeEventListener(c,g),_=null}},createHref:e=>t(o,e),createURL:S,encodeLocation(e){let t=S(e);return{pathname:t.pathname,search:t.search,hash:t.hash}},push:function(e,t){f=i.Push;let r=h(T.location,e,t);n&&n(r,e),m=E()+1;let a=u(r,m),c=T.createHref(r);try{l.pushState(a,"",c)}catch(d){if(d instanceof DOMException&&"DataCloneError"===d.name)throw d;o.location.assign(c)}s&&_&&_({action:f,location:T.location,delta:1})},replace:function(e,t){f=i.Replace;let r=h(T.location,e,t);n&&n(r,e),m=E();let o=u(r,m),a=T.createHref(r);l.replaceState(o,"",a),s&&_&&_({action:f,location:T.location,delta:0})},go:e=>l.go(e)};return T}var m;!function(e){e.data="data",e.deferred="deferred",e.redirect="redirect",e.error="error"}(m||(m={}));const E=new Set(["lazy","caseSensitive","path","id","index","children"]);function g(e,t,n,i){return void 0===n&&(n=[]),void 0===i&&(i={}),e.map(((e,r)=>{let o=[...n,r],s="string"===typeof e.id?e.id:o.join("-");if(d(!0!==e.index||!e.children,"Cannot specify children on an index route"),d(!i[s],'Found a route id collision on id "'+s+"\".  Route id's must be globally unique within Data Router usages"),function(e){return!0===e.index}(e)){let n=a({},e,t(e),{id:s});return i[s]=n,n}{let n=a({},e,t(e),{id:s,children:void 0});return i[s]=n,e.children&&(n.children=g(e.children,t,o,i)),n}}))}function S(e,t,n){void 0===n&&(n="/");let i=k(("string"===typeof t?f(t):t).pathname||"/",n);if(null==i)return null;let r=T(e);!function(e){e.sort(((e,t)=>e.score!==t.score?t.score-e.score:function(e,t){let n=e.length===t.length&&e.slice(0,-1).every(((e,n)=>e===t[n]));return n?e[e.length-1]-t[t.length-1]:0}(e.routesMeta.map((e=>e.childrenIndex)),t.routesMeta.map((e=>e.childrenIndex)))))}(r);let o=null;for(let s=0;null==o&&s<r.length;++s)o=N(r[s],P(i));return o}function T(e,t,n,i){void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i="");let r=(e,r,o)=>{let s={relativePath:void 0===o?e.path||"":o,caseSensitive:!0===e.caseSensitive,childrenIndex:r,route:e};s.relativePath.startsWith("/")&&(d(s.relativePath.startsWith(i),'Absolute route path "'+s.relativePath+'" nested under path "'+i+'" is not valid. An absolute child route path must start with the combined path of all its parent routes.'),s.relativePath=s.relativePath.slice(i.length));let a=V([i,s.relativePath]),c=n.concat(s);e.children&&e.children.length>0&&(d(!0!==e.index,'Index routes must not have child routes. Please remove all child routes from route path "'+a+'".'),T(e.children,t,c,a)),(null!=e.path||e.index)&&t.push({path:a,score:O(a,e.index),routesMeta:c})};return e.forEach(((e,t)=>{var n;if(""!==e.path&&null!=(n=e.path)&&n.includes("?"))for(let i of v(e.path))r(e,t,i);else r(e,t)})),t}function v(e){let t=e.split("/");if(0===t.length)return[];let[n,...i]=t,r=n.endsWith("?"),o=n.replace(/\?$/,"");if(0===i.length)return r?[o,""]:[o];let s=v(i.join("/")),a=[];return a.push(...s.map((e=>""===e?o:[o,e].join("/")))),r&&a.push(...s),a.map((t=>e.startsWith("/")&&""===t?"/":t))}const y=/^:\w+$/,R=3,C=2,b=1,I=10,w=-2,A=e=>"*"===e;function O(e,t){let n=e.split("/"),i=n.length;return n.some(A)&&(i+=w),t&&(i+=C),n.filter((e=>!A(e))).reduce(((e,t)=>e+(y.test(t)?R:""===t?b:I)),i)}function N(e,t){let{routesMeta:n}=e,i={},r="/",o=[];for(let s=0;s<n.length;++s){let e=n[s],a=s===n.length-1,c="/"===r?t:t.slice(r.length)||"/",d=D({path:e.relativePath,caseSensitive:e.caseSensitive,end:a},c);if(!d)return null;Object.assign(i,d.params);let l=e.route;o.push({params:i,pathname:V([r,d.pathname]),pathnameBase:F(V([r,d.pathnameBase])),route:l}),"/"!==d.pathnameBase&&(r=V([r,d.pathnameBase]))}return o}function D(e,t){"string"===typeof e&&(e={path:e,caseSensitive:!1,end:!0});let[n,i]=function(e,t,n){void 0===t&&(t=!1);void 0===n&&(n=!0);l("*"===e||!e.endsWith("*")||e.endsWith("/*"),'Route path "'+e+'" will be treated as if it were "'+e.replace(/\*$/,"/*")+'" because the `*` character must always follow a `/` in the pattern. To get rid of this warning, please change the route path to "'+e.replace(/\*$/,"/*")+'".');let i=[],r="^"+e.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:(\w+)(\?)?/g,((e,t,n)=>(i.push({paramName:t,isOptional:null!=n}),n?"/?([^\\/]+)?":"/([^\\/]+)")));e.endsWith("*")?(i.push({paramName:"*"}),r+="*"===e||"/*"===e?"(.*)$":"(?:\\/(.+)|\\/*)$"):n?r+="\\/*$":""!==e&&"/"!==e&&(r+="(?:(?=\\/|$))");let o=new RegExp(r,t?void 0:"i");return[o,i]}(e.path,e.caseSensitive,e.end),r=t.match(n);if(!r)return null;let o=r[0],s=o.replace(/(.)\/+$/,"$1"),a=r.slice(1),c=i.reduce(((e,t,n)=>{let{paramName:i,isOptional:r}=t;if("*"===i){let e=a[n]||"";s=o.slice(0,o.length-e.length).replace(/(.)\/+$/,"$1")}const c=a[n];return e[i]=r&&!c?void 0:function(e,t){try{return decodeURIComponent(e)}catch(n){return l(!1,'The value for the URL param "'+t+'" will not be decoded because the string "'+e+'" is a malformed URL segment. This is probably due to a bad percent encoding ('+n+")."),e}}(c||"",i),e}),{});return{params:c,pathname:o,pathnameBase:s,pattern:e}}function P(e){try{return decodeURI(e)}catch(t){return l(!1,'The URL path "'+e+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent encoding ('+t+")."),e}}function k(e,t){if("/"===t)return e;if(!e.toLowerCase().startsWith(t.toLowerCase()))return null;let n=t.endsWith("/")?t.length-1:t.length,i=e.charAt(n);return i&&"/"!==i?null:e.slice(n)||"/"}function L(e,t,n,i){return"Cannot include a '"+e+"' character in a manually specified `to."+t+"` field ["+JSON.stringify(i)+"].  Please separate it out to the `to."+n+'` field. Alternatively you may provide the full path as a string in <Link to="..."> and the router will parse it for you.'}function M(e){return e.filter(((e,t)=>0===t||e.route.path&&e.route.path.length>0))}function U(e,t){let n=M(e);return t?n.map(((t,n)=>n===e.length-1?t.pathname:t.pathnameBase)):n.map((e=>e.pathnameBase))}function x(e,t,n,i){let r;void 0===i&&(i=!1),"string"===typeof e?r=f(e):(r=a({},e),d(!r.pathname||!r.pathname.includes("?"),L("?","pathname","search",r)),d(!r.pathname||!r.pathname.includes("#"),L("#","pathname","hash",r)),d(!r.search||!r.search.includes("#"),L("#","search","hash",r)));let o,s=""===e||""===r.pathname,c=s?"/":r.pathname;if(null==c)o=n;else if(i){let e=0===t.length?[]:t[t.length-1].replace(/^\//,"").split("/");if(c.startsWith("..")){let t=c.split("/");for(;".."===t[0];)t.shift(),e.pop();r.pathname=t.join("/")}o="/"+e.join("/")}else{let e=t.length-1;if(c.startsWith("..")){let t=c.split("/");for(;".."===t[0];)t.shift(),e-=1;r.pathname=t.join("/")}o=e>=0?t[e]:"/"}let l=function(e,t){void 0===t&&(t="/");let{pathname:n,search:i="",hash:r=""}="string"===typeof e?f(e):e,o=n?n.startsWith("/")?n:function(e,t){let n=t.replace(/\/+$/,"").split("/");return e.split("/").forEach((e=>{".."===e?n.length>1&&n.pop():"."!==e&&n.push(e)})),n.length>1?n.join("/"):"/"}(n,t):t;return{pathname:o,search:j(i),hash:B(r)}}(r,o),u=c&&"/"!==c&&c.endsWith("/"),h=(s||"."===c)&&n.endsWith("/");return l.pathname.endsWith("/")||!u&&!h||(l.pathname+="/"),l}const V=e=>e.join("/").replace(/\/\/+/g,"/"),F=e=>e.replace(/\/+$/,"").replace(/^\/*/,"/"),j=e=>e&&"?"!==e?e.startsWith("?")?e:"?"+e:"",B=e=>e&&"#"!==e?e.startsWith("#")?e:"#"+e:"";Error;class G{constructor(e,t,n,i){void 0===i&&(i=!1),this.status=e,this.statusText=t||"",this.internal=i,n instanceof Error?(this.data=n.toString(),this.error=n):this.data=n}}function W(e){return null!=e&&"number"===typeof e.status&&"string"===typeof e.statusText&&"boolean"===typeof e.internal&&"data"in e}const H=["post","put","patch","delete"],K=new Set(H),z=["get",...H],Y=new Set(z),q=new Set([301,302,303,307,308]),J=new Set([307,308]),X={state:"idle",location:void 0,formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0},Q={state:"idle",data:void 0,formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0},Z={state:"unblocked",proceed:void 0,reset:void 0,location:void 0},$=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,ee=e=>({hasErrorBoundary:Boolean(e.hasErrorBoundary)}),te="remix-router-transitions";function ne(e){const t=e.window?e.window:"undefined"!==typeof window?window:void 0,n="undefined"!==typeof t&&"undefined"!==typeof t.document&&"undefined"!==typeof t.document.createElement,r=!n;let o;if(d(e.routes.length>0,"You must provide a non-empty routes array to createRouter"),e.mapRouteProperties)o=e.mapRouteProperties;else if(e.detectErrorBoundary){let t=e.detectErrorBoundary;o=e=>({hasErrorBoundary:t(e)})}else o=ee;let s,c,u={},p=g(e.routes,o,void 0,u),f=e.basename||"/",_=a({v7_fetcherPersist:!1,v7_normalizeFormMethod:!1,v7_partialHydration:!1,v7_prependBasename:!1,v7_relativeSplatPath:!1},e.future),E=null,T=new Set,v=null,y=null,R=null,C=null!=e.hydrationData,b=S(p,e.history.location,f),I=null;if(null==b){let t=Se(404,{pathname:e.history.location.pathname}),{matches:n,route:i}=ge(p);b=n,I={[i.id]:t}}let w,A=b.some((e=>e.route.lazy)),O=b.some((e=>e.route.loader));if(A)c=!1;else if(O)if(_.v7_partialHydration){let t=e.hydrationData?e.hydrationData.loaderData:null,n=e.hydrationData?e.hydrationData.errors:null;c=b.every((e=>e.route.loader&&!0!==e.route.loader.hydrate&&(t&&void 0!==t[e.route.id]||n&&void 0!==n[e.route.id])))}else c=null!=e.hydrationData;else c=!0;let N,D={historyAction:e.history.action,location:e.history.location,matches:b,initialized:c,navigation:X,restoreScrollPosition:null==e.hydrationData&&null,preventScrollReset:!1,revalidation:"idle",loaderData:e.hydrationData&&e.hydrationData.loaderData||{},actionData:e.hydrationData&&e.hydrationData.actionData||null,errors:e.hydrationData&&e.hydrationData.errors||I,fetchers:new Map,blockers:new Map},P=i.Pop,L=!1,M=!1,U=new Map,x=null,V=!1,F=!1,j=[],B=[],G=new Map,W=0,H=-1,K=new Map,z=new Set,Y=new Map,q=new Map,ne=new Set,oe=new Map,ae=new Map,ce=!1;function de(e,t){void 0===t&&(t={}),D=a({},D,e);let n=[],i=[];_.v7_fetcherPersist&&D.fetchers.forEach(((e,t)=>{"idle"===e.state&&(ne.has(t)?i.push(t):n.push(t))})),[...T].forEach((e=>e(D,{deletedFetchers:i,unstable_viewTransitionOpts:t.viewTransitionOpts,unstable_flushSync:!0===t.flushSync}))),_.v7_fetcherPersist&&(n.forEach((e=>D.fetchers.delete(e))),i.forEach((e=>xe(e))))}function he(t,n,r){var o,c;let d,{flushSync:l}=void 0===r?{}:r,u=null!=D.actionData&&null!=D.navigation.formMethod&&we(D.navigation.formMethod)&&"loading"===D.navigation.state&&!0!==(null==(o=t.state)?void 0:o._isRedirect);d=n.actionData?Object.keys(n.actionData).length>0?n.actionData:null:u?D.actionData:null;let h=n.loaderData?me(D.loaderData,n.loaderData,n.matches||[],n.errors):D.loaderData,f=D.blockers;f.size>0&&(f=new Map(f),f.forEach(((e,t)=>f.set(t,Z))));let _,m=!0===L||null!=D.navigation.formMethod&&we(D.navigation.formMethod)&&!0!==(null==(c=t.state)?void 0:c._isRedirect);if(s&&(p=s,s=void 0),V||P===i.Pop||(P===i.Push?e.history.push(t,t.state):P===i.Replace&&e.history.replace(t,t.state)),P===i.Pop){let e=U.get(D.location.pathname);e&&e.has(t.pathname)?_={currentLocation:D.location,nextLocation:t}:U.has(t.pathname)&&(_={currentLocation:t,nextLocation:D.location})}else if(M){let e=U.get(D.location.pathname);e?e.add(t.pathname):(e=new Set([t.pathname]),U.set(D.location.pathname,e)),_={currentLocation:D.location,nextLocation:t}}de(a({},n,{actionData:d,loaderData:h,historyAction:P,location:t,initialized:!0,navigation:X,revalidation:"idle",restoreScrollPosition:Ye(t,n.matches||D.matches),preventScrollReset:m,blockers:f}),{viewTransitionOpts:_,flushSync:!0===l}),P=i.Pop,L=!1,M=!1,V=!1,F=!1,j=[],B=[]}async function pe(t,n,r){N&&N.abort(),N=null,P=t,V=!0===(r&&r.startUninterruptedRevalidation),function(e,t){if(v&&R){let n=ze(e,t);v[n]=R()}}(D.location,D.matches),L=!0===(r&&r.preventScrollReset),M=!0===(r&&r.enableViewTransition);let c=s||p,d=r&&r.overrideNavigation,l=S(c,n,f),h=!0===(r&&r.flushSync);if(!l){let e=Se(404,{pathname:n.pathname}),{matches:t,route:i}=ge(c);return Ke(),void he(n,{matches:t,loaderData:{},errors:{[i.id]:e}},{flushSync:h})}if(D.initialized&&!F&&function(e,t){if(e.pathname!==t.pathname||e.search!==t.search)return!1;if(""===e.hash)return""!==t.hash;if(e.hash===t.hash)return!0;if(""!==t.hash)return!0;return!1}(D.location,n)&&!(r&&r.submission&&we(r.submission.formMethod)))return void he(n,{matches:l},{flushSync:h});N=new AbortController;let E,g,T=ue(e.history,n,N.signal,r&&r.submission);if(r&&r.pendingError)g={[Ee(l).route.id]:r.pendingError};else if(r&&r.submission&&we(r.submission.formMethod)){let e=await async function(e,t,n,r,s){void 0===s&&(s={});be();let a,c=function(e,t){let n={state:"submitting",location:e,formMethod:t.formMethod,formAction:t.formAction,formEncType:t.formEncType,formData:t.formData,json:t.json,text:t.text};return n}(t,n);de({navigation:c},{flushSync:!0===s.flushSync});let d=De(r,t);if(d.route.action||d.route.lazy){if(a=await le("action",e,d,r,u,o,f,_.v7_relativeSplatPath),e.signal.aborted)return{shortCircuited:!0}}else a={type:m.error,error:Se(405,{method:e.method,pathname:t.pathname,routeId:d.route.id})};if(Ce(a)){let e;return e=s&&null!=s.replace?s.replace:a.location===D.location.pathname+D.location.search,await fe(D,a,{submission:n,replace:e}),{shortCircuited:!0}}if(Re(a)){let e=Ee(r,d.route.id);return!0!==(s&&s.replace)&&(P=i.Push),{pendingActionData:{},pendingActionError:{[e.route.id]:a.error}}}if(ye(a))throw Se(400,{type:"defer-action"});return{pendingActionData:{[d.route.id]:a.data}}}(T,n,r.submission,l,{replace:r.replace,flushSync:h});if(e.shortCircuited)return;E=e.pendingActionData,g=e.pendingActionError,d=ke(n,r.submission),h=!1,T=new Request(T.url,{signal:T.signal})}let{shortCircuited:y,loaderData:C,errors:b}=await async function(t,n,i,r,o,c,d,l,u,h,m){let E=r||ke(n,o),g=o||c||Pe(E),S=s||p,[T,v]=se(e.history,D,i,g,n,_.v7_partialHydration&&!0===l,F,j,B,ne,Y,z,S,f,h,m);if(Ke((e=>!(i&&i.some((t=>t.route.id===e)))||T&&T.some((t=>t.route.id===e)))),H=++W,0===T.length&&0===v.length){let e=je();return he(n,a({matches:i,loaderData:{},errors:m||null},h?{actionData:h}:{},e?{fetchers:new Map(D.fetchers)}:{}),{flushSync:u}),{shortCircuited:!0}}if(!V&&(!_.v7_partialHydration||!l)){v.forEach((e=>{let t=D.fetchers.get(e.key),n=Le(void 0,t?t.data:void 0);D.fetchers.set(e.key,n)}));let e=h||D.actionData;de(a({navigation:E},e?0===Object.keys(e).length?{actionData:null}:{actionData:e}:{},v.length>0?{fetchers:new Map(D.fetchers)}:{}),{flushSync:u})}v.forEach((e=>{G.has(e.key)&&Ve(e.key),e.controller&&G.set(e.key,e.controller)}));let y=()=>v.forEach((e=>Ve(e.key)));N&&N.signal.addEventListener("abort",y);let{results:R,loaderResults:C,fetcherResults:b}=await ve(D.matches,i,T,v,t);if(t.signal.aborted)return{shortCircuited:!0};N&&N.signal.removeEventListener("abort",y);v.forEach((e=>G.delete(e.key)));let I=Te(R);if(I){if(I.idx>=T.length){let e=v[I.idx-T.length].key;z.add(e)}return await fe(D,I.result,{replace:d}),{shortCircuited:!0}}let{loaderData:w,errors:A}=_e(D,i,T,C,m,v,b,oe);oe.forEach(((e,t)=>{e.subscribe((n=>{(n||e.done)&&oe.delete(t)}))}));let O=je(),P=Be(H),k=O||P||v.length>0;return a({loaderData:w,errors:A},k?{fetchers:new Map(D.fetchers)}:{})}(T,n,l,d,r&&r.submission,r&&r.fetcherSubmission,r&&r.replace,r&&!0===r.initialHydration,h,E,g);y||(N=null,he(n,a({matches:l},E?{actionData:E}:{},{loaderData:C,errors:b})))}async function fe(r,o,s){let{submission:c,fetcherSubmission:l,replace:u}=void 0===s?{}:s;o.revalidate&&(F=!0);let p=h(r.location,o.location,{_isRedirect:!0});if(d(p,"Expected a location on the redirect navigation"),n){let n=!1;if(o.reloadDocument)n=!0;else if($.test(o.location)){const i=e.history.createURL(o.location);n=i.origin!==t.location.origin||null==k(i.pathname,f)}if(n)return void(u?t.location.replace(o.location):t.location.assign(o.location))}N=null;let _=!0===u?i.Replace:i.Push,{formMethod:m,formAction:E,formEncType:g}=r.navigation;!c&&!l&&m&&E&&g&&(c=Pe(r.navigation));let S=c||l;if(J.has(o.status)&&S&&we(S.formMethod))await pe(_,p,{submission:a({},S,{formAction:o.location}),preventScrollReset:L});else{let e=ke(p,c);await pe(_,p,{overrideNavigation:e,fetcherSubmission:l,preventScrollReset:L})}}async function ve(t,n,i,r,s){let a=await Promise.all([...i.map((e=>le("loader",s,e,n,u,o,f,_.v7_relativeSplatPath))),...r.map((t=>{if(t.matches&&t.match&&t.controller)return le("loader",ue(e.history,t.path,t.controller.signal),t.match,t.matches,u,o,f,_.v7_relativeSplatPath);return{type:m.error,error:Se(404,{pathname:t.path})}}))]),c=a.slice(0,i.length),d=a.slice(i.length);return await Promise.all([Ae(t,i,c,c.map((()=>s.signal)),!1,D.loaderData),Ae(t,r.map((e=>e.match)),d,r.map((e=>e.controller?e.controller.signal:null)),!0)]),{results:a,loaderResults:c,fetcherResults:d}}function be(){F=!0,j.push(...Ke()),Y.forEach(((e,t)=>{G.has(t)&&(B.push(t),Ve(t))}))}function Ie(e,t,n){void 0===n&&(n={}),D.fetchers.set(e,t),de({fetchers:new Map(D.fetchers)},{flushSync:!0===(n&&n.flushSync)})}function Ne(e,t,n,i){void 0===i&&(i={});let r=Ee(D.matches,t);xe(e),de({errors:{[r.route.id]:n},fetchers:new Map(D.fetchers)},{flushSync:!0===(i&&i.flushSync)})}function Ue(e){return _.v7_fetcherPersist&&(q.set(e,(q.get(e)||0)+1),ne.has(e)&&ne.delete(e)),D.fetchers.get(e)||Q}function xe(e){let t=D.fetchers.get(e);!G.has(e)||t&&"loading"===t.state&&K.has(e)||Ve(e),Y.delete(e),K.delete(e),z.delete(e),ne.delete(e),D.fetchers.delete(e)}function Ve(e){let t=G.get(e);d(t,"Expected fetch controller: "+e),t.abort(),G.delete(e)}function Fe(e){for(let t of e){let e=Me(Ue(t).data);D.fetchers.set(t,e)}}function je(){let e=[],t=!1;for(let n of z){let i=D.fetchers.get(n);d(i,"Expected fetcher: "+n),"loading"===i.state&&(z.delete(n),e.push(n),t=!0)}return Fe(e),t}function Be(e){let t=[];for(let[n,i]of K)if(i<e){let e=D.fetchers.get(n);d(e,"Expected fetcher: "+n),"loading"===e.state&&(Ve(n),K.delete(n),t.push(n))}return Fe(t),t.length>0}function Ge(e){D.blockers.delete(e),ae.delete(e)}function We(e,t){let n=D.blockers.get(e)||Z;d("unblocked"===n.state&&"blocked"===t.state||"blocked"===n.state&&"blocked"===t.state||"blocked"===n.state&&"proceeding"===t.state||"blocked"===n.state&&"unblocked"===t.state||"proceeding"===n.state&&"unblocked"===t.state,"Invalid blocker state transition: "+n.state+" -> "+t.state);let i=new Map(D.blockers);i.set(e,t),de({blockers:i})}function He(e){let{currentLocation:t,nextLocation:n,historyAction:i}=e;if(0===ae.size)return;ae.size>1&&l(!1,"A router only supports one blocker at a time");let r=Array.from(ae.entries()),[o,s]=r[r.length-1],a=D.blockers.get(o);return a&&"proceeding"===a.state?void 0:s({currentLocation:t,nextLocation:n,historyAction:i})?o:void 0}function Ke(e){let t=[];return oe.forEach(((n,i)=>{e&&!e(i)||(n.cancel(),t.push(i),oe.delete(i))})),t}function ze(e,t){if(y){return y(e,t.map((e=>function(e,t){let{route:n,pathname:i,params:r}=e;return{id:n.id,pathname:i,params:r,data:t[n.id],handle:n.handle}}(e,D.loaderData))))||e.key}return e.key}function Ye(e,t){if(v){let n=ze(e,t),i=v[n];if("number"===typeof i)return i}return null}return w={get basename(){return f},get future(){return _},get state(){return D},get routes(){return p},get window(){return t},initialize:function(){if(E=e.history.listen((t=>{let{action:n,location:i,delta:r}=t;if(ce)return void(ce=!1);l(0===ae.size||null!=r,"You are trying to use a blocker on a POP navigation to a location that was not created by @remix-run/router. This will fail silently in production. This can happen if you are navigating outside the router via `window.history.pushState`/`window.location.hash` instead of using router navigation APIs.  This can also happen if you are using createHashRouter and the user manually changes the URL.");let o=He({currentLocation:D.location,nextLocation:i,historyAction:n});return o&&null!=r?(ce=!0,e.history.go(-1*r),void We(o,{state:"blocked",location:i,proceed(){We(o,{state:"proceeding",proceed:void 0,reset:void 0,location:i}),e.history.go(r)},reset(){let e=new Map(D.blockers);e.set(o,Z),de({blockers:e})}})):pe(n,i)})),n){!function(e,t){try{let n=e.sessionStorage.getItem(te);if(n){let e=JSON.parse(n);for(let[n,i]of Object.entries(e||{}))i&&Array.isArray(i)&&t.set(n,new Set(i||[]))}}catch(n){}}(t,U);let e=()=>function(e,t){if(t.size>0){let i={};for(let[e,n]of t)i[e]=[...n];try{e.sessionStorage.setItem(te,JSON.stringify(i))}catch(n){l(!1,"Failed to save applied view transitions in sessionStorage ("+n+").")}}}(t,U);t.addEventListener("pagehide",e),x=()=>t.removeEventListener("pagehide",e)}return D.initialized||pe(i.Pop,D.location,{initialHydration:!0}),w},subscribe:function(e){return T.add(e),()=>T.delete(e)},enableScrollRestoration:function(e,t,n){if(v=e,R=t,y=n||null,!C&&D.navigation===X){C=!0;let e=Ye(D.location,D.matches);null!=e&&de({restoreScrollPosition:e})}return()=>{v=null,R=null,y=null}},navigate:async function t(n,r){if("number"===typeof n)return void e.history.go(n);let o=ie(D.location,D.matches,f,_.v7_prependBasename,n,_.v7_relativeSplatPath,null==r?void 0:r.fromRouteId,null==r?void 0:r.relative),{path:s,submission:c,error:d}=re(_.v7_normalizeFormMethod,!1,o,r),l=D.location,u=h(D.location,s,r&&r.state);u=a({},u,e.history.encodeLocation(u));let p=r&&null!=r.replace?r.replace:void 0,m=i.Push;!0===p?m=i.Replace:!1===p||null!=c&&we(c.formMethod)&&c.formAction===D.location.pathname+D.location.search&&(m=i.Replace);let E=r&&"preventScrollReset"in r?!0===r.preventScrollReset:void 0,g=!0===(r&&r.unstable_flushSync),S=He({currentLocation:l,nextLocation:u,historyAction:m});if(!S)return await pe(m,u,{submission:c,pendingError:d,preventScrollReset:E,replace:r&&r.replace,enableViewTransition:r&&r.unstable_viewTransition,flushSync:g});We(S,{state:"blocked",location:u,proceed(){We(S,{state:"proceeding",proceed:void 0,reset:void 0,location:u}),t(n,r)},reset(){let e=new Map(D.blockers);e.set(S,Z),de({blockers:e})}})},fetch:function(t,n,i,a){if(r)throw new Error("router.fetch() was called during the server render, but it shouldn't be. You are likely calling a useFetcher() method in the body of your component. Try moving it to a useEffect or a callback.");G.has(t)&&Ve(t);let c=!0===(a&&a.unstable_flushSync),l=s||p,h=ie(D.location,D.matches,f,_.v7_prependBasename,i,_.v7_relativeSplatPath,n,null==a?void 0:a.relative),m=S(l,h,f);if(!m)return void Ne(t,n,Se(404,{pathname:h}),{flushSync:c});let{path:E,submission:g,error:T}=re(_.v7_normalizeFormMethod,!0,h,a);if(T)return void Ne(t,n,T,{flushSync:c});let v=De(m,E);L=!0===(a&&a.preventScrollReset),g&&we(g.formMethod)?async function(t,n,i,r,a,c,l){if(be(),Y.delete(t),!r.route.action&&!r.route.lazy){let e=Se(405,{method:l.formMethod,pathname:i,routeId:n});return void Ne(t,n,e,{flushSync:c})}let h=D.fetchers.get(t);Ie(t,function(e,t){let n={state:"submitting",formMethod:e.formMethod,formAction:e.formAction,formEncType:e.formEncType,formData:e.formData,json:e.json,text:e.text,data:t?t.data:void 0};return n}(l,h),{flushSync:c});let m=new AbortController,E=ue(e.history,i,m.signal,l);G.set(t,m);let g=W,T=await le("action",E,r,a,u,o,f,_.v7_relativeSplatPath);if(E.signal.aborted)return void(G.get(t)===m&&G.delete(t));if(ne.has(t))return void Ie(t,Me(void 0));if(Ce(T))return G.delete(t),H>g?void Ie(t,Me(void 0)):(z.add(t),Ie(t,Le(l)),fe(D,T,{fetcherSubmission:l}));if(Re(T))return void Ne(t,n,T.error);if(ye(T))throw Se(400,{type:"defer-action"});let v=D.navigation.location||D.location,y=ue(e.history,v,m.signal),R=s||p,C="idle"!==D.navigation.state?S(R,D.navigation.location,f):D.matches;d(C,"Didn't find any matches after fetcher action");let b=++W;K.set(t,b);let I=Le(l,T.data);D.fetchers.set(t,I);let[w,A]=se(e.history,D,C,l,v,!1,F,j,B,ne,Y,z,R,f,{[r.route.id]:T.data},void 0);A.filter((e=>e.key!==t)).forEach((e=>{let t=e.key,n=D.fetchers.get(t),i=Le(void 0,n?n.data:void 0);D.fetchers.set(t,i),G.has(t)&&Ve(t),e.controller&&G.set(t,e.controller)})),de({fetchers:new Map(D.fetchers)});let O=()=>A.forEach((e=>Ve(e.key)));m.signal.addEventListener("abort",O);let{results:k,loaderResults:L,fetcherResults:M}=await ve(D.matches,C,w,A,y);if(m.signal.aborted)return;m.signal.removeEventListener("abort",O),K.delete(t),G.delete(t),A.forEach((e=>G.delete(e.key)));let U=Te(k);if(U){if(U.idx>=w.length){let e=A[U.idx-w.length].key;z.add(e)}return fe(D,U.result)}let{loaderData:x,errors:V}=_e(D,D.matches,w,L,void 0,A,M,oe);if(D.fetchers.has(t)){let e=Me(T.data);D.fetchers.set(t,e)}Be(b),"loading"===D.navigation.state&&b>H?(d(P,"Expected pending action"),N&&N.abort(),he(D.navigation.location,{matches:C,loaderData:x,errors:V,fetchers:new Map(D.fetchers)})):(de({errors:V,loaderData:me(D.loaderData,x,C,V),fetchers:new Map(D.fetchers)}),F=!1)}(t,n,E,v,m,c,g):(Y.set(t,{routeId:n,path:E}),async function(t,n,i,r,s,a,c){let l=D.fetchers.get(t);Ie(t,Le(c,l?l.data:void 0),{flushSync:a});let h=new AbortController,p=ue(e.history,i,h.signal);G.set(t,h);let m=W,E=await le("loader",p,r,s,u,o,f,_.v7_relativeSplatPath);ye(E)&&(E=await Oe(E,p.signal,!0)||E);G.get(t)===h&&G.delete(t);if(p.signal.aborted)return;if(ne.has(t))return void Ie(t,Me(void 0));if(Ce(E))return H>m?void Ie(t,Me(void 0)):(z.add(t),void await fe(D,E));if(Re(E))return void Ne(t,n,E.error);d(!ye(E),"Unhandled fetcher deferred data"),Ie(t,Me(E.data))}(t,n,E,v,m,c,g))},revalidate:function(){be(),de({revalidation:"loading"}),"submitting"!==D.navigation.state&&("idle"!==D.navigation.state?pe(P||D.historyAction,D.navigation.location,{overrideNavigation:D.navigation}):pe(D.historyAction,D.location,{startUninterruptedRevalidation:!0}))},createHref:t=>e.history.createHref(t),encodeLocation:t=>e.history.encodeLocation(t),getFetcher:Ue,deleteFetcher:function(e){if(_.v7_fetcherPersist){let t=(q.get(e)||0)-1;t<=0?(q.delete(e),ne.add(e)):q.set(e,t)}else xe(e);de({fetchers:new Map(D.fetchers)})},dispose:function(){E&&E(),x&&x(),T.clear(),N&&N.abort(),D.fetchers.forEach(((e,t)=>xe(t))),D.blockers.forEach(((e,t)=>Ge(t)))},getBlocker:function(e,t){let n=D.blockers.get(e)||Z;return ae.get(e)!==t&&ae.set(e,t),n},deleteBlocker:Ge,_internalFetchControllers:G,_internalActiveDeferreds:oe,_internalSetRoutes:function(e){u={},s=g(e,o,void 0,u)}},w}Symbol("deferred");function ie(e,t,n,i,r,o,s,a){let c,d;if(s){c=[];for(let e of t)if(c.push(e),e.route.id===s){d=e;break}}else c=t,d=t[t.length-1];let l=x(r||".",U(c,o),k(e.pathname,n)||e.pathname,"path"===a);return null==r&&(l.search=e.search,l.hash=e.hash),null!=r&&""!==r&&"."!==r||!d||!d.route.index||Ne(l.search)||(l.search=l.search?l.search.replace(/^\?/,"?index&"):"?index"),i&&"/"!==n&&(l.pathname="/"===l.pathname?n:V([n,l.pathname])),p(l)}function re(e,t,n,i){if(!i||!function(e){return null!=e&&("formData"in e&&null!=e.formData||"body"in e&&void 0!==e.body)}(i))return{path:n};if(i.formMethod&&!Ie(i.formMethod))return{path:n,error:Se(405,{method:i.formMethod})};let r,o,s=()=>({path:n,error:Se(400,{type:"invalid-body"})}),a=i.formMethod||"get",c=e?a.toUpperCase():a.toLowerCase(),l=ve(n);if(void 0!==i.body){if("text/plain"===i.formEncType){if(!we(c))return s();let e="string"===typeof i.body?i.body:i.body instanceof FormData||i.body instanceof URLSearchParams?Array.from(i.body.entries()).reduce(((e,t)=>{let[n,i]=t;return""+e+n+"="+i+"\n"}),""):String(i.body);return{path:n,submission:{formMethod:c,formAction:l,formEncType:i.formEncType,formData:void 0,json:void 0,text:e}}}if("application/json"===i.formEncType){if(!we(c))return s();try{let e="string"===typeof i.body?JSON.parse(i.body):i.body;return{path:n,submission:{formMethod:c,formAction:l,formEncType:i.formEncType,formData:void 0,json:e,text:void 0}}}catch(_){return s()}}}if(d("function"===typeof FormData,"FormData is not available in this environment"),i.formData)r=he(i.formData),o=i.formData;else if(i.body instanceof FormData)r=he(i.body),o=i.body;else if(i.body instanceof URLSearchParams)r=i.body,o=pe(r);else if(null==i.body)r=new URLSearchParams,o=new FormData;else try{r=new URLSearchParams(i.body),o=pe(r)}catch(_){return s()}let u={formMethod:c,formAction:l,formEncType:i&&i.formEncType||"application/x-www-form-urlencoded",formData:o,json:void 0,text:void 0};if(we(u.formMethod))return{path:n,submission:u};let h=f(n);return t&&h.search&&Ne(h.search)&&r.append("index",""),h.search="?"+r,{path:p(h),submission:u}}function oe(e,t){let n=e;if(t){let i=e.findIndex((e=>e.route.id===t));i>=0&&(n=e.slice(0,i))}return n}function se(e,t,n,i,r,o,s,c,d,l,u,h,p,f,_,m){let E=m?Object.values(m)[0]:_?Object.values(_)[0]:void 0,g=e.createURL(t.location),T=e.createURL(r),v=m?Object.keys(m)[0]:void 0,y=oe(n,v).filter(((e,n)=>{if(o)return function(e,t){if(!t.loader)return!1;if(t.loader.hydrate)return!0;return void 0===e.loaderData[t.id]&&(!e.errors||void 0===e.errors[t.id])}(t,e.route);if(e.route.lazy)return!0;if(null==e.route.loader)return!1;if(function(e,t,n){let i=!t||n.route.id!==t.route.id,r=void 0===e[n.route.id];return i||r}(t.loaderData,t.matches[n],e)||c.some((t=>t===e.route.id)))return!0;let r=t.matches[n],d=e;return ce(e,a({currentUrl:g,currentParams:r.params,nextUrl:T,nextParams:d.params},i,{actionResult:E,defaultShouldRevalidate:s||g.pathname+g.search===T.pathname+T.search||g.search!==T.search||ae(r,d)}))})),R=[];return u.forEach(((e,r)=>{if(o||!n.some((t=>t.route.id===e.routeId))||l.has(r))return;let c=S(p,e.path,f);if(!c)return void R.push({key:r,routeId:e.routeId,path:e.path,matches:null,match:null,controller:null});let u=t.fetchers.get(r),_=De(c,e.path),m=!1;m=!h.has(r)&&(!!d.includes(r)||(u&&"idle"!==u.state&&void 0===u.data?s:ce(_,a({currentUrl:g,currentParams:t.matches[t.matches.length-1].params,nextUrl:T,nextParams:n[n.length-1].params},i,{actionResult:E,defaultShouldRevalidate:s})))),m&&R.push({key:r,routeId:e.routeId,path:e.path,matches:c,match:_,controller:new AbortController})})),[y,R]}function ae(e,t){let n=e.route.path;return e.pathname!==t.pathname||null!=n&&n.endsWith("*")&&e.params["*"]!==t.params["*"]}function ce(e,t){if(e.route.shouldRevalidate){let n=e.route.shouldRevalidate(t);if("boolean"===typeof n)return n}return t.defaultShouldRevalidate}async function de(e,t,n){if(!e.lazy)return;let i=await e.lazy();if(!e.lazy)return;let r=n[e.id];d(r,"No route found in manifest");let o={};for(let s in i){let e=void 0!==r[s]&&"hasErrorBoundary"!==s;l(!e,'Route "'+r.id+'" has a static property "'+s+'" defined but its lazy function is also returning a value for this property. The lazy route property "'+s+'" will be ignored.'),e||E.has(s)||(o[s]=i[s])}Object.assign(r,o),Object.assign(r,a({},t(r),{lazy:void 0}))}async function le(e,t,n,i,r,o,s,a,c){let l,u,h;void 0===c&&(c={});let p=e=>{let i,r=new Promise(((e,t)=>i=t));return h=()=>i(),t.signal.addEventListener("abort",h),Promise.race([e({request:t,params:n.params,context:c.requestContext}),r])};try{let i=n.route[e];if(n.route.lazy)if(i){let e,t=await Promise.all([p(i).catch((t=>{e=t})),de(n.route,o,r)]);if(e)throw e;u=t[0]}else{if(await de(n.route,o,r),i=n.route[e],!i){if("action"===e){let e=new URL(t.url),i=e.pathname+e.search;throw Se(405,{method:t.method,pathname:i,routeId:n.route.id})}return{type:m.data,data:void 0}}u=await p(i)}else{if(!i){let e=new URL(t.url);throw Se(404,{pathname:e.pathname+e.search})}u=await p(i)}d(void 0!==u,"You defined "+("action"===e?"an action":"a loader")+' for route "'+n.route.id+"\" but didn't return anything from your `"+e+"` function. Please return a value or `null`.")}catch(E){l=m.error,u=E}finally{h&&t.signal.removeEventListener("abort",h)}if(be(u)){let e,r=u.status;if(q.has(r)){let e=u.headers.get("Location");if(d(e,"Redirects returned/thrown from loaders/actions must have a Location header"),$.test(e)){if(!c.isStaticRequest){let n=new URL(t.url),i=e.startsWith("//")?new URL(n.protocol+e):new URL(e),r=null!=k(i.pathname,s);i.origin===n.origin&&r&&(e=i.pathname+i.search+i.hash)}}else e=ie(new URL(t.url),i.slice(0,i.indexOf(n)+1),s,!0,e,a);if(c.isStaticRequest)throw u.headers.set("Location",e),u;return{type:m.redirect,status:r,location:e,revalidate:null!==u.headers.get("X-Remix-Revalidate"),reloadDocument:null!==u.headers.get("X-Remix-Reload-Document")}}if(c.isRouteRequest){throw{type:l===m.error?m.error:m.data,response:u}}try{let t=u.headers.get("Content-Type");e=t&&/\bapplication\/json\b/.test(t)?await u.json():await u.text()}catch(E){return{type:m.error,error:E}}return l===m.error?{type:l,error:new G(r,u.statusText,e),headers:u.headers}:{type:m.data,data:e,statusCode:u.status,headers:u.headers}}return l===m.error?{type:l,error:u}:function(e){let t=e;return t&&"object"===typeof t&&"object"===typeof t.data&&"function"===typeof t.subscribe&&"function"===typeof t.cancel&&"function"===typeof t.resolveData}(u)?{type:m.deferred,deferredData:u,statusCode:null==(f=u.init)?void 0:f.status,headers:(null==(_=u.init)?void 0:_.headers)&&new Headers(u.init.headers)}:{type:m.data,data:u};var f,_}function ue(e,t,n,i){let r=e.createURL(ve(t)).toString(),o={signal:n};if(i&&we(i.formMethod)){let{formMethod:e,formEncType:t}=i;o.method=e.toUpperCase(),"application/json"===t?(o.headers=new Headers({"Content-Type":t}),o.body=JSON.stringify(i.json)):"text/plain"===t?o.body=i.text:"application/x-www-form-urlencoded"===t&&i.formData?o.body=he(i.formData):o.body=i.formData}return new Request(r,o)}function he(e){let t=new URLSearchParams;for(let[n,i]of e.entries())t.append(n,"string"===typeof i?i:i.name);return t}function pe(e){let t=new FormData;for(let[n,i]of e.entries())t.append(n,i);return t}function fe(e,t,n,i,r){let o,s={},a=null,c=!1,l={};return n.forEach(((n,u)=>{let h=t[u].route.id;if(d(!Ce(n),"Cannot handle redirect results in processLoaderData"),Re(n)){let t=Ee(e,h),r=n.error;i&&(r=Object.values(i)[0],i=void 0),a=a||{},null==a[t.route.id]&&(a[t.route.id]=r),s[h]=void 0,c||(c=!0,o=W(n.error)?n.error.status:500),n.headers&&(l[h]=n.headers)}else ye(n)?(r.set(h,n.deferredData),s[h]=n.deferredData.data):s[h]=n.data,null==n.statusCode||200===n.statusCode||c||(o=n.statusCode),n.headers&&(l[h]=n.headers)})),i&&(a=i,s[Object.keys(i)[0]]=void 0),{loaderData:s,errors:a,statusCode:o||200,loaderHeaders:l}}function _e(e,t,n,i,r,o,s,c){let{loaderData:l,errors:u}=fe(t,n,i,r,c);for(let h=0;h<o.length;h++){let{key:t,match:n,controller:i}=o[h];d(void 0!==s&&void 0!==s[h],"Did not find corresponding fetcher result");let r=s[h];if(!i||!i.signal.aborted)if(Re(r)){let i=Ee(e.matches,null==n?void 0:n.route.id);u&&u[i.route.id]||(u=a({},u,{[i.route.id]:r.error})),e.fetchers.delete(t)}else if(Ce(r))d(!1,"Unhandled fetcher revalidation redirect");else if(ye(r))d(!1,"Unhandled fetcher deferred data");else{let n=Me(r.data);e.fetchers.set(t,n)}}return{loaderData:l,errors:u}}function me(e,t,n,i){let r=a({},t);for(let o of n){let n=o.route.id;if(t.hasOwnProperty(n)?void 0!==t[n]&&(r[n]=t[n]):void 0!==e[n]&&o.route.loader&&(r[n]=e[n]),i&&i.hasOwnProperty(n))break}return r}function Ee(e,t){return(t?e.slice(0,e.findIndex((e=>e.route.id===t))+1):[...e]).reverse().find((e=>!0===e.route.hasErrorBoundary))||e[0]}function ge(e){let t=1===e.length?e[0]:e.find((e=>e.index||!e.path||"/"===e.path))||{id:"__shim-error-route__"};return{matches:[{params:{},pathname:"",pathnameBase:"",route:t}],route:t}}function Se(e,t){let{pathname:n,routeId:i,method:r,type:o}=void 0===t?{}:t,s="Unknown Server Error",a="Unknown @remix-run/router error";return 400===e?(s="Bad Request",r&&n&&i?a="You made a "+r+' request to "'+n+'" but did not provide a `loader` for route "'+i+'", so there is no way to handle the request.':"defer-action"===o?a="defer() is not supported in actions":"invalid-body"===o&&(a="Unable to encode submission body")):403===e?(s="Forbidden",a='Route "'+i+'" does not match URL "'+n+'"'):404===e?(s="Not Found",a='No route matches URL "'+n+'"'):405===e&&(s="Method Not Allowed",r&&n&&i?a="You made a "+r.toUpperCase()+' request to "'+n+'" but did not provide an `action` for route "'+i+'", so there is no way to handle the request.':r&&(a='Invalid request method "'+r.toUpperCase()+'"')),new G(e||500,s,new Error(a),!0)}function Te(e){for(let t=e.length-1;t>=0;t--){let n=e[t];if(Ce(n))return{result:n,idx:t}}}function ve(e){return p(a({},"string"===typeof e?f(e):e,{hash:""}))}function ye(e){return e.type===m.deferred}function Re(e){return e.type===m.error}function Ce(e){return(e&&e.type)===m.redirect}function be(e){return null!=e&&"number"===typeof e.status&&"string"===typeof e.statusText&&"object"===typeof e.headers&&"undefined"!==typeof e.body}function Ie(e){return Y.has(e.toLowerCase())}function we(e){return K.has(e.toLowerCase())}async function Ae(e,t,n,i,r,o){for(let s=0;s<n.length;s++){let a=n[s],c=t[s];if(!c)continue;let l=e.find((e=>e.route.id===c.route.id)),u=null!=l&&!ae(l,c)&&void 0!==(o&&o[c.route.id]);if(ye(a)&&(r||u)){let e=i[s];d(e,"Expected an AbortSignal for revalidating fetcher deferred result"),await Oe(a,e,r).then((e=>{e&&(n[s]=e||n[s])}))}}}async function Oe(e,t,n){if(void 0===n&&(n=!1),!await e.deferredData.resolveData(t)){if(n)try{return{type:m.data,data:e.deferredData.unwrappedData}}catch(i){return{type:m.error,error:i}}return{type:m.data,data:e.deferredData.data}}}function Ne(e){return new URLSearchParams(e).getAll("index").some((e=>""===e))}function De(e,t){let n="string"===typeof t?f(t).search:t.search;if(e[e.length-1].route.index&&Ne(n||""))return e[e.length-1];let i=M(e);return i[i.length-1]}function Pe(e){let{formMethod:t,formAction:n,formEncType:i,text:r,formData:o,json:s}=e;if(t&&n&&i)return null!=r?{formMethod:t,formAction:n,formEncType:i,formData:void 0,json:void 0,text:r}:null!=o?{formMethod:t,formAction:n,formEncType:i,formData:o,json:void 0,text:void 0}:void 0!==s?{formMethod:t,formAction:n,formEncType:i,formData:void 0,json:s,text:void 0}:void 0}function ke(e,t){if(t){return{state:"loading",location:e,formMethod:t.formMethod,formAction:t.formAction,formEncType:t.formEncType,formData:t.formData,json:t.json,text:t.text}}return{state:"loading",location:e,formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0}}function Le(e,t){if(e){return{state:"loading",formMethod:e.formMethod,formAction:e.formAction,formEncType:e.formEncType,formData:e.formData,json:e.json,text:e.text,data:t}}return{state:"loading",formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0,data:t}}function Me(e){return{state:"idle",formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0,data:e}}function Ue(){return Ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Ue.apply(this,arguments)}const xe=r.createContext(null);const Ve=r.createContext(null);const Fe=r.createContext(null);const je=r.createContext(null);const Be=r.createContext({outlet:null,matches:[],isDataRoute:!1});const Ge=r.createContext(null);function We(){return null!=r.useContext(je)}function He(){return We()||d(!1),r.useContext(je).location}function Ke(e){r.useContext(Fe).static||r.useLayoutEffect(e)}function ze(){let{isDataRoute:e}=r.useContext(Be);return e?function(){let{router:e}=tt($e.UseNavigateStable),t=it(et.UseNavigateStable),n=r.useRef(!1);Ke((()=>{n.current=!0}));let i=r.useCallback((function(i,r){void 0===r&&(r={}),n.current&&("number"===typeof i?e.navigate(i):e.navigate(i,Ue({fromRouteId:t},r)))}),[e,t]);return i}():function(){We()||d(!1);let e=r.useContext(xe),{basename:t,future:n,navigator:i}=r.useContext(Fe),{matches:o}=r.useContext(Be),{pathname:s}=He(),a=JSON.stringify(U(o,n.v7_relativeSplatPath)),c=r.useRef(!1);return Ke((()=>{c.current=!0})),r.useCallback((function(n,r){if(void 0===r&&(r={}),!c.current)return;if("number"===typeof n)return void i.go(n);let o=x(n,JSON.parse(a),s,"path"===r.relative);null==e&&"/"!==t&&(o.pathname="/"===o.pathname?t:V([t,o.pathname])),(r.replace?i.replace:i.push)(o,r.state,r)}),[t,i,a,s,e])}()}function Ye(e,t,n,o){We()||d(!1);let{navigator:s}=r.useContext(Fe),{matches:a}=r.useContext(Be),c=a[a.length-1],l=c?c.params:{},u=(c&&c.pathname,c?c.pathnameBase:"/");c&&c.route;let h,p=He();if(t){var _;let e="string"===typeof t?f(t):t;"/"===u||(null==(_=e.pathname)?void 0:_.startsWith(u))||d(!1),h=e}else h=p;let m=h.pathname||"/",E=S(e,{pathname:"/"===u?m:m.slice(u.length)||"/"});let g=Ze(E&&E.map((e=>Object.assign({},e,{params:Object.assign({},l,e.params),pathname:V([u,s.encodeLocation?s.encodeLocation(e.pathname).pathname:e.pathname]),pathnameBase:"/"===e.pathnameBase?u:V([u,s.encodeLocation?s.encodeLocation(e.pathnameBase).pathname:e.pathnameBase])}))),a,n,o);return t&&g?r.createElement(je.Provider,{value:{location:Ue({pathname:"/",search:"",hash:"",state:null,key:"default"},h),navigationType:i.Pop}},g):g}function qe(){let e=function(){var e;let t=r.useContext(Ge),n=nt(et.UseRouteError),i=it(et.UseRouteError);if(void 0!==t)return t;return null==(e=n.errors)?void 0:e[i]}(),t=W(e)?e.status+" "+e.statusText:e instanceof Error?e.message:JSON.stringify(e),n=e instanceof Error?e.stack:null,i="rgba(200,200,200, 0.5)",o={padding:"0.5rem",backgroundColor:i};return r.createElement(r.Fragment,null,r.createElement("h2",null,"Unexpected Application Error!"),r.createElement("h3",{style:{fontStyle:"italic"}},t),n?r.createElement("pre",{style:o},n):null,null)}const Je=r.createElement(qe,null);class Xe extends r.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||"idle"!==t.revalidation&&"idle"===e.revalidation?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:void 0!==e.error?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){console.error("React Router caught the following error during render",e,t)}render(){return void 0!==this.state.error?r.createElement(Be.Provider,{value:this.props.routeContext},r.createElement(Ge.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function Qe(e){let{routeContext:t,match:n,children:i}=e,o=r.useContext(xe);return o&&o.static&&o.staticContext&&(n.route.errorElement||n.route.ErrorBoundary)&&(o.staticContext._deepestRenderedBoundaryId=n.route.id),r.createElement(Be.Provider,{value:t},i)}function Ze(e,t,n,i){var o;if(void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),null==e){var s;if(null==(s=n)||!s.errors)return null;e=n.matches}let a=e,c=null==(o=n)?void 0:o.errors;if(null!=c){let e=a.findIndex((e=>e.route.id&&(null==c?void 0:c[e.route.id])));e>=0||d(!1),a=a.slice(0,Math.min(a.length,e+1))}let l=!1,u=-1;if(n&&i&&i.v7_partialHydration)for(let r=0;r<a.length;r++){let e=a[r];if((e.route.HydrateFallback||e.route.hydrateFallbackElement)&&(u=r),e.route.loader&&e.route.id&&void 0===n.loaderData[e.route.id]&&(!n.errors||void 0===n.errors[e.route.id])){l=!0,a=u>=0?a.slice(0,u+1):[a[0]];break}}return a.reduceRight(((e,i,o)=>{let s,d=!1,h=null,p=null;var f;n&&(s=c&&i.route.id?c[i.route.id]:void 0,h=i.route.errorElement||Je,l&&(u<0&&0===o?(f="route-fallback",!1||rt[f]||(rt[f]=!0),d=!0,p=null):u===o&&(d=!0,p=i.route.hydrateFallbackElement||null)));let _=t.concat(a.slice(0,o+1)),m=()=>{let t;return t=s?h:d?p:i.route.Component?r.createElement(i.route.Component,null):i.route.element?i.route.element:e,r.createElement(Qe,{match:i,routeContext:{outlet:e,matches:_,isDataRoute:null!=n},children:t})};return n&&(i.route.ErrorBoundary||i.route.errorElement||0===o)?r.createElement(Xe,{location:n.location,revalidation:n.revalidation,component:h,error:s,children:m(),routeContext:{outlet:null,matches:_,isDataRoute:!0}}):m()}),null)}var $e=function(e){return e.UseBlocker="useBlocker",e.UseRevalidator="useRevalidator",e.UseNavigateStable="useNavigate",e}($e||{}),et=function(e){return e.UseBlocker="useBlocker",e.UseLoaderData="useLoaderData",e.UseActionData="useActionData",e.UseRouteError="useRouteError",e.UseNavigation="useNavigation",e.UseRouteLoaderData="useRouteLoaderData",e.UseMatches="useMatches",e.UseRevalidator="useRevalidator",e.UseNavigateStable="useNavigate",e.UseRouteId="useRouteId",e}(et||{});function tt(e){let t=r.useContext(xe);return t||d(!1),t}function nt(e){let t=r.useContext(Ve);return t||d(!1),t}function it(e){let t=function(e){let t=r.useContext(Be);return t||d(!1),t}(),n=t.matches[t.matches.length-1];return n.route.id||d(!1),n.route.id}const rt={};o.startTransition;function ot(e){let{basename:t="/",children:n=null,location:o,navigationType:s=i.Pop,navigator:a,static:c=!1,future:l}=e;We()&&d(!1);let u=t.replace(/^\/*/,"/"),h=r.useMemo((()=>({basename:u,navigator:a,static:c,future:Ue({v7_relativeSplatPath:!1},l)})),[u,l,a,c]);"string"===typeof o&&(o=f(o));let{pathname:p="/",search:_="",hash:m="",state:E=null,key:g="default"}=o,S=r.useMemo((()=>{let e=k(p,u);return null==e?null:{location:{pathname:e,search:_,hash:m,state:E,key:g},navigationType:s}}),[u,p,_,m,E,g,s]);return null==S?null:r.createElement(Fe.Provider,{value:h},r.createElement(je.Provider,{children:n,value:S}))}new Promise((()=>{}));r.Component;function st(e){let t={hasErrorBoundary:null!=e.ErrorBoundary||null!=e.errorElement};return e.Component&&Object.assign(t,{element:r.createElement(e.Component),Component:void 0}),e.HydrateFallback&&Object.assign(t,{hydrateFallbackElement:r.createElement(e.HydrateFallback),HydrateFallback:void 0}),e.ErrorBoundary&&Object.assign(t,{errorElement:r.createElement(e.ErrorBoundary),ErrorBoundary:void 0}),t}var at=n(184);const ct=(0,r.createContext)({user:null,setUser:e=>{}}),dt=e=>{let{children:t}=e;const[n,i]=(0,r.useState)(null);return(0,r.useEffect)((()=>{const e=localStorage.getItem("username"),t=localStorage.getItem("chatAvailabilty");e&&t&&i({username:e,chatAvailabilty:t})}),[]),(0,at.jsx)(ct.Provider,{value:{user:n,setUser:i},children:t})};function lt(){const[e,t]=(0,r.useState)(""),[n,i]=(0,r.useState)(""),[o,s]=(0,r.useState)(""),a=ze(),{setUser:c}=(0,r.useContext)(ct);return(0,at.jsxs)("div",{className:"flex items-center justify-center w-screen h-screen flex-col gap-3 bg-slate-950",children:[(0,at.jsx)("h1",{className:"text-3xl font-bold text-white",children:"Insert your username"}),(0,at.jsx)("input",{value:e,onChange:e=>t(e.target.value),placeholder:"Nome de usu\xe1rio",type:"text",className:"bg-slate-900 text-lg text-white py-2 px-2 w-[350px] rounded-md"}),(0,at.jsx)("input",{value:n,onChange:e=>i(e.target.value),placeholder:"Senha",type:"password",className:"bg-slate-900 text-lg text-white py-2 px-2 w-[350px] rounded-md"}),(0,at.jsxs)("select",{onChange:e=>s(e.target.value),placeholder:"Disponibilidade",type:"text",className:"bg-slate-900 text-lg text-white py-2 px-2 w-[350px] rounded-md",value:o,children:[(0,at.jsx)("option",{value:"",disabled:!0,children:"Disponibilidade"}),(0,at.jsx)("option",{value:"chat",children:"Chat"}),(0,at.jsx)("option",{value:"video",children:"Video"}),(0,at.jsx)("option",{value:"ambos",children:"Os dois"})]}),(0,at.jsx)("p",{className:"text-white text-sm",children:"*Voce pode mudar as op\xe7\xf5es depois"}),(0,at.jsx)("button",{onClick:()=>{e.length<4||0!==o.length&&(localStorage.setItem("username",e),localStorage.setItem("chatAvailabilty",o),c({username:e,chatAvailabilty:o}),a("/rooms"))},className:"hover:bg-teal-400 focus:bg-teal-400 transition-all duration-100 bg-teal-500 py-2 w-[350px] rounded-md text-white font-medium",children:"Login"})]})}function ut(e){let{roomName:t,roomId:n,online:i,theme:r,chatType:o,usersAllowed:s}=e;const a=ze();return(0,at.jsxs)("div",{className:"w-[300px] gap-4 p-5 rounded-md bg-slate-800 flex items-center justify-center flex-col",children:[(0,at.jsx)("h1",{className:"text-white text-4xl font-bold",children:t}),(0,at.jsxs)("h2",{className:"text-white text-2xl font-bold",children:["Tema da sala: ",r]}),(0,at.jsxs)("p",{className:"text-white text-lg font-bold",children:["Tipo de chat: ",o]}),(0,at.jsxs)("p",{className:"text-white flex items-center gap-2",children:[i,"/10 online",(0,at.jsx)("i",{className:"bg-green-400 w-[8px] h-[8px] rounded-full drop-shadow"})]}),(0,at.jsx)("button",{onClick:()=>a("/chatRoom/:".concat(n)),className:"".concat(i>=10&&"hover:bg-stone-500 focus:bg-stone-500 bg-stone-500"," hover:bg-teal-400 focus:bg-teal-400 bg-teal-500 transition-all duration-100 w-[80%] py-2 rounded-md text-white font-medium"),disabled:!1,style:{opacity:i>=10||!s?.5:1},children:i>=10?"Full":"Enter"})]})}function ht(e,t){return function(){return e.apply(t,arguments)}}const{toString:pt}=Object.prototype,{getPrototypeOf:ft}=Object,_t=(e=>t=>{const n=pt.call(t);return e[n]||(e[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),mt=e=>(e=e.toLowerCase(),t=>_t(t)===e),Et=e=>t=>typeof t===e,{isArray:gt}=Array,St=Et("undefined");const Tt=mt("ArrayBuffer");const vt=Et("string"),yt=Et("function"),Rt=Et("number"),Ct=e=>null!==e&&"object"===typeof e,bt=e=>{if("object"!==_t(e))return!1;const t=ft(e);return(null===t||t===Object.prototype||null===Object.getPrototypeOf(t))&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},It=mt("Date"),wt=mt("File"),At=mt("Blob"),Ot=mt("FileList"),Nt=mt("URLSearchParams");function Dt(e,t){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!==e&&"undefined"!==typeof e)if("object"!==typeof e&&(e=[e]),gt(e))for(n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else{const i=r?Object.getOwnPropertyNames(e):Object.keys(e),o=i.length;let s;for(n=0;n<o;n++)s=i[n],t.call(null,e[s],s,e)}}function Pt(e,t){t=t.toLowerCase();const n=Object.keys(e);let i,r=n.length;for(;r-- >0;)if(i=n[r],t===i.toLowerCase())return i;return null}const kt="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:"undefined"!==typeof window?window:global,Lt=e=>!St(e)&&e!==kt;const Mt=(Ut="undefined"!==typeof Uint8Array&&ft(Uint8Array),e=>Ut&&e instanceof Ut);var Ut;const xt=mt("HTMLFormElement"),Vt=(e=>{let{hasOwnProperty:t}=e;return(e,n)=>t.call(e,n)})(Object.prototype),Ft=mt("RegExp"),jt=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),i={};Dt(n,((n,r)=>{let o;!1!==(o=t(n,r,e))&&(i[r]=o||n)})),Object.defineProperties(e,i)},Bt="abcdefghijklmnopqrstuvwxyz",Gt="0123456789",Wt={DIGIT:Gt,ALPHA:Bt,ALPHA_DIGIT:Bt+Bt.toUpperCase()+Gt};const Ht=mt("AsyncFunction"),Kt={isArray:gt,isArrayBuffer:Tt,isBuffer:function(e){return null!==e&&!St(e)&&null!==e.constructor&&!St(e.constructor)&&yt(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&("function"===typeof FormData&&e instanceof FormData||yt(e.append)&&("formdata"===(t=_t(e))||"object"===t&&yt(e.toString)&&"[object FormData]"===e.toString()))},isArrayBufferView:function(e){let t;return t="undefined"!==typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Tt(e.buffer),t},isString:vt,isNumber:Rt,isBoolean:e=>!0===e||!1===e,isObject:Ct,isPlainObject:bt,isUndefined:St,isDate:It,isFile:wt,isBlob:At,isRegExp:Ft,isFunction:yt,isStream:e=>Ct(e)&&yt(e.pipe),isURLSearchParams:Nt,isTypedArray:Mt,isFileList:Ot,forEach:Dt,merge:function e(){const{caseless:t}=Lt(this)&&this||{},n={},i=(i,r)=>{const o=t&&Pt(n,r)||r;bt(n[o])&&bt(i)?n[o]=e(n[o],i):bt(i)?n[o]=e({},i):gt(i)?n[o]=i.slice():n[o]=i};for(let r=0,o=arguments.length;r<o;r++)arguments[r]&&Dt(arguments[r],i);return n},extend:function(e,t,n){let{allOwnKeys:i}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return Dt(t,((t,i)=>{n&&yt(t)?e[i]=ht(t,n):e[i]=t}),{allOwnKeys:i}),e},trim:e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,n,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,i)=>{let r,o,s;const a={};if(t=t||{},null==e)return t;do{for(r=Object.getOwnPropertyNames(e),o=r.length;o-- >0;)s=r[o],i&&!i(s,e,t)||a[s]||(t[s]=e[s],a[s]=!0);e=!1!==n&&ft(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:_t,kindOfTest:mt,endsWith:(e,t,n)=>{e=String(e),(void 0===n||n>e.length)&&(n=e.length),n-=t.length;const i=e.indexOf(t,n);return-1!==i&&i===n},toArray:e=>{if(!e)return null;if(gt(e))return e;let t=e.length;if(!Rt(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[Symbol.iterator]).call(e);let i;for(;(i=n.next())&&!i.done;){const n=i.value;t.call(e,n[0],n[1])}},matchAll:(e,t)=>{let n;const i=[];for(;null!==(n=e.exec(t));)i.push(n);return i},isHTMLForm:xt,hasOwnProperty:Vt,hasOwnProp:Vt,reduceDescriptors:jt,freezeMethods:e=>{jt(e,((t,n)=>{if(yt(e)&&-1!==["arguments","caller","callee"].indexOf(n))return!1;const i=e[n];yt(i)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(e,t)=>{const n={},i=e=>{e.forEach((e=>{n[e]=!0}))};return gt(e)?i(e):i(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,n){return t.toUpperCase()+n})),noop:()=>{},toFiniteNumber:(e,t)=>(e=+e,Number.isFinite(e)?e:t),findKey:Pt,global:kt,isContextDefined:Lt,ALPHABET:Wt,generateString:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Wt.ALPHA_DIGIT,n="";const{length:i}=t;for(;e--;)n+=t[Math.random()*i|0];return n},isSpecCompliantForm:function(e){return!!(e&&yt(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])},toJSONObject:e=>{const t=new Array(10),n=(e,i)=>{if(Ct(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[i]=e;const r=gt(e)?[]:{};return Dt(e,((e,t)=>{const o=n(e,i+1);!St(o)&&(r[t]=o)})),t[i]=void 0,r}}return e};return n(e,0)},isAsyncFn:Ht,isThenable:e=>e&&(Ct(e)||yt(e))&&yt(e.then)&&yt(e.catch)};function zt(e,t,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r)}Kt.inherits(zt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Kt.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const Yt=zt.prototype,qt={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{qt[e]={value:e}})),Object.defineProperties(zt,qt),Object.defineProperty(Yt,"isAxiosError",{value:!0}),zt.from=(e,t,n,i,r,o)=>{const s=Object.create(Yt);return Kt.toFlatObject(e,s,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),zt.call(s,e.message,t,n,i,r),s.cause=e,s.name=e.name,o&&Object.assign(s,o),s};const Jt=zt;function Xt(e){return Kt.isPlainObject(e)||Kt.isArray(e)}function Qt(e){return Kt.endsWith(e,"[]")?e.slice(0,-2):e}function Zt(e,t,n){return e?e.concat(t).map((function(e,t){return e=Qt(e),!n&&t?"["+e+"]":e})).join(n?".":""):t}const $t=Kt.toFlatObject(Kt,{},null,(function(e){return/^is[A-Z]/.test(e)}));const en=function(e,t,n){if(!Kt.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const i=(n=Kt.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!Kt.isUndefined(t[e])}))).metaTokens,r=n.visitor||d,o=n.dots,s=n.indexes,a=(n.Blob||"undefined"!==typeof Blob&&Blob)&&Kt.isSpecCompliantForm(t);if(!Kt.isFunction(r))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(Kt.isDate(e))return e.toISOString();if(!a&&Kt.isBlob(e))throw new Jt("Blob is not supported. Use a Buffer instead.");return Kt.isArrayBuffer(e)||Kt.isTypedArray(e)?a&&"function"===typeof Blob?new Blob([e]):Buffer.from(e):e}function d(e,n,r){let a=e;if(e&&!r&&"object"===typeof e)if(Kt.endsWith(n,"{}"))n=i?n:n.slice(0,-2),e=JSON.stringify(e);else if(Kt.isArray(e)&&function(e){return Kt.isArray(e)&&!e.some(Xt)}(e)||(Kt.isFileList(e)||Kt.endsWith(n,"[]"))&&(a=Kt.toArray(e)))return n=Qt(n),a.forEach((function(e,i){!Kt.isUndefined(e)&&null!==e&&t.append(!0===s?Zt([n],i,o):null===s?n:n+"[]",c(e))})),!1;return!!Xt(e)||(t.append(Zt(r,n,o),c(e)),!1)}const l=[],u=Object.assign($t,{defaultVisitor:d,convertValue:c,isVisitable:Xt});if(!Kt.isObject(e))throw new TypeError("data must be an object");return function e(n,i){if(!Kt.isUndefined(n)){if(-1!==l.indexOf(n))throw Error("Circular reference detected in "+i.join("."));l.push(n),Kt.forEach(n,(function(n,o){!0===(!(Kt.isUndefined(n)||null===n)&&r.call(t,n,Kt.isString(o)?o.trim():o,i,u))&&e(n,i?i.concat(o):[o])})),l.pop()}}(e),t};function tn(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function nn(e,t){this._pairs=[],e&&en(e,this,t)}const rn=nn.prototype;rn.append=function(e,t){this._pairs.push([e,t])},rn.toString=function(e){const t=e?function(t){return e.call(this,t,tn)}:tn;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};const on=nn;function sn(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function an(e,t,n){if(!t)return e;const i=n&&n.encode||sn,r=n&&n.serialize;let o;if(o=r?r(t,n):Kt.isURLSearchParams(t)?t.toString():new on(t,n).toString(i),o){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+o}return e}const cn=class{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){Kt.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},dn={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},ln={isBrowser:!0,classes:{URLSearchParams:"undefined"!==typeof URLSearchParams?URLSearchParams:on,FormData:"undefined"!==typeof FormData?FormData:null,Blob:"undefined"!==typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]},un="undefined"!==typeof window&&"undefined"!==typeof document,hn=(pn="undefined"!==typeof navigator&&navigator.product,un&&["ReactNative","NativeScript","NS"].indexOf(pn)<0);var pn;const fn="undefined"!==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"===typeof self.importScripts,_n={...e,...ln};const mn=function(e){function t(e,n,i,r){let o=e[r++];const s=Number.isFinite(+o),a=r>=e.length;if(o=!o&&Kt.isArray(i)?i.length:o,a)return Kt.hasOwnProp(i,o)?i[o]=[i[o],n]:i[o]=n,!s;i[o]&&Kt.isObject(i[o])||(i[o]=[]);return t(e,n,i[o],r)&&Kt.isArray(i[o])&&(i[o]=function(e){const t={},n=Object.keys(e);let i;const r=n.length;let o;for(i=0;i<r;i++)o=n[i],t[o]=e[o];return t}(i[o])),!s}if(Kt.isFormData(e)&&Kt.isFunction(e.entries)){const n={};return Kt.forEachEntry(e,((e,i)=>{t(function(e){return Kt.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),i,n,0)})),n}return null};const En={transitional:dn,adapter:["xhr","http"],transformRequest:[function(e,t){const n=t.getContentType()||"",i=n.indexOf("application/json")>-1,r=Kt.isObject(e);r&&Kt.isHTMLForm(e)&&(e=new FormData(e));if(Kt.isFormData(e))return i&&i?JSON.stringify(mn(e)):e;if(Kt.isArrayBuffer(e)||Kt.isBuffer(e)||Kt.isStream(e)||Kt.isFile(e)||Kt.isBlob(e))return e;if(Kt.isArrayBufferView(e))return e.buffer;if(Kt.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return en(e,new _n.classes.URLSearchParams,Object.assign({visitor:function(e,t,n,i){return _n.isNode&&Kt.isBuffer(e)?(this.append(t,e.toString("base64")),!1):i.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((o=Kt.isFileList(e))||n.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return en(o?{"files[]":e}:e,t&&new t,this.formSerializer)}}return r||i?(t.setContentType("application/json",!1),function(e,t,n){if(Kt.isString(e))try{return(t||JSON.parse)(e),Kt.trim(e)}catch(i){if("SyntaxError"!==i.name)throw i}return(n||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||En.transitional,n=t&&t.forcedJSONParsing,i="json"===this.responseType;if(e&&Kt.isString(e)&&(n&&!this.responseType||i)){const n=!(t&&t.silentJSONParsing)&&i;try{return JSON.parse(e)}catch(r){if(n){if("SyntaxError"===r.name)throw Jt.from(r,Jt.ERR_BAD_RESPONSE,this,null,this.response);throw r}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:_n.classes.FormData,Blob:_n.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Kt.forEach(["delete","get","head","post","put","patch"],(e=>{En.headers[e]={}}));const gn=En,Sn=Kt.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Tn=Symbol("internals");function vn(e){return e&&String(e).trim().toLowerCase()}function yn(e){return!1===e||null==e?e:Kt.isArray(e)?e.map(yn):String(e)}function Rn(e,t,n,i,r){return Kt.isFunction(i)?i.call(this,t,n):(r&&(t=n),Kt.isString(t)?Kt.isString(i)?-1!==t.indexOf(i):Kt.isRegExp(i)?i.test(t):void 0:void 0)}class Cn{constructor(e){e&&this.set(e)}set(e,t,n){const i=this;function r(e,t,n){const r=vn(t);if(!r)throw new Error("header name must be a non-empty string");const o=Kt.findKey(i,r);(!o||void 0===i[o]||!0===n||void 0===n&&!1!==i[o])&&(i[o||t]=yn(e))}const o=(e,t)=>Kt.forEach(e,((e,n)=>r(e,n,t)));return Kt.isPlainObject(e)||e instanceof this.constructor?o(e,t):Kt.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim())?o((e=>{const t={};let n,i,r;return e&&e.split("\n").forEach((function(e){r=e.indexOf(":"),n=e.substring(0,r).trim().toLowerCase(),i=e.substring(r+1).trim(),!n||t[n]&&Sn[n]||("set-cookie"===n?t[n]?t[n].push(i):t[n]=[i]:t[n]=t[n]?t[n]+", "+i:i)})),t})(e),t):null!=e&&r(t,e,n),this}get(e,t){if(e=vn(e)){const n=Kt.findKey(this,e);if(n){const e=this[n];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let i;for(;i=n.exec(e);)t[i[1]]=i[2];return t}(e);if(Kt.isFunction(t))return t.call(this,e,n);if(Kt.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=vn(e)){const n=Kt.findKey(this,e);return!(!n||void 0===this[n]||t&&!Rn(0,this[n],n,t))}return!1}delete(e,t){const n=this;let i=!1;function r(e){if(e=vn(e)){const r=Kt.findKey(n,e);!r||t&&!Rn(0,n[r],r,t)||(delete n[r],i=!0)}}return Kt.isArray(e)?e.forEach(r):r(e),i}clear(e){const t=Object.keys(this);let n=t.length,i=!1;for(;n--;){const r=t[n];e&&!Rn(0,this[r],r,e,!0)||(delete this[r],i=!0)}return i}normalize(e){const t=this,n={};return Kt.forEach(this,((i,r)=>{const o=Kt.findKey(n,r);if(o)return t[o]=yn(i),void delete t[r];const s=e?function(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,n)=>t.toUpperCase()+n))}(r):String(r).trim();s!==r&&delete t[r],t[s]=yn(i),n[s]=!0})),this}concat(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.constructor.concat(this,...t)}toJSON(e){const t=Object.create(null);return Kt.forEach(this,((n,i)=>{null!=n&&!1!==n&&(t[i]=e&&Kt.isArray(n)?n.join(", "):n)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((e=>{let[t,n]=e;return t+": "+n})).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const t=new this(e);for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i.forEach((e=>t.set(e))),t}static accessor(e){const t=(this[Tn]=this[Tn]={accessors:{}}).accessors,n=this.prototype;function i(e){const i=vn(e);t[i]||(!function(e,t){const n=Kt.toCamelCase(" "+t);["get","set","has"].forEach((i=>{Object.defineProperty(e,i+n,{value:function(e,n,r){return this[i].call(this,t,e,n,r)},configurable:!0})}))}(n,e),t[i]=!0)}return Kt.isArray(e)?e.forEach(i):i(e),this}}Cn.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Kt.reduceDescriptors(Cn.prototype,((e,t)=>{let{value:n}=e,i=t[0].toUpperCase()+t.slice(1);return{get:()=>n,set(e){this[i]=e}}})),Kt.freezeMethods(Cn);const bn=Cn;function In(e,t){const n=this||gn,i=t||n,r=bn.from(i.headers);let o=i.data;return Kt.forEach(e,(function(e){o=e.call(n,o,r.normalize(),t?t.status:void 0)})),r.normalize(),o}function wn(e){return!(!e||!e.__CANCEL__)}function An(e,t,n){Jt.call(this,null==e?"canceled":e,Jt.ERR_CANCELED,t,n),this.name="CanceledError"}Kt.inherits(An,Jt,{__CANCEL__:!0});const On=An;const Nn=_n.hasStandardBrowserEnv?{write(e,t,n,i,r,o){const s=[e+"="+encodeURIComponent(t)];Kt.isNumber(n)&&s.push("expires="+new Date(n).toGMTString()),Kt.isString(i)&&s.push("path="+i),Kt.isString(r)&&s.push("domain="+r),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function Dn(e,t){return e&&!function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}(t)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}const Pn=_n.hasStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let n;function i(n){let i=n;return e&&(t.setAttribute("href",i),i=t.href),t.setAttribute("href",i),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return n=i(window.location.href),function(e){const t=Kt.isString(e)?i(e):e;return t.protocol===n.protocol&&t.host===n.host}}():function(){return!0};const kn=function(e,t){e=e||10;const n=new Array(e),i=new Array(e);let r,o=0,s=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),d=i[s];r||(r=c),n[o]=a,i[o]=c;let l=s,u=0;for(;l!==o;)u+=n[l++],l%=e;if(o=(o+1)%e,o===s&&(s=(s+1)%e),c-r<t)return;const h=d&&c-d;return h?Math.round(1e3*u/h):void 0}};function Ln(e,t){let n=0;const i=kn(50,250);return r=>{const o=r.loaded,s=r.lengthComputable?r.total:void 0,a=o-n,c=i(a);n=o;const d={loaded:o,total:s,progress:s?o/s:void 0,bytes:a,rate:c||void 0,estimated:c&&s&&o<=s?(s-o)/c:void 0,event:r};d[t?"download":"upload"]=!0,e(d)}}const Mn="undefined"!==typeof XMLHttpRequest&&function(e){return new Promise((function(t,n){let i=e.data;const r=bn.from(e.headers).normalize();let o,s,{responseType:a,withXSRFToken:c}=e;function d(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}if(Kt.isFormData(i))if(_n.hasStandardBrowserEnv||_n.hasStandardBrowserWebWorkerEnv)r.setContentType(!1);else if(!1!==(s=r.getContentType())){const[e,...t]=s?s.split(";").map((e=>e.trim())).filter(Boolean):[];r.setContentType([e||"multipart/form-data",...t].join("; "))}let l=new XMLHttpRequest;if(e.auth){const t=e.auth.username||"",n=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";r.set("Authorization","Basic "+btoa(t+":"+n))}const u=Dn(e.baseURL,e.url);function h(){if(!l)return;const i=bn.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders());!function(e,t,n){const i=n.config.validateStatus;n.status&&i&&!i(n.status)?t(new Jt("Request failed with status code "+n.status,[Jt.ERR_BAD_REQUEST,Jt.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}((function(e){t(e),d()}),(function(e){n(e),d()}),{data:a&&"text"!==a&&"json"!==a?l.response:l.responseText,status:l.status,statusText:l.statusText,headers:i,config:e,request:l}),l=null}if(l.open(e.method.toUpperCase(),an(u,e.params,e.paramsSerializer),!0),l.timeout=e.timeout,"onloadend"in l?l.onloadend=h:l.onreadystatechange=function(){l&&4===l.readyState&&(0!==l.status||l.responseURL&&0===l.responseURL.indexOf("file:"))&&setTimeout(h)},l.onabort=function(){l&&(n(new Jt("Request aborted",Jt.ECONNABORTED,e,l)),l=null)},l.onerror=function(){n(new Jt("Network Error",Jt.ERR_NETWORK,e,l)),l=null},l.ontimeout=function(){let t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const i=e.transitional||dn;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),n(new Jt(t,i.clarifyTimeoutError?Jt.ETIMEDOUT:Jt.ECONNABORTED,e,l)),l=null},_n.hasStandardBrowserEnv&&(c&&Kt.isFunction(c)&&(c=c(e)),c||!1!==c&&Pn(u))){const t=e.xsrfHeaderName&&e.xsrfCookieName&&Nn.read(e.xsrfCookieName);t&&r.set(e.xsrfHeaderName,t)}void 0===i&&r.setContentType(null),"setRequestHeader"in l&&Kt.forEach(r.toJSON(),(function(e,t){l.setRequestHeader(t,e)})),Kt.isUndefined(e.withCredentials)||(l.withCredentials=!!e.withCredentials),a&&"json"!==a&&(l.responseType=e.responseType),"function"===typeof e.onDownloadProgress&&l.addEventListener("progress",Ln(e.onDownloadProgress,!0)),"function"===typeof e.onUploadProgress&&l.upload&&l.upload.addEventListener("progress",Ln(e.onUploadProgress)),(e.cancelToken||e.signal)&&(o=t=>{l&&(n(!t||t.type?new On(null,e,l):t),l.abort(),l=null)},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o)));const p=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(u);p&&-1===_n.protocols.indexOf(p)?n(new Jt("Unsupported protocol "+p+":",Jt.ERR_BAD_REQUEST,e)):l.send(i||null)}))},Un={http:null,xhr:Mn};Kt.forEach(Un,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(n){}Object.defineProperty(e,"adapterName",{value:t})}}));const xn=e=>"- ".concat(e),Vn=e=>Kt.isFunction(e)||null===e||!1===e,Fn=e=>{e=Kt.isArray(e)?e:[e];const{length:t}=e;let n,i;const r={};for(let o=0;o<t;o++){let t;if(n=e[o],i=n,!Vn(n)&&(i=Un[(t=String(n)).toLowerCase()],void 0===i))throw new Jt("Unknown adapter '".concat(t,"'"));if(i)break;r[t||"#"+o]=i}if(!i){const e=Object.entries(r).map((e=>{let[t,n]=e;return"adapter ".concat(t," ")+(!1===n?"is not supported by the environment":"is not available in the build")}));let n=t?e.length>1?"since :\n"+e.map(xn).join("\n"):" "+xn(e[0]):"as no adapter specified";throw new Jt("There is no suitable adapter to dispatch the request "+n,"ERR_NOT_SUPPORT")}return i};function jn(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new On(null,e)}function Bn(e){jn(e),e.headers=bn.from(e.headers),e.data=In.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return Fn(e.adapter||gn.adapter)(e).then((function(t){return jn(e),t.data=In.call(e,e.transformResponse,t),t.headers=bn.from(t.headers),t}),(function(t){return wn(t)||(jn(e),t&&t.response&&(t.response.data=In.call(e,e.transformResponse,t.response),t.response.headers=bn.from(t.response.headers))),Promise.reject(t)}))}const Gn=e=>e instanceof bn?e.toJSON():e;function Wn(e,t){t=t||{};const n={};function i(e,t,n){return Kt.isPlainObject(e)&&Kt.isPlainObject(t)?Kt.merge.call({caseless:n},e,t):Kt.isPlainObject(t)?Kt.merge({},t):Kt.isArray(t)?t.slice():t}function r(e,t,n){return Kt.isUndefined(t)?Kt.isUndefined(e)?void 0:i(void 0,e,n):i(e,t,n)}function o(e,t){if(!Kt.isUndefined(t))return i(void 0,t)}function s(e,t){return Kt.isUndefined(t)?Kt.isUndefined(e)?void 0:i(void 0,e):i(void 0,t)}function a(n,r,o){return o in t?i(n,r):o in e?i(void 0,n):void 0}const c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(e,t)=>r(Gn(e),Gn(t),!0)};return Kt.forEach(Object.keys(Object.assign({},e,t)),(function(i){const o=c[i]||r,s=o(e[i],t[i],i);Kt.isUndefined(s)&&o!==a||(n[i]=s)})),n}const Hn="1.6.2",Kn={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{Kn[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));const zn={};Kn.transitional=function(e,t,n){function i(e,t){return"[Axios v1.6.2] Transitional option '"+e+"'"+t+(n?". "+n:"")}return(n,r,o)=>{if(!1===e)throw new Jt(i(r," has been removed"+(t?" in "+t:"")),Jt.ERR_DEPRECATED);return t&&!zn[r]&&(zn[r]=!0,console.warn(i(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,r,o)}};const Yn={assertOptions:function(e,t,n){if("object"!==typeof e)throw new Jt("options must be an object",Jt.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let r=i.length;for(;r-- >0;){const o=i[r],s=t[o];if(s){const t=e[o],n=void 0===t||s(t,o,e);if(!0!==n)throw new Jt("option "+o+" must be "+n,Jt.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new Jt("Unknown option "+o,Jt.ERR_BAD_OPTION)}},validators:Kn},qn=Yn.validators;class Jn{constructor(e){this.defaults=e,this.interceptors={request:new cn,response:new cn}}request(e,t){"string"===typeof e?(t=t||{}).url=e:t=e||{},t=Wn(this.defaults,t);const{transitional:n,paramsSerializer:i,headers:r}=t;void 0!==n&&Yn.assertOptions(n,{silentJSONParsing:qn.transitional(qn.boolean),forcedJSONParsing:qn.transitional(qn.boolean),clarifyTimeoutError:qn.transitional(qn.boolean)},!1),null!=i&&(Kt.isFunction(i)?t.paramsSerializer={serialize:i}:Yn.assertOptions(i,{encode:qn.function,serialize:qn.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o=r&&Kt.merge(r.common,r[t.method]);r&&Kt.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete r[e]})),t.headers=bn.concat(o,r);const s=[];let a=!0;this.interceptors.request.forEach((function(e){"function"===typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,s.unshift(e.fulfilled,e.rejected))}));const c=[];let d;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let l,u=0;if(!a){const e=[Bn.bind(this),void 0];for(e.unshift.apply(e,s),e.push.apply(e,c),l=e.length,d=Promise.resolve(t);u<l;)d=d.then(e[u++],e[u++]);return d}l=s.length;let h=t;for(u=0;u<l;){const e=s[u++],t=s[u++];try{h=e(h)}catch(p){t.call(this,p);break}}try{d=Bn.call(this,h)}catch(p){return Promise.reject(p)}for(u=0,l=c.length;u<l;)d=d.then(c[u++],c[u++]);return d}getUri(e){return an(Dn((e=Wn(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}}Kt.forEach(["delete","get","head","options"],(function(e){Jn.prototype[e]=function(t,n){return this.request(Wn(n||{},{method:e,url:t,data:(n||{}).data}))}})),Kt.forEach(["post","put","patch"],(function(e){function t(t){return function(n,i,r){return this.request(Wn(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:n,data:i}))}}Jn.prototype[e]=t(),Jn.prototype[e+"Form"]=t(!0)}));const Xn=Jn;class Qn{constructor(e){if("function"!==typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const n=this;this.promise.then((e=>{if(!n._listeners)return;let t=n._listeners.length;for(;t-- >0;)n._listeners[t](e);n._listeners=null})),this.promise.then=e=>{let t;const i=new Promise((e=>{n.subscribe(e),t=e})).then(e);return i.cancel=function(){n.unsubscribe(t)},i},e((function(e,i,r){n.reason||(n.reason=new On(e,i,r),t(n.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;return{token:new Qn((function(t){e=t})),cancel:e}}}const Zn=Qn;const $n={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries($n).forEach((e=>{let[t,n]=e;$n[n]=t}));const ei=$n;const ti=function e(t){const n=new Xn(t),i=ht(Xn.prototype.request,n);return Kt.extend(i,Xn.prototype,n,{allOwnKeys:!0}),Kt.extend(i,n,null,{allOwnKeys:!0}),i.create=function(n){return e(Wn(t,n))},i}(gn);ti.Axios=Xn,ti.CanceledError=On,ti.CancelToken=Zn,ti.isCancel=wn,ti.VERSION=Hn,ti.toFormData=en,ti.AxiosError=Jt,ti.Cancel=ti.CanceledError,ti.all=function(e){return Promise.all(e)},ti.spread=function(e){return function(t){return e.apply(null,t)}},ti.isAxiosError=function(e){return Kt.isObject(e)&&!0===e.isAxiosError},ti.mergeConfig=Wn,ti.AxiosHeaders=bn,ti.formToJSON=e=>mn(Kt.isHTMLForm(e)?new FormData(e):e),ti.getAdapter=Fn,ti.HttpStatusCode=ei,ti.default=ti;const ni=ti,ii=Object.create(null);ii.open="0",ii.close="1",ii.ping="2",ii.pong="3",ii.message="4",ii.upgrade="5",ii.noop="6";const ri=Object.create(null);Object.keys(ii).forEach((e=>{ri[ii[e]]=e}));const oi={type:"error",data:"parser error"},si="function"===typeof Blob||"undefined"!==typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),ai="function"===typeof ArrayBuffer,ci=e=>"function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,di=(e,t,n)=>{let{type:i,data:r}=e;return si&&r instanceof Blob?t?n(r):li(r,n):ai&&(r instanceof ArrayBuffer||ci(r))?t?n(r):li(new Blob([r]),n):n(ii[i]+(r||""))},li=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+(e||""))},n.readAsDataURL(e)};function ui(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let hi;const pi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fi="undefined"===typeof Uint8Array?[]:new Uint8Array(256);for(let n=0;n<64;n++)fi[pi.charCodeAt(n)]=n;const _i="function"===typeof ArrayBuffer,mi=(e,t)=>{if("string"!==typeof e)return{type:"message",data:gi(e,t)};const n=e.charAt(0);if("b"===n)return{type:"message",data:Ei(e.substring(1),t)};return ri[n]?e.length>1?{type:ri[n],data:e.substring(1)}:{type:ri[n]}:oi},Ei=(e,t)=>{if(_i){const n=(e=>{let t,n,i,r,o,s=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);const d=new ArrayBuffer(s),l=new Uint8Array(d);for(t=0;t<a;t+=4)n=fi[e.charCodeAt(t)],i=fi[e.charCodeAt(t+1)],r=fi[e.charCodeAt(t+2)],o=fi[e.charCodeAt(t+3)],l[c++]=n<<2|i>>4,l[c++]=(15&i)<<4|r>>2,l[c++]=(3&r)<<6|63&o;return d})(e);return gi(n,t)}return{base64:!0,data:e}},gi=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer,Si=String.fromCharCode(30);function Ti(){return new TransformStream({transform(e,t){!function(e,t){si&&e.data instanceof Blob?e.data.arrayBuffer().then(ui).then(t):ai&&(e.data instanceof ArrayBuffer||ci(e.data))?t(ui(e.data)):di(e,!1,(e=>{hi||(hi=new TextEncoder),t(hi.encode(e))}))}(e,(n=>{const i=n.length;let r;if(i<126)r=new Uint8Array(1),new DataView(r.buffer).setUint8(0,i);else if(i<65536){r=new Uint8Array(3);const e=new DataView(r.buffer);e.setUint8(0,126),e.setUint16(1,i)}else{r=new Uint8Array(9);const e=new DataView(r.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(i))}e.data&&"string"!==typeof e.data&&(r[0]|=128),t.enqueue(r),t.enqueue(n)}))}})}let vi;function yi(e){return e.reduce(((e,t)=>e+t.length),0)}function Ri(e,t){if(e[0].length===t)return e.shift();const n=new Uint8Array(t);let i=0;for(let r=0;r<t;r++)n[r]=e[0][i++],i===e[0].length&&(e.shift(),i=0);return e.length&&i<e[0].length&&(e[0]=e[0].slice(i)),n}function Ci(e){if(e)return function(e){for(var t in Ci.prototype)e[t]=Ci.prototype[t];return e}(e)}Ci.prototype.on=Ci.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},Ci.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},Ci.prototype.off=Ci.prototype.removeListener=Ci.prototype.removeAllListeners=Ci.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,i=this._callbacks["$"+e];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var r=0;r<i.length;r++)if((n=i[r])===t||n.fn===t){i.splice(r,1);break}return 0===i.length&&delete this._callbacks["$"+e],this},Ci.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(n){i=0;for(var r=(n=n.slice(0)).length;i<r;++i)n[i].apply(this,t)}return this},Ci.prototype.emitReserved=Ci.prototype.emit,Ci.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},Ci.prototype.hasListeners=function(e){return!!this.listeners(e).length};const bi="undefined"!==typeof self?self:"undefined"!==typeof window?window:Function("return this")();function Ii(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return n.reduce(((t,n)=>(e.hasOwnProperty(n)&&(t[n]=e[n]),t)),{})}const wi=bi.setTimeout,Ai=bi.clearTimeout;function Oi(e,t){t.useNativeTimers?(e.setTimeoutFn=wi.bind(bi),e.clearTimeoutFn=Ai.bind(bi)):(e.setTimeoutFn=bi.setTimeout.bind(bi),e.clearTimeoutFn=bi.clearTimeout.bind(bi))}class Ni extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class Di extends Ci{constructor(e){super(),this.writable=!1,Oi(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new Ni(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=mi(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return-1===e.indexOf(":")?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(e){const t=function(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}(e);return t.length?"?"+t:""}}const Pi="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),ki=64,Li={};let Mi,Ui=0,xi=0;function Vi(e){let t="";do{t=Pi[e%ki]+t,e=Math.floor(e/ki)}while(e>0);return t}function Fi(){const e=Vi(+new Date);return e!==Mi?(Ui=0,Mi=e):e+"."+Vi(Ui++)}for(;xi<ki;xi++)Li[Pi[xi]]=xi;let ji=!1;try{ji="undefined"!==typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(Qr){}const Bi=ji;function Gi(e){const t=e.xdomain;try{if("undefined"!==typeof XMLHttpRequest&&(!t||Bi))return new XMLHttpRequest}catch(n){}if(!t)try{return new(bi[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(n){}}function Wi(){}const Hi=null!=new Gi({xdomain:!1}).responseType;class Ki extends Ci{constructor(e,t){super(),Oi(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.data=void 0!==t.data?t.data:null,this.create()}create(){var e;const t=Ii(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd;const n=this.xhr=new Gi(t);try{n.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let e in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(e)&&n.setRequestHeader(e,this.opts.extraHeaders[e])}}catch(i){}if("POST"===this.method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(i){}try{n.setRequestHeader("Accept","*/*")}catch(i){}null===(e=this.opts.cookieJar)||void 0===e||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(n.timeout=this.opts.requestTimeout),n.onreadystatechange=()=>{var e;3===n.readyState&&(null===(e=this.opts.cookieJar)||void 0===e||e.parseCookies(n)),4===n.readyState&&(200===n.status||1223===n.status?this.onLoad():this.setTimeoutFn((()=>{this.onError("number"===typeof n.status?n.status:0)}),0))},n.send(this.data)}catch(i){return void this.setTimeoutFn((()=>{this.onError(i)}),0)}"undefined"!==typeof document&&(this.index=Ki.requestsCount++,Ki.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if("undefined"!==typeof this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=Wi,e)try{this.xhr.abort()}catch(t){}"undefined"!==typeof document&&delete Ki.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}if(Ki.requestsCount=0,Ki.requests={},"undefined"!==typeof document)if("function"===typeof attachEvent)attachEvent("onunload",zi);else if("function"===typeof addEventListener){addEventListener("onpagehide"in bi?"pagehide":"unload",zi,!1)}function zi(){for(let e in Ki.requests)Ki.requests.hasOwnProperty(e)&&Ki.requests[e].abort()}const Yi="function"===typeof Promise&&"function"===typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),qi=bi.WebSocket||bi.MozWebSocket,Ji="undefined"!==typeof navigator&&"string"===typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();const Xi={websocket:class extends Di{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,n=Ji?{}:Ii(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=Ji?new qi(e,t,n):t?new qi(e,t):new qi(e)}catch(Qr){return this.emitReserved("error",Qr)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;di(n,this.supportsBinary,(e=>{try{this.ws.send(e)}catch(t){}i&&Yi((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){"undefined"!==typeof this.ws&&(this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Fi()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}check(){return!!qi}},webtransport:class extends Di{get name(){return"webtransport"}doOpen(){"function"===typeof WebTransport&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then((()=>{this.onClose()})).catch((e=>{this.onError("webtransport error",e)})),this.transport.ready.then((()=>{this.transport.createBidirectionalStream().then((e=>{const t=function(e,t){vi||(vi=new TextDecoder);const n=[];let i=0,r=-1,o=!1;return new TransformStream({transform(s,a){for(n.push(s);;){if(0===i){if(yi(n)<1)break;const e=Ri(n,1);o=128===(128&e[0]),r=127&e[0],i=r<126?3:126===r?1:2}else if(1===i){if(yi(n)<2)break;const e=Ri(n,2);r=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),i=3}else if(2===i){if(yi(n)<8)break;const e=Ri(n,8),t=new DataView(e.buffer,e.byteOffset,e.length),o=t.getUint32(0);if(o>Math.pow(2,21)-1){a.enqueue(oi);break}r=o*Math.pow(2,32)+t.getUint32(4),i=3}else{if(yi(n)<r)break;const e=Ri(n,r);a.enqueue(mi(o?e:vi.decode(e),t)),i=0}if(0===r||r>e){a.enqueue(oi);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),i=Ti();i.readable.pipeTo(e.writable),this.writer=i.writable.getWriter();const r=()=>{n.read().then((e=>{let{done:t,value:n}=e;t||(this.onPacket(n),r())})).catch((e=>{}))};r();const o={type:"open"};this.query.sid&&(o.data='{"sid":"'.concat(this.query.sid,'"}')),this.writer.write(o).then((()=>this.onOpen()))}))})))}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;this.writer.write(n).then((()=>{i&&Yi((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var e;null===(e=this.transport)||void 0===e||e.close()}},polling:class extends Di{constructor(e){if(super(e),this.polling=!1,"undefined"!==typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?"443":"80"),this.xd="undefined"!==typeof location&&e.hostname!==location.hostname||n!==e.port}const t=e&&e.forceBase64;this.supportsBinary=Hi&&!t,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let e=0;this.polling&&(e++,this.once("pollComplete",(function(){--e||t()}))),this.writable||(e++,this.once("drain",(function(){--e||t()})))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){((e,t)=>{const n=e.split(Si),i=[];for(let r=0;r<n.length;r++){const e=mi(n[r],t);if(i.push(e),"error"===e.type)break}return i})(e,this.socket.binaryType).forEach((e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,((e,t)=>{const n=e.length,i=new Array(n);let r=0;e.forEach(((e,o)=>{di(e,!1,(e=>{i[o]=e,++r===n&&t(i.join(Si))}))}))})(e,(e=>{this.doWrite(e,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=Fi()),this.supportsBinary||t.sid||(t.b64=1),this.createUri(e,t)}request(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign(e,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new Ki(this.uri(),e)}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",((e,t)=>{this.onError("xhr post error",e,t)}))}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",((e,t)=>{this.onError("xhr poll error",e,t)})),this.pollXhr=e}}},Qi=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Zi=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function $i(e){if(e.length>2e3)throw"URI too long";const t=e,n=e.indexOf("["),i=e.indexOf("]");-1!=n&&-1!=i&&(e=e.substring(0,n)+e.substring(n,i).replace(/:/g,";")+e.substring(i,e.length));let r=Qi.exec(e||""),o={},s=14;for(;s--;)o[Zi[s]]=r[s]||"";return-1!=n&&-1!=i&&(o.source=t,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=function(e,t){const n=/\/{2,9}/g,i=t.replace(n,"/").split("/");"/"!=t.slice(0,1)&&0!==t.length||i.splice(0,1);"/"==t.slice(-1)&&i.splice(i.length-1,1);return i}(0,o.path),o.queryKey=function(e,t){const n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,i){t&&(n[t]=i)})),n}(0,o.query),o}class er extends Ci{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.binaryType="arraybuffer",this.writeBuffer=[],e&&"object"===typeof e&&(t=e,e=null),e?(e=$i(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=$i(t.host).host),Oi(this,t),this.secure=null!=t.secure?t.secure:"undefined"!==typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!==typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!==typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"===typeof this.opts.query&&(this.opts.query=function(e){let t={},n=e.split("&");for(let i=0,r=n.length;i<r;i++){let e=n[i].split("=");t[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return t}(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"===typeof addEventListener&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new Xi[e](n)}open(){let e;if(this.opts.rememberUpgrade&&er.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(t){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(e=>this.onClose("transport close",e)))}probe(e){let t=this.createTransport(e),n=!1;er.priorWebsocketSuccess=!1;const i=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",(e=>{if(!n)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;er.priorWebsocketSuccess="websocket"===t.name,this.transport.pause((()=>{n||"closed"!==this.readyState&&(d(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())}))}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}})))};function r(){n||(n=!0,d(),t.close(),t=null)}const o=e=>{const n=new Error("probe error: "+e);n.transport=t.name,r(),this.emitReserved("upgradeError",n)};function s(){o("transport closed")}function a(){o("socket closed")}function c(e){t&&e.name!==t.name&&r()}const d=()=>{t.removeListener("open",i),t.removeListener("error",o),t.removeListener("close",s),this.off("close",a),this.off("upgrading",c)};t.once("open",i),t.once("error",o),t.once("close",s),this.once("close",a),this.once("upgrading",c),-1!==this.upgrades.indexOf("webtransport")&&"webtransport"!==e?this.setTimeoutFn((()=>{n||t.open()}),200):t.open()}onOpen(){if(this.readyState="open",er.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),this.resetPingTimeout(),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((()=>{this.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let n=0;n<this.writeBuffer.length;n++){const i=this.writeBuffer[n].data;if(i&&(e+="string"===typeof(t=i)?function(e){let t=0,n=0;for(let i=0,r=e.length;i<r;i++)t=e.charCodeAt(i),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(i++,n+=4);return n}(t):Math.ceil(1.33*(t.byteLength||t.size))),n>0&&e>this.maxPayload)return this.writeBuffer.slice(0,n);e+=2}var t;return this.writeBuffer}write(e,t,n){return this.sendPacket("message",e,t,n),this}send(e,t,n){return this.sendPacket("message",e,t,n),this}sendPacket(e,t,n,i){if("function"===typeof t&&(i=t,t=void 0),"function"===typeof n&&(i=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const r={type:e,data:t,options:n};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():e()})):this.upgrading?n():e()),this}onError(e){er.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"===typeof removeEventListener&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let n=0;const i=e.length;for(;n<i;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}er.protocol=4;er.protocol;const tr="function"===typeof ArrayBuffer,nr=e=>"function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer,ir=Object.prototype.toString,rr="function"===typeof Blob||"undefined"!==typeof Blob&&"[object BlobConstructor]"===ir.call(Blob),or="function"===typeof File||"undefined"!==typeof File&&"[object FileConstructor]"===ir.call(File);function sr(e){return tr&&(e instanceof ArrayBuffer||nr(e))||rr&&e instanceof Blob||or&&e instanceof File}function ar(e,t){if(!e||"object"!==typeof e)return!1;if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(ar(e[t]))return!0;return!1}if(sr(e))return!0;if(e.toJSON&&"function"===typeof e.toJSON&&1===arguments.length)return ar(e.toJSON(),!0);for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&ar(e[n]))return!0;return!1}function cr(e){const t=[],n=e.data,i=e;return i.data=dr(n,t),i.attachments=t.length,{packet:i,buffers:t}}function dr(e,t){if(!e)return e;if(sr(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let i=0;i<e.length;i++)n[i]=dr(e[i],t);return n}if("object"===typeof e&&!(e instanceof Date)){const n={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=dr(e[i],t));return n}return e}function lr(e,t){return e.data=ur(e.data,t),delete e.attachments,e}function ur(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"===typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=ur(e[n],t);else if("object"===typeof e)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=ur(e[n],t));return e}const hr=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],pr=5;var fr;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(fr||(fr={}));class _r{constructor(e){this.replacer=e}encode(e){return e.type!==fr.EVENT&&e.type!==fr.ACK||!ar(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===fr.EVENT?fr.BINARY_EVENT:fr.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==fr.BINARY_EVENT&&e.type!==fr.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=cr(e),n=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(n),i}}function mr(e){return"[object Object]"===Object.prototype.toString.call(e)}class Er extends Ci{constructor(e){super(),this.reviver=e}add(e){let t;if("string"===typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===fr.BINARY_EVENT;n||t.type===fr.BINARY_ACK?(t.type=n?fr.EVENT:fr.ACK,this.reconstructor=new gr(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!sr(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===fr[n.type])throw new Error("unknown packet type "+n.type);if(n.type===fr.BINARY_EVENT||n.type===fr.BINARY_ACK){const i=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const r=e.substring(i,t);if(r!=Number(r)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(r)}if("/"===e.charAt(t+1)){const i=t+1;for(;++t;){if(","===e.charAt(t))break;if(t===e.length)break}n.nsp=e.substring(i,t)}else n.nsp="/";const i=e.charAt(t+1);if(""!==i&&Number(i)==i){const i=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(!Er.isPayloadValid(n.type,i))throw new Error("invalid payload");n.data=i}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case fr.CONNECT:return mr(t);case fr.DISCONNECT:return void 0===t;case fr.CONNECT_ERROR:return"string"===typeof t||mr(t);case fr.EVENT:case fr.BINARY_EVENT:return Array.isArray(t)&&("number"===typeof t[0]||"string"===typeof t[0]&&-1===hr.indexOf(t[0]));case fr.ACK:case fr.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class gr{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=lr(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Sr(e,t,n){return e.on(t,n),function(){e.off(t,n)}}const Tr=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class vr extends Ci{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Sr(e,"open",this.onopen.bind(this)),Sr(e,"packet",this.onpacket.bind(this)),Sr(e,"error",this.onerror.bind(this)),Sr(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.unshift("message"),this.emit.apply(this,t),this}emit(e){if(Tr.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(n.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;const r={type:fr.EVENT,data:n,options:{}};if(r.options.compress=!1!==this.flags.compress,"function"===typeof n[n.length-1]){const e=this.ids++,t=n.pop();this._registerAckCallback(e,t),r.id=e}const o=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!o||!this.connected)||(this.connected?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(e,t){var n,i=this;const r=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===r)return void(this.acks[e]=t);const o=this.io.setTimeoutFn((()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))}),r);this.acks[e]=function(){i.io.clearTimeoutFn(o);for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t.apply(i,[null,...n])}}emitWithAck(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];const r=void 0!==this.flags.timeout||void 0!==this._opts.ackTimeout;return new Promise(((t,i)=>{n.push(((e,n)=>r?e?i(e):t(n):t(e))),this.emit(e,...n)}))}_addToQueue(e){var t=this;let n;"function"===typeof e[e.length-1]&&(n=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((function(e){if(i!==t._queue[0])return;if(null!==e)i.tryCount>t._opts.retries&&(t._queue.shift(),n&&n(e));else if(t._queue.shift(),n){for(var r=arguments.length,o=new Array(r>1?r-1:0),s=1;s<r;s++)o[s-1]=arguments[s];n(null,...o)}return i.pending=!1,t._drainQueue()})),this._queue.push(i),this._drainQueue()}_drainQueue(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth((e=>{this._sendConnectPacket(e)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:fr.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case fr.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case fr.EVENT:case fr.BINARY_EVENT:this.onevent(e);break;case fr.ACK:case fr.BINARY_ACK:this.onack(e);break;case fr.DISCONNECT:this.ondisconnect();break;case fr.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"===typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(){if(!n){n=!0;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];t.packet({type:fr.ACK,id:e,data:r})}}}onack(e){const t=this.acks[e.id];"function"===typeof t&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((e=>this.emitEvent(e))),this.receiveBuffer=[],this.sendBuffer.forEach((e=>{this.notifyOutgoingListeners(e),this.packet(e)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((e=>e())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:fr.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function yr(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}yr.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},yr.prototype.reset=function(){this.attempts=0},yr.prototype.setMin=function(e){this.ms=e},yr.prototype.setMax=function(e){this.max=e},yr.prototype.setJitter=function(e){this.jitter=e};class Rr extends Ci{constructor(e,n){var i;super(),this.nsps={},this.subs=[],e&&"object"===typeof e&&(n=e,e=void 0),(n=n||{}).path=n.path||"/socket.io",this.opts=n,Oi(this,n),this.reconnection(!1!==n.reconnection),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(i=n.randomizationFactor)&&void 0!==i?i:.5),this.backoff=new yr({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==n.timeout?2e4:n.timeout),this._readyState="closed",this.uri=e;const r=n.parser||t;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=!1!==n.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new er(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=Sr(t,"open",(function(){n.onopen(),e&&e()})),r=t=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",t),e?e(t):this.maybeReconnectOnOpen()},o=Sr(t,"error",r);if(!1!==this._timeout){const e=this._timeout,n=this.setTimeoutFn((()=>{i(),r(new Error("timeout")),t.close()}),e);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}return this.subs.push(i),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Sr(e,"ping",this.onping.bind(this)),Sr(e,"data",this.ondata.bind(this)),Sr(e,"error",this.onerror.bind(this)),Sr(e,"close",this.onclose.bind(this)),Sr(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){Yi((()=>{this.emitReserved("packet",e)}),this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new vr(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t){if(this.nsps[n].active)return}this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach((e=>e())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn((()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open((t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()})))}),t);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Cr={};function br(e,t){"object"===typeof e&&(t=e,e=void 0);const n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0,i=e;n=n||"undefined"!==typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"===typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e="undefined"!==typeof n?n.protocol+"//"+e:"https://"+e),i=$i(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const r=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+r+":"+i.port+t,i.href=i.protocol+"://"+r+(n&&n.port===i.port?"":":"+i.port),i}(e,(t=t||{}).path||"/socket.io"),i=n.source,r=n.id,o=n.path,s=Cr[r]&&o in Cr[r].nsps;let a;return t.forceNew||t["force new connection"]||!1===t.multiplex||s?a=new Rr(i,t):(Cr[r]||(Cr[r]=new Rr(i,t)),a=Cr[r]),n.query&&!t.query&&(t.query=n.queryKey),a.socket(n.path,t)}function Ir(){const[e,t]=(0,r.useState)([]),[n,i]=(0,r.useState)([]),o=ze(),{user:s,setUser:a}=(0,r.useContext)(ct);(0,r.useEffect)((()=>{(async()=>{const{data:e}=await ni.get("http://localhost:8000/rooms");i(e)})()}),[]);(0,r.useEffect)((()=>{(async()=>{const e=[];console.log(n),n.map(((t,n)=>e.push([(0,at.jsx)(ut,{roomName:t.roomName,roomId:t.roomId,online:t.online,theme:t.theme,chatType:t.chatType},t.key)]))),t(e)})()}),[n]);const c=()=>{localStorage.clear(),a(null),o("/rooms")};return s?(0,at.jsxs)("div",{className:"flex  items-center justify-center  md:gap-5 lg:py-10 md:py-10  w-screen md:h-fit h-screen flex-col gap-3 bg-slate-950",children:[(0,at.jsxs)("div",{className:"flex items-center justify-center w-screen flex-col gap-3 bg-slate-950",children:[(0,at.jsx)("button",{onClick:c,className:"hover:bg-teal-400 focus:bg-teal-400 transition-all duration-100 bg-red-500 py-2 w-[350px] rounded-md text-white font-medium",children:"Voltar para login"}),(0,at.jsx)("button",{onClick:c,className:"hover:bg-teal-400 focus:bg-teal-400 transition-all duration-100 bg-red-500 py-2 w-[350px] rounded-md text-white font-medium",children:"ir para sala"}),(0,at.jsx)("button",{onClick:()=>{o("/videoRoom/1")},className:"hover:bg-teal-400 focus:bg-teal-400 transition-all duration-100 bg-red-500 py-2 w-[350px] rounded-md text-white font-medium",children:"ir para video call"}),(0,at.jsx)("button",{onClick:()=>{o("/videoChat/1")},className:"hover:bg-teal-400 focus:bg-teal-400 transition-all duration-100 bg-red-500 py-2 w-[350px] rounded-md text-white font-medium",children:"ir para video chat"})]}),(0,at.jsx)("h1",{className:"text-white text-4xl font-bold",children:"Salas dispon\xedveis"}),(0,at.jsx)("div",{className:"grid md:grid-cols-1 lg:grid-cols-2 grid-cols-3 gap-4",children:e})]}):o("/")}function wr(){const[e,t]=(0,r.useState)(Math.floor((new Date).getTime()/1e3)),[n,i]=(0,r.useState)(),[o,s]=(0,r.useState)([]),[a,c]=(0,r.useState)([]),{sala:d}=function(){let{matches:e}=r.useContext(Be),t=e[e.length-1];return t?t.params:{}}();(0,r.useEffect)((()=>{const t="ws://localhost:8000/ws/".concat(d,"/").concat(e),n=new WebSocket(t);return n.onopen=e=>{n.send("Connect")},n.onmessage=e=>{const t=JSON.parse(e.data);c((e=>[...e,t]))},i(n),()=>n.close()}),[]);return(0,at.jsxs)("div",{className:"container",children:[(0,at.jsx)("h1",{children:"Chat"}),(0,at.jsxs)("h2",{children:["your client id: ",e," "]}),(0,at.jsxs)("div",{className:"chat-container",children:[(0,at.jsx)("div",{className:"chat",children:a.map(((e,t)=>(0,at.jsx)("div",{className:"my-message-container",children:(0,at.jsxs)("div",{className:"my-message",children:[(0,at.jsxs)("p",{className:"client",children:["client id : ",e.clientId]}),(0,at.jsx)("p",{className:"message",children:e.message})]})},t)))}),(0,at.jsxs)("div",{className:"input-chat-container",children:[(0,at.jsx)("input",{className:"input-chat",type:"text",placeholder:"Chat message ...",onChange:e=>s(e.target.value),value:o}),(0,at.jsx)("button",{className:"submit-chat",onClick:()=>{n.send(o),n.onmessage=e=>{const t=JSON.parse(e.data);c((e=>[...e,t]))},s([])},children:"Send"})]})]})]})}Object.assign(br,{Manager:Rr,Socket:vr,io:br,connect:br});var Ar=n(322),Or=n.n(Ar);const Nr=e=>{let{user:t}=e;const n=(0,r.useRef)();return(0,r.useEffect)((()=>{t.videoTrack.play(n.current)}),[]),(0,at.jsxs)("div",{children:["Uid: ",t.uid,(0,at.jsx)("div",{ref:n,style:{width:"200px",height:"200px"}})]})};Or().setLogLevel(2);const Dr=Or().createClient({mode:"rtc",codec:"vp8"}),Pr=()=>{const[e,t]=(0,r.useState)([]),[n]=(0,r.useState)(Math.floor((new Date).getTime()/1e3)),[i,o]=(0,r.useState)([]),[s,a]=(0,r.useState)(null),[c,d]=(0,r.useState)([]),[l,u]=(0,r.useState)([]),h=async(e,n)=>{await Dr.subscribe(e,n),"video"===n&&t((t=>[...t,e])),"audio"===n&&e.audioTrack.play()},p=e=>{t((t=>t.filter((t=>t.uid!==e.uid))))};(0,r.useEffect)((()=>{Dr.on("user-published",h),Dr.on("user-left",p),Dr.join("0294aae3dd5441f7b7a99385af5e556b","frc1","007eJxTYOCSK/fi38ipJHd2n9Vd7WneJb+ybBdWf7vX/8roTYG2xzQFBgMjS5PExFTjlBRTExPDNPMk80RLS2ML08Q001RTU7Mkz4z61IZARgbllYuYGRkgEMRnYUgrSjZkYAAA1M0d3w==",null).then((e=>Promise.all([Or().createMicrophoneAndCameraTracks(),e]))).then((e=>{let[n,i]=e;const[r,s]=n;o(n),t((e=>[...e,{uid:i,videoTrack:s,audioTrack:r}])),Dr.publish(n)}));const e=new WebSocket("ws://localhost:8000/ws/video/1/".concat(n));return e.onopen=()=>{e.send("User ".concat(n," connected"))},e.onmessage=e=>{const t=JSON.parse(e.data);u((e=>[...e,t]))},a(e),()=>{for(let e of i)e.stop(),e.close();Dr.off("user-published",h),Dr.off("user-left",p),Dr.unpublish().then((()=>Dr.leave()))}}),[]);return(0,at.jsxs)("div",{style:{display:"flex",justifyContent:"center"},children:[(0,at.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 200px)"},children:e.map((e=>(0,at.jsx)(Nr,{user:e},e.uid)))}),(0,at.jsxs)("div",{className:"chat-container",children:[(0,at.jsx)("div",{className:"chat",children:l.map(((e,t)=>e.clientId===n?(0,at.jsx)("div",{className:"my-message-container",children:(0,at.jsx)("div",{className:"my-message",children:(0,at.jsxs)("p",{className:"client",children:["client id(",n,"): ",e.message]})})},t):(0,at.jsx)("div",{className:"another-message-container",children:(0,at.jsx)("div",{className:"another-message",children:(0,at.jsxs)("p",{className:"client",children:["client id(",n,"):  ",e.message]})})},t)))}),(0,at.jsxs)("div",{className:"input-chat-container",children:[(0,at.jsx)("input",{className:"input-chat",type:"text",placeholder:"Chat message ...",onChange:e=>d(e.target.value),value:c}),(0,at.jsx)("button",{className:"submit-chat",onClick:()=>{s.send(c),d("")},children:"Send"})]})]})]})};Or().setLogLevel(2);const kr=Or().createClient({mode:"rtc",codec:"vp8"}),Lr=()=>{const[e,t]=(0,r.useState)([]),[n]=(0,r.useState)(Math.floor((new Date).getTime()/1e3)),[i,o]=(0,r.useState)([]),[s,a]=(0,r.useState)(null),[c,d]=(0,r.useState)([]),[l,u]=(0,r.useState)([]),h=async(e,n)=>{await kr.subscribe(e,n),"video"===n&&t((t=>[...t,e])),"audio"===n&&e.audioTrack.play()},p=e=>{t((t=>t.filter((t=>t.uid!==e.uid))))};(0,r.useEffect)((()=>{kr.on("user-published",h),kr.on("user-left",p),kr.join("0294aae3dd5441f7b7a99385af5e556b","frc1","007eJxTYOCSK/fi38ipJHd2n9Vd7WneJb+ybBdWf7vX/8roTYG2xzQFBgMjS5PExFTjlBRTExPDNPMk80RLS2ML08Q001RTU7Mkz4z61IZARgbllYuYGRkgEMRnYUgrSjZkYAAA1M0d3w==",null).then((e=>Promise.all([Or().createMicrophoneAndCameraTracks(),e]))).then((e=>{let[n,i]=e;const[r,s]=n;o(n),t((e=>[...e,{uid:i,videoTrack:s,audioTrack:r}])),kr.publish(n)}));const e=new WebSocket("ws://localhost:8000/ws/video-chat/1/".concat(n));return e.onopen=t=>{e.send("Connect")},e.onmessage=e=>{const t=JSON.parse(e.data);console.log(l),u((e=>[...e,t]))},a(e),()=>{for(let e of i)e.stop(),e.close();kr.off("user-published",h),kr.off("user-left",p),kr.unpublish().then((()=>kr.leave())),e.close()}}),[]);return(0,at.jsxs)("div",{style:{display:"flex",justifyContent:"center"},children:[(0,at.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 200px)"},children:e.map((e=>(0,at.jsx)(Nr,{user:e},e.uid)))}),(0,at.jsxs)("div",{className:"chat-container",children:[(0,at.jsx)("div",{className:"chat",children:l.map(((e,t)=>e.clientId===n?(0,at.jsx)("div",{className:"my-message-container",children:(0,at.jsxs)("div",{className:"my-message",children:[(0,at.jsxs)("p",{className:"client",children:["client id : ",e.clientId]}),(0,at.jsx)("p",{className:"message",children:e.message})]})},t):(0,at.jsx)("div",{className:"another-message-container",children:(0,at.jsxs)("div",{className:"another-message",children:[(0,at.jsxs)("p",{className:"client",children:["client id : ",e.clientId]}),(0,at.jsx)("p",{className:"message",children:e.message})]})},t)))}),(0,at.jsxs)("div",{className:"input-chat-container",children:[(0,at.jsx)("input",{className:"input-chat",type:"text",placeholder:"Chat message ...",onChange:e=>d(e.target.value),value:c}),(0,at.jsx)("button",{className:"submit-chat",onClick:()=>{s.send(c),console.log(l),s.onmessage=e=>{const t=JSON.parse(e.data);console.log(t),u((e=>[...e,t]))},d([])},children:"Send"})]})]})]})};var Mr=n(164),Ur=n.t(Mr,2);function xr(){return xr=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},xr.apply(this,arguments)}new Set(["application/x-www-form-urlencoded","multipart/form-data","text/plain"]);function Vr(){var e;let t=null==(e=window)?void 0:e.__staticRouterHydrationData;return t&&t.errors&&(t=xr({},t,{errors:Fr(t.errors)})),t}function Fr(e){if(!e)return null;let t=Object.entries(e),n={};for(let[r,o]of t)if(o&&"RouteErrorResponse"===o.__type)n[r]=new G(o.status,o.statusText,o.data,!0===o.internal);else if(o&&"Error"===o.__type){if(o.__subType){let e=window[o.__subType];if("function"===typeof e)try{let t=new e(o.message);t.stack="",n[r]=t}catch(i){}}if(null==n[r]){let e=new Error(o.message);e.stack="",n[r]=e}}else n[r]=o;return n}const jr=r.createContext({isTransitioning:!1});const Br=r.createContext(new Map);const Gr=o.startTransition,Wr=Ur.flushSync;function Hr(e){Wr?Wr(e):e()}class Kr{constructor(){this.status="pending",this.promise=new Promise(((e,t)=>{this.resolve=t=>{"pending"===this.status&&(this.status="resolved",e(t))},this.reject=e=>{"pending"===this.status&&(this.status="rejected",t(e))}}))}}function zr(e){let{fallbackElement:t,router:n,future:i}=e,[o,s]=r.useState(n.state),[a,c]=r.useState(),[d,l]=r.useState({isTransitioning:!1}),[u,h]=r.useState(),[p,f]=r.useState(),[_,m]=r.useState(),E=r.useRef(new Map),{v7_startTransition:g}=i||{},S=r.useCallback((e=>{g?function(e){Gr?Gr(e):e()}(e):e()}),[g]),T=r.useCallback(((e,t)=>{let{deletedFetchers:i,unstable_flushSync:r,unstable_viewTransitionOpts:o}=t;i.forEach((e=>E.current.delete(e))),e.fetchers.forEach(((e,t)=>{void 0!==e.data&&E.current.set(t,e.data)}));let a=null==n.window||"function"!==typeof n.window.document.startViewTransition;if(o&&!a){if(r){Hr((()=>{p&&(u&&u.resolve(),p.skipTransition()),l({isTransitioning:!0,flushSync:!0,currentLocation:o.currentLocation,nextLocation:o.nextLocation})}));let t=n.window.document.startViewTransition((()=>{Hr((()=>s(e)))}));return t.finished.finally((()=>{Hr((()=>{h(void 0),f(void 0),c(void 0),l({isTransitioning:!1})}))})),void Hr((()=>f(t)))}p?(u&&u.resolve(),p.skipTransition(),m({state:e,currentLocation:o.currentLocation,nextLocation:o.nextLocation})):(c(e),l({isTransitioning:!0,flushSync:!1,currentLocation:o.currentLocation,nextLocation:o.nextLocation}))}else r?Hr((()=>s(e))):S((()=>s(e)))}),[n.window,p,u,E,S]);r.useLayoutEffect((()=>n.subscribe(T)),[n,T]),r.useEffect((()=>{d.isTransitioning&&!d.flushSync&&h(new Kr)}),[d]),r.useEffect((()=>{if(u&&a&&n.window){let e=a,t=u.promise,i=n.window.document.startViewTransition((async()=>{S((()=>s(e))),await t}));i.finished.finally((()=>{h(void 0),f(void 0),c(void 0),l({isTransitioning:!1})})),f(i)}}),[S,a,u,n.window]),r.useEffect((()=>{u&&a&&o.location.key===a.location.key&&u.resolve()}),[u,p,o.location,a]),r.useEffect((()=>{!d.isTransitioning&&_&&(c(_.state),l({isTransitioning:!0,flushSync:!1,currentLocation:_.currentLocation,nextLocation:_.nextLocation}),m(void 0))}),[d.isTransitioning,_]),r.useEffect((()=>{}),[]);let v=r.useMemo((()=>({createHref:n.createHref,encodeLocation:n.encodeLocation,go:e=>n.navigate(e),push:(e,t,i)=>n.navigate(e,{state:t,preventScrollReset:null==i?void 0:i.preventScrollReset}),replace:(e,t,i)=>n.navigate(e,{replace:!0,state:t,preventScrollReset:null==i?void 0:i.preventScrollReset})})),[n]),y=n.basename||"/",R=r.useMemo((()=>({router:n,navigator:v,static:!1,basename:y})),[n,v,y]);return r.createElement(r.Fragment,null,r.createElement(xe.Provider,{value:R},r.createElement(Ve.Provider,{value:o},r.createElement(Br.Provider,{value:E.current},r.createElement(jr.Provider,{value:d},r.createElement(ot,{basename:y,location:o.location,navigationType:o.historyAction,navigator:v,future:{v7_relativeSplatPath:n.future.v7_relativeSplatPath}},o.initialized||n.future.v7_partialHydration?r.createElement(Yr,{routes:n.routes,future:n.future,state:o}):t))))),null)}function Yr(e){let{routes:t,future:n,state:i}=e;return Ye(t,void 0,i,n)}"undefined"!==typeof window&&"undefined"!==typeof window.document&&window.document.createElement;var qr,Jr;(function(e){e.UseScrollRestoration="useScrollRestoration",e.UseSubmit="useSubmit",e.UseSubmitFetcher="useSubmitFetcher",e.UseFetcher="useFetcher",e.useViewTransitionState="useViewTransitionState"})(qr||(qr={})),function(e){e.UseFetcher="useFetcher",e.UseFetchers="useFetchers",e.UseScrollRestoration="useScrollRestoration"}(Jr||(Jr={}));const Xr=function(e,t){return ne({basename:null==t?void 0:t.basename,future:xr({},null==t?void 0:t.future,{v7_prependBasename:!0}),history:(n={window:null==t?void 0:t.window},void 0===n&&(n={}),_((function(e,t){let{pathname:n,search:i,hash:r}=e.location;return h("",{pathname:n,search:i,hash:r},t.state&&t.state.usr||null,t.state&&t.state.key||"default")}),(function(e,t){return"string"===typeof t?t:p(t)}),null,n)),hydrationData:(null==t?void 0:t.hydrationData)||Vr(),routes:e,mapRouteProperties:st,window:null==t?void 0:t.window}).initialize();var n}([{path:"/",element:(0,at.jsx)(lt,{})},{path:"/rooms",element:(0,at.jsx)(Ir,{})},{path:"/chatRoom/:roomId",element:(0,at.jsx)(wr,{})},{path:"/videoRoom/:roomId",element:(0,at.jsx)(Pr,{})},{path:"/videoChat/:roomId",element:(0,at.jsx)(Lr,{})}]);s.createRoot(document.getElementById("root")).render((0,at.jsx)(dt,{children:(0,at.jsx)(zr,{router:Xr})}))})()})();
//# sourceMappingURL=main.14cc8b83.js.map